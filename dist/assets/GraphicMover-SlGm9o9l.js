import{$_ as e,DT as t,Dd as n,Gh as r,OT as i,Od as a,SE as o,Xu as s,_w as c,gD as l,jd as u,nv as d,qu as f,sv as p}from"./index-ByaFsVj4.js";import{i as m}from"./layerViewUtils--V83RFAv.js";import{t as h}from"./GraphicsLayer-DwoVChbR.js";import{n as g,r as _}from"./layerUtils-Cj6yZbRW.js";import{t as v}from"./GraphicManipulator-Bcgu8Y5Q.js";import{a as y}from"./drawUtils-D8SijXp2.js";var b=class extends c{constructor(e){super(e),this._layerViewCache=new Map,this.highlightName=f,this.view=null}add(e,t){let n=!e||Array.isArray(e)?e:[e];if(!n?.length)return;let r=t??this.highlightName;n.forEach(e=>this._highlight(e,r))}getKeyForFeature(e){let t=e.getObjectId();return t==null?`uid:${e.uid}`:`oid:${t}`}remove(e){let t=!e||Array.isArray(e)?e:[e];t?.length&&t.forEach(e=>e&&this._removeHighlight(this.getKeyForFeature(e)))}removeByKey(e){e?.forEach(e=>e&&this._removeHighlight(e))}removeAll(){this.removeAllHandles()}update(e,t){this.remove(e),this.add(e,t)}_highlight(e,t){let n=e.layer??e.sourceLayer;if(!n)return;let r=this._layerViewCache.get(n);if(r)return void this.addHandles(r.highlight(e,{name:t}),this.getKeyForFeature(e));let i=g(this.view,n);m(i)&&(this._layerViewCache.set(n,i),this.addHandles(i.highlight(e,{name:t}),this.getKeyForFeature(e)))}_removeHighlight(e){this.removeHandles(e)}};l([t()],b.prototype,`_layerViewCache`,void 0),l([t()],b.prototype,`highlightName`,void 0),l([t()],b.prototype,`view`,void 0),b=l([i(`esri.views.draw.support.HighlightHelper`)],b);var x=b,S=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-click`}},C=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-double-click`}},w=class{constructor(e,t,n,r,i,a,o,s,c,l){this.graphic=e,this.allGraphics=t,this.index=n,this.x=r,this.y=i,this.dx=a,this.dy=o,this.totalDx=s,this.totalDy=c,this.viewEvent=l,this.defaultPrevented=!1,this.type=`graphic-move-start`}preventDefault(){this.defaultPrevented=!0}},T=class{constructor(e,t,n,r,i,a,o,s,c,l){this.graphic=e,this.allGraphics=t,this.index=n,this.x=r,this.y=i,this.dx=a,this.dy=o,this.totalDx=s,this.totalDy=c,this.viewEvent=l,this.defaultPrevented=!1,this.type=`graphic-move`}preventDefault(){this.defaultPrevented=!0}},E=class{constructor(e,t,n,r,i,a,o,s,c,l){this.graphic=e,this.allGraphics=t,this.index=n,this.x=r,this.y=i,this.dx=a,this.dy=o,this.totalDx=s,this.totalDy=c,this.viewEvent=l,this.defaultPrevented=!1,this.type=`graphic-move-stop`}preventDefault(){this.defaultPrevented=!0}},D=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-pointer-over`}},O=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-pointer-out`}},k=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-pointer-down`}},A=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-pointer-up`}},j=`indicator-symbols`,M=class extends p{constructor(e){super(e),this._activeGraphic=null,this._dragEvent=null,this._hoverGraphic=null,this._indicators=[],this._initialDragGeometry=null,this._manipulators=[],this._layerViews=null,this.type=`graphic-mover`,this.callbacks={onGraphicClick(){},onGraphicDoubleClick(){},onGraphicMoveStart(){},onGraphicMove(){},onGraphicMoveStop(){},onGraphicPointerOver(){},onGraphicPointerOut(){},onGraphicPointerDown(){},onGraphicPointerUp(){}},this.enableMoveAllGraphics=!1,this.graphics=[],this.highlightName=null,this.highlightsEnabled=!1,this.indicatorsEnabled=!1,this._defaultLayer=new h({listMode:`hide`,internal:!0,title:`GraphicMover highlight layer`}),this.layer=this._defaultLayer,this.view=null}initialize(){_(this.view,this.layer),this._highlightHelper=new x({view:this.view}),this.refresh(),this.addHandles([d(()=>this.graphics.length,()=>this.refresh()),e(()=>this.view?.ready,()=>{this.addHandles([this.view.on(`immediate-click`,e=>this._clickHandler(e),r.TOOL),this.view.on(`double-click`,e=>this._doubleClickHandler(e),r.TOOL),this.view.on(`pointer-down`,e=>this._pointerDownHandler(e),r.TOOL),this.view.on(`pointer-move`,e=>this._pointerMoveHandler(e),r.TOOL),this.view.on(`pointer-up`,e=>this._pointerUpHandler(e),r.TOOL),this.view.on(`drag`,e=>this._dragHandler(e),r.TOOL),this.view.on(`key-down`,e=>this._keyDownHandler(e),r.TOOL)])},{once:!0,initial:!0}),d(()=>this.view,e=>{this._highlightHelper.removeAll(),this._highlightHelper.view=e}),d(()=>[this.highlightsEnabled,this.highlightName],()=>{this._highlightHelper?.removeAll(),this._setUpHighlights()})])}destroy(){this._removeIndicators(),this.view.map?.remove(this.layer),this._defaultLayer.destroy(),this.reset(),this._manipulators.forEach(e=>e.destroy()),this._manipulators=null}get state(){let e=this.view.ready,t=this.graphics.length>0,n=this._activeGraphic;return e&&t?n?`moving`:`active`:e?`ready`:`disabled`}refresh(){this.reset(),this._setup()}reset(){this._activeGraphic=null,this._hoverGraphic=null,this._dragEvent=null,this._highlightHelper.removeAll()}updateGeometry(e,t){let n=this.graphics[e];n&&(n.set(`geometry`,t),this._setUpIndicators())}_setup(){this._setUpHighlights(),this._setUpIndicators(),this._setUpManipulators(),this._syncLayerViews()}_clickHandler(e){let t=this._findTargetGraphic(s(e));if(t){let n=new S(t,this.graphics.indexOf(t),e.x,e.y,e);this.emit(`graphic-click`,n),this.callbacks.onGraphicClick?.(n)}}_doubleClickHandler(e){let t=this._findTargetGraphic(s(e));if(t){let n=new C(t,this.graphics.indexOf(t),e.x,e.y,e);this.emit(`graphic-double-click`,n),this.callbacks.onGraphicDoubleClick?.(n)}}_pointerDownHandler(e){let t=this._findTargetGraphic(s(e));if(t){this._activeGraphic=t;let{x:n,y:r}=e,i=new k(t,this.graphics.indexOf(t),n,r,e);this.emit(`graphic-pointer-down`,i),this.callbacks.onGraphicPointerDown?.(i)}else this._activeGraphic=null}_pointerUpHandler(e){if(this._activeGraphic){let{x:t,y:n}=e,r=this.graphics.indexOf(this._activeGraphic),i=new A(this._activeGraphic,r,t,n,e);this.emit(`graphic-pointer-up`,i),this.callbacks.onGraphicPointerUp?.(i),this._hoverGraphic=this._activeGraphic}}_pointerMoveHandler(e){if(this._dragEvent)return;let t=this._findTargetGraphic(s(e));if(t){let{x:n,y:r}=e;if(this._hoverGraphic){if(this._hoverGraphic===t)return;let i=this.graphics.indexOf(this._hoverGraphic),a=new O(this.graphics[i],i,n,r,e);this._hoverGraphic=null,this.emit(`graphic-pointer-out`,a),this.callbacks.onGraphicPointerOut?.(a)}let i=this.graphics.indexOf(t),a=new D(t,i,n,r,e);this._hoverGraphic=t,this.emit(`graphic-pointer-over`,a),this.callbacks.onGraphicPointerOver?.(a);return}if(this._hoverGraphic){let{x:t,y:n}=e,r=this.graphics.indexOf(this._hoverGraphic),i=new O(this.graphics[r],r,t,n,e);this._hoverGraphic=null,this.emit(`graphic-pointer-out`,i),this.callbacks.onGraphicPointerOut?.(i)}}_dragHandler(e){if(e.action!==`start`&&!this._dragEvent||!this._activeGraphic?.geometry)return;e.action===`start`&&this._removeIndicators(),e.stopPropagation();let{action:t,x:n,y:r}=e,i=this.graphics.indexOf(this._activeGraphic),a=this._dragEvent?n-this._dragEvent.x:0,s=this._dragEvent?r-this._dragEvent.y:0,c=n-e.origin.x,l=r-e.origin.y,u=t===`start`?this._activeGraphic.geometry:this._initialDragGeometry,d=y(u,c,l,this.view);if(this._activeGraphic.geometry=d,this.enableMoveAllGraphics&&this.graphics.forEach(e=>{e!==this._activeGraphic&&(e.geometry=y(e.geometry,a,s,this.view))}),this._dragEvent=e,t===`start`){this._initialDragGeometry=o(u);let t=new w(this._activeGraphic,this.graphics,i,n,r,a,s,c,l,e);this.emit(`graphic-move-start`,t),this.callbacks.onGraphicMoveStart?.(t),t.defaultPrevented&&this._activeGraphic.set(`geometry`,u)}else if(t===`update`){let t=new T(this._activeGraphic,this.graphics,i,n,r,a,s,c,l,e);this.emit(`graphic-move`,t),this.callbacks.onGraphicMove?.(t),t.defaultPrevented&&(this._activeGraphic.geometry=u)}else{let t=new E(this._activeGraphic,this.graphics,i,n,r,a,s,c,l,e);this._dragEvent=null,this._activeGraphic=null,this._setUpIndicators(),this.emit(`graphic-move-stop`,t),this.callbacks.onGraphicMoveStop?.(t),t.defaultPrevented&&(this.graphics[i].set(`geometry`,this._initialDragGeometry),this._setUpIndicators()),this._initialDragGeometry=null}}_keyDownHandler(e){e.key!==`a`&&e.key!==`d`&&e.key!==`n`||this.state!==`moving`||e.stopPropagation()}_findTargetGraphic(e){let t=this.view.toMap(e),n=this.graphics,r=null,i=Number.MAX_VALUE;this._syncLayerViews();let a=this._layerViews.flatMap(e=>`graphicsViews`in e?Array.from(e.graphicsViews(),e=>e.hitTest(t)).flat():e.graphicsView.hitTest(t)).filter(e=>n.includes(e)).sort((e,t)=>n.indexOf(e)-n.indexOf(t));return a.length?a[0]:(this._manipulators.forEach(t=>{let n=t.intersectionDistance(e);n!=null&&n<i&&(i=n,r=t.graphic)}),r)}_syncLayerViews(){this._layerViews=[];let e=new Set;for(let t of this.graphics){let n=g(this.view,t.layer);n&&e.add(n)}this._layerViews=[...e]}_setUpManipulators(){let{graphics:e,view:t}=this;this._manipulators.forEach(e=>e.destroy()),this._manipulators=e.length?e.map(e=>new v({graphic:e,view:t})):[]}_setUpHighlights(){this.highlightsEnabled&&this.graphics.length&&this._highlightHelper.add(this.graphics,this.highlightName)}_setUpIndicators(){if(this._removeIndicators(),this.indicatorsEnabled){for(let e of this.graphics){let t=e.clone();t.symbol=N(e),this._indicators.push(t),this.addHandles(d(()=>e.symbol,()=>this._setUpIndicators()),j)}this.layer.addMany(this._indicators)}}_removeIndicators(){this.removeHandles(j),this._indicators.length&&(this.layer.removeMany(this._indicators),this._indicators.forEach(e=>e.destroy()),this._indicators=[])}};function N(e){if(e.symbol==null)return null;switch(e.symbol.type){case`cim`:return new n({style:`circle`,size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}});case`picture-marker`:{let{xoffset:t,yoffset:r,height:i,width:a}=e.symbol;return new n({xoffset:t,yoffset:r,size:i===a?a:Math.max(i,a),style:`square`,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case`simple-marker`:{let{xoffset:t,yoffset:r,size:i,style:a}=e.symbol;return new n({xoffset:t,yoffset:r,style:a===`circle`?`circle`:`square`,size:i+2,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case`simple-fill`:return new a({color:[0,0,0,0],outline:{style:`dash`,color:[255,127,0,1],width:1}});case`simple-line`:return new u({color:[255,127,0,1],style:`dash`,width:1});case`text`:{let{xoffset:t,yoffset:r}=e.symbol;return new n({xoffset:t,yoffset:r,size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}default:return null}}l([t()],M.prototype,`_activeGraphic`,void 0),l([t({readOnly:!0})],M.prototype,`type`,void 0),l([t()],M.prototype,`callbacks`,void 0),l([t()],M.prototype,`enableMoveAllGraphics`,void 0),l([t()],M.prototype,`graphics`,void 0),l([t()],M.prototype,`highlightName`,void 0),l([t()],M.prototype,`highlightsEnabled`,void 0),l([t()],M.prototype,`indicatorsEnabled`,void 0),l([t()],M.prototype,`_defaultLayer`,void 0),l([t()],M.prototype,`layer`,void 0),l([t({readOnly:!0})],M.prototype,`state`,null),l([t()],M.prototype,`view`,void 0),M=l([i(`esri.views.draw.support.GraphicMover`)],M);var P=M;export{x as n,P as t};