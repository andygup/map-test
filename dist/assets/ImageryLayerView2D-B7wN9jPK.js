import{$T as e,Aw as t,BT as n,CE as r,Dd as i,ED as a,En as o,Ex as s,Od as c,TS as l,VT as u,ZS as d,cv as f,hv as p,id as m,kD as h,mv as g,oT as _,pT as v,pd as y,pv as b,rE as x,sD as S,tT as C,vx as w}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import"./streamLayerUtils-82UmlW-3.js";import{n as ee}from"./QueueProcessor-D6ozkjY6.js";import"./earcut-CEMcWA4Z.js";import"./layerViewUtils-CJcMVuwG.js";import{t as te}from"./popupUtils-z3ynpNjO.js";import"./tagSymbols-67pK6deD.js";import"./PixelBlock-D0vUlFM9.js";import{s as T,y as E}from"./vectorFieldUtils-BkGOIhR4.js";import"./colorUtils-CzajW9E7.js";import{r as D}from"./rasterFieldUtils-D1_HkZOo.js";import"./dataUtils-CwkEyGtp.js";import{i as O,r as k,u as A}from"./rasterProjectionHelper-BpX32CQ6.js";import{t as j}from"./clipUtils-D_rTuWN2.js";import"./timeSupport-vK4lVcYW.js";import"./queryUtils-DGU5ISbw.js";import"./normalizeUtilsSync-TXjrdJAe.js";import"./GeometryUtils-B-8QW9FG.js";import"./VertexAttributeLocations-BScEla0R.js";import"./VertexElementDescriptor-Cl_nC_ty.js";import"./labelPoint-1O-zXr9b.js";import"./callExpressionWithCursor-CKz4lb1p.js";import"./FeatureMetadata-rc_NIaUe.js";import"./CIMSymbolHelper-B2DBxDPE.js";import"./rasterizingUtils-BsmZb-O9.js";import"./Rect-LbcnjDUG.js";import"./BoundingBox-Dtf81F-g.js";import"./BidiEngine-DvXbVJau.js";import"./callExpressionWithFeature-UlbvTUQ4.js";import"./OverrideHelper-BahbnLvz.js";import"./FeatureCommandQueue-2UJWGVaq.js";import"./config-Dk3C6lVr.js";import"./dehydratedFeatureComparison-BCFMkftR.js";import{t as M}from"./WGLContainer-jm6ZclzQ.js";import"./utils-B0heZPZY.js";import"./ProgramTemplate-B9k_04Md.js";import"./VertexArrayObject-ChtD6bwg.js";import"./BufferObject-B3_aJU6V.js";import"./VertexBuffer-Ra4pb4dR.js";import"./vec3f32-DDMWoxUL.js";import{t as N}from"./Container-uEjPEzbR.js";import"./GraphShaderModule-AgkKIWM0.js";import"./FramebufferObject-BoYk_2uK.js";import"./ShaderBuilder-BLOqjpgt.js";import"./bitmapUtils-53gkfkJ0.js";import{i as P}from"./Bitmap-BoQaGe8r.js";import{t as F}from"./BitmapContainer-C6h9gf6w.js";import{t as I}from"./LayerView2D-Bgb1zyoa.js";import{t as L}from"./ExportStrategy-DZKCAuVC.js";import{t as R}from"./LayerView-DQaVI2FN.js";import{t as z}from"./RefreshableLayerView-DdPullJP.js";import{t as B}from"./timeSupport-HhBEqX5E.js";import"./UpdateTracking2D-BMTZzgpI.js";import"./TechniqueInstance-fDAaVtEH.js";import"./TileContainer-BL1bFhTv.js";import"./constants-BOI_CTg-.js";import"./utils-DmZFjYOb.js";import{t as V}from"./highlightOptionsUtils-DmkXKeuF.js";import"./AGraphicContainer-DHUNjrd-.js";import"./ComputedAttributeStorage-BgTqXVQM.js";import{t as H}from"./GraphicsView2D-CUXbaTHc.js";import"./dehydratedFeatures-D5ZOMtMh.js";import"./loadUtils-D_sDj-lv.js";import{n as U,r as W,t as G}from"./RasterVFDisplayObject-CfcwWeND.js";import{t as K}from"./HighlightGraphicContainer-IlTNsfaD.js";import{n as q,t as J}from"./highlightUtils-DVCBHSz1.js";var Y=class extends t{constructor(){super(...arguments),this.attached=!1,this.container=new N,this.updateRequested=!1,this.pixelHighlights=[],this.type=`imagery`,this._bitmapView=new F}destroy(){this.attached&&=(this.detach(),!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(e){this.strategy.update(e).catch(e=>{_(e)||r.getLogger(this).error(e)})}hitTest(e){return new c({attributes:{},geometry:e.clone(),layer:this.layer})}attach(){this.container.addChild(this._bitmapView);let e=this.layer.version>=10,t=this.layer.version>=10.1?this.layer.imageMaxHeight:2048,n=this.layer.version>=10.1?this.layer.imageMaxWidth:2048;this.strategy=new L({container:this._bitmapView,imageNormalizationSupported:e,imageMaxHeight:t,imageMaxWidth:n,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()})}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren(),this.updateRequested=!1}redraw(){this.strategy.updateExports(async e=>{let{source:t}=e;if(!t||t instanceof ImageBitmap)return;let n=t.originalPixelBlock??t.pixelBlock,{pixelHighlights:r}=this,i=r.length>0,a=await this.layer.applyRenderer({extent:t.extent,pixelBlock:n,isRawData:i}),o=a.pixelBlock;i&&n&&o&&await this.layer.highlightPixels({pixelBlock:n,renderedPixelBlock:o,highlightOptions:r}),t.filter=e=>this.layer.pixelFilter?this.layer.applyFilter(e):{...a,extent:t.extent}}).catch(e=>{_(e)||r.getLogger(this).error(e)})}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;let e=this.strategy.bitmaps;if(e.length===1&&e[0].source)return{extent:e[0].source.extent,pixelBlock:e[0].source.originalPixelBlock};if(e.length>1){let t=this.view.extent,n=e.map(e=>e.source).filter(e=>e.extent&&e.extent.intersects(t)).map(e=>({extent:e.extent,pixelBlock:e.originalPixelBlock})),r=E(n,t);return r==null?null:{extent:r.extent,pixelBlock:r.pixelBlock}}return null}async _fetchImage(e,t,n,r){(r||={}).timeExtent=this.timeExtent;let i=this.pixelHighlights.length>0;r.requestAsImageElement=!i,r.returnImageBitmap=!i,r.requestRawData=i;let a=await this.layer.internalFetchImage(e,t,n,r);if(a.imageBitmap)return a.imageBitmap;let o=await this.layer.applyRenderer({...a.pixelData,isRawData:i},{signal:r.signal}),s=a.pixelData.pixelBlock,c=o.pixelBlock;i&&s&&c&&await this.layer.highlightPixels({pixelBlock:s,renderedPixelBlock:c,highlightOptions:this.pixelHighlights});let l=new P(c,o.extent?.clone(),s);return l.filter=e=>this.layer.applyFilter(e),l}};h([n()],Y.prototype,`attached`,void 0),h([n()],Y.prototype,`container`,void 0),h([n()],Y.prototype,`layer`,void 0),h([n()],Y.prototype,`strategy`,void 0),h([n()],Y.prototype,`timeExtent`,void 0),h([n()],Y.prototype,`view`,void 0),h([n()],Y.prototype,`updateRequested`,void 0),h([n()],Y.prototype,`updating`,null),h([n()],Y.prototype,`pixelHighlights`,void 0),h([n()],Y.prototype,`type`,void 0),Y=h([u(`esri.views.2d.layers.imagery.ImageryView2D`)],Y);var X=class extends M{constructor(){super(...arguments),this.symbolTypes=[`triangle`]}prepareRenderPasses(e){let t=e.registerRenderPass({name:`imagery (vf)`,brushes:[U],target:()=>this.children,drawPhase:1});return[...super.prepareRenderPasses(e),t]}doRender(e){this.visible&&e.drawPhase===1&&this.symbolTypes.forEach(t=>{e.renderPass=t,super.doRender(e)})}},Z=class extends t{constructor(e){super(e),this._loading=null,this.update=C((e,t)=>this._update(e,t).catch(e=>{_(e)||r.getLogger(this).error(e)}))}get updating(){return!!this._loading}redraw(e){if(!this.container.children.length)return;let t=this.container.children[0];t.symbolizerParameters=e,t.invalidateVAO(),this.container.symbolTypes=e.style===`wind_speed`?[`scalar`,`triangle`]:e.style===`simple_scalar`?[`scalar`]:[`triangle`],this.container.requestRender()}async _update(e,t,n){if(!e.stationary)return;let{extent:r,spatialReference:i}=e.state,a=new w({xmin:r.xmin,ymin:r.ymin,xmax:r.xmax,ymax:r.ymax,spatialReference:i}),[o,s]=e.state.size;this._loading=this.fetchPixels(a,o,s,n);let c=await this._loading;this._addToDisplay(c,t,e.state),this._loading=null}_addToDisplay(e,t,n){if(e.pixelBlock==null)return this.container.children.forEach(e=>e.destroy()),void this.container.removeAllChildren();let{extent:r,pixelBlock:i}=e,a=new G(i);a.offset=[0,0],a.symbolizerParameters=t,a.rawPixelData=e,a.invalidateVAO(),a.x=r.xmin,a.y=r.ymax,a.pixelRatio=n.pixelRatio,a.rotation=n.rotation,a.resolution=n.resolution,a.width=i.width*t.symbolTileSize,a.height=i.height*t.symbolTileSize,this.container.children.forEach(e=>e.destroy()),this.container.removeAllChildren(),this.container.symbolTypes=t.style===`wind_speed`?[`scalar`,`triangle`]:t.style===`simple_scalar`?[`scalar`]:[`triangle`],this.container.addChild(a)}};h([n()],Z.prototype,`fetchPixels`,void 0),h([n()],Z.prototype,`container`,void 0),h([n()],Z.prototype,`_loading`,void 0),h([n()],Z.prototype,`updating`,null),Z=h([u(`esri.views.2d.layers.imagery.ImageryVFStrategy`)],Z);var Q=class extends t{constructor(){super(...arguments),this.attached=!1,this.container=new X,this.type=`imageryVF`,this._dataParameters={exportParametersVersion:0,bbox:``,symbolTileSize:0,time:``},this._fetchpixels=async(e,t,n,r)=>{let i=await this._projectFullExtentPromise,{layer:a}=this,{symbolTileSize:o}=a.renderer,{extent:s,width:c,height:l}=T(e,t,n,o,i);if(i!=null&&!i.intersects(e))return{extent:s,pixelBlock:null};let u={bbox:`${s.xmin}, ${s.ymin}, ${s.xmax}, ${s.ymax}`,exportParametersVersion:a.exportImageServiceParameters.version,symbolTileSize:o,time:JSON.stringify(this.timeExtent||``)};if(this._canReuseVectorFieldData(u)){let e=this.getPixelData();if(e!=null&&`${e.extent.xmin}, ${e.extent.ymin}, ${e.extent.xmax}, ${e.extent.ymax}`===u.bbox)return e}let{pixelBlock:d}=await a.fetchPixels(s,c,l,{timeExtent:this.timeExtent,interpolation:a.interpolation,signal:r});if(this._dataParameters=u,d==null)return{extent:s,pixelBlock:null};let{dataType:f}=a.rasterInfo;return{extent:s,pixelBlock:f===`vector-uv`&&d?await a.convertVectorFieldData(d,`vector-uv`,{signal:r}):d}}}get updating(){return!this.attached||this._strategy.updating}attach(){this._projectFullExtentPromise=this._getProjectedFullExtent(this.view.spatialReference),this._strategy=new Z({container:this.container,fetchPixels:this._fetchpixels}),this.addHandles(b(()=>this.layer.renderer,e=>this._updateSymbolizerParams(e),g),`attach`)}detach(){this._strategy.destroy(),this.container.children.forEach(e=>e.destroy()),this.container.removeAllChildren(),this.removeHandles(`attach`),this._strategy=this.container=this._projectFullExtentPromise=null}getPixelData(){let e=this.container.children[0]?.rawPixelData;if(this.updating||!e)return null;let{extent:t,pixelBlock:n}=e;return{extent:t,pixelBlock:n}}hitTest(e){return new c({attributes:{},geometry:e.clone(),layer:this.layer})}update(e){this._strategy.update(e,this._symbolizerParams).catch(e=>{_(e)||r.getLogger(this).error(e)})}redraw(){let{renderer:e}=this.layer;e&&(this._updateSymbolizerParams(e),this._strategy.redraw(this._symbolizerParams))}_canReuseVectorFieldData(e){let t=this._dataParameters.exportParametersVersion===e.exportParametersVersion,n=this._dataParameters.time===e.time,r=this._dataParameters.symbolTileSize===e.symbolTileSize,i=this._dataParameters.bbox===e.bbox;return t&&n&&r&&i}async _getProjectedFullExtent(e){try{return k(this.layer.fullExtent,e)}catch{try{let t=(await d(this.layer.url,{query:{option:`footprints`,outSR:l(e),f:`json`}})).data.featureCollection.layers[0].layerDefinition.extent;return t?w.fromJSON(t):null}catch{return null}}}_updateSymbolizerParams(e){e?.type===`vector-field`&&(this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null}))}};h([n()],Q.prototype,`attached`,void 0),h([n()],Q.prototype,`container`,void 0),h([n()],Q.prototype,`layer`,void 0),h([n()],Q.prototype,`timeExtent`,void 0),h([n()],Q.prototype,`type`,void 0),h([n()],Q.prototype,`view`,void 0),h([n()],Q.prototype,`updating`,null),Q=h([u(`esri.views.2d.layers.imagery.VectorFieldView2D`)],Q);var ne=t=>{let r=t,i=class extends r{constructor(...e){super(...e),this.view=null}get timeExtent(){return B(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}async fetchPopupFeaturesAtLocation(t,n){let{layer:r}=this;if(!t)throw new e(`imagerylayerview:fetchPopupFeatures`,`Nothing to fetch without area`,{layer:r});let{popupEnabled:i}=r,a=te(r,n);if(!i||a==null)return[];let c=await a.getRequiredFields(null,{index:new o(r.rasterFields),partitions:new Map([[`$pixel`,r.rasterFields.filter(e=>e.name.startsWith(D)).map(e=>e.name)],[`$imageCollectionItem`,r.fields.map(e=>e.name)]])});v(n);let l=new y;l.timeExtent=this.timeExtent,l.geometry=t,l.outFields=c,l.outSpatialReference=t.spatialReference;let{resolution:u,spatialReference:d}=this.view,f=this.view.type===`2d`?new s(u,u,d):new s(.5*u,.5*u,d),{returnTopmostRaster:p,showNoDataRecords:m}=a.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},h={returnDomainValues:!0,returnTopmostRaster:p,pixelSize:f,showNoDataRecords:m,signal:n?.signal};return r.queryVisibleRasters(l,h)}async getSourceScale(){return await A(),await this.layer.load(),O(this.layer.serviceRasterInfo,this.view.spatialReference)}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return h([n()],i.prototype,`layer`,void 0),h([n()],i.prototype,`suspended`,void 0),h([n({readOnly:!0})],i.prototype,`timeExtent`,null),h([n()],i.prototype,`view`,void 0),i=h([u(`esri.views.layers.ImageryLayerViewMixin`)],i),i},$=class extends ne(z(I(R))){constructor(){super(...arguments),this._exportImageVersion=-1,this._highlightGraphics=new i,this._highlightView=void 0,this._pixelHighlights=[],this.layer=null,this.subview=null}get pixelData(){let{subview:e}=this;return this.updating||!e?null:`getPixelData`in e?e.getPixelData():null}update(e){this.subview?.update(e)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.view&&(this._highlightView=new H({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new K(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container)),this.addAttachHandles([b(()=>this.layer.exportImageServiceParameters.version,e=>{e&&this._exportImageVersion!==e&&(this._exportImageVersion=e,this.requestUpdate())},f),b(()=>this.timeExtent,e=>{let{subview:t}=this;t&&(t.timeExtent=e,`redraw`in t?this.requestUpdate():t.redrawOrRefetch())},f),this.layer.on(`redraw`,()=>{let{subview:e}=this;e&&(`redraw`in e?e.redraw():e.redrawOrRefetch())}),b(()=>this.layer.renderer,()=>this._setSubView()),b(()=>this.view.highlights.items.map(({name:e,color:t})=>({name:e,color:t})),()=>this._updateHighlightOptions(this.subview))])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.container.removeAllChildren(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null,this._highlightView?.destroy(),this._exportImageVersion=-1}viewChange(){}moveEnd(){this.requestUpdate()}highlight(e,t){if(J(e))return q(e)?x():this._highlightPixels(e,t);if(typeof e==`number`||typeof e==`string`)return this._highlightByImageIds([e],t);let n=Array.isArray(e)||p.isCollection(e)?e.at(0):e;if(typeof n==`number`||typeof n==`string`)return this._highlightByImageIds(e,t);if(!(n instanceof c))return x();let r=[];if(Array.isArray(e)||p.isCollection(e)?r=e.map(e=>e.clone()):e instanceof c&&(r=[e.clone()]),!r?.filter(S)?.length)return x();let i=V(t);return this._addHighlightGraphics(r,i),x(()=>!this.destroyed&&this._removeHighlightGraphics(r,i))}_highlightByImageIds(e,t){let n=V(t),r=new AbortController,{signal:i}=r,a=this.layer.sourceJSON.maxRecordCount??1e3,o=Math.ceil(e.length/a),s=[],c=[],l=new ee({concurrency:4,process:e=>this.layer.queryFeatures({objectIds:e.ids,returnGeometry:!0,outSpatialReference:this.view.spatialReference},{signal:i}).then(e=>c.push(...e.features)).catch(()=>{})});for(let t=0;t<o;t++)s.push(l.push({ids:e.slice(t*a,(t+1)*a)}));return Promise.allSettled(s).then(()=>{c.length&&!i.aborted&&(this._addHighlightGraphics(c,n),i.addEventListener(`abort`,()=>{this._removeHighlightGraphics(c,n)}))}),x(()=>r.abort())}_highlightPixels(e,t){let n={target:e,options:t};return this._pixelHighlights.push(n),this._updateHighlightOptions(this.subview),x(()=>{let e=this._pixelHighlights.indexOf(n);e>-1&&(this._pixelHighlights.splice(e,1),this._updateHighlightOptions(this.subview))})}_addHighlightGraphics(e,t){this._highlightGraphics.addMany(e),this._addHighlights(e.map(e=>e.uid),t)}_removeHighlightGraphics(e,t){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map(e=>e.uid),t)}async doRefresh(){this.requestUpdate()}isUpdating(){let e=!this.subview||this.subview.updating||!!this._highlightView?.updating;return a(`esri-2d-log-updating`)&&console.log(`Updating ImageryLayerView2D (${this.layer.id}): ${e}\n-> subview ${!this.subview||this.subview.updating}\n-> higlightView ${this._highlightView?.updating}\n`),e}_processHighlight(){let e=this._getHighlights();this._highlightView?.setHighlight(e)}_setSubView(){if(!this.view)return;let e=this.layer.renderer?.type,t=`imagery`;if(e===`vector-field`?t=`imageryVF`:e===`flow`&&(t=`flow`),this.subview){let{type:e}=this.subview;if(e===t)return this._attachSubview(this.subview),void(e===`flow`?this.subview.redrawOrRefetch():e===`imagery`&&this.layer.format===`lerc`?this.subview.redraw():this.requestUpdate());this._detachSubview(this.subview),this.subview?.destroy()}t===`imagery`?(this.subview=new Y({layer:this.layer,view:this.view,timeExtent:this.timeExtent}),this._updateHighlightOptions(this.subview)):this.subview=t===`imageryVF`?new Q({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new W({layer:this.layer,layerView:this}),this._attachSubview(this.subview),this.requestUpdate()}_attachSubview(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0))}_detachSubview(e){e?.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)}_updateHighlightOptions(e){let t=this.view.highlights;this._pixelHighlights.sort((e,n)=>t.findIndex(({name:e})=>e===V(n.options))-t.findIndex(({name:t})=>t===V(e.options)));let n=this._pixelHighlights.map(({target:e,options:n})=>re(e,t,n)).filter(S);e?.type===`imagery`&&(e.pixelHighlights=n,e.attached&&(this.layer.format===`lerc`?e.redraw():this.requestUpdate()))}};function re(e,t,n){let r=V(n),i=(t.find(e=>e.name===r)?.color??m).toArray(),{pixelRanges:a}=e;if(Array.isArray(a))return{ranges:a,bandId:e.bandId??0,color:i};let o=a.type===`extent`?a:a.extent;if(!o)return;let s=[o.xmin,o.xmax],c=[o.ymin,o.ymax],{xBandId:l,yBandId:u}=e,d=1024,f=1024;return{xBandId:l,yBandId:u,xBandRange:s,yBandRange:c,color:i,width:d,height:f,xyMask:a.type===`polygon`?j({srcExtent:o,geometry:a,size:[d,f]}):void 0}}h([n()],$.prototype,`pixelData`,null),h([n()],$.prototype,`subview`,void 0),$=h([u(`esri.views.2d.layers.ImageryLayerView2D`)],$);var ie=$;export{ie as default};