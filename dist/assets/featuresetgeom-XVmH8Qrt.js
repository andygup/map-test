import{TD as e,mn as t,uy as n,wn as r}from"./index-BN8X5Ryz.js";import{n as i}from"./arcadeEnvironment-DUP-IKH2.js";import"./ImmutableArray-C3KNQCVd.js";import{A as a,G as o,X as s,_ as c,s as l}from"./Dictionary-Db5-uVgu.js";import{n as u}from"./shared-Bq4SQ-mm.js";import"./number-bRvGjlJj.js";import"./Feature-BbsZTluv.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import"./WhereClause-CATd9kVz.js";import{t as d}from"./operatorsWorkerConnection-DOouwDAw.js";import{C as f,S as p,i as m}from"./FeatureSet-Mo_jGewE.js";import{t as h}from"./Empty-DGPqEhPn.js";var g=class extends m{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.actions.SpatialFilter`,this._maxProcessing=40,this._parent=e.parentfeatureset,this._relation=e.relation,this._relationString=e.relationString??``,this._relationGeom=e.relationGeom}get _spatialFilter(){return{relation:this._relation===`esriSpatialRelRelation`?`esriSpatialRelRelation:${this._relationString}`:this._relation,geometry:this._relationGeom}}async _queryAll(){return(await this.query({abortSignal:i})).features}async query(e){await this._ensureLoaded();let t=await this._parent.query({...e,spatialFilter:this._spatialFilter});return f(e.abortSignal),{...t,spatialFilterApplied:e.spatialFilter==null,features:t.spatialFilterApplied?t.features:this._applySpatialFilter(t.features,e.abortSignal)}}async*_applySpatialFilter(e,t){for await(let n of e){f(t);let e=[];for(let t of n)await this._executeSpatialRelationTest(t)&&e.push(t);e.length>0&&(yield e)}}async queryStat(e){if(e.spatialFilter!=null)return{calculated:!1};let t=await this._parent.queryStat({...e,spatialFilter:this._spatialFilter});return t.calculated?t:e.where==null&&e.spatialFilter==null?this._manualStat(e.stat,e.field,e.limit??1e3,e.abortSignal):{calculated:!1}}async canQueryAggregate(e){return e.spatialFilter==null&&this._parent.canQueryAggregate({...e,spatialFilter:this._spatialFilter})}async queryAggregate(e){if(e.spatialFilter!=null)throw new p(`NeverReach`);return this._parent.queryAggregate({...e,spatialFilter:this._spatialFilter})}async _executeSpatialRelationTest(r){if(r.geometry==null)return!1;switch(this._relation){case`esriSpatialRelEnvelopeIntersects`:{let e=t(this._relationGeom),i=n(r.geometry);return e!=null&&i!=null&&d(`intersects`,[e.toJSON(),i])}case`esriSpatialRelIntersects`:return d(`intersects`,[this._relationGeom.toJSON(),r.geometry]);case`esriSpatialRelContains`:return d(`contains`,[this._relationGeom.toJSON(),r.geometry]);case`esriSpatialRelOverlaps`:return d(`overlaps`,[this._relationGeom.toJSON(),r.geometry]);case`esriSpatialRelWithin`:return d(`within`,[this._relationGeom.toJSON(),r.geometry]);case`esriSpatialRelTouches`:return d(`touches`,[this._relationGeom.toJSON(),r.geometry]);case`esriSpatialRelCrosses`:return d(`crosses`,[this._relationGeom.toJSON(),r.geometry]);case`esriSpatialRelRelation`:return d(`relate`,[this._relationGeom.toJSON(),r.geometry,this._relationString]);default:return e(this._relation),!1}}getFieldsIndex(){return this._parent.getFieldsIndex()}};function _(e){return async(n,i,o)=>{if(s(o,2,2,n,i),(o=c(o))[0]===null&&o[1]===null)return!1;if(l(o[0])){if(a(o[1]))return new g({parentfeatureset:o[0],relation:e,relationGeom:o[1]});if(o[1]===null)return new h({parentfeatureset:o[0]});throw new r(n,`InvalidParameter`,i)}if(a(o[0])){if(a(o[1])){switch(e){case`esriSpatialRelEnvelopeIntersects`:{let e=t(o[0]),n=t(o[1]);return e!=null&&n!=null&&d(`intersects`,[e.toJSON(),n.toJSON()])}case`esriSpatialRelIntersects`:return d(`intersects`,[o[0].toJSON(),o[1].toJSON()]);case`esriSpatialRelContains`:return d(`contains`,[o[0].toJSON(),o[1].toJSON()]);case`esriSpatialRelOverlaps`:return d(`overlaps`,[o[0].toJSON(),o[1].toJSON()]);case`esriSpatialRelWithin`:return d(`within`,[o[0].toJSON(),o[1].toJSON()]);case`esriSpatialRelTouches`:return d(`touches`,[o[0].toJSON(),o[1].toJSON()]);case`esriSpatialRelCrosses`:return d(`crosses`,[o[0].toJSON(),o[1].toJSON()])}throw new r(n,`InvalidParameter`,i)}if(l(o[1]))return new g({parentfeatureset:o[1],relation:e,relationGeom:o[0]});if(o[1]===null)return!1;throw new r(n,`InvalidParameter`,i)}if(o[0]===null){if(l(o[1]))return new h({parentfeatureset:o[1]});if(a(o[1])||o[1]===null)return!1}throw new r(n,`InvalidParameter`,i)}}function v(e){e.mode===`async`&&(e.functions.intersects=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelIntersects`))},e.functions.envelopeintersects=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelEnvelopeIntersects`))},e.signatures.push({name:`envelopeintersects`,min:2,max:2}),e.functions.contains=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelContains`))},e.functions.overlaps=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelOverlaps`))},e.functions.within=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelWithin`))},e.functions.touches=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelTouches`))},e.functions.crosses=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelCrosses`))},e.functions.relate=function(t,n){return e.standardFunctionAsync(t,n,async(e,i,u)=>{if(u=c(u),s(u,3,3,t,n),a(u[0])&&a(u[1]))return d(`relate`,[u[0].toJSON(),u[1].toJSON(),o(u[2])]);if(a(u[0])&&u[1]===null||a(u[1])&&u[0]===null)return!1;if(l(u[0])&&u[1]===null)return new h({parentfeatureset:u[0]});if(l(u[1])&&u[0]===null)return new h({parentfeatureset:u[1]});if(l(u[0])&&a(u[1]))return new g({parentfeatureset:u[0],relation:`esriSpatialRelRelation`,relationGeom:u[1],relationString:o(u[2])});if(l(u[1])&&a(u[0]))return new g({parentfeatureset:u[1],relation:`esriSpatialRelRelation`,relationGeom:u[0],relationString:o(u[2])});if(u[0]===null&&u[1]===null)return!1;throw new r(t,`InvalidParameter`,n)})})}export{v as registerFunctions};