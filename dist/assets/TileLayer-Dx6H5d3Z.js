import{A as e,AT as t,BT as n,DT as r,Dh as i,EC as a,Ha as o,Jw as s,L as c,Li as l,M as u,OT as d,RS as f,Rh as p,WS as m,YS as h,cC as g,ca as _,gC as v,gD as y,j as b,jT as x,kT as S,ma as C,pa as w,qS as T,ua as E,wx as D,zi as O}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./OptimizedFeatureSet-CTIqq8fn.js";import"./featureConversionUtils-_DSSMFQ2.js";import"./urlUtils-BholpLvl.js";import{t as k}from"./imageBitmapUtils-DDIV6X3i.js";import"./pbf-wXxPPz7x.js";import"./pbfQueryUtils-q4mcHKpQ.js";import"./queryUtils-D1dUonfL.js";import"./query-C5yhs-oW.js";import"./executeForIds--WTxiX90.js";import"./executeQueryJSON-DqSFIBMl.js";import"./executeQueryPBF-BiLBbjFv.js";import"./QueryTask-B-24FCQu.js";import"./TileInfoTilemapCache-B4g2sXyM.js";import"./TilemapCache-BW-78K6J.js";import{t as A}from"./ArcGISCachedService-CRfKye1j.js";import{n as j,r as M,t as N}from"./SublayersOwner-CXNGXCkS.js";import"./sublayerUtils-B_4dS-HF.js";var P,F=[`Canvas/World_Dark_Gray_Base`,`Canvas/World_Dark_Gray_Reference`,`Canvas/World_Light_Gray_Base`,`Canvas/World_Light_Gray_Reference`,`Elevation/World_Hillshade`,`Elevation/World_Hillshade_Dark`,`Ocean/World_Ocean_Base`,`Ocean/World_Ocean_Reference`,`Ocean_Basemap`,`Reference/World_Boundaries_and_Places`,`Reference/World_Boundaries_and_Places_Alternate`,`Reference/World_Transportation`,`World_Imagery`,`World_Street_Map`,`World_Topo_Map`],I=P=class extends E(e(N(A(M(c(u(w(o(b(C(_(i)))))))))))){constructor(...e){super(...e),this.listMode=`show`,this.elevationInfo=new O({mode:`on-the-ground`}),this.isReference=null,this.operationalLayerType=`ArcGISTiledMapServiceLayer`,this.resampling=!0,this.sourceJSON=null,this.spatialReference=null,this.path=null,this.sublayers=null,this.type=`tile`,this.url=null}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}load(e){let t=e==null?null:e.signal;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:[`Map Service`]},e).catch(s).then(()=>this._fetchService(t))),Promise.resolve(this)}get attributionDataUrl(){let e=this.parsedUrl?.path.toLowerCase();return e?this._getDefaultAttribution(this._getMapName(e)):null}get hasAttributionData(){return super.hasAttributionData}readSpatialReference(e,t){return(e||=t.tileInfo?.spatialReference)&&D.fromJSON(e)}writeSublayers(e,t,n,r){if(!this.loaded||!e)return;let i=e.slice().reverse().flatten(({sublayers:e})=>e&&e.toArray().reverse()).toArray(),a=[],o={writeSublayerStructure:!1,...r};i.forEach(e=>{let t=e.write({},o);a.push(t)}),a.some(e=>Object.keys(e).length>1)&&(t.layers=a)}get tileServers(){return this._getDefaultTileServers(this.parsedUrl?.path)}castTileServers(e){return Array.isArray(e)?e.map(e=>v(e).path):null}fetchTile(e,t,n,r={}){let{signal:i}=r,a=this.getTileUrl(e,t,n),o={responseType:`image`,signal:i,query:{...this.refreshParameters}};return f(a,o).then(e=>e.data)}async fetchImageBitmapTile(e,t,n,r={}){let{signal:i}=r;if(this.fetchTile!==P.prototype.fetchTile){let a=await this.fetchTile(e,t,n,r);return k(a,e,t,n,i)}let a=this.getTileUrl(e,t,n),o={responseType:`blob`,signal:i,query:{...this.refreshParameters}},{data:s}=await f(a,o);return k(s,e,t,n,i)}getTileUrl(e,t,n){let r=!this.capabilities.operations.supportsTileMap&&this.supportsBlankTile,i=g({...this.parsedUrl?.query,blankTile:!r&&null,...this.customParameters,token:this.apiKey}),a=this.tileServers;return`${a&&a.length?a[t%a.length]:this.parsedUrl?.path}/tile/${e}/${t}/${n}${i?`?`+i:``}`}loadAll(){return p(this,e=>{e(this.allSublayers)})}_fetchService(e){return new Promise((t,r)=>{if(this.sourceJSON){if(this.sourceJSON.bandCount!=null&&this.sourceJSON.pixelSizeX!=null)throw new n(`tile-layer:unsupported-url`,`use ImageryTileLayer to open a tiled image service`);t({data:this.sourceJSON});return}if(!this.parsedUrl)throw new n(`tile-layer:undefined-url`,`layer's url is not defined`);let i=T(this.parsedUrl.path);if(i!=null&&i.serverType===`ImageServer`)throw new n(`tile-layer:unsupported-url`,`use ImageryTileLayer to open a tiled image service`);f(this.parsedUrl.path,{query:{f:`json`,...this.parsedUrl.query,...this.customParameters,token:this.apiKey},responseType:`json`,signal:e}).then(t,r)}).then(t=>{let n=this.url;if(t.ssl&&(n=this.url=n.replace(/^http:/i,`https:`)),this.sourceJSON=t.data,this.read(t.data,{origin:`service`,url:this.parsedUrl}),this.version===10.1&&!h(n))return this._fetchServerVersion(n,e).then(e=>{this.read({currentVersion:e})}).catch(()=>{})})}_fetchServerVersion(e,t){if(!m(e))return Promise.reject();let r=e.replace(/(.*\/rest)\/.*/i,`$1`)+`/info`;return f(r,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:t}).then(e=>{if(e.data?.currentVersion)return e.data.currentVersion;throw new n(`tile-layer:version-not-available`,`Server did not provide a version`)})}_getMapName(e){let t=e.match(/^(?:https?:)?\/\/(server\.arcgisonline\.com|services\.arcgisonline\.com|ibasemaps-api\.arcgis\.com)\/arcgis\/rest\/services\/([^/]+(\/[^/]+)*)\/mapserver/i);return t?t[2]:void 0}_getDefaultAttribution(e){if(e==null)return null;let t;e=e.toLowerCase();for(let n=0,r=F.length;n<r;n++)if(t=F[n],t.toLowerCase().includes(e))return a(`//static.arcgis.com/attribution/`+t);return null}_getDefaultTileServers(e){if(e==null)return[];let t=e.search(/^(?:https?:)?\/\/server\.arcgisonline\.com/i)!==-1,n=e.search(/^(?:https?:)?\/\/services\.arcgisonline\.com/i)!==-1;return t||n?[e,e.replace(t?/server\.arcgisonline/i:/services\.arcgisonline/i,t?`services.arcgisonline`:`server.arcgisonline`)]:[]}get hasOverriddenFetchTile(){return!this.fetchTile[L]}};y([r({readOnly:!0})],I.prototype,`attributionDataUrl`,null),y([r({type:[`show`,`hide`,`hide-children`]})],I.prototype,`listMode`,void 0),y([r({json:{read:!0,write:!0}})],I.prototype,`blendMode`,void 0),y([r()],I.prototype,`elevationInfo`,void 0),y([r({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],I.prototype,`isReference`,void 0),y([r({readOnly:!0,type:[`ArcGISTiledMapServiceLayer`]})],I.prototype,`operationalLayerType`,void 0),y([r({type:Boolean})],I.prototype,`resampling`,void 0),y([r()],I.prototype,`sourceJSON`,void 0),y([r({type:D})],I.prototype,`spatialReference`,void 0),y([x(`spatialReference`,[`spatialReference`,`tileInfo`])],I.prototype,`readSpatialReference`,null),y([r({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],I.prototype,`path`,void 0),y([r({readOnly:!0})],I.prototype,`sublayers`,void 0),y([t(`sublayers`,{layers:{type:[j]}})],I.prototype,`writeSublayers`,null),y([r({json:{read:!1,write:!1}})],I.prototype,`popupEnabled`,void 0),y([r()],I.prototype,`tileServers`,null),y([S(`tileServers`)],I.prototype,`castTileServers`,null),y([r({readOnly:!0,json:{read:!1}})],I.prototype,`type`,void 0),y([r(l)],I.prototype,`url`,void 0),I=P=y([d(`esri.layers.TileLayer`)],I);var L=Symbol(`default-fetch-tile`);I.prototype.fetchTile[L]=!0;var R=I;export{R as default};