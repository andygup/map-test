import{$S as e,$m as t,A as n,AT as r,BT as i,DT as a,Dh as o,Ha as s,Jw as c,L as l,Li as u,M as d,OT as f,QS as p,SC as m,Z_ as h,aE as g,ca as _,gD as v,iv as y,j as b,jT as x,lT as S,nv as C,pa as w,uE as T,uT as E,ua as D,wC as O}from"./index-CzMixifc.js";import"./memoryEstimations-C3WUBUZI.js";import"./OptimizedGeometry-5fDazGe-.js";import"./OptimizedFeatureSet-D4F9ObY_.js";import"./featureConversionUtils-VvJ2pauf.js";import"./WhereClause-2gh-KjwG.js";import"./Relationship-C2v8kGut.js";import"./GraphQueryStreaming-C5FsQ1F8.js";import"./WhereClauseCache-D_968G_6.js";import"./PooledRBush-OI-c3i-A.js";import"./QueryEngineCapabilities-COyCnRVj.js";import"./clientSideDefaults-4m0UtucK.js";import"./generateRendererUtils-Boi4GqnB.js";import"./utils-nAxNAb0W.js";import"./cimSymbolUtils-Dwr_LmxD.js";import"./utils-BroCumRv.js";import{_ as k,i as A,n as j,r as M,t as N,v as P}from"./KnowledgeGraphSublayer-CK27JmM0.js";import{M as F}from"./knowledgeGraphService-Cq7hahmh.js";import"./constants-DP4YtCHp.js";import"./GraphicsLayer-CSZ-X1QF.js";import"./networkEnums-B1KLygK2.js";import"./GPMessage-BBSToJRu.js";import"./BoundsStore-DZ48kmJe.js";import"./timeSupport-CjNpK2fD.js";import"./optimizedFeatureQueryEngineAdapter-DhyuxDon.js";import"./FeatureStore-Fclv32GR.js";import"./QueryEngine-DJKNHkzn.js";import"./queryUtils-fxq7u50x.js";import"./quantizationUtils-CzrQVcZ1.js";import"./utils-BUI45WL8.js";import"./utils-Cm-RG8rq.js";import"./SnappingCandidate-BMrZX9Ey.js";import"./FixedIntervalBinParameters-5fcY6iRA.js";var I=class extends D(n(b(w(l(d(s(_(o)))))))){constructor(e){super(e),this._graphTypeLookup=new Map,this._namedTypesModified=!1,this.dataManager=null,this.definitionSetMap=null,this.knowledgeGraph=null,this.layers=new(y.ofType(N)),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType=`KnowledgeGraphLayer`,this.sublayerIdsCache=new Map,this.tables=new(y.ofType(N)),this.type=`knowledge-graph`,this.url=null,this.addHandles(C(()=>this.layers.concat(this.tables),(e,t)=>this._handleSublayersChange(e,t),h))}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}async _doLoad(e){try{await this.loadFromPortal({supportedTypes:[`Knowledge Graph Layer`]},e)}catch(e){c(e)}await this._fetchMetadata(),await this._initializeLayerProperties(e),this.loadLayerAssumingLocalCache(),this._layersLoadedFromAuthoritativeItem()||await j(this)}async _fetchMetadata(){if(!this.url)throw new i(`knowledge-graph:missing-url`,`KnowledgeGraphLayer must be created with a url`);this.knowledgeGraph=await F(this.url),this._forEachGraphType(e=>{e.name&&this._graphTypeLookup.set(e.name,e)})}async _initializeLayerProperties(e){this.originIdOf(`inclusionModeDefinition`)===7?this._validateInclusionModeDefinition():await this._initializeInclusionModeDefinition(e),this._setMemberTypes(),this.dataManager=new A({knowledgeGraph:this.knowledgeGraph,inclusionModeDefinition:this.inclusionModeDefinition})}async _initializeInclusionModeDefinition(e){let t=this.definitionSetMap?await k(this.definitionSetMap,!0,e?.signal?{signal:e.signal}:void 0):{generateAllSublayers:!0,namedTypeDefinitions:new Map};[...this.layers.toArray(),...this.tables.toArray()].forEach(e=>{let n=this._graphTypeLookup.get(e.graphTypeName);n&&!t.namedTypeDefinitions.has(n.name)&&t.namedTypeDefinitions.set(n.name,{useAllData:!0})}),this.setAtOrigin(`inclusionModeDefinition`,t,E(this.originIdOf(`definitionSetMap`)))}_validateInclusionModeDefinition(){let{inclusionModeDefinition:e}=this;if(!e)return;let{namedTypeDefinitions:t}=e;if(t?.size>0)t.forEach((e,n)=>{let r=this._graphTypeLookup.get(n);if(!r)return T.getLogger(this).warn(`A named type, ${n}, was in the inclusion list that wasn't in the data model and will be removed`),void t.delete(n);r.type!==`relationship`&&r.type!==`entity`&&(T.getLogger(this).warn(`A named type, ${n}, was in the inclusion list that wasn't properly modeled and will be removed`),t.delete(n))});else if(!e.generateAllSublayers)throw new i(`knowledge-graph:composite-layer-constructor`,`If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined`)}_setMemberTypes(){let e=[],t=[],{inclusionModeDefinition:n}=this,r=n?.namedTypeDefinitions;!n||n.generateAllSublayers?(e=this.knowledgeGraph.dataModel?.entityTypes??[],t=this.knowledgeGraph.dataModel?.relationshipTypes??[]):r&&r.size>0&&r.forEach((n,r)=>{let i=this._graphTypeLookup.get(r);switch(i?.type){case`relationship`:t.push(i);break;case`entity`:e.push(i)}}),this.memberEntityTypes=e,this.memberRelationshipTypes=t}_forEachGraphType(e){[...this.knowledgeGraph.dataModel?.entityTypes??[],...this.knowledgeGraph.dataModel?.relationshipTypes??[]].forEach(t=>{e(t)})}_refreshNamedTypes(){this._namedTypesModified=!0;for(let e of this.layers)e.emit(`refresh`,{dataChanged:!0});for(let e of this.tables)e.emit(`refresh`,{dataChanged:!0})}async _handleNewRecords(e){let t=new Set,n=[];for(let r of e){if(!this._graphTypeLookup.has(r.typeName))continue;!1===this.layers.concat(this.tables).some(e=>e.objectType.name===r.typeName)&&(this.dataManager.sublayerCaches.set(r.typeName,new Map),t.add(r.typeName)),g(this.sublayerIdsCache,r.typeName,()=>new Set).add(r.id),n.push(r)}this.dataManager.addToLayer(n);for(let e of t){let t=this._graphTypeLookup.get(e);t&&(this._addSublayer(t),t.type===`entity`?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e))}await j(this,Array.from(t)),this._refreshNamedTypes()}_createSublayers(e,t,n){e.forEach(e=>{let r=this._createSublayer(e);n(r)&&t.push(r),this._updateSublayerCaches(e)})}_addSublayer(e){let t=this._createSublayer(e);return t.geometryType?this.layers.push(t):this.tables.push(t),t}_createSublayer(e){return new N({objectType:e,parentCompositeLayer:this,graphType:e.type})}_updateSublayers(e,t){t.forEach(t=>{t.parentCompositeLayer=this;let n=e.find(e=>e.type===t.graphType&&e.name===t.graphTypeName);n&&(t.objectType=n,this._updateSublayerCaches(n))})}_updateSublayerCaches({name:e}){if(!e)return;let t=this.dataManager.sublayerCaches;t.has(e)||t.set(e,new Map)}_saveUrlAsNewResource(e,t,n,r){e[t]=`<pending>`,n.pendingOperations.push(R(this.inclusionModeDefinition).then(i=>{let a=z(r);e[t]=a.itemRelativeUrl,n.toAdd.push({resource:a,content:{type:`blob`,blob:i},compress:!1,finish:e=>{this.definitionSetMap=e.url}})}))}_displaysAllRecords(e){for(let[,{useAllData:t}]of e.namedTypeDefinitions)if(!t)return!1;return!0}_handleSublayersChange(e,t){t&&(t.forEach(e=>{e.parent=null}),this.removeHandles(`sublayers-owner`)),e&&(e.forEach(e=>{e.parent=this}),this.addHandles([e.on(`after-add`,({item:e})=>{e.parent=this}),e.on(`after-remove`,({item:e})=>{e.parent=null})],`sublayers-owner`))}_layersLoadedFromAuthoritativeItem(){let e=this.originIdOf(`layers`);return e>=3&&e<7}readDefinitionSetMap(t,n,r){return e(t,r)}writeDefinitionSetMap(e,t,n,r){let i=r?.portalItem,a=r?.resources,o=S(r?.origin);if(!i||!a||o==null)return void(e&&(t[n]=p(e,r)));let{inclusionModeDefinition:s}=this;if(!s||this._displaysAllRecords(s))return void(this.definitionSetMap=null);let c=this.originIdOf(`inclusionModeDefinition`);if(c===7||this._namedTypesModified||o<c)this._saveUrlAsNewResource(t,n,a,i);else if(o===c&&e){let o=p(e,r);O(o)?this._saveUrlAsNewResource(t,n,a,i):t[n]=o}}set inclusionModeDefinition(e){this.loadStatus!==`loaded`&&this.loadStatus!==`failed`?this._set(`inclusionModeDefinition`,e):T.getLogger(this).error(`#inclusionModeDefinition`,`inclusionModeDefinition cannot be changed after the layer is loaded.`)}get sublayerCapabilities(){return M(this.knowledgeGraph)}loadLayerAssumingLocalCache(){let e=[...this.memberEntityTypes,...this.memberRelationshipTypes];this.layers.length||this.originIdOf(`tables`)===0?this.originIdOf(`layers`)===0?this._createSublayers(e,this.layers,e=>!!e.geometryType):this._updateSublayers(e,this.layers):this.layers=new y,this.tables.length||this.originIdOf(`layers`)===0?this.originIdOf(`tables`)===0?this._createSublayers(e,this.tables,e=>!e.geometryType):this._updateSublayers(e,this.tables):this.tables=new y,this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{let n=g(this.sublayerIdsCache,t,()=>new Set);e.members?.forEach(e=>{n.add(e.id)})})}async addRecords(e){await this.load(),await this._handleNewRecords(e)}async createSublayerForNamedType(e){await this.load();let t=this._graphTypeLookup.get(e);if(!t)throw new i(`knowledge-graph:missing-type`,`The specified type does not exist in the layer's graph data model.`);if(this.dataManager.sublayerCaches.has(e))throw new i(`knowledge-graph:duplicate-type`,`The specified type already exists as a sublayer.`);this.dataManager.sublayerCaches.set(e,new Map),g(this.sublayerIdsCache,e,()=>new Set);let n=this._addSublayer(t);return t.type===`entity`?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e),this.dataManager.inclusionModeDefinition&&this.dataManager.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!0}),await j(this,[e]),this._refreshNamedTypes(),n}convertSublayerToDynamicData(e){if(!this.dataManager.inclusionModeDefinition)throw new i(`knowledge-graph:fully-dynamic-membership`,`This Knowledge Graph Layer already uses fully dynamic membership, individual sublayers cannot be converted`);if(!this._graphTypeLookup.get(e))throw new i(`knowledge-graph:missing-type`,`The specified type does not exist in the layer's graph data model.`);if(!this.dataManager.sublayerCaches.has(e))throw new i(`knowledge-graph:duplicate-type`,`The specified type does not exist as a sublayer.`);this.dataManager.inclusionModeDefinition.namedTypeDefinitions.get(e)?.useAllData?T.getLogger(this).warn(`This Knowledge Graph Layer already uses dynamic membership for the sublayer - no conversion was made`):(this.dataManager.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!0}),this.sublayerIdsCache.delete(e),this._refreshNamedTypes())}convertSublayerToExplicitMembership(e){if(!this.dataManager.inclusionModeDefinition)throw new i(`knowledge-graph:fully-dynamic-membership`,`This Knowledge Graph Layer already uses fully dynamic membership, individual sublayers cannot be converted`);if(!this._graphTypeLookup.get(e))throw new i(`knowledge-graph:missing-type`,`The specified type does not exist in the layer's graph data model.`);let t=this.dataManager.inclusionModeDefinition.namedTypeDefinitions.get(e);if(!t||t.useAllData){if(!this.dataManager.sublayerCaches.has(e))throw new i(`knowledge-graph:duplicate-type`,`The specified type does not exist as a sublayer.`);this.sublayerIdsCache.set(e,new Set),this.dataManager.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:new Map}),this._refreshNamedTypes()}else T.getLogger(this).warn(`This Knowledge Graph Layer already uses explicit membership for the sublayer - no conversion was made`)}convertToFullyDynamicData(){this.dataManager.inclusionModeDefinition||T.getLogger(this).warn(`This Knowledge Graph Layer already uses fully dynamic membership - no conversion was made`),this.sublayerIdsCache.clear(),this.dataManager.inclusionModeDefinition=null,this._refreshNamedTypes()}convertToExplicitMembership(){this.dataManager.inclusionModeDefinition&&this.dataManager.inclusionModeDefinition.namedTypeDefinitions.size>0&&T.getLogger(this).warn(`This Knowledge Graph Layer already uses explicit membership - no conversion was made`),this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map};for(let e of this.dataManager.sublayerCaches.keys())g(this.sublayerIdsCache,e,()=>new Set),this.dataManager.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:new Map});this._refreshNamedTypes()}async removeRecords(e){await this.load();let t=[];for(let n of e)!1===this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(n.typeName)?.useAllData&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(n.typeName)?.members?.has(n.id)&&t.push(n);this.dataManager.removeFromLayer(t);for(let e of t)this.sublayerIdsCache.get(e.typeName)?.delete(e.id);return this._refreshNamedTypes(),t}};v([a()],I.prototype,`dataManager`,void 0),v([a({json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],I.prototype,`definitionSetMap`,void 0),v([x(`definitionSetMap`)],I.prototype,`readDefinitionSetMap`,null),v([r(`definitionSetMap`)],I.prototype,`writeDefinitionSetMap`,null),v([a()],I.prototype,`inclusionModeDefinition`,null),v([a()],I.prototype,`knowledgeGraph`,void 0),v([a({type:y.ofType(N),json:{write:{ignoreOrigin:!0}}})],I.prototype,`layers`,void 0),v([a()],I.prototype,`memberEntityTypes`,void 0),v([a()],I.prototype,`memberRelationshipTypes`,void 0),v([a({type:[`KnowledgeGraphLayer`]})],I.prototype,`operationalLayerType`,void 0),v([a()],I.prototype,`sublayerCapabilities`,null),v([a()],I.prototype,`sublayerIdsCache`,void 0),v([a({type:y.ofType(N),json:{write:{ignoreOrigin:!0}}})],I.prototype,`tables`,void 0),v([a({json:{read:!1}})],I.prototype,`type`,void 0),v([a(u)],I.prototype,`url`,void 0),I=v([f(`esri.layers.KnowledgeGraphLayer`)],I);var L=I;async function R(e){let t=await P(e);return new Blob([t],{type:`application/x-protobuf`})}function z(e){let n=`definitionSetMap-${t()}.dat`,r=m(`knowledgeGraphLayer`,n);return e.resourceFromPath(r)}export{L as default};