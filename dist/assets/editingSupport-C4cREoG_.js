import{BT as e,Ji as t,Lp as n,Lw as r,PC as i,SE as a,Xn as o,Yi as s,_S as c,dh as l,du as u,eh as d,iv as f,lS as p,pS as m,uE as h,uh as g,vd as _,wS as v}from"./index-ByaFsVj4.js";function y(e){return e?.applyEdits!=null}function b(e){return typeof e==`object`&&!!e&&`objectId`in e&&!!e.objectId}function x(e){return e.every(b)}function S(e){return typeof e==`object`&&!!e&&`globalId`in e&&!!e.globalId}function C(e){return e.every(S)}async function w(e,n,i,o={}){let c,l=`gdbVersion`in e?e.gdbVersion:null,u=o.gdbVersion??l;if(s(e)&&e.url)c=t(e.url,e.layerId,u,o.returnServiceEditsOption===`original-and-current-features`);else{c=r(),c.promise.then(t=>{(t.addedFeatures.length||t.updatedFeatures.length||t.deletedFeatures.length||t.addedAttachments.length||t.updatedAttachments.length||t.deletedAttachments.length)&&e.emit(`edits`,t)});let t={result:c.promise};e.emit(`apply-edits`,t)}try{let{results:t,edits:r}=await T(e,n,i,o),s=e=>e.filter(e=>!e.error).map(a),l={edits:r,addedFeatures:s(t.addFeatureResults),updatedFeatures:s(t.updateFeatureResults),deletedFeatures:s(t.deleteFeatureResults),addedAttachments:s(t.addAttachmentResults),updatedAttachments:s(t.updateAttachmentResults),deletedAttachments:s(t.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:t.editMoment?new Date(t.editMoment):null,globalIdToObjectId:o.globalIdToObjectId};return t.editedFeatureResults?.length&&(l.editedFeatures=t.editedFeatureResults),c.resolve(l),t}catch(e){throw c.reject(e),e}}async function T(t,n,r,i){if(await t.load(),!y(n))throw new e(`${t.type}-layer:no-editing-support`,`Layer source does not support applyEdits capability`,{layer:t});if(!g(t))throw new e(`${t.type}-layer:editing-disabled`,`Editing is disabled for layer`,{layer:t});let{edits:a,options:o}=await E(t,r,i);return a.addFeatures?.length||a.updateFeatures?.length||a.deleteFeatures?.length||a.addAttachments?.length||a.updateAttachments?.length||a.deleteAttachments?.length?{edits:a,results:await n.applyEdits(a,o)}:{edits:a,results:{addFeatureResults:[],updateFeatureResults:[],deleteFeatureResults:[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}}}async function E(t,n,r){let i=l(t),a=n&&(n.addFeatures||n.updateFeatures||n.deleteFeatures),o=n&&(n.addAttachments||n.updateAttachments||n.deleteAttachments),s=t.infoFor3D!=null;if(L(n,i,r,!!a,!!o,`${t.type}-layer`),!i.data.isVersioned&&r?.gdbVersion)throw new e(`${t.type}-layer:invalid-parameter`,`'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isVersioned'`);if(!i.editing.supportsRollbackOnFailure&&r?.rollbackOnFailureEnabled)throw new e(`${t.type}-layer:invalid-parameter`,`This layer does not support 'rollbackOnFailureEnabled' parameter. See: 'capabilities.editing.supportsRollbackOnFailure'`);let c={...r};if(c.rollbackOnFailureEnabled!=null||i.editing.supportsRollbackOnFailure||(c.rollbackOnFailureEnabled=!0),c.rollbackOnFailureEnabled||c.returnServiceEditsOption!==`original-and-current-features`||(!1===c.rollbackOnFailureEnabled&&h.getLogger(`esri.layers.graphics.editingSupport`).warn(`${t.type}-layer:invalid-parameter`,`'original-and-current-features' is valid for 'returnServiceEditsOption' only when 'rollBackOnFailure' is true, but 'rollBackOnFailure' was set to false. 'rollBackOnFailure' has been overwritten and set to true.`),c.rollbackOnFailureEnabled=!0),!i.editing.supportsReturnServiceEditsInSourceSpatialReference&&c.returnServiceEditsInSourceSR)throw new e(`${t.type}-layer:invalid-parameter`,`This layer does not support 'returnServiceEditsInSourceSR' parameter. See: 'capabilities.editing.supportsReturnServiceEditsInSourceSpatialReference'`);if(c.returnServiceEditsInSourceSR&&c.returnServiceEditsOption!==`original-and-current-features`)throw new e(`${t.type}-layer:invalid-parameter`,`'returnServiceEditsInSourceSR' is valid only when 'returnServiceEditsOption' is set to 'original-and-current-features'`);let u=I(n,i,`${t.type}-layer`),d=r?.globalIdUsed||s,f=t.fields.filter(e=>e.type===`big-integer`||e.type===`oid`&&(e.length||0)>=8);if(d){let{globalIdField:n}=t;if(n==null)throw new e(`${t.type}-layer:invalid-parameter`,`Layer does not specify a global id field.`);u.addFeatures.forEach(e=>N(e,n))}return u.addFeatures.forEach(e=>k(e,t,d,f)),u.updateFeatures.forEach(e=>j(e,t,d,f)),u.deleteFeatures.forEach(e=>A(e,t,d,f)),u.addAttachments.forEach(e=>M(e,t)),u.updateAttachments.forEach(e=>M(e,t)),s&&await z(u,t),{edits:await P(u),options:c}}function D(t,r,i,a){if(i){if(`attributes`in t&&!t.attributes[r.globalIdField])throw new e(`${r.type}-layer:invalid-parameter`,`Feature should have '${r.globalIdField}' when 'globalIdUsed' is true`);if(!(`attributes`in t)&&!t.globalId)throw new e(`${r.type}-layer:invalid-parameter`,"`'globalId' of the feature should be passed when 'globalIdUsed' is true")}if(a.length&&`attributes`in t)for(let i of a){let a=t.attributes[i.name];if(a!==void 0&&!n(i,a))throw new e(`${r.type}-layer:invalid-parameter`,`Big-integer field '${i.name}' of the feature must be less than ${2**53-1}`,{feature:t})}if(`geometry`in t&&t.geometry!=null){if(t.geometry.hasZ&&!1===r.capabilities?.data.supportsZ)throw new e(`${r.type}-layer:z-unsupported`,`Layer does not support z values while feature has z values.`);if(t.geometry.hasM&&!1===r.capabilities?.data.supportsM)throw new e(`${r.type}-layer:m-unsupported`,`Layer does not support m values while feature has m values.`)}}function O(t,n){if(`geometry`in t&&t.geometry?.type===`mesh`&&n.infoFor3D!=null&&n.spatialReference!=null){let{geometry:r}=t,{spatialReference:i,vertexSpace:a}=r,o=n.spatialReference,s=a.type===`local`,l=p(o),u=c(o,i),d=u||m(o)&&(m(i)||v(i));if(!(s&&l&&d||!s&&!l&&u))throw new e(`${n.type}-layer:mesh-unsupported`,`Uploading a mesh with a ${a.type} vertex space and a spatial reference wkid:${i.wkid} to a layer with a spatial reference wkid:${o.wkid} is not supported.`)}}function k(e,t,n,r){D(e,t,n,r),O(e,t)}function A(e,t,n,r){D(e,t,n,r)}function j(t,n,r,i){D(t,n,r,i),O(t,n);let a=l(n);if(`geometry`in t&&t.geometry!=null&&!a?.editing.supportsGeometryUpdate)throw new e(`${n.type}-layer:unsupported-operation`,`Layer does not support geometry updates.`)}function M(t,n){let{feature:r,attachment:a}=t;if(!r||`attributes`in r&&!r.attributes[n.globalIdField])throw new e(`${n.type}-layer:invalid-parameter`,`Attachment should have reference to a feature with 'globalId'`);if(!(`attributes`in r)&&!r.globalId)throw new e(`${n.type}-layer:invalid-parameter`,`Attachment should have reference to 'globalId' of the parent feature`);if(!a.globalId)throw new e(`${n.type}-layer:invalid-parameter`,`Attachment should have 'globalId'`);if(!a.data&&!a.uploadId)throw new e(`${n.type}-layer:invalid-parameter`,`Attachment should have 'data' or 'uploadId'`);if(!(a.data instanceof File&&a.data.name)&&!a.name)throw new e(`${n.type}-layer:invalid-parameter`,`'name' is required when attachment is specified as Base64 encoded string using 'data'`);if(!n.capabilities?.editing.supportsUploadWithItemId&&a.uploadId)throw new e(`${n.type}-layer:invalid-parameter`,`This layer does not support 'uploadId' parameter. See: 'capabilities.editing.supportsUploadWithItemId'`);if(typeof a.data==`string`){let t=i(a.data);if(t&&!t.isBase64)throw new e(`${n.type}-layer:invalid-parameter`,`Attachment 'data' should be a Blob, File or Base64 encoded string`)}}function N(e,t){let{attributes:n}=e;n[t]??(n[t]=d())}async function P(e){let t=e.addFeatures??[],n=e.updateFeatures??[],r=t.concat(n).map(e=>e.geometry),i=await u(r),a=t.length,o=n.length;return i.slice(0,a).forEach((e,n)=>t[n].geometry=e),i.slice(a,a+o).forEach((e,t)=>n[t].geometry=e),e}function F(e){return{addFeatures:Array.from(e?.addFeatures??[]),updateFeatures:Array.from(e?.updateFeatures??[]),deleteFeatures:e&&f.isCollection(e.deleteFeatures)?e.deleteFeatures.toArray():e.deleteFeatures||[],addAttachments:e.addAttachments||[],updateAttachments:e.updateAttachments||[],deleteAttachments:e.deleteAttachments||[]}}function I(t,n,r){let i=F(t);if(i.addFeatures?.length&&!n.operations.supportsAdd)throw new e(`${r}:unsupported-operation`,`Layer does not support adding features.`);if(i.updateFeatures?.length&&!n.operations.supportsUpdate)throw new e(`${r}:unsupported-operation`,`Layer does not support updating features.`);if(i.deleteFeatures?.length&&!n.operations.supportsDelete)throw new e(`${r}:unsupported-operation`,`Layer does not support deleting features.`);return i.addFeatures=i.addFeatures.map(R),i.updateFeatures=i.updateFeatures.map(R),i.addAssetFeatures=[],i}function L(t,n,r,i,a,o){if(!(t&&(i||a)||r?.usingTelecomOperations))throw new e(`${o}:missing-parameters`,`'addFeatures', 'updateFeatures', 'deleteFeatures', 'addAttachments', 'updateAttachments' or 'deleteAttachments' parameter is required`);if(!n.editing.supportsGlobalId&&r?.globalIdUsed&&!r.usingFeatureServiceEndpoint)throw new e(`${o}:invalid-parameter`,`This layer does not support 'globalIdUsed' parameter. See: 'capabilities.editing.supportsGlobalId'`);if(!n.editing.supportsGlobalId&&a)throw new e(`${o}:invalid-parameter`,`'addAttachments', 'updateAttachments' and 'deleteAttachments' are applicable only if the layer supports global ids. See: 'capabilities.editing.supportsGlobalId'`);if(!r?.globalIdUsed&&a)throw new e(`${o}:invalid-parameter`,`When 'addAttachments', 'updateAttachments' or 'deleteAttachments' is specified, globalIdUsed should be set to true`)}function R(e){let t=new _;return e.attributes||={},t.geometry=e.geometry,t.attributes=e.attributes,t}async function z(t,n){let{infoFor3D:r}=n;if(r==null)return;if(!o(r))throw new e(`${n.type}-layer:binary-gltf-asset-not-supported`,`3DObjectFeatureLayer requires binary glTF (.glb) support for updating mesh geometry.`);t.addAssetFeatures??=[];let{addAssetFeatures:i}=t;for(let e of t.addFeatures??[])B(e)&&i.push(e);for(let e of t.updateFeatures??[])B(e)&&i.push(e)}function B(e){return e?.geometry?.type===`mesh`}function V(t,n,r,i){if(!y(n))throw new e(`${t.type}-layer:no-editing-support`,`Layer source does not support applyEdits capability`,{layer:t});if(!n.uploadAssets)throw new e(`${t.type}-layer:no-asset-upload-support`,`Layer source does not support uploadAssets capability`,{layer:t});return n.uploadAssets(r,i)}export{b as a,R as c,S as d,F as i,L as l,x as n,I as o,P as r,C as s,w as t,V as u};