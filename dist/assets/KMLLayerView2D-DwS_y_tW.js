import{CC as e,DT as t,Fg as n,GC as r,Ka as i,OT as a,RS as o,_d as s,ax as c,cC as l,fT as u,gD as d,gs as f,hu as p,iv as m,ks as h,nv as g,px as _,rC as v,vT as y,vs as b,wg as x,wx as S}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./OptimizedFeatureSet-CTIqq8fn.js";import"./featureConversionUtils-_DSSMFQ2.js";import"./streamLayerUtils-82UmlW-3.js";import"./QueueProcessor-BtMHt_WC.js";import"./SimpleGeometryCursor-5wFw2ZZo.js";import"./earcut-BF1-mB58.js";import"./projectionZScaling-DAQiVc32.js";import{r as C}from"./projectOperator-CfopyaTY.js";import"./glsl-CQsgM67j.js";import"./layerViewUtils-RSw-QNoB.js";import"./colorUtils-DJOs5VE1.js";import{n as w,p as T,u as E}from"./rasterProjectionHelper-w_U-UD-j.js";import{a as D,i as O,r as k}from"./kmlUtils-HLddgLix.js";import"./timeSupport-DTr00ezP.js";import"./queryUtils-DcyDFw5_.js";import"./quantizationUtils-CGy9nkLl.js";import"./normalizeUtilsSync-3fP05dGa.js";import"./GeometryUtils-Dmca5Xm4.js";import"./VertexAttributeLocations-CfzeuYMz.js";import"./VertexElementDescriptor-ju-1bdWe.js";import"./labelPoint-vGsL2GFc.js";import"./callExpressionWithCursor-BmfrFX6I.js";import"./FeatureMetadata-i54qdN5K.js";import"./CIMSymbolHelper-l5sn5wJj.js";import"./rasterizingUtils-CKtfcOpu.js";import"./Rect-BhUrWpQm.js";import"./BoundingBox-CLkiiRfJ.js";import"./BidiEngine-BrFXRv7y.js";import"./callExpressionWithFeature-D55aOczd.js";import"./OverrideHelper-BhCM0ayL.js";import"./FeatureCommandQueue-CjFmAvd1.js";import"./config-BSvujflG.js";import"./dehydratedFeatureComparison-Uk3aLNrk.js";import"./WGLContainer-D_aBMsnu.js";import"./utils-DS5dbHj4.js";import"./ProgramTemplate-BXau1qoF.js";import"./VertexArrayObject-DEfjd5y-.js";import"./BufferObject-q8zuTMny.js";import"./VertexBuffer-xVpphTb4.js";import"./vec3f32-B2H3-fiA.js";import"./Container-BuEih3Ua.js";import"./GraphShaderModule-D5RCsL2_.js";import{t as A}from"./FramebufferObject-BhBPSr-C.js";import"./ShaderBuilder-D3cV1oap.js";import"./bitmapUtils-SuGDUZFe.js";import{n as j,r as M,t as N}from"./Bitmap-CiNUpq9T.js";import{t as P}from"./BitmapContainer-ChYmxUus.js";import{t as F}from"./LayerView2D-BsKgTWnO.js";import{t as I}from"./LayerView-2jeNRFkG.js";import"./UpdateTracking2D-BiwypiBP.js";import"./TechniqueInstance-B37K-FPt.js";import"./TileContainer-B6yQthEI.js";import"./constants-BuH6TGxi.js";import"./utils-Czjlo_U1.js";import"./AGraphicContainer-BjvRrdle.js";import{t as L}from"./GraphicContainer-Dcpg9zYN.js";import"./ComputedAttributeStorage-B3XSA2BQ.js";import{t as R}from"./GraphicsView2D-CPqKya-9.js";import"./dehydratedFeatures-8DNmK2px.js";import{t as z}from"./rasterUtils-CXmXN_V9.js";import{n as B,r as V,t as H}from"./RenderingContext-CUvHo4ju.js";import"./ProgramCache-BCiAPfoP.js";import"./renderState-Be6uDhGv.js";import"./DisjointTimerQuery-mSqh8LCt.js";var U=class extends r{constructor(){super(...arguments),this.id=0,this.rotation=0,this.href=``,this.extent=new c}};d([t({nonNullable:!0,json:{write:!0}})],U.prototype,`id`,void 0),d([t({nonNullable:!0,json:{write:!0}})],U.prototype,`rotation`,void 0),d([t({nonNullable:!0,json:{write:!0}})],U.prototype,`href`,void 0),d([t({type:c,nonNullable:!0,json:{write:!0}})],U.prototype,`extent`,void 0),U=d([a(`esri.layers.support.KMLMapImage`)],U);var W=class e{static{this._instanceRefCount=0}constructor(t){if(this._ownsRctx=!1,t)this._ownsRctx=!1,this._rctx=t;else{if(e._instance)return e._instanceRefCount++,e._instance;e._instanceRefCount=1,e._instance=this,this._ownsRctx=!0;let t=document.createElement(`canvas`).getContext(`webgl2`);t.getExtension(`OES_texture_float`),this._rctx=new H(t,new i)}this._quad=new V(this._rctx,[0,0,1,0,0,1,1,1]);let n=B(`raster/reproject`,`raster/reproject`,{applyProjection:!0,bilinear:!1,bicubic:!1});this._program=this._rctx.programCache.acquire(n.vertexShader,n.fragmentShader,this._quad.locations),this._rctx.useProgram(this._program),this._program.setUniform1f(`u_opacity`,1),this._program.setUniform1i(`u_image`,0),this._program.setUniform1i(`u_flipY`,0),this._program.setUniform1i(`u_transformGrid`,1)}reprojectTexture(e,t,n=!1){let r=C(e.extent,t),i=new _({x:(e.extent.xmax-e.extent.xmin)/e.texture.descriptor.width,y:(e.extent.ymax-e.extent.ymin)/e.texture.descriptor.height,spatialReference:e.extent.spatialReference}),{x:a,y:o}=w(i,t,e.extent),s=(a+o)/2,c=Math.round((r.xmax-r.xmin)/s),l=Math.round((r.ymax-r.ymin)/s);s=(r.width/c+r.height/l)/2;let u=new _({x:s,y:s,spatialReference:r.spatialReference}),d=T({projectedExtent:r,srcBufferExtent:e.extent,pixelSize:u,hasWrapAround:!0,spacing:[16,16]}),f=z(this._rctx,d),p=new b(c,l);p.wrapMode=33071;let m=new A(this._rctx,p);this._rctx.bindFramebuffer(m),this._rctx.setViewport(0,0,c,l),this._rctx.useProgram(this._program),this._rctx.bindTexture(e.texture,0),this._rctx.bindTexture(f,1),this._quad.bind();let{width:g=0,height:v=0}=e.texture.descriptor;if(this._program.setUniform2f(`u_srcImageSize`,g,v),this._program.setUniform2fv(`u_transformSpacing`,d.spacing),this._program.setUniform2fv(`u_transformGridSize`,d.size),this._program.setUniform2f(`u_targetImageSize`,c,l),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),f.dispose(),n){let{width:e,height:t}=m,n=new ImageData(e??0,t??0);m.readPixels(0,0,e??0,t??0,6408,h.UNSIGNED_BYTE,n.data);let i=m.detachColorTexture();return m.dispose(),{texture:i,extent:r,imageData:n}}let y=m.detachColorTexture();return m.dispose(),{texture:y,extent:r}}reprojectBitmapData(e,t){let n=M(e.bitmapData)?N(e.bitmapData):e.bitmapData,r=new b(e.bitmapData.width,e.bitmapData.height);r.wrapMode=33071;let i=new f(this._rctx,r,n),a=this.reprojectTexture({texture:i,extent:e.extent},t,!0);a.texture.dispose();let o=document.createElement(`canvas`),s=a.imageData;return o.width=s.width,o.height=s.height,o.getContext(`2d`).putImageData(s,0,0),{bitmapData:o,extent:a.extent}}async loadAndReprojectBitmapData(e,t,n){let[r]=await Promise.all([o(e,{responseType:`image`}).then(e=>e.data),E()]),i=document.createElement(`canvas`);i.width=r.width,i.height=r.height;let a=i.getContext(`2d`);a.drawImage(r,0,0);let s=a.getImageData(0,0,i.width,i.height);if(t.spatialReference.equals(n))return{bitmapData:s,extent:t};let c=this.reprojectBitmapData({bitmapData:s,extent:t},n);return{bitmapData:c.bitmapData,extent:c.extent}}destroy(){this._ownsRctx?(e._instanceRefCount--,e._instanceRefCount===0&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),e._instance=null)):(this._quad.dispose(),this._program.dispose())}},G=class{constructor(){this.allSublayers=new Map,this.allPoints=[],this.allPolylines=[],this.allPolygons=[],this.allMapImages=[]}},K=class extends F(I){constructor(){super(...arguments),this._bitmapIndex=new Map,this._mapImageContainer=new P,this._kmlVisualData=new G,this._fetchController=null,this.allVisiblePoints=new s,this.allVisiblePolylines=new s,this.allVisiblePolygons=new s,this.allVisibleMapImages=new m}async hitTest(e,t){let n=this.layer;return[this._pointsView?.hitTest(e),this._polylinesView?.hitTest(e),this._polygonsView?.hitTest(e)].flat().filter(Boolean).map(t=>(t.layer=n,t.sourceLayer=n,{type:`graphic`,graphic:t,layer:n,mapPoint:e}))}update(e){this._polygonsView&&this._polygonsView.processUpdate(e),this._polylinesView&&this._polylinesView.processUpdate(e),this._pointsView&&this._pointsView.processUpdate(e)}attach(){this._fetchController=new AbortController,this.container.addChild(this._mapImageContainer),this._polygonsView=new R({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new L(this.view.featuresTilingScheme)}),this.container.addChild(this._polygonsView.container),this._polylinesView=new R({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new L(this.view.featuresTilingScheme)}),this.container.addChild(this._polylinesView.container),this._pointsView=new R({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new L(this.view.featuresTilingScheme)}),this.container.addChild(this._pointsView.container),this.addAttachHandles([this.allVisibleMapImages.on(`change`,e=>{e.added.forEach(e=>this._addMapImage(e)),e.removed.forEach(e=>this._removeMapImage(e))}),g(()=>this.layer.visibleSublayers,e=>{for(let e of this._kmlVisualData.allSublayers.values())e.visibility=0;for(let t of e){let e=this._kmlVisualData.allSublayers.get(t.id);e&&(e.visibility=1)}this._refreshCollections()})]),this._updatingHandles.addPromise(this._fetchService(this._fetchController.signal)),this._imageReprojector=new W}detach(){this._fetchController=u(this._fetchController),this._mapImageContainer.removeAllChildren(),this.container.removeAllChildren(),this._bitmapIndex.clear(),this._polygonsView=y(this._polygonsView),this._polylinesView=y(this._polylinesView),this._pointsView=y(this._pointsView),this._imageReprojector=y(this._imageReprojector)}viewChange(){this._polygonsView.viewChange(),this._polylinesView.viewChange(),this._pointsView.viewChange()}moveEnd(){}isUpdating(){return this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating}_addMapImage(e){(this.view.spatialReference?.isWGS84||this.view.spatialReference?.isWebMercator)&&this._imageReprojector.loadAndReprojectBitmapData(e.href,e.extent,this.view.spatialReference).then(t=>{let n=new j(t.bitmapData);n.x=t.extent.xmin,n.y=t.extent.ymax,n.resolution=t.extent.width/t.bitmapData.width,n.rotation=e.rotation,this._mapImageContainer.addChild(n),this._bitmapIndex.set(e,n)})}async _getViewDependentUrl(t,r){let{viewFormat:i,viewBoundScale:a,httpQuery:o}=t;if(i!=null){if(r==null)throw Error(`Loading this network link requires a view state.`);let s;if(await x(),a!=null&&a!==1){let e=new c(r.extent);e.expand(a),s=e}else s=r.extent;s=n(s,S.WGS84);let u=n(s,S.WebMercator),d=s.xmin,f=s.xmax,m=s.ymin,h=s.ymax,g=r.size[0]*r.pixelRatio,_=r.size[1]*r.pixelRatio,v=Math.max(u.width,u.height),y={"[bboxWest]":d.toString(),"[bboxEast]":f.toString(),"[bboxSouth]":m.toString(),"[bboxNorth]":h.toString(),"[lookatLon]":s.center.x.toString(),"[lookatLat]":s.center.y.toString(),"[lookatRange]":v.toString(),"[lookatTilt]":`0`,"[lookatHeading]":r.rotation.toString(),"[lookatTerrainLon]":s.center.x.toString(),"[lookatTerrainLat]":s.center.y.toString(),"[lookatTerrainAlt]":`0`,"[cameraLon]":s.center.x.toString(),"[cameraLat]":s.center.y.toString(),"[cameraAlt]":v.toString(),"[horizFov]":`60`,"[vertFov]":`60`,"[horizPixels]":g.toString(),"[vertPixels]":_.toString(),"[terrainEnabled]":`0`,"[clientVersion]":`5.0`,"[kmlVersion]":`2.2`,"[clientName]":`ArcGIS API for JavaScript`,"[language]":`en-US`},b=e=>{for(let t in e){let n;for(n in y)e[t]=e[t].replace(n,y[n])}},C=e(i);b(C);let w={};o!=null&&(w=e(o),b(w));let T=p(t.href);return T.query={...T.query,...C,...w},`${T.path}?${l(C)}`}return t.href}async _fetchService(e){let t=new G;await this._loadVisualData(this.layer.url,t,e),this._kmlVisualData=t,this._refreshCollections()}_refreshCollections(){this.allVisiblePoints.removeAll(),this.allVisiblePolylines.removeAll(),this.allVisiblePolygons.removeAll(),this.allVisibleMapImages.removeAll();let e=(e,t)=>{e.addMany(t.filter(e=>this._isSublayerVisible(e.sublayerId)).map(({item:e})=>e))};e(this.allVisiblePoints,this._kmlVisualData.allPoints),e(this.allVisiblePolylines,this._kmlVisualData.allPolylines),e(this.allVisiblePolygons,this._kmlVisualData.allPolygons),this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter(e=>this._isSublayerVisible(e.sublayerId)).map(({item:e})=>e))}_isSublayerVisible(e){let t=this._kmlVisualData.allSublayers.get(e);return!!t?.visibility&&(t.parentFolderId===-1||this._isSublayerVisible(t.parentFolderId))}_loadVisualData(e,t,n){return this._fetchParsedKML(e,n).then(async e=>{for(let r of e.sublayers){t.allSublayers.set(r.id,r);let e=await k(r,`points`,this.layer,r.id),i=await k(r,`polylines`,this.layer,r.id),a=await k(r,`polygons`,this.layer,r.id),o=r.mapImages?.map(e=>U.fromJSON(e))??[];if(t.allPoints.push(...e.map(e=>({item:e,sublayerId:r.id}))),t.allPolylines.push(...i.map(e=>({item:e,sublayerId:r.id}))),t.allPolygons.push(...a.map(e=>({item:e,sublayerId:r.id}))),t.allMapImages.push(...o.map(e=>({item:e,sublayerId:r.id}))),r.networkLink){let e=await this._getViewDependentUrl(r.networkLink,this.view.state);await this._loadVisualData(e,t,n)}}})}_fetchParsedKML(e,t){return D(e,this.layer.spatialReference,this.layer.refreshInterval,t).then(e=>O(e.data))}_removeMapImage(e){let t=this._bitmapIndex.get(e);t&&(this._mapImageContainer.removeChild(t),this._bitmapIndex.delete(e))}};d([t()],K.prototype,`_pointsView`,void 0),d([t()],K.prototype,`_polylinesView`,void 0),d([t()],K.prototype,`_polygonsView`,void 0),K=d([a(`esri.views.2d.layers.KMLLayerView2D`)],K);var q=K;export{q as default};