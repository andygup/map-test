import{DT as e,OT as t,WT as n,_d as r,gD as i,nv as a,qw as o,uE as s}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./OptimizedFeatureSet-CTIqq8fn.js";import"./featureConversionUtils-_DSSMFQ2.js";import"./streamLayerUtils-82UmlW-3.js";import"./QueueProcessor-BtMHt_WC.js";import"./earcut-BF1-mB58.js";import"./layerViewUtils-RSw-QNoB.js";import"./popupUtils-Bb88Y0DD.js";import"./tagSymbols-CazaFvX8.js";import"./colorUtils-DJOs5VE1.js";import"./timeSupport-DTr00ezP.js";import"./queryUtils-DcyDFw5_.js";import"./quantizationUtils-CGy9nkLl.js";import"./sublayerUtils-B_4dS-HF.js";import"./floorFilterUtils-TMZ7AjwL.js";import{t as c}from"./ExportImageParameters-CZohDpMb.js";import"./normalizeUtilsSync-3fP05dGa.js";import"./GeometryUtils-Dmca5Xm4.js";import"./VertexAttributeLocations-CfzeuYMz.js";import"./VertexElementDescriptor-ju-1bdWe.js";import"./labelPoint-vGsL2GFc.js";import"./callExpressionWithCursor-BmfrFX6I.js";import"./FeatureMetadata-i54qdN5K.js";import"./CIMSymbolHelper-l5sn5wJj.js";import"./rasterizingUtils-CKtfcOpu.js";import"./Rect-BhUrWpQm.js";import"./BoundingBox-CLkiiRfJ.js";import"./BidiEngine-BrFXRv7y.js";import"./callExpressionWithFeature-D55aOczd.js";import"./OverrideHelper-BhCM0ayL.js";import"./FeatureCommandQueue-CjFmAvd1.js";import"./config-BSvujflG.js";import"./dehydratedFeatureComparison-Uk3aLNrk.js";import{n as l}from"./drapedUtils-BIPbWxSw.js";import"./WGLContainer-D_aBMsnu.js";import"./utils-DS5dbHj4.js";import"./ProgramTemplate-BXau1qoF.js";import"./VertexArrayObject-DEfjd5y-.js";import"./BufferObject-q8zuTMny.js";import"./VertexBuffer-xVpphTb4.js";import"./vec3f32-B2H3-fiA.js";import"./Container-BuEih3Ua.js";import"./GraphShaderModule-D5RCsL2_.js";import"./FramebufferObject-BhBPSr-C.js";import"./ShaderBuilder-D3cV1oap.js";import"./bitmapUtils-SuGDUZFe.js";import"./Bitmap-CiNUpq9T.js";import{t as u}from"./BitmapContainer-ChYmxUus.js";import{t as d}from"./LayerView2D-BsKgTWnO.js";import{t as f}from"./ExportStrategy-BtFJEMJc.js";import{t as p}from"./LayerView-2jeNRFkG.js";import{t as m}from"./RefreshableLayerView-CXmtIjA5.js";import{t as h}from"./timeSupport-CpSaGF8C.js";import"./UpdateTracking2D-BiwypiBP.js";import"./TechniqueInstance-B37K-FPt.js";import"./TileContainer-B6yQthEI.js";import"./constants-BuH6TGxi.js";import"./utils-Czjlo_U1.js";import{t as g}from"./highlightOptionsUtils-C8mtOR7S.js";import"./AGraphicContainer-BjvRrdle.js";import"./ComputedAttributeStorage-B3XSA2BQ.js";import{t as _}from"./GraphicsView2D-CPqKya-9.js";import"./dehydratedFeatures-8DNmK2px.js";import{t as v}from"./HighlightGraphicContainer-Cgga58jR.js";import{r as y}from"./highlightUtils-Drb4dN_6.js";import{t as b}from"./MapServiceLayerViewHelper-Bl1IjP34.js";var x=n=>{let r=n,a=class extends r{initialize(){this.exportImageParameters=new c({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get floors(){return this.view?.floors??null}get exportImageVersion(){return this.exportImageParameters?.commitProperty(`version`),this.commitProperty(`timeExtent`),this.commitProperty(`floors`),(this._get(`exportImageVersion`)||0)+1}get timeExtent(){return h(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return i([e()],a.prototype,`exportImageParameters`,void 0),i([e({readOnly:!0})],a.prototype,`floors`,null),i([e({readOnly:!0})],a.prototype,`exportImageVersion`,null),i([e()],a.prototype,`layer`,void 0),i([e()],a.prototype,`suspended`,void 0),i([e({readOnly:!0})],a.prototype,`timeExtent`,null),a=i([t(`esri.views.layers.MapImageLayerView`)],a),a},S=class extends x(m(d(p))){constructor(){super(...arguments),this._highlightGraphics=new r,this._updateHash=``}fetchPopupFeaturesAtLocation(e,t){return this._popupHighlightHelper.fetchPopupFeaturesAtLocation(e,t)}update(e){let t=`${this.exportImageVersion}/${e.state.id}/${e.pixelRatio}/${e.stationary}`;this._updateHash!==t&&(this._updateHash=t,this.strategy.update(e).catch(e=>{o(e)||s.getLogger(this).error(e)}),e.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(e.state.resolution)),this._highlightView.processUpdate(e)}attach(){let{imageMaxWidth:e,imageMaxHeight:t,version:n}=this.layer,r=n>=10.3,i=n>=10;this._bitmapContainer=new u,this.container.addChild(this._bitmapContainer),this._highlightView=new _({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new v(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1}),this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new b({createFetchPopupFeaturesQueryGeometry:(e,t)=>l(e,t,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:({graphic:e,property:t})=>this._highlightView.graphicUpdateHandler({graphic:e,property:t}),layerView:this,updatingHandles:this._updatingHandles}),this.strategy=new f({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:t,imageRotationSupported:r,imageNormalizationSupported:i,hidpi:!0}),this.addAttachHandles(a(()=>this.exportImageVersion,()=>this.requestUpdate())),this.requestUpdate()}detach(){this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy(),this._popupHighlightHelper.destroy()}viewChange(){}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}async doRefresh(){this._updateHash=``,this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,t,n,r){return this.layer.fetchImage(e,t,n,{timeExtent:this.timeExtent,floors:this.floors,...r})}fetchImageBitmap(e,t,n,r){return this.layer.fetchImageBitmap(e,t,n,{timeExtent:this.timeExtent,floors:this.floors,...r})}highlight(e,t){let r=y(e);if(r.length===0)return n();let i=g(t);return this._addHighlightGraphics(r,i),n(()=>!this.destroyed&&this._removeHighlightGraphics(r,i))}_processHighlight(){let e=this._getHighlights();this._highlightView?.setHighlight(e)}_addHighlightGraphics(e,t){this._highlightGraphics.addMany(e),this._addHighlights(e.map(e=>e.uid),t)}_removeHighlightGraphics(e,t){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map(e=>e.uid),t)}};i([e()],S.prototype,`strategy`,void 0),S=i([t(`esri.views.2d.layers.MapImageLayerView2D`)],S);var C=S;export{C as default};