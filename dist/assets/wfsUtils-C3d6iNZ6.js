import{$T as e,AS as t,DS as n,EC as r,FT as i,GC as a,Gp as o,Kg as s,Lx as c,Ov as l,PT as u,Vg as d,ZS as f,bC as p,bd as m,rC as h,vx as g}from"./index-BN8X5Ryz.js";import{i as ee}from"./geojson-Dz-UDVkw.js";import{n as _,t as v}from"./xmlUtils-B_nEa0O-.js";var y=`xlink:href`,b=`2.0.0`,x=`__esri_wfs_id__`,S=`wfs-layer:getWFSLayerTypeInfo-error`,C=`wfs-layer:empty-service`,w=`wfs-layer:feature-type-not-found`,T=`wfs-layer:geojson-not-supported`,E=`wfs-layer:kvp-encoding-not-supported`,te=`wfs-layer:malformed-json`,D=`wfs-layer:unknown-geometry-type`,ne=`wfs-layer:unknown-field-type`,re=`wfs-layer:unsupported-spatial-reference`,O=`wfs-layer:unsupported-wfs-version`;async function k(e,t){let n=A((await f(e,{responseType:`text`,query:{SERVICE:`WFS`,REQUEST:`GetCapabilities`,VERSION:b,...t?.customParameters},signal:t?.signal})).data);return P(e,n),n}function A(e){let t=X(e);ae(t),Q(t);let n=t.firstElementChild,r=i(I(n));return{operations:N(n),get featureTypes(){return Array.from(r())},readFeatureTypes:r}}var j=[`json`,`application/json; subtype=geojson; charset=utf-8`,`application/json; subtype=geojson`,`application/json`,`geojson`,`application/geo+json`];function M(e){for(let t of j){let n=e.findIndex(e=>e.toLowerCase()===t);if(n>=0)return e[n]}return null}function N(t){let n=!0,r={GetCapabilities:{url:``},DescribeFeatureType:{url:``},GetFeature:{url:``,outputFormat:null,supportsPagination:!1}},i=[],a=[];if(_(t,{OperationsMetadata:{Parameter:e=>{if(e.getAttribute(`name`)?.toLowerCase()===`outputformat`)return{AllowedValues:{Value:({textContent:e})=>{e&&i.push(e)}}}},Operation:e=>{switch(e.getAttribute(`name`)){case`GetCapabilities`:return{DCP:{HTTP:{Get:e=>{r.GetCapabilities.url=e.getAttribute(y)}}}};case`DescribeFeatureType`:return{DCP:{HTTP:{Get:e=>{r.DescribeFeatureType.url=e.getAttribute(y)}}}};case`GetFeature`:return{DCP:{HTTP:{Get:e=>{r.GetFeature.url=e.getAttribute(y)}}},Parameter:e=>{if(e.getAttribute(`name`)?.toLowerCase()===`outputformat`)return{AllowedValues:{Value:({textContent:e})=>{e&&a.push(e)}}}}}}},Constraint:e=>{switch(e.getAttribute(`name`)){case`KVPEncoding`:return{DefaultValue:e=>{n=e.textContent.toLowerCase()===`true`}};case`ImplementsResultPaging`:return{DefaultValue:e=>{r.GetFeature.supportsPagination=e.textContent.toLowerCase()===`true`}}}}}}),r.GetFeature.outputFormat=M(a)??M(i),!n)throw new e(E,`WFS service doesn't support key/value pair (KVP) encoding`);if(r.GetFeature.outputFormat==null)throw new e(T,`WFS service doesn't support GeoJSON output format`);return r}function P(e,t){a(e)&&(r(e,t.operations.DescribeFeatureType.url,!0)&&(t.operations.DescribeFeatureType.url=p(t.operations.DescribeFeatureType.url)),r(e,t.operations.GetFeature.url,!0)&&(t.operations.GetFeature.url=p(t.operations.GetFeature.url)))}function F(e){let t=parseInt(e.textContent?.match(/(?<wkid>\d+$)/i)?.groups?.wkid??``,10);if(!Number.isNaN(t))return t}function I(e){return v(e,{FeatureTypeList:{FeatureType:e=>{let t={typeName:`undefined:undefined`,name:``,title:``,description:``,extent:null,namespacePrefix:``,namespaceUri:``,defaultSpatialReference:4326,supportedSpatialReferences:[]},n=new Set;return _(e,{Name:e=>{let{name:n,prefix:r}=Z(e.textContent);t.typeName=`${r}:${n}`,t.name=n,t.namespacePrefix=r,t.namespaceUri=e.lookupNamespaceURI(r)},Abstract:e=>{t.description=e.textContent},Title:e=>{t.title=e.textContent},WGS84BoundingBox:e=>{t.extent=g.fromJSON(L(e))},DefaultCRS:e=>{let r=F(e);r&&(t.defaultSpatialReference=r,n.add(r))},OtherCRS:e=>{let t=F(e);t&&n.add(t)}}),t.title||=t.name,n.add(4326),t.supportedSpatialReferences.push(...n),t}}})}function L(e){let t,r,i,a;for(let n of e.children)switch(n.localName){case`LowerCorner`:[t,r]=n.textContent.split(` `).map(e=>Number.parseFloat(e));break;case`UpperCorner`:[i,a]=n.textContent.split(` `).map(e=>Number.parseFloat(e))}return{xmin:t,ymin:r,xmax:i,ymax:a,spatialReference:n}}function R(e,t,n){return u(e,e=>n?e.name===t&&e.namespaceUri===n:e.typeName===t||e.name===t)}async function z(e,t,n,r={}){let{featureType:i,extent:a}=await B(e,t,n,r),{spatialReference:o}=$(e.operations.GetFeature.url,i,r.spatialReference),{fields:s,geometryType:l,swapXY:u,objectIdField:d,geometryField:f}=await V(e,i,o,r);return{url:e.operations.GetCapabilities.url,name:i.name,namespaceUri:i.namespaceUri,fields:s,geometryField:f,geometryType:l,objectIdField:d,spatialReference:r.spatialReference??new c({wkid:i.defaultSpatialReference}),extent:a,swapXY:u,wfsCapabilities:e,customParameters:r.customParameters}}async function B(n,r,i,a={}){let o=n.readFeatureTypes(),l=r?R(o,r,i):o.next().value,{spatialReference:u=new c({wkid:l?.defaultSpatialReference})}=a;if(l==null)throw r?new e(w,`The type '${r}' could not be found in the service`):new e(C,`The service is empty`);let f=l.extent;if(f&&!t(f.spatialReference,u))try{await d(f.spatialReference,u,void 0,a),f=s(f,u)}catch{throw new e(re,`Projection not supported`)}return{extent:f,spatialReference:u,featureType:l}}async function V(t,n,r,i={}){let{typeName:a}=n,[o,s]=await Promise.allSettled([W(t.operations.DescribeFeatureType.url,a,i),U(t,a,r,i)]),c=t=>new e(S,`An error occurred while getting info about the feature type '${a}'`,{error:t});if(o.status===`rejected`)throw c(o.reason);if(s.status===`rejected`)throw c(s.reason);let{fields:l,errors:u}=o.value??{},d=o.value?.geometryType||s.value?.geometryType,f=s.value?.swapXY??!1;if(d==null)throw new e(D,`The geometry type could not be determined for type '${a}`,{typeName:a,geometryType:d,fields:l,errors:u});return{...H(l??[]),geometryType:d,swapXY:f}}function H(e){let t=e.find(e=>e.type===`geometry`),n=e.find(e=>e.type===`oid`);return e=e.filter(e=>e.type!==`geometry`),n||(n=new m({name:`__esri_wfs_id__`,type:`oid`,alias:`__esri_wfs_id__`}),e.unshift(n)),{geometryField:t?.name??null,objectIdField:n.name,fields:e}}async function U(e,t,n,r={}){let i,a=!1,[o,s]=await Promise.all([J(e.operations.GetFeature.url,t,n,e.operations.GetFeature.outputFormat,{...r,count:1}),f(e.operations.GetFeature.url,{responseType:`text`,query:Y(t,n,void 0,{...r,count:1}),signal:r?.signal})]),c=o.type===`FeatureCollection`&&o.features[0]?.geometry;if(c){let e;switch(i=l.fromJSON(ee(c.type)),c.type){case`Point`:e=c.coordinates;break;case`LineString`:case`MultiPoint`:e=c.coordinates[0];break;case`MultiLineString`:case`Polygon`:e=c.coordinates[0][0];break;case`MultiPolygon`:e=c.coordinates[0][0][0]}let t=/<[^>]*pos[^>]*> *(-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?)/.exec(s.data);if(t){let n=e[0].toFixed(3),r=e[1].toFixed(3),i=parseFloat(t[1]).toFixed(3);n===parseFloat(t[2]).toFixed(3)&&r===i&&(a=!0)}}return{geometryType:i,swapXY:a}}async function W(e,t,n){return G(t,(await f(e,{responseType:`text`,query:{SERVICE:`WFS`,REQUEST:`DescribeFeatureType`,VERSION:b,TYPENAME:t,TYPENAMES:t,...n?.customParameters},signal:n?.signal})).data)}function G(t,n){let{name:r}=Z(t),i=X(n);Q(i);let a=u(v(i.firstElementChild,{element:e=>e}),e=>e.getAttribute(`name`)===r);if(a!=null){let e=a.getAttribute(`type`),t=e?u(v(i.firstElementChild,{complexType:e=>e}),t=>t.getAttribute(`name`)===Z(e).name):u(v(a,{complexType:e=>e}),()=>!0);if(t)return q(t)}throw new e(w,`Type '${t}' not found in document`,{document:new XMLSerializer().serializeToString(i)})}var K=new Set([`objectid`,`fid`]);function q(t){let n=[],r=[],i,a=v(t,{complexContent:{extension:{sequence:{element:e=>e}}}});for(let s of a){let a=s.getAttribute(`name`);if(!a)continue;let c,l;if(s.hasAttribute(`type`)?c=Z(s.getAttribute(`type`)).name:_(s,{simpleType:{restriction:e=>(c=Z(e.getAttribute(`base`)).name,{maxLength:e=>{l=+e.getAttribute(`value`)}})}}),!c)continue;let u=s.getAttribute(`nillable`)===`true`,d=!1;switch(c.toLowerCase()){case`integer`:case`nonpositiveinteger`:case`negativeinteger`:case`long`:case`int`:case`short`:case`byte`:case`nonnegativeinteger`:case`unsignedlong`:case`unsignedint`:case`unsignedshort`:case`unsignedbyte`:case`positiveinteger`:r.push(new m({name:a,alias:a,type:`integer`,nullable:u,length:o(`integer`)}));break;case`float`:case`double`:case`decimal`:r.push(new m({name:a,alias:a,type:`double`,nullable:u,length:o(`double`)}));break;case`boolean`:case`string`:case`gyearmonth`:case`gyear`:case`gmonthday`:case`gday`:case`gmonth`:case`anyuri`:case`qname`:case`notation`:case`normalizedstring`:case`token`:case`language`:case`idrefs`:case`entities`:case`nmtoken`:case`nmtokens`:case`name`:case`ncname`:case`id`:case`idref`:case`entity`:case`duration`:case`time`:r.push(new m({name:a,alias:a,type:`string`,nullable:u,length:l??o(`string`)}));break;case`datetime`:case`date`:r.push(new m({name:a,alias:a,type:`date`,nullable:u,length:l??o(`date`)}));break;case`pointpropertytype`:i=`point`,d=!0;break;case`multipointpropertytype`:i=`multipoint`,d=!0;break;case`curvepropertytype`:case`multicurvepropertytype`:case`multilinestringpropertytype`:i=`polyline`,d=!0;break;case`surfacepropertytype`:case`multisurfacepropertytype`:case`multipolygonpropertytype`:i=`polygon`,d=!0;break;case`geometrypropertytype`:case`multigeometrypropertytype`:d=!0,n.push(new e(D,`geometry type '${c}' is not supported`,{type:new XMLSerializer().serializeToString(t)}));break;default:n.push(new e(ne,`Unknown field type '${c}'`,{type:new XMLSerializer().serializeToString(t)}))}d&&r.push(new m({name:a,alias:a,type:`geometry`,nullable:u}))}for(let e of r)if(e.type===`integer`&&!e.nullable&&K.has(e.name.toLowerCase())){e.type=`oid`;break}return{geometryType:i,fields:r,errors:n}}async function J(t,n,r,i,a){let{data:o}=await f(t,{responseType:`text`,query:Y(n,r,i,a),signal:a?.signal});o=o.replaceAll(/": +(-?\d+),(\d+)(,)?/g,`": $1.$2$3`);try{return JSON.parse(o)}catch(t){throw new e(te,`Error while parsing the\xA0response`,{response:o,error:t})}}function Y(e,t,n,r){let i=typeof t==`number`?t:t.wkid;return{SERVICE:`WFS`,REQUEST:`GetFeature`,VERSION:b,TYPENAMES:e,OUTPUTFORMAT:n,SRSNAME:`EPSG:`+i,STARTINDEX:r?.startIndex,COUNT:r?.count,...r?.customParameters}}async function ie(e,t,n){let r=await f(e,{responseType:`text`,query:{SERVICE:`WFS`,REQUEST:`GetFeature`,VERSION:b,TYPENAMES:t,RESULTTYPE:`hits`,...n?.customParameters},signal:n?.signal}),i=/numberMatched=["'](?<numberMatched>\d+)["']/gi.exec(r.data);if(i?.groups)return+i.groups.numberMatched}function X(e){return new DOMParser().parseFromString(e.trim(),`text/xml`)}function Z(e){let[t,n]=e.split(`:`);return{prefix:n?t:``,name:n??t}}function ae(t){let n=t.firstElementChild?.getAttribute(`version`);if(n&&n!==b)throw new e(O,`Unsupported WFS version ${n}. Supported version: ${b}`)}function Q(t){let n=``,r=``;if(_(t.firstElementChild,{Exception:e=>(n=e.getAttribute(`exceptionCode`),{ExceptionText:e=>{r=e.textContent}})}),n)throw new e(`wfs-layer:${n}`,r)}function $(e,t,n){let r={wkid:t.defaultSpatialReference},i=n?.wkid==null?r:{wkid:n.wkid};return{spatialReference:i,getFeatureSpatialReference:h(e)||i.wkid&&t.supportedSpatialReferences.includes(i.wkid)?{wkid:i.wkid}:{wkid:t.defaultSpatialReference}}}export{ie as a,H as c,R as i,J as n,$ as o,z as r,k as s,x as t};