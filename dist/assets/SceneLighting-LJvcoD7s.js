import{$T as e,$m as t,Aw as n,BT as r,Bl as i,Bv as a,CE as o,C_ as s,Cl as c,Cs as l,Dl as u,Em as d,Fm as f,Gb as p,Gu as m,Hl as h,JT as g,Jf as _,Jm as v,Kl as y,Km as b,Lm as ee,Ls as x,Lx as S,Nl as C,Ns as w,Nx as te,Ol as T,Pm as ne,Q as E,QT as D,Qv as O,Rb as re,Rl as k,Rm as ie,Ry as ae,Sw as A,Tb as oe,Tl as se,Tw as j,Ul as ce,Um as le,Uu as ue,VT as de,Vl as M,Vs as fe,Xm as pe,Z as me,_g as he,_l as ge,_t as _e,b_ as ve,cw as ye,dv as be,ft as xe,gS as Se,gl as N,h_ as Ce,hl as P,ht as we,hw as Te,kD as F,kT as Ee,kl as De,lg as Oe,mt as ke,nt as Ae,ot as je,p_ as Me,pl as I,pv as Ne,qu as Pe,rb as Fe,rt as Ie,ut as Le,uw as L,vb as Re,vx as ze,wm as Be,ww as Ve,x_ as R,xl as z,y_ as B,yl as He,yu as Ue,yw as We,zl as Ge}from"./index-BN8X5Ryz.js";import{O as Ke,_ as qe,b as Je,c as Ye,j as Xe,m as Ze,o as Qe,y as $e}from"./plane-Da5EsY0J.js";import{n as et}from"./projectPointToVector-BkRdoTqD.js";import{t as tt}from"./projectVectorToVector-DGzn2p7I.js";import{n as nt,t as rt}from"./orientedBoundingBox-Bd4igSGQ.js";import{c as it}from"./Emissions.glsl-C_Yvv-sZ.js";import{a as at,n as V,r as ot,t as st}from"./ray-LkJ58wpZ.js";import{n as ct,r as lt,t as ut}from"./HUDIntersectorResult-C5AENPbM.js";import{n as dt}from"./VertexAttributeLocations-BScEla0R.js";import{t as H}from"./VertexElementDescriptor-Cl_nC_ty.js";import{r as ft}from"./sphere-d9-4vNcj.js";import{d as pt,l as mt,o as ht}from"./lineSegment-BudcKS0C.js";import{a as gt,c as _t,n as vt}from"./renderState-BaFdYDAL.js";import{a as yt,c as bt,d as xt,i as St,l as Ct,o as wt,r as Tt,s as Et,t as Dt,u as Ot}from"./frustum-LgSQ4wIS.js";function kt(e,t,n){e.worldUpAtPosition(t,At),De(jt,n,t);let r=M(jt);return r===0?0:Te(z(jt,At)/r)}var At=B(),jt=B();function Mt(e,t,n){return 2*Math.atan(Math.sqrt(t*t+n*n)*Math.tan(.5*e)/t)}function Nt(e,t,n){return 2*Math.atan(Math.sqrt(t*t+n*n)*Math.tan(.5*e)/n)}function Pt(e,t,n){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+n*n))}function Ft(e,t,n){return 2*Math.atan(n*Math.tan(.5*e)/Math.sqrt(t*t+n*n))}var It,U=It=class extends n{constructor(e){super(e),this._ray=V(),this._viewport=E(0,0,1,1),this._padding=E(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=m(1,1e3),this._viewDirty=!0,this._viewMatrix=_(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=_(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=_(),this._frustumDirty=!0,this._frustum=bt(),this._fullViewport=me(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=B(),this._up=B(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,`_center`)}get ray(){return De(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,`_up`)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){v(this._viewMatrix,e),this.notifyChange(`_viewMatrix`),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),k(B(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),k(B(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),k(B(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_nearFar`))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_nearFar`))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;let e=Le(me(),this._viewport,1/this.pixelRatio),t=this._get(`screenViewport`);return t&&Ie(e,t)?t:e}get screenPadding(){if(this.pixelRatio===1)return this._padding;let e=Le(me(),this._padding,1/this.pixelRatio),t=this._get(`screenPadding`);return t&&Ie(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_viewport`))}get y(){return this._viewport[1]}set y(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_viewport`))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_viewport`))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_viewport`))}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(e){this.width=e-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(e){this.height=e-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){Ae(this._padding,e)||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),je(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_padding`),this.notifyChange(`_viewport`))}get viewProjectionMatrix(){return this._viewProjectionDirty&&=(ie(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return le(_(),this.projectionMatrix)||this._get(`inverseProjectionMatrix`)||_()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Pt(this._fov,this.width,this.height)}set fovX(e){this._fov=Mt(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Ft(this._fov,this.width,this.height)}set fovY(e){this._fov=Nt(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return Ge(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(le(this._viewInverseTransposeMatrix,this.viewMatrix),t(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){let{near:t,far:n}=this;return 2*t*n/(n+t-e*(n-t))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){let e=this.width,t=this.height,n=this.near*Math.tan(this.fovY/2)*2,r=n*this._aspect,i=n/this.rows,a=r/this.columns,o=-r/2+this.column*a,s=o+a,c=-n/2+this.row*i,l=c+i,u=Be(_(),o*(1+2*this._padding[3]/e),s*(1+2*this._padding[1]/e),c*(1+2*this._padding[2]/t),l*(1+2*this._padding[0]/t),this.near,this.far),f=this._get(`projectionMatrix`);return f&&d(f,u)?f:u}copyFrom(e){h(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,je(this._viewport,e.viewport),this.notifyChange(`_viewport`),je(this._padding,e.padding),this.notifyChange(`_padding`),re(this._nearFar,e.nearFar),this.notifyChange(`_nearFar`),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;let t=e;return this._viewDirty=t._viewDirty,this._viewDirty||(v(this._viewMatrix,e.viewMatrix),this.notifyChange(`_viewMatrix`)),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||=(Ot(this._frustum,e.frustum),!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(v(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),je(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up,this.fov=e.fov}clone(){return new It().copyFrom(this)}equals(e){return N(this.eye,e.eye)&&N(this.center,e.center)&&N(this.up,e.up)&&Ae(this._viewport,e.viewport)&&Ae(this._padding,e.padding)&&Re(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){let t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||we(e.screenPadding,this.screenPadding)>=t||we(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;c(G,e.eye,e.center),c(K,this.eye,this.center);let n=z(G,K),r=u(G),i=u(K),a=5e-4;return n*n>=.9999999999*r*i&&se(e.eye,this.eye)<Math.max(r,i)*a*a}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs(Xe(this.viewForward,De(G,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=Oe()){return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,n=.5){return e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*n,e[2]=.5,e}setGLViewport(e){let t=this.viewport,n=this.padding;e.setViewport(t[0]-n[3],t[1]-n[2],t[2]+n[1]+n[3],t[3]+n[0]+n[2])}applyProjection(e,t){e!==W&&h(W,e),W[3]=1,_e(W,W,this.projectionMatrix);let n=Math.abs(W[3]);C(W,W,1/n);let r=this.fullViewport;t[0]=A(0,r[0]+r[2],.5+.5*W[0]),t[1]=A(0,r[1]+r[3],.5+.5*W[1]),t[2]=.5*(W[2]+1),t[3]=n}unapplyProjection(e,t){let n=this.fullViewport;W[0]=(e[0]/(n[0]+n[2])*2-1)*e[3],W[1]=(e[1]/(n[1]+n[3])*2-1)*e[3],W[2]=(2*e[2]-1)*e[3],W[3]=e[3],this.inverseProjectionMatrix!=null&&(_e(W,W,this.inverseProjectionMatrix),t[0]=W[0],t[1]=W[1],t[2]=W[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,zt),this.renderToScreen(zt,t),t}projectToRenderScreen(e,t){if(W[0]=e[0],W[1]=e[1],W[2]=e[2],W[3]=1,_e(W,W,this.viewProjectionMatrix),W[3]===0)return null;let n=W;C(n,n,1/Math.abs(W[3]));let r=this.fullViewport,i=A(0,r[0]+r[2],.5+.5*n[0]),a=A(0,r[1]+r[3],.5+.5*n[1]);return`x`in t?(t.x=i,t.y=a):(t[0]=i,t[1]=a,t.length>2&&(t[2]=.5*(n[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,zt),t)}unprojectFromRenderScreen(e,t){if(ie(Rt,this.projectionMatrix,this.viewMatrix),!le(Rt,Rt))return null;let n=this.fullViewport;return W[0]=2*(e[0]-n[0])/n[2]-1,W[1]=2*(e[1]-n[1])/n[3]-1,W[2]=2*e[2]-1,W[3]=1,_e(W,W,Rt),W[3]===0?null:(t[0]=W[0]/W[3],t[1]=W[1]/W[3],t[2]=W[2]/W[3],t)}constrainWindowSize(e,t,n,r){let i=e*this.pixelRatio,a=t*this.pixelRatio,o=Math.max(i-n/2,0),s=Math.max(this.fullHeight-a-r/2,0),c=-Math.min(i-n/2,0),l=-Math.min(this.fullHeight-a-r/2,0),u=n-c- -Math.min(this.fullWidth-i-n/2,0),d=r-l- -Math.min(a-r/2,0);return[Math.round(o),Math.round(s),Math.round(u),Math.round(d)]}computeUp(e){e===1?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){let n=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=n,t[1]=r,t}renderToScreen(e,t){let n=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;t[0]=n,t[1]=r}sphereFrustumCoverage(e,t){let{center:n,eye:r,distance:i,fovY:a}=this,o=Math.abs(Math.PI/2-kt(t,n,r));return e.frustumCoverage(o,i,a)}_computeUpGlobal(){De(G,this.center,this.eye);let e=M(this.center);e<1?N(this._up,Me)&&(h(this._up,Me),this._markViewDirty(),this.notifyChange(`_up`)):Math.abs(z(G,this.center))>.9999*M(G)*e||(T(K,G,this.center),T(K,K,G),I(K,K),N(this._up,K)||(h(this._up,K),this.notifyChange(`_up`),this._markViewDirty()))}_computeUpLocal(){He(G,this.eye,this.center),Math.abs(G[2])<=.9999&&(C(G,G,G[2]),k(G,-G[0],-G[1],1-G[2]),I(G,G),N(this._up,G)||(h(this._up,G),this.notifyChange(`_up`),this._markViewDirty()))}_compareAndSetView(e,t,n=``){typeof e[0]==`number`&&isFinite(e[0])&&typeof e[1]==`number`&&isFinite(e[1])&&typeof e[2]==`number`&&isFinite(e[2])?N(e,t)||(h(t,e),this._markViewDirty(),n.length&&this.notifyChange(n)):o.getLogger(`esri.views.3d.webgl-engine.lib.RenderCamera`).warn(`RenderCamera vector contains invalid number, ignoring value`)}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&=(xt(this.viewMatrix,this.projectionMatrix,this._frustum),!1)}_ensureViewClean(){this._viewDirty&&(f(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange(`_viewMatrix`),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};F([r()],U.prototype,`_viewport`,void 0),F([r()],U.prototype,`_padding`,void 0),F([r()],U.prototype,`_fov`,void 0),F([r()],U.prototype,`_nearFar`,void 0),F([r()],U.prototype,`_viewDirty`,void 0),F([r()],U.prototype,`_viewMatrix`,void 0),F([r()],U.prototype,`_pixelRatio`,void 0),F([r()],U.prototype,`pixelRatio`,null),F([r()],U.prototype,`row`,void 0),F([r()],U.prototype,`column`,void 0),F([r()],U.prototype,`_rows`,void 0),F([r()],U.prototype,`rows`,null),F([r()],U.prototype,`_columns`,void 0),F([r()],U.prototype,`columns`,null),F([r()],U.prototype,`eye`,null),F([r()],U.prototype,`center`,null),F([r()],U.prototype,`_center`,void 0),F([r()],U.prototype,`up`,null),F([r()],U.prototype,`_up`,void 0),F([r()],U.prototype,`viewMatrix`,null),F([r({readOnly:!0})],U.prototype,`viewForward`,null),F([r({readOnly:!0})],U.prototype,`viewUp`,null),F([r({readOnly:!0})],U.prototype,`viewRight`,null),F([r({readOnly:!0})],U.prototype,`nearFar`,null),F([r()],U.prototype,`near`,null),F([r()],U.prototype,`far`,null),F([r()],U.prototype,`viewport`,null),F([r({readOnly:!0})],U.prototype,`screenViewport`,null),F([r({readOnly:!0})],U.prototype,`screenPadding`,null),F([r()],U.prototype,`x`,null),F([r()],U.prototype,`y`,null),F([r()],U.prototype,`width`,null),F([r()],U.prototype,`height`,null),F([r()],U.prototype,`fullWidth`,null),F([r()],U.prototype,`fullHeight`,null),F([r({readOnly:!0})],U.prototype,`_aspect`,null),F([r()],U.prototype,`padding`,null),F([r({readOnly:!0})],U.prototype,`projectionMatrix`,null),F([r({readOnly:!0})],U.prototype,`inverseProjectionMatrix`,null),F([r()],U.prototype,`fov`,null),F([r()],U.prototype,`fovX`,null),F([r()],U.prototype,`fovY`,null),F([r()],U.prototype,`viewInverseTransposeMatrix`,null),F([r({readOnly:!0})],U.prototype,`_projectionMatrixInternal`,null),F([r()],U.prototype,`relativeElevation`,void 0),U=It=F([de(`esri.views.3d.webgl.RenderCamera`)],U);var Lt=U,W=me(),Rt=_(),G=B(),K=B(),zt=he(),Bt=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerViewUids=[],this.store=2,this.normalRequired=!0,this.excludeLabels=!1}},Vt=class{constructor(){this._transform=_(),this._transformInverse=new Ht({value:this._transform},le,_),this._transformInverseTranspose=new Ht(this._transformInverse,t,_),this._transformTranspose=new Ht({value:this._transform},t,_),this._transformInverseRotation=new Ht({value:this._transform},Fe,ae)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){v(this._transform,e)}multiplyTransform(e){ie(this._transform,this._transform,e)}set(e){v(this._transform,e),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,t){this.setTransformMatrix(e),this.multiplyTransform(t),this._invalidateLazyTransforms()}},Ht=class{constructor(e,t,n){this._original=e,this._update=t,this._dirty=!0,this._transform=n()}invalidate(){this._dirty=!0}get value(){return this._dirty&&=(this._update(this._transform,this._original.value),!1),this._transform}},Ut=class{constructor(e=0){this.offset=e,this.tmpVertex=B()}applyToVertex(e,t,n){let r=k(qt,e,t,n),a=ce(Jt,r,this.localOrigin),o=this.offset/M(a);return i(this.tmpVertex,r,a,o),this.tmpVertex}applyToAabb(e){let t=Yt,n=Xt,r=Zt;for(let i=0;i<3;++i)t[i]=e[0+i]+this.localOrigin[i],n[i]=e[3+i]+this.localOrigin[i],r[i]=t[i];let i=this.applyToVertex(t[0],t[1],t[2]);for(let t=0;t<3;++t)e[t]=i[t],e[t+3]=i[t];let a=t=>{let n=this.applyToVertex(t[0],t[1],t[2]);for(let t=0;t<3;++t)e[t]=Math.min(e[t],n[t]),e[t+3]=Math.max(e[t+3],n[t])};for(let e=1;e<8;++e){for(let i=0;i<3;++i)r[i]=e&1<<i?n[i]:t[i];a(r)}let o=0;for(let e=0;e<3;++e)t[e]*n[e]<0&&(o|=1<<e);if(o!==0&&o!==7){for(let e=0;e<8;++e)if((o&e)===0){for(let i=0;i<3;++i)r[i]=o&1<<i?0:e&1<<i?t[i]:n[i];a(r)}}for(let t=0;t<3;++t)e[t]-=this.localOrigin[t],e[t+3]-=this.localOrigin[t];return e}},Wt=class{constructor(e=0){this.componentLocalOriginLength=0,this._totalOffset=0,this._offset=0,this._tmpVertex=B(),this._tmpMbs=new ft,this._tmpObb=new rt,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=M(e)}applyToVertex(e,t,n){let r=k(qt,e,t,n),a=k(Jt,e,t,n+this.componentLocalOriginLength),o=this._totalOffset/M(a);return i(this._tmpVertex,r,a,o),this._tmpVertex}applyToAabb(e){let t=this.componentLocalOriginLength,n=e[0],r=e[1],i=e[2]+t,a=e[3],o=e[4],s=e[5]+t,c=Math.abs(n),l=Math.abs(r),u=Math.abs(i),d=Math.abs(a),f=Math.abs(o),p=Math.abs(s),m=.5*(1+Math.sign(n*a))*Math.min(c,d),h=.5*(1+Math.sign(r*o))*Math.min(l,f),g=.5*(1+Math.sign(i*s))*Math.min(u,p),_=Math.max(c,d),v=Math.max(l,f),y=Math.max(u,p),b=Math.sqrt(m*m+h*h+g*g),ee=Math.sign(c+n),x=Math.sign(l+r),S=Math.sign(u+i),C=Math.sign(d+a),w=Math.sign(f+o),te=Math.sign(p+s),T=this._totalOffset;if(b<T)return e[0]-=(1-ee)*T,e[1]-=(1-x)*T,e[2]-=(1-S)*T,e[3]+=C*T,e[4]+=w*T,e[5]+=te*T,e;let ne=T/Math.sqrt(_*_+v*v+y*y),E=T/b,D=E-ne,O=-D;return e[0]+=n*(ee*O+E),e[1]+=r*(x*O+E),e[2]+=i*(S*O+E),e[3]+=a*(C*D+ne),e[4]+=o*(w*D+ne),e[5]+=s*(te*D+ne),e}applyToMbs(e){let t=e.center,n=M(t),r=this._totalOffset/n;return i(this._tmpMbs.center,t,t,r),this._tmpMbs.radius=e.radius+e.radius*this._totalOffset/n,this._tmpMbs}applyToObb(e){return nt(e,this._totalOffset,this._totalOffset,1,this._tmpObb),this._tmpObb}},Gt=new class{constructor(e=0){this.offset=e,this.tmpVertex=B(),this._tmpSphere=new ft}applyToVertex(e,t,n){let r=this.objectTransform.transform,a=(k(qt,e,t,n)),o=(P(a,a,r)),s=this.offset/(M(o));i(o,o,o,s);let c=this.objectTransform.inverse;return P(this.tmpVertex,o,c),this.tmpVertex}applyToMinMax(e,t){let n=this.offset/(M(e));i(e,e,e,n);let r=this.offset/(M(t));i(t,t,t,r)}applyToAabb(e){let t=this.offset/(Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]));e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;let n=this.offset/(Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]));return e[3]+=e[3]*n,e[4]+=e[4]*n,e[5]+=e[5]*n,e}applyToBoundingSphere(e){let t=e.center,n=(M(t)),r=this.offset/n;return i(this._tmpSphere.center,t,t,r),this._tmpSphere.radius=e.radius+e.radius*this.offset/n,this._tmpSphere}};function Kt(e){return e==null?null:(Gt.offset=e,Gt)}new Wt,new Ut;var qt=B(),Jt=B(),Yt=B(),Xt=B(),Zt=B(),Qt=1e-5,$t=class{constructor(e){this.options=new Bt,this._results=new tn,this.transform=new Vt,this.camera=new Lt,this.tolerance=Qt,this.verticalOffset=null,this._ray=V(),this._rayEnd=B(),this._rayBeginTransformed=B(),this._rayEndTransformed=B(),this.viewingMode=e??1}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,n){this.resetWithRay(st(e,t,this._ray),n)}resetWithRay(e,t){this.camera=t,e!==this._ray&&at(e,this._ray),this.options.verticalOffset===0?this.verticalOffset=null:this.viewingMode===2?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset,ce(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,t,n,r,i){this.point=t,this.filterPredicate=r,this.tolerance=n??1e-5;let a=Kt(this.verticalOffset);if(e&&e.length>0){let t=i?e=>{i(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(let n of e){let e=n.getSpatialQueryAccelerator?.();e==null?n.objects.forEach(e=>t(e)):(a==null?e.forEachAlongRay(this._ray.origin,this._ray.direction,t):e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,a),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t))}}this.sortResults()}intersectObject(e){let t=e.geometries;if(!t)return;let n=e.effectiveTransformation,r=Kt(this.verticalOffset);for(let i of t){if(!i.visible)continue;let{material:t,id:a}=i;if(!t.visible)continue;this.transform.setAndInvalidateLazyTransforms(n,i.transformation),P(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),P(this._rayEndTransformed,this.rayEnd,this.transform.inverse);let o=this.transform.transform;r!=null&&(r.objectTransform=this.transform),t.intersect(i,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(t,n,r,i)=>this.handleObjectIntersection({object:e,geometryId:a,primitiveIndex:r},t,n,o,i))}}handleObjectIntersection(e,t,n,r,i){if(t<0||this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;let a=i?this._results.hud:this._results;e=i?new ut(e,i):e;let o=i?r=>r.set(1,e,t,n):i=>i.set(4,e,t,n,r);if((a.min.distance==null||t<a.min.distance)&&o(a.min),this.options.store!==0&&(a.max.distance==null||t>a.max.distance)&&o(a.max),this.options.store===2)if(i){let e=new ct(this._ray);o(e),this._results.hud.all.push(e)}else{let e=new lt(this._ray);o(e),this._results.all.push(e)}}sortResults(e=this._results.all){e.sort((e,t)=>e.distance===t.distance?e.drapedLayerOrder===t.drapedLayerOrder?en(e.renderPriority,t.renderPriority):en(e.drapedLayerOrder,t.drapedLayerOrder):(e.distance??0)-(t.distance??0))}};function en(e,t){return(t??-Number.MAX_VALUE)-(e??-Number.MAX_VALUE)}var tn=class{constructor(){this.min=new lt(V()),this.max=new lt(V()),this.hud={min:new ct(V()),max:new ct(V()),all:[]},this.ground=new lt(V()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}};B(),B(),B();function nn(e,t){let n=[],r=[];return rn(n,e,t,0),rn(r,n,t,1),rn(n,r,t,2),rn(r,n,t,3),r}function rn(e,t,n,r){let i=on(n,r);if(e.length=0,t.length){i(sn,t[0],t[0])===1&&an(e,t[0]);for(let n=0;n<t.length;n++){let r=t[n===t.length-1?0:n+1];switch(i(sn,t[n],r)){case 1:an(e,r);break;case 3:an(e,Pe(sn));break;case 2:an(e,Pe(sn)),an(e,r)}}}}function an(e,t){e.length!==0&&oe(e.at(-1),t)||e.push(t)}function on(e,t){let n=t===0||t===2?0:1,r=e[t],i=t===0||t===1?1:-1,a=n===0?1:0;return(e,t,o)=>{if(t[n]<r&&o[n]<r)return i===1?0:1;if(t[n]>r&&o[n]>r)return i===1?1:0;let s=(o[a]-t[a])/(o[n]-t[n]),c=t[a]+s*(r-t[n]);return e[n]=r,e[a]=c,(t[n]<r?1:-1)*i>0?2:3}}var sn=ue(),cn=B(),ln=B();function un(){return{direction:B(),up:B()}}function dn(e,t,n,r,i){let a=I(cn,e),o=z(a,r),s=o>0;o=Math.abs(o),o>.99&&(o=Math.abs(z(t,r)),o<.99?(h(a,t),s&&C(a,a,-1)):a=null);let c=0;if(a){C(ln,r,z(r,a)),De(a,a,ln);let e=z(a,i)/(M(a)*M(i));T(ln,a,i),c=(z(ln,r)>0?1:-1)*L(Te(e))}let l=L(Te(-z(r,e)/M(e)));return n?(n.heading=c,n.tilt=l,n):{heading:c,tilt:l}}function fn(e,t,n,r){De(pn,n,t),Qe(r,mt(t,pn),e)||e===n||h(e,n)}var pn=B(),mn=R(0,1,0),hn=R(0,0,1),gn=_(),q=B(),J=B();function _n(e,t,n,r=un()){let{direction:i,up:a}=r;return ne(gn,-j(t)),b(gn,gn,j(n)),P(i,hn,gn),C(i,i,-1),P(a,mn,gn),r}function vn(e,t,n,r){return dn(t,n,r,hn,mn)}function yn(e,t,n,r){let i=_n(e,n,r),a=B();return C(a,i.direction,-t),ce(a,a,e),{up:i.up,eye:a,heading:n,tilt:r}}function bn(e){return L(e)}function xn(e){return j(e)}function Sn(e,t,n,r,i){let a=e.renderSpatialReference,o=e.spatialReference??t.spatialReference;return et(t,q,a),et(t,J,a),q[0]-=n/2,J[0]+=n/2,q[1]-=r/2,J[1]+=r/2,tt(q,a,q,o),tt(J,a,J,o),i?(i.xmin=q[0],i.ymin=q[1],i.xmax=J[0],i.ymax=J[1],i.spatialReference=o):i=new ze(q[0],q[1],J[0],J[1],o),i}function Cn(e,t){let n=e.frustum,{renderCoordsHelper:r}=e,i=r.getAltitude(t),a=e.spatialReference,o=e.state.camera.eye,s=[],c=n.planes[5];for(let e=0;e<4;e++){let t=n.lines[e];r.intersectInfiniteManifold(ot(t.origin,t.direction),i,Y)||wn(Y,n,r,t.endpoint,i),fn(Y,o,Y,c),s.push(m(Y[0],Y[1]))}return Tn(nn(s,r.extent),r,a)}function wn(e,t,n,r,a){let o=t.lines[11].direction,s=(a-n.getAltitude(r))/o[2];i(e,r,o,s)}function Tn(e,t,n){let r=e.map(e=>(k(Y,e[0],e[1],0),t.fromRenderCoords(Y,Y,n),[Y[0],Y[1]]));return r.length<=2?new a({spatialReference:n}):(r.push(r[0].slice()),O(r)||r.reverse(),new a({rings:[r],spatialReference:n}))}var Y=B();Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:vn,eyeForCenterWithHeadingTilt:yn,eyeTiltToLookAtTilt:xn,headingTiltToDirectionUp:_n,lookAtTiltToEyeTilt:bn,toArea:Cn,toExtent:Sn},Symbol.toStringTag,{value:`Module`}));var En=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}get boundingSphere(){return this._boundingSphereDirty&&this._updateBoundingSphere(),this._boundingSphere}constructor(e){this.renderCoordsHelper=e,this.frustum=bt(),this._points=wt(),this.lines=Array(12),this._origin=B(),this._direction=B(),this._boundingSphere=new ft,this._altitude=null,this._boundingSphereDirty=!0;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:B(),endpoint:null}}update(e){xt(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),h(this._origin,e.eye),h(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines(),this._boundingSphereDirty=!0}updatePoints(e){for(let t=0;t<this._points.length;t++)h(this._points[t],e[t]);St(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return yt(this.frustum,e)}intersectsRay(e){return Ct(this.frustum,e)}intersectsLineSegment(e,t){return Tt(this.frustum,e,t)}intersectsPoint(e){return Et(this.frustum,e)}_updateLines(){let e=this._points;for(let t=0;t<4;t++){let n=t+4;Dn(this.lines[t],e[t],e[n]),Dn(this.lines[t+4],e[t],t===3?e[0]:e[t+1]),Dn(this.lines[t+8],e[n],t===3?e[4]:e[n+1])}}_updateBoundingSphere(){let{origin:e}=this,t=kn;I(t,this.direction);let n=On;c(n,this.points[4],e);let r=.5*z(n,n)/z(t,n),a=this._boundingSphere;a.center=i(An,e,t,r),a.radius=r}static{this.planePointIndices=Dt}static{this.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]]}};function Dn(e,t,n){e.origin=t,e.endpoint=n,He(e.direction,t,n)}var On=B(),kn=B(),An=B(),jn=R(5802e-9,13558e-9,331e-7),Mn=3,Nn=R(65e-8*Mn,1881e-9*Mn,85e-9*Mn);R(jn[0]+Nn[0],jn[1]+Nn[1],jn[2]+Nn[2]);var Pn=class e{constructor(e=1/0,t=-1/0){this.near=e,this.far=t}set(e,t){this.near=e,this.far=t}union(e){return e!=null&&(this.near=Math.min(this.near,e.near),this.far=Math.max(this.far,e.far)),this}within(e){return this.near<=e&&e<=this.far}equals(e){return this.near===e.near&&this.far===e.far}static{this.Zero=new e(0,0)}static{this.Infinite=new e}};B(),B(),new ft,V();function Fn(e,t,n){let r=t/n,i=j(e),a=Math.sin(r/2),o=Math.cos(i),s=2*We(Math.sqrt(a*a/(o*o)));return L(s)}var In=R(0,0,1),Ln=I(B(),R(1,1,1)),Rn=_(),X=B(),zn=B();function Bn(e,t,n,r=un()){T(X,e,In),z(X,X)===0&&T(X,e,Ln),pe(Rn,-j(t),e),ee(Rn,Rn,-j(n),X);let{up:i,direction:a}=r;return T(i,X,e),I(i,i),P(i,i,Rn),I(a,e),y(a,a),P(a,a,Rn),r}function Vn(e,t,n,r){let i=X,a=zn;return I(i,e),T(zn,i,In),z(zn,zn)===0&&T(zn,i,Ln),T(a,zn,i),dn(t,n,r,i,a)}function Hn(e,t,n,r){let i={eye:B(),up:null,tilt:r,heading:n},a=X;a[0]=e[0],a[1]=e[2],a[2]=-e[1];let o=t,s=j(n),c=j(r),l=Math.sin(s),u=Math.cos(s),d=Math.sin(c),f=Math.cos(c),p=M(a),m;if(Math.abs(c)<1e-8)m=o+p;else{let e=p/d,t=We(o/e),n=Math.PI-c-t;m=e*Math.sin(n)}let h=f*o,g=o*o*(d*d),_=u*u*g,v=m-h,y=v*v,b=_*(_+y-a[1]*a[1]);if(b<0)return C(i.eye,a,m/p),i.tilt=0,Wn(i,e);let ee=Math.sqrt(b),x=a[1]*v,S=_+y,w;if(w=u>0?-ee+x:ee+x,Math.abs(S)<1e-8)return p<1e-8?(i.eye[0]=0,i.eye[1]=0,i.eye[2]=o):C(i.eye,a,m/p),i.tilt=0,Un(i.eye),Wn(i,e);i.eye[1]=w/S;let te=l*l*g,T=d*o,ne=u*T*i.eye[1],E=i.eye[1]*i.eye[1],D=1-E,O=Math.sqrt(D),re=_*E+te-2*ne*O*v+D*y;return Math.abs(re)<1e-8?(C(i.eye,a,m/p),i.tilt=0,Un(i.eye),Wn(i,e)):(i.eye[0]=(D*(m*a[0]-h*a[0])-T*O*(a[0]*i.eye[1]*u+a[2]*l))/re,i.eye[2]=(D*(m*a[2]-h*a[2])-T*O*(a[2]*i.eye[1]*u-a[0]*l))/re,C(i.eye,i.eye,m),Un(i.eye),Wn(i,e))}function Un(e){let t=e[1];e[1]=-e[2],e[2]=t}function Wn(e,t){return e.up=Bn(t,e.heading,e.tilt).up,e}function Gn(e,t,n){let r=M(t),i=Math.sqrt(n*n+r*r-2*n*r*Math.cos(Math.PI-e)),a=We(n/(i/Math.sin(e)));return L(e-a)}function Kn(e,t,n){let r=j(e),i=M(t);return We(n/(i/Math.sin(r)))+r}function qn(e,t,n,r,i){let a,o,s,c,l=t.latitude,u=Se(e.spatialReference).radius,d=t.longitude,f=Fn(l,n,u)/2;a=d-f,o=d+f;let p=j(l),m=(1+Math.sin(p))/(1-Math.sin(p)),h=(m+1)*Math.tan(r/u/2),g=h*h;function _(e){let t=Math.PI/2;return(e=ye.normalize(e,-t))>t&&(e=Math.PI-e),e}if(s=1.5*Math.PI-2*Math.atan(.5*(h+Math.sqrt(4*m+g))),c=s+r/u,s=_(s),c=_(c),c<s){let e=c;c=s,s=e}if(s=Math.max(L(s),-90),c=Math.min(L(c),90),o=Ue.monotonic(a,o),o-a>180){let e=(o-a-180)/2;a+=e,o-=e}let v=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:S.WGS84;return i?(i.xmin=a,i.ymin=s,i.xmax=o,i.ymax=c,i.spatialReference=v):i=new ze(a,s,o,c,v),e.spatialReference&&e.spatialReference.isWebMercator&&te(i,!1,i),i}function Jn(e,t){let{renderCoordsHelper:n}=e,r=e.state.camera.clone(),i=new En(n);r.near=2,i.update(r);let o=n.getAltitude(t),c=e.spatialReference,l=n.referenceEllipsoid.radius,u=r.eye,d=1+Ge(u,t)/(l+o),f=Math.sqrt(d*d-1),{minCurvature:p,maxCurvature:m,minSamples:h,maxSamples:g}=$n,_=Qn(e),v=Ve((f-p)/(m-p),0,1),y=Math.round(A(h,g,v)),b=r.aboveGround,ee=i.planes[5],x=[],S=Ze(Ce,er,$e()),C=Ze(Ce,tr,$e());ke(or,0,0,0,0);for(let e=0;e<4;e++){let t=e===1&&!b||e===3&&b?1-_:0,r=e===1&&b||e===3&&!b?_:1,a=i.lines[e],c=i.lines[e===3?0:e+1];for(let i=0;i<y;i++){let l=i/y,d=i===0?0:A(t,r,e===1?1-(1-l)**2:e===3?l**2:l),f=ge(rr,a.origin,c.origin,d),p=Ke(a.direction,c.direction,d,nr);n.intersectManifoldClosestSilhouette(ot(f,p),o,Z),fn(Z,u,Z,ee),x.push(s(Z)),x.length!==0&&se(x.at(-1),Z);let m=(Ye(S,Z)?1:0)|(Ye(C,Z)?2:0);or[m]=1}}x.length>2&&se(x[0],x.at(-1));let w=Yn(xe(or)>1?Xn(Zn(x,S),C):[x],n,c);return new a({rings:w,spatialReference:c})}function Yn(e,t,n){let r=2*p();return e.map(e=>{let i=[],a=!1;for(let o of e)t.fromRenderCoords(o,Z,n),Math.abs(o[0])<r&&Math.abs(o[1])<r?(i.push([null,Z[1]]),i.push([null,Z[1]]),a=!0):i.push([Z[0],Z[1]]);if(a)for(let e=0;e<i.length;e++){let t=i[e];if(t[0]!=null)continue;let n=i[e+1];t[0]=i.at(e===0?-1:e-1)[0],e++,n[0]=i.at(e===i.length-1?0:e+1)[0]}return i.push(i[0]),O(i)||i.reverse(),i})}function Xn(e,t){let n=[];for(let r of e)n.push(...Zn(r,t));return n}function Zn(e,t){let n=[],r=[],a=p();for(let o=0;o<e.length;o++){let s=e[o],c=o===e.length-1?e[0]:e[o+1],l=ht(s,c,ar),u=qe(t,l.origin,l.vector,0,Z);switch(u){case 2:n.push(s);break;case 3:r.push(s);break;case 0:case 1:{let[e,o,c]=u===0?[1,n,r]:[-1,r,n],l=Je(t),d=i(B(),Z,l,e*a),f=i(B(),Z,l,e*-a);o.push(s),o.push(d),c.push(f)}}}let o=[];return n.length&&o.push(n),r.length&&o.push(r),o}function Qn(e){let{renderCoordsHelper:t,state:n}=e,r=Math.abs(t.getAltitude(n.camera.center));return ir.radius=t.referenceEllipsoid.radius+r,n.camera.sphereFrustumCoverage(ir,t)}var $n={minCurvature:j(5),maxCurvature:j(50),minSamples:1,maxSamples:6},er=R(1,0,0),tr=R(0,1,0),nr=B(),rr=B(),Z=B(),ir=new ft,ar=pt(),or=me();Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:Vn,eyeForCenterWithHeadingTilt:Hn,eyeTiltToLookAtTilt:Kn,headingTiltToDirectionUp:Bn,lookAtTiltToEyeTilt:Gn,toArea:Jn,toExtent:qn},Symbol.toStringTag,{value:`Module`}));var sr={OPAQUE:`opaque-color`,TRANSPARENT:`transparent-color`,COMPOSITE:`composite-color`,FINAL:`final-color`},cr={SSAO:`ssao`,LASERLINES:`laserline-color`,ANTIALIASING:`aa-color`,HIGHLIGHTS:`highlight-color`,MAGNIFIER:`magnifier-color`,OCCLUDED:`occluded-color`,VIEWSHED:`viewshed-color`,CUTFILL_DEPTH:`cutfill-depth`,CUTFILL_COLOR:`cutfill-color`,OPAQUE_TERRAIN:`opaque-terrain-color`,OPAQUE_ENVIRONMENT:`opaque-environment-color`,TRANSPARENT_ENVIRONMENT:`transparent-environment-color`,FOCUSAREA:`focusarea`,FOCUSAREA_COLOR:`focusarea-color`};B();var Q=class extends n{constructor(e){super(e),this.view=null,this.consumes={required:[]},this.produces=sr.COMPOSITE,this.requireGeometryDepth=!1,this._dirty=!0}initialize(){this.addHandles([Ne(()=>this.view.ready,e=>{e&&this.view.stage?.renderer.addRenderNode(this)},be)])}destroy(){this.view.stage?.renderer?.removeRenderNode(this)}precompile(){}render(){throw new e(`RenderNode:render-function-not-implemented`,`render() is not implemented.`)}get camera(){return this.view.state.camera.clone()}get sunLight(){return this.bindParameters.lighting.legacy}get gl(){return this.view.stage.renderView.renderingContext.gl}get techniques(){return this.view.stage.renderView.techniques}acquireOutputFramebuffer(){let e=this._frameBuffer?.getTexture()?.descriptor,t=this.view.stage.renderer.fboCache.acquire(e?.width??640,e?.height??480,this.produces);return t.fbo?.initializeAndBind(),t}bindRenderTarget(){return this._frameBuffer?.fbo?.initializeAndBind(),this._frameBuffer}requestRender(e){switch(e){case 2:this.view.state.fading=!0;case 1:this.view.stage?.renderView.requestRender(e);case 0:case void 0:this._dirty=!0}}resetWebGLState(){this.renderingContext.resetState(),this.renderingContext.bindFramebuffer(this._frameBuffer?.fbo)}get fboCache(){return this.view.stage.renderer.fboCache}get bindParameters(){return this.renderContext.bind}get renderingContext(){return this.view.stage.renderView.renderingContext}get renderContext(){return this.view.stage?.renderer.renderContext}updateAnimation(e){return!!this._dirty&&(this._dirty=!1,!0)}doRender(e){this._frameBuffer=e.find(({name:e})=>e===this.produces);try{return this.render(e)}finally{this._frameBuffer=null}}};F([D({constructOnly:!0})],Q.prototype,`view`,void 0),F([D({constructOnly:!0})],Q.prototype,`consumes`,void 0),F([D()],Q.prototype,`produces`,void 0),F([D({readOnly:!0})],Q.prototype,`techniques`,null),Q=F([g(`esri.views.3d.webgl.RenderNode`)],Q);var lr=class{constructor(e,t){this._module=e,this._load=t}get(){return this._module}async reload(){return this._module=await this._load(),this._module}},ur=[];new H(`position`,3,w.FLOAT,0,12);var dr=[new H(`position`,2,w.FLOAT,0,8)];dt(dr),new H(`position`,2,w.FLOAT,0,12),new H(`uv0`,2,w.HALF_FLOAT,8,12),new H(`position`,2,w.FLOAT,0,16),new H(`uv0`,2,w.FLOAT,8,16);var fr=class{constructor(e,t,n){this._context=e,this.locations=n,this._textures=new Map,this.source=fe()?t:null,t.attributeNames.forEach(e=>{n.has(e)||console.error(`Missing VertexAttributeLocation for ${e} used in shader`)}),this._glProgram=e.programCache.acquire(t.generate(`vertex`,!0),t.generate(`fragment`,!0),n),this._glProgram.stop=()=>{throw Error(`Wrapped _glProgram used directly`)},this.bind=t.generateBind(this),this.bindPass=t.generateBindPass(this),this.bindDraw=t.generateBindDraw(this)}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,t){this._glProgram.setUniform1i(e,t?1:0)}setUniform1i(e,t){this._glProgram.setUniform1i(e,t)}setUniform1f(e,t,n){this._glProgram.setUniform1f(e,t,n)}setUniform2fv(e,t,n){this._glProgram.setUniform2fv(e,t,n)}setUniform3fv(e,t,n){this._glProgram.setUniform3fv(e,t,n)}setUniform4fv(e,t,n){this._glProgram.setUniform4fv(e,t,n)}setUniformMatrix3fv(e,t,n){this._glProgram.setUniformMatrix3fv(e,t,!1,n)}setUniformMatrix4fv(e,t,n){this._glProgram.setUniformMatrix4fv(e,t,!1,n)}setUniformMatrices4fv(e,t,n){this._glProgram.setUniformMatrices4fv(e,t,!1,n)}setUniform1fv(e,t,n){this._glProgram.setUniform1fv(e,t,n)}setUniform1iv(e,t){this._glProgram.setUniform1iv(e,t)}setUniform2iv(e,t){this._glProgram.setUniform2iv(e,t)}setUniform3iv(e,t){this._glProgram.setUniform3iv(e,t)}setUniform4iv(e,t){this._glProgram.setUniform4iv(e,t)}assertCompatibleVertexAttributeLocations(e,t){let n=e.locations;if(t){let e=new Map(n);t.forEach((t,r)=>e.set(r,n.size+t)),n=e}n.size!==this.locations.size&&console.error(`VertexAttributeLocations are incompatible: ${n}, ${this.locations}`),this.locations.forEach((e,t)=>{n.get(t)!==e&&console.error(`VertexAttributeLocations are incompatible: Program has ${t} at position ${e}, VAO has it at position ${n.get(t)}.`)})}stop(){this._textures.clear()}bindTexture(e,t){if(!t?.glName){let n=`Texture sampler ${e} in ${this._context.debugBoundTechnique} has no given Texture in ${Error().stack}`;fe()&&console.error(n),t=this._context.emptyTexture}let n=this._ensureTextureUnit(e,t);this._context.useProgram(this),this.setUniform1i(e,n.unit),this._context.bindTexture(t,n.unit)}_ensureTextureUnit(e,t){let n=this._textures.get(e);return n==null?(n={texture:t,unit:this._textures.size},this._textures.set(e,n)):n.texture=t,n}},pr=()=>o.getLogger(`esri.views.3d.webgl.ShaderTechnique`),mr=class extends n{constructor(e,t,n){super({}),this._context=e,this._configuration=t,this.primitiveType=x.TRIANGLES,this.key=t.key,this.locations=dt(n??dr),this._pipeline=this.initializePipeline(t),this.reload=async n=>{if(n&&await this.shader.reload(),!this.key.equals(t.key))return void pr().warn(`Configuration was changed after construction, cannot reload shader for ${this.declaredClass}.`);Ee(this._program);let r=this.shader.get().build(t);r.debugName=this.declaredClass,this._program=new fr(e.rctx,r,this.locations),this._pipeline=this.initializePipeline(t)}}initialize(){let e=this.shader.get().build(this._configuration);e.debugName=this.declaredClass,this._program=new fr(this._context.rctx,e,this.locations)}destroy(){this._program=Ee(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}getPipeline(e,t){return this._pipeline}initializePipeline(e){return vt({blending:_t,colorWrite:gt})}};function hr(e,t){return it(e)?{buffers:[0]}:t??null}mr=F([de(`esri.views.3d.webgl-engine.core.shaderTechnique.ShaderTechnique`)],mr);var gr=class{constructor(e=ve()){this.intensity=e}},_r=class{constructor(e=ve(),t=R(.57735,.57735,.57735)){this.intensity=e,this.direction=t}},vr=class{constructor(e=ve(),t=R(.57735,.57735,.57735),n=!0,r=1,i=1){this.intensity=e,this.direction=t,this.castShadows=n,this.specularStrength=r,this.environmentStrength=i}},yr=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}};function br(e,t,n){(n||=e).length=e.length;for(let r=0;r<e.length;r++)n[r]=e[r]*t[r];return n}function xr(e,t,n){(n||=e).length=e.length;for(let r=0;r<e.length;r++)n[r]=e[r]*t;return n}function Sr(e,t,n){(n||=e).length=e.length;for(let r=0;r<e.length;r++)n[r]=e[r]+t[r];return n}function Cr(e){return(e+1)*(e+1)}function wr(e){return Ve(Math.floor(Math.sqrt(e)-1),0,2)}function Tr(e,t,n){let r=e[0],i=e[1],a=e[2],o=n||[];return o.length=Cr(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*r,o[2]=.4886025119*a,o[3]=.4886025119*i),t>=2&&(o[4]=1.09254843059*r*i,o[5]=1.09254843059*i*a,o[6]=.31539156525*(3*a*a-1),o[7]=1.09254843059*r*a,o[8]=.54627421529*(r*r-i*i)),o}function Er(e,t){let n=Cr(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=n;for(let e=0;e<n;e++)r.r[e]=r.g[e]=r.b[e]=0;return r}function Dr(e,t){let n=wr(t.r.length);for(let r of e)y(Pr,r.direction),Tr(Pr,n,$),br($,Fr),xr($,r.intensity[0],Nr),Sr(t.r,Nr),xr($,r.intensity[1],Nr),Sr(t.g,Nr),xr($,r.intensity[2],Nr),Sr(t.b,Nr);return t}function Or(e,t){Tr(Pr,0,$);for(let n of e)t.r[0]+=$[0]*Fr[0]*n.intensity[0]*4*Math.PI,t.g[0]+=$[0]*Fr[0]*n.intensity[1]*4*Math.PI,t.b[0]+=$[0]*Fr[0]*n.intensity[2]*4*Math.PI;return t}function kr(e,t,n,r){Er(t,r),k(n.intensity,0,0,0);let i=!1,a=Ar,o=jr,s=Mr;a.length=0,o.length=0,s.length=0;for(let t of e)t instanceof vr&&!i?(h(n.direction,t.direction),h(n.intensity,t.intensity),n.specularStrength=t.specularStrength,n.environmentStrength=t.environmentStrength,n.castShadows=t.castShadows,i=!0):t instanceof vr||t instanceof _r?a.push(t):t instanceof gr?o.push(t):t instanceof yr&&s.push(t);Dr(a,r),Or(o,r);for(let e of s)Sr(r.r,e.r),Sr(r.g,e.g),Sr(r.b,e.b)}var Ar=[],jr=[],Mr=[],$=[0],Nr=[0],Pr=B(),Fr=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398],Ir=class{constructor(){this.color=B(),this.intensity=1}},Lr=class{constructor(){this.direction=B(),this.ambient=new Ir,this.diffuse=new Ir}},Rr=.4,zr=class{constructor(){this._shOrder=2,this._legacy=new Lr,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new yr,this._mainLight=new vr(B(),R(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(e){kr(e,this._shOrder,this._mainLight,this._sphericalHarmonics),this.updateLegacy()}updateLegacy(){h(this._legacy.direction,this._mainLight.direction);let e=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*e,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*e,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*e,C(this._legacy.diffuse.color,this._mainLight.intensity,e),h(Br,this._legacy.diffuse.color),C(Br,Br,Rr*this.globalFactor),ce(this._legacy.ambient.color,this._legacy.ambient.color,Br)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),h(this._mainLight.direction,e.mainLight.direction),h(this._mainLight.intensity,e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,t,n){if(ge(this._mainLight.intensity,e.mainLight.intensity,t.mainLight.intensity,n),this._mainLight.environmentStrength=A(e.mainLight.environmentStrength,t.mainLight.environmentStrength,n),this._mainLight.specularStrength=A(e.mainLight.specularStrength,t.mainLight.specularStrength,n),h(this._mainLight.direction,t.mainLight.direction),this._mainLight.castShadows=t.mainLight.castShadows,this.globalFactor=A(e.globalFactor,t.globalFactor,n),this.noonFactor=A(e.noonFactor,t.noonFactor,n),e.sh.r.length===t.sh.r.length)for(let r=0;r<t.sh.r.length;r++)this._sphericalHarmonics.r[r]=A(e.sh.r[r],t.sh.r[r],n),this._sphericalHarmonics.g[r]=A(e.sh.g[r],t.sh.g[r],n),this._sphericalHarmonics.b[r]=A(e.sh.b[r],t.sh.b[r],n);else for(let e=0;e<t.sh.r.length;e++)this._sphericalHarmonics.r[e]=t.sh.r[e],this._sphericalHarmonics.g[e]=t.sh.g[e],this._sphericalHarmonics.b[e]=t.sh.b[e];this.updateLegacy()}},Br=B();export{mr as a,Q as c,$t as d,Kt as f,hr as i,cr as l,Rr as n,ur as o,Lt as p,gr as r,lr as s,zr as t,Pn as u};