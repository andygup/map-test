const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/visualVariableUtils-C-nBNHVa.js","assets/index-CZ4oMP1N.js","assets/index-CDgdHpAj.css"])))=>i.map(i=>d[i]);
import{AT as e,BS as t,BT as n,Bx as r,DT as i,Dd as a,Dv as o,GC as s,Hw as c,JE as l,Jp as u,OT as d,Oh as f,Q_ as p,RS as m,Rp as h,Up as g,_u as _,_w as v,aE as y,ax as b,du as x,eT as S,fS as ee,gD as C,gu as w,gv as T,hu as E,hv as te,iv as D,jT as O,oa as k,pD as A,rT as j,rh as M,sa as ne,tE as N,vd as P,vv as F,wx as I}from"./index-CZ4oMP1N.js";import{n as L,t as R}from"./popupUtils-Bb88Y0DD.js";import{t as z}from"./sublayerUtils-B_4dS-HF.js";import{t as B}from"./floorFilterUtils-TMZ7AjwL.js";import{r as V}from"./drapedUtils-BIPbWxSw.js";function H(e,t){let{dpi:n,gdbVersion:r,geometry:i,geometryPrecision:a,height:s,historicMoment:c,layerOption:l,mapExtent:u,maxAllowableOffset:d,returnFieldName:f,returnGeometry:p,returnUnformattedValues:m,returnZ:h,spatialReference:g,timeExtent:_,tolerance:v,width:y}=e.toJSON(),{dynamicLayers:b,layerDefs:x,layerIds:S}=U(e),C=t?.geometry==null?null:t.geometry,w={historicMoment:c,geometryPrecision:a,maxAllowableOffset:d,returnFieldName:f,returnGeometry:p,returnUnformattedValues:m,returnZ:h,tolerance:v},T=C?.toJSON()||i;w.imageDisplay=`${y},${s},${n}`,r&&(w.gdbVersion=r),T&&(delete T.spatialReference,w.geometry=JSON.stringify(T),w.geometryType=o(T));let E=g??T?.spatialReference??u?.spatialReference;if(E&&(w.sr=ee(E)),w.time=_?[_.start,_.end].join(`,`):null,u){let{xmin:e,ymin:t,xmax:n,ymax:r}=u;w.mapExtent=`${e},${t},${n},${r}`}return x&&(w.layerDefs=x),b&&!x&&(w.dynamicLayers=b),w.layers=l===`popup`?`visible`:l,S&&!b&&(w.layers+=`:${S.join(`,`)}`),w}function U(e){let{mapExtent:t,floors:n,width:r,sublayers:i,layerIds:a,layerOption:o,gdbVersion:s}=e,c=i?.find(e=>e.layer!=null)?.layer?.serviceSublayers,l=o===`popup`,u={},d=k({extent:t,width:r,spatialReference:t?.spatialReference}),f=[],p=e=>{let t=d===0,n=e.minScale===0||d<=e.minScale,r=e.maxScale===0||d>=e.maxScale;if(e.visible&&(t||n&&r))if(e.sublayers)e.sublayers.forEach(p);else{if(!1===a?.includes(e.id)||l&&(!e.popupTemplate||!e.popupEnabled))return;f.unshift(e)}};if(i?.forEach(p),i&&!f.length)u.layerIds=[];else{let e=z(f,c,s),t=f.map(e=>{let t=B(n,e);return e.toExportImageJSON(t)});if(e)u.dynamicLayers=JSON.stringify(t);else{if(i){let e=f.map(({id:e})=>e);a&&(e=e.filter(e=>a.includes(e))),u.layerIds=e}else a?.length&&(u.layerIds=a);let e=W(n,f);if(e!=null&&e.length){let t={};for(let n of e)n.definitionExpression&&(t[n.id]=n.definitionExpression);Object.keys(t).length&&(u.layerDefs=JSON.stringify(t))}}}return u}function W(e,t){let n=!!e?.length,r=t.filter(e=>e.definitionExpression!=null||n&&e.floorInfo!=null);return r.length?r.map(t=>{let n=B(e,t),r=u(n,t.definitionExpression);return{id:t.id,definitionExpression:r??void 0}}):null}var G,K=G=class extends s{static from(e){return N(G,e)}constructor(e){super(e),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.historicMoment=null,this.layerIds=null,this.layerOption=`top`,this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.timeExtent=null,this.tolerance=null,this.width=400}writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}get sublayers(){return this._get(`sublayers`)??null}set sublayers(e){this._set(`sublayers`,N(D,e))}};C([i({type:Number,json:{write:!0}})],K.prototype,`dpi`,void 0),C([i()],K.prototype,`floors`,void 0),C([i({type:String,json:{write:!0}})],K.prototype,`gdbVersion`,void 0),C([i({types:T,json:{read:F,write:!0}})],K.prototype,`geometry`,void 0),C([i({type:Number,json:{write:!0}})],K.prototype,`geometryPrecision`,void 0),C([i({type:Number,json:{write:!0}})],K.prototype,`height`,void 0),C([i({type:Date})],K.prototype,`historicMoment`,void 0),C([e(`historicMoment`)],K.prototype,`writeHistoricMoment`,null),C([i({type:[Number],json:{write:!0}})],K.prototype,`layerIds`,void 0),C([i({type:[`top`,`visible`,`all`,`popup`],json:{write:!0}})],K.prototype,`layerOption`,void 0),C([i({type:b,json:{write:!0}})],K.prototype,`mapExtent`,void 0),C([i({type:Number,json:{write:!0}})],K.prototype,`maxAllowableOffset`,void 0),C([i({type:Boolean,json:{write:!0}})],K.prototype,`returnFieldName`,void 0),C([i({type:Boolean,json:{write:!0}})],K.prototype,`returnGeometry`,void 0),C([i({type:Boolean,json:{write:!0}})],K.prototype,`returnM`,void 0),C([i({type:Boolean,json:{write:!0}})],K.prototype,`returnUnformattedValues`,void 0),C([i({type:Boolean,json:{write:!0}})],K.prototype,`returnZ`,void 0),C([i({type:I,json:{write:!0}})],K.prototype,`spatialReference`,void 0),C([i()],K.prototype,`sublayers`,null),C([i({type:f,json:{write:!0}})],K.prototype,`timeExtent`,void 0),C([i({type:Number,json:{write:!0}})],K.prototype,`tolerance`,void 0),C([i({type:Number,json:{write:!0}})],K.prototype,`width`,void 0),K=G=C([d(`esri.rest.support.IdentifyParameters`)],K);var q=K,J=class extends s{constructor(e){super(e),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(e,t){return P.fromJSON({attributes:{...t.attributes},geometry:{...t.geometry}})}writeFeature(e,t){if(!e)return;let{attributes:n,geometry:r}=e;n&&(t.attributes={...n}),r!=null&&(t.geometry=r.toJSON(),t.geometryType=te.toJSON(r.type))}};C([i({type:String,json:{write:!0}})],J.prototype,`displayFieldName`,void 0),C([i({type:P})],J.prototype,`feature`,void 0),C([O(`feature`,[`attributes`,`geometry`])],J.prototype,`readFeature`,null),C([e(`feature`)],J.prototype,`writeFeature`,null),C([i({type:Number,json:{write:!0}})],J.prototype,`layerId`,void 0),C([i({type:String,json:{write:!0}})],J.prototype,`layerName`,void 0),J=C([d(`esri.rest.support.IdentifyResult`)],J);var Y=J;async function X(e,t,n){let r=(t=ie(t)).geometry?[t.geometry]:[],i=E(e);return i.path+=`/identify`,x(r).then(e=>{let r=H(t,{geometry:e?.[0]}),a=_({...i.query,f:`json`,...r}),o=w(a,n);return m(i.path,o).then(re).then(e=>ae(e,t.sublayers))})}function re(e){let t=e.data;return t.results=t.results||[],t.exceededTransferLimit=!!t.exceededTransferLimit,t.results=t.results.map(e=>Y.fromJSON(e)),t}function ie(e){return e=q.from(e)}function ae(e,t){if(!t?.length)return e;let n=new Map;function r(e){n.set(e.id,e),e.sublayers&&e.sublayers.forEach(r)}t.forEach(r);for(let t of e.results)t.feature.sourceLayer=n.get(t.layerId);return e}var Z=null;function oe(e,t){return t.type===`tile`||t.type===`map-image`}var Q=class extends v{constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=c(async e=>{this.destroyed||await this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch(()=>{}))})}initialize(){let e=e=>{for(let t of e){let{sourceLayer:e}=t;e!=null&&`geometryType`in e&&e.geometryType===`point`&&t.visible&&(t.visible=!1,this.highlightGraphicUpdated?.({graphic:t,property:`visible`,oldValue:!0,newValue:!1}))}this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch(()=>{})),j(this.updateHighlightedFeatures(this._highlightGeometriesResolution))};this.addHandles([p(()=>this.highlightGraphics,`change`,t=>e(t.added),{onListenerAdd:t=>e(t)})])}async fetchPopupFeaturesAtLocation(e,t){let{layerView:{layer:r,view:{scale:i}}}=this;if(!e)throw new n(`fetchPopupFeatures:invalid-area`,`Nothing to fetch without area`,{layer:r});let a=$(r.sublayers,i,t);if(!a.length)return[];let o=await ce(r,a);if(!((r.capabilities?.operations?.supportsIdentify??!0)&&r.version>=10.5)&&!o)throw new n(`fetchPopupFeatures:not-supported`,`query operation is disabled for this service`,{layer:r});return o?this._fetchPopupFeaturesUsingQueries(e,a,t):this._fetchPopupFeaturesUsingIdentify(e,a,t)}clearHighlights(){this.highlightGraphics?.removeAll()}async _updateHighlightedFeaturesSymbols(e){for(let t of e)this._updateSymbology(t)}_updateSymbology(e){if(e.geometry?.type===`point`)return this._updatePointSymbology(e)}_setGraphicSymbol(e,t){if(!t)return;let n=e.symbol;e.symbol=t,this.highlightGraphicUpdated?.({graphic:e,property:`symbol`,oldValue:n,newValue:t})}_updatePointSymbology(e){let n=e.sourceLayer&&`renderer`in e.sourceLayer&&e.sourceLayer.renderer,{highlightGraphicUpdated:r,highlightGraphics:i,layerView:{view:o}}=this,s=e=>{e.visible||(e.visible=!0,r?.({graphic:e,property:`visible`,oldValue:!1,newValue:!0}))};n&&`getSymbolAsync`in n?n.getSymbolAsync(e).then(async r=>{r||=new a;let c=null,l=`visualVariables`in n?n.visualVariables?.find(e=>e.type===`size`):void 0;l&&(Z||=(await t(async()=>{let{getSize:e}=await import(`./visualVariableUtils-C-nBNHVa.js`);return{getSize:e}},__vite__mapDeps([0,1,2]))).getSize,c=Z(l,e,{view:o.type,scale:o.scale,shape:r.type===`simple-marker`?r.style:null})),c||=`width`in r&&`height`in r&&r.width!=null&&r.height!=null?Math.max(r.width,r.height):`size`in r?r.size:16,i?.includes(e)&&(this._setGraphicSymbol(e,new a({style:`square`,size:c,color:new M([255,255,255,1/255]),xoffset:`xoffset`in r?r.xoffset:0,yoffset:`yoffset`in r?r.yoffset:0})),s(e))}):s(e)}get _updateContext(){let{layerView:{layer:e},highlightGraphics:t,highlightGraphicUpdated:n}=this;return n&&t?.length&&e.capabilities.operations.supportsQuery?{highlightGraphicUpdated:n,highlightGraphics:t}:null}get highlightFeaturesActive(){return!!this._updateContext}async _updateHighlightedFeaturesGeometries(e){this._highlightGeometriesResolution=e;let t=this._updateContext;if(!t)return;let n=this._getTargetResolution(e),r=new Map,{highlightGraphics:i,highlightGraphicUpdated:a}=t;for(let e of i)if(!this._featuresResolutions.has(e)||this._featuresResolutions.get(e)>n){let t=e.sourceLayer;y(r,t,()=>new Map).set(e.getObjectId(),e)}let{layerView:{view:o}}=this,s=Array.from(r,([e,t])=>{let r=e.createQuery();return r.objectIds=[...t.keys()],r.outFields=[e.objectIdField],r.returnGeometry=!0,r.maxAllowableOffset=n,r.outSpatialReference=o.spatialReference,e.queryFeatures(r)}),c=await Promise.all(s);if(!this.destroyed)for(let{features:e}of c)for(let t of e){let e=t.sourceLayer,o=r.get(e).get(t.getObjectId());if(o&&i.includes(o)){let e=o.geometry;o.geometry=t.geometry,a({graphic:o,property:`geometry`,oldValue:e,newValue:o.geometry}),this._featuresResolutions.set(o,n)}}}_getTargetResolution(e){let t=e*r(this.layerView.view.spatialReference),n=t/16;return n<=10?0:e/t*n}async _fetchPopupFeaturesUsingIdentify(e,t,n){let r=await this._createIdentifyParameters(e,t,n);if(r==null)return[];let{results:i}=await X(this.layerView.layer.parsedUrl,r,n);return i.map(e=>e.feature)}async _createIdentifyParameters(e,t,n){let{floors:r,layer:i,timeExtent:a,view:{spatialReference:o,scale:s}}=this.layerView;if(!t.length)return null;await Promise.all(t.map(({sublayer:e})=>e.load(n).catch(()=>{})));let c=Math.min(A(`mapservice-popup-identify-max-tolerance`),i.allSublayers.reduce((e,t)=>t.renderer?V({renderer:t.renderer,pointerType:n?.pointerType}):e,2)),l=this.createFetchPopupFeaturesQueryGeometry(e,c),u=ne(s,o),d=Math.round(l.width/u),f=new b({xmin:l.center.x-u*d,ymin:l.center.y-u*d,xmax:l.center.x+u*d,ymax:l.center.y+u*d,spatialReference:l.spatialReference});return new q({floors:r,gdbVersion:`gdbVersion`in i?i.gdbVersion:void 0,geometry:e,height:d,layerOption:`popup`,mapExtent:f,returnGeometry:!0,spatialReference:o,sublayers:i.sublayers,timeExtent:a,tolerance:c,width:d})}async _fetchPopupFeaturesUsingQueries(e,t,n){let{layerView:{floors:r,timeExtent:i}}=this,a=t.map(async({sublayer:t,popupTemplate:a})=>{if(await t.load(n).catch(()=>{}),t.capabilities&&!t.capabilities.operations.supportsQuery)return[];let o=t.createQuery(),s=V({renderer:t.renderer,pointerType:n?.pointerType}),c=this.createFetchPopupFeaturesQueryGeometry(e,s),l=new Set,[d]=await Promise.all([L(t,a),t.renderer?.collectRequiredFields(l,t.fieldsIndex)]);S(n),h(l,t.fieldsIndex,d);let f=Array.from(l).sort();o.geometry=c,o.outFields=f,o.timeExtent=i;let p=B(r,t);if(o.where=u(o.where,p),t.capabilities?.query.supportsOrderBy&&t.orderBy?.[0]){let e=t.orderBy[0],n=!e.valueExpression&&e.field,r=e.order===`ascending`?`asc`:`desc`;n&&(o.orderByFields=[`${n} ${r}`])}let m=this._getTargetResolution(c.width/s),g=await se(a);S(n);let _=t.geometryType===`point`||g&&g.arcadeUtils.hasGeometryOperations(a);_||(o.maxAllowableOffset=m);let{features:v}=await t.queryFeatures(o,n),y=_?0:m;v=await le(t,v,n);for(let e of v)this._featuresResolutions.set(e,y);return v});return(await Promise.allSettled(a)).reduce((e,t)=>t.status===`fulfilled`?[...e,...t.value]:e,[]).filter(l)}};function $(e,t,n){let r=[];if(!e)return r;let i=e=>{let a=e.minScale===0||t<=e.minScale,o=e.maxScale===0||t>=e.maxScale;if(e.visible&&a&&o){if(e.sublayers)e.sublayers.forEach(i);else if(e.popupEnabled){let t=R(e,{...n,defaultPopupTemplateEnabled:!1});t!=null&&r.unshift({sublayer:e,popupTemplate:t})}}};return e.map(i),r}function se(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some(e=>e.type===`expression`)?g():Promise.resolve()}async function ce(e,t){if(e.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(t.map(({sublayer:e})=>e.load().then(()=>e.capabilities.operations.supportsQuery)))}catch{return!1}}async function le(e,t,n){let r=e.renderer;return r&&`defaultSymbol`in r&&!r.defaultSymbol&&(t=r.valueExpression?await Promise.all(t.map(e=>r.getSymbolAsync(e,n).then(t=>t?e:null))).then(e=>e.filter(e=>e!=null)):t.filter(e=>r.getSymbol(e)!=null)),t}C([i({constructOnly:!0})],Q.prototype,`createFetchPopupFeaturesQueryGeometry`,void 0),C([i({constructOnly:!0})],Q.prototype,`layerView`,void 0),C([i({constructOnly:!0})],Q.prototype,`highlightGraphics`,void 0),C([i({constructOnly:!0})],Q.prototype,`highlightGraphicUpdated`,void 0),C([i({constructOnly:!0})],Q.prototype,`updatingHandles`,void 0),C([i()],Q.prototype,`_updateContext`,null),Q=C([d(`esri.views.layers.support.MapServiceLayerViewHelper`)],Q);export{oe as n,Q as t};