import{Jp as e,Oh as t,pD as n,ra as r,rd as i,wx as a}from"./index-ByaFsVj4.js";var o=4;function s(e){switch(e.type){case`object-id`:case`unique-id-simple`:return`${e.fieldName} ASC`;case`unique-id-composite`:return`${e.fieldNames.join(`,`)} ASC`}}function c(e,n,r){let i=s(r.featureIdInfo);return{returnCentroid:r.serviceGeometryType===`esriGeometryPolygon`&&!e.queryMetadata.supportsCentroidOnDegeneratedQuantizedGeometry&&!e.queryMetadata.supportsDegeneratedQuantizedGeometry,returnGeometry:!0,timeReferenceUnknownClient:r.timeReferenceUnknownClient??void 0,outSpatialReference:a.fromJSON(e.outSpatialReference),orderByFields:e.type===`memory`?[]:[i],where:n.definitionExpression??`1=1`,outFields:n.availableFields,multipatchOption:r.serviceGeometryType===`esriGeometryMultiPatch`?`xyFootprint`:null,gdbVersion:n.gdbVersion,historicMoment:n.historicMoment?new Date(n.historicMoment):null,timeExtent:n.timeExtent?t.fromJSON(n.timeExtent):null}}var l=class t{static create(e,n,r){let i=n.queryScaleRanges,a=n.displayFilterInfo;return new t(c(e,n,r),a,i,r.subtypeField,n.customParameters,r.geometryType,e.queryMetadata)}constructor(e,t,n,r,i,a,o){this._queryParams=e,this._displayFilter=t,this._queryScaleRanges=n,this._subtypeField=r,this._customParameters=i,this._geometryType=a,this._queryMetadata=o}get pageSize(){if(this._queryMetadata==null)throw Error(`InternalError: Service does not support paged queries`);let e=this._queryMetadata.supportsMaxRecordCountFactor?o:null,t=(this._queryMetadata.maxRecordCount??8e3)*(e??1);return Math.min(8e3,t)}get objectIdsQueryPageSize(){return this._queryMetadata?.maxRecordCount??2e3}updateHistoricMoment(e){this._queryParams.historicMoment=e}updateFields(e){this._queryParams.outFields=e}createPatchFieldsQuery(e,t,r){if(!t.getSize())return null;let i=e.clone();if(this._queryParams.outFields[0]===`*`){if((i.outFields??[])[0]===`*`)return null;i.outFields=this._queryParams.outFields}else{let e=new Set(this._queryParams.outFields),n=[];for(let r of e)t.hasField(r)||n.push(r);if(n.length===0)return null;i.outFields=n}i.returnGeometry=!1,i.returnCentroid=!1,i.quantizationParameters=null,i.cacheHint=!0;let a={inner:i,customParameters:this._customParameters};if(n(`esri-tiles-debug`)&&r!=null){let e=r.chunkId.toString().replaceAll(`/`,`.`);a.customParameters=a.customParameters?{...a.customParameters,chunkId:e}:{chunkId:e}}return a}createQuery(e={}){if(!this._queryParams)throw Error(`InternalError: queryInfo should be defined`);return{inner:new i({...this._queryParams,...e}),customParameters:this._customParameters}}createTileQuery(t,i){if(this._queryMetadata==null)throw Error(`InternalError: Service does not support tile queries`);let a=this.createQuery(i),s=a.inner;if(this._queryScaleRanges?.length){let n=this._queryScaleRanges.filter(e=>(!e.minScale||e.minScale>=t.maxScale)&&(!e.maxScale||e.maxScale<=t.minScale)).map(e=>e.subtypeCode);if(n.length){let t=`${this._subtypeField} IN (${n})`;s.where=e(s.where,t)}}if(this._displayFilter&&(s.where=e(s.where,r(this._displayFilter,t.minScale,t.maxScale))),s.quantizationParameters=i.quantizationParameters??t.getQuantizationParameters(),s.resultType=`tile`,s.geometry=t.extent,this._queryMetadata.supportsQuantization?this._geometryType===`esriGeometryPolyline`&&(s.maxAllowableOffset=t.resolution*n(`feature-polyline-generalization-factor`)):this._geometryType!==`esriGeometryPolyline`&&this._geometryType!==`esriGeometryPolygon`||(s.maxAllowableOffset=t.resolution,this._geometryType===`esriGeometryPolyline`&&(s.maxAllowableOffset*=n(`feature-polyline-generalization-factor`))),s.defaultSpatialReferenceEnabled=this._queryMetadata.supportsDefaultSpatialReference,s.compactGeometryEnabled=this._queryMetadata.supportsCompactGeometry,this._queryMetadata.supportsMaxRecordCountFactor&&(s.maxRecordCountFactor=o),n(`esri-tiles-debug`)){let e=t.id.replaceAll(`/`,`.`);a.customParameters=a.customParameters?{...a.customParameters,tileId:e}:{tileId:e}}return a}createPagedTileQuery(e,t){let n=this.pageSize;return this.createTileQuery(e,{start:n*t,num:n,returnExceededLimitFeatures:!0})}createPagedQuery(e,t){let n=this.pageSize;return this.createQuery({start:n*e,num:n,returnExceededLimitFeatures:!0,maxRecordCountFactor:o,quantizationParameters:t,cacheHint:!0})}createObjectIdsQuery(e){return this.createQuery({objectIds:e,outFields:[`*`]})}};function*u(e){switch(e.type){case`object-id`:case`unique-id-simple`:yield e.fieldName;return;case`unique-id-composite`:yield*e.fieldNames;return}}export{l as n,u as t};