import{Hl as e,Ol as t,Rl as n,SD as r,Tw as i,Ul as a,hw as o,kl as s,pl as c,xl as l,yT as u,y_ as d,yl as f,zl as p}from"./index-BN8X5Ryz.js";import{t as m}from"./deduplicate-D-tDe87s.js";import{a as h,s as g}from"./FloatArray-Dt98pDp2.js";import{t as _}from"./TextureBackedBufferLayout-C3PSJOOo.js";import{n as v}from"./Normals-B0YlgMdD.js";var y=h().vec3f(`position`).u16(`componentIndex`,{integer:!0}).freeze(),b=h().vec2u8(`sideness`).freeze(),x=g(b),S=h().vec3f(`position0`).vec3f(`position1`).vec2i16(`normalCompressed`).u16(`componentIndex`,{integer:!0}).u8(`variantOffset`,{glNormalized:!0}).u8(`variantStroke`).u8(`variantExtension`,{glNormalized:!0}).freeze(),C=h().vec3f(`position0`).vec3f(`position1`).vec2i16(`normalCompressed`).vec2i16(`normal2Compressed`).u16(`componentIndex`,{integer:!0}).u8(`variantOffset`,{glNormalized:!0}).u8(`variantStroke`).u8(`variantExtension`,{glNormalized:!0}).freeze(),w=g(S,1),T=g(C,1);x.concat(w),x.concat(T),new _([{name:`color`,type:`vec4unorm8`},{name:`lineWidth`,type:`u8`},{name:`extensionLength`,type:`u8`},{name:`materialType`,type:`u8`},{name:`opacity`,type:`unorm8`},{name:`elevationOffset`,type:`f32`}]);var E=class{constructor(){this.position0=d(),this.position1=d(),this.faceNormal0=d(),this.faceNormal1=d(),this.componentIndex=0,this.cosAngle=0}},D=-1;function O(t,r,i){let a=t.vertices.position,o=t.vertices.componentIndex,s=N.position0,c=N.position1,u=N.faceNormal0,d=N.faceNormal1,{edges:f,normals:m}=ne(t),h=f.length/4,g=r.allocate(h),_=0,v=h,y=i?.allocate(v),b=0,x=0,S=0;A.length=0;for(let e=0;e<h;++e){let t=4*e;a.getVec(f.data[t],s),a.getVec(f.data[t+1],c);let n=A.pushNew();n.index=4*e,n.length=p(s,c)}A.sort((e,t)=>t.length-e.length);let C=[],w=[];A.forAll(({length:t,index:p})=>{let h=f.data[p],v=f.data[p+1],T=f.data[p+2],E=f.data[p+3],O=E===D;if(a.getVec(h,s),a.getVec(v,c),O){let t=3*T;n(u,m.data[t],m.data[t+1],m.data[t+2]),e(d,u),N.componentIndex=o.get(h),N.cosAngle=l(u,d)}else{let t=3*T;if(n(u,m.data[t],m.data[t+1],m.data[t+2]),t=3*E,n(d,m.data[t],m.data[t+1],m.data[t+2]),N.componentIndex=o.get(h),N.cosAngle=l(u,d),k(N,ae))return;N.cosAngle<-.9999&&e(d,u)}x+=t,S++,O||ee(N,B)?(r.write(g,_++,N),C.push(t)):te(N,R)&&(y&&i&&i.write(y,b++,N),w.push(t))});let T=new Float32Array(C.reverse()),E=new Float32Array(w.reverse()),O=y&&i?{instancesData:y.slice(0,b),lodInfo:{lengths:E}}:void 0;return{regular:{instancesData:g.slice(0,_),lodInfo:{lengths:T}},silhouette:O,averageEdgeLength:x/S}}function ee(e,t){return e.cosAngle<t}function k(e,t){return e.cosAngle>t}function te(e,n){let r=o(e.cosAngle);return f(P,e.position1,e.position0),r*(l(t(ie,e.faceNormal0,e.faceNormal1),P)>0?-1:1)>n}function ne(e){let n=e.faces.length/3,r=e.faces,i=e.neighbors,a=e.vertices.position;j.length=M.length=0;for(let e=0;e<n;e++){let n=3*e,o=i[n],l=i[n+1],u=i[n+2],d=r[n],f=r[n+1],p=r[n+2];a.getVec(d,F),a.getVec(f,I),a.getVec(p,L),s(I,I,F),s(L,L,F),t(F,I,L),c(F,F),M.pushArray(F),(o===D||d<f)&&(j.push(d),j.push(f),j.push(e),j.push(o)),(l===D||f<p)&&(j.push(f),j.push(p),j.push(e),j.push(l)),(u===D||p<d)&&(j.push(p),j.push(d),j.push(e),j.push(u))}return{edges:j,normals:M}}var re=class{constructor(){this.index=0,this.length=0}},A=new u({allocator:e=>e||new re,deallocator:null}),j=new u({deallocator:null}),M=new u({deallocator:null}),N=new E,ie=d(),P=d(),F=d(),I=d(),L=d(),R=i(4),ae=Math.cos(R),z=i(35),B=Math.cos(z);function V(e,t,n){let r=t/3,i=new Uint32Array(n+1),a=new Uint32Array(n+1),o=(e,t)=>{e<t?i[e+1]++:a[t+1]++};for(let t=0;t<r;t++){let n=e[3*t],r=e[3*t+1],i=e[3*t+2];o(n,r),o(r,i),o(i,n)}let s=0,c=0;for(let e=0;e<n;e++){let t=i[e+1],n=a[e+1];i[e+1]=s,a[e+1]=c,s+=t,c+=n}let l=new Uint32Array(6*r),u=i[n],d=(e,t,n)=>{if(e<t){let r=i[e+1]++;l[2*r]=t,l[2*r+1]=n}else{let r=a[t+1]++;l[2*u+2*r]=e,l[2*u+2*r+1]=n}};for(let t=0;t<r;t++){let n=e[3*t],r=e[3*t+1],i=e[3*t+2];d(n,r,t),d(r,i,t),d(i,n,t)}let f=(e,t)=>{let n=2*e,r=t-e;for(let e=1;e<r;e++){let t=l[n+2*e],r=l[n+2*e+1],i=e-1;for(;i>=0&&l[n+2*i]>t;i--)l[n+2*i+2]=l[n+2*i],l[n+2*i+3]=l[n+2*i+1];l[n+2*i+2]=t,l[n+2*i+3]=r}};for(let e=0;e<n;e++)f(i[e],i[e+1]),f(u+a[e],u+a[e+1]);let p=new Int32Array(3*r),m=(t,n)=>t===e[3*n]?0:t===e[3*n+1]?1:t===e[3*n+2]?2:-1,h=(e,t)=>{let n=m(e,t);p[3*t+n]=-1},g=(e,t,n,r)=>{let i=m(e,t);p[3*t+i]=r;let a=m(n,r);p[3*r+a]=t};for(let e=0;e<n;e++){let t=i[e],n=i[e+1],r=a[e],o=a[e+1];for(;t<n&&r<o;){let n=l[2*t],i=l[2*u+2*r];n===i?(g(e,l[2*t+1],i,l[2*u+2*r+1]),t++,r++):n<i?(h(e,l[2*t+1]),t++):(h(i,l[2*u+2*r+1]),r++)}for(;t<n;)h(e,l[2*t+1]),t++;for(;r<o;)h(l[2*u+2*r],l[2*u+2*r+1]),r++}return p}var H=.7,U=class{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?se:oe}write(e,t,n){X.seed=this._edgeHashFunction(n);let r=X.getIntRange(0,255),i=X.getIntRange(0,this.settings.variants-1),a=X.getFloat(),o=255*(.5*ce(-(1-Math.min(a/H,1))+Math.max(0,a-H)/(1-H),1.2)+.5);e.position0.setVec(t,n.position0),e.position1.setVec(t,n.position1),e.componentIndex.set(t,n.componentIndex),e.variantOffset.set(t,r),e.variantStroke.set(t,i),e.variantExtension.set(t,o)}},W=new Float32Array(6),G=new Uint32Array(W.buffer),K=new Uint32Array(1);function oe(e){return W[0]=e.position0[0],W[1]=e.position0[1],W[2]=e.position0[2],W[3]=e.position1[0],W[4]=e.position1[1],W[5]=e.position1[2],K[0]=31*(31*(31*(31*(31*(166811+G[0])+G[1])+G[2])+G[3])+G[4])+G[5],K[0]}function se(e){let t=W;t[0]=J(e.position0[0]),t[1]=J(e.position0[1]),t[2]=J(e.position0[2]),t[3]=J(e.position1[0]),t[4]=J(e.position1[1]),t[5]=J(e.position1[2]),K[0]=5381;for(let e=0;e<G.length;e++)K[0]=31*K[0]+G[e];return K[0]}var q=1e4;function J(e){return Math.round(e*q)/q}function ce(e,t){return Math.abs(e)**t*Math.sign(e)}var le=class{constructor(){this._commonWriter=new U}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return S.createBuffer(e)}write(e,t,n){this._commonWriter.write(e,t,n),a(Y,n.faceNormal0,n.faceNormal1),c(Y,Y);let{typedBuffer:r,typedBufferStride:i}=e.normalCompressed;v(r,t,Y[0],Y[1],Y[2],i)}},ue=class{constructor(){this._commonWriter=new U}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return C.createBuffer(e)}write(e,t,n){this._commonWriter.write(e,t,n);{let{typedBuffer:r,typedBufferStride:i}=e.normalCompressed;v(r,t,n.faceNormal0[0],n.faceNormal0[1],n.faceNormal0[2],i)}{let{typedBuffer:r,typedBufferStride:i}=e.normal2Compressed;v(r,t,n.faceNormal1[0],n.faceNormal1[1],n.faceNormal1[2],i)}}},Y=d(),X=new r;function de(e){let t=Z(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return Q.updateSettings(e.writerSettings),$.updateSettings(e.writerSettings),O(t,Q,$)}function Z(e,t,n,r){if(t){let t=V(n,r,e.count);return new fe(n,r,t,e)}let i=m(e.buffer,e.stride/4,{originalIndices:n}),a=V(i.indices,r,i.uniqueCount);return{faces:i.indices,facesLength:i.indices.length,neighbors:a,vertices:y.createView(i.buffer)}}var fe=class{constructor(e,t,n,r){this.faces=e,this.facesLength=t,this.neighbors=n,this.vertices=r}},Q=new le,$=new ue,pe=h().vec3f(`position0`).vec3f(`position1`),me=h().vec3f(`position0`).vec3f(`position1`).u16(`componentIndex`,{integer:!0});export{O as a,pe as i,de as n,y as o,Z as r,me as t};