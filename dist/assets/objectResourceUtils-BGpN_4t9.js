const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/loader-Dj338NG7.js","assets/loader-DeUs1yRB.js","assets/index-BN8X5Ryz.js","assets/index-CWJhHB6-.css","assets/quatf64-D37SEdPg.js","assets/quat-C8PgLo31.js","assets/BufferView-BW77W5ev.js","assets/Util-BQgFCZvD.js","assets/resourceUtils-BhD6CfOV.js"])))=>i.map(i=>d[i]);
import{$S as e,$T as t,CE as n,Jf as r,Jy as i,Ka as a,Mf as o,Pl as s,Ry as c,Um as l,Vl as u,Vu as d,ZS as f,Zy as p,_h as m,_l as h,gh as g,hl as _,kl as v,nu as y,pl as b,pw as x,qy as S,ru as C,sT as w,w_ as T,y_ as E,yg as D,zf as O,zy as k}from"./index-BN8X5Ryz.js";import{c as A}from"./memoryEstimations-D_IbKyOk.js";import{a as j}from"./Indices-tJiSUK6w.js";import{F as ee,H as te,c as ne,l as M,u as N,x as P}from"./BufferView-BW77W5ev.js";import{a as F,n as I,o as re,s as ie}from"./vec3-B5yu4INg.js";import{i as ae,n as L}from"./vec4-BLZ_ZPtE.js";import{i as R}from"./resourceUtils-BhD6CfOV.js";import{i as oe,n as se,t as z}from"./indexUtils-BSuZn8vT.js";import{i as B}from"./orientedBoundingBox-Bd4igSGQ.js";import{t as V}from"./devEnvironmentUtils-Yxtjm7qW.js";import{t as H}from"./image-CmtRVQsT.js";import{k as U}from"./DefaultBufferWriter-BGKzMKkp.js";import{r as W}from"./FloatArray-Dt98pDp2.js";import{t as G}from"./NestedMap-BpsBVffk.js";import{t as K}from"./ManagedTexture-DgNSfAYU.js";import{n as q}from"./DefaultMaterial-BVbzHMdq.js";import{c as ce,d as le,l as ue,u as de}from"./SnowCover.glsl-DvDl-UAS.js";function J(e){if(e==null)return null;let t=e.offset==null?y:e.offset,n=e.rotation==null?0:e.rotation,r=e.scale==null?C:e.scale,i=k(1,0,0,0,1,0,t[0],t[1],1),a=k(Math.cos(n),-Math.sin(n),0,Math.sin(n),Math.cos(n),0,0,0,1),o=k(r[0],0,0,0,r[1],0,0,0,1),s=c();return S(s,a,o),S(s,i,s),s}var fe=class{constructor(){this.geometries=[],this.materials=[],this.textures=[]}},pe=class{constructor(e,t,n){this.name=e,this.lodThreshold=t,this.pivotOffset=n,this.stageResources=new fe,this.numberOfVertices=0}},Y=()=>n.getLogger(`esri.views.3d.layers.graphics.objectResourceUtils`),me=class{constructor(e,t,n){this.resource=e,this.textures=t,this.usedMemory=n}};async function he(e,t){let n=await ge(e,t),r=await xe(n.textureDefinitions??{},t),i=0;for(let e in r)if(r.hasOwnProperty(e)){let t=r[e];i+=t?.image?t.image.width*t.image.height*4:0}return new me(n,r,i+A(n))}async function ge(e,t){let n=await D(f(e,t));if(n.ok)return n.value.data;w(n.error),_e(n.error)}function _e(e){throw new t(``,`Request for object resource failed: ${e}`)}function ve(e){let t=e.params,n=t.topology,r=!0;switch(t.vertexAttributes||(Y().warn(`Geometry must specify vertex attributes`),r=!1),t.topology){case`PerAttributeArray`:break;case`Indexed`:case null:case void 0:{let e=t.faces;if(e){if(t.vertexAttributes)for(let n in t.vertexAttributes){let t=e[n];t?.values?(t.valueType!=null&&t.valueType!==`UInt32`&&(Y().warn(`Unsupported indexed geometry indices type '${t.valueType}', only UInt32 is currently supported`),r=!1),t.valuesPerElement!=null&&t.valuesPerElement!==1&&(Y().warn(`Unsupported indexed geometry values per element '${t.valuesPerElement}', only 1 is currently supported`),r=!1)):(Y().warn(`Indexed geometry does not specify face indices for '${n}' attribute`),r=!1)}}else Y().warn(`Indexed geometries must specify faces`),r=!1;break}default:Y().warn(`Unsupported topology '${n}'`),r=!1}e.params.material||(Y().warn(`Geometry requires material`),r=!1);let i=e.params.vertexAttributes;for(let e in i)i[e].values||(Y().warn(`Geometries with externally defined attributes are not yet supported`),r=!1);return r}function ye(e,t){let n=[],r=[],i=[],o=new G,s=e.resource,c=a.parse(s.version||`1.0`,`wosr`);Z.validate(c);let l=s.model.name,u=s.model.geometries,d=s.materialDefinitions??{},f=e.textures,p=0,m=new Map;for(let e=0;e<u.length;e++){let a=u[e];if(!ve(a))continue;let s=Se(a),c=a.params.vertexAttributes,l=[],h=e=>{if(a.params.topology===`PerAttributeArray`)return null;let t=a.params.faces;for(let n in t)if(n===e)return t[n].values;return null},g=c.position,_=g.values.length/g.valuesPerElement;for(let e in c){let t=c[e],n=t.values,r=h(e)??j(_);l.push([e,new B(n,r,t.valuesPerElement,!0)])}let v=s.texture,y=f&&f[v];if(y&&!m.has(v)){let{image:e,parameters:t}=y,n=new K(e,t);r.push(n),m.set(v,n)}let b=m.get(v),x=b?b.id:void 0,S=s.material,C=o.get(S,v);if(C==null){let e=d[S.slice(S.lastIndexOf(`/`)+1)].params;e.transparency===1&&(e.transparency=0);let n=y?X(y.alphaChannelUsage):void 0,r={ambient:T(e.diffuse),diffuse:T(e.diffuse),opacity:1-(e.transparency||0),textureAlphaMode:n,textureAlphaCutoff:.33,textureId:x,doubleSided:!0,cullFace:0,colorMixMode:e.externalColorMixMode||`tint`,textureAlphaPremultiplied:y?.parameters.preMultiplyAlpha??!1};t?.materialParameters&&Object.assign(r,t.materialParameters),C=new q(r,t),o.set(S,v,C)}i.push(C);let w=new U(C,l);p+=l.find(e=>e[0]===`position`)?.[1]?.indices.length??0,n.push(w)}return{engineResources:[{name:l,stageResources:{textures:r,materials:i,geometries:n},pivotOffset:s.model.pivotOffset,numberOfVertices:p,lodThreshold:null}],referenceBoundingBox:be(n)}}function be(e){let t=O();return e.forEach(e=>{let n=e.boundingInfo;n!=null&&(o(t,n.bbMin),o(t,n.bbMax))}),t}async function xe(e,t){let n=[];for(let r in e){let i=e[r],a=i.images[0].data;if(!a){Y().warn(`Externally referenced texture data is not yet supported`);continue}let o=i.encoding+`;base64,`+a,s=`/textureDefinitions/`+r,c=i.channels===`rgba`?i.alphaChannelUsage||`transparency`:`none`,l={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:X(c)!==1},u=t?.disableTextures?Promise.resolve(null):H(o,t);n.push(u.then(e=>({refId:s,image:e,parameters:l,alphaChannelUsage:c})))}let r=await Promise.all(n),i={};for(let e of r)i[e.refId]=e;return i}function X(e){switch(e){case`mask`:return 2;case`maskAndTransparency`:return 3;case`none`:return 1;default:return 0}}function Se(e){let t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}var Z=new a(1,2,`wosr`);async function Ce(t,n){let r=Q(V(t));if(r.fileType===`wosr`){let e=await(n.cache?n.cache.loadWOSR(r.url,n):he(r.url,n)),{engineResources:t,referenceBoundingBox:i}=ye(e,n);return{lods:t,referenceBoundingBox:i,isEsriSymbolResource:!1,isWosr:!0}}let i;if(n.cache)i=await n.cache.loadGLTF(r.url,n,!!n.usePBR,!!n.useEmissive);else{let{loadGLTF:t}=await e(async()=>{let{loadGLTF:e}=await import(`./loader-Dj338NG7.js`);return{loadGLTF:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));i=await t(new se,r.url,n,n.usePBR,n.useEmissive)}let{engineResources:a,referenceBoundingBox:o}=we(i,n,r.specifiedLodIndex);return{lods:a,referenceBoundingBox:o,isEsriSymbolResource:i.meta.isEsriSymbolResource,isWosr:!1}}function Q(e){let t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:`gltf`,url:t[1],specifiedLodIndex:t[4]==null?null:Number(t[4])}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:`wosr`,url:e,specifiedLodIndex:null}:{fileType:`unknown`,url:e,specifiedLodIndex:null}}function we(e,t,n){let r=e.model,i=e.meta,a=r.meta?.ESRI_proxyEllipsoid,s=i.isEsriSymbolResource&&a!=null&&i.ESRI_webstyle===`EsriRealisticTreesStyle`;s&&!e.customMeta.esriTreeRendering&&(e.customMeta.esriTreeRendering=!0,Oe(e,a));let c=!!t.usePBR,l=i.isEsriSymbolResource?{usePBR:c,isSchematic:!1,treeRendering:s,mrrFactors:ce}:{usePBR:c,isSchematic:!1,treeRendering:!1,mrrFactors:de},u={...t.materialParameters,treeRendering:s},d=[],f=new Map,p=new Map,m=r.lods.length,h=O();return r.lods.forEach((e,i)=>{let a=!0===t.skipHighLods&&(m>1&&i===0||m>3&&i===1)||!1===t.skipHighLods&&n!=null&&i!==n;if(a&&i!==0)return;let c=new pe(e.name,e.lodThreshold,[0,0,0]);e.parts.forEach(e=>{let n=a?new q({},t):Te(r,e,c,l,u,f,p,t,s),{geometry:d,vertexCount:m}=Ee(e,n??new q({},t)),g=d.boundingInfo;g!=null&&i===0&&(o(h,g.bbMin),o(h,g.bbMax)),n!=null&&(c.stageResources.geometries.push(d),c.numberOfVertices+=m)}),a||d.push(c)}),{engineResources:d,referenceBoundingBox:h}}function Te(e,t,n,r,i,a,o,s,c){let l=e.materials.get(t.material);if(l==null)return null;let{normal:u,color:f,texCoord0:p,tangent:h}=t.attributes,g=t.material+(u?`_normal`:``)+(f?`_color`:``)+(p?`_texCoord0`:``)+(h?`_tangent`:``),_=t.attributes.texCoord0!=null,v=t.attributes.normal!=null,y=De(l.alphaMode);if(!a.has(g)){if(_){let t=(t,n=!1,r=!1)=>{if(t!=null&&!o.has(t)){let i=e.textures.get(t);if(i){let e=i.data,a=n&&!R(e)?s.compressionOptions:void 0;o.set(t,new K(R(e)?e.data:e,{...i.parameters,preMultiplyAlpha:!R(e)&&r,encoding:R(e)?e.encoding:void 0,compressionOptions:a}))}}},n=y!==1&&!c;t(l.colorTexture,n,y!==1),t(l.normalTexture),t(l.occlusionTexture,!0),t(l.emissiveTexture),t(l.metallicRoughnessTexture,!0)}let n=m(l.color[0]),u=m(l.color[1]),f=m(l.color[2]),p=l.colorTexture!=null&&_?o.get(l.colorTexture):null,h=ue(l),b=l.normalTextureTransform?.scale==null?d:l.normalTextureTransform?.scale;a.set(g,new q({...r,customDepthTest:1,textureAlphaMode:y,textureAlphaCutoff:l.alphaCutoff,diffuse:[n,u,f],ambient:[n,u,f],opacity:l.alphaMode===`OPAQUE`?1:l.opacity,doubleSided:l.doubleSided,doubleSidedType:`winding-order`,cullFace:l.doubleSided?0:2,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:v?0:2,castShadows:!0,receiveShadows:l.receiveShadows,receiveAmbientOcclusion:l.receiveAmbientOcclusion,textureId:p?.id,colorMixMode:l.colorMixMode,normalTextureId:l.normalTexture!=null&&_?o.get(l.normalTexture).id:void 0,textureAlphaPremultiplied:p!=null&&!!p.parameters.preMultiplyAlpha,occlusionTextureId:l.occlusionTexture!=null&&_?o.get(l.occlusionTexture).id:void 0,emissiveTextureId:l.emissiveTexture!=null&&_?o.get(l.emissiveTexture).id:void 0,metallicRoughnessTextureId:l.metallicRoughnessTexture!=null&&_?o.get(l.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[l.emissiveFactor[0],l.emissiveFactor[1],l.emissiveFactor[2]],emissiveStrengthKHR:l.emissiveStrengthKHR==null?1:l.emissiveStrengthKHR,emissiveStrengthFromSymbol:i.emissiveStrengthFromSymbol==null?void 0:i.emissiveStrengthFromSymbol,mrrFactors:h?le:[l.metallicFactor,l.roughnessFactor,r.mrrFactors[2]],isSchematic:h,colorTextureTransformMatrix:J(l.colorTextureTransform),normalTextureTransformMatrix:J(l.normalTextureTransform),scale:[b[0],b[1]],occlusionTextureTransformMatrix:J(l.occlusionTextureTransform),emissiveTextureTransformMatrix:J(l.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:J(l.metallicRoughnessTextureTransform),...i},s))}let b=a.get(g);if(n.stageResources.materials.push(b),_){let e=e=>{e!=null&&n.stageResources.textures.push(o.get(e))};e(l.colorTexture),e(l.normalTexture),e(l.occlusionTexture),e(l.emissiveTexture),e(l.metallicRoughnessTexture)}return b}function Ee(e,t){let n=e.attributes.position.count,r=z(e.indices||n,e.primitiveType),a=W(3*n),{typedBuffer:o,typedBufferStride:s}=e.attributes.position;ie(a,o,e.transform,3,s);let c=[[`position`,new B(a,r,3,!0)]];if(e.attributes.normal!=null){let t=W(3*n),{typedBuffer:a,typedBufferStride:o}=e.attributes.normal;i($,e.transform),re(t,a,$,3,o),x($)&&I(t,t),c.push([`normal`,new B(t,r,3,!0)])}if(e.attributes.tangent!=null){let t=W(4*n),{typedBuffer:i,typedBufferStride:a}=e.attributes.tangent;p($,e.transform),ae(t,i,$,4,a),x($)&&I(t,t,4),c.push([`tangent`,new B(t,r,4,!0)])}if(e.attributes.texCoord0!=null){let t=W(2*n),{typedBuffer:i,typedBufferStride:a}=e.attributes.texCoord0;oe(t,i,2,a),c.push([`uv0`,new B(t,r,2,!0)])}let l=e.attributes.color;if(l!=null){let t=new Uint8Array(4*n);l.elementCount===4?l instanceof N?L(t,l,1,255):(l instanceof te||l instanceof M)&&L(t,l,1/255,255):(t.fill(255),l instanceof P?F(t,l.typedBuffer,1,255,4,l.typedBufferStride):(e.attributes.color instanceof ee||e.attributes.color instanceof ne)&&F(t,l.typedBuffer,1/255,255,4,e.attributes.color.typedBufferStride)),c.push([`color`,new B(t,r,4,!0)])}return{geometry:new U(t,c),vertexCount:n}}var $=c();function De(e){switch(e){case`BLEND`:return 0;case`MASK`:return 2;case`OPAQUE`:case null:case void 0:return 1}}function Oe(e,t){for(let n=0;n<e.model.lods.length;++n){let i=e.model.lods[n];for(let a of i.parts){let i=a.attributes.normal;if(i==null)return;let o=a.attributes.position,c=o.count,d=E(),f=E(),p=E(),m=new Float32Array(4*c),y=new Float32Array(3*c),x=l(r(),a.transform),S=0,C=0;for(let r=0;r<c;r++){o.getVec(r,f),i.getVec(r,d),_(f,f,a.transform),v(p,f,t.center),s(p,p,t.radius);let c=p[2],l=u(p),w=Math.min(.45+.55*l*l,1)**g;s(p,p,t.radius),x!==null&&_(p,p,x),b(p,p),n+1!==e.model.lods.length&&e.model.lods.length>1&&h(p,p,d,c>-1?.2:Math.min(-4*c-3.8,1)),y[S]=p[0],y[S+1]=p[1],y[S+2]=p[2],S+=3,m[C]=w,m[C+1]=w,m[C+2]=w,m[C+3]=1,C+=4}a.attributes.normal=new P(y.buffer),a.attributes.color=new N(m.buffer)}}}export{Ce as n,J as r,Q as t};