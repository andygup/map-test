import{BT as e,Ey as t,Iy as n,Q as r,ZC as i,aE as a,ew as o,oh as s,rh as c,u_ as l,zy as u}from"./index-ByaFsVj4.js";import"./quatf64-eO7UAs9K.js";import"./quat-sUyQdiZR.js";import"./meshCloneUtils-5rtyOBgA.js";import{i as d,r as f,t as p}from"./MeshMaterialMetallicRoughness-Bn-u5_DP.js";import"./meshProperties-DwrhStLW.js";import{t as m}from"./MeshComponent-BFAosfis.js";import"./MeshLocalVertexSpace-UBa2rGXG.js";import{t as h}from"./MeshVertexAttributes-Fw_NZ99L.js";import{r as g}from"./meshVertexSpaceUtils-D9WJf86L.js";import"./Indices-CZ754tYW.js";import"./projectPointToVector-DjmX75N6.js";import"./computeTranslationToOriginAndRotation-CI8CU_D7.js";import{F as _,H as v,c as y,l as b,n as ee,u as x,x as S,z as C}from"./BufferView-DuUrcLgU.js";import"./Util-uF9mYnOn.js";import{c as w,i as T,l as E,r as D}from"./vec3-BwuFja2y.js";import{a as O,r as k,t as A}from"./vec4-CB8mMORr.js";import{n as te}from"./vertexSpaceConversion-h_-BmbPw.js";import"./spatialReferenceEllipsoidUtils-nVny0a-O.js";import{i as j}from"./resourceUtils-Bd0Z16xi.js";import{t as M}from"./types-DsLx34Br.js";import{t as N}from"./loader-BDLoLzvd.js";import{a as P,n as F,r as I,t as L}from"./indexUtils-D4cu1LR7.js";function R(e,t,n){let r=e.typedBuffer,i=e.typedBufferStride,a=t.typedBuffer,o=t.typedBufferStride,s=n?n.count:t.count,c=(n?.dstIndex??0)*i,l=(n?.srcIndex??0)*o;for(let e=0;e<s;++e){for(let e=0;e<9;++e)r[c+e]=a[l+e];c+=i,l+=o}}Object.freeze(Object.defineProperty({__proto__:null,copy:R},Symbol.toStringTag,{value:`Module`}));function z(e,t,n){let r=e.typedBuffer,i=e.typedBufferStride,a=t.typedBuffer,o=t.typedBufferStride,s=n?n.count:t.count,c=(n?.dstIndex??0)*i,l=(n?.srcIndex??0)*o;for(let e=0;e<s;++e){for(let e=0;e<16;++e)r[c+e]=a[l+e];c+=i,l+=o}}Object.freeze(Object.defineProperty({__proto__:null,copy:z},Symbol.toStringTag,{value:`Module`}));function B(e,t){V(e.typedBuffer,t.typedBuffer,e.typedBufferStride,t.typedBufferStride)}function V(e,t,n=3,r=n){let i=t.length/r,a=0,o=0;for(let s=0;s<i;++s)e[a]=t[o],e[a+1]=t[o+1],e[a+2]=t[o+2],a+=n,o+=r}function H(e,t,n,r,i){let a=e.typedBuffer,o=e.typedBufferStride,s=i?.count??e.count,c=(i?.dstIndex??0)*o;for(let e=0;e<s;++e)a[c]=t,a[c+1]=n,a[c+2]=r,c+=o}Object.freeze(Object.defineProperty({__proto__:null,copy:V,copyView:B,fill:H},Symbol.toStringTag,{value:`Module`}));function U(e,t){W(e.typedBuffer,t,e.typedBufferStride)}function W(e,t,n=4){let r=t.typedBuffer,i=t.typedBufferStride,a=t.count,o=0,s=0;for(let t=0;t<a;++t)e[o]=r[s],e[o+1]=r[s+1],e[o+2]=r[s+2],e[o+3]=r[s+3],o+=n,s+=i}function G(e,t,n,r,i,a){let o=e.typedBuffer,s=e.typedBufferStride,c=a?.count??e.count,l=(a?.dstIndex??0)*s;for(let e=0;e<c;++e)o[l]=t,o[l+1]=n,o[l+2]=r,o[l+3]=i,l+=s}Object.freeze(Object.defineProperty({__proto__:null,copy:W,copyView:U,fill:G},Symbol.toStringTag,{value:`Module`}));function K(e,t){return new e(new ArrayBuffer(t*e.ElementCount*M(e.ElementType)))}async function q(t,n,r){let i=new F(r?.resolveFile),a=await N(i,n,r),o=a.model,s=o.lods.shift(),c=new Map,l=new Map;o.textures.forEach((e,t)=>c.set(t,Z(e))),o.materials.forEach((e,t)=>l.set(t,ne(e,c)));let u=X(s);for(let e of u.parts)re(u,e,l);let{position:d,normal:f,tangent:p,color:m,texCoord0:_}=u.vertexAttributes,v=g(t,r),y=t.spatialReference.isGeographic?g(t):v,b=te({vertexAttributes:{position:d.typedBuffer,normal:f?.typedBuffer,tangent:p?.typedBuffer},vertexSpace:y,spatialReference:t.spatialReference},v,{allowBufferReuse:!0,sourceUnit:r?.unitConversionDisabled?void 0:`meters`});if(!b)throw new e(`load-gltf-mesh:vertex-space-projection`,`Failed to load mesh from glTF because we could not convert the vertex space from ${y.type} to ${v.type}`);return{mesh:{transform:null,vertexSpace:v,components:u.components,spatialReference:t.spatialReference,vertexAttributes:new h({...b,color:m?.typedBuffer,uv:_?.typedBuffer})},meta:a.meta}}function J(e,t){if(e==null)return`-`;let n=e.typedBuffer;return`${a(t,n.buffer,()=>t.size)}/${n.byteOffset}/${n.byteLength}`}function Y(e){return e==null?`-`:e.toString()}function X(e){let t=0,n={color:!1,tangent:!1,normal:!1,texCoord0:!1},r=new Map,i=new Map,o=[];for(let s of e.parts){let{position:e,normal:c,color:l,tangent:u,texCoord0:d}=s.attributes,f=`\n      ${J(e,r)}/\n      ${J(c,r)}/\n      ${J(l,r)}/\n      ${J(u,r)}/\n      ${J(d,r)}/\n      ${Y(s.transform)}\n    `,p=!1,m=a(i,f,()=>(p=!0,{start:t,length:e.count}));p&&(t+=e.count),c&&(n.normal=!0),l&&(n.color=!0),u&&(n.tangent=!0),d&&(n.texCoord0=!0),o.push({gltf:s,writeVertices:p,region:m})}return{vertexAttributes:{position:K(C,t),normal:n.normal?K(S,t):null,tangent:n.tangent?K(x,t):null,color:n.color?K(v,t):null,texCoord0:n.texCoord0?K(ee,t):null},parts:o,components:[]}}function Z(e){return new d({data:(j(e.data),e.data),wrap:oe(e.parameters.wrap)})}function ne(e,t){let n=new c(se(e.color,e.opacity)),r=e.emissiveFactor?new c(ce(e.emissiveFactor)):null,a=e=>e?new f({scale:e.scale?[e.scale[0],e.scale[1]]:[1,1],rotation:i(e.rotation??0),offset:e.offset?[e.offset[0],e.offset[1]]:[0,0]}):null;return new p({color:n,colorTexture:t.get(e.colorTexture),normalTexture:t.get(e.normalTexture),emissiveColor:r,emissiveStrength:e.emissiveStrengthKHR,emissiveTexture:t.get(e.emissiveTexture),occlusionTexture:t.get(e.occlusionTexture),alphaMode:ae(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:t.get(e.metallicRoughnessTexture),colorTextureTransform:a(e.colorTextureTransform),normalTextureTransform:a(e.normalTextureTransform),occlusionTextureTransform:a(e.occlusionTextureTransform),emissiveTextureTransform:a(e.emissiveTextureTransform),metallicRoughnessTextureTransform:a(e.metallicRoughnessTextureTransform)})}function re(e,t,n){t.writeVertices&&ie(e,t);let{indices:r,attributes:i,primitiveType:a,material:o}=t.gltf,s=L(r||i.position.count,a),c=t.region.start;if(c){let e=new Uint32Array(s);for(let t=0;t<s.length;t++)e[t]+=c;s=e}e.components.push(new m({name:t.gltf.name,faces:s,material:n.get(o),shading:i.normal?`source`:`flat`,trustSourceNormals:!0}))}function ie(e,r){let{position:i,normal:a,tangent:s,color:c,texCoord0:l}=e.vertexAttributes,d=r.region.start,{attributes:f,transform:p}=r.gltf,m=f.position.count;if(D(i.slice(d,m),f.position,p),f.normal!=null&&a!=null){let e=n(t(),p),r=a.slice(d,m);T(r,f.normal,e),o(e)&&w(r,r)}else a!=null&&H(a,0,0,1,{dstIndex:d,count:m});if(f.tangent!=null&&s!=null){let e=u(t(),p),n=s.slice(d,m);k(n,f.tangent,e),o(e)&&O(n,n)}else s!=null&&G(s,0,0,1,1,{dstIndex:d,count:m});if(f.texCoord0!=null&&l!=null?P(l.slice(d,m),f.texCoord0):l!=null&&I(l,0,0,{dstIndex:d,count:m}),f.color!=null&&c!=null){let e=f.color,t=c.slice(d,m);if(e.elementCount===4)e instanceof x?A(t,e,1,255):(e instanceof v||e instanceof b)&&A(t,e,1/255,255);else{G(t,255,255,255,255);let n=_.fromTypedArray(t.typedBuffer,t.typedBufferStride);e instanceof S?E(n,e,1,255):(e instanceof _||e instanceof y)&&E(n,e,1/255,255)}}else c!=null&&G(c.slice(d,m),255,255,255,255)}function ae(e){switch(e){case`OPAQUE`:return`opaque`;case`MASK`:return`mask`;case`BLEND`:return`blend`}}function oe(e){return{horizontal:Q(e.s),vertical:Q(e.t)}}function Q(e){switch(e){case 33071:return`clamp`;case 33648:return`mirror`;case 10497:return`repeat`}}function $(e){return e**(1/s)*255}function se(e,t){return r($(e[0]),$(e[1]),$(e[2]),t)}function ce(e){return l($(e[0]),$(e[1]),$(e[2]))}export{q as loadGLTFMesh};