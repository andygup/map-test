import{BT as e,Fh as t,Ih as n,Jw as r,RS as i,aC as a,qS as o}from"./index-ByaFsVj4.js";async function s(t,n){let r=o(t);if(!r)throw new e(`invalid-url`,`Invalid scene service url`);let i={...n,sceneServerUrl:r.url.path,layerId:r.sublayer??void 0};if(i.sceneLayerItem??=await c(i),i.sceneLayerItem==null)return d(i.sceneServerUrl.replace(`/SceneServer`,`/FeatureServer`),i);let a=await f(i);if(!a?.url)throw new e(`related-service-not-found`,`Could not find feature service through portal item relationship`);i.featureServiceItem=a;let s=await d(a.url,i);return s.portalItem=a,s}async function c(e){let i=(await l(e)).serviceItemId;if(!i)return null;let a=new t({id:i,apiKey:e.apiKey}),o=await u(e);o!=null&&(a.portal=new n({url:o}));try{return await a.load({signal:e.signal})}catch(e){return r(e),null}}async function l(e){if(e.rootDocument)return e.rootDocument;let t={query:{f:`json`,...e.customParameters,token:e.apiKey},responseType:`json`,signal:e.signal};try{e.rootDocument=(await i(e.sceneServerUrl,t)).data}catch{e.rootDocument={}}return e.rootDocument}async function u(e){let t=a?.findServerInfo(e.sceneServerUrl);if(t?.owningSystemUrl)return t.owningSystemUrl;let n=e.sceneServerUrl.replace(/(.*\/rest)\/.*/i,`$1`)+`/info`;try{let t=(await i(n,{query:{f:`json`},responseType:`json`,signal:e.signal})).data.owningSystemUrl;if(t)return t}catch(e){r(e)}return null}async function d(t,n){let r=o(t);if(!r)throw new e(`invalid-feature-service-url`,`Invalid feature service url`);let a=r.url.path,s=n.layerId;if(s==null)return{serverUrl:a};let c=l(n),u=n.featureServiceItem?await n.featureServiceItem.fetchData(`json`):null,d=(u?.layers?.[0]||u?.tables?.[0])?.customParameters,f=e=>{let t={query:{f:`json`,...d},responseType:`json`,authMode:e,signal:n.signal};return i(a,t)},p=f(`anonymous`).catch(()=>f(`no-prompt`)),[m,h]=await Promise.all([p,c]),g=h?.layers,_=m.data&&m.data.layers;if(!Array.isArray(_))throw Error(`expected layers array`);if(Array.isArray(g)){for(let e=0;e<Math.min(g.length,_.length);e++)if(g[e].id===s)return{serverUrl:a,layerId:_[e].id}}else if(s!=null&&s<_.length)return{serverUrl:a,layerId:_[s].id};throw Error(`could not find matching associated sublayer`)}async function f({sceneLayerItem:e,signal:n}){if(!e)return null;try{let r=(await e.fetchRelatedItems({relationshipType:`Service2Service`,direction:`reverse`},{signal:n})).find(e=>e.type===`Feature Service`)||null;if(!r)return null;let i=new t({portal:r.portal,id:r.id});return await i.load(),i}catch(e){return r(e),null}}export{s as t};