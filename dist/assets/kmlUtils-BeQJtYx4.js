import{AE as e,Af as t,FE as n,H as r,Lx as i,SC as a,ZS as o,cp as s,ha as c,hf as l,mf as u,py as d,vC as f,yf as p}from"./index-BN8X5Ryz.js";var m={esriGeometryPoint:`points`,esriGeometryPolyline:`polylines`,esriGeometryPolygon:`polygons`};function h(e){let t=e.folders||[],r=t.slice(),i=new Map,a=new Map,o=new Map,s=new Map,c=new Map,l={esriGeometryPoint:a,esriGeometryPolyline:o,esriGeometryPolygon:s};(e.featureCollection?.layers||[]).forEach(e=>{let t=n(e);t.featureSet.features=[];let r=e.featureSet.geometryType;i.set(r,t);let c=e.layerDefinition.objectIdField;r===`esriGeometryPoint`?v(a,c,e.featureSet.features):r===`esriGeometryPolyline`?v(o,c,e.featureSet.features):r===`esriGeometryPolygon`&&v(s,c,e.featureSet.features)}),e.groundOverlays&&e.groundOverlays.forEach(e=>{c.set(e.id,e)}),t.forEach(t=>{t.networkLinkIds.forEach(n=>{let i=b(n,t.id,e.networkLinks);i&&r.push(i)})}),r.forEach(e=>{if(e.featureInfos){e.points=n(i.get(`esriGeometryPoint`)),e.polylines=n(i.get(`esriGeometryPolyline`)),e.polygons=n(i.get(`esriGeometryPolygon`)),e.mapImages=[];for(let t of e.featureInfos)switch(t.type){case`esriGeometryPoint`:case`esriGeometryPolyline`:case`esriGeometryPolygon`:{let n=l[t.type].get(t.id);n&&e[m[t.type]]?.featureSet.features.push(n);break}case`GroundOverlay`:{let n=c.get(t.id);n&&e.mapImages.push(n);break}}e.fullExtent=S([e])}});let u=S(r);return{folders:t,sublayers:r,extent:u}}function g(t,n,r,i){let s=f?.findCredential(t);t=a(t,{token:s?.token});let c=e.kmlServiceUrl;return o(c,{query:{url:t,model:`simple`,folders:``,refresh:r!==0||void 0,outSR:JSON.stringify(n)},responseType:`json`,signal:i})}function _(e,t,n=null,r=[]){let i=[],a={},o=t.sublayers,s=new Set(t.folders.map(e=>e.id));return o.forEach(t=>{let o=new e;if(n?o.read(t,n):o.read(t),r.length&&s.has(o.id)&&(o.visible=r.includes(o.id)),a[t.id]=o,t.parentFolderId!=null&&t.parentFolderId!==-1){let e=a[t.parentFolderId];e.sublayers||=[],e.sublayers?.unshift(o)}else i.unshift(o)}),i}function v(e,t,n){n.forEach(n=>{e.set(n.attributes[t],n)})}function y(e,t){let n;return t.some(t=>t.id===e&&(n=t,!0)),n}function b(e,t,n){let r=y(e,n);return r&&(r.parentFolderId=t,r.networkLink=r),r}async function x(e,t,n,i){let a=e[t];if(!a)return[];let o=c.fromJSON(a.featureSet).features,l=a.layerDefinition,u=r(l.drawingInfo.renderer),d=s.fromJSON(a.popupInfo),f=[];for(let e of o)e.symbol=await u.getSymbolAsync(e),e.popupTemplate=d,e.visible=!0,e.origin=n.sublayerById.get(i).origin,f.push(e);return f}function S(e){let n=t(p),r=t(p);for(let t of e){if(t.polygons?.featureSet?.features)for(let e of t.polygons.featureSet.features)d(n,e.geometry),l(r,n);if(t.polylines?.featureSet?.features)for(let e of t.polylines.featureSet.features)d(n,e.geometry),l(r,n);if(t.points?.featureSet?.features)for(let e of t.points.featureSet.features)d(n,e.geometry),l(r,n);if(t.mapImages)for(let e of t.mapImages)d(n,e.extent),l(r,n)}return u(r,p)?void 0:{xmin:r[0],ymin:r[1],zmin:r[2],xmax:r[3],ymax:r[4],zmax:r[5],spatialReference:i.WGS84}}export{g as a,h as i,_ as n,x as r,S as t};