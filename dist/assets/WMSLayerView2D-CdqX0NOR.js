import{$T as e,BT as t,CE as n,VT as r,jT as i,kD as a,oT as o,pT as s,pv as c,vx as l}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import"./earcut-CEMcWA4Z.js";import"./layerViewUtils-CJcMVuwG.js";import"./tagSymbols-67pK6deD.js";import"./VertexAttributeLocations-BScEla0R.js";import"./VertexElementDescriptor-Cl_nC_ty.js";import{t as u}from"./ExportWMSImageParameters-CAxQbJg0.js";import"./BoundingBox-Dtf81F-g.js";import"./config-Dk3C6lVr.js";import"./WGLContainer-jm6ZclzQ.js";import"./utils-B0heZPZY.js";import"./ProgramTemplate-B9k_04Md.js";import"./VertexArrayObject-ChtD6bwg.js";import"./BufferObject-B3_aJU6V.js";import"./VertexBuffer-Ra4pb4dR.js";import"./vec3f32-DDMWoxUL.js";import"./Container-uEjPEzbR.js";import"./GraphShaderModule-AgkKIWM0.js";import"./FramebufferObject-BoYk_2uK.js";import"./ShaderBuilder-BLOqjpgt.js";import"./bitmapUtils-53gkfkJ0.js";import"./Bitmap-BoQaGe8r.js";import{t as d}from"./BitmapContainer-C6h9gf6w.js";import{t as f}from"./LayerView2D-Bgb1zyoa.js";import{t as p}from"./ExportStrategy-DZKCAuVC.js";import{t as m}from"./LayerView-DQaVI2FN.js";import{t as h}from"./RefreshableLayerView-DdPullJP.js";import{t as g}from"./timeSupport-HhBEqX5E.js";var _=n=>{let o=n,c=class extends o{initialize(){this.exportImageParameters=new u({layer:this.layer})}destroy(){this.exportImageParameters=i(this.exportImageParameters)}get exportImageVersion(){return this.exportImageParameters?.commitProperty(`version`),this.commitProperty(`timeExtent`),(this._get(`exportImageVersion`)||0)+1}get timeExtent(){return g(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}async fetchPopupFeaturesAtLocation(t,n){let{layer:r}=this;if(!t)throw new e(`wmslayerview:fetchPopupFeatures`,`Nothing to fetch without area`,{layer:r});let{popupEnabled:i}=r;if(!i)throw new e(`wmslayerview:fetchPopupFeatures`,`popupEnabled should be true`,{popupEnabled:i});let a=this.createFetchPopupFeaturesQuery(t);if(!a)return[];let{extent:o,width:c,height:l,x:u,y:d}=a;if(!(o&&c&&l))throw new e(`wmslayerview:fetchPopupFeatures`,`WMSLayer does not support fetching features.`,{extent:o,width:c,height:l});let f=await r.fetchFeatureInfo(o,c,l,u,d);return s(n),f}};return a([t()],c.prototype,`exportImageParameters`,void 0),a([t({readOnly:!0})],c.prototype,`exportImageVersion`,null),a([t()],c.prototype,`layer`,void 0),a([t({readOnly:!0})],c.prototype,`timeExtent`,null),c=a([r(`esri.views.layers.WMSLayerView`)],c),c},v=class extends _(h(f(m))){constructor(){super(...arguments),this.bitmapContainer=new d}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}update(e){this.strategy.update(e).catch(e=>{o(e)||n.getLogger(this).error(e)})}attach(){let{layer:e}=this,{imageMaxHeight:t,imageMaxWidth:n}=e;this.bitmapContainer=new d,this.container.addChild(this.bitmapContainer),this.strategy=new p({container:this.bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:t,imageMaxWidth:n,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.addAttachHandles(c(()=>this.exportImageVersion,()=>this.requestUpdate()))}detach(){this.strategy=i(this.strategy),this.container.removeAllChildren()}viewChange(){}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQuery(e){let{view:t,bitmapContainer:n}=this,{x:r,y:i}=e,{spatialReference:a}=t,o,s=0,c=0;if(n.children.some(e=>{let{width:t,height:n,resolution:u,x:d,y:f}=e,p=d+u*t,m=f-u*n;return r>=d&&r<=p&&i<=f&&i>=m&&(o=new l({xmin:d,ymin:m,xmax:p,ymax:f,spatialReference:a}),s=t,c=n,!0)}),!o)return null;let u=o.width/s,d=Math.round((r-o.xmin)/u),f=Math.round((o.ymax-i)/u);return{extent:o,width:s,height:c,x:d,y:f}}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,t,n,r){return this.layer.fetchImageBitmap(e,t,n,{timeExtent:this.timeExtent,...r})}};a([t()],v.prototype,`strategy`,void 0),v=a([r(`esri.views.2d.layers.WMSLayerView2D`)],v);var y=v;export{y as default};