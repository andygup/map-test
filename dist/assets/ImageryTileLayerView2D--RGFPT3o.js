import{$c as e,Ay as t,BT as n,By as r,DT as i,Es as a,Fy as o,Hw as s,Hy as c,Ju as l,OT as u,Ps as d,Py as f,Rc as p,Ts as m,Uo as h,Vl as g,WT as ee,Xc as _,Xl as v,Yl as te,Z_ as ne,Zc as re,_w as ie,aw as ae,ax as oe,ev as se,gD as y,gT as b,gs as ce,is as le,js as ue,jy as de,ks as x,mT as fe,nv as pe,ou as me,pD as he,pg as ge,pw as _e,px as ve,qw as ye,tx as be,uE as xe,uw as Se,vD as S,vd as Ce,vs as we,ws as Te,yg as Ee}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./OptimizedFeatureSet-CTIqq8fn.js";import"./featureConversionUtils-_DSSMFQ2.js";import"./earcut-BF1-mB58.js";import"./layerViewUtils-RSw-QNoB.js";import{t as De}from"./popupUtils-Bb88Y0DD.js";import"./tagSymbols-CazaFvX8.js";import{i as Oe}from"./multidimensionalUtils-DD5iyU0q.js";import{s as ke,t as Ae}from"./PixelBlock-HBARrhko.js";import{k as je,t as Me}from"./vectorFieldUtils-DMJyxx0j.js";import{c as Ne,n as Pe,r as Fe}from"./rasterFieldUtils-CTwnxR3_.js";import{r as Ie}from"./datasetUtils-CRhdcyUt.js";import"./dataUtils-BTiGb5TR.js";import{i as Le,n as Re,s as ze,t as Be}from"./RawBlockCache-DTTCvtu0.js";import{d as Ve,h as He,i as Ue,m as We,t as Ge}from"./rasterProjectionHelper-w_U-UD-j.js";import{t as Ke}from"./clipUtils-DaPwa6ud.js";import"./VertexAttributeLocations-CfzeuYMz.js";import"./VertexElementDescriptor-ju-1bdWe.js";import"./BoundingBox-CLkiiRfJ.js";import"./config-BSvujflG.js";import{s as qe}from"./WGLContainer-D_aBMsnu.js";import"./utils-DS5dbHj4.js";import"./ProgramTemplate-BXau1qoF.js";import"./VertexArrayObject-DEfjd5y-.js";import"./BufferObject-q8zuTMny.js";import"./VertexBuffer-xVpphTb4.js";import"./vec3f32-B2H3-fiA.js";import{r as Je}from"./Container-BuEih3Ua.js";import{$ as Ye,A as Xe,At as Ze,B as Qe,C as $e,Ct as et,D as C,Dt as w,E as tt,Et as nt,Ft as T,G as E,H as D,I as O,It as k,J as A,K as rt,L as it,Lt as at,M as j,Mt as M,N as ot,Nt as st,O as ct,Ot as lt,P as ut,Q as N,R as dt,S as ft,St as pt,T as mt,Tt as P,U as ht,V as gt,W as _t,X as vt,Y as yt,Z as bt,_ as F,a as xt,b as St,bt as Ct,c as I,dt as L,g as wt,gt as Tt,h as R,i as z,it as B,j as Et,jt as V,kt as Dt,l as Ot,lt as kt,m as At,n as jt,nt as Mt,o as H,ot as Nt,pt as Pt,q as U,r as Ft,rt as It,s as W,t as Lt,tt as Rt,u as G,ut as zt,v as Bt,w as Vt,wt as Ht,x as Ut,xt as Wt,yt as K,z as q}from"./GraphShaderModule-D5RCsL2_.js";import{t as Gt}from"./FramebufferObject-BhBPSr-C.js";import"./ShaderBuilder-D3cV1oap.js";import{t as Kt}from"./bitmapUtils-SuGDUZFe.js";import{t as qt}from"./LayerView2D-BsKgTWnO.js";import{t as Jt}from"./LayerView-2jeNRFkG.js";import{t as Yt}from"./RefreshableLayerView-CXmtIjA5.js";import{t as Xt}from"./timeSupport-CpSaGF8C.js";import{t as Zt}from"./TileContainer-B6yQthEI.js";import{s as Qt}from"./constants-BuH6TGxi.js";import{a as $t,c as en,l as tn}from"./utils-Czjlo_U1.js";import{t as nn}from"./highlightOptionsUtils-C8mtOR7S.js";import"./loadUtils-CFFeTrby.js";import{n as rn,r as an,t as on}from"./RasterVFDisplayObject-BV3YuQew.js";import{n as sn}from"./highlightUtils-Drb4dN_6.js";import{i as cn,n as ln,r as un,t as dn}from"./rasterUtils-CXmXN_V9.js";import{t as fn}from"./utils-CyTmGCxv.js";var pn={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:`none`,type:`stretch`},mn=class extends Je{constructor(e=null,t=null,n=null){super(),this._textureInvalidated=!0,this._colormapTextureInvalidated=!0,this._rasterTexture=null,this._maskTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,this._colormapTexture=null,this._colormap=null,this._supportsBilinearTexture=!0,this._processedTexture=null,this._highlightTexture=null,this.functionTextures=[],this.projected=!1,this.stencilRef=0,this.coordScale=[1,1],this._processed=!1,this._highlighted=!1,this._symbolizerParameters=null,this.height=null,this.isRendereredSource=!1,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this._mask=null,this.rawPixelData=null,this._suspended=!1,this._bandIds=null,this._interpolation=null,this._transformGrid=null,this.width=null,this.x=0,this.y=0,this.source=e,this.transformGrid=t,this.interpolation=n}destroy(){super.destroy(),this._disposeTextures()}get processedTexture(){return this._processedTexture}set processedTexture(e){this._processedTexture!==e&&(this._disposeTextures(!0),this._processedTexture=e)}get highlightTexture(){return this._highlightTexture}set highlightTexture(e){this._highlightTexture!==e&&(this._highlightTexture?.dispose(),this._highlightTexture=e),e??(this._highlighted=!1)}get rasterTexture(){return this._rasterTexture}set rasterTexture(e){this._rasterTexture!==e&&(this._rasterTexture?.dispose(),this._rasterTexture=e),e??(this.projected=!1)}get processed(){return this._processed}set processed(e){this._processed=e,e||(this.processedTexture=b(this.processedTexture),this.invalidateTexture())}get highlighted(){return this._highlighted}get symbolizerParameters(){return this._symbolizerParameters||pn}set symbolizerParameters(e){this._symbolizerParameters!==e&&(this._symbolizerParameters=e,this._colormapTextureInvalidated=!0)}get source(){return this._source}set source(e){this._source!==e&&(this._source=e,this._rasterTexture&&(this._rasterTexture=b(this._rasterTexture),this._rasterTextureBandIds=null),this.projected=!1,this.invalidateTexture())}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._maskTexture=b(this._maskTexture))}get suspended(){return this._suspended}set suspended(e){this._suspended&&!e&&this.stage&&(this.ready(),this.requestRender()),this._suspended=e}get bandIds(){return this._bandIds}set bandIds(e){this._bandIds=e,this._isBandIdsChanged(e)&&(this.projected=!1,this.invalidateTexture())}get interpolation(){return this._interpolation||`nearest`}set interpolation(e){this._interpolation=e,this._rasterTexture&&this._rasterTexture.setSamplingMode(this._getTextureSamplingMethod(e||`nearest`)===`bilinear`?9729:9728)}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid!==e&&(this._transformGrid=e,this._transformGridTexture=b(this._transformGridTexture))}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())}getRasterTextureSize(e=!1){let t=e||this.projected;return[t?this.width:this.source?.width||this.width,t?this.height:this.source?.height||this.height]}getRasterCellSize(){let e=this.rawPixelData?.srcPixelSize,{projected:t,resolution:n}=this;return e&&!t?[e.x,e.y]:[n,n]}_createTransforms(){return{displayViewScreenMat3:v()}}setTransform(e){let n=r(this.transforms.displayViewScreenMat3),[i,a]=e.toScreenNoRotation([0,0],[this.x,this.y]),s=this.resolution/this.pixelRatio/e.resolution,c=s*this.width,l=s*this.height,u=Math.PI*this.rotation/180;t(n,n,te(i,a)),t(n,n,te(c/2,l/2)),f(n,n,-u),t(n,n,te(-c/2,-l/2)),de(n,n,te(c,l)),o(this.transforms.displayViewScreenMat3,e.displayViewMat3,n)}getTextures({forProcessing:e=!1,useProcessedTexture:t=!1}={}){let n=t?this._processedTexture??this._rasterTexture:this._rasterTexture,r=[],i=[];return n?(this._transformGridTexture&&!this.projected&&(i.push(this._transformGridTexture),r.push(`u_transformGrid`)),i.push(n),r.push(`u_image`),!this._colormapTexture||!t&&e||(i.push(this._colormapTexture),r.push(`u_colormap`)),this._maskTexture&&(i.push(this._maskTexture),r.push(`u_mask`)),{names:r,textures:i}):{names:r,textures:i}}onAttach(){this.invalidateTexture()}onDetach(){this.invalidateTexture()}updateTexture({context:e}){if(!this.stage)return void this._disposeTextures();let t=this._isValidSource(this.source);t&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(e)),this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(e),this._rasterTexture&&(t?(this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=dn(e,this.transformGrid)),this._mask&&!this._maskTexture&&(this._maskTexture=un(e,this._mask,[this.width,this.height]))):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()))}updateProcessedTexture(e=!0){e&&(this._highlighted=this.highlightTexture!=null);let{functionTextures:t}=this;t.length!==0&&(this.processedTexture=t.shift(),t.forEach(e=>e?.dispose()),t.length=0,this.processed=!!this.processedTexture)}_createOrDestroyRasterTexture(e){let t=this.source?.extractBands(this.bandIds);if(!this._isValidSource(t))return void(this._rasterTexture&&(this._rasterTexture=b(this._rasterTexture),this._rasterTextureBandIds=null));let n=!this._isBandIdsChanged(this.bandIds);if(this._rasterTexture){if(n)return;this._rasterTexture=b(this._rasterTexture),this._rasterTextureBandIds=null}this._supportsBilinearTexture=!!e.capabilities.textureFloatLinear;let r=this._getTextureSamplingMethod(this.interpolation),i=this.isRendereredSource;this._rasterTexture=cn(e,t,r,i),this.projected=!1,this._processed=!1,this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}_isBandIdsChanged(e){let t=this._rasterTextureBandIds;return!(t==null&&e==null||t&&e&&t.join(``)===e.join(``))}_isValidSource(e){return e!=null&&e.pixels?.length>0}_getTextureSamplingMethod(e){let{type:t}=this.symbolizerParameters,n=t===`lut`&&!this.symbolizerParameters.isClassBreaks||t===`hillshade`||t===`stretch`&&this.symbolizerParameters.bandCount===1;return!this._supportsBilinearTexture||n||e!==`bilinear`&&e!==`cubic`?`nearest`:`bilinear`}_updateColormapTexture(e){let t=this._colormap,n=this.symbolizerParameters.colormap;n?t?(n.length!==t.length||n.some((e,n)=>e!==t[n]))&&(this._colormapTexture&&=b(this._colormapTexture),this._colormapTexture=ln(e,n),this._colormap=n):(this._colormapTexture=ln(e,n),this._colormap=n):(this._colormapTexture&&=b(this._colormapTexture),this._colormap=null)}_disposeTextures(e=!1){e?this.projected&&(this._transformGridTexture=b(this._transformGridTexture)):(this._rasterTexture=b(this._rasterTexture),this._colormapTexture=b(this._colormapTexture),this._transformGridTexture=b(this._transformGridTexture),this._maskTexture=b(this._maskTexture),this._rasterTextureBandIds=null,this._colormap=null,this._colormapTextureInvalidated=!0),this._processedTexture=b(this._processedTexture),this._highlightTexture=b(this._highlightTexture)}},hn=class extends qe{constructor(e,t,n,r,i,a,o=null){super(e,t,n,r,i,a),this.bitmap=null,this.bitmap=new mn(o,null,null),this.bitmap.coordScale=[i,a],this.bitmap.once(`isReady`,()=>this.ready())}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(e){this.bitmap.stencilRef=e}get stencilRef(){return this.bitmap.stencilRef}setTransform(e){super.setTransform(e),this.bitmap.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}_createTransforms(){return{displayViewScreenMat3:v(),tileMat3:v()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}},gn=class extends Lt{};y([xt(0,q)],gn.prototype,`position`,void 0);var _n=class extends jt{},vn=class extends G{};y([I(j)],vn.prototype,`inputTexture`,void 0),y([I(j)],vn.prototype,`sumTexture`,void 0),y([I(j)],vn.prototype,`numOfNoDataTexture`,void 0),y([I(F)],vn.prototype,`numTexels`,void 0);var yn=class extends Ft{constructor(){super(...arguments),this.type=`TextureStatisticsDiffShader`}vertex(e){let t=e.position;return{uv:t,glPosition:new U(tn(t),0,1)}}fragment(e){let{inputTexture:t,numOfNoDataTexture:n,sumTexture:r}=this.config,i=new Ot,a=M(t,e.uv),o=K(r,new E(0,0),new O(0)),s=K(n,new E(0,0),new O(0)).r,c=this.config.numTexels.subtract(s),l=o.divide(c),u=L(a.a,new F(0)),d=new F(1).subtract(u).multiply(a.subtract(l));return i.fragColor=d.multiply(d),i}};y([I(vn)],yn.prototype,`config`,void 0),y([S(0,W(gn))],yn.prototype,`vertex`,null),y([S(0,W(_n))],yn.prototype,`fragment`,null);var bn=class extends Lt{};y([xt(0,q)],bn.prototype,`position`,void 0);var xn=class extends jt{},Sn=class extends G{};y([I(j)],Sn.prototype,`minTexture`,void 0),y([I(j)],Sn.prototype,`maxTexture`,void 0),y([I(j)],Sn.prototype,`sumTexture`,void 0),y([I(j)],Sn.prototype,`numOfNoDataTexture`,void 0),y([I(O)],Sn.prototype,`width`,void 0),y([I(O)],Sn.prototype,`height`,void 0),y([I(O)],Sn.prototype,`isFirstPass`,void 0);var Cn=class extends Ft{constructor(){super(...arguments),this.type=`TextureStatisticsMinMaxSumShader`}vertex(e){let t=e.position;return{uv:t,glPosition:new U(tn(t),0,1)}}fragment(e){let t=new Ot,{minTexture:n,maxTexture:r,sumTexture:i,numOfNoDataTexture:a}=this.config,o=e.glFragCoord.xy,s=new E(o.multiply(2)),c=new O(0),l=K(n,s,c),u=K(n,s.add(new E(-1,0)),c),d=K(n,s.add(new E(0,-1)),c),f=K(n,s.add(new E(-1,-1)),c),p=wn(wn(l,wn(u,new U(Qt))),wn(d,wn(f,new U(Qt)))),m=K(r,s,c),h=K(r,s.add(new E(-1,0)),c),g=K(r,s.add(new E(0,-1)),c),ee=K(r,s.add(new E(-1,-1)),c),_=Tn(Tn(m,Tn(h,new U(-Qt))),Tn(g,Tn(ee,new U(-Qt)))),v=K(i,s,c),te=K(i,s.add(new E(-1,0)),c),ne=K(i,s.add(new E(0,-1)),c),re=K(i,s.add(new E(-1,-1)),c),ie=en(En(v),En(te),En(ne),En(re)),ae=K(a,s,c),oe=K(a,s.add(new E(-1,0)),c),se=K(a,s.add(new E(0,-1)),c),y=K(a,s.add(new E(-1,-1)),c),b=new F(this.config.isFirstPass),ce=en(Dn(ae,b),Dn(oe,b),Dn(se,b),Dn(y,b));return t.fragData0=p,t.fragData1=_,t.fragData2=ie,t.fragData3=ce,t}};function wn(e,t){let n=L(e.a,new F(0));return ht(e,t).multiply(new F(1).subtract(n)).add(t.multiply(n))}function Tn(e,t){let n=L(e.a,new F(0));return Qe(e,t).multiply(new F(1).subtract(n)).add(t.multiply(n))}function En(e){let t=L(e.a,new F(0)),n=new F(1).subtract(t);return e.multiply(n)}function Dn(e,t){let n=L(e.a,new F(0)),r=new F(1).subtract(t);return t.multiply(n).multiply(new U(1)).add(r.multiply(e))}y([I(Sn)],Cn.prototype,`config`,void 0),y([S(0,W(bn))],Cn.prototype,`vertex`,null),y([S(0,W(xn))],Cn.prototype,`fragment`,null);var On=class extends Lt{};y([xt(0,q)],On.prototype,`position`,void 0);var kn=class extends jt{},An=class extends G{};y([I(j)],An.prototype,`minTexture`,void 0),y([I(j)],An.prototype,`maxTexture`,void 0),y([I(j)],An.prototype,`sumTexture`,void 0),y([I(j)],An.prototype,`numOfNoDataTexture`,void 0),y([I(j)],An.prototype,`diffSqTexture`,void 0),y([I(F)],An.prototype,`numTexels`,void 0);var jn=class extends Ft{constructor(){super(...arguments),this.type=`TextureStatisticsStdDevShader`}vertex(e){let t=e.position;return{uv:t,glPosition:new U(tn(t),0,1)}}fragment(e){let t=new Ot,{minTexture:n,maxTexture:r,numOfNoDataTexture:i,sumTexture:a,diffSqTexture:o}=this.config,s=e.glFragCoord.xy,c=new E(s),l=new O(0),u=K(n,c,l),d=K(r,c,l),f=K(a,c,l),p=K(i,c,l).r,m=K(o,c,l),h=this.config.numTexels.subtract(p),g=f.divide(h),ee=m.divide(h),_=B(ee);return t.fragData0=u,t.fragData1=d,t.fragData2=g,t.fragData3=_,t}};y([I(An)],jn.prototype,`config`,void 0),y([S(0,W(On))],jn.prototype,`vertex`,null),y([S(0,W(kn))],jn.prototype,`fragment`,null);var Mn=class extends Lt{};y([xt(0,q)],Mn.prototype,`position`,void 0);var Nn=class extends jt{},Pn=class extends G{};y([I(j)],Pn.prototype,`sumTexture`,void 0),y([I(O)],Pn.prototype,`width`,void 0),y([I(O)],Pn.prototype,`height`,void 0);var Fn=class extends Ft{constructor(){super(...arguments),this.type=`TextureStatisticsSumOfSquaredDiffShader`}vertex(e){let t=e.position;return{uv:t,glPosition:new U(tn(t),0,1)}}fragment(e){let t=new Ot,{sumTexture:n}=this.config,r=e.glFragCoord.xy,i=new E(r.multiply(2)),a=new O(0),o=K(n,i,a),s=K(n,i.add(new E(-1,0)),a),c=K(n,i.add(new E(0,-1)),a),l=K(n,i.add(new E(-1,-1)),a);return t.fragData0=en(o,s,c,l),t.fragData1=new U(0),t.fragData2=new U(0),t.fragData3=new U(0),t}};y([I(Pn)],Fn.prototype,`config`,void 0),y([S(0,W(Mn))],Fn.prototype,`vertex`,null),y([S(0,W(Nn))],Fn.prototype,`fragment`,null);var In=1048576,Ln=class extends at{constructor(){super(...arguments),this.type=32,this._width=0,this._height=0,this._framebuffers=null,this._minTexture=null,this._maxTexture=null,this._sumTexture=null,this._numOfNoDataTexture=null,this._resultsFramebuffer=null,this._startFramebuffer=null,this._diffFramebuffer=null,this._scaleFbo=null,this.shaders={textureStatisticsMinMaxSum:new Cn,textureStatisticsSum:new Fn,textureStatisticsDiff:new yn,textureStatisticsStdDev:new jn}}dispose(){this.shaders.textureStatisticsMinMaxSum=null,this._framebuffers&&=(this._framebuffers.forEach(e=>b(e)),null),b(this._resultsFramebuffer),b(this._startFramebuffer),b(this._diffFramebuffer),b(this._scaleFbo),b(this._minTexture),b(this._maxTexture),b(this._sumTexture),b(this._numOfNoDataTexture)}get minValuesTexture(){return this._minTexture||null}get maxValuesTexture(){return this._maxTexture||null}get meanValuesTexture(){return this._resultsFramebuffer?.getColorTexture(36066)||null}get stdDevValuesTexture(){return this._resultsFramebuffer?.getColorTexture(36067)||null}get statsFbo(){return this._resultsFramebuffer}render(e,t){let{context:n,painter:r}=e,i=t.fbo.width,o=t.fbo.height,s=t.fbo,c=n.gl,l=n.getBoundFramebufferObject();if(i*o>In||!_e(i)||!_e(o)){let e=i/o;if(i*o>In){let t=Math.max(Math.floor(Math.sqrt(In/e)),1);i=Math.max(Math.floor(e*t),1),o=t}if(_e(i)||(i=Vn(i)),_e(o)||(o=Vn(o)),this._scaleFbo)this._scaleFbo.resize(i,o);else{let{dataType:e,internalFormat:r}=t.fbo.getColorTexture(m).descriptor,s=r??a.RGBA8;this._scaleFbo=zn(n,i,o,e,s)}n.bindFramebuffer(this._scaleFbo),n.setViewport(0,0,i,o),r.blitTexture(n,s.getColorTexture(m),9728),s=this._scaleFbo}this._updateResources(e,s),r.setPipelineState({...fn,color:{write:[!0,!0,!0,!0],blendMode:`none`}});let u=this._applyReductionPass(e);c.readBuffer(c.COLOR_ATTACHMENT3),u.copyToTexture(0,0,1,1,0,0,this._numOfNoDataTexture),c.readBuffer(c.COLOR_ATTACHMENT2),u.copyToTexture(0,0,1,1,0,0,this._sumTexture),c.readBuffer(c.COLOR_ATTACHMENT1),u.copyToTexture(0,0,1,1,0,0,this._maxTexture),c.readBuffer(c.COLOR_ATTACHMENT0),u.copyToTexture(0,0,1,1,0,0,this._minTexture);let d=t.fbo.getColorTexture(m);if(!d)throw Error(`Start buffer color texture is not available, cannot compute diff.`);this._computeDiff(e,d,this._sumTexture,this._numOfNoDataTexture,i,o);let f=this._applySecondReductionPass(e,i,o).getColorTexture(m);this._computeSdtDev(e,this._minTexture,this._maxTexture,this._sumTexture,this._numOfNoDataTexture,f,i,o),n.bindFramebuffer(l),n.setViewport(0,0,t.fbo.width,t.fbo.height),n.setDrawBuffers([m]),r.setPipelineState(fn)}_applyReductionPass(e){let{context:t,painter:n}=e,r=this.shaders.textureStatisticsMinMaxSum,i=this._framebuffers;if(i===null)throw Error(`Framebuffers are not initialized, cannot apply reduction pass.`);t.setDrawBuffers([m,Te,d]);let a=this._startFramebuffer,o=a.getColorTexture(m),s=a.getColorTexture(Te),c=a.getColorTexture(d),l=a.getColorTexture(ue),u=i,f=0;for(let e of u){t.setViewport(0,0,e.width,e.height),t.bindFramebuffer(e),t.setClearColor(0,0,0,0),t.clear(16384);let i={shader:r,uniforms:{config:{minTexture:{texture:o,unit:1},maxTexture:{texture:s,unit:2},sumTexture:{texture:c,unit:3},numOfNoDataTexture:{texture:l,unit:4},width:e.width,height:e.height,isFirstPass:f===0?1:0}},defines:null,optionalAttributes:null,useComputeBuffer:!1};n.submitDrawMesh(t,i,n.quadMesh),o=e.getColorTexture(m),s=e.getColorTexture(Te),c=e.getColorTexture(d),l=e.getColorTexture(ue),f++}return i.at(-1)}_applySecondReductionPass(e,t,n){let{context:r,painter:i}=e,a=this.shaders.textureStatisticsSum,o=this._framebuffers;if(o===null||this._diffFramebuffer==null)throw Error(`Framebuffers are not initialized, cannot apply reduction pass.`);r.setDrawBuffers([m]);let s=this._diffFramebuffer.getColorTexture(m),c=o;for(let e of c){r.setViewport(0,0,e.width,e.height),r.bindFramebuffer(e),r.setClearColor(0,0,0,0),r.clear(16384);let t={shader:a,uniforms:{config:{sumTexture:{texture:s,unit:2},width:e.width,height:e.height}},defines:null,optionalAttributes:null,useComputeBuffer:!1};i.submitDrawMesh(r,t,i.quadMesh),s=e.getColorTexture(m)}return o.at(-1)}_updateResources(e,t){let{context:n}=e,r=t.width,i=t.height;if(this._startFramebuffer===null){if(!h().supportsColorBufferFloat)throw Error(`WebGL does not support color buffer float, cannot compute texture statistics.`);let e=t.getColorTexture(m);if(!e)throw Error(`Input FBO does not have a color attachment 0, cannot compute texture statistics.`);let o=e.descriptor,{dataType:s,internalFormat:c}=o,l=zn(n,r,i,s,c??a.RGBA8,4),u=l.getColorTexture(m),f=l.getColorTexture(Te),p=l.getColorTexture(d),g=l.getColorTexture(ue);t.copyToTexture(0,0,r,i,0,0,u),t.copyToTexture(0,0,r,i,0,0,f),t.copyToTexture(0,0,r,i,0,0,p),t.copyToTexture(0,0,r,i,0,0,g),this._startFramebuffer=l,this._diffFramebuffer=zn(n,r,i,x.FLOAT,a.RGBA32F),this._resultsFramebuffer=zn(n,1,1,x.FLOAT,a.RGBA32F,4),this._minTexture=Bn(n,1,1,x.FLOAT,a.RGBA32F),this._maxTexture=Bn(n,1,1,x.FLOAT,a.RGBA32F),this._sumTexture=Bn(n,1,1,x.FLOAT,a.RGBA32F),this._numOfNoDataTexture=Bn(n,1,1,x.FLOAT,a.R32F)}else{let e=this._startFramebuffer;e.resize(r,i);let n=e.getColorTexture(m),a=e.getColorTexture(Te),o=e.getColorTexture(d),s=e.getColorTexture(ue);t.copyToTexture(0,0,r,i,0,0,n),t.copyToTexture(0,0,r,i,0,0,a),t.copyToTexture(0,0,r,i,0,0,o),t.copyToTexture(0,0,r,i,0,0,s),this._diffFramebuffer.resize(r,i)}if(this._width===r&&this._height===i&&this._framebuffers!==null)return;let o=(this._framebuffers||[]).reverse();this._framebuffers=null,this._width=r,this._height=i,this._framebuffers=this._updateFramebuffers(n,r,i,o,4)}_updateFramebuffers(e,t,n,r,i=1){let a=[],o=t,s=n;for(;o>1||s>1;){let t=Math.max(1,Math.floor(o/2)),n=Math.max(1,Math.floor(s/2)),c=Rn(e,t,n,r,i);a.push(c),o=t,s=n}return a.at(-1),r.forEach(e=>b(e)),r.length=0,a}_computeDiff(e,t,n,r,i,a){let{context:o,painter:s}=e;o.bindFramebuffer(this._diffFramebuffer),o.setDrawBuffers([m]),o.setViewport(0,0,i,a),o.setClearColor(0,0,0,0),o.clear(16384);let c={shader:this.shaders.textureStatisticsDiff,uniforms:{config:{inputTexture:{texture:t,unit:1},sumTexture:{texture:n,unit:2},numOfNoDataTexture:{texture:r,unit:3},numTexels:i*a}},defines:null,optionalAttributes:null,useComputeBuffer:!1};s.submitDrawMesh(o,c,s.quadMesh)}_computeSdtDev(e,t,n,r,i,a,o,s){let{context:c,painter:l}=e;c.bindFramebuffer(this._resultsFramebuffer),c.setDrawBuffers([m,Te,d,ue]),c.setViewport(0,0,1,1),c.setClearColor(0,0,0,0),c.clear(16384);let u={shader:this.shaders.textureStatisticsStdDev,uniforms:{config:{minTexture:{texture:t,unit:1},maxTexture:{texture:n,unit:2},sumTexture:{texture:r,unit:3},numOfNoDataTexture:{texture:i,unit:4},diffSqTexture:{texture:a,unit:5},numTexels:o*s}},defines:null,optionalAttributes:null,useComputeBuffer:!1};l.submitDrawMesh(c,u,l.quadMesh)}};function Rn(e,t,n,r,i=1){let o=r.pop();return o===void 0?o=zn(e,t,n,x.FLOAT,a.RGBA32F,i):o.resize(t,n),o}function zn(e,t,n,r,i,a=1){if(a<1||a>4)throw Error(`Number of color attachments must be between 1 and 4.`);let o=new Gt(e,Bn(e,t,n,r,i));for(let s=1;s<a;s++){let a=Bn(e,t,n,r,i);o.attachColorTexture(a,m+s)}return o}function Bn(e,t,n,r,i){let a=new we(t,n);return a.samplingMode=9728,a.wrapMode=33071,a.pixelFormat=6408,a.dataType=r,a.internalFormat=i,new ce(e,a)}function Vn(e){let t=ae(e),n=t/2;return Math.abs(t-e)<Math.abs(n-e)?t:n}function Hn(e,t){let n=new we(e,t);return n.internalFormat=a.RGBA32F,n.samplingMode=9728,n.dataType=x.FLOAT,n.isImmutable=!0,n.wrapMode=33071,n}function Un(e,t,n){let r=Hn(t,n);return new ce(e,r)}function Wn(e,t,n){let r=Hn(t,n);return new Gt(e,r)}function Gn(e,t){let{symbolizerParameters:n}=e,{type:r}=n,i=r===`lut`?`nearest`:e.interpolation,a=i===`bilinear`&&r!==`lut`&&(r!==`stretch`||n.bandCount===1),o=i===`cubic`;return{bilinear:a||i===`bilinear`&&t!=null&&!t.capabilities.textureFloatLinear,bicubic:o,nearestOnEdge:a}}function Kn(e,t,n,r){let i=T(t.multiply(n)),a=new E(new O(i.x),new O(i.y)),o=new E(a.x.add(1),a.y),s=new E(a.x,a.y.add(1)),c=new E(a.x.add(1),a.y.add(1)),l=K(e,a,new O(0)),u=K(e,o,new O(0)),d=K(e,s,new O(0)),f=K(e,c,new O(0)),p=Xe(t.multiply(n)),m=A(l,u,p.x),h=A(d,f,p.x),g=A(m,h,p.y);if(!r)return g;let ee=new U(l.a,u.a,d.a,f.a),_=ee.xy.multiply(ee.zw),v=T(_.x.multiply(_.y).add(.5)),te=g.multiply(v),ne=$t(v).multiply(M(e,t));return te.add(ne)}var qn=class extends G{};function Jn(e,t){let n=M(t.transformTexture,e);return new q(n.r,n.g)}function Yn(e,t){let{transformTexture:n,targetImageSize:r,transformSpacing:i}=t,a=T(e.multiply(r)),o=new q(4,1),s=T(a.divide(i)).multiply(o),c=Xe(a.add(new q(.5,.5)).divide(i)),l=new E(Ze(s.x),Ze(s.y)),u=new D(c,1);return k(yt(c.x,c.y),Xn(n,l,u),Zn(n,l,u))}function Xn(e,t,n){let r=K(e,t,new O(0)),i=new E(t.x.add(1),t.y),a=K(e,i,new O(0));return new q(V(r.rgb,n),V(a.rgb,n))}function Zn(e,t,n){let r=new E(t.x.add(2),t.y),i=K(e,r,new O(0)),a=new E(t.x.add(3),t.y),o=K(e,a,new O(0));return new q(V(i.rgb,n),V(o.rgb,n))}function Qn(e){let t=L(new q(-1e-5,-1e-5),e).multiply(L(e,new q(1.00001,1.00001))),n=$t(t.x.multiply(t.y));return new $e(n)}function $n(e,t,n=!1){return t?n?Jn(e,t):Yn(e,t):e}function er(e,t,n){let{bicubic:r=!1,bilinear:i=!1,nearestOnEdge:a=!1}=n??{};return r||i?r?Kt(t.texture,e,t.srcImageSize):Kn(t.texture,e,t.srcImageSize,a):M(t.texture,e)}y([I(j)],qn.prototype,`transformTexture`,void 0),y([I(q)],qn.prototype,`targetImageSize`,void 0),y([I(q)],qn.prototype,`transformSpacing`,void 0),y([I(q)],qn.prototype,`transformGridSize`,void 0);var tr=class extends Lt{};y([xt(0,q)],tr.prototype,`position`,void 0);var nr=class extends jt{},rr=class extends G{};y([I(j)],rr.prototype,`texture`,void 0),y([I(Ht)],rr.prototype,`dvsMat3`,void 0),y([I(q)],rr.prototype,`coordScale`,void 0),y([I(q)],rr.prototype,`srcImageSize`,void 0),y([I(F)],rr.prototype,`opacity`,void 0);var ir=class extends G{};y([I(j)],ir.prototype,`maskTexture`,void 0);var ar=class extends G{};y([I(j)],ar.prototype,`highlightTexture`,void 0);var J=class extends Ft{constructor(){super(...arguments),this.applyProjection=!0,this.lookupProjection=!1,this.bilinear=!1,this.bicubic=!1,this.nearestOnEdge=!1,this.applyPixelMask=!1,this.applyPixelHighlights=!1}vertex(e){let t=e.position,{dvsMat3:n,coordScale:r}=this.config,i=n.multiply(new D(t.multiply(r),1));return{uv:t,glPosition:new U(i,1)}}fragment(e){let t=new Ot,n=$n(e.uv,this.applyProjection?this.projectionConfig:void 0,this.lookupProjection),r=this._colorize(n,e.uv);this.applyPixelHighlights&&(r=this._highlightPixels(e.uv,r));let i=k(Qn(n),new U(0),r),a=i.a.multiply(this.config.opacity);if(this.applyPixelMask){let t=this._getPixelMask(e.uv);a=a.multiply(t)}return t.fragColor=new U(i.rgb,1).multiply(a),t}_getPixel(e){let{config:t,bicubic:n,bilinear:r,nearestOnEdge:i}=this;return er(e,t,{bicubic:n,bilinear:r,nearestOnEdge:i})}_getPixelMask(e){let{maskTexture:t}=this.pixelMaskConfig,n=M(t,e);return N(n.a)}_highlightPixels(e,t){let{highlightTexture:n}=this.highlightConfig,r=M(n,e),i=N(r.a);return A(t,r,i)}};y([z],J.prototype,`applyProjection`,void 0),y([z],J.prototype,`lookupProjection`,void 0),y([z],J.prototype,`bilinear`,void 0),y([z],J.prototype,`bicubic`,void 0),y([z],J.prototype,`nearestOnEdge`,void 0),y([z],J.prototype,`applyPixelMask`,void 0),y([z],J.prototype,`applyPixelHighlights`,void 0),y([I(rr)],J.prototype,`config`,void 0),y([H(qn)],J.prototype,`projectionConfig`,void 0),y([H(ir)],J.prototype,`pixelMaskConfig`,void 0),y([H(ar)],J.prototype,`highlightConfig`,void 0),y([S(0,W(tr))],J.prototype,`vertex`,null),y([S(0,W(nr))],J.prototype,`fragment`,null);var or=class extends G{};function sr(e,t,n,r=!0){let{colormapTexture:i,colormapOffset:a,colormapMaxIndex:o}=n,s=e.r.multiply(t).subtract(a),c=P(s,new F(0),o),l=new q(c.add(.5).divide(o.add(1)),0),u=M(i,l),d=new U(u.rgb,u.a.multiply(e.a));if(r)return d;let f=L(new F(0),s).multiply(L(s,n.colormapMaxIndex));return d.multiply(f)}y([I(j)],or.prototype,`colormapTexture`,void 0),y([I(F)],or.prototype,`colormapOffset`,void 0),y([I(F)],or.prototype,`colormapMaxIndex`,void 0);var cr=class extends J{constructor(){super(...arguments),this.type=`RasterColorizerLUTShader`}_colorize(e){let t=this._getPixel(e);return sr(t,new F(1),this.colormapConfig,!1)}};y([I(or)],cr.prototype,`colormapConfig`,void 0);function lr(e){let t=new U(0,-1/3,2/3,-1),n=k(_t(e.y,e.z),new U(e.zy,t.wz),new U(e.yz,t.xy)),r=k(_t(e.x,n.x),new U(n.xyw,e.x),new U(e.x,n.yzx)),i=r.x.subtract(ht(r.w,r.y)),a=new F(1e-10),o=r.w.subtract(r.y),s=i.multiply(6).add(a),c=C(o.divide(s).add(r.z)),l=r.x.add(a),u=ht(i.divide(l),new F(1));return new D(c,u,r.x)}function ur(e){let t=new U(1,2/3,1/3,3),n=C(Xe(e.xxx.add(t.xyz)).multiply(6).subtract(t.www)),r=P(n.subtract(t.xxx),new D(0,0,0),new D(1));return e.z.multiply(A(t.xxx,r,e.y))}var dr=class extends G{};function Y(e){let t=C(e),n=L(t,new q(1,1)).multiply(t),r=new F(2).subtract(t),i=L(new F(1),t).multiply(r);return n.add(i)}function fr(e,t,n){let r=new F(1).divide(n),i=M(e,Y(r.multiply(new q(-1,-1)).add(t))),a=M(e,Y(r.multiply(new q(0,-1)).add(t))),o=M(e,Y(r.multiply(new q(1,-1)).add(t))),s=M(e,Y(r.multiply(new q(-1,0)).add(t))),c=M(e,Y(t)),l=M(e,Y(r.multiply(new q(1,0)).add(t))),u=M(e,Y(r.multiply(new q(-1,1)).add(t))),d=M(e,Y(r.multiply(new q(0,1)).add(t))),f=M(e,Y(r.multiply(new q(1,1)).add(t))),p=new U(i.a,a.a,o.a,s.a),m=new U(l.a,u.a,d.a,f.a),h=p.multiply(m),g=h.xy.multiply(h.zw),ee=g.x.multiply(g.y).multiply(c.a),_=new R(new F(0),10);return _[0]=i.r,_[1]=a.r,_[2]=o.r,_[3]=s.r,_[4]=c.r,_[5]=l.r,_[6]=u.r,_[7]=d.r,_[8]=f.r,_[9]=ee,_}function pr(e,t){let n=new U(e[5],e[3],e[7],e[1]).multiply(2),r=new D(e[2],n[0],e[8]),i=new D(e[0],n[1],e[6]),a=V(r.subtract(i),new D(1)),o=new D(e[6],n[2],e[8]),s=new D(e[0],n[3],e[2]),c=V(o.subtract(s),new D(1));return new q(a,c).multiply(t)}function mr(e,t,n){let{factor:r}=t,i=pr(e,r),a=B(V(i,i).add(1)),o=e[9],{sinZsinAs:s,sinZcosAs:c,cosZs:l,weights:u}=t;if(!n){let e=hr({sinZsinA:s[0],sinZcosA:c[0],cosZ:l[0],weights:new F(1),dzxy:i,dzd:a});return new U(e,e,e,o)}let d=hr({sinZsinA:new D(s[0],s[1],s[2]),sinZcosA:new D(c[0],c[1],c[2]),cosZ:new D(l[0],l[1],l[2]),weights:new D(u[0],u[1],u[2]),dzxy:i,dzd:a}),f=hr({sinZsinA:new D(s[3],s[4],s[5]),sinZcosA:new D(c[3],c[5],c[5]),cosZ:new D(l[3],l[4],l[5]),weights:new D(u[3],u[4],u[5]),dzxy:i,dzd:a}),p=V(d.add(f),new D(1));return new U(p,p,p,o)}function hr(e){let t=e.sinZsinA.multiply(e.dzxy.y),n=e.sinZcosA.multiply(e.dzxy.x),r=t.subtract(n),i=e.cosZ.add(r).divide(e.dzd);return i.multiply(L(new F(0),i)).multiply(e.weights)}function gr(e,t){let{pixelSizeFactor:n}=e,r=[e.factor[0]/t[0],e.factor[1]/t[1]];if(n>0){let{zFactor:i,pixelSizePower:a,gcsFactor:o}=e,s=t[0]*o,c=t[1]*o;r[0]=(i+s**a*n)/(8*s),r[1]=(i+c**a*n)/(8*c)}return r}y([I(R.ofType(F,6))],dr.prototype,`sinZcosAs`,void 0),y([I(R.ofType(F,6))],dr.prototype,`sinZsinAs`,void 0),y([I(R.ofType(F,6))],dr.prototype,`cosZs`,void 0),y([I(R.ofType(F,6))],dr.prototype,`weights`,void 0),y([I(F)],dr.prototype,`minValue`,void 0),y([I(F)],dr.prototype,`maxValue`,void 0),y([I(q)],dr.prototype,`factor`,void 0);var _r=class extends J{constructor(){super(...arguments),this.type=`RasterColorizerShadedReliefShader`,this.applyColormap=!1,this.isMultidirectional=!1}_colorize(e){let{texture:t}=this.config,n=fr(t,e,this.config.srcImageSize),r=mr(n,this.hillshadeConfig,this.isMultidirectional);if(!this.applyColormap)return new U(r.x,r.x,r.x,r.a);let{minValue:i,maxValue:a}=this.hillshadeConfig,o=this._getPixel(e),s=a.subtract(i),c=o.r.subtract(i),l=P(c.divide(s),new F(0),new F(1)),u=sr(new U(l,l,l,1),new F(255),this.colormapConfig),d=lr(u.xyz),f=ur(new D(d.xy,r.x));return new U(f,u.a.multiply(r.a))}};y([z],_r.prototype,`applyColormap`,void 0),y([z],_r.prototype,`isMultidirectional`,void 0),y([I(dr)],_r.prototype,`hillshadeConfig`,void 0),y([H(or)],_r.prototype,`colormapConfig`,void 0);function X(e){let t=N(e),n=e.add(C(t).subtract(1));return t.multiply(t).divide(n)}function vr(e){return new U(T(e.rgb.add(.5)),e.a)}function yr(e,t){return L(t.x,e).multiply(L(e,t.y))}function br(e,t){let n=new D(0,0,0),r=new D(e);for(let e=0;e<9/3;e++){let i=6*e,a=new D(t[i],t[i+2],t[i+4]),o=new D(t[i+1],t[i+3],t[i+5]);n=n.add(L(a,r).multiply(L(r,o)))}return N(V(n,new D(1,1,1)))}function xr(e,t,n){let r=new D(e),i=new D(0,0,0),a=new F(0);for(let e=0;e<n/3;e++){let n=9*e,o=new D(t[n],t[n+3],t[n+6]),s=new D(t[n+1],t[n+4],t[n+7]),c=L(o,r).multiply(L(r,s)),l=new D(t[n+2],t[n+5],t[n+8]);a=A(a,l.x,c.x),a=A(a,l.y,c.y),a=A(a,l.z,c.z),i=i.add(c)}return{mapValue:a,includeMask:N(V(i,new D(1,1,1)))}}var Sr=class extends G{};y([I(F)],Sr.prototype,`minOutput`,void 0),y([I(F)],Sr.prototype,`maxOutput`,void 0),y([I(D)],Sr.prototype,`minCutOff`,void 0),y([I(D)],Sr.prototype,`maxCutOff`,void 0),y([I(D)],Sr.prototype,`factor`,void 0),y([I(D)],Sr.prototype,`gamma`,void 0),y([I(D)],Sr.prototype,`gammaCorrection`,void 0);var Cr=class extends G{};function wr(e,t){let{minCutOff:n,maxCutOff:r,factor:i,minOutput:a}=t;return P(e,n,r).subtract(n).multiply(i).add(a)}function Tr(e,t){let{minCutOff:n,maxCutOff:r,minOutput:i,maxOutput:a,gamma:o,gammaCorrection:s}=t,c=P(e,n,r).subtract(n),l=r.subtract(n),u=c.divide(l),d=L(new F(1),o),f=N(o.subtract(1)),p=a.subtract(i),m=new D(1),h=it(m.divide(p),u.multiply(s)),g=$t(d.multiply(f).multiply(h)),ee=it(u,m.divide(o)),_=g.multiply(p).multiply(ee).add(i);return P(_,i,a)}function Er(e,t,n,r=255){let i=n?Tr(e.rgb,t).divide(r):wr(e.rgb,t);return new U(i,e.a)}function Dr(e,t,n,r,i){let a=new E(0,0),o=new O(0),s=K(n.minTexture,a,o).rgb,c=K(n.maxTexture,a,o).rgb;if(i){let e=K(n.meanTexture,a,o).rgb,t=K(n.stddevTexture,a,o).rgb.multiply(n.numberOfStandardDeviations);s=Qe(s,e.subtract(t)),c=ht(c,e.add(t))}let l=c.subtract(s),u=new D(X(l.x),X(l.y),X(l.z)),d=t.maxOutput.subtract(t.minOutput).multiply(u),f={...t,minCutOff:s,maxCutOff:c,factor:d},p=r?Tr(e.rgb,f).divide(255):wr(e.rgb,f);return new U(p,e.a)}y([I(j)],Cr.prototype,`minTexture`,void 0),y([I(j)],Cr.prototype,`maxTexture`,void 0),y([I(j)],Cr.prototype,`meanTexture`,void 0),y([I(j)],Cr.prototype,`stddevTexture`,void 0),y([I(F)],Cr.prototype,`numberOfStandardDeviations`,void 0);var Or=class extends J{constructor(){super(...arguments),this.type=`RasterColorizerStretchShader`,this.isMultiband=!0,this.applyColormap=!1,this.useGamma=!1,this.noOp=!1,this.draStretchType=0}_colorize(e){let t=this._getPixel(e);if(this.noOp)return t;let{draStretchType:n,stretchConfig:r,useGamma:i,statisticsConfig:a}=this,o=n===0?Er(t,r,i):Dr(t,r,a,i,n===2);if(this.isMultiband)return o;if(o=new U(o.rrr,o.a),this.applyColormap){let e=this.useGamma?255:1;o=sr(o,new F(e),this.colormapConfig)}return o}};y([z],Or.prototype,`isMultiband`,void 0),y([z],Or.prototype,`applyColormap`,void 0),y([z],Or.prototype,`useGamma`,void 0),y([z],Or.prototype,`noOp`,void 0),y([z],Or.prototype,`draStretchType`,void 0),y([I(Sr)],Or.prototype,`stretchConfig`,void 0),y([H(or)],Or.prototype,`colormapConfig`,void 0),y([H(Cr)],Or.prototype,`statisticsConfig`,void 0);var kr=160,Ar=new Set([`f32`,`f64`,`u16`,`s16`,`u32`,`s32`]),jr=class extends at{constructor(){super(...arguments),this.name=`BrushRasterColorizer`,this.type=0,this.shaders={lut:new cr,stretch:new Or,shadedRelief:new _r},this._mosaicFbo=null,this._statisticsTechnique=null,this._draTimer=0}shutdown(e){super.shutdown(e),this._mosaicFbo=b(this._mosaicFbo),this._statisticsTechnique=b(this._statisticsTechnique)}render(e,t){let n=t.bitmaps.some(Nr);n||(this._mosaicFbo=b(this._mosaicFbo),this._statisticsTechnique=b(this._statisticsTechnique));let r=n?this._computeStatisticsTextures(e,t):void 0;for(let n of t.bitmaps){if(!n.source||n.suspended)continue;e.timeline.begin(this.name);let{painter:t}=e;t.setPipelineState({depth:!1,stencil:{test:{mask:255,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:`composite`}}),n.updateTexture(e),n.updateProcessedTexture();let{type:i}=n.symbolizerParameters,a=i===`stretch`?this._getStretchOptions(n,r):i===`lut`?this._getLutOptions(n):this._getShadedReliefOptions(n);n.interpolation!==`bilinear`||e.context.capabilities.textureFloatLinear||(a.defines.bilinear=!0),t.submitDrawMesh(e.context,a,t.quadMesh,n),e.timeline.end(this.name)}}_computeStatisticsTextures(e,t){this._statisticsTechnique??=new Ln;let n=this._statisticsTechnique,r=he(`esri-2d-dra-delay`);if(r==null){let e=t.bitmaps.find(Nr),{stretchType:n,bandCount:i}=e.symbolizerParameters,{pixelType:a}=e.source;n===`minMax`&&i>=3&&Ar.has(a)&&(r=kr)}if(r){let i=performance.now();(i-this._draTimer>=r||e.stationary||!n.minValuesTexture)&&(this._mosaic(e,t),n.render(e,{fbo:this._mosaicFbo}),this._draTimer=i)}else this._mosaic(e,t),n.render(e,{fbo:this._mosaicFbo});return{minTexture:n.minValuesTexture,maxTexture:n.maxValuesTexture,meanTexture:n.meanValuesTexture,stddevTexture:n.stdDevValuesTexture}}_mosaic(e,t){let{context:n,painter:r}=e,i=n.getBoundFramebufferObject();if(this._mosaicFbo)this._mosaicFbo.resize(i.width,i.height);else{let e=Mr(n,i.width,i.height);this._mosaicFbo=new Gt(n,e)}n.bindFramebuffer(this._mosaicFbo);let a=`RasterColorizerMosaic`;for(let n of t.bitmaps){if(!Nr(n))continue;e.timeline.begin(a),r.setPipelineState({depth:!1,stencil:{test:{mask:255,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:`composite`}});let t=n.interpolation;n.interpolation=`nearest`,n.updateTexture(e),n.updateProcessedTexture();let i=this._getStretchOptions(n);i.defines.noOp=!0,r.submitDrawMesh(e.context,i,r.quadMesh,n),n.interpolation=t,e.timeline.end(a)}n.bindFramebuffer(i)}_getLutOptions(e){let{config:t,projectionConfig:n,colormapConfig:r,pixelMaskConfig:i,highlightConfig:a,projectionDefines:o}=this._getCommonConfig(e),s=Gn(e);return{shader:this.shaders.lut,uniforms:{projectionConfig:n,config:t,colormapConfig:r,pixelMaskConfig:i,highlightConfig:a},defines:{...o,...s,applyPixelMask:!!i,applyPixelHighlights:!!a},optionalAttributes:null,useComputeBuffer:!1}}_getStretchOptions(e,t){let n=e.symbolizerParameters,{config:r,projectionConfig:i,colormapConfig:a,pixelMaskConfig:o,highlightConfig:s,projectionDefines:c,textureUnit:l}=this._getCommonConfig(e),u=Gn(e),d=t?{minTexture:{texture:t.minTexture,unit:l},maxTexture:{texture:t.maxTexture,unit:l+1},meanTexture:{texture:t.meanTexture,unit:l+2},stddevTexture:{texture:t.stddevTexture,unit:l+3},numberOfStandardDeviations:n.numberOfStandardDeviations||2}:void 0,f=t?n.stretchType===`standardDeviation`?2:1:0;return{shader:this.shaders.stretch,uniforms:{projectionConfig:i,config:r,stretchConfig:n,colormapConfig:a,pixelMaskConfig:o,highlightConfig:s,statisticsConfig:d},defines:{...c,...u,isMultiband:n.bandCount>1,applyColormap:!!a,useGamma:n.useGamma,noOp:e.isRendereredSource&&!e.processed,applyPixelMask:!!o,applyPixelHighlights:!!s,draStretchType:f},optionalAttributes:null,useComputeBuffer:!1}}_getShadedReliefOptions(e){let t=e.symbolizerParameters,{config:n,projectionConfig:r,colormapConfig:i,pixelMaskConfig:a,highlightConfig:o,projectionDefines:s}=this._getCommonConfig(e),c=Gn(e);return{shader:this.shaders.shadedRelief,uniforms:{projectionConfig:r,config:n,hillshadeConfig:t,colormapConfig:i,pixelMaskConfig:a,highlightConfig:o},defines:{...s,...c,isMultidirectional:t.hillshadeType>0,applyColormap:!!i,applyPixelMask:!!a,applyPixelHighlights:!!o},optionalAttributes:null,useComputeBuffer:!1}}_getCommonConfig(e){let{coordScale:t,computedOpacity:n,transforms:r}=e,{names:i,textures:a}=e.getTextures({useProcessedTexture:e.processed}),o=a[i.indexOf(`u_image`)],s=e.getRasterTextureSize(),c=0,l={texture:{texture:o,unit:c++},dvsMat3:r.displayViewScreenMat3,coordScale:t,srcImageSize:s,opacity:n},u=a[i.indexOf(`u_transformGrid`)],{transformGrid:d}=e,f=!(!u||!d),p=f?{transformTexture:{texture:u,unit:c++},targetImageSize:[e.width,e.height],transformSpacing:d.spacing,transformGridSize:d.size}:void 0,m=a[i.indexOf(`u_colormap`)],{colormap:h,colormapOffset:g}=e.symbolizerParameters,ee=m&&h?{colormapTexture:{texture:m,unit:c++},colormapOffset:g??0,colormapMaxIndex:h.length/4-1}:void 0,_=a[i.indexOf(`u_mask`)],v=_?{maskTexture:{texture:_,unit:c++}}:void 0,{highlightTexture:te}=e;return{config:l,projectionConfig:p,colormapConfig:ee,pixelMaskConfig:v,highlightConfig:te?{highlightTexture:{texture:te,unit:c++}}:void 0,projectionDefines:{applyProjection:f,lookupProjection:f&&d.spacing[0]===1},textureUnit:c}}};function Mr(e,t,n){let r=new we(t,n);return r.internalFormat=a.RGBA32F,r.samplingMode=9728,r.dataType=x.FLOAT,r.wrapMode=33071,new ce(e,r)}function Nr(e){return!e.suspended&&e.source!=null&&!e.isRendereredSource&&e.symbolizerParameters.type===`stretch`&&!!e.symbolizerParameters.dynamicRangeAdjustment}var Pr=class extends J{constructor(){super(...arguments),this.hasExistingHighlights=!1}_computeHighlightedColor(e,t,n){let r=A(new U(0),t,e);if(this.hasExistingHighlights){let{highlightTexture:t}=this.highlightConfig,i=M(t,n);return A(i,r,e)}return r}};y([z],Pr.prototype,`hasExistingHighlights`,void 0);var Fr=class extends G{};y([I(R.ofType(F,18))],Fr.prototype,`ranges`,void 0),y([I(Ht)],Fr.prototype,`bandSwap`,void 0),y([I(U)],Fr.prototype,`color`,void 0);var Ir=class extends Pr{constructor(){super(...arguments),this.type=`RasterRangeHighlightShader`}_colorize(e,t){let n=this._getPixel(e),{ranges:r,color:i,bandSwap:a}=this.rangeHighlightConfig,o=a.multiply(n.rgb).x,s=br(o,r).multiply(N(n.a));return this._computeHighlightedColor(s,i,t)}};y([I(Fr)],Ir.prototype,`rangeHighlightConfig`,void 0);var Lr=class extends G{};y([I(q)],Lr.prototype,`xRange`,void 0),y([I(q)],Lr.prototype,`yRange`,void 0),y([I(Ht)],Lr.prototype,`bandSwap`,void 0),y([I(U)],Lr.prototype,`color`,void 0);var Rr=class extends G{};y([I(j)],Rr.prototype,`maskTexture`,void 0);var zr=class extends Pr{constructor(){super(...arguments),this.type=`RasterXYBandHighlightShader`,this.useMask=!1}_colorize(e,t){let n=this._getPixel(e),{xRange:r,yRange:i,color:a,bandSwap:o}=this.xyRangeHighlightConfig,{x:s,y:c}=o.multiply(n.rgb),l=yr(s,r).multiply(yr(c,i)).multiply(N(n.a));if(this.useMask){let{maskTexture:e}=this.xyMaskHighlightConfig,t=P(s.subtract(r.x).divide(r.y.subtract(r.x)),new F(0),new F(1)),n=P(i.y.subtract(c).divide(i.y.subtract(i.x)),new F(0),new F(1)),a=M(e,new q(t,n)).r;l=l.multiply(a)}return this._computeHighlightedColor(l,a,t)}};y([z],zr.prototype,`useMask`,void 0),y([I(Lr)],zr.prototype,`xyRangeHighlightConfig`,void 0),y([H(Rr)],zr.prototype,`xyMaskHighlightConfig`,void 0);var Br=class extends at{constructor(){super(...arguments),this.name=`BrushRasterHighlight`,this.type=2,this.shaders={range:new Ir,xyBand:new zr}}shutdown(e){super.shutdown(e),this._fbo?.dispose(),this._fbo=void 0}_getBandIds(e,t){let{type:n}=e,r=n===`xy-band`?e.bandIds:[e.bandId];return t?.length?r.map(e=>t.indexOf(e)):n===`xy-band`?[0,1]:[0]}_getSingleBandShaderOptions(e,t,n,r){let{config:i,projectionConfig:a,highlightConfig:o,projectionDefines:s}=this._getCommonConfig(t),c=Gn(t,r),l={bandSwap:n,ranges:e.ranges,color:e.color};return{shader:this.shaders.range,uniforms:{projectionConfig:a,config:i,rangeHighlightConfig:l,highlightConfig:o},defines:{...s,...c,applyPixelMask:!1,applyPixelHighlights:!1,hasExistingHighlights:!!o},optionalAttributes:null,useComputeBuffer:!1}}_getXYBandShaderOptions(e,t,n,r,i){let{config:a,projectionConfig:o,highlightConfig:s,projectionDefines:c}=this._getCommonConfig(t),l=Gn(t,r),u={bandSwap:n,xRange:e.xRange,yRange:e.yRange,color:e.color},d=i?{maskTexture:{texture:i,unit:4}}:void 0;return{shader:this.shaders.xyBand,uniforms:{projectionConfig:o,config:a,xyRangeHighlightConfig:u,xyMaskHighlightConfig:d,highlightConfig:s},defines:{...c,...l,applyPixelMask:!1,applyPixelHighlights:!1,hasExistingHighlights:!!s,useMask:!!d},optionalAttributes:null,useComputeBuffer:!1}}render(e,t){let{pixelHighlightOptions:n}=e;if(!n)return;let{context:r}=e;if(!this._fbo){let t=Vr(e.context,512,512);this._fbo=new Gt(r,t)}let{type:i}=n,a=i===`xy-band`?Hr(e.context,n):void 0,o=r.getBoundFramebufferObject(),s=r.getViewport();for(let o of t.bitmaps){if(!o.source||o.highlighted||o.suspended||o.isRendereredSource)continue;let t=this._getBandIds(n,o.bandIds);if(t.some(e=>e<0||e>2))continue;e.timeline.begin(this.name);let{painter:s}=e;s.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:`custom`,blendParameters:{srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0}}}),o.updateTexture(e),o.updateProcessedTexture(!1);let c=new Float32Array(9);c[3*t[0]]=1,c[3*t[1]+1]=i===`xy-band`?1:0;let l=i===`single-band`?this._getSingleBandShaderOptions(n,o,c,r):this._getXYBandShaderOptions(n,o,c,r,a);r.bindFramebuffer(this._fbo),r.setViewport(0,0,512,512),s.submitDrawMesh(e.context,l,s.quadMesh);let u=Vr(e.context,512,512);this._fbo.copyToTexture(0,0,512,512,0,0,u),o.highlightTexture=u,e.timeline.end(this.name)}a?.dispose(),r.bindFramebuffer(o),r.setViewport(s.x,s.y,s.width,s.height)}_getCommonConfig(e){let{names:t,textures:n}=e.getTextures({forProcessing:!0,useProcessedTexture:e.processed}),r=n[t.indexOf(`u_image`)],i=e.getRasterTextureSize(),a={texture:{texture:r,unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:i,opacity:1},o=n[t.indexOf(`u_transformGrid`)],{transformGrid:s}=e,c=!(!o||!s),l=c?{transformTexture:{texture:o,unit:1},targetImageSize:[e.width,e.height],transformSpacing:s.spacing,transformGridSize:s.size}:void 0,{highlightTexture:u}=e;return{config:a,projectionConfig:l,highlightConfig:u?{highlightTexture:{texture:u,unit:2}}:void 0,projectionDefines:{applyProjection:c,lookupProjection:c&&s.spacing[0]===1}}}};function Vr(e,t,n){let r=new we(t,n);return r.internalFormat=a.RGBA8,r.samplingMode=9728,r.dataType=x.UNSIGNED_BYTE,r.isImmutable=!0,r.wrapMode=33071,new ce(e,r)}function Hr(e,t){let{mask:n,maskSize:r}=t;if(!n?.length||!r?.length)return;let i=new we(r[0],r[1]);return i.internalFormat=a.R8,i.samplingMode=9728,i.dataType=x.UNSIGNED_BYTE,i.isImmutable=!0,i.wrapMode=33071,new ce(e,i,n)}var Z=class extends at{shutdown(e){super.shutdown(e),this._fbo?.dispose(),this._fbo=void 0}render(e,t){let{rasterFunction:n}=e;if(!n)return;let{context:r}=e,i=`indexedColormap`in n.parameters?ln(r,n.parameters.indexedColormap):void 0,a=n.name===`Reproject`,o=r.getBoundFramebufferObject(),s=r.getViewport();for(let o of t.bitmaps){let s=a?!(o.rasterTexture&&o.projected):!o.processed;if(!o.source||!s||o.suspended)continue;e.timeline.begin(this.name);let{painter:c}=e;c.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:`custom`,blendParameters:{srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0}}}),a||(o.processedTexture=b(o.processedTexture)),o.updateTexture(e);let[l,u]=o.getRasterTextureSize(a),d=l===512&&u===512,f=d?t.processorFbo:Wn(r,l,u);r.bindFramebuffer(f),r.setViewport(0,0,f.width,f.height),this._process(e,o,i);let p=Un(e.context,l,u);if(f.copyToTexture(0,0,l,u,0,0,p),a)o.rasterTexture=p;else{let t=e.hasBranches?n.id:0;o.functionTextures[t]?.dispose(),o.functionTextures[t]=p}d||f.dispose(),e.timeline.end(this.name)}i?.dispose(),r.bindFramebuffer(o),r.setViewport(s.x,s.y,s.width,s.height)}_getCommonConfig(e,t){let{rasterFunction:n,hasBranches:r}=e,{raster:i,rasters:a}=n.parameters,o=r?i?.id??a?.find(e=>e.name!==`Constant`)?.id??-1:0,s=t.functionTextures[o]??t.rasterTexture,c=n.name===`Reproject`;return{texture:{texture:s,unit:0},srcImageSize:t.getRasterTextureSize(c)}}_getMultipleInputConfig(e,t){return t?.length?t.length===2?{twoRasterConfig:this._getTwoInputConfig(t,e)}:t.length===3?{threeRasterConfig:this._getThreeInputConfig(t,e)}:{}:{}}_getConstantCount(e){return e?.filter(e=>e.name===`Constant`).length??0}_getTextures(e,t){return e.filter(e=>e.name!==`Constant`).map(e=>e.id!=null&&e.name!==`Identity`?t.functionTextures[e.id]:t.rasterTexture)}_getTwoInputConfig(e,t){let n=this._getTextures(e,t),r=n[1]?{texture:n[1],unit:1}:void 0,i=e.findIndex(e=>e.name===`Constant`),a=i===0?new Float32Array([0,1,0,1,0,0,0,0,0]):new Float32Array([1,0,0,0,1,0,0,0,0]);return{image1:r,image1Const:i>-1?e[i].parameters.value:0,imageSwap:a}}_getThreeInputConfig(e,t){let n=this._getTextures(e,t),r=0,i=0,a=new Float32Array([1,0,0,0,1,0,0,0,1]),o=n[1]?{texture:n[1],unit:1}:void 0,s=n[2]?{texture:n[2],unit:2}:void 0,c=[];if(e.forEach((e,t)=>e.name===`Constant`&&c.push(t)),c.length===1)r=e[c[0]].parameters.value,a=c[0]===0?new Float32Array([0,1,0,0,0,1,1,0,0]):c[0]===1?new Float32Array([1,0,0,0,0,1,0,1,0]):new Float32Array([1,0,0,0,1,0,0,0,1]);else if(c.length===2){r=e[c[0]].parameters.value,i=e[c[1]].parameters.value;let t=e.findIndex(e=>e.name!==`Constant`);a=t===0?new Float32Array([1,0,0,0,1,0,0,0,1]):t===1?new Float32Array([0,1,0,1,0,0,0,0,1]):new Float32Array([0,0,1,1,0,0,0,1,0])}return{image1:o,image2:s,image1Const:r,image2Const:i,imageSwap:a}}},Ur=class extends Lt{};y([xt(0,q)],Ur.prototype,`position`,void 0);var Wr=class extends jt{},Gr=class extends G{};y([I(j)],Gr.prototype,`texture`,void 0),y([I(q)],Gr.prototype,`srcImageSize`,void 0);var Q=class extends Ft{vertex(e){return{uv:e.position,glPosition:new U(tn(e.position),0,1)}}fragment(e){let t=new Ot,n=$n(e.uv),r=this._process(n);return t.fragColor=new U(r.rgb,1).multiply(r.a),t}_getPixel(e){return er(e,this.config)}};y([I(Gr)],Q.prototype,`config`,void 0),y([S(0,W(Ur))],Q.prototype,`vertex`,null),y([S(0,W(Wr))],Q.prototype,`fragment`,null);var Kr=class extends G{};y([I(q)],Kr.prototype,`cellSize`,void 0);var qr=class extends Q{constructor(){super(...arguments),this.type=`AspectShader`}_process(e){let{texture:t}=this.config,n=fr(t,e,this.config.srcImageSize),r=new q(1).divide(this.aspectConfig.cellSize.multiply(8)),{x:i,y:a}=pr(n,r),o=Mt(a),s=n[9].multiply(N(C(i).add(C(o)))),c=C(N(i)),l=new F(3.14159265359),u=new F(0),d=L(u,o).multiply(.5).multiply(l).add(L(o,u).multiply(1.5).multiply(l)),f=St(new F(2.5).multiply(l).add(Nt(o,Mt(i))),new F(2).multiply(l)),p=A(d,f,c).multiply(180).divide(l);return new U(p,p,p,s)}};y([I(Kr)],qr.prototype,`aspectConfig`,void 0);var Jr=class extends Z{constructor(){super(...arguments),this.name=`RasterAspectProcessor`,this.type=3,this.shaders={aspect:new qr}}_process(e,t){let n={cellSize:t.getRasterCellSize()},r=this._getCommonConfig(e,t),i={shader:this.shaders.aspect,uniforms:{config:r,aspectConfig:n},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:o}=e;a.submitDrawMesh(o,i,a.quadMesh)}},Yr=class extends G{};y([I(Ht)],Yr.prototype,`bandIndexMat3`,void 0);var Xr=class extends G{};y([I(D)],Xr.prototype,`adjustments`,void 0);var Zr=class extends Q{constructor(){super(...arguments),this.type=`BandArithmeticShader`,this.isOutputRounded=!1}_process(e){let t=this._getPixel(e),n=this.bandArithmeticConfig.bandIndexMat3.multiply(t.rgb),r=this._processIndex(n),i=new U(r,r,r,t.a);return this.isOutputRounded?vr(i):i}_processIndex(e){let{r:t,g:n}=e,r=this.adjustmentConfig?.adjustments;switch(this.indexType){case`ndxi`:{let e=t.subtract(n),r=t.add(n);return e.multiply(X(r))}case`sr`:return t.multiply(X(n));case`ci`:return t.multiply(X(n)).subtract(1);case`savi`:{let{x:e}=r,i=t.subtract(n),a=t.add(n).add(e);return i.multiply(X(a)).multiply(e.add(1))}case`tsavi`:{let{x:e,y:i,z:a}=r,o=a.multiply(e.multiply(e).add(1)).subtract(i.multiply(e)),s=e.multiply(t.subtract(e.multiply(n)).subtract(i)),c=i.multiply(t).add(n).add(o);return s.multiply(X(c))}case`msavi`:{let e=t.multiply(2).add(1),r=e.multiply(e).subtract(t.subtract(n).multiply(8));return e.subtract(B(r)).multiply(.5)}case`gemi`:{let e=t.multiply(t).subtract(n.multiply(n)).multiply(2).add(t.multiply(1.5)).add(n.multiply(.5)),r=t.add(n).add(.5),i=e.multiply(X(r)),a=i.multiply($t(i.multiply(.25))),o=n.subtract(.125).multiply(X($t(n)));return a.subtract(o)}case`pvi`:{let{x:e,y:i}=r,a=B(e.multiply(e).add(1));return t.subtract(n.multiply(e)).subtract(i).multiply(X(a))}case`vari`:{let t=e.g.subtract(e.r),n=e.g.add(e.r).subtract(e.b);return t.multiply(X(n))}case`rtvicore`:return t.subtract(n).multiply(100).subtract(t.subtract(e.b).multiply(10));case`bai`:{let e=it(new F(.1).subtract(n),new F(2)),r=it(new F(.06).subtract(t),new F(2));return X(e.add(r))}case`evi`:{let r=e.b,i=t.add(n.multiply(6)).subtract(r.multiply(7.5)).add(1);return t.subtract(n).multiply(2.5).multiply(X(i))}case`wndwi`:{let{r:t,g:n,b:i}=e,a=r.x,o=a.multiply(n),s=a.multiply(i),c=t.add(o).add(i).subtract(s);return t.subtract(o).subtract(i).add(s).multiply(X(c))}case`mtvi`:{let r=e.b,i=it(t.multiply(2).add(1),new F(2)),a=t.multiply(6).subtract(B(n).multiply(5)),o=B(i.subtract(a).subtract(.5)),s=t.subtract(r).multiply(1.2),c=n.subtract(r).multiply(2.5);return s.subtract(c).multiply(1.5).multiply(X(o))}default:return t}}};y([z],Zr.prototype,`indexType`,void 0),y([z],Zr.prototype,`isOutputRounded`,void 0),y([I(Yr)],Zr.prototype,`bandArithmeticConfig`,void 0),y([H(Xr)],Zr.prototype,`adjustmentConfig`,void 0);var Qr=class extends Z{constructor(){super(...arguments),this.name=`RasterBandArithmeticProcessor`,this.type=4,this.shaders={bandArithmetic:new Zr}}_process(e,t){let n=e.rasterFunction.parameters,r={indexType:n.indexType,isOutputRounded:n.isOutputRounded},i={bandIndexMat3:n.bandIndexMat3},a=n.adjustments?{adjustments:[...n.adjustments]}:void 0,o=this._getCommonConfig(e,t),s={shader:this.shaders.bandArithmetic,uniforms:{config:o,bandArithmeticConfig:i,adjustmentConfig:a},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:l}=e;c.submitDrawMesh(l,s,c.quadMesh)}},$r=class extends Q{constructor(){super(...arguments),this.type=`ColormapToRGBShader`}_process(e){let t=this._getPixel(e),n=sr(t,new F(1),this.colormapConfig,!1);return new U(n.xyz.multiply(255),n.a)}};y([I(or)],$r.prototype,`colormapConfig`,void 0);var ei=class extends Z{constructor(){super(...arguments),this.name=`RasterColormapToRGBProcessor`,this.type=5,this.shaders={colormapToRGB:new $r}}_process(e,t,n){let r=e.rasterFunction.parameters,i={colormapTexture:{texture:n,unit:1},colormapOffset:r.offset,colormapMaxIndex:r.indexedColormap.length/4-1},a=this._getCommonConfig(e,t),o={shader:this.shaders.colormapToRGB,uniforms:{config:a,colormapConfig:i},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},ti=class extends G{};y([I(j)],ti.prototype,`image1`,void 0),y([I(F)],ti.prototype,`image1Const`,void 0),y([I(Ht)],ti.prototype,`imageSwap`,void 0);var ni=class extends G{};y([I(j)],ni.prototype,`image1`,void 0),y([I(j)],ni.prototype,`image2`,void 0),y([I(F)],ni.prototype,`image1Const`,void 0),y([I(F)],ni.prototype,`image2Const`,void 0),y([I(Ht)],ni.prototype,`imageSwap`,void 0);var ri=e=>{let t=e;class n extends t{constructor(){super(...arguments),this.constantCount=0,this.imageCount=1}_getRasterValues(e){let{imageCount:t}=this;if(t===1){let t=M(this.config.texture,e);return{a:t.r,b:t.g,c:t.b,alpha:t.a}}if(t===2){let t=this._getTwoValues(e);return{a:t.a,b:t.b,c:t.b,alpha:t.alpha}}return this._getThreeValues(e)}_getTwoValues(e){let t=M(this.config.texture,e);if(this.constantCount===1){let{imageSwap:e,image1Const:n}=this.twoRasterConfig,r=e.multiply(new D(t.r,n,0));return{a:r.x,b:r.y,alpha:t.a}}let{image1:n}=this.twoRasterConfig,r=M(n,e);return{a:t.r,b:r.r,alpha:t.a.multiply(r.a)}}_getThreeValues(e){let t=M(this.config.texture,e),{imageSwap:n,image1:r,image2:i,image1Const:a,image2Const:o}=this.threeRasterConfig;if(this.constantCount===2){let e=n.multiply(new D(t.r,a,o));return{a:e.x,b:e.y,c:e.z,alpha:t.a}}if(this.constantCount===1){let i=M(r,e),o=n.multiply(new D(t.r,i.r,a));return{a:o.x,b:o.y,c:o.z,alpha:t.a.multiply(i.a)}}let s=M(r,e),c=M(i,e);return{a:t.r,b:s.r,c:c.r,alpha:t.a.multiply(s.a).multiply(c.a)}}}return y([z],n.prototype,`constantCount`,void 0),y([z],n.prototype,`imageCount`,void 0),y([H(ti)],n.prototype,`twoRasterConfig`,void 0),y([H(ni)],n.prototype,`threeRasterConfig`,void 0),n},ii=class extends ri(Q){constructor(){super(...arguments),this.type=`CompositeBandShader`}_process(e){let{a:t,b:n,c:r,alpha:i}=this._getRasterValues(e);return new U(t,n,r,i)}},ai=class extends Z{constructor(){super(...arguments),this.name=`RasterCompositeBandProcessor`,this.type=6,this.shaders={compositeBand:new ii}}_process(e,t){let{rasters:n}=e.rasterFunction.parameters,r={constantCount:this._getConstantCount(n),imageCount:n?.length??1},i=this._getMultipleInputConfig(t,n),a=this._getCommonConfig(e,t),o={shader:this.shaders.compositeBand,uniforms:{config:a,...i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},oi=class extends G{};y([I(q)],oi.prototype,`domainRange`,void 0);var si=class extends ri(Q){constructor(){super(...arguments),this.type=`LocalShader`,this.isOutputRounded=!1}_process(e){if(this.operationName===`conditional`)return this._conditional(e);let{a:t,b:n,alpha:r}=this._getRasterValues(e),{value:i,alpha:a}=this._compute(t,n,r);return this._processResult(i,a)}_processResult(e,t){let n=yr(e,this.domainRangeConfig.domainRange),r=new U(e,e,e,t).multiply(n);return this.isOutputRounded?vr(r):r}_compute(e,t,n){let{operationName:r}=this,i;switch(r){case`plus`:i=e.add(t);break;case`minus`:i=e.subtract(t);break;case`times`:i=e.multiply(t);break;case`divide`:case`floatdivide`:i=e.multiply(X(t)),n=n.multiply(w(C(N(t))));break;case`floordivide`:i=T(e.multiply(X(t))),n=n.multiply(w(C(N(t))));break;case`square`:i=e.multiply(e);break;case`sqrt`:i=B(e);break;case`power`:i=it(e,t);break;case`ln`:i=k(Ut(e,new F(0)),Wt(e),new F(0)),n=n.multiply(this._isAboveZero(e));break;case`log10`:i=k(Ut(e,new F(0)),ot(e).multiply(X(ot(new F(10)))),new F(0)),n=n.multiply(this._isAboveZero(e));break;case`log2`:i=k(Ut(e,new F(0)),ot(e),new F(0)),n=n.multiply(this._isAboveZero(e));break;case`exp`:i=Rt(e);break;case`exp10`:i=it(new F(10),e);break;case`exp2`:i=it(new F(2),e);break;case`rounddown`:i=T(e);break;case`roundup`:i=lt(e);break;case`int`:i=N(e).multiply(T(C(e)));break;case`mod`:i=St(e,t);break;case`negate`:i=Mt(e);break;case`abs`:i=C(e);break;case`acos`:{let t=this._isAbsBiggerThanOne(e);i=k(t,new F(0),dt(e)),n=k(t,new F(0),n);break}case`acosh`:i=rt(e);break;case`asin`:{let t=this._isAbsBiggerThanOne(e);i=k(t,new F(0),Pt(e)),n=k(t,new F(0),n);break}case`asinh`:i=et(e);break;case`atan`:i=Nt(e);break;case`atanh`:{let t=this._isAbsBiggerThanOne(e);i=k(t,new F(0),bt(e)),n=k(t,new F(0),n);break}case`atan2`:i=Nt(e,t);break;case`cos`:i=Tt(e);break;case`cosh`:i=It(e);break;case`sin`:i=Dt(e);break;case`sinh`:i=nt(e);break;case`tan`:i=vt(e);break;case`tanh`:i=Ye(e);break;case`bitwiseand`:i=new F(tt(new O(e),new O(t)));break;case`bitwiseor`:i=new F(wt(new O(e),new O(t)));break;case`bitwiseleftshift`:i=new F(ct(new O(e),new O(t)));break;case`bitwiserightshift`:i=new F(zt(new O(e),new O(t)));break;case`bitwisenot`:i=new F(ut(new O(e)));break;case`bitwisexor`:i=new F(pt(new O(e),new O(t)));break;case`booleanand`:i=w(mt(gt(e,new F(0)),gt(t,new F(0))));break;case`booleanor`:i=w(At(gt(e,new F(0)),gt(t,new F(0))));break;case`booleannot`:i=w(Bt(e,new F(0)));break;case`booleanxor`:i=w(Vt(gt(e,new F(0)),gt(t,new F(0))));break;case`greaterthan`:i=w(Ut(e,t));break;case`greaterthanequal`:i=w(ft(e,t));break;case`lessthan`:i=w(_t(e,t));break;case`lessthanequal`:i=w(yt(e,t));break;case`equalto`:i=w(Bt(e,t));break;case`notequal`:i=w(gt(e,t));break;case`isnull`:i=w(Bt(n,new F(0))),n=new F(1);break;case`setnull`:{let r=w(Bt(e,new F(0)));i=r.multiply(t),n=n.multiply(r);break}default:i=e}return{value:i,alpha:n}}_conditional(e){let{a:t,b:n,c:r,alpha:i}=this._getRasterValues(e),a=new F(C(N(t))),o=A(r,n,a);return this._processResult(o,i)}_isAboveZero(e){return w(Ut(e,new F(0)))}_isAbsBiggerThanOne(e){return Ut(C(e),new F(1))}};y([z],si.prototype,`operationName`,void 0),y([z],si.prototype,`isOutputRounded`,void 0),y([I(oi)],si.prototype,`domainRangeConfig`,void 0);var ci=class extends ri(Q){constructor(){super(...arguments),this.type=`ComputeChangeShader`,this.isOutputRounded=!1}_process(e){let{a:t,b:n,alpha:r}=this._getRasterValues(e),i=t.subtract(n);this.method===`relative-difference`&&(i=i.multiply(X(Qe(C(t),C(n)))));let a=yr(i,this.domainRangeConfig.domainRange),o=new U(i,i,i,r).multiply(a);return this.isOutputRounded?vr(o):o}};y([z],ci.prototype,`method`,void 0),y([z],ci.prototype,`isOutputRounded`,void 0),y([I(oi)],ci.prototype,`domainRangeConfig`,void 0);var li=class extends Z{constructor(){super(...arguments),this.name=`RasterComputeChangeProcessor`,this.type=7,this.shaders={computeChange:new ci}}_process(e,t){let n=e.rasterFunction.parameters,{rasters:r}=n,i={constantCount:this._getConstantCount(r),imageCount:r.length,method:n.method,isOutputRounded:n.isOutputRounded},a={domainRange:n.domainRange},{twoRasterConfig:o}=this._getMultipleInputConfig(t,r),s=this._getCommonConfig(e,t),c={shader:this.shaders.computeChange,uniforms:{config:s,domainRangeConfig:a,twoRasterConfig:o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,c,l.quadMesh)}},ui=class extends G{};y([I(F)],ui.prototype,`contrastOffset`,void 0),y([I(F)],ui.prototype,`brightnessOffset`,void 0);var di=class extends Q{constructor(){super(...arguments),this.type=`ContrastBrightnessShader`}_process(e){let{rgb:t,a:n}=this._getPixel(e),{contrastOffset:r,brightnessOffset:i}=this.contrastBrightnessConfig,a=new F(255),o=new F(128),s=t.multiply(200),c=a.multiply(100),l=a.multiply(2).multiply(i),u=s.subtract(c).add(l),d=Et([Bt(r,new F(-100)),new D(o)],[Bt(r,new F(100)),N(u).add(1).divide(2).multiply(a)],[Ut(r,new F(0)),u.divide(new F(100).subtract(r).multiply(2)).add(o)],[!0,u.multiply(r.add(100)).divide(2e4).add(o)]);return vr(new U(d,n))}};y([I(ui)],di.prototype,`contrastBrightnessConfig`,void 0);var fi=class extends Z{constructor(){super(...arguments),this.name=`RasterContrastBrightnessProcessor`,this.type=8,this.shaders={contrastBrightness:new di}}_process(e,t){let n=this._getCommonConfig(e,t),r=e.rasterFunction.parameters,i={shader:this.shaders.contrastBrightness,uniforms:{config:n,contrastBrightnessConfig:r},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:o}=e;a.submitDrawMesh(o,i,a.quadMesh)}},pi=class extends G{};y([I(Ct.ofType(F,5,5,!0))],pi.prototype,`kernel`,void 0),y([I(q)],pi.prototype,`clampRange`,void 0);var mi=class extends Q{constructor(){super(...arguments),this.type=`ConvolutionShader`,this.rows=3,this.cols=3}_process(e){let{rows:t,cols:n}=this,r=new q(Math.floor(t/2),Math.floor(n/2)),{texture:i,srcImageSize:a}=this.config,o=new F(1).divide(a),{kernel:s}=this.convolutionConfig,c=kt(s,{initialValue:new U(0,0,0,1),xRange:[0,t],yRange:[0,n],callback:(t,n,a,s)=>{let c=new q(new F(a),new F(s)).subtract(r).multiply(o),l=M(i,Y(e.add(c))),u=l.rgb.multiply(n).add(t.rgb),d=l.a.multiply(t.a);return new U(u,d)}}),{clampRange:l}=this.convolutionConfig;return new U(P(c.rgb,l.x,l.y),1).multiply(c.a)}};y([z],mi.prototype,`rows`,void 0),y([z],mi.prototype,`cols`,void 0),y([I(pi)],mi.prototype,`convolutionConfig`,void 0);var hi=class extends Z{constructor(){super(...arguments),this.name=`RasterConvolutionProcessor`,this.type=9,this.shaders={convolution:new mi}}_process(e,t){let n=e.rasterFunction.parameters,r={rows:n.kernelRows,cols:n.kernelCols},i={kernel:[...n.kernel],clampRange:n.clampRange},a=this._getCommonConfig(e,t),o={shader:this.shaders.convolution,uniforms:{config:a,convolutionConfig:i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},gi=class extends G{};y([I(F)],gi.prototype,`zlFactor`,void 0);var _i=class extends Q{constructor(){super(...arguments),this.type=`CurvatureShader`}_process(e){let{texture:t}=this.config,n=fr(t,e,this.config.srcImageSize),r=n[3].add(n[5]).multiply(.5).subtract(n[4]),i=n[1].add(n[7]).multiply(.5).subtract(n[4]),{zlFactor:a}=this.curvatureConfig,{curvatureType:o}=this,s;if(o===`standard`)s=Mt(a).multiply(r.add(i));else{let e=n[2].subtract(n[0]).add(n[6]).subtract(n[8]).divide(4),t=n[5].subtract(n[3]).divide(2),c=n[1].subtract(n[7]).divide(2),l=t.multiply(t),u=c.multiply(c),d=t.multiply(c),f=a.divide(l.add(u));s=o===`profile`?V(new D(r,i,e),new D(l,u,d)).multiply(f):V(new D(r,i,Mt(e)),new D(u,l,d)).multiply(Mt(f))}return new U(s,s,s,n[9])}};y([z],_i.prototype,`curvatureType`,void 0),y([I(gi)],_i.prototype,`curvatureConfig`,void 0);var vi=class extends Z{constructor(){super(...arguments),this.name=`RasterCurvatureProcessor`,this.type=10,this.shaders={curvature:new _i}}_process(e,t){let n=e.rasterFunction.parameters,r={curvatureType:n.curvatureType},i=t.getRasterCellSize(),a={zlFactor:200*n.zFactor/i[0]/i[1]},o=this._getCommonConfig(e,t),s={shader:this.shaders.curvature,uniforms:{config:o,curvatureConfig:a},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:l}=e;c.submitDrawMesh(l,s,c.quadMesh)}},yi=class extends G{};y([I(Ht)],yi.prototype,`bandIndexMat3`,void 0);var bi=class extends Q{constructor(){super(...arguments),this.type=`ExtractBandShader`}_process(e){let t=this._getPixel(e),n=this.extractBandConfig.bandIndexMat3.multiply(t.rgb);return new U(n,t.a)}};y([I(yi)],bi.prototype,`extractBandConfig`,void 0);var xi=class extends Z{constructor(){super(...arguments),this.name=`RasterExtractBandProcessor`,this.type=11,this.shaders={extractBand:new bi}}_process(e,t){let n={bandIndexMat3:e.rasterFunction.parameters.bandIndexMat3},r=this._getCommonConfig(e,t),i={shader:this.shaders.extractBand,uniforms:{config:r,extractBandConfig:n},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:o}=e;a.submitDrawMesh(o,i,a.quadMesh)}},Si=class extends G{};y([I(q)],Si.prototype,`clampRange`,void 0);var Ci=class extends Q{constructor(){super(...arguments),this.type=`FocalStatisticsShader`,this.rows=3,this.cols=3,this.fill=!1}_process(e){let t=this._process1(e),n=L(new F(1),t.a);if(!this.fill)return this._clamp(t.rgb,n);let r=this._getPixel(e),i=A(t.rgb,r.rgb,r.a);return this._clamp(i,n)}_clamp(e,t){let{clampRange:n}=this.focalStatisticsConfig;return new U(P(e,n.x,n.y),1).multiply(t)}_process1(e){let{texture:t,srcImageSize:n}=this.config,{rows:r,cols:i}=this,a=new q(Math.floor(r/2),Math.floor(i/2)),o=new F(1).divide(n),s=this._getPixel(e),{statisticsType:c}=this,l=c===`min`||c===`max`?new U(s.rgb,0):new U(0,0,0,0);switch(c){case`min`:return this._stat(r,i,l,(n,r,i)=>{let s=new q(new F(r),new F(i)).subtract(a).multiply(o),c=M(t,Y(e.add(s))),l=ht(n.rgb,c.rgb);return new U(l,n.a.add(c.a))});case`max`:return this._stat(r,i,l,(n,r,i)=>{let s=new q(new F(r),new F(i)).subtract(a).multiply(o),c=M(t,Y(e.add(s))),l=Qe(n.rgb,c.rgb);return new U(l,n.a.add(c.a))});case`mean`:{let n=this._stat(r,i,l,(n,r,i)=>{let s=new q(new F(r),new F(i)).subtract(a).multiply(o),c=M(t,Y(e.add(s))),l=n.rgb.add(c.rgb.multiply(c.a));return new U(l,n.a.add(c.a))}),s=n.rgb.multiply(X(n.a));return new U(s,n.a)}case`stddev`:{let n=this._stat(r,i,l,(n,r,i)=>{let s=new q(new F(r),new F(i)).subtract(a).multiply(o),c=M(t,Y(e.add(s))),l=n.rgb.add(c.rgb.multiply(c.a));return new U(l,n.a.add(c.a))}),s=this._stat(r,i,l,(n,r,i)=>{let s=new q(new F(r),new F(i)).subtract(a).multiply(o),c=M(t,Y(e.add(s))),l=n.rgb.add(c.a.multiply(c.rgb).multiply(c.rgb));return new U(l,n.a.add(c.a))}),c=X(s.a),u=B(s.subtract(n.multiply(n).multiply(c)).multiply(c));return new U(u.rgb,n.a)}default:return s}}_stat(e=3,t=3,n,r){let i=new O(0).setMutable().setDebugName(`StatColIterator`),a=new O(0).setMutable().setDebugName(`StatRowIterator`),o=n.setMutable().setDebugName(`StatAccumulator`),s=r(o,i,a).setDebugName(`StatPredicate`);return st({iterX:i,iterY:a,accumulator:o},U,s,({out:n,iterX:r,iterY:i,accumulator:a,subgraph:o})=>`\n  for (${i} = 0; ${i} < ${e}; ${i}++) {\n    for (${r} = 0; ${r} < ${t}; ${r}++) {\n  \n    ${o.body}\n  \n    ${a} = ${o.varName};\n    }\n  }\n  ${n} = ${a};\n  `).setDebugName(`statBody`)}};y([z],Ci.prototype,`rows`,void 0),y([z],Ci.prototype,`cols`,void 0),y([z],Ci.prototype,`statisticsType`,void 0),y([z],Ci.prototype,`fill`,void 0),y([I(Si)],Ci.prototype,`focalStatisticsConfig`,void 0);var wi=class extends Z{constructor(){super(...arguments),this.name=`RasterFocalStatisticsProcessor`,this.type=21,this.shaders={focalStatistics:new Ci}}_process(e,t){let n=e.rasterFunction.parameters,r={rows:n.kernelRows,cols:n.kernelCols,statisticsType:n.statisticsType,fill:n.fillNoDataOnly},i={clampRange:n.clampRange},a=this._getCommonConfig(e,t),o={shader:this.shaders.focalStatistics,uniforms:{config:a,focalStatisticsConfig:i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},Ti=class extends G{};y([I(D)],Ti.prototype,`weights`,void 0);var Ei=class extends Q{constructor(){super(...arguments),this.type=`GrayscaleShader`}_process(e){let t=this._getPixel(e),{weights:n}=this.grayscaleConfig,r=V(n,t.rgb);return new U(r,r,r,t.a)}};y([I(Ti)],Ei.prototype,`grayscaleConfig`,void 0);var Di=class extends Z{constructor(){super(...arguments),this.name=`RasterGrayscaleProcessor`,this.type=12,this.shaders={grayscale:new Ei}}_process(e,t){let n={weights:e.rasterFunction.parameters.weights},r=this._getCommonConfig(e,t),i={shader:this.shaders.grayscale,uniforms:{config:r,grayscaleConfig:n},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:a,context:o}=e;a.submitDrawMesh(o,i,a.quadMesh)}},Oi=class extends Q{constructor(){super(...arguments),this.type=`HillshadeShader`,this.isMultidirectional=!1}_process(e){let{texture:t}=this.config,n=fr(t,e,this.config.srcImageSize),r=mr(n,this.hillshadeConfig,this.isMultidirectional);return new U(r.rgb.multiply(255),r.a)}};y([z],Oi.prototype,`isMultidirectional`,void 0),y([I(dr)],Oi.prototype,`hillshadeConfig`,void 0);var ki=class extends Z{constructor(){super(...arguments),this.name=`RasterHillshadeProcessor`,this.type=13,this.shaders={hillshade:new Oi}}_process(e,t){let n=e.rasterFunction.parameters,r={isMultidirectional:n.hillshadeType>0},i=t.getRasterCellSize(),a=gr(n,i),o={...n,factor:a,minValue:0,maxValue:8e3},s=this._getCommonConfig(e,t),c={shader:this.shaders.hillshade,uniforms:{config:s,hillshadeConfig:o},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,c,l.quadMesh)}},Ai=class extends Z{constructor(){super(...arguments),this.name=`RasterLocalProcessor`,this.type=14,this.shaders={local:new si}}_process(e,t){let n=e.rasterFunction.parameters,r={constantCount:this._getConstantCount(n.rasters),imageCount:n.imageCount,operationName:n.operationName,isOutputRounded:n.isOutputRounded},i={domainRange:n.domainRange},a=n.operationName===`conditional`?n.rasters:n.rasters?.slice(0,2),o=this._getMultipleInputConfig(t,a),s=this._getCommonConfig(e,t),c={shader:this.shaders.local,uniforms:{config:s,domainRangeConfig:i,...o},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:u}=e;l.submitDrawMesh(u,c,l.quadMesh)}},ji=class extends G{};y([I(R.ofType(F,6))],ji.prototype,`includedRanges`,void 0),y([I(R.ofType(F,9))],ji.prototype,`noDataValues`,void 0);var Mi=class extends Q{constructor(){super(...arguments),this.type=`MaskShader`,this.isMultiband=!0}_process(e){let t=this._getPixel(e),n=this._computeNoDataFactor(t.r),r=this._computeRangeFactor(t.rgb),i;if(this.isMultiband){let e=this._computeNoDataFactor(t.g),a=this._computeNoDataFactor(t.b),o=new D(n,e,a).multiply(r);i=o.x.multiply(o.y).multiply(o.z)}else i=n.multiply(r.x);return t.multiply(i)}_computeNoDataFactor(e){let{noDataValues:t}=this.maskConfig,n=new D(1);for(let r=0;r<9/3;r++){let i=3*r,a=new D(t[i+0],t[i+1],t[i+2]),o=C(N(a.subtract(e)));n=n.multiply(o)}return n.x.multiply(n.y).multiply(n.z)}_computeRangeFactor(e){let{includedRanges:t}=this.maskConfig,n=new D(t[0],t[2],t[4]),r=new D(t[1],t[3],t[5]);return L(n,e).multiply(L(e,r))}};y([z],Mi.prototype,`isMultiband`,void 0),y([I(ji)],Mi.prototype,`maskConfig`,void 0);var Ni=class extends Z{constructor(){super(...arguments),this.name=`RasterMaskProcessor`,this.type=15,this.shaders={mask:new Mi}}_process(e,t){let n=e.rasterFunction.parameters,r={isMultiband:n.bandCount>1},i={includedRanges:[...n.includedRanges],noDataValues:[...n.noDataValues]},a=this._getCommonConfig(e,t),o={shader:this.shaders.mask,uniforms:{config:a,maskConfig:i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},Pi=class extends G{};y([I(Ht)],Pi.prototype,`bandIndexMat3`,void 0);var Fi=class extends Q{constructor(){super(...arguments),this.type=`NDVIShader`,this.scaled=!0}_process(e){let t=this._getPixel(e),{r:n,g:r}=this.ndviConfig.bandIndexMat3.multiply(t.rgb),i=n.subtract(r),a=n.add(r),o=i.multiply(X(a));if(!this.scaled)return new U(o,o,o,t.a);let s=T(o.multiply(100).add(100.5));return new U(s,s,s,t.a)}};y([z],Fi.prototype,`scaled`,void 0),y([I(Pi)],Fi.prototype,`ndviConfig`,void 0);var Ii=class extends Z{constructor(){super(...arguments),this.name=`RasterNDVIProcessor`,this.type=16,this.shaders={ndvi:new Fi}}_process(e,t){let n=e.rasterFunction.parameters,r={scaled:n.scaled},i={bandIndexMat3:n.bandIndexMat3},a=this._getCommonConfig(e,t),o={shader:this.shaders.ndvi,uniforms:{config:a,ndviConfig:i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},Li=class extends G{};y([I(R.ofType(F,27))],Li.prototype,`rangeMaps`,void 0),y([I(R.ofType(F,18))],Li.prototype,`noDataRanges`,void 0),y([I(F)],Li.prototype,`unmatchMask`,void 0),y([I(F)],Li.prototype,`replacementValue`,void 0),y([I(q)],Li.prototype,`clampRange`,void 0);var Ri=class extends Q{constructor(){super(...arguments),this.type=`RemapShader`}_process(e){let t=this._getPixel(e),{rangeMaps:n,unmatchMask:r,clampRange:i,replacementValue:a}=this.remapConfig,{mapValue:o,includeMask:s}=xr(t.r,n,9),c=this.replaceUnmatched?a:r.multiply(t.r),l=A(c,o,s),u=P(l,i.x,i.y),d=this._computeNoDataFactor(t.rrr).multiply(Qe(r,s));return new U(u,u,u,t.a).multiply(d)}_computeNoDataFactor(e){let{noDataRanges:t}=this.remapConfig,n=new D(0,0,0);for(let r=0;r<9/3;r++){let i=6*r,a=new D(t[i],t[i+2],t[i+4]),o=new D(t[i+1],t[i+3],t[i+5]);n=n.add(L(a,e).multiply(L(e,o)))}return $t(N(V(n,new D(1,1,1))))}};y([I(Li)],Ri.prototype,`remapConfig`,void 0),y([z],Ri.prototype,`replaceUnmatched`,void 0);var zi=class extends Z{constructor(){super(...arguments),this.name=`RasterRemapProcessor`,this.type=17,this.shaders={remap:new Ri}}_process(e,t){let n=e.rasterFunction.parameters,r={replaceUnmatched:n.allowUnmatched&&n.replacementValue!=null},i={rangeMaps:[...n.rangeMaps],noDataRanges:[...n.noDataRanges],unmatchMask:n.allowUnmatched?1:0,replacementValue:n.replacementValue??0,clampRange:n.clampRange},a=this._getCommonConfig(e,t),o={shader:this.shaders.remap,uniforms:{config:a,remapConfig:i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},Bi=class extends J{constructor(){super(...arguments),this.type=`ReprojectShader`}_colorize(e){return this._getPixel(e)}},Vi=class extends Z{constructor(){super(...arguments),this.name=`RasterReprojectProcessor`,this.type=18,this.shaders={reproject:new Bi}}_process(e,t){let n=e.rasterFunction.parameters,r=this._getInterpolationDefines(t.interpolation,!!n.requireNNEdge),{config:i,projectionConfig:a,projectionDefines:o}=this._getReprojectConfig(t),s={shader:this.shaders.reproject,uniforms:{config:i,projectionConfig:a},defines:{...o,...r,applyPixelMask:!1,applyPixelHighlights:!1},optionalAttributes:null,useComputeBuffer:!1},{interpolation:c}=t;t.interpolation=`nearest`;let{painter:l,context:u}=e;l.submitDrawMesh(u,s,l.quadMesh),t.interpolation=c,t.projected=!0}_getReprojectConfig(e){let{source:t}=e,{names:n,textures:r}=e.getTextures({forProcessing:!0}),i={texture:{texture:r[n.indexOf(`u_image`)],unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:[t.width,t.height],opacity:1},a=r[n.indexOf(`u_transformGrid`)],{transformGrid:o}=e,s=!(!a||!o);return{config:i,projectionConfig:s?{transformTexture:{texture:a,unit:1},targetImageSize:[e.width,e.height],transformSpacing:o.spacing,transformGridSize:o.size}:void 0,projectionDefines:{applyProjection:s,lookupProjection:s&&o.spacing[0]===1}}}_getInterpolationDefines(e,t){let n=e===`bilinear`&&t;return{bilinear:n,bicubic:e===`cubic`,nearestOnEdge:n}}},Hi=class extends Oi{constructor(){super(...arguments),this.type=`ShadedReliefShader`}_process(e){let t=super._process(e),{minValue:n,maxValue:r}=this.hillshadeConfig,i=this._getPixel(e),a=r.subtract(n),o=i.r.subtract(n),s=P(o.divide(a),new F(0),new F(1)),c=sr(new U(s,s,s,1),new F(255),this.colormapConfig),l=lr(c.xyz),u=ur(new D(l.xy,t.x.divide(255))).multiply(255);return new U(u,c.a.multiply(t.a))}};y([I(or)],Hi.prototype,`colormapConfig`,void 0);var Ui=class extends Z{constructor(){super(...arguments),this.name=`RasterShadedReliefProcessor`,this.type=19,this.shaders={shadedRelief:new Hi}}_process(e,t,n){let r=e.rasterFunction.parameters,i={isMultidirectional:r.hillshadeType>0},a=t.getRasterCellSize(),o=gr(r,a),s={...r,factor:o},c={colormapTexture:{texture:n,unit:1},colormapOffset:r.offset,colormapMaxIndex:r.indexedColormap.length/4-1},l=this._getCommonConfig(e,t),u={shader:this.shaders.shadedRelief,uniforms:{config:l,hillshadeConfig:s,colormapConfig:c},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:d,context:f}=e;d.submitDrawMesh(f,u,d.quadMesh)}},Wi=class extends G{};y([I(F)],Wi.prototype,`pixelSizePower`,void 0),y([I(F)],Wi.prototype,`pixelSizeFactor`,void 0),y([I(F)],Wi.prototype,`zFactor`,void 0),y([I(q)],Wi.prototype,`cellSize`,void 0);var Gi=class extends Q{constructor(){super(...arguments),this.type=`SlopeShader`,this.isOutputRounded=!1,this.percentRise=!1}_process(e){let{cellSize:t,pixelSizePower:n,pixelSizeFactor:r,zFactor:i}=this.slopeConfig,a=it(t,new q(n)).multiply(r).add(i).divide(t.multiply(8)),{texture:o}=this.config,s=fr(o,e,this.config.srcImageSize),{x:c,y:l}=pr(s,a),u=B(c.multiply(c).add(l.multiply(l))),d=this.percentRise?u.multiply(100):Nt(u).multiply(57.2957795),f=new U(d,d,d,s[9]);return this.isOutputRounded?vr(f):f}};y([z],Gi.prototype,`isOutputRounded`,void 0),y([z],Gi.prototype,`percentRise`,void 0),y([I(Wi)],Gi.prototype,`slopeConfig`,void 0);var Ki=class extends Z{constructor(){super(...arguments),this.name=`RasterSlopeProcessor`,this.type=20,this.shaders={slope:new Gi}}_process(e,t){let n=e.rasterFunction.parameters,r={isOutputRounded:n.isOutputRounded,percentRise:n.slopeType===`percent-rise`},i={cellSize:t.getRasterCellSize(),pixelSizePower:n.slopeType===`adjusted`?n.pixelSizePower:0,pixelSizeFactor:n.slopeType===`adjusted`?n.pixelSizeFactor:0,zFactor:n.zFactor},a=this._getCommonConfig(e,t),o={shader:this.shaders.slope,uniforms:{config:a,slopeConfig:i},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:s,context:c}=e;s.submitDrawMesh(c,o,s.quadMesh)}},qi=class extends Q{constructor(){super(...arguments),this.type=`StretchShader`,this.isMultiband=!0,this.isOutputRounded=!1,this.useGamma=!1}_process(e){let t=this._getPixel(e),n=Er(t,this.stretchConfig,this.useGamma,1);return this.isMultiband||(n=new U(n.rrr,n.a)),this.isOutputRounded?vr(n):n}};y([z],qi.prototype,`isMultiband`,void 0),y([z],qi.prototype,`isOutputRounded`,void 0),y([z],qi.prototype,`useGamma`,void 0),y([I(Sr)],qi.prototype,`stretchConfig`,void 0);var Ji=class extends Z{constructor(){super(...arguments),this.name=`RasterStretchProcessor`,this.type=22,this.shaders={stretch:new qi}}_process(e,t){let n=e.rasterFunction.parameters,r={isMultiband:n.bandCount>1,isOutputRounded:n.isOutputRounded,useGamma:n.useGamma},i=this._getCommonConfig(e,t),a={shader:this.shaders.stretch,uniforms:{config:i,stretchConfig:n},defines:r,optionalAttributes:null,useComputeBuffer:!1},{painter:o,context:s}=e;o.submitDrawMesh(s,a,o.quadMesh)}},Yi=new Map([[`Aspect`,Jr],[`BandArithmetic`,Qr],[`ColormapToRGB`,ei],[`CompositeBand`,ai],[`ComputeChange`,li],[`ContrastBrightness`,fi],[`Convolution`,hi],[`Curvature`,vi],[`ExtractBand`,xi],[`Grayscale`,Di],[`Hillshade`,ki],[`Local`,Ai],[`Mask`,Ni],[`NDVI`,Ii],[`Remap`,zi],[`Reproject`,Vi],[`ShadedRelief`,Ui],[`Slope`,Ki],[`Statistics`,wi],[`Stretch`,Ji]]),Xi=class extends at{constructor(){super(...arguments),this.type=1,this.shaders={},this._techniques=new Map}shutdown(e){super.shutdown(e),this._fbo?.dispose(),this._fbo=void 0;for(let e of this._techniques.values())e.shutdown();this._techniques.clear()}render(e,t){this._fbo??=Wn(e.context,512,512);let{name:n}=e.rasterFunction;if(n===`Arithmetic`&&(n=`Local`),!this._techniques.has(n)){let e=Yi.get(n);if(!e)return;this._techniques.set(n,new e)}this._techniques.get(n).render(e,{...t,processorFbo:this._fbo})}},Zi=class extends Zt{constructor(){super(...arguments),this.isCustomTilingScheme=!1}get pixelHighlights(){return this._pixelHighlights}set pixelHighlights(e){this._pixelHighlights=e,this.children.forEach(({bitmap:e})=>e.highlightTexture=null),this.requestRender()}createTile(e){let t=this._getTileBounds(e),[n,r]=this.tileInfoView.tileInfo.size,i=this.tileInfoView.getTileResolution(e.level);return new hn(e,i,t[0],t[3],n,r)}onAttach(){super.onAttach(),this._colorizerTechnique=new jr,this._processorTechnique=new Xi,this._highlightTechnique=new Br}onDetach(){super.onDetach(),this._colorizerTechnique?.shutdown(),this._colorizerTechnique=void 0,this._processorTechnique?.shutdown(),this._processorTechnique=void 0,this._highlightTechnique?.shutdown(),this._highlightTechnique=void 0}doRender(e){if(!this.visible||e.drawPhase!==1||!this._colorizerTechnique)return;let{rasterFunctionChain:t}=this;if(t?.functions?.length){if(!this._processorTechnique)return;let{functions:n,hasBranches:r}=t;for(let t of n){if(t.name===`Constant`||t.name===`Identity`)continue;e.rasterFunction=t,e.hasBranches=r,super.doRender(e);let n=this.children.map(e=>e.bitmap);this._processorTechnique.render(e,{bitmaps:n})}}if(this._pixelHighlights?.length&&this._highlightTechnique)for(let t of this._pixelHighlights){e.pixelHighlightOptions=t,super.doRender(e);let n=this.children.map(e=>e.bitmap);this._highlightTechnique.render(e,{bitmaps:n})}e.rasterFunction=null,e.pixelHighlightOptions=void 0,super.doRender(e);let n=this.children.map(e=>e.bitmap);this._colorizerTechnique.render(e,{bitmaps:n})}_getTileBounds(e){let t=this.tileInfoView.getTileBounds(be(),e);if(this.isCustomTilingScheme&&e.world){let{tileInfo:n}=this.tileInfoView,r=me(n.spatialReference);if(r){let i=n.lodAt(e.level);if(!i)return t;let{resolution:a}=i,o=a*n.size[0];t[0]=r*e.world+n.origin.x+e.col*o,t[2]=t[0]+o}}return t}},Qi=[0,0],$=class extends ie{constructor(){super(...arguments),this._updatingHandles=new ge,this._emptyTilePixelBlock=null,this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=[],this.previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._isCustomTilingScheme=!1,this._maxIndexedColormapSize=0,this._rasterFunctionState=`na`,this._globalUpdateRequested=!1,this.attached=!1,this.timeExtent=null,this.redrawOrRefetch=s(async(e={})=>{let t=this._rasterFunctionState,n=e.reprocess||t===`gpu`&&!this.canUseWebGLForProcessing||t===`cpu`&&this.canUseWebGLForProcessing;if(n&&(await this._updatingHandles.addPromise(this.layer.updateRasterFunction()),this.updateRasterFunctionParameters()),!this.previousLOD||this.layerView.suspended)return;let r=this._rasterFunctionState,{type:i}=this;return e.refetch||i!==`raster`&&n||r===`cpu`||t===`cpu`?this._updatingHandles.addPromise(this.doRefresh()):this._updatingHandles.addPromise(this._redrawImage(e.signal))})}destroy(){this._updatingHandles.destroy()}get canUseWebGLForProcessing(){return!1}get canUseLocalSymbolizerParams(){return(this.canUseWebGLForProcessing||this.type===`rasterVF`)&&!this.layerView.hasTilingEffects}get isCPUBasedDRA(){let{renderer:e}=this.layer;return e?.type===`raster-stretch`&&e.dynamicRangeAdjustment&&(!this.canUseWebGLForProcessing||!(e.stretchType===`min-max`||e.stretchType===`standard-deviation`))}get useWebGLForProcessing(){return this._get(`useWebGLForProcessing`)??!0}set useWebGLForProcessing(e){this._set(`useWebGLForProcessing`,e)}get useProgressiveUpdate(){return this._get(`useProgressiveUpdate`)??!0}set useProgressiveUpdate(e){if(this._tileStrategy&&this.useProgressiveUpdate!==e){this._tileStrategy.destroy(),this.container.removeAllChildren();let t=this._getCacheSize(e);this._tileStrategy=new _({cachePolicy:`purge`,acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),cacheSize:t,tileInfoView:this._tileInfoView}),this._set(`useProgressiveUpdate`,e),this.layerView.requestUpdate()}}update(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume();let{extent:t,resolution:n,scale:r}=e.state,i=this._tileInfoView.getClosestInfoForScale(r);if(this.layer.raster){if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){let e=this._srcResolutions[i.level],r=`toJSON`in t?t:oe.fromJSON(t);Re(this._blockCacheRegistryUrl,this._blockCacheRegistryId,r,n,e,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,this.previousLOD?.level!==i.level&&(this.previousLOD=i,this._symbolizerParams!=null&&this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}}moveEnd(){!this.isCPUBasedDRA&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,this._fetchQueue.length===0&&this._redrawImage(this._abortController.signal).then(()=>{this._globalUpdateRequested=!1,this.layerView.requestUpdate()}));let e=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(e),this.layerView.requestUpdate()}get updating(){return this._globalUpdateRequested||this._updatingHandles?.updating}attach(){this._maxIndexedColormapSize=4*(h().maxTextureSize||4096),this._initializeTileInfo(),this._tileInfoView=new e(this.layerView.tileInfo,this.layerView.fullExtent);let t=this._computeFetchConcurrency();this._fetchQueue=new re({tileInfoView:this._tileInfoView,concurrency:t,process:(e,t)=>this._fetchTile(e,t),priority:g.MAPVIEW_FETCH_QUEUE,scheduler:this.scheduler});let n=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new _({cachePolicy:`purge`,acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),cacheSize:n,tileInfoView:this._tileInfoView}),this._updateBlockCacheRegistry()}detach(){this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,Be(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryUrl=this._blockCacheRegistryId=null}acquireTile(e){let t=this.container.createTile(e);return this._updatingHandles.addPromise(this._enqueueTileFetch(t)),this.layerView.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.isCPUBasedDRA||!this.useProgressiveUpdate,t}releaseTile(e){this._fetchQueue.abort(e.key.id),this.container.removeChild(e),e.once(`detach`,()=>{e.destroy(),this.layerView.requestUpdate()}),this.layerView.requestUpdate()}createEmptyTilePixelBlock(e=null){let t=e==null||e.join(`,`)===this._tileInfoView.tileInfo.size.join(`,`);if(t&&this._emptyTilePixelBlock!=null)return this._emptyTilePixelBlock;e||=this._tileInfoView.tileInfo.size;let[n,r]=e,i=new Ae({width:n,height:r,pixels:[new Uint8Array(n*r)],mask:new Uint8Array(n*r),pixelType:`u8`});return t&&(this._emptyTilePixelBlock=i),i}_getBandIds(){if(this.container&&(!(`rasterFunctionChain`in this.container)||!this.container.rasterFunctionChain))return this.layer.bandIds;let{bandIds:e,raster:t}=this.layer,n=`rasterFunction`in t?t.rasterFunction.rawInputBandIds:null;return e?.length&&n?.length&&t.rasterInfo.bandCount!==1?e.map(e=>n[Math.min(e,n.length-1)]):`rasterFunction`in t?n:e}updateRasterFunctionParameters(){}_fetchTile(e,t){let n=this._getFetchOptions(e.level,t.signal);return this.fetchTile(e,n)}_getFetchOptions(e,t){let{canUseWebGLForProcessing:n}=this,{layerView:r}=this,{tileInfo:i}=r,a=!i.isWrappable&&Ge(r.view.spatialReference)!=null,o=n&&this.layer.raster.hasUniqueSourceStorageInfo,{layer:s}=this.layerView,c=s.serviceRasterInfo?.storageInfo.isBsqTile?s.getRawDisplayBandIds():void 0;return{allowPartialFill:!0,datumTransformation:r.datumTransformation,interpolation:n?`nearest`:this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:o,skipRasterFunction:this.type===`raster`&&this.container.rasterFunctionChain!=null,signal:t,srcResolution:this._srcResolutions[e],timeExtent:r.timeExtent,tileInfo:i,bandIds:c,disableWrapAround:a}}_getCacheSize(e){return e?40:0}_initializeTileInfo(){let{layerView:e}=this,t=e.view.spatialReference;if(this._canUseLayerLODs()){let{origin:n,lods:r}=this.layer.tileInfo,i=r.map(({scale:e})=>e),a=Ee.create({spatialReference:t,size:512,scales:i,origin:n});e.set(`tileInfo`,a),this._srcResolutions=r.map(({resolution:e})=>({x:e,y:e}));return}let{scales:n,srcResolutions:r,isCustomTilingScheme:i}=Ve(this.layer.serviceRasterInfo,t,{tileSize:512,alignGlobalDatasetWithAGOL:!0,limitToSrcResolution:!1}),a=Ee.create({spatialReference:t,size:512,scales:n}),o=a.origin.x===0;fe(e.fullExtent);let{xmin:s,ymax:c}=e.fullExtent;(o||i&&a.origin.x>s)&&(a.origin=new ve({x:s,y:c,spatialReference:t})),this._isCustomTilingScheme=i,e.set(`tileInfo`,a),this._srcResolutions=r??[]}_canUseLayerLODs(){let{layer:e,layerView:t}=this;if(e.raster.tileType!==`Map`)return!1;let{lods:n}=e.tileInfo,r=t.view.constraints?.effectiveLODs;return r?.length===n.length&&r.every(({scale:e},t)=>Math.abs(e-n[t].scale)<.001)}_computeFetchConcurrency(){let{blockBoundary:e}=this.layer.serviceRasterInfo.storageInfo,t=e[e.length-1];return(t.maxCol-t.minCol+1)*(t.maxRow-t.minRow+1)>64?2:10}async _enqueueTileFetch(e,t){if(!this._fetchQueue.has(e.key.id)){try{let t=e.once(`detach`,()=>t=void 0),n=await this._fetchQueue.push(e.key),r=this._getBandIds(),i=!this.useProgressiveUpdate||this.isCPUBasedDRA&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.layerView.moving&&this._fetchQueue.length===0){i=!1;try{await this._redrawImage(this._abortController?.signal)}catch(e){ye(e)&&xe.getLogger(this).error(e)}this._globalUpdateRequested=!1}if(!t)return;this.canUseLocalSymbolizerParams&&this._symbolizerParams==null&&this._updateSymbolizerParams();let a=this._tileInfoView.getTileCoords(Qi,e.key),o=this._tileInfoView.getTileResolution(e.key);await this.updateTileSource(e,{source:n,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:i,bandIds:r,coords:a,resolution:o}),t&&(e.once(`attach`,()=>this.layerView.requestUpdate()),this.container.addChild(e),t.remove())}catch(e){ye(e)||xe.getLogger(this).error(e)}this.layerView.requestUpdate()}}async _redrawImage(e){if(!this.attached||this.container.children.length===0||(await this.layer.updateRenderer(),this.isCPUBasedDRA?await this._updateGlobalSymbolizerParams(e):(this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._globalSymbolizerParams=null),!this.attached||e?.aborted))return;let t=this.container.children.map(async t=>this.updateTileSymbolizerParameters(t,{local:this._symbolizerParams,global:this._globalSymbolizerParams},e));await Promise.allSettled(t),this.attached&&!e?.aborted&&this.container.requestRender()}async _updateGlobalSymbolizerParams(e){let t=this._getFetchOptions(this.previousLOD.level,e),n=await this.layer.fetchPixels(this.layerView.view.extent,this.layerView.view.width,this.layerView.view.height,{...t,interpolation:`nearest`,requestRawData:!1,skipRasterFunction:!1});if(!n?.pixelBlock)return;let{resolution:r}=this.previousLOD,{isBsqTile:i}=this.layer.raster.rasterInfo.storageInfo,a=i?null:this._getBandIds(),o=this.layer.symbolizer.generateWebGLParameters({pixelBlock:n.pixelBlock.extractBands(a),isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:r,y:r},bandIds:a});!this.canUseWebGLForProcessing&&o&&o.type===`stretch`&&this.layer.renderer?.type===`raster-stretch`&&(o.factor=o.factor.map(e=>255*e),o.minOutput=Math.round(255*o.minOutput),o.maxOutput=Math.round(255*o.maxOutput)),this._globalSymbolizerParams=o}_updateSymbolizerParams(){let{resolution:e}=this.previousLOD,t=this._getBandIds();this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:t})}_updateBlockCacheRegistry(e=!1){let{layer:t,layerView:n}=this,{raster:r}=t,{multidimensionalDefinition:i}=t.normalizeRasterFetchOptions({multidimensionalDefinition:t.multidimensionalDefinition,timeExtent:n.timeExtent}),a=r.rasterInfo.multidimensionalInfo?r.getSliceIndex(i):null,o=r.rasterInfo.storageInfo.isBsqTile?t.getRawDisplayBandIds():null,s=Le(r.rasterId,a,o);if(s!==this._blockCacheRegistryUrl){if(this._blockCacheRegistryUrl!=null&&Be(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=ze(s,r.rasterInfo),e){let{view:e}=n,t=this._tileInfoView.getClosestInfoForScale(e.scale),i=this._srcResolutions[t.level];Re(s,this._blockCacheRegistryId,e.extent,e.resolution,i,r.ioConfig.sampling)}this._blockCacheRegistryUrl=s}}async doRefresh(){if(!this.attached||!this.previousLOD||this.layerView.suspended)return;await this.layer.updateRenderer(),this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();let e=[];this._globalUpdateRequested=this.isCPUBasedDRA||!this.useProgressiveUpdate,this._tileStrategy.refresh(t=>e.push(this._enqueueTileFetch(t))),await this._updatingHandles.addPromise(Promise.allSettled(e))}};y([i()],$.prototype,`_globalUpdateRequested`,void 0),y([i()],$.prototype,`attached`,void 0),y([i()],$.prototype,`canUseWebGLForProcessing`,null),y([i()],$.prototype,`canUseLocalSymbolizerParams`,null),y([i()],$.prototype,`isCPUBasedDRA`,null),y([i()],$.prototype,`container`,void 0),y([i()],$.prototype,`layer`,void 0),y([i()],$.prototype,`layerView`,void 0),y([i()],$.prototype,`scheduler`,void 0),y([i()],$.prototype,`type`,void 0),y([i()],$.prototype,`useWebGLForProcessing`,null),y([i()],$.prototype,`useProgressiveUpdate`,null),y([i()],$.prototype,`timeExtent`,void 0),y([i()],$.prototype,`updating`,null),$=y([u(`esri.views.2d.layers.imagery.BaseImageryTileSubView2D`)],$);var $i=[1024,1024],ea=class extends ${constructor(){super(...arguments),this.type=`raster`}get canUseWebGLForProcessing(){let{loaded:e,symbolizer:t}=this.layer;if(!e||!t)return!1;let n=t.lookup.colormapLut?.indexedColormap,r=n&&n.length>this._maxIndexedColormapSize,i=ke(this.layer.serviceRasterInfo);return!(he(`ios`)&&i>4)&&this.useWebGLForProcessing&&t.canRenderInWebGL&&!r&&!(this.layer.interpolation===`majority`&&le(this.layer))}attach(){super.attach(),this.container=new Zi(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this.updateRasterFunctionParameters()}detach(){super.detach(),this.container.removeAllChildren(),this.container=null}fetchTile(e,t){return this.layer.fetchTile(e.level,e.row,e.col,t)}updateRasterFunctionParameters(){let{raster:e,type:t}=this.layer,{container:n}=this;if(e.datasetFormat!==`Function`||t===`wcs`)return n.rasterFunctionChain=null,n.children.forEach(e=>{let{bitmap:t}=e;t&&(t.suspended=!0,t.processed=!1,t.projected&&(t.invalidateTexture(),t.rasterTexture=null))}),void(this._rasterFunctionState=`na`);let r=this._rasterFunctionState,{rasterFunction:i,primaryRasters:a}=e,o=i.supportsGPU&&(!a||a.rasters.length<=1),s=o?i.flatWebGLFunctionChain:null,{renderer:c}=this.layer;n.rasterFunctionChain=!o||!s?.functions.length||c?.type===`raster-stretch`&&c.dynamicRangeAdjustment||!this.canUseWebGLForProcessing?null:this._addProjection(s);let l=i==null?`na`:n.rasterFunctionChain?`gpu`:`cpu`,u=r===l||r===`na`&&l===`cpu`&&s?.functions?.length===0;n.children.forEach(e=>{let{bitmap:t}=e;t&&(t.suspended=!u,t.processed=!1,t.processedTexture=null)}),this._rasterFunctionState=l}async updateTileSource(e,t){let n=this._getBandIds(),r=this._getLayerInterpolation(),{canUseWebGLForProcessing:i}=this,{source:a,globalSymbolizerParams:o,suspended:s,coords:c,resolution:l}=t,u=this.isCPUBasedDRA?o:t.symbolizerParams,{bitmap:d}=e;if([d.x,d.y]=c,d.resolution=l,a?.pixelBlock!=null){let e={extent:a.extent,pixelBlock:a.pixelBlock,srcPixelSize:a.srcTilePixelSize};d.rawPixelData=e,i?(d.source=a.pixelBlock,d.isRendereredSource=!1):(d.source=await this.layer.applyRenderer(e,o?.type===`stretch`?o:void 0),d.isRendereredSource=!0),d.symbolizerParameters=i?u:null,d.transformGrid=i?a.transformGrid:null}else d.source=this.createEmptyTilePixelBlock(),d.symbolizerParameters=i?u:null,d.transformGrid=null;let{isBsqTile:f}=this.layer.raster.rasterInfo.storageInfo;d.bandIds=i&&!f?n:null,d.width=this._tileInfoView.tileInfo.size[0],d.height=this._tileInfoView.tileInfo.size[1],d.interpolation=r,d.suspended=s;let{raster:p}=this.layer;if(Ie(p)){let t=p.getClippingGeometry(this.layerView.view.spatialReference);if(t){let n=p.getTileExtentFromTileInfo(e.key.level,e.key.row,e.key.col,this._tileInfoView.tileInfo);n&&(d.mask=Ke({srcExtent:n,geometry:t,size:[d.width,d.height]}))}}d.invalidateTexture()}async updateTileSymbolizerParameters(e,t,n){let{local:r,global:i}=t,a=this._getBandIds(),o=this._getLayerInterpolation(),{canUseWebGLForProcessing:s}=this,{bitmap:c}=e,{rawPixelData:l}=c;s||l==null?(c.isRendereredSource&&l!=null&&(c.source=l.pixelBlock),c.isRendereredSource=!1):(c.source=await this.layer.applyRenderer(l,i?.type===`stretch`?i:void 0,{signal:n}),c.isRendereredSource=!0),c.symbolizerParameters=s?this.layerView.hasTilingEffects?i:r:null;let{isBsqTile:u}=this.layer.raster.rasterInfo.storageInfo;c.bandIds=s&&!u?a:null,c.interpolation=o,c.suspended=!1}updateHighlightOptions(e){if(!e.length)return void(this.container.pixelHighlights=void 0);let t=[],{highlights:n}=this.layerView.view;e.sort((e,t)=>n.findIndex(({name:e})=>e===nn(t.options))-n.findIndex(({name:t})=>t===nn(e.options)));for(let{target:r,options:i}of e){let{pixelRanges:e}=r,a=nn(i),o=(n.find(e=>e.name===a)?.color??l).toUnitRGBA();if(Array.isArray(e)){let n=Array.from({length:18},()=>0);for(let t=0;t<e.length;t++)n[2*t]=e[t][0],n[2*t+1]=e[t][1];for(let t=e.length;t<9;t++)n[2*t]=Se,n[2*t+1]=-Se;let i=r.bandId??0;t.push({ranges:n,bandId:i,color:o,type:`single-band`})}else{let n=e.type===`extent`?e:e.extent;if(!n)continue;let i=[n.xmin,n.xmax],a=[n.ymin,n.ymax],{xBandId:s,yBandId:c}=r,l={xRange:i,yRange:a,bandIds:[s,c],color:o,type:`xy-band`};e.type===`polygon`&&(l.maskSize=$i,l.mask=Ke({srcExtent:n,geometry:e,size:$i})),t.push(l)}}this.container.pixelHighlights=t}_getLayerInterpolation(){let{interpolation:e,renderer:t}=this.layer;if(!t)return e;let n=t.type;return n===`raster-colormap`||n===`unique-value`?`nearest`:t.type===`raster-stretch`&&t.colorRamp!=null?e===`bilinear`||e===`cubic`?`bilinear`:`nearest`:e}_addProjection(e){return e?.functions?.length&&!e.hasFocalFunction&&e.functions.unshift({name:`Reproject`,parameters:{targetImageSize:this._tileInfoView.tileInfo.size,requireNNEdge:e.isSourceSingleBand},pixelType:`f32`,id:0,isNoopProcess:!1}),e}};y([i()],ea.prototype,`canUseWebGLForProcessing`,null),y([i()],ea.prototype,`container`,void 0),y([i()],ea.prototype,`layer`,void 0),y([i()],ea.prototype,`type`,void 0),ea=y([u(`esri.views.2d.layers.imagery.ImageryTileView2D`)],ea);var ta=class extends qe{constructor(e,t,n,r,i,a,o=null){super(e,t,n,r,i,a),this.tileData=new on(o),this.tileData.coordScale=[i,a],this.tileData.once(`isReady`,()=>this.ready())}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(e){this.tileData.stencilRef=e}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{displayViewScreenMat3:v(),tileMat3:v()}}setTransform(e){super.setTransform(e);let t=this.resolution/(e.resolution*e.pixelRatio),n=this.transforms.tileMat3,[r,i]=this.tileData.offset,a=[this.x+r*this.resolution,this.y-i*this.resolution],[s,l]=e.toScreenNoRotation([0,0],a),{symbolTileSize:u}=this.tileData.symbolizerParameters,d=Math.round((this.width-this.tileData.offset[0])/u)*u,f=Math.round((this.height-this.tileData.offset[1])/u)*u,p=d/this.rangeX*t,m=f/this.rangeY*t;c(n,p,0,0,0,m,0,s,l,1),o(this.transforms.displayViewScreenMat3,e.displayViewMat3,n),this.tileData.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}},na=class extends Zt{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=[`triangle`]}createTile(e){let t=this.tileInfoView.getTileBounds(be(),e),[n,r]=this.tileInfoView.tileInfo.size,i=this.tileInfoView.getTileResolution(e.level);return new ta(e,i,t[0],t[3],n,r)}prepareRenderPasses(e){let t=e.registerRenderPass({name:`imagery (vf tile)`,brushes:[rn],target:()=>this.children.map(e=>e.tileData),drawPhase:1});return[...super.prepareRenderPasses(e),t]}doRender(e){this.visible&&e.drawPhase===1&&this.symbolTypes.forEach(t=>{e.renderPass=t,super.doRender(e)})}},ra=class extends ${constructor(){super(...arguments),this._handle=null,this.type=`rasterVF`}async fetchTile(e,t){t={...t,interpolation:`nearest`,requestProjectedLocalDirections:!0};let n=await this.layer.fetchTile(e.level,e.row,e.col,t);return this.layer.serviceRasterInfo?.dataType===`vector-magdir`&&n?.pixelBlock&&(n.pixelBlock=await this.layer.convertVectorFieldData(n.pixelBlock,`vector-magdir`,t)),n}updateTileSource(e,t){let n=t.symbolizerParams,{tileData:r}=e;r.key=e.key,r.width=this._tileInfoView.tileInfo.size[0],r.height=this._tileInfoView.tileInfo.size[1];let{symbolTileSize:i}=n,{source:a}=t;if(r.offset=this._getTileSymbolOffset(r.key,i),a?.pixelBlock!=null)r.rawPixelData={extent:a.extent,pixelBlock:a.pixelBlock},r.symbolizerParameters=n,r.source=this._sampleVectorFieldData(a.pixelBlock,n,r.offset);else{let e=[Math.round((this._tileInfoView.tileInfo.size[0]-r.offset[0])/i),Math.round((this._tileInfoView.tileInfo.size[1]-r.offset[1])/i)];r.source=this.createEmptyTilePixelBlock(e),r.symbolizerParameters=n}return r.invalidateVAO(),Promise.resolve()}updateTileSymbolizerParameters(e,t){let n=t.local,{symbolTileSize:r}=n,{tileData:i}=e;i.offset=this._getTileSymbolOffset(i.key,r);let a=i.symbolizerParameters.symbolTileSize;i.symbolizerParameters=n;let o=i.rawPixelData?.pixelBlock;return o!=null&&a!==r&&(i.source=this._sampleVectorFieldData(o,i.symbolizerParameters,i.offset)),Promise.resolve()}attach(){super.attach(),this.container=new na(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=pe(()=>this.layer.renderer,e=>this._updateSymbolType(e))}detach(){super.detach(),this.container.removeAllChildren(),this._handle?.remove(),this._handle=null,this.container=null}_getTileSymbolOffset(e,t){let n=e.col*this._tileInfoView.tileInfo.size[0]%t,r=e.row*this._tileInfoView.tileInfo.size[1]%t;return[n>t/2?t-n:-n,r>t/2?t-r:-r]}_sampleVectorFieldData(e,t,n){let{symbolTileSize:r}=t;return Me(e,`vector-uv`,r,n)}_updateSymbolType(e){e?.type===`vector-field`&&(this.container.symbolTypes=e.style===`wind-barb`?[`scalar`,`triangle`]:e.style===`simple-scalar`?[`scalar`]:[`triangle`])}};y([i()],ra.prototype,`container`,void 0),y([i()],ra.prototype,`layer`,void 0),y([i()],ra.prototype,`type`,void 0),ra=y([u(`esri.views.2d.layers.imagery.VectorFieldTileView2D`)],ra);var ia=e=>{let t=e,r=class extends t{constructor(...e){super(...e),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){return Xt(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}get hasTilingEffects(){let{renderer:e}=this.layer;return!!(e?.type===`raster-stretch`&&e.dynamicRangeAdjustment&&!(e.stretchType===`min-max`||e.stretchType===`standard-deviation`))}get datumTransformation(){try{return this.layer.loaded?He(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(e){try{return!this.layer.loaded||!!We(this.layer.serviceRasterInfo,e)}catch{return!1}}async fetchPopupFeaturesAtLocation(e,t){let{layer:r}=this;if(!e)throw new n(`imageryTileLayerView:fetchPopupFeatures`,`Nothing to fetch without area`,{layer:r});let{popupEnabled:i}=r,a=De(r,t);if(!i||a==null)return[];let o=[],{value:s,magdirValue:c,processedValue:l}=await r.identify(e,{timeExtent:this.timeExtent,signal:t?.signal}),u=``;if(s?.length){u=r.type===`imagery-tile`&&r.hasStandardTime()&&s[0]!=null?s.map(e=>r.getStandardTimeValue(e)).join(`, `):s.join(`, `);let e={ObjectId:0};e[Ne.servicePixelValue]=r.type===`imagery-tile`&&Ie(r.raster)?l?.join(`, `):u,e[Ne.rawServicePixelValue]=u;let t=r.raster?.rasterInfo??r.serviceRasterInfo,n=t?.attributeTable;if(n!=null){let{fields:t,features:r}=n,i=t.find(({name:e})=>e.toLowerCase()===`value`),a=e[Ne.servicePixelValue],o=i?r.find(e=>String(e.attributes[i.name])===a):null;if(o)for(let t in o.attributes)o.attributes.hasOwnProperty(t)&&(e[Fe+t]=o.attributes[t])}let i=t?.dataType;i!==`vector-magdir`&&i!==`vector-uv`||(e[Ne.magnitude]=c?.[0],e[Ne.direction]=c?.[1]);let{multidimensionalDefinition:a}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});Pe(r.rasterFields,e,a);let{graphicOrigin:d}=r,f=new Ce({geometry:this.fullExtent?.clone(),attributes:e,layer:r,origin:d,sourceLayer:r});o.push(f)}return o}async getSourceScale(){return await this.layer.load(),Ue(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return We(this.layer.serviceRasterInfo,this.view.spatialReference)}};return y([i()],r.prototype,`fullExtent`,null),y([i()],r.prototype,`layer`,void 0),y([i({readOnly:!0})],r.prototype,`timeExtent`,null),y([i()],r.prototype,`tileInfo`,void 0),y([i({readOnly:!0})],r.prototype,`hasTilingEffects`,null),y([i()],r.prototype,`datumTransformation`,null),r=y([u(`esri.views.layers.ImageryTileLayerViewMixin`)],r),r},aa=class extends ia(Yt(qt(Jt))){constructor(){super(...arguments),this._useWebGLForProcessing=!0,this._useProgressiveUpdate=!0,this._pixelHighlights=[],this.subview=null}get useWebGLForProcessing(){return this._useWebGLForProcessing}set useWebGLForProcessing(e){this._useWebGLForProcessing=e,this.subview&&`useWebGLForProcessing`in this.subview&&(this.subview.useWebGLForProcessing=e)}get useProgressiveUpdate(){return this._useWebGLForProcessing}set useProgressiveUpdate(e){this._useProgressiveUpdate=e,this.subview&&`useProgressiveUpdate`in this.subview&&(this.subview.useProgressiveUpdate=e)}get displayParameters(){let{layer:e}=this,t=this._get(`displayParameters`);return e.renderer&&e.visible?{bandIds:e.bandIds,renderer:e.renderer,interpolation:e.interpolation,multidimensionalDefinition:e.multidimensionalDefinition,rasterFunction:e.type===`imagery-tile`?e.rasterFunction:null}:t}update(e){this.subview?.update(e),this.notifyChange(`updating`)}isUpdating(){return!this.subview||this.subview.updating}attach(){this.layer.increaseRasterJobHandlerUsage(),this._updateSubview(),this.addAttachHandles([pe(()=>this.displayParameters,(e,t)=>{let n=e.interpolation!==t?.interpolation&&(e.interpolation===`majority`||t?.interpolation===`majority`)&&le(this.layer),r=!!this.layer.serviceRasterInfo?.storageInfo?.isBsqTile&&e.bandIds?.join()!==t?.bandIds?.join(),i=e.renderer!==t?.renderer&&this._getSubviewType(t?.renderer)!==this._getSubviewType(e.renderer);i&&this._updateSubview();let a=e.multidimensionalDefinition!==t?.multidimensionalDefinition,o=e.rasterFunction!==t?.rasterFunction,s=o&&!this._useWebGLForProcessing,c=a||n||i||s||r;this.subview.redrawOrRefetch({refetch:c,reprocess:o}).catch(e=>{ye(e)||xe.getLogger(this).error(e)}),this.notifyChange(`updating`)}),pe(()=>this.layer.multidimensionalSubset??null,(e,t)=>{let{multidimensionalDefinition:n}=this.layer;n!=null&&Oe(n,e)!==Oe(n,t)&&(this.subview.redrawOrRefetch({refetch:!0}).catch(e=>{ye(e)||xe.getLogger(this).error(e)}),this.notifyChange(`updating`))},ne),pe(()=>this.timeExtent,()=>{this.subview.timeExtent=this.timeExtent,this.subview.redrawOrRefetch({refetch:!0}).catch(e=>{ye(e)||xe.getLogger(this).error(e)})},se),pe(()=>this.view.highlights.items.map(({name:e,color:t})=>({name:e,color:t})),()=>this._updateHighlightOptions(this.subview),se)])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}viewChange(){this.requestUpdate()}moveEnd(){this.subview.moveEnd()}highlight(e,t){if(!e.pixelRanges||sn(e))return ee();let n={target:{...e},options:{...t}};return this._pixelHighlights.push(n),this._updateHighlightOptions(this.subview),ee(()=>{let e=this._pixelHighlights.indexOf(n);e!==-1&&(this._pixelHighlights.splice(e,1),this._updateHighlightOptions(this.subview))})}doRefresh(){return this.subview?this.subview.doRefresh():Promise.resolve()}_updateSubview(){let{renderer:e}=this.layer;if(!e)return;let t=this._getSubviewType(e);if(this.subview){if(this.subview.type===t)return void this._attachSubview(this.subview);this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}let{layer:n}=this,r;if(r=t===`rasterVF`?new ra({layer:n,layerView:this,scheduler:this.scheduler}):t===`flow`?new an({layer:n,layerView:this,scheduler:this.scheduler}):new ea({layer:n,layerView:this,scheduler:this.scheduler}),`useWebGLForProcessing`in r&&(r.useWebGLForProcessing=this._useWebGLForProcessing),`useProgressiveUpdate`in r&&(r.useProgressiveUpdate=this._useProgressiveUpdate),`previousLOD`in r){let{subview:e}=this;r.previousLOD=e&&`previousLOD`in e?e.previousLOD:null}this._attachSubview(r),this._updateHighlightOptions(r),this.subview=r,this.requestUpdate()}_attachSubview(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0))}_detachSubview(e){e?.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)}_getSubviewType(e){let t=e?.type;return t===`vector-field`?`rasterVF`:t===`flow`?`flow`:`raster`}_updateHighlightOptions(e){e?.type===`raster`&&e.updateHighlightOptions(this._pixelHighlights)}};y([i()],aa.prototype,`subview`,void 0),y([i()],aa.prototype,`useWebGLForProcessing`,null),y([i()],aa.prototype,`useProgressiveUpdate`,null),y([i({readOnly:!0})],aa.prototype,`displayParameters`,null),aa=y([u(`esri.views.2d.layers.ImageryTileLayerView2D`)],aa);var oa=aa;export{oa as default};