import{$T as e,Kh as t,ZS as n,iC as r,qh as i,sT as a,vC as o}from"./index-BN8X5Ryz.js";async function s(t,n){let i=r(t);if(!i)throw new e(`invalid-url`,`Invalid scene service url`);let a={...n,sceneServerUrl:i.url.path,layerId:i.sublayer??void 0};if(a.sceneLayerItem??=await c(a),a.sceneLayerItem==null)return d(a.sceneServerUrl.replace(`/SceneServer`,`/FeatureServer`),a);let o=await f(a);if(!o?.url)throw new e(`related-service-not-found`,`Could not find feature service through portal item relationship`);a.featureServiceItem=o;let s=await d(o.url,a);return s.portalItem=o,s}async function c(e){let n=(await l(e)).serviceItemId;if(!n)return null;let r=new t({id:n,apiKey:e.apiKey}),o=await u(e);o!=null&&(r.portal=new i({url:o}));try{return await r.load({signal:e.signal})}catch(e){return a(e),null}}async function l(e){if(e.rootDocument)return e.rootDocument;let t={query:{f:`json`,...e.customParameters,token:e.apiKey},responseType:`json`,signal:e.signal};try{e.rootDocument=(await n(e.sceneServerUrl,t)).data}catch{e.rootDocument={}}return e.rootDocument}async function u(e){let t=o?.findServerInfo(e.sceneServerUrl);if(t?.owningSystemUrl)return t.owningSystemUrl;let r=e.sceneServerUrl.replace(/(.*\/rest)\/.*/i,`$1`)+`/info`;try{let t=(await n(r,{query:{f:`json`},responseType:`json`,signal:e.signal})).data.owningSystemUrl;if(t)return t}catch(e){a(e)}return null}async function d(t,i){let a=r(t);if(!a)throw new e(`invalid-feature-service-url`,`Invalid feature service url`);let o=a.url.path,s=i.layerId;if(s==null)return{serverUrl:o};let c=l(i),u=i.featureServiceItem?await i.featureServiceItem.fetchData(`json`):null,d=(u?.layers?.[0]||u?.tables?.[0])?.customParameters,f=e=>{let t={query:{f:`json`,...d},responseType:`json`,authMode:e,signal:i.signal};return n(o,t)},p=f(`anonymous`).catch(()=>f(`no-prompt`)),[m,h]=await Promise.all([p,c]),g=h?.layers,_=m.data&&m.data.layers;if(!Array.isArray(_))throw Error(`expected layers array`);if(Array.isArray(g)){for(let e=0;e<Math.min(g.length,_.length);e++)if(g[e].id===s)return{serverUrl:o,layerId:_[e].id}}else if(s!=null&&s<_.length)return{serverUrl:o,layerId:_[s].id};throw Error(`could not find matching associated sublayer`)}async function f({sceneLayerItem:e,signal:n}){if(!e)return null;try{let r=(await e.fetchRelatedItems({relationshipType:`Service2Service`,direction:`reverse`},{signal:n})).find(e=>e.type===`Feature Service`)||null;if(!r)return null;let i=new t({portal:r.portal,id:r.id});return await i.load(),i}catch(e){return a(e),null}}export{s as t};