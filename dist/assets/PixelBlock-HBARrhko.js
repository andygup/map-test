import{BT as e,DT as t,GC as n,OT as r,SE as i,gD as a,kT as o,uE as s}from"./index-CZ4oMP1N.js";var c=9999999e31,l=2e-7,u={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34028234663852886e22,34028234663852886e22],f64:[-Number.MAX_VALUE,Number.MAX_VALUE],unknown:void 0,c64:void 0,c128:void 0};function d(e){return u[e]??[-34028234663852886e22,34028234663852886e22]}var f={u1:1,u2:1,u4:1,u8:1,s8:1,u16:2,s16:2,u32:4,s32:4,f32:4,f64:8,unknown:4,c64:16,c128:32};function p(e){return f[e]}function m(e){return p(e.pixelType)*e.bandCount}function h(e,t){return e==null||t==null?`s32`:e<0?e>=-128&&t<128?`s8`:e>=-32768&&t<32768?`s16`:`s32`:t<256?`u8`:t<65536?`u16`:`u32`}function g(e){return(e?.startsWith(`s`)||e?.startsWith(`u`))??!1}function _(e,t,n,r){let[i,a]=d(n),o=g(n);return o&&(i-=1e-5,a+=1e-5),o?n.startsWith(`u`)?y(e,t,r,[i,a]):b(e,t,r,[i,a]):x(e,t,r,[i,a])}function v(e,t){for(let n=0;n<t.length;n++)t[n]&&isNaN(e[n])&&(t[n]=0,e[n]=0)}function y(e,t,n,r){let[i,a]=r;for(let r=0;r<t.length;r++)if(t[r]){let o=e[r];o<i||o>a?t[r]=0:n[r]=o+.5|0}}function b(e,t,n,r){let[i,a]=r;for(let r=0;r<t.length;r++)if(t[r]){let o=e[r];o<i||o>a?t[r]=0:n[r]=o+(o>0?.5:-.5)|0}}function x(e,t,n,r){let[i,a]=r;for(let r=0;r<t.length;r++)if(t[r]){let o=e[r];o<i||o>a?t[r]=0:n[r]=o}}function S(e,t,n){if(e.depthCount&&e.depthCount>1)return;let{pixels:r,statistics:i,pixelType:a}=e,o=r[0].length,s=e.bandMasks??[],u=e.mask??new Uint8Array(o).fill(255),f=a===`f32`||a===`f64`,p=d(a),m=!1;for(let e=0;e<r.length;e++){let o=typeof t==`number`?t:t[e];if(o==null)continue;let d=i?.[e]?.minValue??p[0],h=i?.[e]?.maxValue??p[1];if(d>o+2**-52||h<o-2**-52)continue;let g=s[e]||u.slice(),_=r[e],v=n?.customFloatTolerance;if(f&&v!==0){let e=v;e||=Math.abs(o)>=c?l*Math.abs(o):a===`f32`?2**-23:2**-52;for(let t=0;t<_.length;t++)g[t]&&Math.abs(_[t]-o)<e&&(_[t]=0,g[t]=0,u[t]=0,m=!0)}else for(let e=0;e<_.length;e++)g[e]&&_[e]===o&&(_[e]=0,g[e]=0,u[e]=0,m=!0);s[e]=g}if(m){let t=e.bandMasks||e.pixels.length>1?s:null;n?.matchAllNoData?e.mask=t&&t.length>1?h(t):u:(e.bandMasks=t,e.mask=u)}function h(e){if(e.length<2)return e[0];let t=e[0].length,n=new Uint8Array(t).fill(0);for(let r=0;r<e.length;r++){let i=e[r];for(let e=0;e<t;e++)i[e]&&(n[e]=255)}return n}m&&`updateStatistics`in e&&e.updateStatistics()}var C=class{constructor(e=null,t=null,n=null){this.minValue=e,this.maxValue=t,this.noDataValue=n}},w,T=class extends n{static{w=this}static createEmptyBand(e,t){return new(w.getPixelArrayConstructor(e))(t)}static combineBandMasks(e){if(e.length<2)return e[0];let t=e[0].length,n=new Uint8Array(t).fill(255);for(let r=0;r<e.length;r++){let i=e[r];for(let e=0;e<t;e++)i[e]||(n[e]=0)}return n}static getPixelArrayConstructor(e){let t;switch(e){case`u1`:case`u2`:case`u4`:case`u8`:t=Uint8Array;break;case`u16`:t=Uint16Array;break;case`u32`:t=Uint32Array;break;case`s8`:t=Int8Array;break;case`s16`:t=Int16Array;break;case`s32`:t=Int32Array;break;case`f32`:case`c64`:case`c128`:case`unknown`:t=Float32Array;break;case`f64`:t=Float64Array}return t}constructor(e){super(e),this.width=null,this.height=null,this.pixelType=`f32`,this.validPixelCount=null,this.mask=null,this.maskIsAlpha=!1,this.premultiplyAlpha=!1,this.statistics=null,this.depthCount=1}castPixelType(e){if(!e)return`f32`;let t=e.toLowerCase();return[`u1`,`u2`,`u4`].includes(t)?t=`u8`:[`unknown`,`u8`,`s8`,`u16`,`s16`,`u32`,`s32`,`f32`,`f64`].includes(t)||(t=`f32`),t}getPlaneCount(){return this.pixels?.length}addData(t){if(!t.pixels||t.pixels.length!==this.width*this.height)throw new e(`pixelblock:invalid-or-missing-pixels`,`add data requires valid pixels array that has same length defined by pixel block width * height`);this.pixels||=[],this.statistics||=[],this.pixels.push(t.pixels),this.statistics.push(t.statistics??new C)}getAsRGBA(){let e=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case`s8`:case`s16`:case`u16`:case`s32`:case`u32`:case`f32`:case`f64`:this._fillFromNon8Bit(e);break;default:this._fillFrom8Bit(e)}return new Uint8ClampedArray(e)}getAsRGBAFloat(){let e=new Float32Array(this.width*this.height*4);return this._fillFrom32Bit(e),e}updateStatistics(){if(!this.pixels)return;this.statistics=this.pixels.map(e=>E(e,this.mask));let e=this.mask,t=0;if(e!=null)for(let n=0;n<e.length;n++)e[n]&&t++;else t=this.width*this.height;this.validPixelCount=t}clamp(e){if(!e||e===`f64`||e===`f32`||!this.pixels)return;let[t,n]=d(e),r=this.pixels,i=this.width*this.height,a=r.length,o,s,c,l=[];for(let u=0;u<a;u++){c=w.createEmptyBand(e,i),o=r[u];for(let e=0;e<i;e++)s=o[e],c[e]=s>n?n:s<t?t:s;l.push(c)}this.pixels=l,this.pixelType=e}extractBands(e){let{pixels:t,statistics:n}=this;if(e==null||e.length===0||!t||t.length===0)return this;let r=t.length,i=e.some(e=>e>=t.length),a=r===e.length&&!e.some((e,t)=>e!==t);if(i||a)return this;let o=this.bandMasks?.length===r?e.map(e=>this.bandMasks[e]):void 0,{mask:s,validPixelCount:c}=this,{width:l,height:u}=this;return o?.length&&(s=w.combineBandMasks(o),c=s.filter(e=>!!e).length),new w({pixelType:this.pixelType,width:l,height:u,mask:s,bandMasks:o,validPixelCount:c,maskIsAlpha:this.maskIsAlpha,pixels:e.map(e=>t[e]),statistics:n&&e.map(e=>n[e])})}clone(){let e=new w({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount,premultiplyAlpha:this.premultiplyAlpha,depthCount:this.depthCount}),t;this.mask!=null&&(e.mask=new Uint8Array(this.mask)),this.noDataValues&&(e.noDataValues=[...this.noDataValues]),this.bandMasks&&(e.bandMasks=this.bandMasks.map(e=>new Uint8Array(e)));let n=w.getPixelArrayConstructor(this.pixelType);if(this.pixels&&this.pixels.length>0){e.pixels=[];let r=!!this.pixels[0].slice;for(t=0;t<this.pixels.length;t++)e.pixels[t]=r?this.pixels[t].slice():new n(this.pixels[t])}if(this.statistics)for(e.statistics=[],t=0;t<this.statistics.length;t++)e.statistics[t]=i(this.statistics[t]);return e}getTransferableObject(){let{pixels:e,bandMasks:t,mask:n}=this;this.pixels=[],this.bandMasks=void 0,this.mask=void 0;let r=this.toJSON();this.pixels=e,this.bandMasks=t,this.mask=n,r.pixels=e&&[...e],r.bandMasks=t&&[...t],r.mask=n;let i=[];return[...e??[],n,...t??[]].filter(e=>e!=null&&ArrayBuffer.isView(e)).forEach(e=>{e&&!i.includes(e.buffer)&&i.push(e.buffer)}),{pixelBlock:r,transferList:i}}_fillFrom8Bit(e){let{mask:t,maskIsAlpha:n,premultiplyAlpha:r,pixels:i}=this;if(!e||!i?.length)return void s.getLogger(this).error(`getAsRGBA()`,`Unable to convert to RGBA. The input pixel block is empty.`);let a,o,c,l;a=o=c=i[0],i.length>=3?(o=i[1],c=i[2]):i.length===2&&(o=i[1]);let u=new Uint32Array(e),d=this.width*this.height;if(a.length===d)if(t!=null&&t.length===d)if(n)for(l=0;l<d;l++){let e=t[l];if(e){let t=e/255;u[l]=r?e<<24|c[l]*t<<16|o[l]*t<<8|a[l]*t:e<<24|c[l]<<16|o[l]<<8|a[l]}}else for(l=0;l<d;l++)t[l]&&(u[l]=255<<24|c[l]<<16|o[l]<<8|a[l]);else for(l=0;l<d;l++)u[l]=255<<24|c[l]<<16|o[l]<<8|a[l];else s.getLogger(this).error(`getAsRGBA()`,`Unable to convert to RGBA. The pixelblock is invalid.`)}_fillFromNon8Bit(e){let{pixels:t,mask:n,statistics:r}=this;if(!e||!t?.length)return void s.getLogger(this).error(`getAsRGBA()`,`Unable to convert to RGBA. The input pixel block is empty.`);let i=this.pixelType,a=1,o=0,c=1;if(r&&r.length>0){for(let e of r)if(e.minValue!=null&&(o=Math.min(o,e.minValue)),e.maxValue!=null&&e.minValue!=null){let t=e.maxValue-e.minValue;c=Math.max(c,t)}a=255/c}else{let e=255;i===`s8`?(o=-128,e=127):i===`u16`?e=65535:i===`s16`?(o=-32768,e=32767):i===`u32`?e=4294967295:i===`s32`?(o=-2147483648,e=2147483647):i===`f32`?(o=-34e38,e=34e38):i===`f64`&&(o=-Number.MAX_VALUE,e=Number.MAX_VALUE),a=255/(e-o)}let l=new Uint32Array(e),u=this.width*this.height,d,f,p,m,h;if(d=f=p=t[0],d.length!==u)return s.getLogger(this).error(`getAsRGBA()`,`Unable to convert to RGBA. The pixelblock is invalid.`);if(t.length>=2)if(f=t[1],t.length>=3&&(p=t[2]),n!=null&&n.length===u)for(m=0;m<u;m++)n[m]&&(l[m]=255<<24|(p[m]-o)*a<<16|(f[m]-o)*a<<8|(d[m]-o)*a);else for(m=0;m<u;m++)l[m]=255<<24|(p[m]-o)*a<<16|(f[m]-o)*a<<8|(d[m]-o)*a;else if(n!=null&&n.length===u)for(m=0;m<u;m++)h=(d[m]-o)*a,n[m]&&(l[m]=255<<24|h<<16|h<<8|h);else for(m=0;m<u;m++)h=(d[m]-o)*a,l[m]=255<<24|h<<16|h<<8|h}_fillFrom32Bit(e){let{pixels:t,mask:n}=this;if(!e||!t?.length)return s.getLogger(this).error(`getAsRGBAFloat()`,`Unable to convert to RGBA. The input pixel block is empty.`);let r,i,a,o;r=i=a=t[0],t.length>=3?(i=t[1],a=t[2]):t.length===2&&(i=t[1]);let c=this.width*this.height;if(r.length!==c)return s.getLogger(this).error(`getAsRGBAFloat()`,`Unable to convert to RGBA. The pixelblock is invalid.`);let l=0;if(n!=null&&n.length===c)for(o=0;o<c;o++)e[l++]=r[o],e[l++]=i[o],e[l++]=a[o],e[l++]=1&n[o];else for(o=0;o<c;o++)e[l++]=r[o],e[l++]=i[o],e[l++]=a[o],e[l++]=1}};function E(e,t){let n=1/0,r=-1/0,i=e.length,a,o=0;if(t!=null)for(a=0;a<i;a++)t[a]&&(o=e[a],n=o<n?o:n,r=o>r?o:r);else for(a=0;a<i;a++)o=e[a],n=o<n?o:n,r=o>r?o:r;return new C(n,r)}a([t({json:{write:!0}})],T.prototype,`width`,void 0),a([t({json:{write:!0}})],T.prototype,`height`,void 0),a([t({json:{write:!0}})],T.prototype,`pixelType`,void 0),a([o(`pixelType`)],T.prototype,`castPixelType`,null),a([t({json:{write:!0}})],T.prototype,`validPixelCount`,void 0),a([t({json:{write:!0}})],T.prototype,`mask`,void 0),a([t({json:{write:!0}})],T.prototype,`maskIsAlpha`,void 0),a([t({json:{write:!0}})],T.prototype,`pixels`,void 0),a([t()],T.prototype,`premultiplyAlpha`,void 0),a([t({json:{write:!0}})],T.prototype,`statistics`,void 0),a([t({json:{write:!0}})],T.prototype,`depthCount`,void 0),a([t({json:{write:!0}})],T.prototype,`noDataValues`,void 0),a([t({json:{write:!0}})],T.prototype,`bandMasks`,void 0),T=w=a([r(`esri.layers.support.PixelBlock`)],T);export{S as a,g as c,v as i,d as l,C as n,h as o,_ as r,m as s,T as t};