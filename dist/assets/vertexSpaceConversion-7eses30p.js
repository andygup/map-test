import{cl as H,dF as K,e4 as L,e5 as U,dy as $,dG as x,dH as y,e6 as M,cj as T,dz as V,e7 as Y,e8 as D,ck as h,dM as I,cd as J,K as Q,e9 as N,d9 as W,ea as X}from"./index-DzfnmjFP.js";import{m as Z}from"./meshVertexSpaceUtils-DeDI6owL.js";import{i as R,e as E,f as b}from"./vec3-Lc_U4bRi.js";import{logProjectionError as A,transformNormal as B,transformTangent as k,projectFromPCPF as _,projectNormalFromPCPF as nn,projectTangentFromPCPF as tn,projectToPCPF as rn,projectNormalToPCPF as en,projectTangentToPCPF as on}from"./projection-CzRJm6AG.js";const g=()=>Q.getLogger("esri.geometry.support.meshUtils.vertexSpaceConversion");function yn(n,t,{vertexSpace:r,spatialReference:o}){if(r.type==="georeferenced"){const u=n;if(!N(t,u,o))return!1;const{origin:c}=r;return W(n,u,c),!0}const e=$(o),a=n;if(!N(t,a,e))return!1;const{origin:l}=r,s=G;if(!x(o,l,s,e))return!1;const i=T(G,s);return i!=null&&(X(n,a,i),!0)}function Tn(n,t,r){const{vertexSpace:o,transform:e,vertexAttributes:a}=n,l=w(n.spatialReference,r,p.SOURCE|p.TARGET);if(Z(o,t)&&(!e||H(e.localMatrix,K))&&L(l,1)){const{position:s,normal:i,tangent:u}=a,c=r==null?void 0:r.allowBufferReuse;return{position:c?s:s.slice(),normal:c?i:i==null?void 0:i.slice(),tangent:c?u:u==null?void 0:u.slice()}}switch(n.vertexSpace.type){case"local":return t.type==="local"?un(n,n.vertexSpace,t.origin,r):ln(n,n.vertexSpace,t.origin,r);case"georeferenced":return t.type==="local"?sn(n,n.vertexSpace,t.origin,r):an(n,n.vertexSpace,t.origin,r)}}function an({vertexAttributes:n,transform:t,spatialReference:r},{origin:o},e,a){const{position:l,normal:s,tangent:i}=t?S(n,t.localMatrix):n,u=new Float64Array(l.length);let c=l;if(o&&(c=R(u,c,o)),e){const F=U(q,e);c=R(u,c,F)}w(r,a,p.NONE);const m=a==null?void 0:a.allowBufferReuse;return{position:c!==n.position||m?c:c.slice(),normal:s!==n.normal||m?s:s==null?void 0:s.slice(),tangent:i!==n.tangent||m?i:i==null?void 0:i.slice()}}function ln({spatialReference:n,vertexAttributes:t,transform:r},{origin:o},e,a){const l=$(n);if(!x(n,o,f,l))return A(g(),n,l),null;r&&y(f,f,r.localMatrix),z(f,n,a,p.SOURCE);const s=new Float64Array(t.position.length),i=fn(t.position,f,n,s);if(!i)return null;const u=gn(i,s,t.normal,f,n);if(t.normal&&!u)return null;const c=pn(i,s,t.tangent,f,n);if(t.tangent&&!c)return null;if(e){const m=U(q,e);R(i,i,m)}return{position:i,normal:u,tangent:c}}function sn({vertexAttributes:n,spatialReference:t,transform:r},{origin:o},e,a){const l=$(t);if(!x(t,e,f,l))return A(g(),t,l),null;const s=1/w(t,a,p.TARGET);M(f,f,[s,s,s]);const i=T(v,f),{position:u,normal:c,tangent:m}=cn(n,o,r),F=new Float64Array(u.length),d=mn(u,t,i,F);if(!d)return null;const P=V(Fn,i),C=An(c,u,F,t,P,c!==n.normal?c:void 0);if(!C&&c)return null;const j=$n(m,u,F,t,P,m!==n.tangent?m:void 0);return!j&&m?null:{position:d,normal:C,tangent:j}}function cn(n,t,r){if(!t)return n;if(!r){const{position:e,normal:a,tangent:l}=n;return{position:R(new Float64Array(e.length),e,t),tangent:l,normal:a}}const o=S(n,r.localMatrix);return R(o.position,o.position,t),o}function un({vertexAttributes:n,spatialReference:t,transform:r},{origin:o},e,a){const l=$(t);if(!x(t,o,f,l))return A(g(),t,l),null;if(r&&y(f,f,r.localMatrix),!x(t,e,v,l))return A(g(),l,t),null;T(v,v);const s=y(f,v,f);return z(s,t,a,p.SOURCE|p.TARGET),S(n,s)}function S(n,t){const r=new Float64Array(n.position.length);E(r,n.position,t);const o=n.normal?new Float32Array(n.normal.length):null,e=n.tangent?new Float32Array(n.tangent.length):null;return o&&n.normal&&B(n.normal,o,t),e&&n.tangent&&k(n.tangent,e,t),{position:r,normal:o,tangent:e}}function fn(n,t,r,o){E(o,n,t);const e=new Float64Array(n.length);return _(o,e,r)?e:(A(g(),$(r),r),null)}function gn(n,t,r,o,e){if(r==null)return null;const a=new Float32Array(r.length);return B(r,a,o),nn(a,n,t,e,a)?a:(A(g(),$(e),e),null)}function pn(n,t,r,o,e){if(r==null)return null;const a=new Float32Array(r.length);return k(r,a,o),tn(a,n,t,e,a)?a:(A(g(),$(e),e),null)}function z(n,t,r,o){const e=w(t,r,o);e!==1&&M(n,n,[e,e,e])}function w(n,t,r){const o=!!(r&p.SOURCE),e=!!(r&p.TARGET),a=t==null?void 0:t.sourceUnit,l=t==null?void 0:t.targetUnit;if(!a&&!l)return 1;let s=O(a,n);!o&&a&&s!==1&&(g().warn("source unit conversion not supported"),s=1);let i=1/O(l,n);return!e&&l&&i!==1&&(g().warn("target unit conversion not supported"),i=1),s*i}function mn(n,t,r,o){const e=rn(n,t,o);if(!e)return A(g(),t,$(t)),null;const a=new Float64Array(e.length);return E(a,e,r),a}function An(n,t,r,o,e,a){if(n==null)return null;const l=a??new Float32Array(n.length);return en(n,t,r,o,l)?(b(l,l,e),l):(A(g(),o,$(o)),null)}function $n(n,t,r,o,e,a){if(n==null)return null;const l=a??new Float32Array(n.length);return on(n,t,r,o,l)?(b(l,l,e,4),l):(A(g(),o,$(o)),null)}function O(n,t){if(n==null)return 1;const r=Y(t);return 1/D(r,"meters",n)}const f=h(),v=h(),Fn=I(),q=J(),G=h();var p;(function(n){n[n.NONE=0]="NONE",n[n.SOURCE=1]="SOURCE",n[n.TARGET=2]="TARGET"})(p||(p={}));export{Tn as M,yn as N,O as X};
