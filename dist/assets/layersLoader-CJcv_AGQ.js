import{BT as e,Ba as t,Ih as n,Ma as r,_h as i,bh as a,qS as o,v as s,vh as c}from"./index-CzMixifc.js";import"./associatedFeatureServiceUtils-BCXt0fb8.js";import{r as l,t as u}from"./fetchService-DOhU8MGQ.js";import{c as d,i as f,l as p,n as m,o as h,r as g,s as _,t as v,u as y}from"./loadUtils-BPyArSJg.js";async function b(e,t){let n=e.instance.portalItem;if(n?.id)return await n.load(t),x(e),e.validateItem&&e.validateItem(n),S(e,t)}function x(t){let n=t.instance.portalItem;if(!n?.type||!t.supportedTypes.includes(n.type))throw new e(`portal:invalid-layer-item-type`,"Invalid layer item type '${type}', expected '${expectedType}'",{type:n?.type,expectedType:t.supportedTypes.join(`, `)})}async function S(e,t){let n=e.instance,i=n.portalItem;if(!i)return;let{url:a}=i,{title:o}=i,c=r(i,`portal-item`);if(n.type===`group`)return C(n,c,e);a&&n.type!==`media`&&n.read({url:a},c);let l=new y,{data:u,preferredHost:d}=await A(e,l,t);return a=i.url,`isUrlHostModified`in n&&(d?n.applyPreferredHost({preferredHost:d}):n.applyHostFromPortalItem()),u&&n.read(u,c),n.resourceReferences={portalItem:i,paths:c.readResourcePaths??[]},n.type!==`subtype-group`&&n.read({title:o},c),s(n,c)}async function C(n,r,i){let a=n.portalItem;if(!n.sourceIsPortalItem)return;let{title:o,type:s}=a;if(s===`Group Layer`){if(!t(a,`Map`))throw new e(`portal:invalid-layer-item-typekeyword`,`'Group Layer' item without 'Map' type keyword is not supported`);return w(n,i)}return n.read({title:o},r),T(n,i)}async function w(t,n){let i=t.portalItem,a=await i.fetchData(`json`);if(!a)return;if(!n.populateGroupLayer)throw new e(`portal:missing-populate-group-layer`,`Missing populate group layer`);let o=r(i,`web-map`);t.read(a,o),await n.populateGroupLayer(t,a,{context:o}),t.resourceReferences={portalItem:i,paths:o.readResourcePaths??[]}}async function T(t,n){let r,{portalItem:i}=t;if(!i)return;let o=i.type,s=n.layerModuleTypeMap;if(!s)throw new e(`portal:missing-layer-module-type-map`,`Layer module type map is required to construct sub layers`);switch(o){case`Feature Service`:case`Feature Collection`:r=s.FeatureLayer;break;case`Stream Service`:r=s.StreamLayer;break;case`Scene Service`:r=s.SceneLayer;break;case`Video Service`:r=s.VideoLayer;break;default:throw new e(`portal:unsupported-item-type-as-group`,`The item type '${o}' is not supported as a 'GroupLayer'`)}let c=o===`Video Service`,l=new y,[u,{data:d}]=await Promise.all([r(),c?{data:null}:A(n,l)]),h=()=>u;if(c)return D(t,h,s);if(o===`Feature Service`){let e=_(d)?.customParameters;d=i.url?(await f(d,i.url,l)).data:{},h=await I(d,s)||h;let{provider:n,preferredHost:r}=await F(i.url,{customParameters:e,loadContext:l});return a(i,r),await O(t,h,h,d,s,n)}return o===`Scene Service`&&i.url&&(d=await p(i,d,l)),m(d)>0?await O(t,h,null,d,s):await E(t,h,s)}async function E(e,t,n){let{portalItem:r}=e;if(!r?.url)return;let i=await l(r.url);i&&O(e,t,null,{layers:i.layers?.map(v),tables:i.tables?.map(v)},n)}async function D(e,t,n){let{portalItem:r}=e;if(!r?.url)return;let i=await l(r.url);i&&O(e,t,null,{layers:i.layers?.map(({id:e,name:t})=>({id:e,name:t}))},n)}async function O(e,t,n,r,i,a){let o=r.layers||[],s=r.tables||[];if(e.portalItem?.type===`Feature Collection`?(o.forEach((e,t)=>{e.id=t,e?.layerDefinition?.type===`Table`&&s.push(e)}),o=o.filter(e=>e?.layerDefinition?.type!==`Table`)):(o.reverse(),s.reverse()),o.forEach(n=>{let i=a?.(n);if(i||!a){let a=k(e,t(n),r,n,i);e.add(a)}}),s.length){let t=n?null:await i.FeatureLayer();s.forEach(i=>{let o=a?.(i);if(o||!a){let a=k(e,n?n(i):t,r,i,o);e.tables.add(a)}})}}function k(e,t,r,i,a){let o=e.portalItem,s={portalItem:o.clone(),layerId:i.id};i.url!=null&&(s.url=i.url);let c=new t(s);if(`sourceJSON`in c&&(c.sourceJSON=a),c.type!==`subtype-group`&&c.type!==`catalog`&&(c.sublayerTitleMode=`service-name`),o.type===`Feature Collection`){let e={origin:`portal-item`,portal:o.portal||n.getDefault()};c.read(i,e);let t=r.showLegend;t!=null&&c.read({showLegend:t},e)}return c}async function A(e,t,n){if(!1===e.supportsData)return{data:void 0};let r=e.instance,i=r.portalItem;if(!i)return{data:void 0};let o=null;try{o=await i.fetchData(`json`,n)}catch{}if(N(r)){let e=null,{count:n,preferredHost:s}=await j(i,o,t);if(a(i,s),(o?.layers||o?.tables)&&n>0){if(r.layerId==null){let e=h(r.type),t=e?.length?d(o,e)[0]:_(o);t&&(r.layerId=t.id)}e=M(o,r),e?.layerType===`OrientedImageryLayer`&&r.type===`oriented-imagery`&&r.supportedSourceTypes.add(`Feature Layer`),e&&o.showLegend!=null&&(e.showLegend=o.showLegend)}return n>1&&`sublayerTitleMode`in r&&r.sublayerTitleMode!==`service-name`&&(r.sublayerTitleMode=`item-title-and-service-name`),{data:e,preferredHost:s}}return{data:o}}async function j(e,t,n){if(t?.layers&&t?.tables)return{count:m(t)};let r=o(e.url);if(!r)return{count:1};let a=r.url.path,s=await n.fetchServiceMetadata(a,{customParameters:_(t)?.customParameters}).catch(()=>null);return{count:(t?.layers?.length??s?.layers?.length??0)+(t?.tables?.length??s?.tables?.length??0),preferredHost:c(e)?i():null}}function M(e,t){let{layerId:n}=t,r=e.layers?.find(e=>e.id===n)||e.tables?.find(e=>e.id===n);return r&&P(r,t)?r:null}function N(e){return e.type!==`stream`&&`layerId`in e}function P(e,t){let n=`layerType`in e&&e.layerType,{type:r}=t;return!(r===`feature`&&n&&e.layerType!==`ArcGISFeatureLayer`||r===`catalog`&&!n||r===`oriented-imagery`&&!n||r===`subtype-group`&&!n)}async function F(e,t){let{layersJSON:n,preferredHost:r}=await u(e,t);if(!n)return{provider:null,preferredHost:r};let i=[...n.layers,...n.tables];return{provider:e=>i.find(t=>t.id===e.id),preferredHost:r}}async function I(e,t){let{layers:n,tables:r}=e,i=[...n??[],...r??[]];if(!i.length)return;let a=new Set,o=[];for(let{layerType:e}of i){let n=e??`ArcGISFeatureLayer`;if(a.has(n))continue;a.add(n);let r=t[g(n)];o.push(r())}let s=await Promise.all(o),c=new Map;return Array.from(a).forEach((e,t)=>{c.set(e,s[t])}),({layerType:e})=>{let t=e??`ArcGISFeatureLayer`;return c.get(t)}}export{b as load};