import{$T as e,A as t,BT as n,CE as r,ED as i,Gh as a,L as o,Li as s,Lx as c,M as l,Rh as u,Ua as d,VT as f,WT as p,ZS as m,ca as h,cv as g,fC as _,ji as v,kD as y,lv as b,ma as x,pa as S,qh as C,rh as w,sT as T,vx as E}from"./index-BN8X5Ryz.js";import"./memoize-Dl61_jt0.js";import{o as D,p as O,y as k}from"./elevationInfoUtils-uoMH3ofe.js";import{t as A}from"./tiles3DUtils-BFwR0uHY.js";import{t as j}from"./SceneModifications-BfQhIZ_m.js";var M=class extends S(o(l(t(d(h(x(u))))))){readModifications(e,t,n){this._modificationsSource={url:_(e,n),context:n}}initialize(){this.addHandles(b(()=>this.modifications,`after-changes`,()=>this.modifications=this.modifications,g))}constructor(e){super(e),this.operationalLayerType=`IntegratedMesh3DTilesLayer`,this.modifications=null,this._modificationsSource=null,this.spatialReference=new c({wkid:4326,vcsWkid:115700}),this.fullExtent=new E(-180,-90,180,90,this.spatialReference),this.url=null,this.type=`integrated-mesh-3dtiles`,this.path=null,this.minScale=0,this.maxScale=0,this._rootTilesetJSON=null,this._rootTileset=null,this._key=null,this._session=null,this._rootRequestPromise=null}set elevationInfo(e){e!=null&&e.mode!==`absolute-height`||this._set(`elevationInfo`,e),this._validateElevationInfo(e)}async load(e){return this.addResolvingPromise(this._doLoad(e)),this}get rootTilesetJSON(){return this._rootTilesetJSON}get rootTileset(){return this._rootTileset}get key(){return this._key}get session(){return this._session}_findSessionParameter(e){let t=[e];for(;t?.length>0;){let e=t.pop();if(!e)return;for(let[n,r]of Object.entries(e)){if(n===`uri`)try{let e=new URL(`https://tmp`+r).searchParams.get(`session`);if(e)return e}catch{}typeof r==`object`&&r&&t.push(r)}}return null}async requestRootAndSession(t){let n=(t,n)=>new e(`3dtiles-init:`+t,n);return this._rootRequestPromise||=new Promise((e,i)=>{this.url||i(n(`url-missing`,`Layer url missing`)),this._key=this.customParameters?this.customParameters.key:null,new Promise((e,t)=>{if(this.replacesTerrain&&!this._key){let r=this.portalItem?.portal||this.parent?.portalItem?.portal||C.getDefault();r.signIn().then(()=>{r.g3dTilesEnabled?m(r.restUrl+`/portals/self/modules/g3dtiles`,{responseType:`json`,query:{f:`json`}}).then(t=>{this._key=t.data.keyString,e()},()=>t(n(`g3dtiles-key-error`,`Error fetching Google 3D Tiles key from portal`))):t(n(`g3dTilesEnabled-false`,`Google 3D Tiles are not enabled on Portal `+r.url))},()=>t(n(`sign-in-failed`,`Error signing in to Portal`)))}else e()}).then(()=>{m(this.url,{query:this._key?{key:this._key,token:this.apiKey}:{token:this.apiKey},responseType:`array-buffer`,signal:t}).then(t=>{try{this._rootTilesetJSON=JSON.parse(new TextDecoder().decode(t.data))}catch(e){i(n(`root-parse-failed`,`Error parsing root tile, details: `+e));return}this._rootTilesetJSON?(this._session=this._findSessionParameter(this._rootTilesetJSON),this._rootTileset=t.data,this.fullExtent=A(this._rootTilesetJSON),e(),this._rootRequestPromise=null):i(n(`root-is-null`,`Root tile is null.`))},e=>{T(e),i(n(`root-load-failed`,`Error loading root tile`)),this._rootRequestPromise=null,r.getLogger(`IntegratedMesh3DTilesLayer`).error(`Layer loading failed`,e)})},e=>i(e))}),this._rootRequestPromise}async _doLoad(t){let n=t==null?null:t.signal;if(this.isUsedAsGroundLayer&&!i(`enable-feature:basemap-groundlayers`))throw new e(`3dtiles-init:not-supported-in-groundlayers`,`Layer is not supported in basemap.`);try{await this.loadFromPortal({supportedTypes:[`3DTiles Service`],validateItem:t=>{if(t.typeKeywords?.includes(`IntegratedMesh`))return!0;throw new e(`portal:invalid-layer-item-type`,"Invalid layer item, expected '${expectedType}' ",{expectedType:`3DTiles Service containing IntegratedMesh`})}},t)}catch(e){T(e)}if(this._modificationsSource!=null){let e=await j.fromUrl(this._modificationsSource.url,this.spatialReference,t);this.setAtOrigin(`modifications`,e,this._modificationsSource.context.origin),this._modificationsSource=null}await this.requestRootAndSession(n)}beforeSave(){if(this._modificationsSource!=null)return this.load().then(()=>{},()=>{})}get hasAttributionData(){return!1}_validateElevationInfo(e){let t=`Integrated mesh 3d tiles layers`;O(r.getLogger(this),k(t,`absolute-height`,e)),O(r.getLogger(this),D(t,e))}get replacesTerrain(){return!!i(`enable-feature:basemap-groundlayers`)&&this.hasGoogleUrl&&this.isUsedAsGroundLayer}get isUsedAsGroundLayer(){return a(this.parent)}get hasGoogleUrl(){return!!this.url?.match(/.+\.googleapis.com/)}};y([n({type:[`IntegratedMesh3DTilesLayer`]})],M.prototype,`operationalLayerType`,void 0),y([n({type:j,clonable:e=>e.clone()}),w({origins:[`web-scene`,`portal-item`],type:`resource`,prefix:`modifications`})],M.prototype,`modifications`,void 0),y([p([`web-scene`,`portal-item`],`modifications`)],M.prototype,`readModifications`,null),y([n({type:c})],M.prototype,`spatialReference`,void 0),y([n({type:E})],M.prototype,`fullExtent`,void 0),y([n(v)],M.prototype,`elevationInfo`,null),y([n({type:[`show`,`hide`]})],M.prototype,`listMode`,void 0),y([n(s)],M.prototype,`url`,void 0),y([n({readOnly:!0})],M.prototype,`type`,void 0),y([n({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],M.prototype,`path`,void 0),y([n({type:Number,json:{name:`layerDefinition.minScale`,write:!0,origins:{service:{read:!1,write:!1}}}})],M.prototype,`minScale`,void 0),y([n({type:Number,json:{name:`layerDefinition.maxScale`,write:!0,origins:{service:{read:!1,write:!1}}}})],M.prototype,`maxScale`,void 0),y([n({readOnly:!0})],M.prototype,`hasAttributionData`,null),y([n()],M.prototype,`replacesTerrain`,null),y([n()],M.prototype,`isUsedAsGroundLayer`,null),y([n()],M.prototype,`hasGoogleUrl`,null),M=y([f(`esri.layers.IntegratedMesh3DTilesLayer`)],M);var N=M;export{N as default};