import{$v as e,fD as t,mn as n,wn as r}from"./index-CzMixifc.js";import{n as i}from"./arcadeEnvironment-BvmpPtDd.js";import"./ImmutableArray-C3KNQCVd.js";import{W as a,Y as o,g as s,k as c,s as l}from"./Dictionary-CGt1qKCN.js";import{n as u}from"./shared-DVF4C5pR.js";import"./number-D2fZD7kK.js";import"./Feature-2QyVo8eG.js";import"./memoryEstimations-C3WUBUZI.js";import"./OptimizedGeometry-5fDazGe-.js";import"./OptimizedFeatureSet-D4F9ObY_.js";import"./featureConversionUtils-VvJ2pauf.js";import"./WhereClause-2gh-KjwG.js";import{t as d}from"./operatorsWorkerConnection-D_CeJsIM.js";import{C as f,S as p,i as m}from"./FeatureSet-B1gniK-o.js";import{t as h}from"./Empty-D8NMSeY8.js";var g=class extends m{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.actions.SpatialFilter`,this._maxProcessing=40,this._parent=e.parentfeatureset,this._relation=e.relation,this._relationString=e.relationString??``,this._relationGeom=e.relationGeom}get _spatialFilter(){return{relation:this._relation===`esriSpatialRelRelation`?`esriSpatialRelRelation:${this._relationString}`:this._relation,geometry:this._relationGeom}}async _queryAll(){return(await this.query({abortSignal:i})).features}async query(e){await this._ensureLoaded();let t=await this._parent.query({...e,spatialFilter:this._spatialFilter});return f(e.abortSignal),{...t,spatialFilterApplied:e.spatialFilter==null,features:t.spatialFilterApplied?t.features:this._applySpatialFilter(t.features,e.abortSignal)}}async*_applySpatialFilter(e,t){for await(let n of e){f(t);let e=[];for(let t of n)await this._executeSpatialRelationTest(t)&&e.push(t);e.length>0&&(yield e)}}async queryStat(e){if(e.spatialFilter!=null)return{calculated:!1};let t=await this._parent.queryStat({...e,spatialFilter:this._spatialFilter});return t.calculated?t:e.where==null&&e.spatialFilter==null?this._manualStat(e.stat,e.field,e.limit??1e3,e.abortSignal):{calculated:!1}}async canQueryAggregate(e){return e.spatialFilter==null&&this._parent.canQueryAggregate({...e,spatialFilter:this._spatialFilter})}async queryAggregate(e){if(e.spatialFilter!=null)throw new p(`NeverReach`);return this._parent.queryAggregate({...e,spatialFilter:this._spatialFilter})}async _executeSpatialRelationTest(r){if(r.geometry==null)return!1;switch(this._relation){case`esriSpatialRelEnvelopeIntersects`:{let t=n(this._relationGeom),i=e(r.geometry);return t!=null&&i!=null&&d(`intersects`,[t.toJSON(),i])}case`esriSpatialRelIntersects`:return d(`intersects`,[this._relationGeom.toJSON(),r.geometry]);case`esriSpatialRelContains`:return d(`contains`,[this._relationGeom.toJSON(),r.geometry]);case`esriSpatialRelOverlaps`:return d(`overlaps`,[this._relationGeom.toJSON(),r.geometry]);case`esriSpatialRelWithin`:return d(`within`,[this._relationGeom.toJSON(),r.geometry]);case`esriSpatialRelTouches`:return d(`touches`,[this._relationGeom.toJSON(),r.geometry]);case`esriSpatialRelCrosses`:return d(`crosses`,[this._relationGeom.toJSON(),r.geometry]);case`esriSpatialRelRelation`:return d(`relate`,[this._relationGeom.toJSON(),r.geometry,this._relationString]);default:return t(this._relation),!1}}getFieldsIndex(){return this._parent.getFieldsIndex()}};function _(e){return async(t,i,a)=>{if(o(a,2,2,t,i),(a=s(a))[0]===null&&a[1]===null)return!1;if(l(a[0])){if(c(a[1]))return new g({parentfeatureset:a[0],relation:e,relationGeom:a[1]});if(a[1]===null)return new h({parentfeatureset:a[0]});throw new r(t,`InvalidParameter`,i)}if(c(a[0])){if(c(a[1])){switch(e){case`esriSpatialRelEnvelopeIntersects`:{let e=n(a[0]),t=n(a[1]);return e!=null&&t!=null&&d(`intersects`,[e.toJSON(),t.toJSON()])}case`esriSpatialRelIntersects`:return d(`intersects`,[a[0].toJSON(),a[1].toJSON()]);case`esriSpatialRelContains`:return d(`contains`,[a[0].toJSON(),a[1].toJSON()]);case`esriSpatialRelOverlaps`:return d(`overlaps`,[a[0].toJSON(),a[1].toJSON()]);case`esriSpatialRelWithin`:return d(`within`,[a[0].toJSON(),a[1].toJSON()]);case`esriSpatialRelTouches`:return d(`touches`,[a[0].toJSON(),a[1].toJSON()]);case`esriSpatialRelCrosses`:return d(`crosses`,[a[0].toJSON(),a[1].toJSON()])}throw new r(t,`InvalidParameter`,i)}if(l(a[1]))return new g({parentfeatureset:a[1],relation:e,relationGeom:a[0]});if(a[1]===null)return!1;throw new r(t,`InvalidParameter`,i)}if(a[0]===null){if(l(a[1]))return new h({parentfeatureset:a[1]});if(c(a[1])||a[1]===null)return!1}throw new r(t,`InvalidParameter`,i)}}function v(e){e.mode===`async`&&(e.functions.intersects=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelIntersects`))},e.functions.envelopeintersects=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelEnvelopeIntersects`))},e.signatures.push({name:`envelopeintersects`,min:2,max:2}),e.functions.contains=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelContains`))},e.functions.overlaps=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelOverlaps`))},e.functions.within=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelWithin`))},e.functions.touches=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelTouches`))},e.functions.crosses=function(t,n){return e.standardFunctionAsync(t,n,_(`esriSpatialRelCrosses`))},e.functions.relate=function(t,n){return e.standardFunctionAsync(t,n,async(e,i,u)=>{if(u=s(u),o(u,3,3,t,n),c(u[0])&&c(u[1]))return d(`relate`,[u[0].toJSON(),u[1].toJSON(),a(u[2])]);if(c(u[0])&&u[1]===null||c(u[1])&&u[0]===null)return!1;if(l(u[0])&&u[1]===null)return new h({parentfeatureset:u[0]});if(l(u[1])&&u[0]===null)return new h({parentfeatureset:u[1]});if(l(u[0])&&c(u[1]))return new g({parentfeatureset:u[0],relation:`esriSpatialRelRelation`,relationGeom:u[1],relationString:a(u[2])});if(l(u[1])&&c(u[0]))return new g({parentfeatureset:u[1],relation:`esriSpatialRelRelation`,relationGeom:u[0],relationString:a(u[2])});if(u[0]===null&&u[1]===null)return!1;throw new r(t,`InvalidParameter`,n)})})}export{v as registerFunctions};