import{hn as R,sR as sn,dF as He,sY as tt,ck as G,n7 as Mt,t1 as kn,sS as kr,dH as Be,jl as qn,hJ as Ci,t2 as nn,ea as ye,hk as Ni,cf as it,hI as an,n5 as Yn,cM as Y,fK as oe,c6 as St,cw as X,cd as D,b1 as on,bN as Ie,gX as Jn,b4 as ln,b2 as $r,ac as wi,t3 as qr,t4 as Xn,i$ as Ai,al as Rt,aE as u,aF as x,j7 as Zn,jg as fr,mN as Qn,cI as Ge,d9 as ie,t5 as Yr,pX as Jr,t6 as Wi,pW as ri,cj as Ht,t7 as hn,t8 as Kn,dI as ea,nP as Mr,t9 as ta,ta as Xr,fO as Zr,l5 as $t,tb as Qr,tc as ia,q1 as ra,hl as sa,jc as jt,j9 as re,m2 as Ut,jp as Fi,da as kt,cF as Pe,cG as ee,l7 as na,K as ji,td as cn,aL as Ne,te as Qe,e0 as Qt,aM as Kt,dN as Hi,nv as Kr,tf as aa,a8 as zt,n4 as dn,N as qt,ho as _,tg as oa,lw as gr,_ as Ir,d8 as un,hp as ei,th as la,jG as Ce,je as si,p_ as Ee,hq as es,ti as ha,hK as zi,tj as ca,tk as pn,hD as fn,dx as Ei,tl as F,tm as da,au as B,nu as ts,e5 as ua,l6 as pa,gP as Yt,kk as ke,kl as yt,mM as Pt,hi as is,cS as wt,pq as ae,tn as fa,kj as rs,dM as ga,n3 as ma,to as ss,tp as _a,fv as ns,jQ as ze,tq as va,ds as ya,tr as wa,ts as as,tt as Sa,tu as Ta,tv as gn,b9 as Gi,fd as os,b6 as ba,fu as xa,tw as Bi,l4 as Oa,sT as ki,tx as Ra,ty as Ca,cg as ls,pZ as Aa,tz as Ea,ji as Da,tA as $a,dG as Ma,dY as Ia,x as Pa,js as La,tB as Na,oG as Fa,tC as ja,tD as Ua}from"./index-DzfnmjFP.js";import{r as J,n as Ae,t as hs}from"./vec3f32-nZdmKIgz.js";import{t as Pr,a as cs}from"./DoubleArray-vvGJsfPE.js";import{r as ds,n as us,d as ps,R as Di,o as Lr,g as mn,s as Ui,e as Vt,h as _n,i as I,j as Le,k as vn,l as be,m as fs,p as Va,f as Wa,w as Nr,b as Si,q as Ha,u as za,x as Ga,y as Ba,c as ka,z as qa,P as Ya,A as Ja,B as qi,C as Fr,D as jr,E as Yi,F as Xa,G as Za,H as Qa,I as Ka,J as gs,K as ms,L as eo,O as to,M as _s,N as io,Q as ro,S as so,T as no,U as Ur,V as te,t as ao,W as oo,X as we,Y as lo,_ as Ji,Z as ho,$ as co,a0 as uo,a1 as po,a2 as fo,a3 as go,a4 as mo,a5 as xe,a6 as vs}from"./IntegerPassUniform-C4orcbhQ.js";import{A as Vr,l as _o}from"./Indices-BYieEVYU.js";import{s as pe,m as vo,u as yo,c as ot,f as ni,l as wo}from"./Util-Cv2AMtKx.js";import{u as So}from"./hydratedFeatures-7n7nUTHP.js";import{p as $i,a as yn}from"./triangulationUtils-D-x_1Xxe.js";import{o as P,b as To,g as bo,c as ys,e as xo}from"./NormalAttribute.glsl-D_IY537z.js";import{Y as Oo,H as Ro,N as Co,L as Ao,j as ai}from"./Octree-rROAz83p.js";import"./BindType-BmZEZMMh.js";import{b as Eo,d as ws,y as Ss}from"./axisAngleDegrees-DlBeYaSx.js";import{t as Wr}from"./NestedMap-DgiGbX8E.js";import{H as Do}from"./InterleavedLayout-rpfDyLJZ.js";import{f as oi,E as Ts,M as $o,_ as Mi,F as Mo,R as Tt,L as Io}from"./enums-BlUEVwJR.js";import{S as Ke,o as Po,_ as Ct,l as Lo,s as No}from"./renderState-BxbDJrNm.js";import{c as mr,e as Fo}from"./Texture-DqEAKFgW.js";import{t as jo}from"./glUtil-C6KhMg1m.js";import{o as Uo}from"./VertexArrayObject-Cd7vfrr6.js";import{c as Vo}from"./BufferObject-eYlZ7iXJ.js";import"./floatRGBA-RLC-pnKC.js";function wn(t){return t.type==="point"}let Lc=class{constructor(e,i=null,r=0){this.array=e,this.spatialReference=i,this.offset=r}};function Sn(t){return"array"in t}function li(t,e,i="ground"){if(wn(e))return t.getElevation(e.x,e.y,e.z||0,e.spatialReference,i);if(Sn(e)){let r=e.offset;return t.getElevation(e.array[r++],e.array[r++],e.array[r]||0,e.spatialReference??t.spatialReference,i)}return t.getElevation(e[0],e[1],e[2]||0,t.spatialReference,i)}function Wo(t){t.code.add(R`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}
const vec4 RGBA_2_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, RGBA_2_FLOAT_FACTORS);
}`)}var Gt,Ii,_r;(function(t){t[t.RasterImage=0]="RasterImage",t[t.Features=1]="Features"})(Gt||(Gt={})),function(t){t[t.MapLayer=0]="MapLayer",t[t.ViewLayer=1]="ViewLayer",t[t.Outline=2]="Outline",t[t.SnappingHint=3]="SnappingHint"}(Ii||(Ii={})),function(t){t[t.WithRasterImage=0]="WithRasterImage",t[t.WithoutRasterImage=1]="WithoutRasterImage"}(_r||(_r={}));var Pi,Me;(function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"})(Pi||(Pi={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}(Me||(Me={}));var Jt;(function(t){t[t.ASYNC=0]="ASYNC",t[t.SYNC=1]="SYNC"})(Jt||(Jt={}));let Ho=class extends sn{get geometries(){return this._geometries}get transformation(){return this._transformation??He}set transformation(e){this._transformation=tt(this._transformation??G(),e),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?tt(this._shaderTransformation??G(),e):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}constructor(e={}){super(),this.type=Mt.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerUid=e.layerUid,e.isElevationSource&&(this.lastValidElevationBB=new Tn),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){pe(this._parentLayer==null||e==null,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._emit("geometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const i=this._geometries.splice(e,1)[0];i&&(this._emit("geometryRemoved",{object:this,geometry:i}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,i,r=!1){this._emit("attributesChanged",{object:this,geometry:e,attribute:i,sync:r}),kn(i)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const i of this._geometries)i.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new ds(kr.MaskOccludee);for(const i of this._geometries)i.occludees=us(i.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const i of this._geometries)i.occludees=ps(i.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new ds(kr.Highlight);for(const i of this._geometries)i.highlights=us(i.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const i of this._geometries)i.highlights=ps(i.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,i){return Be(i,this.transformation,e.transformation)}getCombinedShaderTransformation(e,i=G()){return Be(i,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new bs,this._validateBoundingVolume(this._bvWorldSpace,Bt.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new bs,this._validateBoundingVolume(this._bvObjectSpace,Bt.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,i){const r=i===Bt.ObjectSpace;for(const s of this._geometries){const n=s.boundingInfo;n&&zo(n,e,r?s.transformation:this.getCombinedShaderTransformation(s))}qn(Ci(e.bounds),e.min,e.max,.5);for(const s of this._geometries){const n=s.boundingInfo;if(n==null)continue;const a=r?s.transformation:this.getCombinedShaderTransformation(s),o=nn(a);ye(xs,n.center,a);const l=Ni(xs,Ci(e.bounds)),h=n.radius*o;e.bounds[3]=Math.max(e.bounds[3],l+h)}}_invalidateBoundingVolume(){var i;const e=(i=this._bvWorldSpace)==null?void 0:i.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&e&&this._parentLayer.notifyObjectBBChanged(this,e)}_emit(e,i){this._parentLayer&&this._parentLayer.events.emit(e,i)}get test(){}},Tn=class{constructor(){this.min=it(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=it(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}},bs=class extends Tn{constructor(){super(...arguments),this.bounds=an()}};function zo(t,e,i){const r=t.bbMin,s=t.bbMax;if(Yn(i)){const n=Y(Go,i[12],i[13],i[14]);oe(_e,r,n),oe(Oe,s,n);for(let a=0;a<3;++a)e.min[a]=Math.min(e.min[a],_e[a]),e.max[a]=Math.max(e.max[a],Oe[a])}else if(ye(_e,r,i),St(r,s))for(let n=0;n<3;++n)e.min[n]=Math.min(e.min[n],_e[n]),e.max[n]=Math.max(e.max[n],_e[n]);else{ye(Oe,s,i);for(let n=0;n<3;++n)e.min[n]=Math.min(e.min[n],_e[n],Oe[n]),e.max[n]=Math.max(e.max[n],_e[n],Oe[n]);for(let n=0;n<3;++n){X(_e,r),X(Oe,s),_e[n]=s[n],Oe[n]=r[n],ye(_e,_e,i),ye(Oe,Oe,i);for(let a=0;a<3;++a)e.min[a]=Math.min(e.min[a],_e[a],Oe[a]),e.max[a]=Math.max(e.max[a],_e[a],Oe[a])}}}const Go=D(),_e=D(),Oe=D(),xs=D();var Bt;(function(t){t[t.WorldSpace=0]="WorldSpace",t[t.ObjectSpace=1]="ObjectSpace"})(Bt||(Bt={}));const Bo=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];let ko=class extends sn{get objects(){return this._objects}constructor(e,i,r=""){super(),this.stage=e,this.apiLayerUid=r,this.type=Mt.Layer,this.events=new on,this.visible=!0,this.pickable=!0,this.sliceable=!1,this._objects=new Ie,this._objectsAdded=new Ie,this._handles=new Jn,this.apiLayerUid=r,this.visible=(i==null?void 0:i.visible)??!0,this.pickable=(i==null?void 0:i.pickable)??!0,this.updatePolicy=(i==null?void 0:i.updatePolicy)??Jt.ASYNC,this._disableOctree=(i==null?void 0:i.disableOctree)??!1,e.add(this);for(const s of Bo)this._handles.add(this.events.on(s,n=>e.handleEvent(s,n)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),this._octree!=null&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),this._octree!=null&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(const i of e)i.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),this._octree!=null&&this._objectsAdded.pushArray(e)}removeMany(e){const i=new Array;if(this._objects.removeUnorderedMany(e,e.length,i),i.length!==0){for(const r of i)r.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:i}),this._octree!=null){for(let r=0;r<i.length;)this._objectsAdded.removeUnordered(i[r])?(i[r]=i[i.length-1],i.length-=1):++r;this._octree.remove(i)}}}sync(){this.updatePolicy!==Jt.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,i){this._octree==null||this._objectsAdded.includes(e)||this._octree.update(e,i)}getSpatialQueryAccelerator(){return this._octree==null&&this._objects.length>50&&!this._disableOctree?(this._octree=new Oo(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)):this._octree!=null&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}invalidateSpatialQueryAccelerator(){this._octree=ln(this._octree),this._objectsAdded.clear()}};const qo={required:[]},Wc={required:[P.Depth]};let Hr=class extends $r{consumes(){return qo}get usedMemory(){return 0}get isDecoration(){return!1}get running(){return!1}get materialReference(){return null}modify(e){}get numGeometries(){return 0}get hasOccludees(){return!1}queryRenderOccludedState(e){return!1}},Yo=class extends Hr{},Jo=class extends Hr{constructor(){super(...arguments),this.drapedPriority=0}},Bc=class extends Hr{},Xo=class extends Uo{};var et,Os,Rs,Cs;(function(t){t[t.INNER=0]="INNER",t[t.OUTER=1]="OUTER"})(et||(et={})),function(t){t[t.REGULAR=0]="REGULAR",t[t.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",t[t.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",t[t.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(Os||(Os={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON"}(Rs||(Rs={})),function(t){t[t.FADING=0]="FADING",t[t.IMMEDIATE=1]="IMMEDIATE",t[t.UNFADED=2]="UNFADED"}(Cs||(Cs={}));let Zo=class{constructor(e,i){this.vec3=e,this.id=i}};function vr(t,e,i,r){return new Zo(it(t,e,i),r)}let As=class{constructor(){this._extent=wi(),this.resolution=0,this.renderLocalOrigin=vr(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new Qo}get extent(){return this._extent}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const i=.001*e.range;if(this._extent[0]-i<=e.min){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];qr(this._extent,e.range,0,r)}if(this._extent[2]+i>=e.max){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];qr(this._extent,-e.range,0,r)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,Xn(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const i=this.canvasGeometries.extents[e];if(i[0]!==i[2]&&i[1]!==i[3])return!0}return!1}},Qo=class{constructor(){this.extents=[wi(),wi(),wi()],this.numViews=0}};var le;(function(t){t[t.Color=0]="Color",t[t.ColorNoRasterImage=1]="ColorNoRasterImage",t[t.Highlight=2]="Highlight",t[t.WaterNormal=3]="WaterNormal",t[t.Occluded=4]="Occluded",t[t.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"})(le||(le={}));let Ko=class{constructor(e,i,r){this._fbos=e,this._format=i,this._name=r}get valid(){var e;return((e=this._handle)==null?void 0:e.getTexture())!=null}dispose(){this._handle=Ai(this._handle)}get texture(){var e;return(e=this._handle)==null?void 0:e.getTexture()}bind(e,i,r){var s,n,a,o,l,h;this._handle&&((s=this._handle.fbo)==null?void 0:s.width)===i&&((n=this._handle.fbo)==null?void 0:n.height)===r||((a=this._handle)==null||a.release(),this._handle=this._fbos.acquire(i,r,this._name,this._format)),e.unbindTexture((l=(o=this._handle)==null?void 0:o.fbo)==null?void 0:l.colorTexture),e.bindFramebuffer((h=this._handle)==null?void 0:h.fbo)}generateMipMap(){var e,i,r,s,n;(r=(i=(e=this._handle)==null?void 0:e.getTexture())==null?void 0:i.descriptor)!=null&&r.hasMipmap&&((n=(s=this._handle)==null?void 0:s.getTexture())==null||n.generateMipmap())}},lt=class{constructor(e,i,r,s,n=Di.RGBA_MIPMAP){this.output=r,this.content=s,this.fbo=new Ko(e,n,i)}get valid(){return this.fbo.valid}},el=class{constructor(e){this.targets=[new lt(e,"overlay color",P.Color,le.Color),new lt(e,"overlay IM color",P.Color,le.ColorNoRasterImage),new lt(e,"overlay highlight",P.Highlight,le.Highlight,Di.RGBA4),new lt(e,"overlay water",P.Normal,le.WaterNormal),new lt(e,"overlay occluded",P.Color,le.Occluded)],Rt("enable-feature:objectAndLayerId-rendering")&&this.targets.push(new lt(e,"overlay oid",P.ObjectAndLayerIdColor,le.ObjectAndLayerIdColor))}getTexture(e){var i;return(i=this.targets[e])==null?void 0:i.fbo.texture}dispose(){for(const e of this.targets)e.fbo.dispose()}computeValidity(){return this.targets.reduce((e,i,r)=>i.valid?e|=1<<r:e,0)}};function tl(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/e)}function il(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/i)}function rl(t,e,i){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}function sl(t,e,i){return 2*Math.atan(i*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}let nl=class{constructor(){this.adds=new Ie,this.removes=new Ie,this.updates=new Ie({allocator:e=>e||new al,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},al=class{},ol=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}};var Es,U;function ll(t){const e=new Map,i=r=>{let s=e.get(r);return s||(s=new ol,e.set(r,s)),s};return t.removes.forAll(r=>{Xi(r)&&i(r.material).removes.push(r)}),t.adds.forAll(r=>{Xi(r)&&i(r.material).adds.push(r)}),t.updates.forAll(r=>{Xi(r.renderGeometry)&&i(r.renderGeometry.material).updates.push(r)}),e}function Xi(t){return t.geometry.indexCount>=1}(function(t){t[t.Default=0]="Default",t[t.Screenshot=1]="Screenshot",t[t.ObjectAndLayerID=2]="ObjectAndLayerID"})(Es||(Es={})),function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"}(U||(U={}));var yr;let M=yr=class extends $r{constructor(t){super(t),this._ray=Zn(),this._viewport=fr(0,0,1,1),this._padding=fr(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Qn(1,1e3),this._viewDirty=!0,this._viewMatrix=G(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=G(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=G(),this._frustumDirty=!0,this._frustum=Ro(),this._fullViewport=Ge(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=D(),this._up=D(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get rows(){return this._rows}set rows(t){this._rows=Math.max(1,t)}get columns(){return this._columns}set columns(t){this._columns=Math.max(1,t)}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return ie(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){tt(this._viewMatrix,t),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),Y(D(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),Y(D(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),Y(D(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const t=Yr(Ge(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&Jr(t,e)?e:t}get screenPadding(){if(this.pixelRatio===1)return this._padding;const t=Yr(Ge(),this._padding,1/this.pixelRatio),e=this._get("screenPadding");return e&&Jr(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[U.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[U.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[U.RIGHT]+this._padding[U.LEFT]}set fullWidth(t){this.width=t-(this._padding[U.RIGHT]+this._padding[U.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[U.TOP]+this._padding[U.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[U.TOP]+this._padding[U.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[U.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[U.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){Wi(this._padding,t)||(this._viewport[0]+=t[U.LEFT]-this._padding[U.LEFT],this._viewport[1]+=t[U.BOTTOM]-this._padding[U.BOTTOM],this._viewport[2]-=t[U.RIGHT]+t[U.LEFT]-(this._padding[U.RIGHT]+this._padding[U.LEFT]),this._viewport[3]-=t[U.TOP]+t[U.BOTTOM]-(this._padding[U.TOP]+this._padding[U.BOTTOM]),ri(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(Be(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return Ht(G(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||G()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return rl(this._fov,this.width,this.height)}set fovX(t){this._fov=tl(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return sl(this._fov,this.width,this.height)}set fovY(t){this._fov=il(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return Ni(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(Ht(this._viewInverseTransposeMatrix,this.viewMatrix),hn(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){const t=this.width,e=this.height,i=this.near*Math.tan(this.fovY/2)*2,r=i*this._aspect,s=i/this.rows,n=r/this.columns,a=-r/2+this.column*n,o=a+n,l=-i/2+this.row*s,h=l+s,c=Kn(G(),a*(1+2*this._padding[U.LEFT]/t),o*(1+2*this._padding[U.RIGHT]/t),l*(1+2*this._padding[U.BOTTOM]/e),h*(1+2*this._padding[U.TOP]/e),this.near,this.far),d=this._get("projectionMatrix");return d&&ea(d,c)?d:c}copyFrom(t){X(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,ri(this._viewport,t.viewport),this.notifyChange("_viewport"),ri(this._padding,t.padding),this.notifyChange("_padding"),Mr(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.row=t.row,this.column=t.column,this.rows=t.rows,this.columns=t.columns,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(tt(this._viewMatrix,t.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(Co(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(tt(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),ri(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up}clone(){return new yr().copyFrom(this)}equals(t){return St(this.eye,t.eye)&&St(this.center,t.center)&&St(this.up,t.up)&&Wi(this._viewport,t.viewport)&&Wi(this._padding,t.padding)&&ta(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation&&this.row===t.row&&this.column===t.column&&this.rows===t.rows&&this.columns===t.columns}almostEquals(t){const e=Math.max(1,1/this.pixelRatio,1/t.pixelRatio);if(Math.abs(t.fov-this._fov)>=.001||Xr(t.screenPadding,this.screenPadding)>=e||Xr(this.screenViewport,t.screenViewport)>=e||this.row!==t.row||this.column!==t.column||this.rows!==t.rows||this.columns!==t.columns)return!1;Zr(se,t.eye,t.center),Zr(Zi,this.eye,this.center);const i=$t(se,Zi),r=Qr(se),s=Qr(Zi),n=5e-4;return i*i>=(1-1e-10)*r*s&&ia(t.eye,this.eye)<Math.max(r,s)*n*n}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(ra(this.viewForward,ie(se,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=sa()){return t[0]=(this.padding[U.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[U.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,i=.5){return t[0]=this.padding[U.LEFT]+this.width*e,t[1]=this.padding[U.BOTTOM]+this.height*i,t[2]=.5,t}setGLViewport(t){const e=this.viewport,i=this.padding;t.setViewport(e[0]-i[3],e[1]-i[2],e[2]+i[1]+i[3],e[3]+i[0]+i[2])}applyProjection(t,e){t!==L&&X(L,t),L[3]=1,jt(L,L,this.projectionMatrix);const i=Math.abs(L[3]);re(L,L,1/i);const r=this.fullViewport;e[0]=Ut(0,r[0]+r[2],.5+.5*L[0]),e[1]=Ut(0,r[1]+r[3],.5+.5*L[1]),e[2]=.5*(L[2]+1),e[3]=i}unapplyProjection(t,e){const i=this.fullViewport;L[0]=(t[0]/(i[0]+i[2])*2-1)*t[3],L[1]=(t[1]/(i[1]+i[3])*2-1)*t[3],L[2]=(2*t[2]-1)*t[3],L[3]=t[3],this.inverseProjectionMatrix!=null&&(jt(L,L,this.inverseProjectionMatrix),e[0]=L[0],e[1]=L[1],e[2]=L[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,Qi),this.renderToScreen(Qi,e),e}projectToRenderScreen(t,e){if(L[0]=t[0],L[1]=t[1],L[2]=t[2],L[3]=1,jt(L,L,this.viewProjectionMatrix),L[3]===0)return null;const i=L;re(i,i,1/Math.abs(L[3]));const r=this.fullViewport,s=Ut(0,r[0]+r[2],.5+.5*i[0]),n=Ut(0,r[1]+r[3],.5+.5*i[1]);return"x"in e?(e.x=s,e.y=n):(e[0]=s,e[1]=n,e.length>2&&(e[2]=.5*(i[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,Qi),e)}unprojectFromRenderScreen(t,e){if(Be(hi,this.projectionMatrix,this.viewMatrix),!Ht(hi,hi))return null;const i=this.fullViewport;return L[0]=2*(t[0]-i[0])/i[2]-1,L[1]=2*(t[1]-i[1])/i[3]-1,L[2]=2*t[2]-1,L[3]=1,jt(L,L,hi),L[3]===0?null:(e[0]=L[0]/L[3],e[1]=L[1]/L[3],e[2]=L[2]/L[3],e)}constrainWindowSize(t,e,i,r){const s=t*this.pixelRatio,n=e*this.pixelRatio,a=Math.max(s-i/2,0),o=Math.max(this.fullHeight-n-r/2,0),l=-Math.min(s-i/2,0),h=-Math.min(this.fullHeight-n-r/2,0),c=i-l- -Math.min(this.fullWidth-s-i/2,0),d=r-h- -Math.min(n-r/2,0);return[Math.round(a),Math.round(o),Math.round(c),Math.round(d)]}computeUp(t){t===Fi.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){const i=t[0]*this.pixelRatio,r=this.fullHeight-t[1]*this.pixelRatio;return e[0]=i,e[1]=r,e}renderToScreen(t,e){const i=t[0]/this.pixelRatio,r=(this.fullHeight-t[1])/this.pixelRatio;e[0]=i,e[1]=r}_computeUpGlobal(){ie(se,this.center,this.eye);const t=kt(this.center);t<1?(Y(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs($t(se,this.center))>.9999*kt(se)*t||(Pe(this._up,se,this.center),Pe(this._up,this._up,se),ee(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){na(se,this.eye,this.center),Math.abs(se[2])<=.9999&&(re(se,se,se[2]),Y(this._up,-se[0],-se[1],1-se[2]),ee(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(t,e,i=""){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?St(t,e)||(X(e,t),this._markViewDirty(),i.length&&this.notifyChange(i)):ji.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(Ao(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(cn(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};u([x()],M.prototype,"_viewport",void 0),u([x()],M.prototype,"_padding",void 0),u([x()],M.prototype,"_fov",void 0),u([x()],M.prototype,"_nearFar",void 0),u([x()],M.prototype,"_viewDirty",void 0),u([x()],M.prototype,"_viewMatrix",void 0),u([x()],M.prototype,"_pixelRatio",void 0),u([x()],M.prototype,"pixelRatio",null),u([x()],M.prototype,"row",void 0),u([x()],M.prototype,"column",void 0),u([x()],M.prototype,"_rows",void 0),u([x()],M.prototype,"rows",null),u([x()],M.prototype,"_columns",void 0),u([x()],M.prototype,"columns",null),u([x()],M.prototype,"eye",null),u([x()],M.prototype,"center",null),u([x()],M.prototype,"_center",void 0),u([x()],M.prototype,"up",null),u([x()],M.prototype,"_up",void 0),u([x()],M.prototype,"viewMatrix",null),u([x({readOnly:!0})],M.prototype,"viewForward",null),u([x({readOnly:!0})],M.prototype,"viewUp",null),u([x({readOnly:!0})],M.prototype,"viewRight",null),u([x({readOnly:!0})],M.prototype,"nearFar",null),u([x()],M.prototype,"near",null),u([x()],M.prototype,"far",null),u([x()],M.prototype,"viewport",null),u([x({readOnly:!0})],M.prototype,"screenViewport",null),u([x({readOnly:!0})],M.prototype,"screenPadding",null),u([x()],M.prototype,"x",null),u([x()],M.prototype,"y",null),u([x()],M.prototype,"width",null),u([x()],M.prototype,"height",null),u([x()],M.prototype,"fullWidth",null),u([x()],M.prototype,"fullHeight",null),u([x({readOnly:!0})],M.prototype,"_aspect",null),u([x()],M.prototype,"padding",null),u([x({readOnly:!0})],M.prototype,"projectionMatrix",null),u([x({readOnly:!0})],M.prototype,"inverseProjectionMatrix",null),u([x()],M.prototype,"fov",null),u([x()],M.prototype,"fovX",null),u([x()],M.prototype,"fovY",null),u([x()],M.prototype,"viewInverseTransposeMatrix",null),u([x({readOnly:!0})],M.prototype,"_projectionMatrixInternal",null),u([x()],M.prototype,"relativeElevation",void 0),M=yr=u([Ne("esri.views.3d.webgl.RenderCamera")],M);const Vi=M,L=Ge(),hi=G(),se=D(),Zi=D(),Qi=Qe();var Ds;(function(t){t[t.Material=0]="Material",t[t.ShadowMap=1]="ShadowMap",t[t.Highlight=2]="Highlight",t[t.ViewshedShadowMap=3]="ViewshedShadowMap"})(Ds||(Ds={}));var bt,wr;function hl(t){return t!=null&&!t.running}(function(t){t[t.RENDERING=0]="RENDERING",t[t.FADING=1]="FADING",t[t.FINISHED=2]="FINISHED"})(bt||(bt={})),function(t){t[t.RG=0]="RG",t[t.BA=1]="BA"}(wr||(wr={}));var Sr;let ci=Sr=class extends Kt{constructor(t){super(t),this.type="cloudy",this.cloudCover=.5}clone(){return new Sr({cloudCover:this.cloudCover})}};u([Qt({cloudy:"cloudy"})],ci.prototype,"type",void 0),u([x({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ci.prototype,"cloudCover",void 0),ci=Sr=u([Ne("esri.views.3d.environment.CloudyWeather")],ci);var Tr;let di=Tr=class extends Kt{constructor(t){super(t),this.type="foggy",this.fogStrength=.5}clone(){return new Tr({fogStrength:this.fogStrength})}};u([Qt({foggy:"foggy"})],di.prototype,"type",void 0),u([x({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],di.prototype,"fogStrength",void 0),di=Tr=u([Ne("esri.views.3d.environment.FoggyWeather")],di);var br;let Lt=br=class extends Kt{constructor(t){super(t),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new br({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([Qt({rainy:"rainy"})],Lt.prototype,"type",void 0),u([x({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Lt.prototype,"cloudCover",void 0),u([x({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Lt.prototype,"precipitation",void 0),Lt=br=u([Ne("esri.views.3d.environment.RainyWeather")],Lt);var xr;let ht=xr=class extends Kt{constructor(t){super(t),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new xr({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};u([Qt({snowy:"snowy"})],ht.prototype,"type",void 0),u([x({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ht.prototype,"cloudCover",void 0),u([x({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ht.prototype,"precipitation",void 0),u([x({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],ht.prototype,"snowCover",void 0),ht=xr=u([Ne("esri.views.3d.environment.SnowyWeather")],ht);var Or;let ui=Or=class extends Kt{constructor(t){super(t),this.type="sunny",this.cloudCover=.5}clone(){return new Or({cloudCover:this.cloudCover})}};u([Qt({sunny:"sunny"})],ui.prototype,"type",void 0),u([x({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ui.prototype,"cloudCover",void 0),ui=Or=u([Ne("esri.views.3d.environment.SunnyWeather")],ui);const ct=1e4,rd=1e5;let cl=class{constructor(){this.readChannels=wr.RG,this.renderingStage=bt.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=D(),this.parallax=new $s,this.parallaxNew=new $s,this.pointOnGround=D(),this.fadeMode=z.HIDE,this.fadeFactor=0,this.opacity=0}updateParallax(e){const i=this.parallax,r=kt(e.eye);if(i.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(r*r-Hi.radius*Hi.radius,0))/r,ws(Ms,i.anchorPointClouds,dt),Kr(i.transform,He,dt[3],Ss(dt)),this.fadeMode===z.CROSS_FADE){const s=this.parallaxNew;ws(Ms,s.anchorPointClouds,dt),Kr(s.transform,He,dt[3],Ss(dt))}}updateFading(e,i,r,s){this.isFading&&this._advanceFading(r,s),this._evaluateFading(e,i,r)}_evaluateFading(e,i,r){const s=e.relativeElevation,n=this._calculateDistanceToAnchorPoint(e);if((s>1.7*ct||s<-ct||n>gl)&&this.opacity>0)this._setFade(z.HIDE,r);else if(!this.isFading){if((s>ct||s<-.35*ct||n>fl)&&this.opacity>0)this._setFade(z.FADE_OUT,r);else if(s<=ct&&s>=-.35*ct&&i===aa.IDLE&&hl(this.data)){if(this.opacity===0)return void this._setFade(z.FADE_IN,r);(n>pl||this.renderingStage===bt.FADING)&&this._setFade(z.CROSS_FADE,r)}}}_advanceFading(e,i){this._switchReadChannels(),this._updateAnchorPoint(),this._advanceFadingFactorAndOpacity(e,i)}_advanceFadingFactorAndOpacity(e,i){if(this.fadeFactor<1)return this.fadeFactor=i?zt((e-this.startTime)/(ul*i),0,1):1,this.fadeMode===z.FADE_OUT&&(this.opacity=1-this.fadeFactor),this.fadeMode===z.FADE_IN&&(this.opacity=this.fadeFactor),void(this.fadeMode===z.CROSS_FADE&&(this.opacity=1));this.fadeFactor=0,this.fadeMode===z.FADE_OUT&&(this.opacity=0),this.fadeMode===z.FADE_IN&&(this.opacity=1),this.fadeMode===z.CROSS_FADE&&(this.opacity=1),this.fadeMode=z.NONE}_switchReadChannels(){const e=this.fadeMode===z.CROSS_FADE&&this.fadeFactor===1,i=this.fadeMode===z.FADE_IN&&this.fadeFactor===0;this.renderingStage===bt.FADING&&(e||i)&&(this.readChannels=1-this.readChannels,this.renderingStage=bt.FINISHED)}_calculateDistanceToAnchorPoint(e){return ee(this.pointOnGround,e.eye),re(this.pointOnGround,this.pointOnGround,Hi.radius),kt(ie(dl,this.parallax.anchorPointClouds,this.pointOnGround))}_updateAnchorPoint(){this.fadeMode===z.CROSS_FADE&&(this.fadeFactor===0&&X(this.parallaxNew.anchorPointClouds,this.pointOnGround),this.fadeFactor===1&&X(this.parallax.anchorPointClouds,this.parallaxNew.anchorPointClouds)),this.fadeMode===z.FADE_IN&&this.fadeFactor===0&&X(this.parallax.anchorPointClouds,this.pointOnGround)}_setFade(e,i){switch(e){case z.HIDE:this.opacity=0;break;case z.FADE_OUT:this.opacity=1;break;case z.FADE_IN:this.opacity=0;break;case z.CROSS_FADE:this.opacity=1}this.fadeMode=e,this.fadeFactor=0,this.startTime=i}get isFading(){return this.fadeMode===z.FADE_OUT||this.fadeMode===z.FADE_IN||this.fadeMode===z.CROSS_FADE}};var z;(function(t){t[t.NONE=0]="NONE",t[t.HIDE=1]="HIDE",t[t.FADE_OUT=2]="FADE_OUT",t[t.FADE_IN=3]="FADE_IN",t[t.CROSS_FADE=4]="CROSS_FADE"})(z||(z={}));let $s=class{constructor(){this.anchorPointClouds=D(),this.radiusCurvatureCorrectionFactor=0,this.transform=G()}};const Ms=it(0,0,1),dt=Eo(),dl=D(),ul=1.25,pl=34e3,fl=64e3,gl=2e5;var xt;(function(t){t[t.Disabled=0]="Disabled",t[t.Enabled=1]="Enabled",t[t.EnabledWithWater=2]="EnabledWithWater",t[t.COUNT=3]="COUNT"})(xt||(xt={}));let zr=class extends dn{constructor(){super(...arguments),this.color=it(1,1,1)}};function bn(){const t=new Lr;return t.include(mn),t.fragment.uniforms.add(new Ui("tex",e=>e.texture),new Vt("uColor",e=>e.color)),t.fragment.code.add(R`void main() {
vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);
}`),t}const ml=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:zr,build:bn},Symbol.toStringTag,{value:"Module"}));let _l=class{constructor(e){this._context=e,this._perConstructorInstances=new Wr,this._frameCounter=0,this._keepAliveFrameCount=Is}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach(e=>e.forEach(i=>i.technique.destroy())),this._perConstructorInstances.clear()}acquire(e,i=yl){const r=i.key;let s=this._perConstructorInstances.get(e,r);if(s==null){const n=new e(this._context,i,()=>this.release(n));s=new vl(n),this._perConstructorInstances.set(e,r,s)}return++s.refCount,s.technique}releaseAndAcquire(e,i,r){if(r!=null){if(i.key===r.key)return r;this.release(r)}return this.acquire(e,i)}release(e){if(e==null||this._perConstructorInstances.empty)return;const i=this._perConstructorInstances.get(e.constructor,e.key);i!=null&&(--i.refCount,i.refCount===0&&(i.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==Is&&this._perConstructorInstances.forEach((e,i)=>{e.forEach((r,s)=>{r.refCount===0&&r.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(r.technique.destroy(),this._perConstructorInstances.delete(i,s))})})}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach((i,r)=>{const s=async(n,a)=>{const o=a.shader;o&&(await o.reload(),n.forEach(l=>l.technique.reload(this._context)))};e.push(s(i,r))}),await Promise.all(e)}},vl=class{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}};const Is=-1,yl=new _n;let wl=class{constructor(e,i,r,s){this._textures=e,this._techniques=i,this.materialChanged=r,this.requestRender=s,this._id2glMaterialRef=new Wr}dispose(){this._textures.destroy()}acquire(e,i,r){this._ownMaterial(e);const s=e.produces.get(i);if(!(s!=null&&s(r)))return null;let n=this._id2glMaterialRef.get(r,e.id);if(n==null){const a=e.createGLMaterial({material:e,techniques:this._techniques,textures:this._textures,output:r});n=new Sl(a),this._id2glMaterialRef.set(r,e.id,n)}return n.ref(),n.glMaterial}release(e,i){const r=this._id2glMaterialRef.get(i,e.id);r!=null&&(r.unref(),r.referenced||(qt(r.glMaterial),this._id2glMaterialRef.delete(i,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&ji.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Sl=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,pe(this._refCnt>=0)}get referenced(){return this._refCnt>0}};var rt,Xt;(function(t){t[t.Draped=0]="Draped",t[t.Screen=1]="Screen",t[t.World=2]="World",t[t.COUNT=3]="COUNT"})(rt||(rt={})),function(t){t[t.Center=0]="Center",t[t.Tip=1]="Tip",t[t.COUNT=2]="COUNT"}(Xt||(Xt={}));let Q=class extends vn{constructor(){super(...arguments),this.output=P.Color,this.transparencyPassType=Le.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.space=rt.Screen,this.hideOnShortSegments=!1,this.hasCap=!1,this.anchor=Xt.Center,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}get draped(){return this.space===rt.Draped}};u([I({count:P.COUNT})],Q.prototype,"output",void 0),u([I({count:Le.COUNT})],Q.prototype,"transparencyPassType",void 0),u([I()],Q.prototype,"occluder",void 0),u([I()],Q.prototype,"hasSlicePlane",void 0),u([I()],Q.prototype,"writeDepth",void 0),u([I({count:rt.COUNT})],Q.prototype,"space",void 0),u([I()],Q.prototype,"hideOnShortSegments",void 0),u([I()],Q.prototype,"hasCap",void 0),u([I({count:Xt.COUNT})],Q.prototype,"anchor",void 0),u([I()],Q.prototype,"hasTip",void 0),u([I()],Q.prototype,"vvSize",void 0),u([I()],Q.prototype,"vvColor",void 0),u([I()],Q.prototype,"vvOpacity",void 0),u([I()],Q.prototype,"hasOccludees",void 0),u([I()],Q.prototype,"multipassEnabled",void 0),u([I()],Q.prototype,"cullAboveGround",void 0),u([I({constValue:!1})],Q.prototype,"occlusionPass",void 0),u([I({constValue:!0})],Q.prototype,"hasVvInstancing",void 0),u([I({constValue:!0})],Q.prototype,"hasSliceTranslatedView",void 0);const Ps=8;function Tl(t,e){const i=t.vertex;i.uniforms.add(new be("intrinsicWidth",r=>r.width)),e.vvSize?(t.attributes.add(_.SIZEFEATUREATTRIBUTE,"float"),i.uniforms.add(new Vt("vvSizeMinSize",r=>r.vvSize.minSize),new Vt("vvSizeMaxSize",r=>r.vvSize.maxSize),new Vt("vvSizeOffset",r=>r.vvSize.offset),new Vt("vvSizeFactor",r=>r.vvSize.factor)),i.code.add(R`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(t.attributes.add(_.SIZE,"float"),i.code.add(R`float getSize(){
return intrinsicWidth * size;
}`)),e.vvOpacity?(t.attributes.add(_.OPACITYFEATUREATTRIBUTE,"float"),i.constants.add("vvOpacityNumber","int",8),i.uniforms.add(new fs("vvOpacityValues",r=>r.vvOpacity.values,Ps),new fs("vvOpacityOpacities",r=>r.vvOpacity.opacityValues,Ps)),i.code.add(R`float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):i.code.add(R`vec4 applyOpacity( vec4 color ){
return color;
}`),e.vvColor?(t.include(Va,e),t.attributes.add(_.COLORFEATUREATTRIBUTE,"float"),i.code.add(R`vec4 getColor(){
return applyOpacity(interpolateVVColor(colorFeatureAttribute));
}`)):(t.attributes.add(_.COLOR,"vec4"),i.code.add(R`vec4 getColor(){
return applyOpacity(color);
}`))}function xn(t){return t.pattern.map(e=>Math.round(e*t.pixelRatio))}function bl(t){if(t==null)return 1;const e=xn(t);return Math.floor(e.reduce((i,r)=>i+r))}function xl(t){return xn(t).reduce((e,i)=>Math.max(e,i))}function Ol(t){return t==null?oa:t.length===4?t:gr(Rl,t[0],t[1],t[2],1)}const Rl=Ge();function Cl(t,e){t.constants.add("stippleAlphaColorDiscard","float",.001),t.constants.add("stippleAlphaHighlightDiscard","float",.5),e.stippleEnabled?Al(t,e):El(t)}function Al(t,e){const i=!(e.draped&&e.stipplePreferContinuous),{vertex:r,fragment:s}=t;s.include(Wo),e.draped||(Wa(r,e),r.uniforms.add(new be("worldToScreenPerDistanceRatio",(n,a)=>1/a.camera.perScreenPixelRatio)),r.code.add(R`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),t.varyings.add("vStippleDistance","float"),t.varyings.add("vStippleDistanceLimits","vec2"),t.varyings.add("vStipplePatternStretch","float"),r.code.add(R`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${$l};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),r.code.add(R`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),r.code.add(R`
    if (segmentLengthPseudoScreen >= ${i?"patternLength":"1e4"}) {
  `),Nr(r),r.code.add(R`float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
float segmentLengthScreenRounded = flooredRepetitions * patternLength;
float stretch = repetitions / flooredRepetitions;
vStipplePatternStretch = max(0.75, stretch);
return vec2(0.0, segmentLengthScreenRounded);
}
return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
}`),s.uniforms.add(new Ui("stipplePatternTexture",n=>n.stippleTexture),new be("stipplePatternSDFNormalizer",n=>Dl(n.stipplePattern)),new be("stipplePatternPixelSizeInv",n=>1/On(n))),s.code.add(R`float getStippleSDF(out bool isClamped) {
float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;
float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv * vLineSizeInv;
u = fract(u);
float encodedSDF = rgba2float(texture(stipplePatternTexture, vec2(u, 0.5)));
float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;
return (sdf - 0.5) * vStipplePatternStretch + 0.5;
}
float getStippleSDF() {
bool ignored;
return getStippleSDF(ignored);
}
float getStippleAlpha() {
bool isClamped;
float stippleSDF = getStippleSDF(isClamped);
float antiAliasedResult = clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);
return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
}`),e.stippleOffColorEnabled?(s.uniforms.add(new Si("stippleOffColor",n=>Ol(n.stippleOffColor))),s.code.add(R`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`)):s.code.add(R`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}function El(t){t.fragment.code.add(R`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}function Dl(t){return t?(Math.floor(.5*(xl(t)-1))+.5)/t.pixelRatio:1}function On(t){const e=t.stipplePattern;return e?bl(t.stipplePattern)/e.pixelRatio:1}const $l=R.float(.4),Rn=64,Ml=Rn/2,Il=Ml/5,Pl=Rn/Il,ud=.25;function Ll(t,e){const{vertex:i,constants:r}=t;r.add("markerSizePerLineWidth","float",Pl),Nr(i),i.uniforms.get("markerScale")==null&&i.constants.add("markerScale","float",1),i.code.add(R`float getLineWidth() {
return max(getSize(), 1.0) * pixelRatio;
}
float getScreenMarkerSize() {
return markerSizePerLineWidth * markerScale * getLineWidth();
}`),e.space===rt.World&&(i.constants.add("maxSegmentLengthFraction","float",.45),i.uniforms.add(new be("perRenderPixelRatio",(s,n)=>n.camera.perRenderPixelRatio)),i.code.add(R`bool areWorldMarkersHidden(vec4 pos, vec4 other) {
vec3 midPoint = mix(pos.xyz, other.xyz, 0.5);
float distanceToCamera = length(midPoint);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
float worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;
float segmentLen = length(pos.xyz - other.xyz);
return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
}
float getWorldMarkerSize(vec4 pos) {
float distanceToCamera = length(pos.xyz);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
return getScreenMarkerSize() * screenToWorldRatio;
}`))}var st;(function(t){t[t.BUTT=0]="BUTT",t[t.SQUARE=1]="SQUARE",t[t.ROUND=2]="ROUND",t[t.COUNT=3]="COUNT"})(st||(st={}));let H=class extends vn{constructor(){super(...arguments),this.output=P.Color,this.capType=st.BUTT,this.transparencyPassType=Le.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.wireframe=!1,this.objectAndLayerIdColorInstanced=!1}};u([I({count:P.COUNT})],H.prototype,"output",void 0),u([I({count:st.COUNT})],H.prototype,"capType",void 0),u([I({count:Le.COUNT})],H.prototype,"transparencyPassType",void 0),u([I()],H.prototype,"occluder",void 0),u([I()],H.prototype,"hasSlicePlane",void 0),u([I()],H.prototype,"hasPolygonOffset",void 0),u([I()],H.prototype,"writeDepth",void 0),u([I()],H.prototype,"draped",void 0),u([I()],H.prototype,"stippleEnabled",void 0),u([I()],H.prototype,"stippleOffColorEnabled",void 0),u([I()],H.prototype,"stipplePreferContinuous",void 0),u([I()],H.prototype,"roundJoins",void 0),u([I()],H.prototype,"applyMarkerOffset",void 0),u([I()],H.prototype,"vvSize",void 0),u([I()],H.prototype,"vvColor",void 0),u([I()],H.prototype,"vvOpacity",void 0),u([I()],H.prototype,"falloffEnabled",void 0),u([I()],H.prototype,"innerColorEnabled",void 0),u([I()],H.prototype,"hasOccludees",void 0),u([I()],H.prototype,"multipassEnabled",void 0),u([I()],H.prototype,"cullAboveGround",void 0),u([I()],H.prototype,"wireframe",void 0),u([I()],H.prototype,"objectAndLayerIdColorInstanced",void 0),u([I({constValue:!1})],H.prototype,"occlusionPass",void 0),u([I({constValue:!0})],H.prototype,"hasVvInstancing",void 0),u([I({constValue:!0})],H.prototype,"hasSliceTranslatedView",void 0);const Zt=1;function Cn(t){const e=new Lr,{attributes:i,varyings:r,constants:s,vertex:n,fragment:a}=e;e.include(Ha),e.include(Tl,t),e.include(Cl,t);const o=t.applyMarkerOffset&&!t.draped;o&&(n.uniforms.add(new be("markerScale",f=>f.markerScale)),e.include(Ll,{space:rt.World,draped:!1})),e.include(za,t),Ga(n,t),n.uniforms.add(new Ba("inverseProjectionMatrix",(f,y)=>y.camera.inverseProjectionMatrix),new ka("nearFar",(f,y)=>y.camera.nearFar),new be("miterLimit",f=>f.join!=="miter"?0:f.miterLimit),new Si("viewport",(f,y)=>y.camera.fullViewport)),n.constants.add("LARGE_HALF_FLOAT","float",65500),i.add(_.POSITION,"vec3"),i.add(_.PREVPOSITION,"vec3"),i.add(_.NEXTPOSITION,"vec3"),i.add(_.SUBDIVISIONFACTOR,"float"),i.add(_.UV0,"vec2"),r.add("vColor","vec4"),r.add("vpos","vec3"),r.add("vLineDistance","float"),r.add("vLineWidth","float");const l=t.multipassEnabled&&t.output===P.Color;l&&r.add("depth","float");const h=t.stippleEnabled;h&&r.add("vLineSizeInv","float"),s.add("aaWidth","float",t.stippleEnabled?0:1);const c=t.capType===st.ROUND,d=t.stippleEnabled&&c,g=t.falloffEnabled||d;g&&r.add("vLineDistanceNorm","float"),c&&(r.add("vSegmentSDF","float"),r.add("vReverseSegmentSDF","float")),n.code.add(R`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),n.code.add(R`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),n.code.add(R`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${l?"depth = pos.z;":""}

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),Nr(n),n.code.add(R`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;
      float lineSize = getSize();

      if (lineSize < 1.0) {
        coverage = lineSize; // convert sub-pixel coverage to alpha
        lineSize = 1.0;
      }
      lineSize += aaWidth;

      float lineWidth = lineSize * pixelRatio;
      vLineWidth = lineWidth;
      ${h?R`vLineSizeInv = 1.0 / lineSize;`:""}

      vec4 pos  = view * vec4(position, 1.0);
      vec4 prev = view * vec4(prevPosition, 1.0);
      vec4 next = view * vec4(nextPosition, 1.0);
  `),o&&n.code.add(R`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos, other);
if(!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;
}`),n.code.add(R`clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),(t.stippleEnabled||c)&&n.code.add(R`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${c?R`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),n.code.add(R`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),t.roundJoins?n.code.add(R`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${t.stippleEnabled?R`min(1.0, subdivisionFactor * ${R.float((Zt+2)/(Zt+1))})`:R`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):n.code.add(R`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`);const p=t.capType!==st.BUTT;return n.code.add(R`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${p?R`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),n.code.add(R`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;
    float lineDistNorm = sign(uv0.y) * pos.w;

    vLineDistance =  lineWidth * lineDistNorm;
    ${g?R`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),c&&n.code.add(R`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),t.stippleEnabled&&(t.draped?n.uniforms.add(new be("worldToScreenRatio",(f,y)=>1/y.screenToPCSRatio)):n.code.add(R`vec3 segmentCenter = mix((nextPosition + position) * 0.5, (position + prevPosition) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),n.code.add(R`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(nextPosition - position, position - prevPosition, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),t.draped?n.code.add(R`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):n.code.add(R`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),n.uniforms.add(new be("stipplePatternPixelSize",f=>On(f))),n.code.add(R`float patternLength = lineSize * stipplePatternPixelSize;
vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);
vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);
if (segmentLengthScreenDouble >= 0.001) {
vec2 stippleDisplacement = pos.xy - segmentOrigin;
float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);
vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
}
vStippleDistanceLimits *= pos.w;
vStippleDistance *= pos.w;
vStippleDistanceLimits = isJoin ?
vStippleDistanceLimits :
isStartVertex ?
vec2(-1e34, vStippleDistanceLimits.y) :
vec2(vStippleDistanceLimits.x, 1e34);`)),n.code.add(R`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${t.wireframe&&!t.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }
  }
  `),l&&e.include(qa,t),e.include(Ya,t),a.include(Ja),a.code.add(R`
  void main() {
    discardBySlice(vpos);
    ${l?"terrainDepthTest(depth);":""}
  `),t.wireframe?a.code.add(R`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(c&&a.code.add(R`
        float sdf = min(vSegmentSDF, vReverseSegmentSDF);
        vec2 fragmentPosition = vec2(
          min(sdf, 0.0),
          vLineDistance
        ) * gl_FragCoord.w;

        float fragmentRadius = length(fragmentPosition);
        float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
        float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

        if (capCoverage < ${R.float(qi)}) {
          discard;
        }
      `),d?a.code.add(R`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${R.float(qi)}, stippleCoverage);
      `):a.code.add(R`float stippleAlpha = getStippleAlpha();`),t.output!==P.ObjectAndLayerIdColor&&a.code.add(R`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);`),a.uniforms.add(new Si("intrinsicColor",f=>f.color)),a.code.add(R`vec4 color = intrinsicColor * vColor;`),t.innerColorEnabled&&(a.uniforms.add(new Si("innerColor",f=>f.innerColor??f.color),new be("innerWidth",(f,y)=>f.innerWidth*y.camera.pixelRatio)),a.code.add(R`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),a.code.add(R`vec4 finalColor = blendStipple(color, stippleAlpha);`),t.falloffEnabled&&(a.uniforms.add(new be("falloff",f=>f.falloff)),a.code.add(R`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`)),t.stippleEnabled||a.code.add(R`float featherStartDistance = max(vLineWidth - 2.0, 0.0);
float value = abs(vLineDistance) * gl_FragCoord.w;
float feather = (value - featherStartDistance) / (vLineWidth - featherStartDistance);
finalColor.a *= 1.0 - clamp(feather, 0.0, 1.0);`)),t.transparencyPassType===Le.ColorAlpha&&(e.outputs.add("fragColor","vec4",0),e.outputs.add("fragAlpha","float",1)),a.code.add(R`
    ${t.output===P.ObjectAndLayerIdColor?R`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${R.float(qi)}) {
      discard;
    }

    ${t.output===P.Color?R`fragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===P.Color&&t.transparencyPassType===Le.ColorAlpha?R`
            fragColor = premultiplyAlpha(fragColor);
            fragAlpha = fragColor.a;`:""}
    ${t.output===P.Highlight?R`fragColor = vec4(1.0);`:""}
    ${t.output===P.ObjectAndLayerIdColor?R`outputObjectAndLayerIdColor();`:""}
  }
  `),e}const Nl=Object.freeze(Object.defineProperty({__proto__:null,build:Cn,ribbonlineNumRoundJoinSubdivisions:Zt},Symbol.toStringTag,{value:"Module"})),An=new Map([[_.POSITION,0],[_.PREVPOSITION,1],[_.NEXTPOSITION,2],[_.SUBDIVISIONFACTOR,3],[_.UV0,4],[_.COLOR,5],[_.COLORFEATUREATTRIBUTE,5],[_.SIZE,6],[_.SIZEFEATUREATTRIBUTE,6],[_.OPACITYFEATUREATTRIBUTE,7],[_.OBJECTANDLAYERIDCOLOR,8]]);let En=class Dn extends Fr{initializeProgram(e){return new jr(e.rctx,Dn.shader.get().build(this.configuration),An)}_makePipelineState(e,i){const r=this.configuration,s=e===Le.NONE,n=e===Le.FrontFace,a=To(r.output);return Ke({blending:r.output===P.Color?s?Yi:Xa(e):null,depthTest:{func:Za(e)},depthWrite:s?r.writeDepth||a?Po:null:Qa(e),drawBuffers:r.output===P.Depth?{buffers:[oi.NONE]}:Ka(e),colorWrite:Ct,stencilWrite:r.hasOccludees?gs:null,stencilTest:r.hasOccludees?i?ms:eo:null,polygonOffset:s||n?r.hasPolygonOffset?Ls:null:to})}initializePipeline(){const e=this.configuration;if(e.occluder){const i=e.hasPolygonOffset?Ls:null;this._occluderPipelineTransparent=Ke({blending:Yi,polygonOffset:i,depthTest:_s,depthWrite:null,colorWrite:Ct,stencilWrite:null,stencilTest:io,drawBuffers:e.output===P.Depth?{buffers:[oi.NONE]}:null}),this._occluderPipelineOpaque=Ke({blending:Yi,polygonOffset:i,depthTest:_s,depthWrite:null,colorWrite:Ct,stencilWrite:ro,stencilTest:so,drawBuffers:e.output===P.Depth?{buffers:[oi.NONE]}:null}),this._occluderPipelineMaskWrite=Ke({blending:null,polygonOffset:i,depthTest:no,depthWrite:null,colorWrite:null,stencilWrite:gs,stencilTest:ms,drawBuffers:e.output===P.Depth?{buffers:[oi.NONE]}:null})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?Ts.LINES:Ts.TRIANGLE_STRIP}getPipeline(e,i,r){return e?this._occludeePipelineState:this.configuration.occluder?r?this._occluderPipelineTransparent:i?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}};En.shader=new Ur(Nl,()=>Ir(()=>Promise.resolve().then(()=>dc),void 0));const Ls={factor:0,units:-4};var ge;(function(t){t[t.LEFT_JOIN_START=-2]="LEFT_JOIN_START",t[t.LEFT_JOIN_END=-1]="LEFT_JOIN_END",t[t.LEFT_CAP_START=-4]="LEFT_CAP_START",t[t.LEFT_CAP_END=-5]="LEFT_CAP_END",t[t.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",t[t.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",t[t.RIGHT_CAP_START=4]="RIGHT_CAP_START",t[t.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(ge||(ge={}));let Fl=class extends la{constructor(e){super(e,new Ul),this._configuration=new H,this.produces=new Map([[te.OPAQUE_MATERIAL,i=>i===P.Highlight||i===P.ObjectAndLayerIdColor||i===P.Color&&this.parameters.renderOccluded===Ce.OccludeAndTransparentStencil],[te.OPAQUE_NO_SSAO_DEPTH,i=>bo(i)],[te.OCCLUDER_MATERIAL,i=>ys(i)&&this.parameters.renderOccluded===Ce.OccludeAndTransparentStencil],[te.TRANSPARENT_OCCLUDER_MATERIAL,i=>ys(i)&&this.parameters.renderOccluded===Ce.OccludeAndTransparentStencil],[te.TRANSPARENT_MATERIAL,i=>i===P.Color&&this.parameters.writeDepth&&this.parameters.renderOccluded!==Ce.OccludeAndTransparentStencil],[te.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,i=>i===P.Color&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==Ce.OccludeAndTransparentStencil],[te.DRAPED_MATERIAL,i=>xo(i)]]),this._vertexAttributeLocations=An}getConfiguration(e,i){this._configuration.output=e,this._configuration.draped=i.slot===te.DRAPED_MATERIAL;const r=this.parameters.stipplePattern!=null&&e!==P.Highlight;return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&this.parameters.stippleOffColor!=null,this._configuration.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins=this.parameters.join==="round",this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=this.parameters.markerParameters!=null&&Wl(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&this.parameters.innerColor!=null,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===Ce.OccludeAndTransparentStencil,this._configuration.transparencyPassType=i.transparencyPassType,this._configuration.multipassEnabled=i.multipassEnabled,this._configuration.cullAboveGround=i.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,i,r,s,n,a){if(!r.options.selectionMode)return;const o=e.attributes.get(_.POSITION).data,l=e.attributes.get(_.SIZE);let h=this.parameters.width;if(this.parameters.vvSize){const y=e.attributes.get(_.SIZEFEATUREATTRIBUTE).data[0];h*=zt(this.parameters.vvSize.offset[0]+y*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else l&&(h*=l.data[0]);const c=s[0],d=s[1],g=(h/2+4)*e.screenToWorldRatio;let p=Number.MAX_VALUE,f=0;for(let y=0;y<o.length-5;y+=3){const w=o[y],O=o[y+1],v=c-w,S=d-O,C=o[y+3]-w,T=o[y+4]-O,A=zt((C*v+T*S)/(C*C+T*T),0,1),m=C*A-v,W=T*A-S,V=m*m+W*W;V<p&&(p=V,f=y/3)}p<g*g&&n(a.dist,a.normal,f,!1)}intersect(e,i,r,s,n,a){if(!r.options.selectionMode||!e.visible)return;if(!vo(i))return void ji.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const o=e.attributes,l=o.get(_.POSITION).data;let h=this.parameters.width;if(this.parameters.vvSize){const v=o.get(_.SIZEFEATUREATTRIBUTE).data[0];h*=zt(this.parameters.vvSize.offset[0]+v*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o.has(_.SIZE)&&(h*=o.get(_.SIZE).data[0]);const c=r.camera,d=Hl;Mr(d,r.point);const g=h*c.pixelRatio/2+4*c.pixelRatio;Y(Nt[0],d[0]-g,d[1]+g,0),Y(Nt[1],d[0]+g,d[1]+g,0),Y(Nt[2],d[0]+g,d[1]-g,0),Y(Nt[3],d[0]-g,d[1]-g,0);for(let v=0;v<4;v++)if(!c.unprojectFromRenderScreen(Nt[v],Ve[v]))return;si(c.eye,Ve[0],Ve[1],er),si(c.eye,Ve[1],Ve[2],tr),si(c.eye,Ve[2],Ve[3],ir),si(c.eye,Ve[3],Ve[0],rr);let p=Number.MAX_VALUE,f=0;const y=$n(this.parameters,o)?l.length-2:l.length-5;for(let v=0;v<y;v+=3){ce[0]=l[v]+i[12],ce[1]=l[v+1]+i[13],ce[2]=l[v+2]+i[14];const S=(v+3)%l.length;if(de[0]=l[S]+i[12],de[1]=l[S+1]+i[13],de[2]=l[S+2]+i[14],Ee(er,ce)<0&&Ee(er,de)<0||Ee(tr,ce)<0&&Ee(tr,de)<0||Ee(ir,ce)<0&&Ee(ir,de)<0||Ee(rr,ce)<0&&Ee(rr,de)<0)continue;if(c.projectToRenderScreen(ce,Ye),c.projectToRenderScreen(de,Je),Ye[2]<0&&Je[2]>0){ie(De,ce,de);const T=c.frustum,A=-Ee(T[ai.NEAR],ce)/$t(De,es(T[ai.NEAR]));re(De,De,A),oe(ce,ce,De),c.projectToRenderScreen(ce,Ye)}else if(Ye[2]>0&&Je[2]<0){ie(De,de,ce);const T=c.frustum,A=-Ee(T[ai.NEAR],de)/$t(De,es(T[ai.NEAR]));re(De,De,A),oe(de,de,De),c.projectToRenderScreen(de,Je)}else if(Ye[2]<0&&Je[2]<0)continue;Ye[2]=0,Je[2]=0;const C=ha(zi(Ye,Je,js),d);C<p&&(p=C,X(Ns,ce),X(Fs,de),f=v/3)}const w=r.rayBegin,O=r.rayEnd;if(p<g*g){let v=Number.MAX_VALUE;if(ca(zi(Ns,Fs,js),zi(w,O,zl),qe)){ie(qe,qe,w);const S=kt(qe);re(qe,qe,1/S),v=S/Ni(w,O)}a(v,qe,f,!1)}}get _layout(){const e=Do().vec3f(_.POSITION).vec3f(_.PREVPOSITION).vec3f(_.NEXTPOSITION).f32(_.SUBDIVISIONFACTOR).vec2f(_.UV0);return this.parameters.vvSize?e.f32(_.SIZEFEATUREATTRIBUTE):e.f32(_.SIZE),this.parameters.vvColor?e.f32(_.COLORFEATUREATTRIBUTE):e.vec4f(_.COLOR),this.parameters.vvOpacity&&e.f32(_.OPACITYFEATUREATTRIBUTE),Rt("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(_.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new Vl(this._layout,this.parameters)}createGLMaterial(e){return new jl(e)}validateParameters(e){e.join!=="miter"&&(e.miterLimit=0),e.markerParameters!=null&&(e.markerScale=e.markerParameters.width/e.width)}},jl=class extends ao{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output===P.Color&&this._updateOccludeeState(e);const i=this._material.parameters.stipplePattern;return this._stipplePattern!==i&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(i,this._stipplePattern)}),this._stipplePattern=i),this.ensureTechnique(En,e)}},Ul=class extends oo{constructor(){super(...arguments),this.width=0,this.color=pn,this.join="miter",this.cap=st.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}},Vl=class{constructor(e,i){this.vertexBufferLayout=e,this._parameters=i,this.numJoinSubdivisions=0;const r=i.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=Zt+r}}_isClosed(e){return $n(this._parameters,e.attributes)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const r=e.attributes.get(_.POSITION).indices.length/2+1,s=this._isClosed(e);let n=s?2:2*2;return n+=((s?r:r-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),n+=2,this._parameters.wireframe&&(n=2+4*(n-2)),n}write(e,i,r,s,n){var nt,ti,$;const a=Gl,o=Bl,l=kl,h=r.attributes.get(_.POSITION),c=h.indices,d=h.data.length/3,g=(nt=r.attributes.get(_.DISTANCETOSTART))==null?void 0:nt.data;c&&c.length!==2*(d-1)&&console.warn("RibbonLineMaterial does not support indices");const p=((ti=r.attributes.get(_.SIZEFEATUREATTRIBUTE))==null?void 0:ti.data[0])??(($=r.attributes.get(_.SIZE))==null?void 0:$.data[0])??1;let f=[1,1,1,1],y=0;const w=this.vertexBufferLayout.fields.has(_.COLORFEATUREATTRIBUTE);w?y=r.attributes.get(_.COLORFEATUREATTRIBUTE).data[0]:r.attributes.has(_.COLOR)&&(f=r.attributes.get(_.COLOR).data);const O=Rt("enable-feature:objectAndLayerId-rendering")?r.objectAndLayerIdColor:null,v=this.vertexBufferLayout.fields.has(_.OPACITYFEATUREATTRIBUTE),S=v?r.attributes.get(_.OPACITYFEATUREATTRIBUTE).data[0]:0,C=new Float32Array(s.buffer),T=Rt("enable-feature:objectAndLayerId-rendering")?new Uint8Array(s.buffer):null,A=this.vertexBufferLayout.stride/4;let m=n*A;const W=m;let V=0;const E=g?(k,Z,me)=>V=g[me]:(k,Z,me)=>V+=Ni(k,Z),he=Rt("enable-feature:objectAndLayerId-rendering"),j=(k,Z,me,Ue,at,Gn,Bn)=>{if(C[m++]=Z[0],C[m++]=Z[1],C[m++]=Z[2],C[m++]=k[0],C[m++]=k[1],C[m++]=k[2],C[m++]=me[0],C[m++]=me[1],C[m++]=me[2],C[m++]=Ue,C[m++]=Bn,C[m++]=at,C[m++]=p,w)C[m++]=y;else{const ii=Math.min(4*Gn,f.length-4);C[m++]=f[ii],C[m++]=f[ii+1],C[m++]=f[ii+2],C[m++]=f[ii+3]}v&&(C[m++]=S),he&&(O!=null&&(T[4*m]=O[0],T[4*m+1]=O[1],T[4*m+2]=O[2],T[4*m+3]=O[3]),m++)};m+=A,Y(o,h.data[0],h.data[1],h.data[2]),e&&ye(o,o,e);const Fe=this._isClosed(r);if(Fe){const k=h.data.length-3;Y(a,h.data[k],h.data[k+1],h.data[k+2]),e&&ye(a,a,e)}else Y(l,h.data[3],h.data[4],h.data[5]),e&&ye(l,l,e),j(o,o,l,1,ge.LEFT_CAP_START,0,0),j(o,o,l,1,ge.RIGHT_CAP_START,0,0),X(a,o),X(o,l);const It=Fe?0:1,je=Fe?d:d-1;for(let k=It;k<je;k++){const Z=(k+1)%d*3;Y(l,h.data[Z],h.data[Z+1],h.data[Z+2]),e&&ye(l,l,e),E(a,o,k),j(a,o,l,0,ge.LEFT_JOIN_END,k,V),j(a,o,l,0,ge.RIGHT_JOIN_END,k,V);const me=this.numJoinSubdivisions;for(let Ue=0;Ue<me;++Ue){const at=(Ue+1)/(me+1);j(a,o,l,at,ge.LEFT_JOIN_END,k,V),j(a,o,l,at,ge.RIGHT_JOIN_END,k,V)}j(a,o,l,1,ge.LEFT_JOIN_START,k,V),j(a,o,l,1,ge.RIGHT_JOIN_START,k,V),X(a,o),X(o,l)}Fe?(Y(l,h.data[3],h.data[4],h.data[5]),e&&ye(l,l,e),V=E(a,o,je),j(a,o,l,0,ge.LEFT_JOIN_END,It,V),j(a,o,l,0,ge.RIGHT_JOIN_END,It,V)):(V=E(a,o,je),j(a,o,o,0,ge.LEFT_CAP_END,je,V),j(a,o,o,0,ge.RIGHT_CAP_END,je,V)),Ki(C,W+A,C,W,A),m=Ki(C,m-A,C,m,A),this._parameters.wireframe&&this._addWireframeVertices(s,W,m,A)}_addWireframeVertices(e,i,r,s){const n=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(e.buffer,i*Float32Array.BYTES_PER_ELEMENT,r-i);let o=0;const l=h=>o=Ki(a,h,n,o,s);for(let h=0;h<a.length-1;h+=2*s)l(h),l(h+2*s),l(h+1*s),l(h+2*s),l(h+1*s),l(h+3*s)}};function Ki(t,e,i,r,s){for(let n=0;n<s;n++)i[r++]=t[e++];return r}function $n(t,e){return t.isClosed?e.get(_.POSITION).indices.length>2:!1}function Wl(t){return t.anchor===Xt.Tip&&t.hideOnShortSegments&&t.placement==="begin-end"&&t.worldSpace}const ce=D(),de=D(),De=D(),qe=D(),Hl=D(),Ye=Qe(),Je=Qe(),Ns=D(),Fs=D(),js=un(),zl=un(),Gl=D(),Bl=D(),kl=D(),Nt=[Qe(),Qe(),Qe(),Qe()],Ve=[D(),D(),D(),D()],er=ei(),tr=ei(),ir=ei(),rr=ei();let ql=class{constructor(e){this._originSR=e,this._rootOriginId="root/"+fn(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){const i=this._origins.get(this._rootOriginId);if(i==null){const c=vr(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,c),c}const r=this._gridSize,s=Math.round(e[0]/r),n=Math.round(e[1]/r),a=Math.round(e[2]/r),o=`${s}/${n}/${a}`;let l=this._origins.get(o);const h=.5*r;if(ie(K,e,i.vec3),K[0]=Math.abs(K[0]),K[1]=Math.abs(K[1]),K[2]=Math.abs(K[2]),K[0]<h&&K[1]<h&&K[2]<h){if(l){const c=Math.max(...K);if(ie(K,e,l.vec3),K[0]=Math.abs(K[0]),K[1]=Math.abs(K[1]),K[2]=Math.abs(K[2]),Math.max(...K)<c)return l}return i}return l||(l=vr(s*r,n*r,a*r,o),this._origins.set(o,l)),l}_drawOriginBox(e,i=fr(1,1,0,1)){const r=window.view,s=r._stage,n=i.toString();if(!this._objects.has(n)){this._material=new Fl({width:2,color:i}),s.add(this._material);const p=new ko(s,{pickable:!1}),f=new Ho({castShadow:!1});s.add(f),p.add(f),this._objects.set(n,f)}const a=this._objects.get(n),o=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],l=o.length,h=new Array(3*l),c=new Array,d=.5*this._gridSize;for(let p=0;p<l;p++)h[3*p]=e[0]+(1&o[p]?d:-d),h[3*p+1]=e[1]+(2&o[p]?d:-d),h[3*p+2]=e[2]+(4&o[p]?d:-d),p>0&&c.push(p-1,p);Ei(h,this._originSR,0,h,r.renderSpatialReference,0,l);const g=new we(this._material,[[_.POSITION,new F(h,c,3,!0)]],null,Mt.Line);s.add(g),a.addGeometry(g)}get test(){}};const K=D();var Rr;(function(t){t[t.Occluded=0]="Occluded",t[t.NotOccluded=1]="NotOccluded",t[t.Both=2]="Both",t[t.COUNT=3]="COUNT"})(Rr||(Rr={}));function yd(t){t.include(lo),t.uniforms.add(new Ui("geometryDepthTexture",(e,i)=>{var r;return(r=i.multipassGeometry.depth)==null?void 0:r.attachment})),t.code.add(R`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos);
return (elementDepth < (geometryDepth - 1.0));
}`)}let Yl=class{},Jl=class{constructor(e,i){this.shadowMap=e,this.slicePlane=i,this.slot=te.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=Le.NONE,this.alignPixelEnabled=!1,this.decorations=da.ON,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new Vi,this._inverseViewport=B(),this.oldLighting=new Ji,this.newLighting=new Ji,this._fadedLighting=new Ji,this._lighting=this.newLighting,this.ssr=new Xl,this.multipassEnabled=!1,this.multipassTerrain=new ho,this.multipassGeometry=new Yl,this.hudRenderStyle=Rr.Occluded,this.cloudsFade=new cl,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:i,newLighting:r}=this;e>=1?this._lighting=r:(this._fadedLighting.lerpLighting(i,r,e),this._lighting=this._fadedLighting)}},Xl=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=G()}},Zl=class{constructor(e,i,r=null){this.rctx=e,this.sliceHelper=r,this.lastFrameCamera=new Vi,this.output=P.Color,this.renderOccludedMask=Cr,this.bindParameters=new Jl(i,r!=null?r.plane:null),this.bindParameters.alignPixelEnabled=!0}};const Cr=Ce.Occlude|Ce.OccludeAndTransparent|Ce.OccludeAndTransparentStencil;let Wt=class extends Vi{constructor(){super(...arguments),this._projectionMatrix=G()}get projectionMatrix(){return this._projectionMatrix}};u([x()],Wt.prototype,"_projectionMatrix",void 0),u([x({readOnly:!0})],Wt.prototype,"projectionMatrix",null),Wt=u([Ne("esri.views.3d.webgl-engine.lib.CascadeCamera")],Wt);var Ar;(function(t){t[t.Highlight=0]="Highlight",t[t.ExcludeHighlight=1]="ExcludeHighlight"})(Ar||(Ar={}));let pi=class{constructor(){this.camera=new Wt,this.lightMat=G()}},Ql=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},Kl=class{constructor(e,i){this._fbos=e,this._viewingMode=i,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Ql,this._projectionView=G(),this._projectionViewInverse=G(),this._modelViewLight=G(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=Ge(),this._cascades=[new pi,new pi,new pi,new pi],this._lastOrigin=null,this._maxTextureWidth=Math.min(Rt("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){var e;return(e=this._handle)==null?void 0:e.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return gr(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=Ai(this._handle),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=zt(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)nr[e]=this._cascades[e];return nr.length=this._numCascades,nr}start(e,i,r,s,n){pe(this.enabled);const{near:a,far:o}=nh(r);this._computeCascadeDistances(a,o,s),this._textureHeight=this._computeTextureHeight(e,n,s),this._setupMatrices(e,i);const{viewMatrix:l,projectionMatrix:h}=e;for(let c=0;c<this._numCascades;++c)this._constructCascade(c,h,l,i);this._lastOrigin=null,this.clear()}finish(){var e;pe(this.enabled),(e=this._handle)==null||e.detachDepth()}getShadowMapMatrices(e){if(!this._lastOrigin||!St(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||D(),X(this._lastOrigin,e);for(let i=0;i<this._numCascades;++i){ts(Gs,this._cascades[i].lightMat,e);for(let r=0;r<16;++r)Bs[16*i+r]=Gs[r]}}return Bs}moveSnapshot(e){var i,r;pe(this.enabled),(i=this._handle)==null||i.detachDepth(),(r=this._snapshots[e])==null||r.release(),this._snapshots[e]=this._handle,this._handle=null,this.clear()}copySnapshot(e){var l,h,c,d;const i=(h=(l=this._handle)==null?void 0:l.getTexture())==null?void 0:h.descriptor;if(!this.enabled||!i)return;(c=this._snapshots[e])==null||c.release();const{width:r,height:s}=i,n=e===Ar.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[e]=this._fbos.acquire(r,s,n,Di.RGBA4);const a=this._fbos.rctx;this._bindFbo();const o=a.bindTexture((d=this._snapshots[e])==null?void 0:d.getTexture(),mr.TEXTURE_UNIT_FOR_UPDATES);a.gl.copyTexSubImage2D($o.TEXTURE_2D,0,0,0,0,0,r,s),a.bindTexture(o,mr.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(e){var i;return this.enabled?(i=this._snapshots[e])==null?void 0:i.getTexture():null}clear(){const e=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),e.setClearColor(1,1,1,1),e.clear(Mi.COLOR_BUFFER_BIT|Mi.DEPTH_BUFFER_BIT)}_computeTextureHeight(e,i,r){const s=Math.min(window.devicePixelRatio,i)/e.pixelRatio,n=r?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,a=co(Math.floor(Math.max(e.fullWidth,e.fullHeight)*s*n)),o=Math.min(this._maxTextureWidth,this._numCascades*a);return uo(o/this._numCascades)}_ensureFbo(){var e,i,r,s,n;((i=(e=this._handle)==null?void 0:e.fbo)==null?void 0:i.width)===this._textureWidth&&((r=this._handle)==null?void 0:r.fbo.height)===this._textureHeight||((s=this._handle)==null||s.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",Di.RGBA4)),(n=this._handle)==null||n.acquireDepth(po.DEPTH16_BUFFER)}_discardSnapshot(e){this._snapshots[e]=Ai(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){var i;const e=this._fbos.rctx;e.unbindTexture(this.depthTexture),e.bindFramebuffer((i=this._handle)==null?void 0:i.fbo)}_constructCascade(e,i,r,s){const n=this._cascades[e],a=-this._cascadeDistances[e],o=-this._cascadeDistances[e+1],l=(i[10]*a+i[14])/Math.abs(i[11]*a+i[15]),h=(i[10]*o+i[14])/Math.abs(i[11]*o+i[15]);pe(l<h);for(let p=0;p<8;++p){gr(Us,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?l:h,1);const f=Te[p];jt(f,Us,this._projectionViewInverse),f[0]/=f[3],f[1]/=f[3],f[2]/=f[3]}ua(sr,Te[0]),n.camera.viewMatrix=ts(eh,this._modelViewLight,sr);for(let p=0;p<8;++p)ye(Te[p],Te[p],n.camera.viewMatrix);let c=Te[0][2],d=Te[0][2];for(let p=1;p<8;++p)c=Math.min(c,Te[p][2]),d=Math.max(d,Te[p][2]);c-=200,d+=200,n.camera.near=-d,n.camera.far=-c,sh(r,s,c,d,n.camera),Be(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const g=this._textureHeight;n.camera.viewport=[e*g,0,g,g]}_setupMatrices(e,i){Be(this._projectionView,e.projectionMatrix,e.viewMatrix),Ht(this._projectionViewInverse,this._projectionView);const r=this._viewingMode===Fi.Global?e.eye:Y(sr,0,0,1);cn(this._modelViewLight,[0,0,0],[-i[0],-i[1],-i[2]],r)}_computeCascadeDistances(e,i,r){const s=r?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(yo(i/e,4)),s);const n=(i-e)/this._numCascades,a=(i/e)**(1/this._numCascades);let o=e,l=e;for(let h=0;h<this._numCascades+1;++h)this._cascadeDistances[h]=Ut(o,l,this.settings.splitSchemeLambda),o*=a,l+=n}get test(){}};const eh=G(),Us=Ge(),Te=[];for(let t=0;t<8;++t)Te.push(Ge());const Vs=B(),Ws=B(),th=B(),Hs=B(),zs=B(),sr=D(),nr=[],Gs=G(),Bs=He.concat(He,He,He,He),ve=B(),ut=B(),Xe=[B(),B(),B(),B()],q=B(),ar=B(),We=B(),Ft=B(),pt=B(),ft=B(),fi=B();function ih(t,e,i,r,s,n,a,o){Yt(ve,0,0);for(let T=0;T<4;++T)ke(ve,ve,t[T]);yt(ve,ve,.25),Yt(ut,0,0);for(let T=4;T<8;++T)ke(ut,ut,t[T]);yt(ut,ut,.25),Pt(Xe[0],t[4],t[5],.5),Pt(Xe[1],t[5],t[6],.5),Pt(Xe[2],t[6],t[7],.5),Pt(Xe[3],t[7],t[4],.5);let l=0,h=is(Xe[0],ve);for(let T=1;T<4;++T){const A=is(Xe[T],ve);A<h&&(h=A,l=T)}wt(q,Xe[l],t[l+4]);const c=q[0];let d,g;q[0]=-q[1],q[1]=c,wt(ar,ut,ve),ae(ar,q)<0&&fa(q,q),Pt(q,q,ar,i),rs(q,q),d=g=ae(wt(We,t[0],ve),q);for(let T=1;T<8;++T){const A=ae(wt(We,t[T],ve),q);A<d?d=A:A>g&&(g=A)}Mr(r,ve),yt(We,q,d-e),ke(r,r,We);let p=-1,f=1,y=0,w=0;for(let T=0;T<8;++T){wt(Ft,t[T],r),rs(Ft,Ft);const A=q[0]*Ft[1]-q[1]*Ft[0];A>0?A>p&&(p=A,y=T):A<f&&(f=A,w=T)}ot(p>0,"leftArea"),ot(f<0,"rightArea"),yt(pt,q,d),ke(pt,pt,ve),yt(ft,q,g),ke(ft,ft,ve),fi[0]=-q[1],fi[1]=q[0];const O=ni(r,t[w],ft,ke(We,ft,fi),1,s),v=ni(r,t[y],ft,We,1,n),S=ni(r,t[y],pt,ke(We,pt,fi),1,a),C=ni(r,t[w],pt,We,1,o);ot(O,"rayRay"),ot(v,"rayRay"),ot(S,"rayRay"),ot(C,"rayRay")}function N(t,e){return 3*e+t}const ks=B();function fe(t,e){return Yt(ks,t[e],t[e+3]),ks}const ue=B(),b=ga();function rh(t,e,i,r,s){wt(ue,i,r),yt(ue,ue,.5),b[0]=ue[0],b[1]=ue[1],b[2]=0,b[3]=ue[1],b[4]=-ue[0],b[5]=0,b[6]=ue[0]*ue[0]+ue[1]*ue[1],b[7]=ue[0]*ue[1]-ue[1]*ue[0],b[8]=1,b[N(0,2)]=-ae(fe(b,0),t),b[N(1,2)]=-ae(fe(b,1),t);let n=ae(fe(b,0),i)+b[N(0,2)],a=ae(fe(b,1),i)+b[N(1,2)],o=ae(fe(b,0),r)+b[N(0,2)],l=ae(fe(b,1),r)+b[N(1,2)];n=-(n+o)/(a+l),b[N(0,0)]+=b[N(1,0)]*n,b[N(0,1)]+=b[N(1,1)]*n,b[N(0,2)]+=b[N(1,2)]*n,n=1/(ae(fe(b,0),i)+b[N(0,2)]),a=1/(ae(fe(b,1),i)+b[N(1,2)]),b[N(0,0)]*=n,b[N(0,1)]*=n,b[N(0,2)]*=n,b[N(1,0)]*=a,b[N(1,1)]*=a,b[N(1,2)]*=a,b[N(2,0)]=b[N(1,0)],b[N(2,1)]=b[N(1,1)],b[N(2,2)]=b[N(1,2)],b[N(1,2)]+=1,n=ae(fe(b,1),e)+b[N(1,2)],a=ae(fe(b,2),e)+b[N(2,2)],o=ae(fe(b,1),i)+b[N(1,2)],l=ae(fe(b,2),i)+b[N(2,2)],n=-.5*(n/a+o/l),b[N(1,0)]+=b[N(2,0)]*n,b[N(1,1)]+=b[N(2,1)]*n,b[N(1,2)]+=b[N(2,2)]*n,n=ae(fe(b,1),e)+b[N(1,2)],a=ae(fe(b,2),e)+b[N(2,2)],o=-a/n,b[N(1,0)]*=o,b[N(1,1)]*=o,b[N(1,2)]*=o,s[0]=b[0],s[1]=b[1],s[2]=0,s[3]=b[2],s[4]=b[3],s[5]=b[4],s[6]=0,s[7]=b[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=b[6],s[13]=b[7],s[14]=0,s[15]=b[8]}function sh(t,e,i,r,s){const n=1/Te[0][3],a=1/Te[4][3];pe(n<a);let o=n+Math.sqrt(n*a);const l=Math.sin(pa(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));o/=l,ih(Te,o,l,Vs,Ws,th,Hs,zs),rh(Vs,Ws,Hs,zs,s.projectionMatrix),s.projectionMatrix[10]=2/(i-r),s.projectionMatrix[14]=-(i+r)/(i-r)}function nh(t){let{near:e,far:i}=t;return e<2&&(e=2),i<2&&(i=2),e>=i&&(e=2,i=4),{near:e,far:i}}let ah=class{constructor(e,i){this._material=e,this._repository=i,this._map=new Map}dispose(){this._map.forEach((e,i)=>{e!=null&&this._repository.release(this._material,i)})}load(e,i,r){const s=this._material.produces.get(i);if(!(s!=null&&s(r)))return null;this._map.has(r)||this._map.set(r,this._repository.acquire(this._material,i,r));const n=this._map.get(r);if(n!=null){if(n.ensureResources(e)===ma.LOADED)return n;this._repository.requestRender()}return null}},oh=class extends fo{constructor(e=D()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}},Gr=class{constructor(e=0,i=0){this.from=e,this.to=i}get numElements(){return this.to-this.from}};function qs(t){const e=new Map;t.forAll(r=>e.set(r.from,r));let i=!0;for(;i;){i=!1;for(let r=0;r<t.length;++r){const s=t.data[r],n=e.get(s.to);if(!n)return;s.to=n.to,e.delete(n.from),t.removeUnordered(n),i=!0}}}let Ys=class extends Gr{constructor(e,i,r){super(i,r),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.geometry.highlights!=null&&this.isVisible}get hasOccludees(){return this.geometry.occludees!=null}},lh=class{constructor(){this.first=0,this.count=0}},hh=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new Ie({allocator:e=>e||new Gr,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=gi(),this.drawCommandsHighlight=gi(),this.drawCommandsOccludees=gi(),this.drawCommandsShadowHighlightRest=gi()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,i){this.deleteInstance(e),this._instances.set(e,i),this._numElements+=i.numElements}deleteInstance(e){const i=this._instances.get(e);i&&(this._numElements-=i.numElements,this._instances.delete(e))}updateInstance(e,i,r){const s=this._instances.get(e);s&&(this._numElements-=s.numElements,s.from=i,s.to=r,this._numElements+=s.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;if(!this.needsMultipleCommands()){const r=this.drawCommandsDefault.pushNew(),s=this.holes.front();return this.vao!=null&&this.holes.length===1&&s.to===Math.floor(this.vao.byteSize/e)?(r.first=0,void(r.count=s.from)):(r.first=1/0,r.count=0,this._instances.forEach(n=>{r.first=Math.min(r.first,n.from),r.count=Math.max(r.count,n.to)}),void(r.count-=r.first))}const i=Array.from(this._instances.values()).sort((r,s)=>r.from===s.from?r.to-s.to:r.from-s.from);for(const r of i)r.isVisible&&(Js(r.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,r),Js(r.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,r))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function ch(t){return t.vao!=null}function gi(){return new Ie({allocator:t=>t||new lh,deallocator:t=>t})}function Js(t,e){const i=t.back();if(i==null){const r=t.pushNew();return r.first=e.from,void(r.count=e.numElements)}if(dh(i,e)){const r=e.from-i.first+e.numElements;i.count=r}else{const r=t.pushNew();r.first=e.from,r.count=e.numElements}}function dh(t,e){return t.first+t.count>=e.from}let uh=class{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(i=>i.instances.has(e))}},ph=class{constructor(e,i){this._cache=e(i,(r,s,n)=>{switch(s){case ss.ALL:return r.forEach(a=>a.dispose()),0;case ss.SOME:{const a=r.shift();return a&&(n-=Math.round(a.usedMemory),a.dispose()),n}}})}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(e){return this._cache.getSize(e)}pop(e){const i=this._cache.peek(e);if(!i)return;const r=i.pop();if(i.length>0){if(r){const s=this._cache.getSize(e)-Math.round(r.usedMemory);this._cache.updateSize(e,i,s)}}else this._cache.pop(e);return r}put(e,i,r=_a){const s=this._cache.peek(e);if(!s)return void this._cache.put(e,[i],i.usedMemory,r);s.push(i);const n=this._cache.getSize(e)+Math.round(i.usedMemory);this._cache.updateSize(e,s,n)}},fh=class{constructor(e,i,r){this._rctx=e,this._locations=i,this._layout=r,this._cache=new ph(e.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(e){const i=e.toString();let r=this._cache.pop(i);return r||(r=new Xo(this._rctx,this._locations,{geometry:this._layout},{geometry:Vo.createVertex(this._rctx,Mo.STATIC_DRAW)}),r.vertexBuffers.geometry.setSize(e),r)}deleteVao(e){if(e==null)return;const i=e.byteSize.toString();this._cache.put(i,e)}},Ti=class extends Jo{constructor(t){super(t),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._produces=new Map,this.drapedPriority=0}destroy(){this._glMaterials=qt(this._glMaterials),this._dataByOrigin.forEach(t=>t.dispose()),this._dataByOrigin.clear(),this._vaoCache=qt(this._vaoCache)}initialize(){this.material.produces.forEach((t,e)=>{this._produces.set(e,i=>!(this._dataByOrigin.size===0||!(i!==P.Highlight&&i!==P.ShadowHighlight||this._hasHighlights))&&t(i))})}get produces(){return this._produces}initializeRenderContext(t,e){const{rctx:i}=t.renderContext;this._glMaterials=new ah(this.material,e??t.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new fh(i,this.material.vertexAttributeLocations,jo(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get hasOccludees(){return this._hasOccludees}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(t){return this.material.queryRenderOccludedState(t)}get materialReference(){return this.material}get numGeometries(){let t=0;return this._dataByOrigin.forEach(e=>t+=e.buffers.reduce((i,r)=>i+r.instances.size,0)),t}get usedMemory(){let t=0;return this._dataByOrigin.forEach(e=>t+=e.buffers.reduce((i,r)=>i+r.vao.usedMemory,0)),t}forEachGeometry(t){this._dataByOrigin.forEach(e=>e.buffers.forEach(i=>i.instances.forEach(r=>t(r.geometry))))}modify(t){this._updateGeometries(t.updates),this._addAndRemoveGeometries(t.adds,t.removes),this._updateDrawCommands()}_updateGeometries(t){const e=this._bufferWriter;if(e===null)return;const i=e.vertexBufferLayout.stride/4;for(const r of t){const s=r.renderGeometry,n=this._dataByOrigin.get(s.localOrigin.id),a=n==null?void 0:n.findBuffer(s.id);if(a==null)return;const o=a.instances.get(s.id);if(r.updateType&(Me.GEOMETRY|Me.TRANSFORMATION)){const l=vi(e.elementCount(o.geometry.geometry)*i),h=e.vertexBufferLayout.createView(l.buffer);this._writeGeometry(s,h,0),a.vao.vertexBuffers.geometry.setSubData(l,o.from*i,0,o.numElements*i)}r.updateType&(Me.HIGHLIGHT|Me.OCCLUDEE|Me.VISIBILITY)&&(a.drawCommandsDirty=!0)}}_computeDeltas(t,e){const i=new Wr;for(const r of t){const s=r.localOrigin;if(s==null)continue;let n=i.get(s.id,null);n==null&&(n=new Xs(s.vec3),i.set(s.id,null,n)),n.changes.push(r)}for(const r of e){const s=r.localOrigin;if(s==null)continue;const n=this._dataByOrigin.get(s.id),a=n==null?void 0:n.findBuffer(r.id);if(a==null)continue;let o=i.get(s.id,a);o==null&&(o=new Xs(s.vec3),i.set(s.id,a,o)),o.changes.push(r)}return i}_addAndRemoveGeometries(t,e){if(this._bufferWriter===null||this._vaoCache===null)return;const{_bufferWriter:i,_dataByOrigin:r}=this,s=i.vertexBufferLayout.stride/4,n=this._computeDeltas(t,e);n.forEach((a,o)=>{const l=a.get(null),h=l!=null?l.changes:[];n.delete(o,null);let c=r.get(o);if(a.forEach((d,g)=>{if(n.delete(o,g),g==null)return void pe(!1,"No VAO for removed geometries");if(g.instances.size===d.changes.length)return this._vaoCache.deleteVao(g.vao),ns(c.buffers,g),void(c.buffers.length===0&&h.length===0&&r.delete(o));const p=g.numElements,f=g.vao.byteSize/4,y=h.reduce((S,C)=>S+i.elementCount(C.geometry),0),w=d.changes.reduce((S,C)=>S+i.elementCount(C.geometry),0),O=Math.min((p+y-w)*s,_i),v=O>f;O>Li&&O<f/2?(d.changes.forEach(({id:S})=>g.deleteInstance(S)),g.instances.forEach(({geometry:S})=>h.push(S)),this._vaoCache.deleteVao(g.vao),ns(c.buffers,g)):v?this._applyAndRebuild(g,h,d):this._applyRemoves(g,d)}),h.length>0)for(c==null&&(c=new uh(l.origin),r.set(o,c)),c.buffers.forEach(d=>this._applyAdds(d,h));h.length>0;)c.buffers.push(this._applyAndRebuild(new hh,h,null))})}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(t=>{t.buffers.forEach(e=>{e.drawCommandsDirty&&(e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,ze(e.instances,i=>(e.updateDrawState(i),e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)),e.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||e.hasHighlights,this._hasOccludees=this._hasOccludees||e.hasOccludees})})}_applyAndRebuild(t,e,i){if(i!=null)for(const p of i.changes)t.deleteInstance(p.id);const r=this._bufferWriter,s=r.vertexBufferLayout.stride,n=s/4,a=Math.floor(_i/n);let o=t.numElements;for(;e.length>0;){const p=e.pop(),f=r.elementCount(p.geometry);if(o+f>a&&o>0){e.push(p);break}o+=f;const y=new Ys(p,0,0);pe(t.instances.get(p.id)==null),t.addInstance(p.id,y)}const l=o*n,h=vi(l),c=r.vertexBufferLayout.createView(h.buffer);let d=0;t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,t.instances.forEach((p,f)=>{this._writeGeometry(p.geometry,c,d);const y=d;d+=r.elementCount(p.geometry.geometry),t.updateInstance(f,y,d),t.updateDrawState(p)}),this._vaoCache.deleteVao(t.vao),t.vao=this._vaoCache.newVao(Ks(l)),t.vao.vertexBuffers.geometry.setSubData(h,0,0,d*n),t.holes.clear();const g=t.holes.pushNew();return g.from=d,g.to=Math.floor(t.vao.byteSize/s),t.updateDrawCommands(s),t}_applyRemoves(t,e){if(e.changes.length===0||this._bufferWriter===null)return;for(const a of e.changes){const o=a.id,l=t.instances.get(o);if(!l)continue;t.deleteInstance(o);const h=$e.back();if(h){if(h.to===l.from){h.to=l.to;continue}if(h.from===l.to){h.from=l.from;continue}}const c=$e.pushNew();c.from=l.from,c.to=l.to}qs($e);const i=this._bufferWriter.vertexBufferLayout.stride/4,r=$e.reduce((a,o)=>Math.max(a,o.numElements),0)*i,s=vi(r);s.fill(0,0,r);const n=t.vao.vertexBuffers.geometry;$e.forAll(a=>n.setSubData(s,a.from*i,0,a.numElements*i)),t.holes.pushArray($e.data,$e.length),$e.forAll((a,o)=>$e.data[o]=null),$e.clear(),t.drawCommandsDirty=!0}_applyAdds(t,e){if(e.length===0||this._bufferWriter===null)return;if(!ch(t))return void this._applyAndRebuild(t,e,null);const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,s=t.numElements,n=e.reduce((w,O)=>w+i.elementCount(O.geometry),0),a=Math.min((s+n)*r,_i),o=4*a;if(t.vao.byteSize<Ks(_i-Li)&&o>t.vao.byteSize)return void this._applyAndRebuild(t,e,null);qs(t.holes);const l=new Array;for(const w of e){const O=i.elementCount(w.geometry),v=gh(t.holes,O);l.push(v)}const h=t.vao.vertexBuffers.geometry;let c=0,d=0,g=0;const p=vi(a),f=i.vertexBufferLayout.createView(p.buffer);e.forEach((w,O)=>{const v=l[O];if(v==null)return;if(g!==v){const T=g-d;T>0&&h.setSubData(p,d*r,0,T*r),d=v,c=0}const S=i.elementCount(w.geometry);this._writeGeometry(w,f,c),c+=S,g=v+S;const C=new Ys(w,v,v+S);pe(t.instances.get(w.id)==null),t.addInstance(w.id,C),t.drawCommandsDirty=!0});const y=g-d;y>0&&h.setSubData(p,d*r,0,y*r),va(e,(w,O)=>l[O]==null)}_writeGeometry(t,e,i){if(this._bufferWriter===null)return;const r=t.localOrigin.vec3;wo(Zs,-r[0],-r[1],-r[2]);const s=Be(mh,Zs,t.transformation);Ht(mi,s),hn(mi,mi),this._bufferWriter.write(s,mi,t.geometry,e,i)}updateAnimation(t){return this.material.update(t)}prepareTechnique(t){if(!this.material.shouldRender(t))return null;const{output:e,bindParameters:i}=t,r=this.material.produces.get(i.slot);if(!(r!=null&&r(e)))return null;const s=e===P.Highlight||e===P.ShadowHighlight;if(s&&!this._hasHighlights)return null;const n=e===P.ShadowExcludeHighlight,a=!(s||n);for(const o of this._dataByOrigin.values())for(const l of o.buffers){if(s&&!l.hasHighlights)continue;const h=(s?l.drawCommandsHighlight:n&&l.needsMultipleCommands()?l.drawCommandsShadowHighlightRest:l.drawCommandsDefault)||null,c=a&&l.drawCommandsOccludees||null;if(h!=null&&h.length||c!=null&&c.length){const d=this._glMaterials.load(t.rctx,i.slot,e),g=d!=null?d.beginSlot(i):null;if(g!=null)return g}}return null}renderNode(t,e){const{output:i,bindParameters:r}=t,s=i===P.Highlight||i===P.ShadowHighlight,n=i===P.ShadowExcludeHighlight,a=!(s||n),o=r.slot===te.OCCLUDER_MATERIAL,l=r.slot===te.TRANSPARENT_OCCLUDER_MATERIAL,h=t.rctx;h.runAppleAmdDriverHelper(),h.bindTechnique(e,r,this.material.parameters);for(const c of this._dataByOrigin.values())for(const d of c.buffers){if(s&&!d.hasHighlights)continue;const g=(s?d.drawCommandsHighlight:n&&d.needsMultipleCommands()?d.drawCommandsShadowHighlightRest:d.drawCommandsDefault)||null,p=a&&d.drawCommandsOccludees||null;(g!=null&&g.length||p!=null&&p.length)&&(e.program.bindDraw(new oh(c.origin),r,this.material.parameters),e.ensureAttributeLocations(d.vao),h.bindVAO(d.vao),g!=null&&g.length&&(h.setPipelineState(e.getPipeline(!1,o,l)),g.forAll(f=>h.drawArrays(e.primitiveType,f.first,f.count))),p!=null&&p.length&&(h.setPipelineState(e.getPipeline(!0,o,l)),p.forAll(f=>h.drawArrays(e.primitiveType,f.first,f.count))))}}get test(){}};u([x({constructOnly:!0})],Ti.prototype,"material",void 0),Ti=u([Ne("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],Ti);let Xs=class{constructor(e){this.origin=e,this.changes=new Array}};function gh(t,e){let i;if(!t.some(s=>!(s.numElements<e)&&(i=s,!0)))return null;const r=i.from;return i.from+=e,i.from>=i.to&&t.removeUnordered(i),r}const Zs=G(),mh=G(),mi=G(),$e=new Ie({allocator:t=>t||new Gr,deallocator:null}),Li=65536,or=4*Li,Qs=1024,Mn=16777216,_i=Mn/4;let lr=new Float32Array(Li);function vi(t){return lr.length<t&&(lr=new Float32Array(t)),lr}function Ks(t){const e=4*t;return e<=Qs?Qs:e<or?ya(e):Math.max(Math.min(Math.ceil(1.5*e/or)*or,Mn),e)}let Se=class extends $r{constructor(e){super(e),this._pending=new _h,this._changes=new nl,this._materialRenderers=new Map,this._sortedMaterialRenderers=new Ie,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach(e=>e.destroy()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materials(){return this.rendererContext.materials}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){return ze(this._materialRenderers,e=>e.numGeometries!==0&&!e.queryRenderOccludedState(Ce.Occlude))}get isEmpty(){return!this.updating&&this._materialRenderers.size===0&&this._geometries.size===0}getMaterialRenderer(e){return this._materialRenderers.get(e)}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=ll(this._changes);let i=!1;return e.forEach((r,s)=>{let n=this.getMaterialRenderer(s);if(!n&&r.adds.length>0){const a=new Ti({material:s});a.initializeRenderContext(this.rendererContext.pluginContext,this._materials),n=a,this._materialRenderers.set(s,n),i=!0}n&&(n.modify(r),n.numGeometries===0&&(this._materialRenderers.delete(s),n.destroy(),i=!0))}),this._changes.clear(),i&&this._updateSortedMaterialRenderers(),this._hasHighlights=ze(this._materialRenderers,r=>{const s=r.produces.get(te.DRAPED_MATERIAL);return!!s&&s(P.Highlight)}),this._hasWater=ze(this._materialRenderers,r=>{const s=r.produces.get(te.DRAPED_WATER);return!!s&&s(P.Normal)}),this.notifyChange("updating"),!0}addGeometries(e,i){if(e.length===0)return;const r=this._validateRenderGeometries(e);for(const n of r)this._geometries.set(n.id,n);const s=this._pending.empty;for(const n of r)this._pending.adds.add(n);s&&this.notifyChange("updating"),i===Pi.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,i){const r=this._pending.empty,s=this._pending.adds;for(const n of e)s.has(n)?(this._pending.removed.add(n),s.delete(n)):this._pending.removed.has(n)||this._pending.removes.add(n),this._geometries.delete(n.id);r&&!this._pending.empty&&this.notifyChange("updating"),i===Pi.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,i){const r=this._changes.updates.length===0;for(const s of e){const n=this._changes.updates.pushNew();n.renderGeometry=this._validateRenderGeometry(s),n.updateType=i}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),i){case Me.TRANSFORMATION:case Me.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case Me.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let i=!1;return this._sortedMaterialRenderers.forAll(r=>i=!!r.updateAnimation&&r.updateAnimation(e)||i),i}shouldRender(e){return this._sortedMaterialRenderers.some(i=>i.prepareTechnique(e))}render(e){this._sortedMaterialRenderers.forAll(i=>{const r=i.prepareTechnique(e);r!=null&&i.renderNode(e,r)})}intersect(e,i,r,s,n){return this._geometries.forEach(a=>{if(s&&!s(a))return;this._intersectRenderGeometry(a,r,i,0,e,n);const o=this.rendererContext.longitudeCyclical;o&&(a.boundingSphere[0]-a.boundingSphere[3]<o.min&&this._intersectRenderGeometry(a,r,i,o.range,e,n),a.boundingSphere[0]+a.boundingSphere[3]>o.max&&this._intersectRenderGeometry(a,r,i,-o.range,e,n)),n++}),n}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;for(const i of this._materialRenderers.values())i.drapedPriority=e++,this._sortedMaterialRenderers.push(i);this._sortedMaterialRenderers.sort((i,r)=>{var s,n,a,o;return((s=r.materialReference)==null?void 0:s.renderPriority)===((n=i.materialReference)==null?void 0:n.renderPriority)?i.drapedPriority-r.drapedPriority:(((a=r.materialReference)==null?void 0:a.renderPriority)||0)-(((o=i.materialReference)==null?void 0:o.renderPriority)||0)})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const i=this._changes.updates.data[e];this._pending.has(i.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,i,r,s,n,a){if(!e.visible)return;let o=0;s+=e.transformation[12],o=e.transformation[13],hr[0]=r[0]-s,hr[1]=r[1]-o,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,n,hr,(l,h,c)=>{vh(i,c,a,e.material.renderPriority,n,e.layerUid,e.graphicUid)},i)}_notifyGraphicGeometryChanged(e){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let i;for(const r of e){const s=r.graphicUid;s!=null&&s!==i&&(this.drapeSource.notifyGraphicGeometryChanged(s),i=s)}}_notifyGraphicVisibilityChanged(e){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let i;for(const r of e){const s=r.graphicUid;s!=null&&s!==i&&(this.drapeSource.notifyGraphicVisibilityChanged(s),i=s)}}_validateRenderGeometries(e){for(const i of e)this._validateRenderGeometry(i);return e}_validateRenderGeometry(e){return e.localOrigin==null&&(e.localOrigin=this._localOriginFactory.getOrigin(Ci(e.boundingSphere))),e}get test(){}};u([x()],Se.prototype,"drapeSource",void 0),u([x()],Se.prototype,"updating",null),u([x()],Se.prototype,"rctx",null),u([x({constructOnly:!0})],Se.prototype,"rendererContext",void 0),u([x()],Se.prototype,"_materials",null),u([x()],Se.prototype,"_localOriginFactory",null),u([x({readOnly:!0})],Se.prototype,"isEmpty",null),u([x()],Se.prototype,"_materialRenderers",void 0),u([x()],Se.prototype,"_geometries",void 0),Se=u([Ne("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Se);let _h=class{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}};function vh(t,e,i,r,s,n,a){const o=new wa(n,a,e),l=h=>{h.set(Ta.OVERLAY,o,t.dist,t.normal,t.transformation,i,r)};if((s.results.min.drapedLayerOrder==null||i>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==as.MIN&&(s.results.max.drapedLayerOrder==null||i<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===as.ALL){const h=Sa(s.ray);l(h),s.results.all.push(h)}}const hr=B();let In=class Pn extends Fr{initializeProgram(e){return new jr(e.rctx,Pn.shader.get().build(),gn)}initializePipeline(){return this.configuration.hasAlpha?Ke({blending:Lo(Tt.SRC_ALPHA,Tt.ONE,Tt.ONE_MINUS_SRC_ALPHA,Tt.ONE_MINUS_SRC_ALPHA),colorWrite:Ct}):Ke({colorWrite:Ct})}};In.shader=new Ur(ml,()=>Ir(()=>Promise.resolve().then(()=>uc),void 0));class Ln extends _n{constructor(){super(...arguments),this.hasAlpha=!1}}u([I()],Ln.prototype,"hasAlpha",void 0);let Br=class extends dn{constructor(){super(...arguments),this.overlayIndex=et.INNER,this.opacity=1}};function Nn(){const t=new Lr;return t.include(mn),t.fragment.uniforms.add(new Ui("tex",e=>e.texture)),t.fragment.uniforms.add(new go("overlayIdx",e=>e.overlayIndex)),t.fragment.uniforms.add(new be("opacity",e=>e.opacity)),t.fragment.code.add(R`void main() {
vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;
}`),t}const yh=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Br,build:Nn},Symbol.toStringTag,{value:"Module"}));let Fn=class jn extends Fr{initializeProgram(e){return new jr(e.rctx,jn.shader.get().build(),gn)}initializePipeline(){return Ke({blending:No(Tt.ONE,Tt.ONE_MINUS_SRC_ALPHA),colorWrite:Ct})}};Fn.shader=new Ur(yh,()=>Ir(()=>Promise.resolve().then(()=>pc),void 0));let Re=class extends Yo{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Br,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new Ie,this._passParameters=new zr,this._materials=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new Vi,this.worldToPCSRatio=1,this.events=new on,this.longitudeCyclical=null,this.produces=new Map([[te.DRAPED_MATERIAL,i=>i!==P.Highlight||this.hasHighlights],[te.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this.view._stage.renderer.fboCache,i=this.view._stage.renderView,{waterTextures:r,stippleTextures:s,markerTextures:n}=i;this._techniques=new _l({rctx:this._rctx,viewingMode:Fi.Local,stippleTextures:s,markerTextures:n,waterTextures:r}),this._renderContext=new Zl(this._rctx,new Kl(e,this.view.state.viewingMode),null),this.addHandles([Gi(()=>r.updating,()=>this.events.emit("content-changed"),os),Gi(()=>this.spatialReference,a=>this._localOriginFactory=new ql(a),os),ba(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0)]),this._materials=new wl(i.textures,this._techniques,()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed")),this._bindParameters.slot=te.DRAPED_MATERIAL,this._bindParameters.mainDepth=null,this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=Le.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new mo(it(1,1,1))]),this.addHandles(this.view.resourceController.scheduler.registerTask(xa.STAGE,this))}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._debugTextureTechnique=Ai(this._debugTextureTechnique),this._passParameters.texture=qt(this._passParameters.texture),this._techniques=ln(this._techniques),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materials(){return this._materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}initializeRenderContext(e){this.pluginContext=e}uninitializeRenderContext(){}renderNode(){}get updating(){return this._sortedDrapeSourceRenderersDirty||ze(this._renderers,e=>e.updating)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(e){for(const i of this._renderers.values()){const r=i.getMaterialRenderer(e);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e)}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,Se)}createDrapeSourceRenderer(e,i,r){const s=this._renderers.get(e);s!=null&&s.destroy();const n=new i({...r,rendererContext:this,drapeSource:e});return this._renderers.set(e,n),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(Gi(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e),n}removeDrapeSourceRenderer(e){if(e==null)return;const i=this._renderers.get(e);i!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),i.destroy())}computeValidity(){var e;return((e=this._renderTargets)==null?void 0:e.computeValidity())??0}releaseRenderTargets(){var e;(e=this._renderTargets)==null||e.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&Bi(e,i=>i.drapeTargetType===_r.WithoutRasterImage)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=Bi(e,i=>i.drapeSourceType===Gt.Features),this._hasDrapedRasterSource=Bi(e,i=>i.drapeSourceType===Gt.RasterImage)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,i,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new el(this.view._stage.renderer.fboCache),this._overlays=[new As,new As]),this.ensureDrapeTargets(e),this.ensureDrapeSources(i),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=qt(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){var i,r;if(e!=null)return e===le.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?(i=this._renderTargets)==null?void 0:i.getTexture(le.Color):(r=this._renderTargets)==null?void 0:r.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_processDrapeSources(e,i){let r=!1;for(const[s,n]of this._renderers){if(e.done)break;(s.destroyed||i(s))&&n.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=ze(this._renderers,s=>s.hasHighlights),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Oa,e=>e.updatePolicy===Jt.SYNC)}get isEmpty(){return!ki.OVERLAY_DRAW_DEBUG_TEXTURE&&!ze(this._renderers,e=>!e.isEmpty)}get hasWater(){return this._hasWater}get rendersOccludedDraped(){const e=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=en;const i=this._sortedRenderers.some(({renderer:r})=>r.shouldRender(this._renderContext));return this._renderContext.renderOccludedMask=e,i}renders(e){return ki.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==le.Occluded||this._sortedRenderers.some(({renderer:i})=>i.shouldRender(this._renderContext))}get mode(){var e,i;return this.isEmpty?xt.Disabled:(e=this._renderTargets)!=null&&e.getTexture(le.WaterNormal)?xt.EnabledWithWater:(i=this._renderTargets)!=null&&i.getTexture(le.Color)?xt.Enabled:xt.Disabled}updateAnimation(e){let i=!1;return this._renderers.forEach(r=>i=r.updateAnimation(e)||i),i}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const i of this._overlays)this.longitudeCyclical?i.setupGeometryViewsCyclical(this.longitudeCyclical):i.setupGeometryViewsDirect();for(const i of this._renderTargets.targets){if(i.content===le.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=this._drawTarget(et.INNER,i,e),s=this._drawTarget(et.OUTER,i,e);(r||s)&&i.fbo.generateMipMap()}}}_drawTarget(e,i,r){const s=this._overlays[e],n=s.canvasGeometries;if(n.numViews===0)return!1;const{alignPixelEnabled:a,contentPixelRatio:o}=r;this._screenToWorldRatio=o*s.mapUnitsPerPixel/this._bindParameters.overlayStretch;const l=i.output;if(this.isEmpty||l===P.Highlight&&!this.hasHighlights||l===P.Normal&&!this.hasWater||!s.hasSomeSizedView())return!1;const h=this._rctx;if(this._camera.pixelRatio=s.pixelRatio*o,this._renderContext.output=l,this._bindParameters.alignPixelEnabled=a,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=l===P.Normal?te.DRAPED_WATER:te.DRAPED_MATERIAL,i.content===le.Occluded&&(this._renderContext.renderOccludedMask=en),!this.renders(i.content))return this._renderContext.renderOccludedMask=Cr,!1;const c=s.resolution;this._rctx.setViewport(e===et.INNER?0:c,0,c,c);const d=2*s.resolution,g=s.resolution,p=i.fbo;if(p.bind(h,d,g),e===et.INNER&&(h.setClearColor(0,0,0,0),h.clear(Mi.COLOR_BUFFER_BIT)),ki.OVERLAY_DRAW_DEBUG_TEXTURE&&i.content!==le.Occluded)for(let f=0;f<n.numViews;f++)this._setViewParameters(n.extents[f],s),this._ensureDebugPatternResources(s.resolution,Sh[e]),this._rctx.bindTechnique(this._debugTextureTechnique,this._renderContext.bindParameters,this._passParameters),this._rctx.screen.draw();return this._sortedRenderers.forAll(({drapeSource:f,renderer:y})=>{if(i.content===le.ColorNoRasterImage&&f.drapeSourceType===Gt.RasterImage)return;const{fullOpacity:w}=f,O=w!=null&&w<1&&l===P.Color?this.bindTemporaryFramebuffer(d,g):null;for(let v=0;v<n.numViews;v++)this._setViewParameters(n.extents[v],s),y.render(this._renderContext);if(O){p.bind(h,d,g),this._overlayParameters.texture=O.getTexture(),this._overlayParameters.opacity=w,this._overlayParameters.overlayIndex=e;const v=this.pluginContext.techniques.acquire(Fn);this._rctx.bindTechnique(v,this._renderContext.bindParameters,this._overlayParameters),this._rctx.screen.draw(),v.release(),O.release()}}),h.bindFramebuffer(null),this._renderContext.renderOccludedMask=Cr,!0}bindTemporaryFramebuffer(e,i){var n;const r=this.view._stage.renderer.fboCache,s=r.acquire(e,i,"overlay tmp");return r.rctx.unbindTexture((n=s.fbo)==null?void 0:n.colorTexture),r.rctx.bindFramebuffer(s.fbo),r.rctx.clear(Mi.COLOR_BUFFER_BIT),s}async reloadShaders(){await this._techniques.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,i,r,s){var a;this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let n=0;for(const{renderer:o}of this._sortedRenderers)n=((a=o.intersect)==null?void 0:a.call(o,e,i,r,s,n))??n}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this.view.map.allLayers,i=e.length;this._renderers.forEach((r,s)=>{const n=e.indexOf(s.layer),a=n>=0,o=s.renderGroup??(a?Ii.MapLayer:Ii.ViewLayer),l=i*o+(a?n:0);this._sortedRenderers.push(new wh(s,r,l))}),this._sortedRenderers.sort((r,s)=>r.index-s.index)}_setViewParameters(e,i){const r=this._camera;r.viewport=[0,0,i.resolution,i.resolution],Ra(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),Ca(r.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=ze(this._renderers,i=>i.hasWater);e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_ensureDebugPatternResources(e,i){if(Y(this._passParameters.color,i[0],i[1],i[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let s=0;for(let o=0;o<e;o++)for(let l=0;l<e;l++){const h=Math.floor(l/10),c=Math.floor(o/10);h<2||c<2||10*h>e-20||10*c>e-20?(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=255):(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=1&h&&1&c?1&l^1&o?0:255:1&h^1&c?0:128)}const n=new Fo(e);n.samplingMode=Io.NEAREST,this._passParameters.texture=new mr(this._rctx,n,r);const a=new Ln;a.hasAlpha=!0,this._debugTextureTechnique=this._techniques.acquire(In,a)}get test(){}};u([x()],Re.prototype,"hasHighlights",void 0),u([x()],Re.prototype,"_sortedDrapeSourceRenderersDirty",void 0),u([x()],Re.prototype,"_techniques",void 0),u([x({constructOnly:!0})],Re.prototype,"view",void 0),u([x()],Re.prototype,"worldToPCSRatio",void 0),u([x()],Re.prototype,"spatialReference",void 0),u([x({type:Boolean,readOnly:!0})],Re.prototype,"updating",null),u([x()],Re.prototype,"isEmpty",null),u([x({readOnly:!0})],Re.prototype,"rendersOccludedDraped",null),Re=u([Ne("esri.views.3d.terrain.OverlayRenderer")],Re);class wh{constructor(e,i,r){this.drapeSource=e,this.renderer=i,this.index=r}}const Sh=[[1,.5,.5],[.5,.5,1]],Th=-2,en=Ce.OccludeAndTransparent;var Er;(function(t){function e(a,o){const l=a[o],h=a[o+1],c=a[o+2];return Math.sqrt(l*l+h*h+c*c)}function i(a,o){const l=a[o],h=a[o+1],c=a[o+2],d=1/Math.sqrt(l*l+h*h+c*c);a[o]*=d,a[o+1]*=d,a[o+2]*=d}function r(a,o,l){a[o]*=l,a[o+1]*=l,a[o+2]*=l}function s(a,o,l,h,c,d=o){(c=c||a)[d]=a[o]+l[h],c[d+1]=a[o+1]+l[h+1],c[d+2]=a[o+2]+l[h+2]}function n(a,o,l,h,c,d=o){(c=c||a)[d]=a[o]-l[h],c[d+1]=a[o+1]-l[h+1],c[d+2]=a[o+2]-l[h+2]}t.length=e,t.normalize=i,t.scale=r,t.add=s,t.subtract=n})(Er||(Er={}));const gt=Er,cr=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],bh=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],xh=[0,0,1,0,1,1,0,1],Oh=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],Un=new Array(36);for(let t=0;t<6;t++)for(let e=0;e<6;e++)Un[6*t+e]=t;const Ze=new Array(36);for(let t=0;t<6;t++)Ze[6*t]=0,Ze[6*t+1]=1,Ze[6*t+2]=2,Ze[6*t+3]=2,Ze[6*t+4]=3,Ze[6*t+5]=0;function Hd(t,e){Array.isArray(e)||(e=[e,e,e]);const i=new Array(24);for(let r=0;r<8;r++)i[3*r]=cr[r][0]*e[0],i[3*r+1]=cr[r][1]*e[1],i[3*r+2]=cr[r][2]*e[2];return new we(t,[[_.POSITION,new F(i,Oh,3,!0)],[_.NORMAL,new F(bh,Un,3)],[_.UV0,new F(xh,Ze,2)]])}const dr=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],Rh=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],Ch=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],Ah=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];function zd(t,e){Array.isArray(e)||(e=[e,e,e]);const i=new Array(18);for(let r=0;r<6;r++)i[3*r]=dr[r][0]*e[0],i[3*r+1]=dr[r][1]*e[1],i[3*r+2]=dr[r][2]*e[2];return new we(t,[[_.POSITION,new F(i,Ch,3,!0)],[_.NORMAL,new F(Rh,Ah,3)]])}const bi=J(-.5,0,-.5),xi=J(.5,0,-.5),Oi=J(0,0,.5),Ri=J(0,.5,0),mt=Ae(),_t=Ae(),At=Ae(),Et=Ae(),Dt=Ae();ie(mt,bi,Ri),ie(_t,bi,xi),Pe(At,mt,_t),ee(At,At),ie(mt,xi,Ri),ie(_t,xi,Oi),Pe(Et,mt,_t),ee(Et,Et),ie(mt,Oi,Ri),ie(_t,Oi,bi),Pe(Dt,mt,_t),ee(Dt,Dt);const ur=[bi,xi,Oi,Ri],Eh=[0,-1,0,At[0],At[1],At[2],Et[0],Et[1],Et[2],Dt[0],Dt[1],Dt[2]],Dh=[0,1,2,3,1,0,3,2,1,3,0,2],$h=[0,0,0,1,1,1,2,2,2,3,3,3];function Gd(t,e){Array.isArray(e)||(e=[e,e,e]);const i=new Array(12);for(let r=0;r<4;r++)i[3*r]=ur[r][0]*e[0],i[3*r+1]=ur[r][1]*e[1],i[3*r+2]=ur[r][2]*e[2];return new we(t,[[_.POSITION,new F(i,Dh,3,!0)],[_.NORMAL,new F(Eh,$h,3)]])}function Bd(t,e,i,r,s={uv:!0}){const n=-Math.PI,a=2*Math.PI,o=-Math.PI/2,l=Math.PI,h=Math.max(3,Math.floor(i)),c=Math.max(2,Math.floor(r)),d=(h+1)*(c+1),g=xe(3*d),p=xe(3*d),f=xe(2*d),y=[];let w=0;for(let S=0;S<=c;S++){const C=[],T=S/c,A=o+T*l,m=Math.cos(A);for(let W=0;W<=h;W++){const V=W/h,E=n+V*a,he=Math.cos(E)*m,j=Math.sin(A),Fe=-Math.sin(E)*m;g[3*w]=he*e,g[3*w+1]=j*e,g[3*w+2]=Fe*e,p[3*w]=he,p[3*w+1]=j,p[3*w+2]=Fe,f[2*w]=V,f[2*w+1]=T,C.push(w),++w}y.push(C)}const O=new Array;for(let S=0;S<c;S++)for(let C=0;C<h;C++){const T=y[S][C],A=y[S][C+1],m=y[S+1][C+1],W=y[S+1][C];S===0?(O.push(T),O.push(m),O.push(W)):S===c-1?(O.push(T),O.push(A),O.push(m)):(O.push(T),O.push(A),O.push(m),O.push(m),O.push(W),O.push(T))}const v=[[_.POSITION,new F(g,O,3,!0)],[_.NORMAL,new F(p,O,3,!0)]];return s.uv&&v.push([_.UV0,new F(f,O,2,!0)]),s.offset&&(v[0][0]=_.OFFSET,v.push([_.POSITION,new F(Float64Array.from(s.offset),Vr(O.length),3,!0)])),new we(t,v)}function kd(t,e,i,r){const s=Mh(e,i);return new we(t,s)}function Mh(t,e,i){let r,s;r=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],s=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];for(let l=0;l<r.length;l+=3)gt.scale(r,l,t/gt.length(r,l));let n={};function a(l,h){l>h&&([l,h]=[h,l]);const c=l.toString()+"."+h.toString();if(n[c])return n[c];let d=r.length;return r.length+=3,gt.add(r,3*l,r,3*h,r,d),gt.scale(r,d,t/gt.length(r,d)),d/=3,n[c]=d,d}for(let l=0;l<e;l++){const h=s.length,c=new Array(4*h);for(let d=0;d<h;d+=3){const g=s[d],p=s[d+1],f=s[d+2],y=a(g,p),w=a(p,f),O=a(f,g),v=4*d;c[v]=g,c[v+1]=y,c[v+2]=O,c[v+3]=p,c[v+4]=w,c[v+5]=y,c[v+6]=f,c[v+7]=O,c[v+8]=w,c[v+9]=y,c[v+10]=w,c[v+11]=O}s=c,n={}}const o=vs(r);for(let l=0;l<o.length;l+=3)gt.normalize(o,l);return[[_.POSITION,new F(vs(r),s,3,!0)],[_.NORMAL,new F(o,s,3,!0)]]}function qd(t,e,i,r,s,n,a,o,l=null){const h=i?ls(i):D(),c=e?ls(e):it(0,0,1);a??(a=B());const d=r?[255*r[0],255*r[1],255*r[2],r.length>3?255*r[3]:255]:[255,255,255,255],g=s!=null&&s.length===2?s:[1,1],p=Vr(1),f=[[_.POSITION,new F(h,p,3,!0)],[_.NORMAL,new F(c,p,3,!0)],[_.UV0,new F(a,p,a.length)],[_.COLOR,new F(d,p,4,!0)],[_.SIZE,new F(g,p,2)]];if(n!=null&&(n=[n[0],n[1],n[2],n[3]],f.push([_.CENTEROFFSETANDDISTANCE,new F(n,p,4)])),o){const y=[o[0],o[1],o[2],o[3]];f.push([_.FEATUREATTRIBUTE,new F(y,p,4)])}return new we(t,f,null,Mt.Point,l)}function Yd(t,e,i,r,s,n=!0,a=!0){let o=0;const l=i,h=e;let c=J(0,o,0),d=J(0,o+h,0),g=J(0,-1,0),p=J(0,1,0);s&&(o=h,d=J(0,0,0),c=J(0,o,0),g=J(0,1,0),p=J(0,-1,0));const f=[d,c],y=[g,p],w=r+2,O=Math.sqrt(h*h+l*l);if(s)for(let m=r-1;m>=0;m--){const W=m*(2*Math.PI/r),V=J(Math.cos(W)*l,o,Math.sin(W)*l);f.push(V);const E=J(h*Math.cos(W)/O,-l/O,h*Math.sin(W)/O);y.push(E)}else for(let m=0;m<r;m++){const W=m*(2*Math.PI/r),V=J(Math.cos(W)*l,o,Math.sin(W)*l);f.push(V);const E=J(h*Math.cos(W)/O,l/O,h*Math.sin(W)/O);y.push(E)}const v=new Array,S=new Array;if(n){for(let m=3;m<f.length;m++)v.push(1),v.push(m-1),v.push(m),S.push(0),S.push(0),S.push(0);v.push(f.length-1),v.push(2),v.push(1),S.push(0),S.push(0),S.push(0)}if(a){for(let m=3;m<f.length;m++)v.push(m),v.push(m-1),v.push(0),S.push(m),S.push(m-1),S.push(1);v.push(0),v.push(2),v.push(f.length-1),S.push(1),S.push(2),S.push(y.length-1)}const C=xe(3*w);for(let m=0;m<w;m++)C[3*m]=f[m][0],C[3*m+1]=f[m][1],C[3*m+2]=f[m][2];const T=xe(3*w);for(let m=0;m<w;m++)T[3*m]=y[m][0],T[3*m+1]=y[m][1],T[3*m+2]=y[m][2];const A=[[_.POSITION,new F(C,v,3,!0)],[_.NORMAL,new F(T,S,3,!0)]];return new we(t,A)}function Jd(t,e,i,r,s,n,a){const o=s?hs(s):J(1,0,0),l=n?hs(n):J(0,0,0);a??(a=!0);const h=Ae();ee(h,o);const c=Ae();re(c,h,Math.abs(e));const d=Ae();re(d,c,-.5),oe(d,d,l);const g=J(0,1,0);Math.abs(1-$t(h,g))<.2&&Y(g,0,0,1);const p=Ae();Pe(p,h,g),ee(p,p),Pe(g,p,h);const f=2*r+(a?2:0),y=r+(a?2:0),w=xe(3*f),O=xe(3*y),v=xe(2*f),S=new Array(3*r*(a?4:2)),C=new Array(3*r*(a?4:2));a&&(w[3*(f-2)]=d[0],w[3*(f-2)+1]=d[1],w[3*(f-2)+2]=d[2],v[2*(f-2)]=0,v[2*(f-2)+1]=0,w[3*(f-1)]=w[3*(f-2)]+c[0],w[3*(f-1)+1]=w[3*(f-2)+1]+c[1],w[3*(f-1)+2]=w[3*(f-2)+2]+c[2],v[2*(f-1)]=1,v[2*(f-1)+1]=1,O[3*(y-2)]=-h[0],O[3*(y-2)+1]=-h[1],O[3*(y-2)+2]=-h[2],O[3*(y-1)]=h[0],O[3*(y-1)+1]=h[1],O[3*(y-1)+2]=h[2]);const T=(E,he,j)=>{S[E]=he,C[E]=j};let A=0;const m=Ae(),W=Ae();for(let E=0;E<r;E++){const he=E*(2*Math.PI/r);re(m,g,Math.sin(he)),re(W,p,Math.cos(he)),oe(m,m,W),O[3*E]=m[0],O[3*E+1]=m[1],O[3*E+2]=m[2],re(m,m,i),oe(m,m,d),w[3*E]=m[0],w[3*E+1]=m[1],w[3*E+2]=m[2],v[2*E]=E/r,v[2*E+1]=0,w[3*(E+r)]=w[3*E]+c[0],w[3*(E+r)+1]=w[3*E+1]+c[1],w[3*(E+r)+2]=w[3*E+2]+c[2],v[2*(E+r)]=E/r,v[2*E+1]=1;const j=(E+1)%r;T(A++,E,E),T(A++,E+r,E),T(A++,j,j),T(A++,j,j),T(A++,E+r,E),T(A++,j+r,j)}if(a){for(let E=0;E<r;E++){const he=(E+1)%r;T(A++,f-2,y-2),T(A++,E,y-2),T(A++,he,y-2)}for(let E=0;E<r;E++){const he=(E+1)%r;T(A++,E+r,y-1),T(A++,f-1,y-1),T(A++,he+r,y-1)}}const V=[[_.POSITION,new F(w,S,3,!0)],[_.NORMAL,new F(O,C,3,!0)],[_.UV0,new F(v,S,2,!0)]];return new we(t,V)}function Xd(t,e,i,r,s,n){r=r||10,s=s==null||s,pe(e.length>1);const a=[[0,0,0]],o=[],l=[];for(let h=0;h<r;h++){o.push([0,-h-1,-(h+1)%r-1]);const c=h/r*2*Math.PI;l.push([Math.cos(c)*i,Math.sin(c)*i])}return Ih(t,l,e,a,o,s,n)}function Ih(t,e,i,r,s,n,a=J(0,0,0)){const o=e.length,l=xe(i.length*o*3+(6*r.length||0)),h=xe(i.length*o*3+(r?6:0)),c=new Array,d=new Array;let g=0,p=0;const f=D(),y=D(),w=D(),O=D(),v=D(),S=D(),C=D(),T=D(),A=D(),m=D(),W=D(),V=D(),E=D(),he=ei();Y(A,0,1,0),ie(y,i[1],i[0]),ee(y,y),n?(oe(T,i[0],a),ee(w,T)):Y(w,0,0,1),tn(y,w,A,A,v,w,rn),X(O,w),X(V,v);for(let $=0;$<r.length;$++)re(S,v,r[$][0]),re(T,w,r[$][2]),oe(S,S,T),oe(S,S,i[0]),l[g++]=S[0],l[g++]=S[1],l[g++]=S[2];h[p++]=-y[0],h[p++]=-y[1],h[p++]=-y[2];for(let $=0;$<s.length;$++)c.push(s[$][0]>0?s[$][0]:-s[$][0]-1+r.length),c.push(s[$][1]>0?s[$][1]:-s[$][1]-1+r.length),c.push(s[$][2]>0?s[$][2]:-s[$][2]-1+r.length),d.push(0),d.push(0),d.push(0);let j=r.length;const Fe=r.length-1;for(let $=0;$<i.length;$++){let k=!1;$>0&&(X(f,y),$<i.length-1?(ie(y,i[$+1],i[$]),ee(y,y)):k=!0,oe(m,f,y),ee(m,m),oe(W,i[$-1],O),Aa(i[$],m,he),Ea(he,Da(W,f),T)?(ie(T,T,i[$]),ee(w,T),Pe(v,m,w),ee(v,v)):tn(m,O,V,A,v,w,rn),X(O,w),X(V,v)),n&&(oe(T,i[$],a),ee(E,T));for(let Z=0;Z<o;Z++)if(re(S,v,e[Z][0]),re(T,w,e[Z][1]),oe(S,S,T),ee(C,S),h[p++]=C[0],h[p++]=C[1],h[p++]=C[2],oe(S,S,i[$]),l[g++]=S[0],l[g++]=S[1],l[g++]=S[2],!k){const me=(Z+1)%o;c.push(j+Z),c.push(j+o+Z),c.push(j+me),c.push(j+me),c.push(j+o+Z),c.push(j+o+me);for(let Ue=0;Ue<6;Ue++){const at=c.length-6;d.push(c[at+Ue]-Fe)}}j+=o}const It=i[i.length-1];for(let $=0;$<r.length;$++)re(S,v,r[$][0]),re(T,w,r[$][1]),oe(S,S,T),oe(S,S,It),l[g++]=S[0],l[g++]=S[1],l[g++]=S[2];const je=p/3;h[p++]=y[0],h[p++]=y[1],h[p++]=y[2];const nt=j-o;for(let $=0;$<s.length;$++)c.push(s[$][0]>=0?j+s[$][0]:-s[$][0]-1+nt),c.push(s[$][2]>=0?j+s[$][2]:-s[$][2]-1+nt),c.push(s[$][1]>=0?j+s[$][1]:-s[$][1]-1+nt),d.push(je),d.push(je),d.push(je);const ti=[[_.POSITION,new F(l,c,3,!0)],[_.NORMAL,new F(h,d,3,!0)]];return new we(t,ti)}function Zd(t,e,i,r){pe(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),pe(e[0].length===3,"createPolylineGeometry(): malformed vertex"),pe(i==null||i.length===e.length,"createPolylineGeometry: need same number of points and normals"),pe(i==null||i[0].length===3,"createPolylineGeometry(): malformed normal");const s=Pr(3*e.length),n=new Array(2*(e.length-1));let a=0,o=0;for(let h=0;h<e.length;h++){for(let c=0;c<3;c++)s[a++]=e[h][c];h>0&&(n[o++]=h-1,n[o++]=h)}const l=[[_.POSITION,new F(s,n,3,!0)]];if(i){const h=xe(3*i.length);let c=0;for(let d=0;d<e.length;d++)for(let g=0;g<3;g++)h[c++]=i[d][g];l.push([_.NORMAL,new F(h,n,3,!0)])}return r&&l.push([_.COLOR,new F(r,_o(r.length/4),4)]),new we(t,l,null,Mt.Line)}function Qd(t,e,i,r,s,n=0){const a=new Array(18),o=[[-i,n,s/2],[r,n,s/2],[0,e+n,s/2],[-i,n,-s/2],[r,n,-s/2],[0,e+n,-s/2]],l=[0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5];for(let h=0;h<6;h++)a[3*h]=o[h][0],a[3*h+1]=o[h][1],a[3*h+2]=o[h][2];return new we(t,[[_.POSITION,new F(a,l,3,!0)]])}function Kd(t,e){const i=t.getMutableAttribute(_.POSITION).data;for(let r=0;r<i.length;r+=3){const s=i[r],n=i[r+1],a=i[r+2];Y(vt,s,n,a),ye(vt,vt,e),i[r]=vt[0],i[r+1]=vt[1],i[r+2]=vt[2]}}function eu(t,e=t){const i=t.attributes,r=i.get(_.POSITION).data,s=i.get(_.NORMAL).data;if(s){const n=e.getMutableAttribute(_.NORMAL).data;for(let a=0;a<s.length;a+=3){const o=s[a+1];n[a+1]=-s[a+2],n[a+2]=o}}if(r){const n=e.getMutableAttribute(_.POSITION).data;for(let a=0;a<r.length;a+=3){const o=r[a+1];n[a+1]=-r[a+2],n[a+2]=o}}}function pr(t,e,i,r,s){return!(Math.abs($t(e,t))>s)&&(Pe(i,t,e),ee(i,i),Pe(r,i,t),ee(r,r),!0)}function tn(t,e,i,r,s,n,a){return pr(t,e,s,n,a)||pr(t,i,s,n,a)||pr(t,r,s,n,a)}const rn=.99619469809,vt=D();let tu=class{constructor(e,i={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=G(),this._shaderTransformation=null,this._boundingSphere=null,this.id=fn(),this.layerUid=i.layerUid,this.graphicUid=i.graphicUid,this.castShadow=i.castShadow??!1,i.objectShaderTransformation!=null&&this.objectShaderTransformationChanged(i.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){tt(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??(this._shaderTransformation=G()),Be(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??(this._boundingSphere=an()),ye(Ci(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*nn(this.shaderTransformation)),this._boundingSphere):$a}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}};function Ph(t,e,i,r,s,n,a,o,l,h,c){const d=Hh[c.mode];let g,p,f=0;if(Ei(t,e,i,r,l.spatialReference,s,o))return d.requiresAlignment(c)?(f=d.applyElevationAlignmentBuffer(r,s,n,a,o,l,h,c),g=n,p=a):(g=r,p=s),Ei(g,l.spatialReference,p,n,h.spatialReference,a,o)?f:void 0}function Vn(t,e,i,r,s){const n=(wn(t)?t.z:Sn(t)?t.array[t.offset+2]:t[2])||0;switch(i.mode){case"on-the-ground":{const a=li(e,t,"ground")??0;return s.verticalDistanceToGround=0,s.sampledElevation=a,void(s.z=a)}case"relative-to-ground":{const a=li(e,t,"ground")??0,o=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=o,s.sampledElevation=a,void(s.z=o+a)}case"relative-to-scene":{const a=li(e,t,"scene")??0,o=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=o,s.sampledElevation=a,void(s.z=o+a)}case"absolute-height":{const a=i.geometryZWithOffset(n,r),o=li(e,t,"ground")??0;return s.verticalDistanceToGround=a-o,s.sampledElevation=o,void(s.z=a)}default:return void(s.z=0)}}function ru(t,e,i,r){return Vn(t,e,i,r,Ot),Ot.z}function su(t,e,i){return e==="on-the-ground"&&i==="on-the-ground"?t.staysOnTheGround:e===i||e!=="on-the-ground"&&i!=="on-the-ground"?e==null||i==null?t.definedChanged:Dr.UPDATE:t.onTheGroundChanged}function nu(t){return t==="relative-to-ground"||t==="relative-to-scene"}function au(t){return t!=="absolute-height"}function ou(t,e,i,r,s){Vn(e,i,s,r,Ot),Lh(t,Ot.verticalDistanceToGround);const n=Ot.sampledElevation,a=tt(zh,t.transformation);return yi[0]=e.x,yi[1]=e.y,yi[2]=Ot.z,Ma(e.spatialReference,yi,a,r.spatialReference)?t.transformation=a:console.warn("Could not locate symbol object properly, it might be misplaced"),n}function Lh(t,e){for(let i=0;i<t.geometries.length;++i){const r=t.geometries[i].getMutableAttribute(_.CENTEROFFSETANDDISTANCE);r&&r.data[3]!==e&&(r.data[3]=e,t.geometryVertexAttributeUpdated(t.geometries[i],_.CENTEROFFSETANDDISTANCE))}}function Nh(t,e,i,r,s,n){let a=0;const o=n.spatialReference;e*=3,r*=3;for(let l=0;l<s;++l){const h=t[e],c=t[e+1],d=t[e+2],g=n.getElevation(h,c,d,o,"ground")??0;a+=g,i[r]=h,i[r+1]=c,i[r+2]=g,e+=3,r+=3}return a/s}function Fh(t,e,i,r,s,n,a,o){let l=0;const h=o.calculateOffsetRenderUnits(a),c=o.featureExpressionInfoContext,d=n.spatialReference;e*=3,r*=3;for(let g=0;g<s;++g){const p=t[e],f=t[e+1],y=t[e+2],w=n.getElevation(p,f,y,d,"ground")??0;l+=w,i[r]=p,i[r+1]=f,i[r+2]=c==null?y+w+h:w+h,e+=3,r+=3}return l/s}function jh(t,e,i,r,s,n,a,o){let l=0;const h=o.calculateOffsetRenderUnits(a),c=o.featureExpressionInfoContext,d=n.spatialReference;e*=3,r*=3;for(let g=0;g<s;++g){const p=t[e],f=t[e+1],y=t[e+2],w=n.getElevation(p,f,y,d,"scene")??0;l+=w,i[r]=p,i[r+1]=f,i[r+2]=c==null?y+w+h:w+h,e+=3,r+=3}return l/s}function Uh(t){const e=t.meterUnitOffset,i=t.featureExpressionInfoContext;return e!==0||i!=null}function Vh(t,e,i,r,s,n,a,o){const l=o.calculateOffsetRenderUnits(a),h=o.featureExpressionInfoContext;e*=3,r*=3;for(let c=0;c<s;++c){const d=t[e],g=t[e+1],p=t[e+2];i[r]=d,i[r+1]=g,i[r+2]=h==null?p+l:l,e+=3,r+=3}return 0}class Wh{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}var Dr;(function(t){t[t.NONE=0]="NONE",t[t.UPDATE=1]="UPDATE",t[t.RECREATE=2]="RECREATE"})(Dr||(Dr={}));const Hh={"absolute-height":{applyElevationAlignmentBuffer:Vh,requiresAlignment:Uh},"on-the-ground":{applyElevationAlignmentBuffer:Nh,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:Fh,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:jh,requiresAlignment:()=>!0}},zh=G(),Ot=new Wh,yi=D(),Gh=()=>ji.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function Bh(t){return{cachedResult:t.cachedResult,arcade:t.arcade?{func:t.arcade.func,context:t.arcade.modules.arcadeUtils.createExecContext(null,{sr:t.arcade.context.spatialReference}),modules:t.arcade.modules}:null}}async function lu(t,e,i,r){const s=t==null?void 0:t.expression;if(typeof s!="string")return null;const n=Jh(s);if(n!=null)return{cachedResult:n};const a=await Ia();Pa(i);const o=a.arcadeUtils,l=o.createSyntaxTree(s);return o.dependsOnView(l)?(r!=null&&r.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:o.createFunction(l),context:o.createExecContext(null,{sr:e}),modules:a}}}function kh(t,e,i){return t.arcadeUtils.createFeature(e.attributes,e.geometry,i)}function qh(t,e){if(t!=null&&!Wn(t)){if(!e||!t.arcade)return void Gh().errorOncePerTick("Arcade support required but not provided");const i=e;i._geometry&&(i._geometry=So(i._geometry)),t.arcade.modules.arcadeUtils.updateExecContext(t.arcade.context,e)}}function Yh(t){if(t!=null){if(Wn(t))return t.cachedResult;const e=t.arcade;let i=e==null?void 0:e.modules.arcadeUtils.executeFunction(e.func,e.context);return typeof i!="number"&&(t.cachedResult=0,i=0),i}return 0}function hu(t,e=!1){let i=t==null?void 0:t.featureExpressionInfo;const r=i==null?void 0:i.expression;return e||r==="0"||(i=null),i??null}const cu={cachedResult:0};function Wn(t){return t.cachedResult!=null}function Jh(t){return t==="0"?0:null}let du=class Hn{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=La(e)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,i){const r=this.calculateOffsetRenderUnits(i);return this.featureExpressionInfoContext!=null?r:e+r}calculateOffsetRenderUnits(e){let i=this._meterUnitOffset;const r=this.featureExpressionInfoContext;return r!=null&&(i+=Yh(r)*this._metersPerElevationInfoUnit),i/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=Na(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}updateFeatureExpressionInfoContext(e,i,r){if(e==null)return void(this._featureExpressionInfoContext=null);const s=e==null?void 0:e.arcade;s&&i!=null&&r!=null?(this._featureExpressionInfoContext=Bh(e),qh(this._featureExpressionInfoContext,kh(s.modules,i,r))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const i=new Hn;return e!=null&&i.setFromElevationInfo(e),i}};const ne={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},Xh={dash:ne.dash,"dash-dot":[...ne.dash,...ne.dot],dot:ne.dot,"long-dash":ne["long-dash"],"long-dash-dot":[...ne["long-dash"],...ne.dot],"long-dash-dot-dot":[...ne["long-dash"],...ne.dot,...ne.dot],none:null,"short-dash":ne["short-dash"],"short-dash-dot":[...ne["short-dash"],...ne["short-dot"]],"short-dash-dot-dot":[...ne["short-dash"],...ne["short-dot"],...ne["short-dot"]],"short-dot":ne["short-dot"],solid:null},Zh=8;function Qh(t,e){return t==null?t:{pattern:t.slice(),pixelRatio:e}}function uu(t){return{pattern:[t,t],pixelRatio:2}}function pu(t){return t!=null&&t.type==="style"?Kh(t.style):null}function Kh(t){return t!=null?Qh(Xh[t],Zh):null}function fu(t,e,i=null){const r=[],s=e.mapPositions;ec(e,r);const n=r[0][1].data,a=r[0][1].indices.length,o=Vr(a);return tc(e,r,o),sc(e,r,o),ic(e,r,o),rc(e,r,o),nc(e,r,o),ac(e,r,o),oc(e,r,n),new we(t,r,s,Mt.Line,i)}function ec(t,e){const{attributeData:{position:i},removeDuplicateStartEnd:r}=t,s=lc(i)&&r,n=i.length/3-(s?1:0),a=new Array(2*(n-1)),o=s?i.slice(0,-3):i;let l=0;for(let h=0;h<n-1;h++)a[l++]=h,a[l++]=h+1;e.push([_.POSITION,new F(o,a,3,s)])}function tc(t,e,i){if(t.attributeData.colorFeature!=null)return;const r=t.attributeData.color;e.push([_.COLOR,new F(r??pn,i,4)])}function ic(t,e,i){t.attributeData.normal&&e.push([_.NORMAL,new F(t.attributeData.normal,i,3)])}function rc(t,e,i){t.attributeData.colorFeature!=null&&e.push([_.COLORFEATUREATTRIBUTE,new F([t.attributeData.colorFeature],i,1,!0)])}function sc(t,e,i){t.attributeData.sizeFeature==null&&e.push([_.SIZE,new F([t.attributeData.size??1],i,1,!0)])}function nc(t,e,i){t.attributeData.sizeFeature!=null&&e.push([_.SIZEFEATUREATTRIBUTE,new F([t.attributeData.sizeFeature],i,1,!0)])}function ac(t,e,i){t.attributeData.opacityFeature!=null&&e.push([_.OPACITYFEATUREATTRIBUTE,new F([t.attributeData.opacityFeature],i,1,!0)])}function oc(t,e,i){if(t.overlayInfo==null||t.overlayInfo.renderCoordsHelper.viewingMode!==Fi.Global||!t.overlayInfo.spatialReference.isGeographic)return;const r=Pr(i.length),s=Fa(t.overlayInfo.spatialReference);for(let d=0;d<r.length;d+=3)ja(i,d,r,d,s);const n=i.length/3,a=xe(n+1);let o=hc,l=cc,h=0,c=0;Yt(o,r[c++],r[c++]),c++,a[0]=0;for(let d=1;d<n+1;++d)d===n&&(c=0),Yt(l,r[c++],r[c++]),c++,h+=Ua(o,l),a[d]=h,[o,l]=[l,o];e.push([_.DISTANCETOSTART,new F(a,e[0][1].indices,1,!0)])}function lc(t){const e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}const hc=B(),cc=B();function gu(t,e,i,r){const s=t.type==="polygon"?$i.CCW_IS_HOLE:$i.NONE,n=t.type==="polygon"?t.rings:t.paths,{position:a,outlines:o}=yn(n,!!t.hasZ,s,t.spatialReference),l=Pr(a.length),h=Ph(a,t.spatialReference,0,l,0,a,0,a.length/3,e,i,r),c=h!=null;return{lines:c?zn(o,a,l):[],projectionSuccess:c,sampledElevation:h}}function mu(t,e){const i=t.type==="polygon"?$i.CCW_IS_HOLE:$i.NONE,r=t.type==="polygon"?t.rings:t.paths,{position:s,outlines:n}=yn(r,!1,i),a=Ei(s,t.spatialReference,0,s,e,0,s.length/3);for(let o=2;o<s.length;o+=3)s[o]=Th;return{lines:a?zn(n,s):[],projectionSuccess:a}}function zn(t,e,i=null){const r=new Array;for(const{index:s,count:n}of t){if(n<=1)continue;const a=3*s,o=3*n;r.push({position:cs(e,3*s,3*n),mapPositions:i!=null?cs(i,a,o):void 0})}return r}const dc=Object.freeze(Object.defineProperty({__proto__:null,build:Cn,ribbonlineNumRoundJoinSubdivisions:Zt},Symbol.toStringTag,{value:"Module"})),uc=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:zr,build:bn},Symbol.toStringTag,{value:"Module"})),pc=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Br,build:Nn},Symbol.toStringTag,{value:"Module"}));export{nu as $,Xd as A,Yd as B,Jt as C,Ih as D,Pi as E,rd as F,z as G,wr as H,bt as I,hu as J,lu as K,Vn as L,eu as M,zd as N,Ho as O,Gd as P,Hd as Q,Wh as R,kd as S,Lh as T,Lc as U,qh as V,cu as W,Dr as X,ou as Y,yd as Z,su as _,Wo as a,kh as a0,au as a1,Me as a2,st as a3,rt as a4,Tl as a5,Ll as a6,Xt as a7,Rn as a8,Ml as a9,ud as aa,Q as ab,pu as ac,ah as ad,Bc as ae,tn as af,ql as ag,Ii as b,Rr as c,ko as d,Gt as e,Jo as f,Zd as g,uu as h,fu as i,ru as j,qd as k,mu as l,tu as m,Wc as n,du as o,gu as p,Vi as q,Xo as r,Bd as s,Th as t,Ph as u,li as v,Qd as w,Kd as x,Jd as y,Fl as z};
