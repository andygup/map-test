import{bE as W,bF as j,bG as z,bH as E,bI as L,a9 as A,bJ as B,bK as C,ad as D,bL as F}from"./index-DzfnmjFP.js";import{r as H}from"./vec3f32-nZdmKIgz.js";import{n as J,h as K}from"./WGLContainer-U6-BcYfB.js";import{E as k}from"./Container-CR-hhQoG.js";class V extends J{constructor(){super(...arguments),this._viewStateId=-1,this._dvsMat3=W()}get dvsMat3(){return this._dvsMat3}beforeRender(e){this._updateMatrices(e),this._updateOverlays(e,this.children);for(const s of this.children)s.beforeRender(e)}prepareRenderPasses(e){const s=e.registerRenderPass({name:"overlay",brushes:[K.overlay],target:()=>this.children,drawPhase:k.MAP});return[...super.prepareRenderPasses(e),s]}_updateMatrices(e){const{state:s}=e,{id:a,size:c,pixelRatio:r,resolution:d,rotation:l,viewpoint:u,displayMat3:_}=s;if(this._viewStateId===a)return;const p=Math.PI/180*l,i=r*c[0],n=r*c[1];this._localOrigin=u.targetGeometry.clone();const{x:h,y:b}=this._localOrigin,M=j(h,s.spatialReference);this._localOrigin.x=M,this._localOrigin.y=b;const v=d*i,m=d*n,t=z(this._dvsMat3);E(t,t,_),L(t,t,A(i/2,n/2)),B(t,t,H(i/v,-n/m,1)),C(t,t,-p),this._viewStateId=a}_updateOverlays(e,s){const{state:a}=e,{rotation:c,spatialReference:r,worldScreenWidth:d,size:l,viewpoint:u}=a,_=this._localOrigin;let p,i=0;const n=D(r);if(n&&r.isWrappable){const h=l[0],b=l[1],M=180/Math.PI*c,v=Math.abs(Math.cos(M)),m=Math.abs(Math.sin(M)),t=Math.round(h*v+b*m),[R,x]=n.valid,o=F(r),{x:O,y:I}=u.targetGeometry,S=[O,I],g=[0,0];a.toScreen(g,S);const f=[0,0];let w;w=t>d?.5*d:.5*t;const P=Math.floor((O+.5*o)/o),$=R+P*o,G=x+P*o,y=[g[0]+w,0];a.toMap(f,y),f[0]>G&&(i=o),y[0]=g[0]-w,a.toMap(f,y),f[0]<$&&(i=-o),p={worldWidth:o,xBounds:[R,x]}}for(const h of s)h.updateDrawCoords(_,i,r,p)}}export{V as f};
