import{$T as e,A as t,BT as n,CE as r,CT as i,FC as a,L as o,LC as s,Li as c,M as l,Rh as u,ST as d,UT as f,Ua as p,VT as m,WT as h,ca as g,cv as _,dC as v,fC as y,hv as b,j as x,kD as S,lh as C,pa as w,pv as T,sT as E,ua as D,vE as O}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import"./WhereClause-CATd9kVz.js";import"./closestPointOnCurve-CwZL45U3.js";import"./Relationship-CyGEtlAI.js";import"./GraphQueryStreaming-DUkFf9hi.js";import"./WhereClauseCache-BO4WYMj9.js";import"./PooledRBush-BH7_Gu1G.js";import"./QueryEngineCapabilities-CxeEdoTy.js";import"./clientSideDefaults-Iizf0eUh.js";import"./generateRendererUtils-DGV_dTnd.js";import"./utils-DCGMUq-q.js";import"./cimSymbolUtils-CLt57XQ8.js";import"./utils-BGjabRH0.js";import{a as k,i as A,n as j,r as M,t as N,v as P,y as F}from"./KnowledgeGraphSublayer-CS9ztNyM.js";import{M as I}from"./knowledgeGraphService-IHR0Dm6J.js";import"./constants-nHW_AykQ.js";import"./GraphicsLayer-DBcl42yN.js";import"./networkEnums-DSwvS-2R.js";import"./GPMessage-BiUuPRZS.js";import"./BoundsStore-DE7p6f_c.js";import"./timeSupport-vK4lVcYW.js";import"./optimizedFeatureQueryEngineAdapter-DQyaY_b1.js";import"./FeatureStore-DxVA8hqB.js";import"./QueryEngine-CD8WljsT.js";import"./queryUtils-DGU5ISbw.js";import"./utils-Bftaersa.js";import"./utils-BizEctJo.js";import"./SnappingCandidate-4DPnOY6Y.js";import"./FixedIntervalBinParameters-CMgMaWGN.js";var L=class extends D(t(x(w(o(l(p(g(u)))))))){constructor(e){super(e),this._graphTypeLookup=new Map,this._namedTypesModified=!1,this.dataManager=null,this.definitionSetMap=null,this.knowledgeGraph=null,this.layers=new(b.ofType(N)),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType=`KnowledgeGraphLayer`,this.sublayerIdsCache=new Map,this.tables=new(b.ofType(N)),this.type=`knowledge-graph`,this.url=null,this.addHandles(T(()=>this.layers.concat(this.tables),(e,t)=>this._handleSublayersChange(e,t),_))}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}async _doLoad(e){try{await this.loadFromPortal({supportedTypes:[`Knowledge Graph Layer`]},e)}catch(e){E(e)}await this._fetchMetadata(e),await this._initializeLayerProperties(e),this.loadLayerAssumingLocalCache(),this._layersLoadedFromAuthoritativeItem()||await j(this)}async _fetchMetadata(t){if(!this.url)throw new e(`knowledge-graph:missing-url`,`KnowledgeGraphLayer must be created with a url`);let n=await I(this.url);this.knowledgeGraph=n;let{edit:r,fullEdit:i,updateItem:a}=await M(n.serviceDefinition.serviceItemId,this.url,t);this._set(`userHasEditingPrivileges`,r),this._set(`userHasFullEditingPrivileges`,i),this._set(`userHasUpdateItemPrivileges`,a),this._forEachGraphType(e=>{e.name&&this._graphTypeLookup.set(e.name,e)})}async _initializeLayerProperties(e){this.originIdOf(`inclusionModeDefinition`)===7?this._validateInclusionModeDefinition():await this._initializeInclusionModeDefinition(e),this._setMemberTypes(),this.dataManager=new k({knowledgeGraph:this.knowledgeGraph,inclusionModeDefinition:this.inclusionModeDefinition})}async _initializeInclusionModeDefinition(e){let t=this.definitionSetMap?await P(this.definitionSetMap,!0,e?.signal?{signal:e.signal}:void 0):{generateAllSublayers:!0,namedTypeDefinitions:new Map};[...this.layers.toArray(),...this.tables.toArray()].forEach(e=>{let n=this._graphTypeLookup.get(e.graphTypeName);n&&!t.namedTypeDefinitions.has(n.name)&&t.namedTypeDefinitions.set(n.name,{useAllData:!0})}),this.setAtOrigin(`inclusionModeDefinition`,t,i(this.originIdOf(`definitionSetMap`)))}_validateInclusionModeDefinition(){let{inclusionModeDefinition:t}=this;if(!t)return;let{namedTypeDefinitions:n}=t;if(n?.size>0)n.forEach((e,t)=>{let i=this._graphTypeLookup.get(t);if(!i)return r.getLogger(this).warn(`A named type, ${t}, was in the inclusion list that wasn't in the data model and will be removed`),void n.delete(t);i.type!==`relationship`&&i.type!==`entity`&&(r.getLogger(this).warn(`A named type, ${t}, was in the inclusion list that wasn't properly modeled and will be removed`),n.delete(t))});else if(!t.generateAllSublayers)throw new e(`knowledge-graph:composite-layer-constructor`,`If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined`)}_setMemberTypes(){let e=[],t=[],{inclusionModeDefinition:n}=this,r=n?.namedTypeDefinitions;!n||n.generateAllSublayers?(e=this.knowledgeGraph.dataModel?.entityTypes??[],t=this.knowledgeGraph.dataModel?.relationshipTypes??[]):r&&r.size>0&&r.forEach((n,r)=>{let i=this._graphTypeLookup.get(r);switch(i?.type){case`relationship`:t.push(i);break;case`entity`:e.push(i)}}),this.memberEntityTypes=e,this.memberRelationshipTypes=t}_forEachGraphType(e){[...this.knowledgeGraph.dataModel?.entityTypes??[],...this.knowledgeGraph.dataModel?.relationshipTypes??[]].forEach(t=>{e(t)})}_refreshNamedTypes(){this._namedTypesModified=!0;for(let e of this.layers)e.emit(`refresh`,{dataChanged:!0});for(let e of this.tables)e.emit(`refresh`,{dataChanged:!0})}async _handleNewRecords(e){let t=new Set,n=[];for(let r of e){if(!this._graphTypeLookup.has(r.typeName))continue;!1===this.layers.concat(this.tables).some(e=>e.objectType.name===r.typeName)&&(this.dataManager.sublayerCaches.set(r.typeName,new Map),t.add(r.typeName)),O(this.sublayerIdsCache,r.typeName,()=>new Set).add(r.id),n.push(r)}this.dataManager.addToLayer(n);for(let e of t){let t=this._graphTypeLookup.get(e);t&&(this._addSublayer(t),t.type===`entity`?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e))}await j(this,Array.from(t)),this._refreshNamedTypes()}_createSublayers(e,t,n){e.forEach(e=>{let r=this._createSublayer(e);n(r)&&t.push(r),this._updateSublayerCaches(e)})}_addSublayer(e){let t=this._createSublayer(e);return t.geometryType?this.layers.push(t):this.tables.push(t),t}_createSublayer(e){return new N({objectType:e,parentCompositeLayer:this,graphType:e.type})}_updateSublayers(e,t){t.forEach(t=>{t.parentCompositeLayer=this;let n=e.find(e=>e.type===t.graphType&&e.name===t.graphTypeName);n&&(t.objectType=n,this._updateSublayerCaches(n))})}_updateSublayerCaches({name:e}){if(!e)return;let t=this.dataManager.sublayerCaches;t.has(e)||t.set(e,new Map)}_saveUrlAsNewResource(e,t,n,r){e[t]=`<pending>`,n.pendingOperations.push(z(this.inclusionModeDefinition).then(i=>{let a=B(r);e[t]=a.itemRelativeUrl,n.toAdd.push({resource:a,content:{type:`blob`,blob:i},compress:!1,finish:e=>{this.definitionSetMap=e.url}})}))}_displaysAllRecords(e){for(let[,{useAllData:t}]of e.namedTypeDefinitions)if(!t)return!1;return!0}_handleSublayersChange(e,t){t&&(t.forEach(e=>{e.parent=null}),this.removeHandles(`sublayers-owner`)),e&&(e.forEach(e=>{e.parent=this}),this.addHandles([e.on(`after-add`,({item:e})=>{e.parent=this}),e.on(`after-remove`,({item:e})=>{e.parent=null})],`sublayers-owner`))}_layersLoadedFromAuthoritativeItem(){let e=this.originIdOf(`layers`);return e>=3&&e<7}readDefinitionSetMap(e,t,n){return y(e,n)}writeDefinitionSetMap(e,t,n,r){let i=r?.portalItem,a=r?.resources,o=d(r?.origin);if(!i||!a||o==null)return void(e&&(t[n]=v(e,r)));let{inclusionModeDefinition:c}=this;if(!c||this._displaysAllRecords(c))return void(this.definitionSetMap=null);let l=this.originIdOf(`inclusionModeDefinition`);if(l===7||this._namedTypesModified||o<l)this._saveUrlAsNewResource(t,n,a,i);else if(o===l&&e){let o=v(e,r);s(o)?this._saveUrlAsNewResource(t,n,a,i):t[n]=o}}set inclusionModeDefinition(e){this.loadStatus!==`loaded`&&this.loadStatus!==`failed`?this._set(`inclusionModeDefinition`,e):r.getLogger(this).error(`#inclusionModeDefinition`,`inclusionModeDefinition cannot be changed after the layer is loaded.`)}get sublayerCapabilities(){return A(this.knowledgeGraph)}loadLayerAssumingLocalCache(){let e=[...this.memberEntityTypes,...this.memberRelationshipTypes];this.layers.length||this.originIdOf(`tables`)===0?this.originIdOf(`layers`)===0?this._createSublayers(e,this.layers,e=>!!e.geometryType):this._updateSublayers(e,this.layers):this.layers=new b,this.tables.length||this.originIdOf(`layers`)===0?this.originIdOf(`tables`)===0?this._createSublayers(e,this.tables,e=>!e.geometryType):this._updateSublayers(e,this.tables):this.tables=new b,this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{let n=O(this.sublayerIdsCache,t,()=>new Set);e.members?.forEach(e=>{n.add(e.id)})})}async addRecords(e){await this.load(),await this._handleNewRecords(e)}async createSublayerForNamedType(t){await this.load();let n=this._graphTypeLookup.get(t);if(!n)throw new e(`knowledge-graph:missing-type`,`The specified type does not exist in the layer's graph data model.`);if(this.dataManager.sublayerCaches.has(t))throw new e(`knowledge-graph:duplicate-type`,`The specified type already exists as a sublayer.`);this.dataManager.sublayerCaches.set(t,new Map),O(this.sublayerIdsCache,t,()=>new Set);let r=this._addSublayer(n);return n.type===`entity`?this.dataManager.entityTypeNames.add(t):this.dataManager.relationshipTypeNames.add(t),this.dataManager.inclusionModeDefinition&&this.dataManager.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!0}),await j(this,[t]),this._refreshNamedTypes(),r}convertSublayerToDynamicData(t){if(!this.dataManager.inclusionModeDefinition)throw new e(`knowledge-graph:fully-dynamic-membership`,`This Knowledge Graph Layer already uses fully dynamic membership, individual sublayers cannot be converted`);if(!this._graphTypeLookup.get(t))throw new e(`knowledge-graph:missing-type`,`The specified type does not exist in the layer's graph data model.`);if(!this.dataManager.sublayerCaches.has(t))throw new e(`knowledge-graph:duplicate-type`,`The specified type does not exist as a sublayer.`);this.dataManager.inclusionModeDefinition.namedTypeDefinitions.get(t)?.useAllData?r.getLogger(this).warn(`This Knowledge Graph Layer already uses dynamic membership for the sublayer - no conversion was made`):(this.dataManager.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!0}),this.sublayerIdsCache.delete(t),this._refreshNamedTypes())}convertSublayerToExplicitMembership(t){if(!this.dataManager.inclusionModeDefinition)throw new e(`knowledge-graph:fully-dynamic-membership`,`This Knowledge Graph Layer already uses fully dynamic membership, individual sublayers cannot be converted`);if(!this._graphTypeLookup.get(t))throw new e(`knowledge-graph:missing-type`,`The specified type does not exist in the layer's graph data model.`);let n=this.dataManager.inclusionModeDefinition.namedTypeDefinitions.get(t);if(!n||n.useAllData){if(!this.dataManager.sublayerCaches.has(t))throw new e(`knowledge-graph:duplicate-type`,`The specified type does not exist as a sublayer.`);this.sublayerIdsCache.set(t,new Set),this.dataManager.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:new Map}),this._refreshNamedTypes()}else r.getLogger(this).warn(`This Knowledge Graph Layer already uses explicit membership for the sublayer - no conversion was made`)}convertToFullyDynamicData(){this.dataManager.inclusionModeDefinition||r.getLogger(this).warn(`This Knowledge Graph Layer already uses fully dynamic membership - no conversion was made`),this.sublayerIdsCache.clear(),this.dataManager.inclusionModeDefinition=null,this._refreshNamedTypes()}convertToExplicitMembership(){this.dataManager.inclusionModeDefinition&&this.dataManager.inclusionModeDefinition.namedTypeDefinitions.size>0&&r.getLogger(this).warn(`This Knowledge Graph Layer already uses explicit membership - no conversion was made`),this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map};for(let e of this.dataManager.sublayerCaches.keys())O(this.sublayerIdsCache,e,()=>new Set),this.dataManager.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:new Map});this._refreshNamedTypes()}async removeRecords(e){await this.load();let t=[];for(let n of e)!1===this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(n.typeName)?.useAllData&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(n.typeName)?.members?.has(n.id)&&t.push(n);this.dataManager.removeFromLayer(t);for(let e of t)this.sublayerIdsCache.get(e.typeName)?.delete(e.id);return this._refreshNamedTypes(),t}};S([n()],L.prototype,`dataManager`,void 0),S([n({json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],L.prototype,`definitionSetMap`,void 0),S([h(`definitionSetMap`)],L.prototype,`readDefinitionSetMap`,null),S([f(`definitionSetMap`)],L.prototype,`writeDefinitionSetMap`,null),S([n()],L.prototype,`inclusionModeDefinition`,null),S([n()],L.prototype,`knowledgeGraph`,void 0),S([n({type:b.ofType(N),json:{write:{ignoreOrigin:!0}}})],L.prototype,`layers`,void 0),S([n()],L.prototype,`memberEntityTypes`,void 0),S([n()],L.prototype,`memberRelationshipTypes`,void 0),S([n({type:[`KnowledgeGraphLayer`]})],L.prototype,`operationalLayerType`,void 0),S([n()],L.prototype,`sublayerCapabilities`,null),S([n()],L.prototype,`sublayerIdsCache`,void 0),S([n({type:b.ofType(N),json:{write:{ignoreOrigin:!0}}})],L.prototype,`tables`,void 0),S([n({json:{read:!1}})],L.prototype,`type`,void 0),S([n(c)],L.prototype,`url`,void 0),L=S([m(`esri.layers.KnowledgeGraphLayer`)],L);var R=L;async function z(e){let t=await F(e);return new Blob([t],{type:`application/x-protobuf`})}function B(e){let t=`definitionSetMap-${C()}.dat`,n=a(`knowledgeGraphLayer`,t);return e.resourceFromPath(n)}export{R as default};