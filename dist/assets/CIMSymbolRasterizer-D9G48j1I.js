import{Cv as e,jt as t,yv as n}from"./index-CzMixifc.js";import"./memoryEstimations-C3WUBUZI.js";import"./OptimizedGeometry-5fDazGe-.js";import"./colorUtils-Btp0B-0Y.js";import"./quantizationUtils-CzrQVcZ1.js";import"./GeometryUtils-C6BJBMi9.js";import"./labelPoint-D95l1mBc.js";import{c as r,t as i,u as a}from"./CIMSymbolHelper-CIzDgFQE.js";import{t as o}from"./CIMResourceManager-dPAzhonh.js";import{n as s,t as c}from"./rasterizingUtils-L-rXtdWe.js";import"./Rect-BMNJQxpm.js";import"./BoundingBox-CW0_Ka-z.js";import"./BidiEngine-CpIovbIK.js";import"./callExpressionWithFeature-jAwzgzDm.js";import{t as l}from"./OverrideHelper-Catw08-A.js";var u=96/72,d=class{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new o}get _canvas(){return this._imageDataCanvas||=document.createElement(`canvas`),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(r,a,o,c,u,d,f,m,h,g){if(!r)return null;let{data:_}=r;if(!_||_.type!==`CIMSymbolReference`||!_.symbol)return null;let{symbol:v}=_;d||=t(v);let y=await l.resolveSymbolOverrides(_,a,this._spatialReference,u,d,f,m),b=this._cimResourceManager,x=[];i.fetchResources(y,b,x),i.fetchFonts(y,b,x),x.length>0&&await Promise.all(x);let{width:S,height:C}=o,w=p(d,S,C,c,g),T=i.getEnvelope(y,w,b);if(!T)return null;T.x===1/0&&(T.x=S+2),T.y===1/0&&(T.y=-C/2),T.width===-1/0&&(T.width=S),T.height===-1/0&&(T.height=C);let E=1,D=0,O=0;switch(v.type){case`CIMPointSymbol`:case`CIMTextSymbol`:{let e=1;T.width>S&&(e=S/T.width);let t=1;T.height>C&&(t=C/T.height),c===`preview`&&(T.width<S&&(e=S/T.width),T.height<C&&(t=C/T.height)),E=Math.min(e,t),D=T.x+T.width/2,O=T.y+T.height/2}break;case`CIMLineSymbol`:if(g){O=T.y+T.height/2,D=T.x+T.width/2;let e=T.width-S,t=T.height-C;w={paths:s(w.paths,{xmin:-1*T.width/2+e,xmax:T.width/2-e,ymin:-1*T.height/2+t,ymax:T.height/2-t,width:T.width-2*e,height:T.height-2*t})}}else{(h||T.height>C)&&(E=C/T.height),O=T.y+T.height/2;let t=T.x*E+S/2,r=(T.x+T.width)*E+S/2,i=n(w)?w.paths:e(w)?w.rings:null;if(i===null)throw Error(`Bad geometry, can't rasterise symbol!`);i[0][0][0]-=t/E,i[0][2][0]-=(r-S)/E}break;case`CIMPolygonSymbol`:if(g){O=T.y+T.height/2,D=T.x+T.width/2;let e=T.width-S,t=T.height-C;w={paths:s(w.rings,{xmin:-1*T.width/2+e,xmax:T.width/2-e,ymin:-1*T.height/2+t,ymax:T.height/2-t,width:T.width-2*e,height:T.height-2*t})}}else{D=T.x+T.width/2,O=T.y+T.height/2;let e=T.x*E+S/2,t=(T.x+T.width)*E+S/2,n=T.y*E+C/2,r=(T.y+T.height)*E+C/2,{rings:i}=w;e<0&&(i[0][0][0]-=e,i[0][3][0]-=e,i[0][4][0]-=e),n<0&&(i[0][0][1]+=n,i[0][1][1]+=n,i[0][4][1]+=n),t>S&&(i[0][1][0]-=t-S,i[0][2][0]-=t-S),r>C&&(i[0][2][1]+=r-C,i[0][3][1]+=r-C)}}let k={type:`cim`,data:{type:`CIMSymbolReference`,symbol:y}};return this.rasterize(k,S,C,D,O,E,d,1,w)}rasterize(e,n,i,o,s,c,l,d=0,f=null,m=window.devicePixelRatio||1){let{data:h}=e;if(!h||h.type!==`CIMSymbolReference`||!h.symbol)return null;let{symbol:g}=h,_=this._canvas,v=m*u;_.width=n*v,_.height=i*v,l||=t(g),f||=p(l,n,i,`legend`),_.width+=2*d,_.height+=2*d;let y=_.getContext(`2d`,{willReadFrequently:!0}),b=r.createIdentity();return b.translate(-o,-s),b.scale(c*v,-c*v),b.translate(n*v/2+d,i*v/2+d),y.clearRect(0,0,_.width,_.height),new a(y,this._cimResourceManager,b,!0).drawSymbol(g,f),y.getImageData(0,0,_.width,_.height)}};function f(e,t,n,r){return t===`esriGeometryPolygon`?{rings:c(s(e.rings,{xmin:0,ymin:0,width:n,height:r}),-1*n/2,-1*r/2)}:t===`esriGeometryPolyline`?{paths:c(s(e.paths,{xmin:0,ymin:0,width:n,height:r}),-1*n/2,-1*r/2)}:null}function p(e,t,n,r,i){let a=-t/2+1,o=t/2-1,s=n/2-1,c=-n/2+1;if(i&&(e===`esriGeometryPolygon`||e===`esriGeometryPolyline`)){let r=f(i,e,t,n);if(r)return r}switch(e){case`esriGeometryPoint`:return{x:0,y:0};case`esriGeometryPolyline`:return{paths:[[[a,0,-4],[0,0,0],[o,0,2]]],hasM:!0};default:return r===`legend`?{rings:[[[a,s],[o,0],[o,c],[a,c],[a,s]]]}:{rings:[[[a,s],[o,s],[o,c],[a,c],[a,s]]]}}}export{d as CIMSymbolRasterizer};