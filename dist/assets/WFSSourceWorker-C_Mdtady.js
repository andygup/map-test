import{BT as e,B_ as t,En as n,LT as r,Qp as i,_S as a,dg as o,dw as s,eT as c,qw as l,uE as u}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./OptimizedFeatureSet-CTIqq8fn.js";import{a as d,s as f}from"./featureConversionUtils-_DSSMFQ2.js";import"./WhereClause-CO9FHcAq.js";import"./WhereClauseCache-Hc_hnaJ1.js";import"./PooledRBush-kIuSXR8J.js";import"./QueryEngineCapabilities-BJYIHckU.js";import"./generateRendererUtils-3fX8Itfa.js";import"./utils-DD8h9sO0.js";import"./BoundsStore-Cb3Fp4W3.js";import"./timeSupport-DTr00ezP.js";import"./optimizedFeatureQueryEngineAdapter-DdSTa-WE.js";import{t as p}from"./FeatureStore-BI832uP0.js";import{t as m}from"./QueryEngine-BmSuo7NQ.js";import{c as h,l as g}from"./queryUtils-DcyDFw5_.js";import"./quantizationUtils-CGy9nkLl.js";import"./utils-DhzlDVJ-.js";import"./utils-DfE5TL5h.js";import"./SnappingCandidate-CSwuQTV6.js";import"./FixedIntervalBinParameters-Dvwocz3j.js";import"./date-4JksS9rw.js";import{n as _,t as v}from"./geojson-CXDwHPSt.js";import{r as y}from"./sourceUtils-3L4uhiUn.js";import"./xmlUtils-CfkRQroA.js";import{a as b,n as x,o as S}from"./wfsUtils-CDHDekO-.js";var C=`esri.layers.WFSLayer`,w=class{constructor(){this._customParameters=null,this._queryEngine=null,this._supportsPagination=!0}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(t,r={}){let{getFeatureUrl:i,getFeatureOutputFormat:a,fields:o,geometryType:s,featureType:l,maxRecordCount:u,maxTotalRecordCount:d,maxPageCount:f,objectIdField:g,customParameters:_}=t,{spatialReference:v,getFeatureSpatialReference:y}=S(i,l,t.spatialReference);try{await h(y,v)}catch{throw new e(`unsupported-projection`,`Projection not supported`,{inSpatialReference:y,outSpatialReference:v})}c(r),this._customParameters=_,this._featureType=l,this._fieldsIndex=n.fromLayerJSON({fields:o,dateFieldsTimeReference:o.some(e=>e.type===`esriFieldTypeDate`)?{timeZoneIANA:`UTC`}:null}),this._geometryType=s,this._getFeatureUrl=i,this._getFeatureOutputFormat=a,this._getFeatureSpatialReference=y,this._maxRecordCount=u,this._maxTotalRecordCount=d,this._maxPageCount=f,this._objectIdField=g,this._spatialReference=v;let b=await this._snapshotFeatures(r);if(b.errors.length>0&&(this._supportsPagination=!1,b=await this._snapshotFeatures(r),b.errors.length>0))throw b.errors[0];let x={type:`object-id`,fieldName:g};return this._queryEngine=new m({fieldsIndex:this._fieldsIndex,geometryType:s,hasM:!1,hasZ:!1,featureIdInfo:x,spatialReference:v,timeInfo:null,featureStore:new p({geometryType:s,hasM:!1,hasZ:!1})}),this._queryEngine.featureStore.addMany(b.features),{warnings:D(b),extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async applyEdits(){throw new e(`wfs-source:editing-not-supported`,`applyEdits() is not supported on WFSLayer`)}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),(await this._queryEngine.executeQueryForIds(e,t.signal)).filter(i)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),await this._queryEngine.executeQueryForSnapping(e,t.signal)}async queryAttributeBins(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeAttributeBinsQuery(e,t.signal)}async refresh(e){return this._customParameters=e.customParameters,this._maxRecordCount=e.maxRecordCount,this._maxTotalRecordCount=e.maxTotalRecordCount,this._maxPageCount=e.maxPageCount,this._snapshotTask?.abort(),this._snapshotTask=o(e=>this._snapshotFeatures({signal:e})),this._snapshotTask.promise.then(e=>{this._queryEngine.featureStore.clear(),this._queryEngine.featureStore.addMany(e.features);for(let t of D(e))u.getLogger(C).warn(new r(`wfs-layer:refresh-warning`,t.message,t.details));e.errors?.length&&u.getLogger(C).warn(new r(`wfs-layer:refresh-error`,`Refresh completed with errors`,{errors:e.errors}))},()=>{this._queryEngine.featureStore.clear()}),await this._waitSnapshotComplete(),{extent:(await this._queryEngine.fetchRecomputedExtents()).fullExtent}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _snapshotFeatures(e){let t=e?.signal,n=this._maxTotalRecordCount,r=this._maxPageCount,i=this._supportsPagination&&r>1?await b(this._getFeatureUrl,this._featureType.typeName,{customParameters:this._customParameters,signal:t}):void 0,a=[],o=[];if(i==null)try{a=await this._singleQuery(t)}catch(e){l(e)||o.push(e)}else{let e=Math.min(i,n),c=T(this,s(Math.ceil(e/this._maxRecordCount),1,r),t);await Promise.allSettled(Array.from({length:10}).map(()=>E(c,a,o)))}return c(t),{features:a,totalRecordCount:i,maxTotalRecordCount:n,maxPageCount:r,errors:o}}async _singleQuery(e){let t=Number.isFinite(this._maxRecordCount)&&this._maxRecordCount>0?this._maxRecordCount:void 0,n=await x(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,count:t,signal:e});return this._processGeoJSON(n,{signal:e})}async _pageQuery(e,t){let n=e*this._maxRecordCount,r=await x(this._getFeatureUrl,this._featureType.typeName,this._getFeatureSpatialReference,this._getFeatureOutputFormat,{customParameters:this._customParameters,startIndex:n,count:this._maxRecordCount,signal:t});return this._processGeoJSON(r,{startIndex:n,signal:t})}_processGeoJSON(e,t){v(e,this._getFeatureSpatialReference.wkid);let{startIndex:n,signal:r}=t;c(r);let i=_(e,{geometryType:this._geometryType,hasZ:!1,objectIdField:this._objectIdField});if(!a(this._spatialReference,this._getFeatureSpatialReference))for(let e of i)e.geometry!=null&&(e.geometry=d(g(f(e.geometry,this._geometryType,!1,!1),this._getFeatureSpatialReference,this._spatialReference)));let o=n??1;for(let e of i){let t={};y(this._fieldsIndex,t,e.attributes,!0),e.attributes=t,t[this._objectIdField]??(e.objectId=t[this._objectIdField]=o++)}return i}};function*T(e,t,n){for(let r=0;r<t;r++)yield e._pageQuery(r,n)}async function E(e,t,n){let r=e.next();for(;!r.done;){try{let e=await r.value;t.push(...e)}catch(e){l(e)||n.push(e)}r=e.next()}}function D(e){let t=[];return e.totalRecordCount!=null&&(e.features.length<e.totalRecordCount&&t.push({name:`wfs-layer:maxRecordCount-too-low`,message:`Could only fetch ${e.features.length} of ${e.totalRecordCount} in ${e.maxPageCount} queries. Try increasing the value of WFSLayer.maxRecordCount.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount}}),e.totalRecordCount>e.maxTotalRecordCount&&t.push({name:`wfs-layer:large-dataset`,message:`The number of ${e.totalRecordCount} features exceeds the maximum allowed of ${e.maxTotalRecordCount}.`,details:{recordCount:e.features.length,totalRecordCount:e.totalRecordCount,maxTotalRecordCount:e.maxTotalRecordCount}})),t}export{w as default};