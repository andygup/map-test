const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/OverrideHelper-BMUKsh_Y.js","assets/colorUtils-DJOs5VE1.js","assets/index-CZ4oMP1N.js","assets/index-CDgdHpAj.css","assets/quantizationUtils-CGy9nkLl.js","assets/OverrideHelper-BhCM0ayL.js","assets/callExpressionWithFeature-D55aOczd.js","assets/CIMSymbolRasterizer-YjZ385DV.js","assets/BidiEngine-BrFXRv7y.js","assets/CIMSymbolHelper-l5sn5wJj.js","assets/rasterizingUtils-CKtfcOpu.js","assets/labelPoint-vGsL2GFc.js","assets/OptimizedGeometry-hOUTi-cB.js","assets/memoryEstimations-DQOvnrRz.js","assets/GeometryUtils-Dmca5Xm4.js","assets/Rect-BhUrWpQm.js","assets/BoundingBox-CLkiiRfJ.js","assets/CIMResourceManager-Aeqm523S.js","assets/callExpressionWithFeature-CPU76xdq.js","assets/LineMarker.glsl-BOARFmdl.js","assets/LineMarker.glsl-CXMKsfEf.js","assets/MarkerSizing.glsl-6EXRj3G4.js","assets/FloatsPassUniform-yzynPlDB.js","assets/NoParameters-D8vOu4I5.js","assets/Uniform-D2x0fAcR.js","assets/VisualVariables.glsl-DPoFF9eG.js","assets/AlphaCutoff-BxDXdpVQ.js","assets/HighlightReadBitmap.glsl-cy3SD0WQ.js","assets/glsl-CQsgM67j.js","assets/Texture2DBindUniform-DU-6Ejb6.js","assets/Float3PassUniform-tY0I44AO.js","assets/Float4PassUniform-BlgtXzb0.js","assets/ScreenSizePerspective.glsl-D8mo4yes.js","assets/View.glsl-DCHnRtrH.js","assets/Float3BindUniform-CTBiVhme.js","assets/Float3DrawUniform-CdNiRdHS.js","assets/FloatBindUniform-DmTbQwNg.js","assets/Matrix4BindUniform-DS27O9oA.js","assets/FloatPassUniform-DkGcNskm.js","assets/Slice.glsl-B4UNza77.js","assets/TerrainDepthTest.glsl-DLAwRTt4.js","assets/ReadDepth.glsl-CSPikWKN.js","assets/Float2BindUniform-C046qJa3.js","assets/Float4BindUniform-DsRDgU9t.js","assets/Texture2DPassUniform-DbQ0ICoe.js","assets/OutputColorHighlightOLID.glsl-BZElqToO.js","assets/Emissions.glsl-D75sJPX5.js","assets/Texture2DDrawUniform-_ATT3Du-.js","assets/ShaderBuilder-D3cV1oap.js","assets/videoUtils-Cwi_sthm.js","assets/ManagedTexture-MMKE_FPf.js","assets/image-D9NkN0IP.js","assets/Util-BF0TzZHY.js","assets/sdfPrimitives-BLSDVil_.js","assets/NativeLine.glsl-ClOJXnSr.js","assets/NativeLine.glsl-B06i-jJB.js","assets/Transform.glsl-LjRXb9GP.js","assets/VertexColor.glsl-DVDp3fwI.js","assets/Path.glsl-CoOMJhgQ.js","assets/Path.glsl-Bx31FzEF.js","assets/ReadShadowMap.glsl-Dwb5mPt6.js","assets/PiUtils.glsl-BTnoJadg.js","assets/ObjectAndLayerIdColor.glsl-xqs4IH1X.js","assets/SnowCover.glsl-C9VUzrAA.js","assets/SSAO.glsl-CieOBHuS.js","assets/ScreenSpacePass.glsl-DOjTinpP.js","assets/CameraSpace.glsl-6Z1q9G0l.js","assets/Float2PassUniform-DUjW63UW.js","assets/SSAOBlur.glsl-DEwR3tk9.js","assets/Float2DrawUniform-aR5RLpeA.js","assets/SceneLighting-DFVSfk4c.js","assets/sphere-9YfqUkuX.js","assets/vectorStacks-FfDNcZoS.js","assets/quatf64-BJJPhW0N.js","assets/vec3-zq4-AU_O.js","assets/plane-Bg1a5O73.js","assets/ray-CWXoVP-g.js","assets/ObjectStack-CBI5g-Qc.js","assets/projectPointToVector-HYpbaZqA.js","assets/projectVectorToVector-DX3Yd1qf.js","assets/dehydratedPoint-rdg1UAtQ.js","assets/frustum-Dz51AK3u.js","assets/lineSegment-BJ2rgalW.js","assets/orientedBoundingBox-CzNbshh-.js","assets/quat-BszBv_-H.js","assets/computeTranslationToOriginAndRotation-Cm78hfIp.js","assets/spatialReferenceEllipsoidUtils-B0E4spY0.js","assets/HUDIntersectorResult-CPKd33dL.js","assets/VertexAttributeLocations-CfzeuYMz.js","assets/VertexElementDescriptor-ju-1bdWe.js","assets/renderState-Be6uDhGv.js","assets/BooleanBindUniform-_2Zs0Oiv.js","assets/NormalUtils.glsl-tsz2eoyP.js","assets/Normals.glsl-C_GiWNRp.js","assets/Pattern.glsl-C4hxLCVk.js","assets/Pattern.glsl-Dn3MZTv0.js","assets/WaterSurface.glsl-CU4Ima_e.js","assets/WaterSurface.glsl-BrGEvZ-a.js","assets/weather--8ZTL_jU.js"])))=>i.map(i=>d[i]);
import{$ as e,Af as t,Al as n,Am as r,BS as i,BT as a,Bf as o,Bm as s,Bx as c,Cb as l,Cf as u,Cl as d,DT as f,Db as p,Df as m,ES as h,Eb as g,Ef as _,En as v,Ey as y,Fb as b,Fd as x,Ff as S,Fu as C,Gd as ee,Gg as te,Hl as ne,Id as re,If as ie,Il as ae,Ir as oe,Is as se,Iu as ce,Iw as le,Iy as ue,J as w,JE as de,Jd as fe,Jw as pe,Jx as me,Kw as he,Lu as ge,Mf as _e,Ml as T,Mu as ve,Nb as ye,Nf as be,Nl as E,Nm as xe,Nr as Se,Nu as D,OT as Ce,Ob as we,Og as Te,Ol as O,Om as Ee,PC as De,Pm as Oe,Pu as ke,Q as Ae,Qd as je,Qt as Me,Rf as k,Rm as Ne,SE as Pe,Sf as Fe,Tb as Ie,Tf as Le,Vb as Re,Vf as ze,Vl as Be,Vm as Ve,Wf as He,Wl as Ue,X as We,Xd as Ge,Y as Ke,Yg as qe,Z as Je,Zd as Ye,Zh as Xe,_S as Ze,_T as Qe,_b as $e,_w as et,aE as tt,af as nt,ah as rt,al as A,ax as it,bf as at,bm as ot,bs as st,c_ as j,cg as ct,cl as lt,db as ut,dg as dt,dl as M,dn as ft,dw as pt,eT as mt,et as ht,fT as gt,fw as _t,gD as N,gT as vt,gs as yt,hf as bt,i_ as xt,ig as P,iw as St,jl as Ct,jm as wt,ju as Tt,kf as Et,kl as Dt,kv as Ot,mE as kt,mf as At,mt as jt,nt as Mt,nw as Nt,oE as Pt,o_ as Ft,of as It,og as Lt,ot as Rt,ov as zt,pT as Bt,p_ as Vt,pl as Ht,qb as Ut,qd as Wt,qu as Gt,rS as Kt,r_ as qt,rf as Jt,rh as Yt,rl as F,sf as Xt,tx as Zt,uE as Qt,u_ as I,uf as L,ul as $t,ut as en,vT as tn,vl as nn,vs as rn,wf as an,xb as on,xl as sn,yb as cn,yl as R,yw as ln,zm as un,zw as dn,zy as fn}from"./index-CZ4oMP1N.js";import{r as pn}from"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./quatf64-BJJPhW0N.js";import"./quat-BszBv_-H.js";import"./axisAngleDegrees-B_kvpSNV.js";import"./meshCloneUtils-CCqUCHap.js";import{r as mn,t as hn}from"./MeshMaterialMetallicRoughness-Q-7oSOPc.js";import"./meshProperties-DH9aY28x.js";import{t as gn}from"./MeshComponent-CbjVLVfh.js";import"./MeshLocalVertexSpace-OEvelzSD.js";import{a as _n,i as vn}from"./meshVertexSpaceUtils-CsTvVRUI.js";import{t as yn}from"./earcut-BF1-mB58.js";import{a as bn,i as xn,n as Sn,r as Cn,t as wn}from"./Indices-BME9aaDP.js";import{D as Tn,a as En,b as Dn,g as On,m as kn,w as An,x as jn,y as Mn}from"./plane-Bg1a5O73.js";import"./vectorStacks-FfDNcZoS.js";import{n as Nn,r as Pn}from"./triangulationUtils-BlqOiLV7.js";import"./deduplicate-DAw_n_cX.js";import{n as Fn}from"./projectPointToVector-HYpbaZqA.js";import{t as In}from"./computeTranslationToOriginAndRotation-Cm78hfIp.js";import{G as Ln,j as Rn,u as zn}from"./BufferView-D7rgY_ku.js";import{a as Bn,i as Vn}from"./Util-BF0TzZHY.js";import{s as Hn}from"./vec3-DSOiDp9-.js";import"./vec4-utmnCg3f.js";import{a as Un,i as Wn,l as Gn,m as Kn,o as qn,p as Jn}from"./vertexSpaceConversion-Ca0tjp55.js";import"./spatialReferenceEllipsoidUtils-B0E4spY0.js";import{i as Yn}from"./resourceUtils-CaJfvVKq.js";import"./types-D4cna6kF.js";import"./indexUtils-q35bJYvF.js";import{t as Xn}from"./projectMeshVertexPositions-DD7Pub3p.js";import"./dehydratedPoint-rdg1UAtQ.js";import{t as Zn}from"./projectVectorToVector-DX3Yd1qf.js";import{n as Qn,r as $n,t as er}from"./symbolColorUtils-aHvrhrl1.js";import{i as z,r as tr}from"./orientedBoundingBox-CzNbshh-.js";import{_ as nr,d as rr,h as ir,i as ar,l as B,m as or,p as sr,u as cr}from"./Emissions.glsl-D75sJPX5.js";import"./glsl-CQsgM67j.js";import"./Uniform-D2x0fAcR.js";import"./Float3DrawUniform-CdNiRdHS.js";import"./Float3PassUniform-tY0I44AO.js";import"./FloatPassUniform-DkGcNskm.js";import"./Texture2DDrawUniform-_ATT3Du-.js";import"./Texture2DPassUniform-DbQ0ICoe.js";import"./NoParameters-D8vOu4I5.js";import{n as lr}from"./cimSymbolUtils-Q6FkyqJB.js";import{o as ur}from"./utils-Cuuurg5i.js";import{n as dr,t as fr}from"./SnappingCandidate-CSwuQTV6.js";import"./ObjectStack-CBI5g-Qc.js";import{r as pr}from"./ray-CWXoVP-g.js";import"./HUDIntersectorResult-CPKd33dL.js";import"./Intersector-CuU_DZjQ.js";import"./videoUtils-Cwi_sthm.js";import"./GeometryUtils-Dmca5Xm4.js";import{n as mr}from"./VertexAttributeLocations-CfzeuYMz.js";import"./VertexElementDescriptor-ju-1bdWe.js";import"./labelPoint-vGsL2GFc.js";import{E as hr,O as gr,t as _r}from"./CIMSymbolHelper-l5sn5wJj.js";import"./rasterizingUtils-CKtfcOpu.js";import"./Rect-BhUrWpQm.js";import"./BoundingBox-CLkiiRfJ.js";import"./BidiEngine-BrFXRv7y.js";import"./devEnvironmentUtils-Dd-UzSlS.js";import{r as vr,t as yr}from"./webStyleSymbolUtils-CccoPLb0.js";import"./vec3-zq4-AU_O.js";import{r as br}from"./sphere-9YfqUkuX.js";import{d as xr,n as Sr,o as Cr,s as wr}from"./lineSegment-BJ2rgalW.js";import"./triangle-_uWz9WdI.js";import"./hydratedFeatures-B670wkRA.js";import"./VertexArrayObject-DEfjd5y-.js";import"./BufferObject-q8zuTMny.js";import{t as Tr}from"./VertexBuffer-xVpphTb4.js";import"./vec3f32-B2H3-fiA.js";import"./ShaderBuilder-D3cV1oap.js";import{a as Er,i as Dr,l as Or,n as kr,r as Ar,u as jr}from"./renderState-Be6uDhGv.js";import"./image-D9NkN0IP.js";import"./frustum-Dz51AK3u.js";import{B as Mr,D as Nr,E as Pr,F as Fr,H as Ir,L as Lr,O as Rr,P as V,R as zr,S as Br,V as Vr,_ as Hr,c as Ur,d as Wr,f as Gr,i as Kr,k as qr,l as Jr,m as Yr,n as Xr,p as Zr,r as Qr,s as $r,t as ei,u as ti,x as ni,z as ri}from"./DefaultBufferWriter-BXwy9hB-.js";import{S as ii,_ as ai,a as oi,f as si,h as ci,l as li,o as ui,p as di,s as fi,u as pi,v as mi,x as hi}from"./ElevationContext-CNTqCoLi.js";import{a as gi,n as _i}from"./MaterialUtil-QJlc_rwl.js";import{t as vi}from"./Octree-XJBZsigF.js";import{a as yi,i as bi,p as xi,s as Si,u as Ci}from"./SceneLighting-DFVSfk4c.js";import"./ScreenSpacePass.glsl-DOjTinpP.js";import"./Float2BindUniform-C046qJa3.js";import"./ReadDepth.glsl-CSPikWKN.js";import{a as wi,n as Ti,r as Ei,s as Di}from"./FloatArray-DqATud34.js";import"./Float4BindUniform-DsRDgU9t.js";import"./CameraSpace.glsl-6Z1q9G0l.js";import"./Texture2DBindUniform-DU-6Ejb6.js";import"./Float2PassUniform-DUjW63UW.js";import"./Float3BindUniform-CTBiVhme.js";import"./Float4PassUniform-BlgtXzb0.js";import"./FloatBindUniform-DmTbQwNg.js";import"./Matrix4BindUniform-DS27O9oA.js";import"./Matrix4PassUniform-JGr7b2hu.js";import{_ as Oi,a as ki,c as Ai,d as ji,g as Mi,h as Ni,l as Pi,m as Fi,n as Ii,o as Li,p as Ri,r as zi,s as Bi,t as Vi,u as Hi,v as Ui,y as Wi}from"./DefaultLayouts-tuXT9snh.js";import{a as Gi,c as Ki,d as qi,f as Ji,i as Yi,l as Xi,o as Zi,s as Qi,u as $i}from"./FloatsPassUniform-yzynPlDB.js";import"./TextureOnly.glsl-9MXRi8S3.js";import"./HighlightCellGridScreenSpacePass.glsl-SS-SFvgQ.js";import"./IntegerPassUniform-Bc4jwiiu.js";import"./HighlightDownsample.glsl-C4UAj6v_.js";import"./HighlightReadBitmap.glsl-cy3SD0WQ.js";import"./Float2DrawUniform-aR5RLpeA.js";import"./HighlightApply.glsl-CvivNaSD.js";import"./HighlightBlur.glsl-BeYrwKnv.js";import"./HighlightToSingle.glsl-Bf1qRLQ8.js";import"./NestedMap-D5qGZL0n.js";import"./Slice.glsl-B4UNza77.js";import"./ObjectAndLayerIdColor.glsl-xqs4IH1X.js";import"./VisualVariables.glsl-DPoFF9eG.js";import{t as ea}from"./AlphaCutoff-BxDXdpVQ.js";import"./ScreenSizePerspective.glsl-D8mo4yes.js";import"./View.glsl-DCHnRtrH.js";import"./MarkerSizing.glsl-6EXRj3G4.js";import"./RibbonLine.glsl-Cen5G4Qg.js";import{r as ta,t as na}from"./ManagedTexture-MMKE_FPf.js";import{a as ra,i as ia,n as aa,o as oa,t as sa}from"./sdfPrimitives-BLSDVil_.js";import"./PiUtils.glsl-BTnoJadg.js";import"./TerrainDepthTest.glsl-DLAwRTt4.js";import"./OutputColorHighlightOLID.glsl-BZElqToO.js";import"./weather--8ZTL_jU.js";import"./OverlayCompositing.glsl-BzV-Npum.js";import{O as ca,_ as la,a as ua,c as da,h as fa,i as pa,k as ma,l as ha,n as ga,o as _a,r as va,s as ya}from"./graphicUtils-BW24Jhcf.js";import{t as ba}from"./VerticalOffset.glsl-CD0ss13J.js";import"./HUDVisibility.glsl-e56UpBL8.js";import"./BooleanBindUniform-_2Zs0Oiv.js";import"./HUDMaterial.glsl-BqTlEc9K.js";import"./Transform.glsl-LjRXb9GP.js";import"./VertexColor.glsl-DVDp3fwI.js";import"./ColorMaterial.glsl-Cdxxi9i2.js";import"./TextureBackedBufferLayout-CRYrdH8z.js";import{C as xa,E as Sa,O as Ca,S as wa,T as Ta,_ as Ea,a as Da,d as Oa,f as ka,g as Aa,h as ja,i as Ma,j as Na,k as Pa,l as Fa,m as Ia,n as La,o as Ra,p as za,r as Ba,s as Va,t as Ha,u as Ua,w as Wa}from"./pointUtils-Dz4Bisuv.js";import{a as Ga,i as Ka,n as qa,o as Ja,r as Ya,t as Xa}from"./primitiveObjectSymbolUtils-frpHRDK8.js";import"./MixExternalColor.glsl-G62irSUg.js";import{a as Za,i as Qa,n as $a,o as eo,s as to}from"./DefaultMaterial-BF2zOTJE.js";import{d as no,l as ro,u as io}from"./SnowCover.glsl-C9VUzrAA.js";import"./DefaultMaterial.glsl-B_7BDQY3.js";import"./ReadShadowMap.glsl-Dwb5mPt6.js";import"./SSAOBlur.glsl-DEwR3tk9.js";import"./SSAO.glsl-CieOBHuS.js";import"./Normals.glsl-C_GiWNRp.js";import"./RealisticTree.glsl-C3WDO8M8.js";import{i as ao,n as oo,r as so,t as co}from"./Normals-C9pyKGRR.js";import{a as lo,c as uo,i as fo,l as po,n as mo,o as ho,r as go,s as _o,t as vo}from"./placementUtils-Ra55xcJ3.js";import{n as yo}from"./LineMarker.glsl-CXMKsfEf.js";import{n as bo,r as xo}from"./objectResourceUtils-uAGJU6RV.js";import{n as So}from"./NativeLine.glsl-B06i-jJB.js";import{n as Co,r as wo}from"./Path.glsl-Bx31FzEF.js";import"./NormalUtils.glsl-tsz2eoyP.js";import{t as To}from"./Pattern.glsl-Dn3MZTv0.js";import{t as Eo}from"./WaterSurface.glsl-BrGEvZ-a.js";function Do(e,t,n){let r=(t.length>0?t[0]:e.length/3)-1,i=Pn(e,r,n);if(i!==2){e=e.slice();for(let t=0;t<e.length;t+=3)e[t+i]=e[t+2]}return yn(e,t,3)}function Oo(e){let t=[[`position`,new z(e.attributeData.position,e.indices,3,!0)]],n=Sn(e.indices.length);return e.attributeData.colorFeature==null?e.attributeData.color&&t.push([`color`,new z(e.attributeData.color,n,4,!0)]):t.push([`colorFeatureAttribute`,new z([e.attributeData.colorFeature],n,1,!0)]),e.attributeData.uvMapSpace&&t.push([`uvMapSpace`,new z(e.attributeData.uvMapSpace,e.indices,4,!0)]),e.attributeData.boundingRect&&t.push([`boundingRect`,new z(e.attributeData.boundingRect,e.indices,9,!0)]),new qr(e.material,t,e.mapPositions,0,e.attributeData.olidColor)}function ko(e,t=null){let n=[[`position`,new z(e.attributeData.position,e.indices,3,!0)],[`uv0`,new z(e.attributeData.uv0,e.indices,2,!0)]];return new qr(e.material,n,e.mapPositions,0,t)}function Ao(e){switch(e.type){case`extent`:if(e instanceof it)return Ot.fromExtent(e);break;case`polygon`:return e}return null}var jo=class{constructor(e,t,n){this.renderData=e,this.layerViewUid=t,this.graphicUid=n,this.outGeometries=[]}};function Mo(e,t,n,r){let i=Nn(e.rings,!!e.hasZ&&r.mode!==`on-the-ground`,1,e.spatialReference),a=be(i.position.length),o=li(i.position,e.spatialReference,0,a,0,i.position,0,i.position.length/3,t,n,r),s=o!=null;return new Vo(i.position,a,Fo(i.polygons,i.position,a),Po(i.outlines,i.position,a),s,o)}function No(e,t){let n=Nn(e.rings,!1,1),r=te(n.position,e.spatialReference,0,n.position,t,0);for(let e=2;e<n.position.length;e+=3)n.position[e]=-2;let i=Fo(n.polygons,n.position),a=Po(n.outlines,n.position);return new Bo(n.position,i,a,r)}function Po(e,t,n=null){return e.filter(({count:e})=>e>1).map(({index:e,count:r})=>{let i=3*e,a=3*r;return n==null?new Io(e,r,S(t,i,a)):new Lo(e,r,S(t,i,a),S(n,i,a))})}function Fo(e,t,n=null){let r=[];for(let{index:i,count:a,holeIndices:o,pathLengths:s}of e){if(a<=1)continue;let e=3*i,c=3*a,l=o.map(e=>e-i),u=n==null?new zo(i,a,S(t,3*i,3*a),l,s):new Ro(i,a,S(t,3*i,3*a),S(n,e,c),l,s);r.push(u)}return r}var Io=class{constructor(e,t,n){this.index=e,this.count=t,this.position=n}},Lo=class extends Io{constructor(e,t,n,r){super(e,t,n),this.mapPositions=r}},Ro=class extends Lo{constructor(e,t,n,r,i,a){super(e,t,n,r),this.holeIndices=i,this.pathLengths=a}},zo=class extends Io{constructor(e,t,n,r,i){super(e,t,n),this.holeIndices=r,this.pathLengths=i}},Bo=class{constructor(e,t,n,r){this.position=e,this.polygons=t,this.outlines=n,this.projectionSuccess=r}},Vo=class{constructor(e,t,n,r,i,a){this.position=e,this.mapPositions=t,this.polygons=n,this.outlines=r,this.projectionSuccess=i,this.sampledElevation=a}},Ho=[`polygon`,`extent`],Uo=class extends Va{constructor(e,t,n,r){super(e,t,n,r,ss(t)),this.ensureDrapedStatus(!1)}async doLoad(){let e=this.symbolLayer,t=e?.material,n=this.symbolLayer.material?.color?.a,r=this.needsDrivenTransparentPass||n!=null&&n!==1,i=t?.emissive,a=!this._hasDrivenColorOrOpacity&&(n==null||n===0),o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:qt,diffuse:qt,opacity:a?0:1,layerOpacity:this._getLayerOpacity(),drivenOpacity:r,hasSymbolColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:e.castShadows,emissiveStrengthFromSymbol:i?.strength??0,emissiveSource:1,offsetTransparentBackfaces:!0,normalType:1},s=new $a(o,this._context),c=new $a({...o,cullFace:2},this._context);this._materials[0]=s,this._materials[1]=c,this._updateTransparentDepedentMaterialParameters()}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,Ho,this.symbolLayer.type))return null;let n=this._getDrivenUInt8ColorWithNaNSupport(e.renderingInfo,this._materialColor,!1);er(n,n);let r=this.createElevationContextForGraphic(t);return this._createAs3DShape(t,e.renderingInfo,n,r,t.uid)}layerOpacityChanged(e,t){let n=this._getLayerOpacity();this._materials[0]?.setParameters({layerOpacity:n}),this._materials[1]?.setParameters({layerOpacity:n}),this._updateTransparentDepedentMaterialParameters(),e?.forEach(e=>t(e)?.layerOpacityChanged(n,this._context.isAsync))}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,pi)}slicePlaneEnabledChanged(e,t){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e?.forEach(e=>{t(e)?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){let e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[0]?.setParameters(e),this._materials[1]?.setParameters(e),!0}_getExtrusionSize(e){let t;return t=e.size&&this._drivenProperties.size?Na(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?0:1}async queryForSnapping(e,t,n,r){let i=this._getExtrusionSize(n)*this._context.renderCoordsHelper.unitInMeters/me(t),{objectId:a,target:o}=e,s=Pe(o);switch(s.z=(s.z??0)+i,e.type){case`edge`:{let{start:t,end:n}=e,r=Pe(t),o=Pe(n);return r.z=(r.z??0)+i,o.z=(o.z??0)+i,[new fr(a,s,1/0,r,o)]}case`vertex`:return[new dr(a,s,1/0),new fr(a,o,1/0,o,s)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,t,n,r,i){let a=Ao(e.geometry);if(a==null)return null;if(a.rings.length===0||!a.rings.some(e=>e.length>0))return this._logGeometryValidationWarnings(a.rings,`rings`,`ExtrudeSymbol3DLayer`),null;let o=Mo(a,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(o,a.rings,`rings`,`ExtrudeSymbol3DLayer`);let s=da(a);if(s==null)return null;let c=[],l=[],d=at(),f=k(),p=j(),m=this._context.renderCoordsHelper.viewingMode===1;m||this._context.renderCoordsHelper.worldUpAtPosition(null,p),In(a.spatialReference,[s.x,s.y,0],f,this._context.renderCoordsHelper.spatialReference);let h=k();xe(h,f);let g=y();ue(g,h);let{polygons:_,mapPositions:v,position:b}=o,x=new Map,S=this._materials[0];for(let e of _){let r=e.count;if(this._context.clippingExtent&&(u(e.mapPositions,d),!L(d,this._context.clippingExtent)))continue;let a=yn(e.mapPositions,e.holeIndices,3);if(a.length===0)continue;let o=a.length,s=6*r,g=xn(s+o),_=xn(o),y=be(3*s),C=be(3*s),ee=be(3*s),te=be(s);Go(b,v,a,e,y,ee,C,te,g,_,this._getExtrusionSize(t),p,m),Hn(y,y,h);let ne=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid}),re=new hs(y,ee,co(C),te),ie=Wo(S,g,g.length-_.length,re,n,ne),ae=r,oe=r,se=2*e.count,ce=new gs(ae,oe,se,o/3);os(ie,ce,f),x.set(ie,ce),c.push(ie,Wo(this._materials[1],_,0,re,n,ne)),l.push(re.heights)}if(c.length===0)return null;let C=new hi({geometries:c,layerViewUid:this._context.layerViewUid,graphicUid:i,isElevationSource:!0});C.transformation=f;let ee=Qn(this.symbolLayer,{opacity:this._getLayerOpacity()}),te=ee?new Oa(this._materials[0],ee,this._context.slicePlaneEnabled):null,ne=new Ua(this,C,null,(e,t,n,r,i)=>rs(e,t,n,r,i,l,x),r,te);return ne.alignedSampledElevation=o.sampledElevation,ne.needsElevationUpdates=pi(r.mode),ne}get _materialColor(){return this.symbolLayer.material?.color}_updateTransparentDepedentMaterialParameters(){let e=this._materials[0];e&&e.setParameters({cullFace:e.transparent?0:2})}};function Wo(e,t,n,r,i,a){let o=Sn(t.length),s=[[`position`,new z(r.positions,t,3,!0)],[`normalCompressed`,new z(r.normals,t,2,!0)],[`symbolColor`,new z(i,o,4,!0)]];return new qr(e,s,r.elevation,0,a,n)}function Go(e,t,n,r,i,a,o,s,c,l,u,d,f){let p=n.length/3,m=2*r.count;Ko(e,t,r.index,r.count,n,0,p,i,a,o,s,c,l,m,u,d,f);let h=0,g=2*r.count;m=0;let _=r.pathLengths[0];Yo(i,a,s,o,h,_,r.count,g,c,m,u),g+=4*_,m+=2*_,h+=_;for(let e=1;e<r.pathLengths.length;++e){let t=r.pathLengths[e];Yo(i,a,s,o,h,t,r.count,g,c,m,u),g+=4*t,m+=2*t,h+=t}}function Ko(e,t,n,r,i,a,o,s,c,l,u,d,f,p,m,h,g){T(U,h),c??=[],l??=[],u??=[];let _=m>0?1:-1,v=3*n,y=0,b=3*y,x=r,S=3*x;for(let n=0;n<r;++n){let n=e[v],r=e[v+1],i=e[v+2];g&&(U[0]=n,U[1]=r,U[2]=i,F(U,U)),s[b+0]=n,s[b+1]=r,s[b+2]=i;let a=t[v+0],o=t[v+1],d=t[v+2];c[b+0]=a,c[b+1]=o,c[b+2]=d,l[b+0]=-_*U[0],l[b+1]=-_*U[1],l[b+2]=-_*U[2],u[y]=0,s[S+0]=n+m*U[0],s[S+1]=r+m*U[1],s[S+2]=i+m*U[2],c[S+0]=a,c[S+1]=o,c[S+2]=d,u[x]=m,b+=3,S+=3,v+=3,y+=1,x+=1}v=3*a,b=0,S=3*p;let C=m<0?us:ls,ee=m<0?ls:us;for(let e=0;e<o;++e)f[b]=i[v+C[0]],f[b+1]=i[v+C[1]],f[b+2]=i[v+C[2]],d[S]=i[v+ee[0]]+r,d[S+1]=i[v+ee[1]]+r,d[S+2]=i[v+ee[2]]+r,b+=3,S+=3,v+=3}function qo(e,t,n,r,i,a,o){r[a]=r[o],o*=3,e[a*=3]=e[o],e[a+1]=e[o+1],e[a+2]=e[o+2],t[a]=t[o],t[a+1]=t[o+1],t[a+2]=t[o+2],n[a]=i[0],n[a+1]=i[1],n[a+2]=i[2]}var Jo=j();function Yo(e,t,n,r,i,a,o,s,c,l,u){t??=[],n??=[],r??=[];let d=i,f=i+1,p=i+o,m=i+o+1,h=s,g=s+1,_=s+2*a,v=s+2*a+1;u<0&&(d=i+o+1,m=i);let y=3*l;for(let s=0;s<a;++s)s===a-1&&(f=i,u>0?m=i+o:d=i+o),ts(e,d,f,p,Jo),qo(e,t,r,n,Jo,h,d),qo(e,t,r,n,Jo,g,f),qo(e,t,r,n,Jo,_,p),qo(e,t,r,n,Jo,v,m),c[y]=h,c[y+1]=_,c[y+2]=v,c[y+3]=h,c[y+4]=v,c[y+5]=g,y+=6,d++,f++,p++,m++,h+=2,g+=2,_+=2,v+=2}var Xo=j(),Zo=j(),Qo=j(),$o=j(),es=j();function ts(e,t,n,r,i){t*=3,n*=3,r*=3,O(Xo,e[t++],e[t++],e[t++]),O(Zo,e[n++],e[n++],e[n++]),O(Qo,e[r++],e[r++],e[r++]),R($o,Zo,Xo),R(es,Qo,Xo),nn(i,es,$o),F(i,i)}var ns=j();function rs(e,t,n,i,a,o,s){let c=e.stageObject,l=c.geometries,u=l.length,d=t.mode!==`absolute-height`,f=0,p=c.transformation,m=r(k(),p);for(let e=0;e<u;e+=2){let t=l[e];if(!Aa(t))continue;let r=t.getMutableAttribute(`position`).data,u=o[e/2],h=new ci(t.mapPositions),g=r.length/3,_=!1,v=0;{let e=0;for(let t=0;t<g;t++){ns[0]=r[e],ns[1]=r[e+1],ns[2]=r[e+2],i(h,cs),d&&(v+=cs.sampledElevation),Ji.TESTS_DISABLE_OPTIMIZATIONS?(O(H,h.array[h.offset],h.array[h.offset+1],cs.z+u[e/3]),n!=null&&a.toRenderCoords(H,n,H),A(H,H,m)):(O(H,r[e],r[e+1],r[e+2]),A(H,H,p),a.setAltitude(H,cs.z+u[e/3]),A(H,H,m)),r[e]=H[0],r[e+1]=H[1],r[e+2]=H[2];let t=ds/a.unitInMeters;(Math.abs(ns[0]-r[e])>=t||Math.abs(ns[1]-r[e+1])>=t||Math.abs(ns[2]-r[e+2])>=t)&&(_=!0),h.offset+=3,e+=3}}if(_){let n=s.get(t);n&&os(t,n,p),c.geometryVertexAttributeUpdated(l[e],`normalCompressed`),t.invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(l[e],`position`),l[e+1].invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(l[e+1],`position`)}f+=v/g}return f/u}function os(e,t,n){let r=e.getMutableAttribute(`position`),i=e.getMutableAttribute(`normalCompressed`).data,a=r.data,o=e.attributes.get(`position`).indices,{topVertexStart:s,topVertexCount:c,topFaceStart:l,topFaceCount:u}=t,d=l+u,f=s+c,p=fs,m=ps,h=ms,g=U,_=H;O(_,0,0,0);let v=(e,t)=>{let r=3*e;O(t,a[r+0],a[r+1],a[r+2]),A(t,t,n)};for(let e=l;e<d;++e){let t=3*e;v(o[t+0],p[0]),v(o[t+1],p[1]),v(o[t+2],p[2]),Ht(m,p[1],p[0]),Ht(h,p[2],p[0]),nn(g,m,h),E(_,_,g)}F(_,_);for(let e=s;e<f;++e){let t=_[0],n=_[1],r=_[2];oo(i,e,t,n,r)}}function ss(e){return(e.material?.color?.a??0)===1}var H=j(),U=j(),cs=new di,ls=[0,2,1],us=[0,1,2],ds=.01,fs=[j(),j(),j()],ps=j(),ms=j(),hs=class{constructor(e,t,n,r){this.positions=e,this.elevation=t,this.normals=n,this.heights=r}},gs=class{constructor(e,t,n,r){this.topVertexStart=e,this.topVertexCount=t,this.topFaceStart=n,this.topFaceCount=r}},_s=.42,vs=.32;function ys(e,t){if(e)switch(t){case`bright`:{let t=(e[0]+e[1]+e[2])/3;return[t*vs+(1-vs),t*vs+(1-vs),t*vs+(1-vs),e[3]*vs]}case`dark`:return[e[0]*_s,e[1]*_s,e[2]*_s,e[3]*_s]}}var bs=class{constructor(e,t,n,r){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=n,this._drapeSourceRenderer=r,this.type=`draped`,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e.stage}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}setVisibility(e){if(this.stage!=null&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,0);if(e||this._addedToStage){for(let e of this.renderGeometries)e.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,1)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,2),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=j()){return O(e,0,0,0)}getBoundingBoxObjectSpace(e=at()){return Et(e)}addObjectState(e){e.stateType===0&&(this.renderGeometries.forEach(t=>{let n=t.geometry.allocateIdAndHighlight(e.highlightName);e.addRenderGeometry(t,n,this)}),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,8))}removeObjectState(e){this.renderGeometries.forEach(t=>e.removeByObject(t))}updateHighlights(e){}removeRenderGeometryObjectState(e,t){t.channel===0&&(e.geometry.removeHighlight(t),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries([e],8))}computeAttachmentOrigin(e){for(let t of this.renderGeometries)t.geometry.computeAttachmentOrigin(Cs)&&(e.draped.origin[0]+=Cs[0],e.draped.origin[1]+=Cs[1],e.draped.num++)}async getProjectedBoundingBox(e,n,r,i,a){Et(a);for(let n=0;n<this.renderGeometries.length;n++){let i=this.renderGeometries[n];this._getRenderGeometryProjectedBoundingRect(i,e,xs,r),t(a,xs)}if(n){let e;Le(a,Cs);let t=pa(a,n.service.spatialReference,n);try{e=await n.service.queryElevation(Cs[0],Cs[1],i,t,`ground`)}catch{}e!=null&&(a[2]=Math.min(a[2],e),a[5]=Math.max(a[5],e))}return a}_getRenderGeometryProjectedBoundingRect(e,t,n,r){if(this.boundingBox)_(Ss,this.boundingBox);else{let{center:t,radius:n}=e.boundingSphere;Ss[0]=t[0]-n,Ss[1]=t[1]-n,Ss[2]=t[2]-n,Ss[3]=t[0]+n,Ss[4]=t[1]+n,Ss[5]=t[2]+n}return t(Ss,0,2),this.calculateRelativeScreenBounds&&r.push({location:Le(Ss),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),je(Ss,n)}},xs=Zt(),Ss=at(),Cs=j(),ws=I(0,0,1),Ts=16,Es=1.5,Ds=[128*ia,128*ia],Os=class t extends Va{static{this.PRIMITIVE_SIZE=Ds}getCachedSize(){return{size:this._getIconSize()}}static{this.elevationModeChangeTypes={definedChanged:1,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,n,r){super(e,t,n,r,Fs(t)),this._cimData=null,this._overrideHelperClass=null,this._arcadeInfo=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._textureHandle=null,this._patchTask=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}async doLoad(e){this._validateOrThrow();let t=this._prepareMaterialParameters(),n=this._getPrimitive();if(n!=null)this._prepareResourcesPrimitive(t,n);else{let n=ur(this.symbolLayer),r=js(n);r==null?await this._prepareResourcesHref(t,n,e):await this._prepareResourcesCIM(t,JSON.parse(r),e)}}_validateOrThrow(){if(this._drivenProperties.size)return;let e=_a(this._getIconSize());if(e)throw new a(`graphics3diconsymbollayer:invalid-size`,e)}_getIconSize(){let e=this.symbolLayer,t=Math.round(e.size==null?Ts:P(e.size));return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e,t){let n=this._overrideHelperClass,r=this._cimData;if(n&&r&&r.symbol||this.logger.error(`Can't create texture, CIM data is undefined`),r.primitiveOverrides){r=Pe(r);let i=r.primitiveOverrides;n.evaluateOverrides(i,e,this._arcadeInfo.geometryType,null,null,t.layer.fieldsIndex),n.applyOverrides(r.symbol,i)}let i=kt(JSON.stringify(r)),a=this._cimSymbolTextures.get(i);if(a)return a;let o=this._context.sharedResources.cimSymbolRasterizer,s=this._context.renderer&&this._context.renderer.type===`dictionary`?this._context.renderer.fieldMap:null;s&&n.applyDictionaryTextOverrides(r.symbol,e,s,null);let c=this._cimScaleFactorOrFunction==null?1:Me(this._cimScaleFactorOrFunction,e);c!==1&&r.symbol&&lr(r.symbol,c,!0);let l=_r.getEnvelope(r,null,o.resourceManager);if(l?.width&&l.height){let e=l.x+l.width/2,t=l.y+l.height/2,n=o.rasterize({type:`cim`,data:r},l.width,l.height,e,t,1,`esriGeometryPoint`,0,null,this._context.graphicsCoreOwner.view.state.rasterPixelRatio),i=new Wt({x:-l.x/l.width-.5,y:(l.height+l.y)/l.height-.5});this._cimMaterialParametersInfo.anchorPosition=Ms(`relative`,i),a=new na(n,{width:n?.width??1,height:n?.height??1,reloadable:!0})}else a=new na(new ImageData(1,1),{width:1,height:1,reloadable:!0});return this._cimSymbolTextures.set(i,a),this._context.stage.addTexture(a),a}_prepareMaterialParameters(){let e={anchorPosition:Ms(this.symbolLayer.anchor,this.symbolLayer.anchorPosition),rotation:this.symbolLayer.angle},t=this.symbol;ks(t)&&(e.verticalOffset=new ba(t.verticalOffset)),this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this.view.screenSizePerspective.parameters),(e.rotation!==0||this._drivenProperties.rotation)&&(e.hasRotation=!0);let n=this.symbolLayer.occludedVisibility?.mode??`hidden`,r=this.view.basemapTerrain;return e.useVisibilityPixel=!r.opaque&&!r.invisible&&n===`hidden`,e.occludedVisibilityMode=this.symbolLayer.occludedVisibility?.mode??`hidden`,e.occludedFragmentFade=!1,e.horizonCullingEnabled=this._context.spherical,e.hasSlicePlane=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){let n=this._getOutlineSize();if(As(t)&&n===0)throw Error(`Nothing to render`);if(this._outlineSize=n,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,this._context.sharedResources.textures!=null){let n=this._context.sharedResources.textures.fromData(`${t}-icon`,()=>aa(t));this._textureHandle=n,e.textureId=n.managedTexture.id}e.textureIsSignedDistanceField=!0,e.sampleSignedDistanceFieldTexelCenter=ra(t),e.distanceFieldBoundingBox=oa;let r=this._getIconSize();this._size=[r,r],this._symbolTextureRatio=1/ia,this._createMaterial(e)}async _prepareResourcesHref(e,t,n){this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;let r=this._getIconSize(),i=r*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(this._context.sharedResources.textures!=null){let o=await ct(this._context.sharedResources.textures.fromUrl(t,i,{signal:n}));if(!1===o.ok)throw pe(o.error),new a(`graphics3diconsymbollayer:request-failed`,`Failed to load (Request for icon resource failed: ${t})`);this._textureHandle=o.value;let s=o.value.managedTexture;this._size=Ns(s,r),e.textureId=s.id}this._createMaterial(e)}async _prepareResourcesCIM(e,t,n){let{OverrideHelper:r}=await i(async()=>{let{OverrideHelper:e}=await import(`./OverrideHelper-BMUKsh_Y.js`);return{OverrideHelper:e}},__vite__mapDeps([0,1,2,3,4,5,6]));if(this._overrideHelperClass=r,this._cimData=t,!this._context.sharedResources.cimSymbolRasterizer){let e=(await i(async()=>{let{CIMSymbolRasterizer:e}=await import(`./CIMSymbolRasterizer-YjZ385DV.js`);return{CIMSymbolRasterizer:e}},__vite__mapDeps([7,2,3,8,9,10,11,12,13,14,15,16,1,4,17,5,6]))).CIMSymbolRasterizer;mt(n),this._context.sharedResources.cimSymbolRasterizer??=new e(this._context.renderCoordsHelper.spatialReference)}let a=this._context.sharedResources.cimSymbolRasterizer,o=[],s=t,c=s?.symbol;_r.fetchResources(c,a.resourceManager,o,n),_r.fetchFonts(c,a.resourceManager,o);let l=this._context.layer.fields?this._context.layer.fields.map(e=>e.toJSON()):[];if(this._arcadeInfo={spatialReference:this._context.renderCoordsHelper.spatialReference,fields:l,geometryType:`esriGeometryPoint`},s?.primitiveOverrides&&o.push(r.createRenderExpressions(s.primitiveOverrides,this._arcadeInfo)),o.length>0&&(await Promise.all(o),mt(n)),this._context.renderer&&this._context.renderer.type===`dictionary`&&this._context.renderer.scaleExpression){let e=this._context.renderer;if(e.scaleExpression){let t=e.scaleExpression,n=await ft(t,this._context.layer.spatialReference),{default:r}=await i(async()=>{let{default:e}=await import(`./callExpressionWithFeature-CPU76xdq.js`);return{default:e}},__vite__mapDeps([18,4,6,2,3])),a=new v(l);this._cimScaleFactorOrFunction=(e,t,i)=>{let o=r(n,e,{$view:i},`esriGeometryPoint`,a,t);return o===null?1:o}}}mt(n),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return Ps(this.symbolLayer)}_getOutlineSize(){let e=0,t=this.symbolLayer;return t.outline?.size==null?(e=As(this._getPrimitive())?Es:0,Math.max(e,0)):Math.max(P(t.outline.size),0)}_getOutlineColor(){let e=this._getLayerOpacity(),t=this.symbolLayer,n=t?.outline?.color;if(n!=null){let t=n.toUnitRGB(),r=n.a*e;return[t[0],t[1],t[2],r]}return[0,0,0,0]}_getFillColor(){if(As(this._getPrimitive()))return Ca;let e=this._getPrimitive()==null,t=this._materialColor;return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}get _materialColor(){return this.symbolLayer.material?.color}get _fastVisualVariableFallbackColor(){let t=this._materialColor;return t==null?this._getPrimitive()==null?e:w:t.toUnitRGBA()}_getFallbackSize(){let e=this._getIconSize(),{symbolLayer:{size:t}}=this;return(t==null?Ts:Math.round(P(t)))/e}_createMaterial(e){let t=this._context.spherical;if(this._cimData){this._fastUpdates=null;let n=e.textureId?this._cimSymbolMaterials.get(e.textureId):null;return n||(n=new ha(e,t),this._cimSymbolMaterials.set(e.textureId??0,n)),n}this._fastUpdates=Zi(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates&&(e={...e,...this._fastUpdates.materialParameters}),this._materials[0]=new ha(e,t),e.isFocused=!1;let n=this.view.map?.focusAreas.style;return e.color=ys(e.color,n),e.outlineColor=ys(e.outlineColor,n),this._materials[1]=new ha(e,t),this._materials[0]}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,useVisibilityPixel:!1,hasSlicePlane:!1,shaderPolygonOffset:0,draped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._patchTask=gt(this._patchTask),this._materials.length=0,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(e=>this._context.stage.removeTexture(e)),this._cimSymbolTextures.clear(),this._textureHandle=Qe(this._textureHandle)}_getScaleFactor({size:e},t){if(!this._drivenProperties.size)return 1;if(e==null)return this._getFallbackSize();let[n,r,i]=e;return n===`symbol-value`?1:typeof n==`number`&&isFinite(n)?P(n)/t:typeof i==`number`&&isFinite(i)?P(i)/t:1}_getDrivenRotation(e){return this._drivenProperties.rotation?e.heading??0:0}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let n=Ha(t.geometry);if(n==null)return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;let r,i=[0,0],a=this.view.focusAreasView?.containsGeometry(n)??!0;if(this._cimData){if(!this._cimData.symbol)return null;let n=this._generateTextureCIM(t,e),o={textureId:n.id,isFocused:a,...this._cimMaterialParametersInfo};r=this._createMaterial(o);let s=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;i=[n.parameters.width/s,n.parameters.height/s]}else i=this._size,r=a?this._materials[0]:this._materials[1];if(n==null)return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;let o=e.renderingInfo,s=this._getDrivenUInt8Color(o,this._materialColor,this._getPrimitive()==null),c=this._getDrivenRotation(o),l=1;if(!this._fastUpdates?.visualVariables.size){let e=i[0]>i[1]?i[0]:i[1];l=this._getScaleFactor(o,e)}l*=this._symbolTextureRatio;let u=C(i[0]*l,i[1]*l),d=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus(d.mode===`on-the-ground`)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,n,r,s,c,u):this._createAs3DShape(t,n,r,s,c,u,d,t.uid)}terrainTransparencyChanged(){return this.draped}layerOpacityChanged(){let e=this._getFillColor(),t=this._getOutlineColor();this._forEachMaterial(n=>{n.setParameters({color:e}),n.setParameters({outlineColor:t})})}layerScreenSizePerspectiveChanged(){let e=this._context.screenSizePerspectiveEnabled&&!this.draped?this.view.screenSizePerspective.parameters:null;this._forEachMaterial(t=>{t.setParameters({screenSizePerspective:e})})}updateGeometry(e,t){let n=e.geometry;if(this.draped||!n||!this._validateGeometry(n))return!1;let{elevationContext:r,stageObject:i}=t;if(r.mode!==this.getGeometryElevationMode(n))return!1;let a=Ha(n);if(!a)return!1;r.updateFeatureExpressionFeature(e,this._context.layer);let o=Da(i,this._context,a,r);if(o==null)return!1;let s=Ba(this._context,a);return i.geometries[0].localOrigin===s&&(t.alignedSampledElevation=o,La(t,a,this._context.elevationProvider),!0)}layerElevationInfoChanged(e,n,r){let i=this._elevationContext.mode,a=fi(t.elevationModeChangeTypes,r,i);if(a!==1)return a;let o=ui(i)||i===`absolute-height`;return this.updateGraphics3DGraphicElevationInfo(e,n,()=>o)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return this._getPrimitive()!=null}applyRendererDiff(e,t){for(let n in e.diff){if(n!==`visualVariables`||!Qi(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return 0;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return 2}get needsUpdateFocus(){return!0}prepareSymbolLayerPatch(e){if(this._patchTask?.abort(),e.diff.type!==`partial`)return;let t=e.diff.diff;this._preparePatchResource(e,t),this._preparePatchRotation(e,t)}_preparePatchResource(e,t){if(!t.resource||t.resource.type!==`partial`)return;let n=t.resource.diff;if(n?.href?.type!==`complete`)return;let r=n.href.newValue,{textures:i}=this._context.sharedResources;if(r==null||i==null||js(r)!=null)return;let o=this._getIconSize(),s=o*this._context.graphicsCoreOwner.view.state.pixelRatio;e.symbolLayerStatePatches.push(()=>{this._patchTask=gt(this._patchTask),this._patchTask=dt(e=>this._context.schedule(async(e,t)=>{let n=await ct(i.fromUrl(r,s,{signal:t}));mt(t);let c=!n.ok;if(c&&pe(n.error),this._textureHandle=Qe(this._textureHandle),this._patchTask=null,c){this._forEachMaterial(e=>{e.visible=!1,e.setParameters({textureId:null})});let e=`Failed to load (Request for icon resource failed: ${r})`;this.logger.error(new a(`graphics3diconsymbollayer:request-failed`,e));return}this._textureHandle=n.value;let l=n.value.managedTexture;this._size=Ns(l,o),this._forEachMaterial(e=>{e.setParameters({textureId:l.id}),e.visible=!0})},e))}),delete n.href}_preparePatchRotation(e,t){if(!t.angle||t.angle.type!==`complete`)return;let n=t.angle.newValue??0,r=n!==0||this._drivenProperties.rotation;e.symbolLayerStatePatches.push(()=>{this._forEachMaterial(e=>e.setParameters({rotation:n,hasRotation:r}))}),delete t.angle}_defaultElevationInfoNoZ(){return Is}_createAs3DShape(e,t,n,r,i,a,o,s){let c=this.getFastUpdateAttrValues(e),l=this._context.layerViewUid,u=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerViewUid:l}),d=fa(n,{normal:ws,color:r,rotation:i,size:a,centerOffsetAndDistance:Ls,featureAttribute:c,olidColor:u}),f=Ma(this._context,t,d,o,s);if(f==null)return null;let p=new Ua(this,f.object,null,ja,o);return p.hiddenIfDeconflicted=!0,p.alignedSampledElevation=f.sampledElevation,p.needsElevationUpdates=ui(o.mode)||o.mode===`absolute-height`,p.getScreenSize=this._createScreenSizeGetter(a,c),p.calculateRelativeScreenBounds=e=>n.calculateRelativeScreenBounds(p.getScreenSize(),1,e),La(p,t,this._context.elevationProvider),p}_createAsOverlay(e,t,n,r,i,a){n.renderPriority=this._renderPriority;let o=j();Fn(t,o,this._context.overlaySR),o[2]=-2;let s=this._context.clippingExtent;if(s!=null&&!At(s,o))return null;let c=this.getFastUpdateAttrValues(e),l=e.uid,u=this._context.layerViewUid,d=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:l,layerViewUid:u}),f=fa(n,{normal:ws,position:o,color:r,rotation:i,size:a,featureAttribute:c,olidColor:d}),p=new Mi(f,{layerViewUid:u,graphicUid:l}),m=new bs(this,[p],null,this._context.drapeSourceRenderer);return m.getScreenSize=this._createScreenSizeGetter(a,c),m.calculateRelativeScreenBounds=e=>n.calculateRelativeScreenBounds(m.getScreenSize(),1,e),m}_createScreenSizeGetter(e,t){let n=this._outlineSize+2;if(this._fastUpdates&&t){let r=e[0]/this._symbolTextureRatio,i=e[1]/this._symbolTextureRatio;return(e=D())=>{let[a,o]=$i(Rs,this._fastUpdates.materialParameters,t);return e[0]=a*r+n,e[1]=o*i+n,e}}let r=e[0]/this._symbolTextureRatio+n,i=e[1]/this._symbolTextureRatio+n;return(e=D())=>(e[0]=r,e[1]=i,e)}_fastVisualVariableConvertOptions(){let e=Math.max(this._size[0],this._size[1]),t=I(e,e,e),n=Xe(1),r=e*n,i=I(r,r,r),a=this._getFallbackSize();return new Gi({supports:{size:!0,color:!0,rotation:!0,opacity:!1},modelSize:t,symbolSize:i,unitInMeters:n,fallbackColor:this._fastVisualVariableFallbackColor,fallbackSize:I(a,a,a)})}_forEachMaterial(e){this._materials.forEach(e),this._cimSymbolMaterials.forEach(e)}test(){return{...super.test(),material:this._materials[0]}}};function ks(e){return e&&e.type===`point-3d`&&e.hasVisibleVerticalOffset()}function As(e){return e!=null&&(e===`cross`||e===`x`)}function js(e){let t=De(e);return t?.mediaType===`application/json`?t.data:void 0}function Ms(e,t){return e===`relative`?C((t.x||0)+.5,.5-(t.y||0)):e in vo?vo[e]:vo.center}function Ns({parameters:e},t){let n=(e.width??1)/(e.height??1);return n>1?[t,Math.round(t/n)]:[Math.round(t*n),t]}function Ps(e){return e.resource?.href?null:e.resource?.primitive??`circle`}function Fs(e){return(e.material?.color?.a??0)===1&&Ps(e)!=null}var Is={mode:`relative-to-ground`,offset:0},Ls=Ae(0,0,0,1),Rs=j();function zs(e){switch(e){case`butt`:return 0;case`square`:return 1;case`round`:return 2;default:return null}}function Bs(e){return e===`diamond`?`kite`:e}var Vs=class extends yi{constructor(e,t){super(e,t,Di(Hs(t))),this.shader=new Si(yo,()=>i(()=>import(`./LineMarker.glsl-BOARFmdl.js`),__vite__mapDeps([19,20,21,2,3,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53])))}_makePipelineState(e,t){let{output:n,hasEmission:r,oitPass:i,space:a,hasOccludees:o}=e;return kr({blending:B(n)?zr(i):null,depthTest:a===0?null:Fr(i),depthWrite:Mr(e),drawBuffers:bi(n,Vr(i,r)),colorWrite:Er,stencilWrite:o?ti:null,stencilTest:o?t?Zr:Ur:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(e){return e.occluder?(this._occluderPipelineTransparent=kr({blending:jr,depthTest:Gr,depthWrite:null,colorWrite:Er,stencilWrite:null,stencilTest:Jr}),this._occluderPipelineOpaque=kr({blending:jr,depthTest:Gr,depthWrite:null,colorWrite:Er,stencilWrite:Wr,stencilTest:Yr}),this._occluderPipelineMaskWrite=kr({blending:null,depthTest:$r,depthWrite:null,colorWrite:null,stencilWrite:ti,stencilTest:Zr})):this._occluderPipelineTransparent=this._occluderPipelineOpaque=this._occluderPipelineMaskWrite=null,this._occludeePipelineState=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){return t?this._occludeePipelineState:e.occluder===12?this._occluderPipelineTransparent??super.getPipeline(e):e.occluder===11?this._occluderPipelineOpaque??super.getPipeline(e):this._occluderPipelineMaskWrite??super.getPipeline(e)}};function Hs(e){let t=wi().vec3f(`position`).vec4f16(`previousDelta`).vec2f16(`uv0`);return e.hasVVColor?t.f32(`colorFeatureAttribute`):t.vec4u8(`color`,{glNormalized:!0}),e.hasVVOpacity&&t.f32(`opacityFeatureAttribute`),e.hasVVSize?t.f32(`sizeFeatureAttribute`):t.f16(`size`),e.worldSpace&&t.vec3f16(`normal`),t.freeze()}Vs=N([Ce(`esri.views.3d.webgl-engine.shaders.LineMarkerTechnique`)],Vs);var W=class extends Rr{constructor(e){super(),this.spherical=e,this.space=1,this.anchor=0,this.occluder=!1,this.writeDepth=!1,this.hideOnShortSegments=!1,this.hasCap=!1,this.hasTip=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasScreenSizePerspective=!1,this.textureCoordinateType=0,this.emissionSource=0,this.discardInvisibleFragments=!0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasSliceTranslatedView=!0,this.olidColorInstanced=!1,this.overlayEnabled=!1,this.snowCover=!1}get draped(){return this.space===0}get worldSpace(){return this.space===2}};N([V({count:3})],W.prototype,`space`,void 0),N([V({count:2})],W.prototype,`anchor`,void 0),N([V()],W.prototype,`occluder`,void 0),N([V()],W.prototype,`writeDepth`,void 0),N([V()],W.prototype,`hideOnShortSegments`,void 0),N([V()],W.prototype,`hasCap`,void 0),N([V()],W.prototype,`hasTip`,void 0),N([V()],W.prototype,`hasVVSize`,void 0),N([V()],W.prototype,`hasVVColor`,void 0),N([V()],W.prototype,`hasVVOpacity`,void 0),N([V()],W.prototype,`hasOccludees`,void 0),N([V()],W.prototype,`terrainDepthTest`,void 0),N([V()],W.prototype,`cullAboveTerrain`,void 0),N([V()],W.prototype,`hasScreenSizePerspective`,void 0);var Us=class extends Pr{constructor(e,t){super(e,Gs),this.produces=new Map([[2,e=>e===8||B(e)&&this.parameters.renderOccluded===8],[3,e=>nr(e)],[11,e=>sr(e)&&this.parameters.renderOccluded===8],[12,e=>sr(e)&&this.parameters.renderOccluded===8],[4,e=>B(e)&&this.parameters.writeDepth],[9,e=>B(e)&&!this.parameters.writeDepth],[19,e=>B(e)||e===8]]),this.intersectDraped=void 0,this._configuration=new W(t)}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.space=t.slot===19?0:this.parameters.worldSpace?2:1,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==0,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=t.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.occluder=this.parameters.renderOccluded===8,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest&&B(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration}get visible(){return this.parameters.color[3]>=ea}intersect(){}createBufferWriter(){return new Ks(Hs(this.parameters),this.parameters)}createGLMaterial(e){return new Ws(e)}},Ws=class extends ar{dispose(){super.dispose(),this._markerTextures?.release(this._markerPrimitive),this._markerPrimitive=null}beginSlot(e){let t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextures.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this.getTechnique(Vs,e)}},Gs=class extends Yi{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive=`arrow`,this.placement=`end`,this.cap=0,this.anchor=0,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.stipplePattern=null,this.markerTexture=null}},Ks=class{constructor(e,t){this.layout=e,this._parameters=t}elementCount(){return this._parameters.placement===`begin-end`?12:6}write(e,t,n,r,i,a){let o=n.get(`position`).data,s=o.length/3,c=[1,0,0],l=n.get(`normal`);this._parameters.worldSpace&&l!=null&&(c=l.data);let u=1,d=0;this._parameters.vvSize?d=n.get(`sizeFeatureAttribute`).data[0]:n.has(`size`)&&(u=n.get(`size`).data[0]);let f=[1,1,1,1],p=0;this._parameters.vvColor?p=n.get(`colorFeatureAttribute`).data[0]:n.has(`color`)&&(f=n.get(`color`).data);let m=0;this._parameters.vvOpacity&&(m=n.get(`opacityFeatureAttribute`).data[0]);let h=new Float32Array(i.buffer),g=Ln(i.buffer),_=new Uint8Array(i.buffer),v=a*(this.layout.stride/4),y=h.BYTES_PER_ELEMENT/g.BYTES_PER_ELEMENT,b=4/y,x=(e,t,n,r)=>{h[v++]=e[0],h[v++]=e[1],h[v++]=e[2],Br(t,e,g,v*y),v+=b;let i=v*y;if(g[i++]=n[0],g[i++]=n[1],v=Math.ceil(i/y),this._parameters.vvColor)h[v++]=p;else{let e=Math.min(4*r,f.length-4),t=4*v++;_[t]=255*f[e],_[t+1]=255*f[e+1],_[t+2]=255*f[e+2],_[t+3]=255*f[e+3]}this._parameters.vvOpacity&&(h[v++]=m),i=v*y,this._parameters.vvSize?(h[v++]=d,i+=2):g[i++]=u,this._parameters.worldSpace&&(g[i++]=c[0],g[i++]=c[1],g[i++]=c[2]),v=Math.ceil(i/y)},S=(t,n)=>{let r=O(qs,o[3*t],o[3*t+1],o[3*t+2]),i=Js,a=t+n;do O(i,o[3*a],o[3*a+1],o[3*a+2]),a+=n;while(lt(r,i)&&a>=0&&a<s);e&&(A(r,r,e),A(i,i,e)),x(r,i,[-1,-1],t),x(r,i,[1,-1],t),x(r,i,[1,1],t),x(r,i,[-1,-1],t),x(r,i,[1,1],t),x(r,i,[-1,1],t)},C=this._parameters.placement;return C!==`begin`&&C!==`begin-end`||S(0,1),C!==`end`&&C!==`begin-end`||S(s-1,-1),null}},qs=j(),Js=j(),Ys=[`polyline`,`polygon`,`extent`],Xs=class e extends Va{static{this.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,n,r){super(e,t,n,r,$s(t))}async doLoad(){if(this._fastUpdates=Zi(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastMarkerUpdates=Zi(this._context.renderer,this._fastVisualVariableConvertOptions(!0)),!this._drivenProperties.size&&(this.symbolLayer.size==null?Xe(1):this.symbolLayer.size)<0)throw new a(`graphics3dlinesymbollayer:invalid-size`,`Symbol sizes may not be negative values`)}_getMaterialParameters(e,t){let n=this._screenSizePerspective,r={...this._getMaterialColorParameters(t),width:this._computeMaterialWidth(this.symbolLayer?.size),hasPolygonOffset:!0,join:this.symbolLayer.join||`miter`,cap:zs(this.symbolLayer.cap||`butt`),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:Ri(this.symbolLayer.pattern),emissiveStrength:this._emissiveStrength??0,screenSizePerspective:n};return t===4&&this._fastMarkerUpdates?.visualVariables?{...r,...this._fastMarkerUpdates.materialParameters}:this._fastUpdates?.visualVariables?{...r,...this._fastUpdates.materialParameters}:r}_getMaterialColorParameters(e){let t=e===4,n=this._getCombinedOpacityAndColor(t&&this._markerColor||this._materialColor);return this._patternHidesLine&&!t&&(n[3]=0),{color:n}}get _materialColor(){return this.symbolLayer.material?.color}get _emissiveStrength(){return this.symbolLayer.material?.emissive?.strength}get _markerColor(){return this.symbolLayer.marker?.color}get _lineMaterial(){return this._materials[0]??(this._materials[0]=new ai(this._getMaterialParameters(!1,0),this.view.state.isGlobal)),this._materials[0]}get _ringMaterial(){return this._materials[1]??(this._materials[1]=new ai(this._getMaterialParameters(!0,1),this.view.state.isGlobal)),this._materials[1]}get _wireframeLineMaterial(){return this._materials[2]??(this._materials[2]=new ai({...this._getMaterialParameters(!1,2),wireframe:!0},this.view.state.isGlobal)),this._materials[2]}get _wireframeRingMaterial(){return this._materials[3]??(this._materials[3]=new ai({...this._getMaterialParameters(!0,3),wireframe:!0},this.view.state.isGlobal)),this._materials[3]}get _markerMaterial(){return this._materials[4]==null&&this.symbolLayer.marker!=null&&(this._materials[4]=new Us({...this._getMaterialParameters(!1,4),placement:this.symbolLayer.marker.placement,markerPrimitive:Bs(this.symbolLayer.marker.style)},this.view.state.isGlobal)),this._materials[4]}_getDrivenSize(e){if(this._drivenProperties.size){let t=e.size;return t==null?this._getFallbackSize():P(Pa(t))}return 1}_getDrivenColor({color:e,opacity:t}){let n=We();return this._drivenProperties.color&&(Rt(n,e??this._getFallbackOpacityAndColor(w)),t==null)||this._drivenProperties.opacity&&(e||this._materialColor)&&(n[3]=t??this._getFallbackOpacity()),n}_getDrivenMarkerColor({color:e,opacity:t}){let n=We();return this._drivenProperties.color&&(Rt(n,e??this._getFallbackMarkerOpacityAndColor(w)),t==null)||this._drivenProperties.opacity&&(e||this._markerColor||this._materialColor)&&(n[3]=t??this._getFallbackMarkerOpacity()),n}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,Ys,this.symbolLayer.type))return null;let n=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus(n.mode===`on-the-ground`),this.draped?this._createAsOverlay(e):this._createAs3DShape(e,n,t.uid)}applyRendererDiff(e,t){for(let n in e.diff){if(n!==`visualVariables`)return 0;{let e=this._fastUpdates;if(!Qi(e,t,this._fastVisualVariableConvertOptions()))return 0;for(let t of this._materials)t instanceof ai&&t.setParameters(e.materialParameters);let n=this._fastMarkerUpdates;if(!Qi(n,t,this._fastVisualVariableConvertOptions(!0)))return 0;for(let e of this._materials)e instanceof Us&&e.setParameters(n.materialParameters)}}return 2}prepareSymbolLayerPatch(e){if(e.diff.type!==`partial`)return;let t=e.diff.diff,n={};t.size?.type===`complete`&&(n.width=this._computeMaterialWidth(t.size.newValue),delete t.size),t.cap?.type===`complete`&&(n.cap=zs(t.cap.newValue??`butt`),delete t.cap);let r=this._prepareMarkerPatch(e,t);this._prepareMaterialPatch(e,t,r),e.symbolLayerStatePatches.push(()=>{for(let e of this._materials)e?.setParameters(n)})}layerOpacityChanged(){for(let e=0;e<5;e++)this._materials[e]?.setParameters(this._getMaterialColorParameters(e))}get _screenSizePerspective(){return!this.draped&&this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null}layerScreenSizePerspectiveChanged(){let e=this._screenSizePerspective;for(let t of this._materials)t?.setParameters({screenSizePerspective:e})}layerElevationInfoChanged(t,n,r){let i=this._elevationContext.mode,a=fi(e.elevationModeChangeTypes,r,i);if(a!==1)return a;let o=ui(i);return this.updateGraphics3DGraphicElevationInfo(t,n,()=>o)}slicePlaneEnabledChanged(){let e={hasSlicePlane:this._context.slicePlaneEnabled};for(let t of this._materials)t?.setParameters(e);return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,n){let r=Zs(e.graphic.geometry),i=r.type===`polygon`?r.rings:r.paths,a=[],o=at(),s=ji(r,this._context.elevationProvider,this._context.renderCoordsHelper,t),c=r.type===`polygon`?`rings`:`paths`;this._logGeometryCreationWarnings(s,i,c,`LineSymbol3DLayer`);for(let t=0;t<s.lines.length;t++){let i=s.lines[t],c=i.position,l=i.mapPositions;if(this._context.clippingExtent!=null&&(u(l,o),!L(o,this._context.clippingExtent)))continue;let d=this._createGeometry(r.type===`polygon`?this._ringMaterial:this._lineMaterial,e,c,l,r.type,1,n);if(a.push(d),Ji.LINE_WIREFRAMES&&a.push(d.instantiate({material:r.type===`polygon`?this._wireframeRingMaterial:this._wireframeLineMaterial})),this._markerMaterial!=null){let t=d.instantiate({material:this._markerMaterial});t.attributes.has(`color`)&&t.setAttributeData(`color`,this._getDrivenMarkerColor(e.renderingInfo)),a.push(t)}}if(a.length===0)return null;let l=this._context.layerViewUid,d=new hi({geometries:a,castShadow:!1,layerViewUid:l,graphicUid:n}),f=new Ua(this,d,null,ka,t);return f.alignedSampledElevation=s.sampledElevation,f.needsElevationUpdates=ui(t.mode),f}_createGeometry(e,t,n,r,i,a,o){let s=a===0?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,c=i===`polygon`,l=this._fastUpdates?.visualVariables.color,u=this._fastUpdates?.visualVariables.size,d=this._fastUpdates?.visualVariables.opacity,f=this._context.layerViewUid,p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:o,layerViewUid:f}),m={position:n,size:u?null:this._getDrivenSize(t.renderingInfo),color:l?null:this._getDrivenColor(t.renderingInfo),sizeFeature:u?Xi(u.field,t.graphic):null,colorFeature:l?Xi(l.field,t.graphic):null,opacityFeature:d?Xi(d.field,t.graphic):null};return ca(e,{overlayInfo:s,removeDuplicateStartEnd:c,mapPositions:r,attributeData:m},p)}_createAsOverlay(e){let t=e.graphic,n=Zs(t.geometry),r=n.type===`polygon`?n.rings:n.paths,i=n.type===`polygon`?this._ringMaterial:this._lineMaterial;i.renderPriority=this._renderPriority;let a=Ji.LINE_WIREFRAMES?n.type===`polygon`?this._wireframeRingMaterial:this._wireframeLineMaterial:null,o=this._markerMaterial;a!=null&&(a.renderPriority=this._renderPriority-.001),o!=null&&(o.renderPriority=this._renderPriority-.002);let s=[],c=at(),l=Et(),d=Hi(n,this._context.overlaySR),f=n.type===`polygon`?`rings`:`paths`;this._logGeometryCreationWarnings(d,r,f,`LineSymbol3DLayer`);for(let r of d.lines){if(u(r.position,c),!L(c,this._context.clippingExtent))continue;nt(l,c);let d=this._createGeometry(i,e,r.position,void 0,n.type,0,t.uid),f=e=>{let n=this._context.layerViewUid,r=new Mi(e,{layerViewUid:n,graphicUid:t.uid});s.push(r)};if(o!=null){let t=d.instantiate({material:o});t.attributes.has(`color`)&&t.setAttributeData(`color`,this._getDrivenMarkerColor(e.renderingInfo)),f(t);let n=this.symbolLayer.marker.placement;n!==`begin`&&n!==`begin-end`||It(c,r.position,0,1),n!==`end`&&n!==`begin-end`||It(c,r.position,r.position.length-3,1)}f(d),Ji.LINE_WIREFRAMES&&f(d.instantiate({material:a}))}return new bs(this,s,l,this._context.drapeSourceRenderer)}get _patternHidesLine(){let e=this.symbolLayer.pattern;return e!=null&&e.type===`style`&&e.style===`none`}_computeMaterialWidth(e){return e??=Xe(1),this._drivenProperties.size?this._fastUpdates?.visualVariables.size?P(1):1:P(e)}_prepareMaterialPatch(e,t,n){let r=t.material;if(r==null)return void(n.changed&&n.useMaterialColor&&Qs(this._getCombinedOpacityAndColor(this._materialColor),this._materials[4],e));if(r.type===`collection`)return;let i=r.type===`complete`?r.newValue?.color:r.diff.color?.type===`complete`?r.diff.color.newValue:null,a=this._getCombinedOpacityAndColor(i);n.useMaterialColor&&Qs(ht(a),this._materials[4],e),this._patternHidesLine&&(a[3]=0),Qs(a,this._materials[0],e),delete t.material}_prepareMarkerPatch(e,t){let n=t.marker,r=this._markerMaterial;if(n==null||n.type!==`partial`||n.diff==null||n.diff.placement!=null||n.diff.style!=null&&n.diff.style.type!==`complete`||n.diff.color!=null&&n.diff.color.type!==`complete`||r==null)return{changed:!1,useMaterialColor:this._markerColor==null};let i=n.diff.color,a=i!=null,o=a?i.newValue:null,s=o==null&&this._markerColor==null;o&&Qs(this._getCombinedOpacityAndColor(o),r,e);let c=n.diff.style?.newValue;return c&&e.symbolLayerStatePatches.push(()=>r.setParameters({markerPrimitive:Bs(c)})),delete t.marker,{changed:a,useMaterialColor:s}}_fastVisualVariableConvertOptions(e=!1){let t=this._getFallbackSize();return new Gi({supports:{size:!0,color:!0,rotation:!1,opacity:!0},fallbackColor:e?this._getFallbackMarkerOpacityAndColor(Ra):this._getFallbackOpacityAndColor(Ra),fallbackSize:I(t,t,t)})}_getFallbackOpacityAndColor(e){return this._materialColor?.toUnitRGBA()??e}_getFallbackOpacity(){return this._materialColor?.a??0}_getFallbackMarkerOpacityAndColor(e){return this.symbolLayer?.marker?.color?.toUnitRGBA()??this._getFallbackOpacityAndColor(e)}_getFallbackMarkerOpacity(){return this.symbolLayer?.marker?.color?.a??this._getFallbackOpacity()}_getFallbackSize(){let e=this.symbolLayer?.size;return e==null?1:P(e)}};function Zs(e){switch(e.type){case`extent`:if(e instanceof it)return Ot.fromExtent(e);break;case`polygon`:case`polyline`:return e}return null}function Qs(e,t,n){t!=null&&n.symbolLayerStatePatches.push(()=>t.setParameters({color:e}))}function $s(e){let t=e.material?.color,n=e.marker?.color??t;return(t?.a??0)===1&&(n?.a??0)===1}var ec={disableDelayMs:2e3},tc=class extends Ua{constructor(){super(...arguments),this.fastTransformUpdatesAllowed=!1,this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1,this._autoDisableFastUpdatesTimeoutId=0}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}destroy(){super.destroy(),this._cancelAutoDisableFastUpdates()}enableFastTransformUpdates(e,t){if(!this.fastTransformUpdatesAllowed||this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!0;let{stageObject:n}=this,r=n.geometries.slice();n.removeAllGeometries();let i=ot(nc,n.transformation),a=t.getOrigin(i);for(let t of r){let r=e(t.material),i=t.instantiate({material:r});i.localOrigin=a,n.addGeometry(i)}this._originalGeometries=r}autoDisableFastTransformUpdates(e){this._cancelAutoDisableFastUpdates(),this._autoDisableFastUpdatesTimeoutId=setTimeout(()=>{this._autoDisableFastUpdatesTimeoutId=0,e()},ec.disableDelayMs)}updateAutoDisableFastTransformUpdates(e){this._autoDisableFastUpdatesTimeoutId&&this.autoDisableFastTransformUpdates(e)}_cancelAutoDisableFastUpdates(){clearTimeout(this._autoDisableFastUpdatesTimeoutId),this._autoDisableFastUpdatesTimeoutId=0}disableFastTransformUpdates(e){if(!this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!1;let{stageObject:t}=this,n=t.geometries.map(t=>e(t.material));t.removeAllGeometries();for(let e=0;e<this._originalGeometries.length;e++){let r=this._originalGeometries[e],i=n[e];i.setParameters({modelTransformation:null}),i===r.material?t.addGeometry(r):t.addGeometry(r.instantiate({material:i}))}this._originalGeometries.length=0}updateFastLocalOrigin(e,t,n){if(!this._fastTransformUpdatesEnabled)return;let{stageObject:r}=this;if(r.geometries.length===0)return;let i=r.geometries[0].localOrigin,a=ot(nc,e),s=n.getOrigin(a);if(s===i)return;let c=t?.localMatrix??o;r.shaderTransformation=null,r.transformation=e,r.geometries.forEach(e=>{e.transformation=c,e.localOrigin=s})}updateTransform(e,t,n){let{stageObject:r}=this,i=t?.localMatrix??o;if(!this._fastTransformUpdatesEnabled)return r.shaderTransformation=null,r.transformation=e,r.geometries.forEach(e=>e.transformation=i),void this._updateEdgeTransform(n);let a=r.transformation,s=r.geometries[0].transformation,c=e,l=i,u=Ee(rc,a,s),d=Ee(ic,c,l);r.shaderTransformation=Ee(oc,d,xe(oc,s)),this._setFastMaterialTransformation({matA:u,matB:d}),this._updateEdgeTransform(n)}alignWithElevation(e,t,n){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(e,t,n);let r=(n,r)=>oi(n,e,this.elevationContext,t,r),{stageObject:i}=this;if(!i.geometries[0].material.parameters.modelTransformation)return;let a=i.transformation,o=i.geometries[0].transformation,s=Ee(rc,a,o),c=i.effectiveTransformation,l=Ne(ac,c);this.alignedSampledElevation=ja(this,this.elevationContext,e.spatialReference,r,t,l),i.shaderTransformation=l;let u=i.geometries[0].transformation,d=Ee(ic,l,u);this._setFastMaterialTransformation({matA:s,matB:d}),this._updateEdgeTransform(n)}_setFastMaterialTransformation({matA:e,matB:t}){let{stageObject:n}=this;if(n.geometries.length===0)return;let r=n.geometries[0].localOrigin,i=Ve(lc,d(nc,r.vec3,-1)),a=Ee(sc,i,e),o=Ee(cc,i,t),s=xe(sc,a),c=Ee(cc,o,s);for(let e of n.geometries)e.material.setParameters({modelTransformation:c})}_updateEdgeTransform(e){let{stageObject:t,_stageLayer:n}=this;n.stage.renderer.withEdgeView(n=>{n.fastUpdateObject3DEdgesTransform(t)||this.resetEdgeObject(e)})}},nc=j(),rc=k(),ic=k(),ac=k(),oc=k(),sc=k(),cc=k(),lc=k(),uc=class{constructor(){this._fastTransformOriginalMaterials=new Map,this._fastTransformClonedMaterials=new Map,this._graphicReferenceCount=0}enable(e,t,n){e.enableFastTransformUpdates(e=>{if(this._graphicReferenceCount<=1){if(this._fastTransformOriginalMaterials.has(e))return e;let n=t.byMaterial(e);return this._fastTransformOriginalMaterials.set(e,n),t.delete(e),e}let r=new $a(e.parameters,n);return this._fastTransformClonedMaterials.set(r,e),r},n.localOriginFactory)}disable(e,t){let n=new Set,r=new Set;e.disableFastTransformUpdates(e=>{if(!this._fastTransformClonedMaterials.has(e)){let i=e,a=this._fastTransformOriginalMaterials.get(i);return t.has(a.uid)?(n.add(i),t.byUid(a.uid).material):(r.add(i),a.material)}let i=e,a=this._fastTransformClonedMaterials.get(i);return this._fastTransformClonedMaterials.delete(i),a});for(let e of n)this._fastTransformOriginalMaterials.delete(e);for(let e of r){let n=this._fastTransformOriginalMaterials.get(e);this._fastTransformOriginalMaterials.delete(e),t.set(n.uid,n)}}onAddGraphic(){this._graphicReferenceCount++}onRemoveGraphic(e,t){this._graphicReferenceCount--,this.disable(e,t)}forEachMaterialInfo(e){this._fastTransformOriginalMaterials.forEach(e)}forEachClonedMaterial(e){this._fastTransformClonedMaterials.forEach(e)}destroy(){this._fastTransformClonedMaterials.clear(),this._fastTransformOriginalMaterials.clear()}},dc=class{constructor(){this._byUid=new Map,this._byMaterial=new Map}get materials(){return Array.from(this._byUid.values(),e=>e.material)}byUid(e){return this._byUid.get(e)}byMaterial(e){return this._byMaterial.get(e)}set(e,t){this._byUid.set(e,t),this._byMaterial.set(t.material,t)}delete(e){let t=this._byMaterial.get(e)?.uid;t&&(this._byUid.delete(t),this._byMaterial.delete(e))}has(e){return this._byUid.has(e)}forEachMaterialInfo(e){this._byUid.forEach(e)}clear(){this._byUid.clear(),this._byMaterial.clear()}},fc=class extends yi{constructor(e,t){super(e,t,t.hasVertexColors?Pi:Bi),this.shader=new Si(So,()=>i(()=>import(`./NativeLine.glsl-ClOJXnSr.js`),__vite__mapDeps([54,55,56,2,3,42,24,36,28,23,39,35,57,33,34,37,31,45,46,30,38,47,44,26,27,29,48]))),this.primitiveType=se.LINES}initializePipeline(e){let{hasOccludees:t,output:n,hasEmission:r,transparent:i,oitPass:a}=e,o=(e,n=null,i=null)=>kr({blending:n,depthTest:$r,depthWrite:i,colorWrite:Er,stencilWrite:t?ti:null,stencilTest:t?e?Zr:Ur:null,drawBuffers:Vr(a,r)});return B(n)?(this._occludeePipeline=o(!0,i?jr:null,Dr),o(!1,i?jr:null,Dr)):o(!1)}getPipeline(e,t){return t?this._occludeePipeline:super.getPipeline(e)}};fc=N([Ce(`esri.views.3d.webgl-engine.shaders.NativeLineTechnique`)],fc);var pc=class extends Rr{constructor(){super(...arguments),this.hasVertexColors=!1,this.transparent=!1,this.hasOccludees=!1,this.writeDepth=!0,this.draped=!1,this.snowCover=!1,this.emissionSource=0,this.textureCoordinateType=0}get discardInvisibleFragments(){return this.transparent&&this.writeDepth}};N([V()],pc.prototype,`hasVertexColors`,void 0),N([V()],pc.prototype,`transparent`,void 0),N([V()],pc.prototype,`hasOccludees`,void 0),N([V()],pc.prototype,`writeDepth`,void 0);var mc=class extends Pr{constructor(e){super(e,gc),this._configuration=new pc,this.produces=new Map([[2,e=>cr(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.hasOccludees=t.hasOccludees,this._configuration}get visible(){return this.parameters.color[3]>=ea}intersect(e,t,n,r,i,a){let{options:o,camera:s,rayBegin:c,rayEnd:l}=n;if(!o.selectionMode||!e.visible||!s)return;if(!Vn(t))return void Qt.getLogger(`esri.views.3d.webgl-engine.materials.NativeLineMaterial`).error(`intersection assumes a translation-only matrix`);let u=e.attributes.get(`position`).data,f=Tc;g(f,n.point),O(Ec[0],f[0]-2,f[1]+2,0),O(Ec[1],f[0]+2,f[1]+2,0),O(Ec[2],f[0]+2,f[1]-2,0),O(Ec[3],f[0]-2,f[1]-2,0);for(let e=0;e<4;e++)if(!s.unprojectFromRenderScreen(Ec[e],Dc[e]))return;jn(s.eye,Dc[0],Dc[1],Oc),jn(s.eye,Dc[1],Dc[2],kc),jn(s.eye,Dc[2],Dc[3],Ac),jn(s.eye,Dc[3],Dc[0],jc);let p=Number.MAX_VALUE,m=0;for(let e=0;e<u.length-5;e+=3){if(G[0]=u[e]+t[12],G[1]=u[e+1]+t[13],G[2]=u[e+2]+t[14],K[0]=u[e+3]+t[12],K[1]=u[e+4]+t[13],K[2]=u[e+5]+t[14],On(Oc,G)<0&&On(Oc,K)<0||On(kc,G)<0&&On(kc,K)<0||On(Ac,G)<0&&On(Ac,K)<0||On(jc,G)<0&&On(jc,K)<0)continue;let n=s.projectToRenderScreen(G,yc),r=s.projectToRenderScreen(K,bc);if(n==null||r==null)continue;if(n[2]<0&&r[2]>0){R(_c,G,K);let e=s.frustum,t=-On(e[4],G)/M(_c,Dn(e[4]));if(d(_c,_c,t),E(G,G,_c),!s.projectToRenderScreen(G,n))continue}else if(n[2]>0&&r[2]<0){R(_c,K,G);let e=s.frustum,t=-On(e[4],K)/M(_c,Dn(e[4]));if(d(_c,_c,t),E(K,K,_c),!s.projectToRenderScreen(K,r))continue}else if(n[2]<0&&r[2]<0)continue;n[2]=0,r[2]=0;let i=wr(Cr(n,r,Cc),f);i<p&&(p=i,T(xc,G),T(Sc,K),m=e/3)}if(p<4){let e=Number.MAX_VALUE;if(Sr(Cr(xc,Sc,Cc),Cr(c,l,wc),vc)){R(vc,vc,c);let t=Ct(vc);d(vc,vc,1/t),e=t/Dt(c,l)}a(e,vc,m)}}intersectDraped(e,t,n,r,i){if(!t.options.selectionMode)return;let a=e.attributes.get(`position`).data,o=e.attributes.get(`size`),s=o?o.data[0]:0,c=n[0],l=n[1],u=((s+1)/2+4)*e.screenToWorldRatio,d=Number.MAX_VALUE,f=0;for(let e=0;e<a.length-5;e+=3){let t=a[e],n=a[e+1],r=c-t,i=l-n,o=a[e+3]-t,s=a[e+4]-n,u=pt((o*r+s*i)/(o*o+s*s),0,1),p=o*u-r,m=s*u-i,h=p*p+m*m;h<d&&(d=h,f=e/3)}d<u*u&&r(i.distance,i.normal,f)}createGLMaterial(e){return new hc(e)}createBufferWriter(){let e=this.parameters.hasVertexColors?Li:zi;return new ei(e)}},hc=class extends ar{beginSlot(e){return this.getTechnique(fc,e)}},gc=class extends Nr{constructor(){super(...arguments),this.color=e,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1}},G=j(),K=j(),_c=j(),vc=j(),yc=Lt(),bc=Lt(),xc=j(),Sc=j(),Cc=xr(),wc=xr(),Tc=j(),Ec=[Lt(),Lt(),Lt(),Lt()],Dc=[j(),j(),j(),j()],Oc=Mn(),kc=Mn(),Ac=Mn(),jc=Mn(),Mc=[`mesh`],Nc=class extends Va{constructor(e,t,n,r){super(e,t,n,r,Zc(t)),this._materialInfoCache=new dc,this._fastUpdateProcessor=new uc,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){Ji.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new mc({color:[1,0,1,1]}),this._debugTangentNormalMaterial=new mc({color:[1,.5,0,1]}),this._debugFaceNormalMaterial=new mc({color:[0,1,1,1]})),this.updateComplexity()}destroy(){super.destroy(),this._textures.forEach(e=>e.unload()),this._context.stage.removeTextures(Array.from(this._textures.values())),this._materialInfoCache.clear(),this._textures.clear(),this._fastUpdateProcessor.destroy()}get materials(){return this._materialInfoCache.materials}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,Mc,`fill on mesh-3d`))return null;let n=this.createElevationContextForGraphic(t),r=e.renderingInfo;return this._createAs3DShape(t,r,n,t.uid)}onRemoveGraphic(e){this._fastUpdateProcessor.onRemoveGraphic(e,this._materialInfoCache)}layerOpacityChanged(e,t){let n=this._getLayerOpacity();this._updateMaterialParameters(e=>{e.material.setParameters({layerOpacity:n});let t=e.material.parameters;this._setMaterialTextureAlphaMode(t,e)}),e?.forEach(e=>t(e)?.layerOpacityChanged(n,this._context.isAsync))}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,pi)}slicePlaneEnabledChanged(e,t){return this._updateMaterialParameters(({material:e})=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),e?.forEach(e=>t(e)?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)),!0}physicalBasedRenderingChanged(){let e=this._usePBR();return this._updateMaterialParameters(({material:t})=>t.setParameters({usePBR:e})),!0}updateTransform(e,t,n,r){if(!e.fastTransformUpdatesAllowed)return!1;let i=e.fastTransformUpdatesEnabled;switch(r){case 0:if(i)return!0;break;case 1:if(!i)return!0;break;default:if(!i)return!!this.updateTransform(e,t,n,0)&&(e.autoDisableFastTransformUpdates(()=>this.updateTransform(e,t,n,1)),!0)}let a=this._context.renderCoordsHelper.spatialReference,o=rl,{origin:s,transform:c}=n;if(!In(t,O(q,s.x,s.y,s.z??0),o,a))return!1;switch(r){case 0:this._fastUpdateProcessor.enable(e,this._materialInfoCache,this._context);break;case 1:this._fastUpdateProcessor.disable(e,this._materialInfoCache);break;case 2:e.updateFastLocalOrigin(o,c,this._context.localOriginFactory)}let{elevationContext:l}=e;l.centerInElevationSR=this._getCenterInElevationSR(o);let{elevationProvider:u,renderCoordsHelper:d}=this._context;return e.alignedSampledElevation=ja(e,l,u.spatialReference,(e,t)=>oi(e,u,l,d,t),d,o),e.updateTransform(o,c,this._context.isAsync),e.updateAutoDisableFastTransformUpdates(()=>this.updateTransform(e,t,n,1)),!0}computeComplexity(){if(!this._textures||this._textures.size===0)return super.computeComplexity();let e=0;for(let t of this._textures.values())e+=t.usedMemory;let t={...Ea(this.symbol,this.symbolLayer),resourceBytes:e},n=$n(this.symbolLayer)?2:0;return new xa({drawCallsPerFeature:n,memory:t})}_requiresSymbolVertexColors(){return this._hasDrivenColorOrOpacity}_materialPropertiesDefault(e,t){let n=this._requiresSymbolVertexColors(),r=!!e.vertexAttributes.color,i=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:n,hasVertexColors:r,hasVertexTangents:i,uid:`vc:${r},vt:${i},vct${t},svc:${n}`}}_materialProperties(e,t,n){let r=this._materialPropertiesDefault(e,n);if(!t.material)return r;let{color:i,colorTexture:a,colorTextureTransform:o,normalTexture:s,normalTextureTransform:c,doubleSided:l,alphaCutoff:u,alphaMode:d}=t.material,f=Jc(i),p=Jc(a),m=Yc(o),h=Jc(s),g=Yc(c);if(r.color=i,r.colorTexture=a,r.normalTexture=s,r.uid=`${r.uid},cmuid:${f},ctmuid:${p},cttuid:${m},ntmuid:${h},nttuid:${g},ds:${l},ac:${u},am:${d}`,t.material instanceof hn){let{metallic:e,roughness:n,metallicRoughnessTexture:i,metallicRoughnessTextureTransform:a,emissiveColor:s,emissiveStrength:l,emissiveTexture:u,emissiveTextureTransform:d,occlusionTexture:f,occlusionTextureTransform:p}=t.material,m=Jc(i),h=Yc(a),g=Jc(s),_=Jc(u),v=Yc(d),y=Jc(f),b=Yc(p);r.uid=[r.uid,`mrm:${e}`,`mrr:${n}`,`mrt:${m}`,`mrtt:${h}`,`emuid:${g}`,`ems:${l}`,`etmuid:${_}`,`ett:${v}`,`otmuid:${y}`,`ott:${b}`].join(`,`),r.metallic=e,r.roughness=n,r.metallicRoughnessTexture=i,r.emissiveColor=s,r.emissiveStrength=l,r.emissiveTexture=u,r.occlusionTexture=f,r.colorTextureTransform=Hc(o),r.normalTextureTransform=Hc(c),r.emissiveTextureTransform=Hc(d),r.occlusionTextureTransform=Hc(p),r.metallicRoughnessTextureTransform=Hc(a)}return r}_getInternalTexture(e,t=!1,n=1){let r=qc(e);if(!r)return null;let i=`${e.contentHash}/${n}`,a=this._textures.get(i);if(a){let e=this._context.stage.renderView.textures,t=null,n=e.acquire(a.id);return n==null||dn(n)||(a.events.on(`unloaded`,()=>t=Qe(t)),t=n),a}let o=null,s=this._context.stage.renderView.renderingContext.parameters.maxMaxAnisotropy,c={wrap:Uc(e.wrap),noUnpackFlip:!0,maxAnisotropy:s,mipmap:s>1};return Yn(r)?(o=r.data,c.preMultiplyAlpha=!1,c.encoding=r.encoding):(o=r,c.preMultiplyAlpha=n!==1,c.compressionOptions=t?{compressionTracker:this._context.compressionTracker,compressionCallback:()=>this.updateComplexity()}:void 0),a=new na(o,c),this._textures.set(i,a),a.events.on(`loaded`,()=>this.updateComplexity()),a.load(this._context.stage.renderView.renderingContext),this._context.stage.addTexture(a),a.events.on(`unloaded`,()=>{this._textures.delete(i)}),a}_setInternalMaterialTextureParameters(e,t){if(e.colorTexture!=null){let n=t.textureAlphaMode!==1,r=this._getInternalTexture(e.colorTexture,n,t.textureAlphaMode);r?(t.textureId=r.id,t.textureAlphaPremultiplied=!!r.parameters.preMultiplyAlpha):t.textureId=void 0}if(e.normalTexture&&(t.normalTextureId=this._getInternalTexture(e.normalTexture)?.id),e.emissiveColor){let n=e.emissiveColor?.toUnitRGB();t.emissiveBaseColor=I(rt(n[0]),rt(n[1]),rt(n[2]))}e.emissiveStrength&&(t.emissiveStrengthKHR=e.emissiveStrength),e.emissiveTexture&&(t.emissiveTextureId=this._getInternalTexture(e.emissiveTexture)?.id),e.occlusionTexture&&(t.occlusionTextureId=this._getInternalTexture(e.occlusionTexture,!0)?.id),e.metallicRoughnessTexture&&(t.metallicRoughnessTextureId=this._getInternalTexture(e.metallicRoughnessTexture,!0)?.id)}_setInternalMaterialParameters(e,t,n){e.color!=null&&Kc(e.color,t,n),this._setInternalMaterialTextureParameters(e,t),t.colorTextureTransformMatrix=xo(e.colorTextureTransform),t.normalTextureTransformMatrix=xo(e.normalTextureTransform);let r=e.normalTextureTransform?.scale==null?Tt:e.normalTextureTransform?.scale;t.scale=[r[0],r[1]],t.occlusionTextureTransformMatrix=xo(e.occlusionTextureTransform),t.emissiveTextureTransformMatrix=xo(e.emissiveTextureTransform),t.metallicRoughnessTextureTransformMatrix=xo(e.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(t,n=this._materialColor){let r=this._drivenProperties.color,i=this._drivenProperties.opacity;if(r)t.externalColor=e;else{let e=n??null;if(e){let n=e.toUnitRGBA();i&&(n[3]=1),t.externalColor=n}else t.externalColor=Ra}t.colorMixMode=this.symbolLayer.material?.colorMixMode??`multiply`,t.castShadows=!!this.symbolLayer.castShadows,t.emissiveStrengthFromSymbol=this.symbolLayer?.material?.emissive?.strength??1,t.emissiveSource=He(this.symbolLayer?.material?.emissive?.source??`emissive`)}_getOrCreateMaterial(e,t){let n=t.material?.color,r=t.material?.colorTexture,i=t.material?.alphaMode,a=i===`blend`,o=i!==`opaque`&&(Gc(e)||n!=null&&n.a<1||r?.transparent||a),s=this._materialProperties(e,t,o),c=this._materialInfoCache.byUid(s.uid);if(c)return this._setInternalMaterialTextureParameters(s,c.material.parameters),c.material;let l={uid:s.uid,material:null,isComponentTransparent:o,alphaMode:t.material?t.material.alphaMode:`opaque`},u=ro({normalTexture:s.normalTexture,metallicRoughnessTexture:s.metallicRoughnessTexture,metallicFactor:s.metallic,roughnessFactor:s.roughness,emissiveTexture:s.emissiveTexture,emissiveFactor:s.emissiveColor?.toUnitRGB(),occlusionTexture:s.occlusionTexture}),d={usePBR:this._usePBR(),isSchematic:u,hasVertexColors:s.hasVertexColors,hasSymbolColors:s.hasSymbolVertexColors,hasVertexTangents:s.hasVertexTangents,ambient:xt,diffuse:qt,opacity:1,doubleSided:!0,doubleSidedType:`winding-order`,cullFace:0,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,drivenOpacity:this.needsDrivenTransparentPass||l.isComponentTransparent};d.mrrFactors=u?no:[s.metallic,s.roughness,io[2]],t.material&&(d.doubleSided=t.material.doubleSided,d.cullFace=t.material.doubleSided?0:2,d.textureAlphaCutoff=t.material.alphaCutoff),this._setExternalMaterialParameters(d),this._setMaterialTextureAlphaMode(d,l),this._setInternalMaterialParameters(s,d,l);let f=new $a(d,this._context);return l.material=f,this._materialInfoCache.set(s.uid,l),f}prepareSymbolLayerPatch(e){if(e.diff.type!==`partial`)return;let t=e.diff.diff;this._preparePatchColor(e,t)}_preparePatchColor(e,t){if(!t.material||t.material.type!==`partial`)return;let n=t.material.diff;if(!n.color||n.color.type!==`complete`||n.color.newValue==null||n.color.oldValue==null)return;let r=n.color.newValue;delete n.color,e.symbolLayerStatePatches.push(()=>{this._updateMaterialParameters(e=>{let t=e.material.parameters;this._setExternalMaterialParameters(t,r),this._setMaterialTextureAlphaMode(t,e),e.material.setParameters({externalColor:t.externalColor})})})}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTextureAlphaMode(e,t){t.alphaMode===`auto`?e.textureAlphaMode=this.needsDrivenTransparentPass||t.isComponentTransparent||(e.layerOpacity??1)<1||(e.opacity??1)<1||(e.externalColor?.[3]??1)<1?3:1:e.textureAlphaMode=t.alphaMode===`opaque`?1:t.alphaMode===`mask`?2:0}_createFaceDebugNormals(e,t){let r=t.length,i=e.spatialReference.isGeographic?20015077/180:1,a=.1*Math.max(e.extent.width*i,e.extent.height*i,e.extent.zmax-e.extent.zmin),o=[],s=[],c=t[0].transformation,l=ue(y(),c);for(let e=0;e<r;e++){let r=t[e].attributes.get(`position`);if(!r)continue;let i=r.data,u=r.indices;for(let e=0;e<u.length;e+=3)Vc(i,u,e,tl),Bc(i,u,e,q,J,el),E(q,q,J),E(q,q,el),d(q,q,1/3),A(q,q,c),o.push(...q),$t(tl,tl,l),F(tl,tl),n(q,q,tl,a),o.push(...q),s.push(s.length),s.push(s.length)}return o.length?new qr(this._debugFaceNormalMaterial,[[`position`,new z(o,s,3,!0)]],null,2):null}_createPerVertexDebugVectors(e,t,r,i,a){let o=t.length,s=e.spatialReference.isGeographic?20015077/180:1,c=.1*a*Math.max(e.extent.width*s,e.extent.height*s,e.extent.zmax-e.extent.zmin),l=[],u=[],d=t[0].transformation,f=ue(y(),d);r===`tangent`&&fn(f,d);for(let e=0;e<o;e++){let i=t[e],a=i.attributes.get(`position`),o=i.attributes.get(r);if(!a||!o)continue;let s=a.data,p=a.indices,m=o.data,h=o.indices;for(let e=0;e<p.length;e++){let t=3*p[e],r=h[e]*o.stride;O(q,s[t+0],s[t+1],s[t+2]),A(q,q,d),l.push(...q),O(J,m[r+0],m[r+1],m[r+2]),$t(J,J,f),F(J,J),n(q,q,J,c),l.push(...q),u.push(u.length),u.push(u.length)}}return l.length?new qr(i,[[`position`,new z(l,u,3,!0)]],null,2):null}_createAs3DShape(e,t,n,r){let i=e.geometry;if(i.type!==`mesh`)return null;let a=this._createGeometryInfo(i,t,r);if(a==null)return null;let{geometries:o,objectTransformation:s}=a;if(Ji.DRAW_MESH_GEOMETRY_NORMALS){let e=this._createPerVertexDebugVectors(i,o,`normal`,this._debugVertexNormalMaterial,1),t=this._createPerVertexDebugVectors(i,o,`tangent`,this._debugTangentNormalMaterial,.5),n=this._createFaceDebugNormals(i,o);e&&o.push(e),t&&o.push(t),n&&o.push(n)}let c=this._context.layerViewUid,l=new hi({geometries:o,layerViewUid:c,graphicUid:r,isElevationSource:!0});l.transformation=s;let u=Qn(this.symbolLayer,{opacity:this._getLayerOpacity()}),d=u?new Oa(o[0].material,u,this._context.slicePlaneEnabled):null,f=new tc(this,l,null,ja,n,d);this._fastUpdateProcessor.onAddGraphic(),f.needsElevationUpdates=pi(n.mode),f.useObjectOriginAsAttachmentOrigin=!0,f.fastTransformUpdatesAllowed=this._fastTransformUpdatesAllowed(i),n.centerInElevationSR=this._getCenterInElevationSR(l.transformation);let{elevationProvider:p,renderCoordsHelper:m}=this._context;return f.alignedSampledElevation=ja(f,n,p.spatialReference,(e,t)=>oi(e,p,n,m,t),m),f}_fastTransformUpdatesAllowed(e){let{vertexSpace:t,spatialReference:n}=e;if(!_n(t))return!1;let{type:r}=t,{view:i}=this._context.graphicsCoreOwner,{viewingMode:a}=i.state,o=i.spatialReference;return a===1&&r===`local`||a===2&&Ze(o,n)&&r===`georeferenced`&&!n.isGeographic}_getElevationSR(){return this._context.elevationProvider.spatialReference??null}_getCenterInElevationSR(e){let t=j(),n=O(ol,e[12],e[13],e[14]);return Zn(n,this._context.renderCoordsHelper.spatialReference,t,this._getElevationSR()),t}_passthroughReprojectionInfo(e){return e.reprojection===0&&!!e.objectTransformation}_createPositionBuffer(e,t){let n=e.vertexAttributes.position,r,i=n;if(t.reprojection===0)return{position:i,georeferencedPositionBuffer:r};let a=t.reprojection===1?t.transformBeforeProject:null;a&&(i=Hn(new Float64Array(i.length),i,a));let{normal:o,tangent:s}=e.vertexAttributes;this._passthroughReprojectionInfo(t)||!o&&!s||(r=i);let c=i===n||i===r?new Float64Array(i.length):i;return te(i,e.spatialReference,0,c,this._context.renderCoordsHelper.spatialReference,0),{position:c,georeferencedPositionBuffer:r}}_createNormalBuffer(e,t,n,r){let i=e.vertexAttributes.normal;if(i==null)return null;let a=i,o=r.reprojection===1?r.transformBeforeProject:null;o&&(a=Jn(a,new Float32Array(a.length),o));let s=this._context.graphicsCoreOwner.view.viewingMode;if(r.reprojection===0)return a;if(s===`local`){if(!h(this._context.renderCoordsHelper.spatialReference))return a;if(n==null)return null;if(e.spatialReference.isGeographic){let e=a===i?new Float32Array(a.length):a;return Gn(a,0,n,e)}if(e.spatialReference.isWebMercator){let e=a===i?new Float32Array(a.length):a;return Wn(a,0,n,e)}return a}if(n==null)return null;let c=a===i?new Float32Array(a.length):a,l=this._context.renderCoordsHelper.spatialReference;return Kn(a,n,e.spatialReference,t,l,c)}_createTangentBuffer(e,t,n,r){let i=e.vertexAttributes.tangent;if(i==null)return null;let a=i,o=r.reprojection===1?r.transformBeforeProject:null;o&&(a=Un(a,new Float32Array(a.length),o));let s=this._context.graphicsCoreOwner.view.viewingMode;if(r.reprojection===0)return a;if(s===`local`){if(!h(this._context.renderCoordsHelper.spatialReference))return a;if(n==null)return null;if(e.spatialReference.isGeographic){let e=a===i?new Float32Array(a.length):a;return Gn(a,1,n,e)}if(e.spatialReference.isWebMercator){let e=a===i?new Float32Array(a.length):a;return Wn(a,1,n,e)}return a}if(n==null)return null;let c=a===i?new Float32Array(a.length):a,l=this._context.renderCoordsHelper.spatialReference;return qn(a,n,e.spatialReference,t,l,c)}_createSymbolColorBuffer(e){return this._requiresSymbolVertexColors()?new Uint8Array(this._getDrivenUInt8ColorWithNaNSupport(e,this._materialColor,!0)):null}_createBuffers(e,t){let n=e.vertexAttributes&&e.vertexAttributes.position;if(!n)return this.logger.warn(`Mesh geometry must contain position vertex attributes`),null;let r=e.vertexAttributes.normal,i=e.vertexAttributes.uv,a=e.vertexAttributes.tangent;if(r&&r.length!==n.length)return this.logger.warn(`Mesh normal vertex buffer must contain the same number of elements as the position buffer`),null;if(a&&a.length/4!=n.length/3)return this.logger.warn(`Mesh tangent vertex buffer must contain the same number of elements as the position buffer`),null;if(i&&i.length/2!=n.length/3)return this.logger.warn(`Mesh uv vertex buffer must contain the same number of elements as the position buffer`),null;let o=this._computeReprojectionInfo(e),{position:s,georeferencedPositionBuffer:c}=this._createPositionBuffer(e,o),l=Xc(e),u=this._createSymbolColorBuffer(t),d=this._createNormalBuffer(e,s,c,o),f=this._createTangentBuffer(e,s,c,o),p=i,{transformation:m,position:h,normal:g,tangent:_}=this._passthroughReprojectionInfo(o)?{transformation:o.objectTransformation,position:s,normal:d,tangent:f}:this._transformOriginLocal(e,s,d,f);return{positionBuffer:h,normalBuffer:g,tangentBuffer:_,uvBuffer:p,colorBuffer:l,symbolColorBuffer:u,objectTransformation:m,geometryTransformation:o.reprojection===0&&o.geometryTransformation?o.geometryTransformation:k()}}_computeReprojectionInfo(e){let{vertexSpace:t}=e,n=t.type===`georeferenced`?Ze(this._context.renderCoordsHelper.spatialReference,e.spatialReference)?0:1:0;if(vn(t))return{reprojection:n};let r=t.origin,i=k(),a=e.transform?.localMatrix??o;if(n===0)return In(e.spatialReference,r,i,this._context.renderCoordsHelper.spatialReference),{reprojection:n,objectTransformation:i,geometryTransformation:ze(a)};let s=Ve(k(),r);return Ee(s,s,a),{reprojection:n,transformBeforeProject:s}}_transformOriginLocal(e,t,n,r){let i=this._context.renderCoordsHelper.spatialReference,a=e.origin;$c[0]=a.x,$c[1]=a.y,$c[2]=a.z??0;let o=k();In(e.spatialReference,$c,o,i),xe(nl,o);let{position:s,normal:c,tangent:l}=e.vertexAttributes,u=t===s?new Float64Array(t.length):t;Hn(u,t,nl);let d=n?n===c?new Float32Array(n.length):n:null,f=r?r===l?new Float32Array(r.length):r:null;return n&&d&&Jn(n,d,nl),r&&f&&Un(r,f,nl),{transformation:o,position:u,normal:d,tangent:f}}_validateFaces(e,t){let n=e.vertexAttributes.position.length/3,r=t.faces;if(r){let e=-1;for(let t=0;t<r.length;t++){let n=r[t];n>e&&(e=n)}if(n<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(n%3!=0)return this.logger.warn(`Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)`),!1;return!0}_isOutsideClippingArea(e){if(!this._context.clippingExtent||!e.vertexAttributes?.position)return!1;let t=this._context.elevationProvider.spatialReference,n=Xn(e,t??e.spatialReference);return!!n&&(u(n,il),!L(il,this._context.clippingExtent))}_createGeometryInfo(e,t,n){if(!Te(e.spatialReference,this._context.renderCoordsHelper.spatialReference))return this.logger.warn(`Geometry spatial reference is not compatible with the view`),null;if(!this._validateVertexSpace(e)||this._isOutsideClippingArea(e))return null;let r=this._createBuffers(e,t);if(r==null)return null;let{positionBuffer:i,uvBuffer:a,colorBuffer:o,symbolColorBuffer:s,normalBuffer:c,tangentBuffer:l,objectTransformation:u,geometryTransformation:d}=r,f=e.components??al,p=[],m=!1,h=ot(q,u),g=this._context.localOriginFactory.getOrigin(h);for(let t of f){if(!this._validateFaces(e,t))return null;let r=Fc(e,t);if(r.length===0)continue;let u=Ic(i,c,t,r);u.didFlipNormals&&(m=!0);let f=[[`position`,new z(i,r,3,!0)],[`normal`,new z(u.normals,u.indices,3,!0)]];o&&f.push([`color`,new z(o,r,4,!0)]),s&&f.push([`symbolColor`,new z(s,Sn(r.length),4,!0)]),a&&f.push([`uv0`,new z(a,r,2,!0)]),l&&f.push([`tangent`,new z(l,r,4,!0)]);let h=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:n,layerViewUid:this._context.layerViewUid}),_=this._getOrCreateMaterial(e,t),v=new qr(_,f,null,0,h);v.transformation=d,v.localOrigin=g,p.push(v)}return m&&this.logger.warn(`Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals.`),{geometries:p,objectTransformation:u}}_updateMaterialParameters(e){this._materialInfoCache.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachClonedMaterial((e,t)=>{t.setParameters(e.parameters)})}_validateVertexSpace(e){let{_context:{graphicsCoreOwner:{view:{state:{viewingMode:t}}}}}=this,{vertexSpace:n}=e;return t!==2||n.type!==`local`||(this.logger.warn(`Displaying a mesh with a local vertex space in a view in local viewing mode is not supported.`),!1)}test(){return{...super.test(),materials:this._materialInfoCache.materials}}get _materialColor(){return this.symbolLayer.material?.color}},Pc=class{constructor(e,t,n){this.normals=e,this.indices=t,this.didFlipNormals=n}};function Fc(e,t){return t.faces??bn(e.vertexAttributes.position.length/3)}function Ic(e,t,n,r){switch(n.shading||`flat`){default:case`source`:return Rc(e,t,n,r);case`flat`:return Lc(e,r);case`smooth`:return zc(e,r)}}function Lc(e,t){let n=Ei(t.length),r=Array(3*t.length);for(let i=0;i<t.length;i+=3){let a=Vc(e,t,i,tl);for(let e=0;e<3;e++)n[i+e]=a[e],r[i+e]=i/3}return new Pc(n,r,!1)}function Rc(e,t,n,r){if(t==null)return Lc(e,r);let i=!1;if(!n.trustSourceNormals)for(let n=0;n<r.length;n+=3){Vc(e,r,n,tl);for(let e=0;e<3;e++){let a=3*r[n+e];q[0]=t[a],q[1]=t[a+1],q[2]=t[a+2],M(tl,q)<0&&(t[a]=-t[a],t[a+1]=-t[a+1],t[a+2]=-t[a+2],i=!0)}}return new Pc(t,r,i)}function zc(e,t){let n={};for(let r=0;r<t.length;r+=3){let i=Vc(e,t,r,tl);for(let e=0;e<3;e++){let a=t[r+e],o=n[a];o||(o={normal:j(),count:0},n[a]=o),E(o.normal,o.normal,i),o.count++}}let r=Ei(3*t.length),i=Array(3*t.length);for(let e=0;e<t.length;e++){let a=n[t[e]];a.count!==1&&(F(a.normal,a.normal),a.count=1);for(let t=0;t<3;t++)r[3*e+t]=a.normal[t];i[e]=e}return new Pc(r,i,!1)}function Bc(e,t,n,r,i,a){let o=3*t[n],s=3*t[n+1],c=3*t[n+2];r[0]=e[o],r[1]=e[o+1],r[2]=e[o+2],i[0]=e[s],i[1]=e[s+1],i[2]=e[s+2],a[0]=e[c],a[1]=e[c+1],a[2]=e[c+2]}function Vc(e,t,n,r){return Bc(e,t,n,q,J,el),R(J,J,q),R(el,el,q),nn(q,J,el),F(r,q),r}function Hc(e){if(!e)return null;let{scale:t,offset:n,rotation:r}=e;return{scale:t,offset:n,rotation:_t(r)}}function Uc(e=`repeat`){if(typeof e==`string`){let t=Wc(e);return{s:t,t}}return{s:Wc(e.horizontal),t:Wc(e.vertical)}}function Wc(e){switch(e){case`clamp`:return 33071;case`mirror`:return 33648;default:return 10497}}function Gc(e){let t=e.vertexAttributes.color;if(t==null)return!1;for(let e=3;e<t.length;e+=4)if(t[e]!==255)return!0;return!1}function Kc(e,t,n){t.diffuse=e.toUnitRGB(),t.opacity=n.alphaMode===`opaque`?1:e.a}function qc(e){return e.data??e.url}function Jc(e){return e==null?`-`:e instanceof Yt?e.toHex():e.contentHash}function Yc(e){let{offset:t,scale:n,rotation:r}=e??Qc;return`${t[0]},${t[1]},${r},${n[0]},${n[1]}`}function Xc(e){return e.vertexAttributes.color}function Zc(e){return(e.material?.color?.a??0)===1}var Qc=new mn,$c=j(),q=j(),J=j(),el=j(),tl=j(),nl=k(),rl=k(),il=at(),al=[new gn],ol=j(),sl=class{constructor(e,t,n,r,i){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=n,this.elevationContext=r,this._highlightOrderMap=i,this.type=`lod-instance`,this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1,this._highlightName=null}initialize(){}setVisibility(e){let{instanceData:t}=this;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){this.instanceIndex!=null&&(this.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}alignWithElevation(e,t){if(this.elevationAligner){let n=(n,r)=>oi(n,e,this.elevationContext,t,r),r=this.elevationAligner(this,this.elevationContext,e.spatialReference,n,t);r!=null&&(this.alignedSampledElevation=r)}}getCenterObjectSpace(e=j()){return this.instanceData.getCombinedLocalTransform(this.instanceIndex,dl),A(e,this._lodRenderer.baseBoundingSphere.center,dl)}getBoundingBoxObjectSpace(e=at()){this.instanceData.getCombinedLocalTransform(this.instanceIndex,dl);let t=this._lodRenderer.baseBoundingBox;Et(e);for(let n=0;n<8;++n)O(Y,1&n?t[3]:t[0],2&n?t[4]:t[1],4&n?t[5]:t[2]),A(Y,Y,dl),Fe(e,Y);return e}computeAttachmentOrigin(e){this.instanceData.getGlobalTransform(this.instanceIndex,dl),e.render.origin[0]+=dl[12],e.render.origin[1]+=dl[13],e.render.origin[2]+=dl[14],e.render.num++}async getProjectedBoundingBox(e,t,n,r,i){let a=this.getBoundingBoxObjectSpace(i),o=ul,s=Jt(a)?1:o.length;this.instanceData.getGlobalTransform(this.instanceIndex,dl);for(let e=0;e<s;e++){let t=o[e];Y[0]=a[t[0]],Y[1]=a[t[1]],Y[2]=a[t[2]],A(Y,Y,dl),cl[3*e]=Y[0],cl[3*e+1]=Y[1],cl[3*e+2]=Y[2]}if(!e(cl,0,s))return null;Et(a);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let e=0;e<3*s;e+=3){for(let t=0;t<3;t++)a[t]=Math.min(a[t],cl[e+t]),a[t+3]=Math.max(a[t+3],cl[e+t]);c&&n.push({location:cl.slice(e,e+3),screenSpaceBoundingRect:c})}if(t&&(Le(a,ll),this.elevationContext.mode!==`absolute-height`)){let e,n=pa(a,t.service.spatialReference,t);try{e=await t.service.queryElevation(ll[0],ll[1],r,n,`ground`)}catch{}e!=null&&Xt(a,0,0,-this.alignedSampledElevation+e)}return a}addObjectState(e){e.stateType===0&&this.addObjectHighlightState(e)}addObjectHighlightState(e){let t=new Ir(e.highlightName);this._addHighlightId(t),e.addExternal(e=>{this._removeHighlightId(e)},t)}removeObjectState(e){this._highlights.forEach(t=>e.remove(t))}updateHighlights(e){this._highlightOrderMap=e,this._updateHighlightOptions()}_calculateHighlightOptions(){let e=-1,t=null;return this._highlights.forEach(({highlightName:n})=>{let r=this._highlightOrderMap.get(n);r!==void 0&&r>e&&(e=r,t=n)}),t}_addHighlightId(e){this._highlights.add(e),this._updateHighlightOptions()}_removeHighlightId(e){this._highlights.delete(e),this._updateHighlightOptions()}_updateHighlightOptions(){let e=this._calculateHighlightOptions();e!==this._highlightName&&(this._highlightName=e,this.instanceData.setHighlight(this.instanceIndex,e))}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}get instanceData(){return this._lodRenderer.instanceData}},cl=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Y=j(),ll=j(),ul=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],dl=k();function fl(e,t){let n=e.stageResources.geometries.map(t=>new Ga(new Ja(t),e.stageResources.textures)),r=e.lodThreshold==null||e.lodThreshold===0&&t>0?ml(n):e.lodThreshold;return new Ya(n,r,e.pivotOffset)}function pl(e){return new Ka(e.map((e,t)=>fl(e,t)))}function ml(e){let t=e.reduce((e,t)=>e+t.numTriangles,0);return Math.sqrt(t*hl/Math.PI)}var hl=20;async function gl(e){if(e==null||e.styleName==null&&e.styleUrl==null)return null;let t=e.name;if(t==null)throw new a(`symbolstyleutils:style-symbol-reference-name-missing`,`Missing name in style symbol reference`);let n={portal:e.portal},r=await Se(e,n).catch(()=>null);if(r===null)return null;let i=yr(t,r.data);if(i&&!i.formatInfos?.some(e=>e.type===`gltf_basisu`))return null;let o=await vr(r,t,n,oe,{acceptedFormats:[`web-gltf-basisu`,`web-gltf`,`web`]}).catch(()=>null);if(o===null||o.type!==`point-3d`)return null;let s=o.symbolLayers.items[0];return s.type===`object`?s.resource:null}var _l=class extends vi{constructor(e,t){super(e=>new br(this._instanceData.view.boundingSphere.getVec(e,vl)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=t,this._tmpSphere=new br,this._tmpMat4=k()}addInstance(e){let t=this._instanceData.view.boundingSphere,n=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);A(this._tmpSphere.center,this._boundingSphere.center,n),this._tmpSphere.radius=this._boundingSphere.radius*Tn(n),t.setVec(e,this._tmpSphere.toVec4()),this.add([e])}removeInstance(e){this.remove([e])}},vl=Je(),yl=class{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,n){let r=n.computeScreenPixelSizeAt(e),i=this._worldSpaceRadius*t/r,a=0;for(let e=1;e<this._minScreenSpaceRadii.length;++e)i>=this._minScreenSpaceRadii[e]&&(a=e);return a}},bl=class{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach((e,t)=>{e!=null&&this._repository.release(this._material,t)})}load(e,t,n){if(!this._material.produces.get(t)?.(n))return null;this._map.has(n)||this._map.set(n,this._repository.acquire(this._material,t,n));let r=this._map.get(n);if(r){if(r.ensureResources(e)===2)return r;this._repository.requestRender()}return null}},xl=class{constructor(e,t){this.geometry=t;let n=e.renderContext.rctx,r=t.renderGeometry,{material:i,layout:a,buffer:o}=r;this._materials=e.materials,i.setParameters({instancedDoublePrecision:!0}),this.glMaterials=new bl(i,this._materials),this.vbo=new Tr(n,Di(a),o),this.vao=new Wi(n,this.vbo)}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get material(){return this.geometry.renderGeometry.material}get layout(){return this.geometry.renderGeometry.layout}get boundingInfo(){return this.geometry.boundingInfo}get numTriangles(){return this.numVertices/3}get numVertices(){return this.geometry.renderGeometry.numVertices}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,t,n,r,i,a,o,s){return this.geometry.intersect(e,t,n,r,i,a,o,s)}},Sl=class e{static async create(t,n,r){let i=await Promise.allSettled(n.components.map(e=>t.controller.schedule(()=>new xl(t,e.geometry),r))),a=i.map(e=>e.status===`fulfilled`?e.value:null).filter(de);if(he(r)||a.length!==i.length){a.forEach(e=>e.destroy()),mt(r);for(let e of i)if(e.status===`rejected`)throw e.reason}return new e(n.minScreenSpaceRadius,a)}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,t,n,r,i,a,o){this.components.forEach(s=>s.intersect(e,t,n,r,i,a,this.boundingSphere,o))}get boundingBox(){if(this._boundingBox==null){let e=Et();this.components.forEach(t=>{t.boundingInfo!=null&&(Fe(e,t.boundingInfo.bbMin),Fe(e,t.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){let e=this.boundingBox,t=j();Le(e,t),this._boundingSphere={center:t,radius:.5*bt(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,t)=>e+t.numTriangles,0)}},Cl=e=>{let t=e.baseBoundingSphere.radius,n=e.levels.map(e=>e.minScreenSpaceRadius);return new yl(t,n)},X=class extends Ui{constructor(e,t){super(e),this.type=3,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceDatas=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new xi,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[2,e=>this._produces(e)],[4,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new to({shaderTransformation:e.shaderTransformation},e.symbol.materialParameters),this.addHandles(t.registerTask(Be.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=eo(this.symbol.materialParameters),this._glInstanceBufferLayout=Di(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on(`instances-changed`,()=>this._requestUpdateCycle()),this._instanceData.events.on(`instance-transform-changed`,({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)}),this._instanceData.events.on(`instance-visibility-changed`,({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)}),this._instanceData.events.on(`instance-highlight-changed`,()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDatas.values()]}get _allRenderInstanceDataExceptHighlightShadow(){let e=[this._defaultRenderInstanceData];for(let t of this._highlightRenderInstanceDatas)t[0]!==`default`&&e.push(t[1]);return e}hasHighlight(e){return this._highlightRenderInstanceDatas.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmitters(){return this._levels.some(e=>e.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((e,t)=>t.reduce((e,t)=>e+t.usedMemory,e),this._levels.reduce((e,t)=>e+t.components.reduce((e,t)=>e+t.usedMemory,0),0))}get renderStats(){let e=this._instanceData.size,t=[];return this._levels.forEach((e,n)=>{let r=this._allRenderInstanceData[0][n].size+this._allRenderInstanceData[1][n].size,i=e.triangleCount;t.push({renderedInstances:r,renderedTriangles:r*i,trianglesPerInstance:i})}),{totalInstances:e,renderedInstances:t.reduce((e,t)=>e+t.renderedInstances,0),renderedTriangles:t.reduce((e,t)=>e+t.renderedTriangles,0),levels:t}}_createRenderInstanceDataArray(){let{rctx:e}=this._context.renderContext;return this.symbol.levels.map(t=>new Za(e,this._instanceBufferLayout))}async initializeRenderContext(e,t){this._context=e,this._defaultRenderInstanceData=this._createRenderInstanceDataArray();let n=await Promise.allSettled(this.symbol.levels.map(n=>Sl.create(e,n,t))),r=n.map(e=>e.status===`fulfilled`?e.value:null).filter(de);if(he(t)||r.length!==n.length){r.forEach(e=>e.destroy()),mt(t);for(let e of n)if(e.status===`rejected`)throw e.reason}this._levels=r,this._levelSelector=Cl(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceDatas.forEach(e=>e.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(e=>e.components.some(e=>e.material.produces.get(4)?.(0)))}hasHighlights(){return Pt(this._highlightRenderInstanceDatas,e=>e.some(e=>e.size>0))}_produces(e){return(e!==8||this.hasHighlights())&&(e!==4||this.hasHighlight(`default`))}prepareRender(e){if(!Ji.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){let t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&=(this.runTask(ne),!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;let t=this._getInstanceDatas(e);if(!t)return null;let n=[],r=this.levels;return t.forEach(t=>r.forEach(({components:r},i)=>r.forEach(r=>n.push(this._beginComponent(e,t[i],r))))),n}render(e,t){let n=this._getInstanceDatas(e);if(!n||t==null)return;let r=0,i=this.levels;n.forEach(n=>i.forEach(({components:i},a)=>i.forEach(i=>this._renderComponent(e,t[r++],n[a],i,a)))),e.rctx.unbindBuffer(34962),e.rctx.bindVAO(null)}_getInstanceDatas(e){let{output:t,bind:n}=e,r=t===8,i=t===4,a=t!==5;if(!r&&!i)return a?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;let{_highlightRenderInstanceDatas:o}=this;if(a){if(r){let e=n.highlight?.name;if(!e)return null;let t=o.get(e);return t?[t]:null}let e=o.get(Gt);return i?e?[e]:null:Array.from(o.values())}return null}intersect(e,t,n,r){if(!this.baseMaterial.visible||this._octree==null)return;let i=j();R(i,r,n);let a=i=>{this._instanceData.getCombinedModelTransform(i,Ol),e.transform.set(Ol),A(kl,n,e.transform.inverse),A(Al,r,e.transform.inverse);let a=this._instanceData.getState(i),o=this._instanceData.getLodLevel(i),s=this._levels.length;4&a&&(Bn(!!(18&a),`invalid instance state`),Bn(o>=0&&o<s,`invaid lod level`),this._levels[o].intersect(e,t,kl,Al,i,this.metadata,s))};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(a):this._octree.forEachAlongRay(n,i,a)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){let e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new _l(e,this.baseBoundingSphere);for(let n=0;n<e.capacity;++n)18&t.get(n)&&this._octreeCached.addInstance(n)}return this._octreeCached}_invalidateOctree(){this._octreeCached=tn(this._octreeCached)}queryDepthRange(e){if(this._octree==null)return new Ci;let t=e.viewForward,n=this._octree.findClosest(t,1,e.frustum),r=this._octree.findClosest(t,-1,e.frustum);if(n==null||r==null)return new Ci;let i=e.eye,a=this._instanceData.view;a.boundingSphere.getVec(n,Dl),R(Dl,Dl,i);let o=M(Dl,t)-Dl[3];a.boundingSphere.getVec(r,Dl),R(Dl,Dl,i);let s=M(Dl,t)+Dl[3];return new Ci(o,s)}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.startUpdateCycle()))}get readyToRun(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){let{_enableLevelSelection:t,_camera:n,_levelSelector:r}=this;this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.beginUpdate()));let i=this._instanceData,o=i.view,s=i.size,c=i.capacity,l=this._instanceIndex,u=Math.ceil(c/500),{_highlightRenderInstanceDatas:d}=this;for(let f=0;f<s&&!e.done;++f){l===this._cycleStartIndex&&this._startUpdateCycle();let f=o.state.get(l),p=0;if(!(1&f)){l=l+1===c?0:l+1,s++;continue}let m=o.lodLevel.get(l);if(2&f&&this._defaultRenderInstanceData[m].freeTail(),16&f){let e=i.geHighlightOptionsPrev(l);if(e){let t=d.get(e);if(!t)throw new a(`internal:lod-renderer`,`Internal error in lodRenderer`);t[m].freeTail(),t.every(e=>e.isEmpty)&&(t.forEach(e=>e.destroy()),d.delete(e))}}if(32&f)i.freeInstance(l);else if(4&f){let e=0;if(t&&(o.modelOrigin.getVec(l,El),e=r.selectLevel(El,i.getCombinedMedianScaleFactor(l),n)),p=-83&f,e>=0)if(8&f){let t=i.getHighlightName(l);if(t){let n=()=>{let e=this._createRenderInstanceDataArray();return e.forEach(e=>e.beginUpdate()),e},r=tt(d,t,n);if(e>=r.length)throw new a(`internal:lod-renderer`,`LodRenderer internal error - missing lodLevel ${e}`);wl(r[e],o,l)}p|=16}else wl(this._defaultRenderInstanceData[e],o,l),p|=2;o.state.set(l,p),o.lodLevel.set(l,e)}else p=-83&f,o.state.set(l,p);let h=!!(18&f),g=!!(18&p);this._octreeCached!=null&&(!h&&g?this._octreeCached.addInstance(l):h&&!g?this._octreeCached.removeInstance(l):h&&g&&64&f&&(this._octreeCached.removeInstance(l),this._octreeCached.addInstance(l))),l=l+1===c?0:l+1,l%u===0&&e.madeProgress(),h!==g&&this.metadata.notifyGraphicVisibilityChanged(l),g&&64&f&&this.metadata.notifyGraphicGeometryChanged(l)}this._instanceIndex=l,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.endUpdate())),this._context.requestRender()}_beginComponent(e,t,n){return t.size===0?null:n.glMaterials.load(e.rctx,e.bind.slot,e.output)?.beginSlot(e.bind)}_renderComponent(e,t,n,r,i){if(!t)return;let{bind:a,rctx:o}=e;o.runAppleAmdDriverHelper();let s=o.bindTechnique(t,a,r.material.parameters,Ml),c=this._glInstanceBufferLayout;s.assertCompatibleVertexAttributeLocations(r.vao,mr(c)),o.bindVAO(r.vao),Ji.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===0&&(s.setUniform4fv(`externalColor`,jl[Math.min(i,jl.length-1)]),s.setUniform1i(`symbolColorMixMode`,_i.replace));let l=n.capacity,u=n.headIndex,d=n.tailIndex,f=n.firstIndex,p=(e,i)=>{st(o,s.locations,n.buffer,e),o.drawArraysInstanced(t.primitiveType,0,r.numVertices,i-e)};r.material.transparent&&f!=null?u>d?(Bn(f>=d&&f<=u,`invalid firstIndex`),p(f,u),p(d,f)):u<d&&(f<=u?(Bn(f>=0&&f<=u,`invalid firstIndex`),p(f,u),p(d,l),p(0,f)):(Bn(f>=d&&f<=l,`invalid firstIndex`),p(f,l),p(0,u),p(d,f))):u>d?p(d,u):u<d&&(p(0,u),p(d,l))}};function wl(e,t,n){let r=e.allocateHead();Tl(t,n,e.view,r)}function Tl(e,t,n,r){ii(e.modelOrigin,t,n.modelOriginHi,n.modelOriginLo,r),n.model.copyFrom(r,e.model,t),n.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&n.color&&n.color.copyFrom(r,e.color,t),e.olidColor&&n.olidColor&&n.olidColor.copyFrom(r,e.olidColor,t),e.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(r,e.featureAttribute,t)}N([f({constructOnly:!0})],X.prototype,`symbol`,void 0),N([f({constructOnly:!0})],X.prototype,`metadata`,void 0),N([f({constructOnly:!0})],X.prototype,`shaderTransformation`,void 0),N([f()],X.prototype,`_instanceData`,void 0),N([f()],X.prototype,`_cycleStartIndex`,void 0),N([f({readOnly:!0})],X.prototype,`_enableLevelSelection`,null),N([f()],X.prototype,`_updateCyclesWithStaticCamera`,void 0),N([f({readOnly:!0})],X.prototype,`readyToRun`,null),X=N([Ce(`esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer`)],X);var El=j(),Dl=Je(),Ol=k(),kl=j(),Al=j(),jl=[Ke(1,0,1,1),Ke(0,0,1,1),Ke(0,1,0,1),Ke(1,1,0,1),Ke(1,0,0,1)],Ml=new Qa,Nl=class{constructor(e,t,n,r,i,a,o,s,c,l,u=null){this.lodResources=e,this.lodRenderer=t,this.stageResources=n,this.resourceSize=r,this.isEsriSymbolResource=i,this.isWosr=a,this.resourceBoundingBox=o,this.symbolSize=s,this.extentPadding=c,this.physicalBasedRenderingEnabled=l,this.pivotOffset=u}},Pl=class extends Va{getCachedSize(){let[e,t,n]=this._resources==null?[1,1,1]:this._resources.symbolSize;return{width:e,depth:t,height:n}}constructor(e,t,n,r){super(e,t,n,r,Ll(t)),this._resources=null,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=[],this.skipHighSymbolLodsChanged=!1,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=n.physicalBasedRenderingEnabled}async doLoad(e){if(!this._drivenProperties.size){let e=_a(this.symbolLayer);if(e)throw Error(e)}if(this._isPrimitive){let t=this.symbolLayer.resource,n=t&&Xa(t?.primitive)?t.primitive:ee;this._resources=await this._createResourcesForPrimitive(n,e)}else{let t=await gl(this.symbol.styleOrigin),n=t?.href??this.symbolLayer.resource?.href;this._resources=await this._createResourcesForUrl(n,e)}this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.updateComplexity()}get extentPadding(){return this._resources==null?0:this._resources.extentPadding}get _isPrimitive(){return this._primitive!=null}get lodRenderer(){return this._resources?.lodRenderer}get materials(){return this._resources?.stageResources.materials??[]}async _createResourcesForPrimitive(e,t){let n=this.symbolLayer,r=at(Ge(e)),i=Vt(_e(r)),a=Vt(Ye(i,n)),o=Ct(a),s=n?.material,c={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:no,ambient:qt,diffuse:qt,opacity:1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:n.castShadows,emissiveStrengthFromSymbol:s?.emissive?.strength??0,emissiveSource:1,offsetTransparentBackfaces:!1,drivenOpacity:this.needsDrivenTransparentPass},l=!!c.usePBR,u=this.symbol;u.type===`point-3d`&&u.verticalOffset&&(c.verticalOffset=new ba(u.verticalOffset),c.castShadows=!1),this._context.screenSizePerspectiveEnabled&&(c.screenSizePerspective=this.view.screenSizePerspective.parameters),this._hasDrivenColorOrOpacity?c.externalColor=Ra:c.externalColor=this._materialColor?.toUnitRGBA()??w,this._fastUpdates=Zi(this._context.renderer,this._fastVisualVariableConvertOptions(r,a,i,null)),c.instanced=!0,this._fastUpdates?(Object.assign(c,this._fastUpdates.materialParameters),c.instancedFeatureAttribute=!0):this._hasDrivenColorOrOpacity&&(c.instancedColor=!0);let d=new $a(c,this._context);d.setParameters({cullFace:Rl(d.transparent)});let f=qa(e,d);if(!f)throw Error(`Unknown object symbol primitive: ${e}`);let p=await this._createStageResources(f,l,t),m=await this._createLodRenderer(f,t);return new Nl(f,m,p,i,!1,!1,r,a,o,l)}async _createResourcesForUrl(e,t){let n={instanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},r={spherical:this._context.spherical,materialParameters:n,cache:this._context.sharedResources.objectResourceCache,compressionOptions:{compressionTracker:this._context.compressionTracker,compressionCallback:()=>this.updateComplexity()}};this._fastUpdates=Zi(this._context.renderer,this._fastVisualVariableConvertOptions(null,null,null,null)),this._fastUpdates?(Object.assign(r.materialParameters,this._fastUpdates.materialParameters),r.materialParameters.instancedFeatureAttribute=!0):this._hasDrivenColorOrOpacity&&(r.materialParameters.instancedColor=!0);let i=this.symbol;if(i.type===`point-3d`&&i.verticalOffset){let{screenLength:e,minWorldLength:t,maxWorldLength:n}=i.verticalOffset;r.materialParameters.verticalOffset={screenLength:P(e),minWorldLength:t||0,maxWorldLength:n??1/0},r.materialParameters.castShadows=!1}let a=this._context.physicalBasedRenderingEnabled;r.signal=t,r.usePBR=a,r.useEmissive=this.view.stage.renderView.renderingContext.driverTest.floatBufferBlend.result,r.skipHighLods=this._context.skipHighSymbolLods;let o=this.symbolLayer.material;r.materialParameters.emissiveStrengthFromSymbol=o?.emissive?.strength??1,r.materialParameters.emissiveSource=He(o?.emissive?.source??`emissive`);let s=await bo(e,r),c=s.isEsriSymbolResource,l=s.isWosr,u=pl(s.lods),d=this._context,f=this._getExternalColorParameters(o),p=this.needsDrivenTransparentPass,m=u.getMaterials();m.forEach(e=>{e.setParameters({...f,drivenOpacity:p}),d.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:this.view.screenSizePerspective.parameters})});let h=s.referenceBoundingBox,g=Vt(_e(h)),_=Vt(u.levels[0].pivotOffset),v=Vt(Ye(g,this.symbolLayer)),y=Ct(v),b=this._fastUpdates;Qi(b,this._context.renderer,this._fastVisualVariableConvertOptions(h,v,g,_))&&m.forEach(e=>e.setParameters(b.materialParameters));let x=await this._createStageResources(u,a,t),S=await this._createLodRenderer(u,t);return new Nl(u,S,x,g,c,l,h,v,y,a,_)}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createStageResources(e,t,n){let r=this._context.stage,i=e.getMaterials();t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();let a=e.getTextures();r.addTextures(a),this._addDisposeResource(()=>{a.forEach(e=>e.unload()),r.removeTextures(a)}),await Promise.all(a.map(e=>this._context.stage.schedule(()=>e.load(r.renderView.renderingContext),n))),mt(n);let o=e.getEngineGeometries();return{materials:i,textures:a,geometries:o}}async _createLodRenderer(e,t){let n=this._context.stage,r={layerViewUid:this._context.layerViewUid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},i=this._fastUpdates,a=new X({symbol:e,metadata:r,shaderTransformation:i?{applyTransform:(e,t,n)=>{e.getFeatureAttribute(t,Hl),Ne(n,Ki(i.materialParameters,Hl,n))},scaleFactor:(e,t,n)=>{t.getFeatureAttribute(n,Hl),$i(e,i.materialParameters,Hl)}}:null},this._context.scheduler);return a.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource(()=>{n.removeRenderPlugin(a),a.destroy()}),await n.addRenderPlugin(a,t),a}_getExternalColorParameters(e){let t={};if(t.externalColor=Ra,!this._drivenProperties.color&&e?.color!=null){let n=e.color.toUnitRGBA();this._drivenProperties.opacity&&(n[3]=NaN),t.externalColor=n}return t}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(e=>e()),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let n=Ha(t.geometry);if(n==null)return this.logger.warn(`unsupported geometry type for object symbol: ${t.geometry.type}`),null;let r=this.createElevationContextForGraphic(t),i=e.renderingInfo;return this._createAs3DShape(t,n,i,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(this._resources==null)return;let e=this._getLayerOpacity(),t=this._resources.stageResources.materials;for(let n=0;n<t.length;n++){let r=t[n];r.setParameters({layerOpacity:e}),this._isPrimitive&&r.setParameters({cullFace:Rl(r.transparent)})}}layerScreenSizePerspectiveChanged(){if(this._resources==null)return;let e=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null;for(let t of this._resources.stageResources.materials)t.setParameters({screenSizePerspective:e})}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,pi)}slicePlaneEnabledChanged(){if(this._resources==null)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(let e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(this._resources==null)return!0;let{stageResources:e,isWosr:t}=this._resources;for(let n of e.materials)this._isPrimitive?n.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||n.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this._hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this._hasLoadedPBRTextures=!0,!1)}applyRendererDiff(e,t){if(this._resources==null)return 0;let{stageResources:{materials:n},lodRenderer:r,resourceBoundingBox:i,symbolSize:a,resourceSize:o,pivotOffset:s}=this._resources;for(let c in e.diff){if(c!==`visualVariables`||!Qi(this._fastUpdates,t,this._fastVisualVariableConvertOptions(i,a,o,s)))return 0;for(let e of n)e.setParameters(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged()}return 2}computeComplexity(){if(this._resources==null)return super.computeComplexity();let e=this._resources.lodResources,t=wa(e.levels),n=e.computeUsedMemory(),r={...Ea(this.symbol,this.symbolLayer),resourceBytes:n};return new xa({verticesPerFeature:t,memory:r})}_hasLodRenderer(){return this._resources!=null}_createAs3DShape(e,t,n,r,i){if(!this._hasLodRenderer()||this._resources==null)return null;let a=this.getFastUpdateAttrValues(e),o=this._context.clippingExtent;if(Fn(t,zl,this._context.elevationProvider.spatialReference),o!=null&&!At(o,zl))return null;let s=Il(r),c=this._computeGlobalTransform(t,r,Vl,Ul),l=this._computeLocalTransform(this._resources,this.symbolLayer,n,Bl),u=this._resources.lodRenderer.instanceData,d=u.addInstance();this._instanceIndexToGraphicUid.set(d,i),u.setLocalTransform(d,l,!1),u.setGlobalTransform(d,c),a&&u.setFeatureAttribute(d,a),this._fastUpdates==null&&this._hasDrivenColorOrOpacity&&u.setColor(d,this._getDrivenUInt8ColorWithNaNSupport(n,this._materialColor,!this._isPrimitive));let f=this._context.stage.renderView.olidRenderHelper;if(f){let e=f.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid});u.setObjectAndLayerIdColor(d,e)}let p=new sl(this,d,Ia,r,this._context.stage.view.state.highlightOrderMap);return s&&(p.alignedSampledElevation=Ul.sampledElevation),p.needsElevationUpdates=pi(r.mode),La(p,t,this._context.elevationProvider),p}_computeGlobalTransform(e,t,n,r){return oi(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r),zl[0]=e.x,zl[1]=e.y,zl[2]=r.z,In(e.spatialReference,zl,n,this._context.renderCoordsHelper.spatialReference),n}_computeLocalTransform(e,t,n,r){return un(r),this._applyObjectRotation(n,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,n,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,n){if(this._fastUpdates?.requiresShaderTransformation)return;let r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,i=ua(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);i[0]===1&&i[1]===1&&i[2]===1||wt(n,n,i)}prepareSymbolLayerPatch(e){if(e.diff.type!==`partial`)return;let t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(this._resources==null)return!0;let n=e.geometry;if(!n)return!1;let r=Ha(n);if(r==null)return!1;let i=this.getGeometryElevationMode(n),{elevationContext:a}=t;return a.mode===i&&(a.updateFeatureExpressionFeature(e,this._context.layer),this._computeGlobalTransform(r,a,Vl,Ul),Il(a)&&(t.alignedSampledElevation=Ul.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(t.instanceIndex,Vl,!0),La(t,r,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition)||this._resources==null)return;let n=(e,t,n)=>(e!=null&&e.type===`complete`?e.newValue:t)??n,r=n(t.heading,this.symbolLayer.heading,0),i=n(t.tilt,this.symbolLayer.tilt,0),a=n(t.roll,this.symbolLayer.roll,0),o=n(t.width,this.symbolLayer.width,void 0),s=n(t.height,this.symbolLayer.height,void 0),c=n(t.depth,this.symbolLayer.depth,void 0),l=n(t.anchor,this.symbolLayer.anchor,void 0),u=n(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;let d={heading:r,tilt:i,roll:a,anchor:l,anchorPosition:u},f=this._resources;this.loadStatus===1&&e.symbolLayerStatePatches.push(()=>{f.symbolSize=Vt(Ye(f.resourceSize,{width:o,height:s,depth:c,isPrimitive:this._isPrimitive}))}),e.graphics3DGraphicPatches.push(({instanceIndex:e},t)=>{let n=this._computeLocalTransform(f,d,t,Bl);f.lodRenderer.instanceData.setLocalTransform(e,n,!0)})}_preparePatchColor(t,n){if(!n.material||n.material.type!==`partial`)return;let r=n.material.diff;if(!r.color||r.color.type!==`complete`||r.color.newValue==null||r.color.oldValue==null)return;let i=r.color.newValue,a=i==null?e:i.toUnitRGBA();delete r.color;let o=this._resources;if(o==null)return;let s=this._isPrimitive;t.graphics3DGraphicPatches.push(({instanceIndex:e})=>{if(this._hasDrivenColorOrOpacity)o.lodRenderer.instanceData.setColor(e,a);else{let e={externalColor:a};for(let t of o.stageResources.materials)t.setParameters(e),s&&t.setParameters({cullFace:Rl(t.transparent)})}})}_applyObjectRotation(e,t,n){if(!this._fastUpdates?.requiresShaderTransformation||!t)return va(e.heading,e.tilt,e.roll,n)}_applyAnchor(e,t,n){if(this._fastUpdates?.requiresShaderTransformation)return;let r=Fl(e.resourceBoundingBox,e.pivotOffset,t);r&&Oe(n,n,r)}_fastVisualVariableConvertOptions(e,t,n,r){let i=e==null?qt:Vt(_e(e)),a=e==null?xt:Fl(e,r,this.symbolLayer),o=this._context.renderCoordsHelper.unitInMeters,s=ua(t??void 0,t,n,o),c=I(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new Gi({supports:{size:!0,color:!0,rotation:!0,opacity:!1},modelSize:i,symbolSize:t??qt,unitInMeters:o,anchor:a,scale:s,rotation:c,fallbackColor:this._getFallbackOpacityAndColor(),fallbackSize:s})}get _primitive(){let{resource:e}=this.symbolLayer;return e?.href==null?e?.primitive??`sphere`:null}_getFallbackOpacityAndColor(){return this._materialColor?.toUnitRGBA()??(this._isPrimitive?w:Ra)}get _materialColor(){return this.symbolLayer.material?.color}};function Fl(e,t,n){let r=j();switch(n.anchor){case`center`:T(r,Le(e)),ae(r,r);break;case`top`:{let t=Le(e);O(r,-t[0],-t[1],-e[5]);break}case`bottom`:{let t=Le(e);O(r,-t[0],-t[1],-e[2]);break}case`relative`:{let t=Le(e),i=_e(e),a=n.anchorPosition,o=a?I(a.x,a.y,a.z):xt;sn(r,i,o),E(r,r,t),ae(r,r);break}default:t==null?T(r,xt):ae(r,t)}return r}function Il(e){return e.mode!==`absolute-height`}function Ll(e){return(e.material?.color?.a??0)===1&&e.resource?.href==null}function Rl(e){return e?0:2}var zl=j(),Bl=k(),Vl=k(),Hl=Je(),Ul=new di,Wl=class{constructor(e,t,n,r,i){this.vertices=e,this.positionsES=t,this.offset=r,this.positions=i;let a=e.length,o=Math.floor(a/2),s=this.offset+3*o,c=n[s],l=n[s+1],u=n[s+2];this.origin=I(c,l,u);let d=this.offset+3*a;for(let e=this.offset;e<d;e+=3)i[e]=n[e]-c,i[e+1]=n[e+1]-l,i[e+2]=n[e+2]-u;this.updatePathVertexInformation()}updatePathVertexInformation(){let e=this.vertices.length,t=this.vertices[0],n=this.offset,r=this.positions;t.vRight[0]=r[n+3]-r[n],t.vRight[1]=r[n+4]-r[n+1],t.vRight[2]=r[n+5]-r[n+2],n+=3;let i=Ct(t.vRight);t.vMinSiblingLength=i,F(t.vRight,t.vRight);let a=t;for(let t=1;t<e;++t){let o=this.vertices[t];if(o.vLeft=a.vRight,t<e-1){o.vRight[0]=r[n+3]-r[n],o.vRight[1]=r[n+4]-r[n+1],o.vRight[2]=r[n+5]-r[n+2];let e=Ct(o.vRight);o.vMinSiblingLength=Math.min(i,e),i=e,F(o.vRight,o.vRight)}else T(o.vRight,o.vLeft),o.vMinSiblingLength=i;a=o,n+=3}}},Gl=class{constructor(e,t,n,r,i,a={}){this.path=e,this.profile=t,this.extruder=n,this.startCap=r,this.endCap=i,this.options=a,this._extrusionVertexCount=0;let o=this.path.vertices.length-2;this.numExtrusionProfiles=n.numProfilesPerJoin()*o+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.startCap.vertexBufferStart=this.numVerticesTotal;let s=this.startCap.numVertices;this.numVerticesTotal+=s,this.endCap.vertexBufferStart=this.numVerticesTotal;let c=this.endCap.numVertices;this.numVerticesTotal+=c,this.pathVertexData=wn(1*this.numVerticesTotal),this.profileRightAxes=ao(2*this.numVerticesTotal),this.profileUpAxes=ao(2*this.numVerticesTotal),this.profileVertexAndNormals=ma(4*this.numVerticesTotal),this.profileAuxData=ma(3*this.numVerticesTotal),this.positions=Ti(e.positions,e.offset,3*e.vertices.length),this._rebuildGeometry(),this._buildTopology()}emitVertex(e,t,n,r,i){let a=4*this._extrusionVertexCount;if(this.profileVertexAndNormals[a]=n[0],this.profileVertexAndNormals[a+1]=n[1],this.profileVertexAndNormals[a+2]=r[0],this.profileVertexAndNormals[a+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,a=3*this._extrusionVertexCount,i){let t=this.path.vertices[e],n=t.maxStretchDistance;this.profileAuxData[a]=t.rotationRight[0]*n,this.profileAuxData[a+1]=t.rotationRight[1]*n}else this.profileAuxData[a]=this.profileAuxData[a+1]=0;this.profileAuxData[a+2]=0,oo(this.profileRightAxes,this._extrusionVertexCount,t.right[0],t.right[1],t.right[2]),oo(this.profileUpAxes,this._extrusionVertexCount,t.up[0],t.up[1],t.up[2]),++this._extrusionVertexCount}emitCapVertex(e,t,n,r,i,a){let o=4*this._extrusionVertexCount;this.profileVertexAndNormals[o]=n[0],this.profileVertexAndNormals[o+1]=n[1],this.profileVertexAndNormals[o+2]=r[0],this.profileVertexAndNormals[o+3]=r[1],o=3*this._extrusionVertexCount,this.profileAuxData[o]=i,this.profileAuxData[o+1]=a,this.profileAuxData[o+2]=1,oo(this.profileRightAxes,this._extrusionVertexCount,t.right[0],t.right[1],t.right[2]),oo(this.profileUpAxes,this._extrusionVertexCount,t.up[0],t.up[1],t.up[2]),this.pathVertexData[this._extrusionVertexCount]=e,++this._extrusionVertexCount}_rebuildGeometry(){this._extrusionVertexCount=0;let{positions:e,offset:t,vertices:n}=this.path;this.positions=Ti(e,t,3*n.length);let r=0,i=(e,t,n,i,a)=>this.emitCapVertex(r,e,t,n,i,a),a=(e,t,n,i)=>this.emitVertex(r,e,t,n,i);for(this.startCap.rebuildConnectingProfileGeometry(n[r],this.profile,i),r=1;r<n.length-1;++r)this.extruder.extrude(n[r],this.profile,a);this.endCap.rebuildConnectingProfileGeometry(n[r],this.profile,i),r=0,this.startCap.rebuildCapGeometry(n[r],i),r=n.length-1,this.endCap.rebuildCapGeometry(n[r],i)}_buildTopology(){let e=this.profile.vertices.length,t=this.profile.numSegments,n=this.numExtrusionProfiles-1,r=3*(2*(t*n));this.startCap.indexBufferStart=r,this.startCap.firstProfileVertexIndex=0,r+=this.startCap.numIndices,this.endCap.indexBufferStart=r,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1);let i=[],a=[],o=(e,t,n)=>{i.push(e),i.push(t),i.push(n),a.push(this.pathVertexData[e]),a.push(this.pathVertexData[t]),a.push(this.pathVertexData[n])};for(let r=0;r<t;++r){let t=this.profile.indices[2*r],i=this.profile.indices[2*r+1];for(let r=0;r<n;++r){let n=r*e+t,a=(r+1)*e+i,s=r*e+i;o(n,(r+1)*e+t,a),o(n,a,s)}}this.startCap.buildTopology(this.path.vertices[0],o),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],o),this.vertexIndices=Cn(i),this.pathVertexIndices=Cn(a)}onPathChanged(){this._rebuildGeometry()}},Kl=class{rebuildConnectingProfileGeometry(e,t,n){for(let r=0;r<t.vertices.length;++r)n(e.frame,t.vertices[r],t.normals[r],0,0)}},ql=class extends Kl{constructor(){super(),this.numVertices=0,this.numIndices=0}rebuildCapGeometry(){}buildTopology(){}},Jl=class extends Kl{constructor(e,t=0,n=!1){super(),this.profile=e,this.profilePlaneOffset=t,this.flip=n}get numVertices(){return this.profile.vertices.length}get numIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,n){let r=this.profilePlaneOffset;for(let i=0;i<t.vertices.length;++i)n(e.frame,t.vertices[i],t.normals[i],r,0)}rebuildCapGeometry(e,t){let n=this.profile,r=this.flip?1:-1,i=this.profilePlaneOffset,a=Zl;l(a,0,0);for(let o=0;o<n.vertices.length;++o)t(e.frame,n.vertices[o],a,i,r)}buildTopology(e,t){let n=this.profile,r=this.vertexBufferStart+n.indices[0];for(let e=1;e<n.numSegments;++e){let i=n.indices[2*e],a=n.indices[2*e+1],o=this.vertexBufferStart+i,s=this.vertexBufferStart+a;this.flip?t(s,o,r):t(r,o,s)}}},Yl=class extends Kl{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}get numVertices(){let e=this.profile.vertices.length*(this.numSegments-1)+this.profile.poles.length;return this.breakNormals&&(e+=this.profile.vertices.length),e}get numIndices(){let e=0,t=this.profile;e+=2*t.numSegments*(this.numSegments-1);for(let n=0;n<t.numSegments;++n){let r=t.indices[2*n],i=t.indices[2*n+1];t.poleIndices[r]===t.poleIndices[i]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){let n=this.profile,r=e.frame,i=.5*this.sign,a=Xl,o=Zl;l(o,0,0);for(let e of n.poles)e.normal?t(r,e.position,e.normal,i,0):t(r,e.position,o,i,this.sign);if(this.breakNormals)for(let e=0;e<n.vertices.length;++e)t(r,n.vertices[e],n.normals[e],0,0);for(let e=0;e<this.numSegments-1;++e){let s=(1-(e+1)/this.numSegments)*Math.PI*.5,c=Math.sin(s),l=Math.cos(s);for(let e=0;e<n.vertices.length;++e){let s=n.poles[n.poleIndices[e]];$e(a,n.vertices[e],s.position),on(a,a,c),s.normal?(p(a,a,s.position),t(r,a,s.normal,i*l,0)):(we(o,a),on(o,o,c),p(a,a,s.position),t(r,a,o,i*l,this.sign*l))}}}buildTopology(e,t){let n=this.profile,r=this.breakNormals?this.vertexBufferStart+n.poles.length:this.firstProfileVertexIndex,i=this.breakNormals?this.vertexBufferStart+n.poles.length+n.vertices.length:this.vertexBufferStart+n.poles.length;for(let e=0;e<n.numSegments;++e){let a=n.indices[2*e],o=n.indices[2*e+1],s=this.vertexBufferStart+n.poleIndices[a],c=this.vertexBufferStart+n.poleIndices[o],l=r+a,u=r+o;for(let e=0;e<this.numSegments-1;++e){let r=i+e*n.vertices.length+a,s=i+e*n.vertices.length+o;this.flip?(t(r,u,l),t(u,r,s)):(t(l,u,r),t(s,r,u)),l=r,u=s}this.flip?(t(s,u,l),s!==c&&t(s,c,u)):(t(l,u,s),s!==c&&t(u,c,s))}}},Xl=D(),Zl=D(),Ql=class{numProfilesPerJoin(){return 1}extrude(e,t,n){for(let r=0;r<t.vertices.length;++r)n(e.frame,t.vertices[r],t.normals[r],!1)}},$l=class{constructor(e,t){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,n){let r=iu,{rotationAngle:i,rotationRight:a,frame:o}=e;if(Math.abs(i)>=this.cutoffAngle){let c=e.rotationFrameUp;for(let l=0;l<this.numBendSubdivisions+1;++l){s(ru,.5*-i+l*i/this.numBendSubdivisions,c),tu(r,o,ru);for(let s=0;s<t.vertices.length;++s)cn(t.vertices[s],a)*i>=0?n(r,t.vertices[s],t.normals[s],!1):n(o,e.applyMiterStretch(nu,t.vertices[s]),t.normals[s],!0)}}else for(let r=0;r<this.numBendSubdivisions+1;++r)for(let r=0;r<t.vertices.length;++r){let s=cn(t.vertices[r],a)*i>=0;n(o,e.applyMiterStretch(nu,t.vertices[r]),t.normals[r],!s)}}},eu=class{constructor(){this.up=j(),this.right=j()}};function tu(e,t,n){A(e.up,t.up,n),A(e.right,t.right,n)}var nu=D(),ru=k(),iu=new eu,au=class extends qr{constructor(e,t,n,r,i,a){super(e,t,null,0,a),this.path=n,this.geometrySR=r,this.stencilWidth=i}};function ou(e){return`path`in e}var su=class{constructor(e){this.builder=e}onPathChanged(e){this.builder.onPathChanged()}},cu=class extends su{constructor(e){super(e),this.color=Ae(255,255,255,255),this._size=D(),this.positions=Ei(3*this.builder.numVerticesTotal),this.normals=new Int16Array(2*this.builder.numVerticesTotal)}bakeVertexColors(e){Rt(this.color,e)}bake(e){g(this._size,e);let{numVerticesTotal:t,pathVertexData:n,positions:r,profileRightAxes:i,profileUpAxes:a,profileVertexAndNormals:o,profileAuxData:s}=this.builder;for(let c=0;c<t;++c){let t=n[c];t*=3;let u=pu,d=0,f=0,m=so(mu,i,c),h=so(hu,a,c),g=4*c,_=l(uu,o[g]*e[0],o[g+1]*e[1]),v=3*c;if(s[v+2]===1)nn(u,h,m),d=s[v]*e[0],f=s[v+1];else{let e=du,t=fu;l(e,s[v],s[v+1]);let n=Ie(e);we(e,e);let r=cn(_,e);if(Math.abs(r)>n){l(t,-e[1],e[0]);let i=cn(_,t);on(e,e,n*Math.sign(r)),on(t,t,i),p(_,e,t)}O(u,0,0,0)}let y=m[0]*_[0]+h[0]*_[1],b=m[1]*_[0]+h[1]*_[1],x=m[2]*_[0]+h[2]*_[1];this.positions[v]=r[t]+y+u[0]*d,this.positions[v+1]=r[t+1]+b+u[1]*d,this.positions[v+2]=r[t+2]+x+u[2]*d;let S=o[g+2],C=o[g+3];oo(this.normals,c,m[0]*S+h[0]*C+u[0]*f,m[1]*S+h[1]*C+u[1]*f,m[2]*S+h[2]*C+u[2]*f)}}createGeometryData(){let e=this.builder.vertexIndices;return[[`position`,new z(this.positions,e,3,!0)],[`normalCompressed`,new z(this.normals,e,2,!0)],[`color`,new z(this.color,Sn(e.length),4,!0)]]}onPathChanged(e){super.onPathChanged(e),this.bake(this.size)}intersect(e,t,n,r){let i=this.builder.vertexIndices,a=new tr(this.positions,3),o=i.length/3;Xr(e,t,0,o,i,a,void 0,n,(e,t,n)=>r(e,n,t))}get size(){return this._size}},lu=class extends su{constructor(e,t,n,r){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=n,this.opacityAttributeValue=r,this.baked=new cu(e),this._vvSize=Ei(this.builder.path.vertices.length).fill(t),this._vvColor=ma(this.builder.path.vertices.length).fill(n),this._vvOpacity=ma(this.builder.path.vertices.length).fill(r)}createGeometryData(){let e=this.builder,{pathVertexIndices:t,vertexIndices:n}=e;return[[`position`,new z(e.positions,t,3,!0)],[`profileVertexAndNormal`,new z(e.profileVertexAndNormals,n,4,!0)],[`profileAuxData`,new z(e.profileAuxData,n,3,!0)],[`profileRight`,new z(e.profileRightAxes,n,2,!0)],[`profileUp`,new z(e.profileUpAxes,n,2,!0)],[`sizeFeatureAttribute`,new z(this._vvSize,t,1,!0)],[`colorFeatureAttribute`,new z(this._vvColor,t,1,!0)],[`opacityFeatureAttribute`,new z(this._vvOpacity,t,1,!0)]]}onPathChanged(e){super.onPathChanged(e);let t=e.getMutableAttribute(`position`);t&&(t.data=this.builder.positions)}},uu=D(),du=D(),fu=D(),pu=j(),mu=j(),hu=j();function gu(e,t){let n=null,r=e.vertices.length,i=.99619469809,a=j(),o=j(),s=j(),c=j(),l=j(),u=j(),d=Mn(),f=e.vertices[0];T(o,t),O(a,0,1,0),la(f.vRight,o,a,a,s,o,i),T(f.frame.up,o),T(f.frame.right,s);let p=e.positions,m=e.offset;n=f;for(let t=1;t<r;++t){f=e.vertices[t],E(l,f.vLeft,f.vRight);let r=Ct(l);r>0?(r=1/Math.sqrt(r),l[0]*=r,l[1]*=r,l[2]*=r):(l[0]=f.vRight[0],l[1]=f.vRight[1],l[2]=f.vRight[2]),u[0]=p[m]+n.frame.up[0],u[1]=p[m+1]+n.frame.up[1],u[2]=p[m+2]+n.frame.up[2],m+=3;let h=O(_u,p[m],p[m+1],p[m+2]);kn(h,l,d),En(d,pr(u,f.vLeft),c)?(c[0]-=p[m],c[1]-=p[m+1],c[2]-=p[m+2],F(o,c),nn(s,l,o),F(s,s)):la(l,n.frame.up,n.frame.right,a,s,o,i),T(f.frame.up,o),T(f.frame.right,s),n=f}}var _u=j(),vu=class{constructor(){this.vertices=[],this.normals=[],this.indices=[],this.poles=[],this.poleIndices=[]}addVertex(e,t){return this.vertices.push(ge(e)),this.normals.push(ge(t)),this.vertices.length-1}addPole(e,t=null){return this.poles.push({position:ge(e),normal:t?ge(t):null}),this.poles.length-1}addSegment(e,t=null){this.indices.push(e.v0),this.indices.push(e.v1),t&&(this.poleIndices.push(t.v0),this.poleIndices.push(t.v1))}get numSegments(){return this.indices.length/2}translate(e,t){for(let n of this.vertices)n[0]+=e,n[1]+=t;for(let n of this.poles)n.position[0]+=e,n.position[1]+=t}get usedMemory(){return this.vertices.length*pn(this.vertices[0])*2+pn(this.indices)}},yu={top:[0,-.5],bottom:[0,.5]};function bu(e){let t=.5,n=new vu,r={v0:0,v1:0};n.addPole(C(0,0));for(let e=0;e<10;++e){let r=2*e*Math.PI/10,i=Math.cos(r),a=Math.sin(r),o=C(i*t,a*t),s=C(i,a);n.addVertex(o,s)}for(let e=0;e<9;++e){let t={v0:e,v1:e+1};n.addSegment(t,r)}if(n.addSegment({v0:9,v1:0},r),e!==`center`){let t=yu[e];n.translate(t[0],t[1])}return n}var xu={center:bu(`center`),top:bu(`top`),bottom:bu(`bottom`)},Su={center:Cu(`center`),top:Cu(`top`),bottom:Cu(`bottom`)};function Cu(e){let t=new vu,n=C(.5*-1,.5*-1),r=C(.5*1,.5*-1),i=C(.5*1,.5*1),a=C(.5*-1,.5*1),o=C(0,-1),s=C(1,0),c=C(0,1),l=C(-1,0);if(t.addPole(C(0,.5*1),c),t.addPole(C(0,.5*1)),t.addPole(C(0,.5*-1)),t.addPole(C(0,.5*-1),o),t.addVertex(n,o),t.addVertex(r,o),t.addSegment({v0:0,v1:1},{v0:3,v1:3}),t.addVertex(r,s),t.addVertex(i,s),t.addSegment({v0:2,v1:3},{v0:2,v1:1}),t.addVertex(i,c),t.addVertex(a,c),t.addSegment({v0:4,v1:5},{v0:0,v1:0}),t.addVertex(a,l),t.addVertex(n,l),t.addSegment({v0:6,v1:7},{v0:1,v1:2}),e!==`center`){let n=yu[e];t.translate(n[0],n[1])}return t}function wu(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function Tu(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e}function Eu(e,t,n,r,i){return e[0]=t,e[1]=n,e[2]=r,e[3]=i,e}function Du(e,t){if(e===t){let n=t[1];e[1]=t[2],e[2]=n}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e}function Ou(e,t){let n=t[0],r=t[1],i=t[2],a=t[3],o=n*a-i*r;return o?(o=1/o,e[0]=a*o,e[1]=-r*o,e[2]=-i*o,e[3]=n*o,e):null}function ku(e,t){let n=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=n,e}function Au(e){return e[0]*e[3]-e[2]*e[1]}function ju(e,t,n){let r=t[0],i=t[1],a=t[2],o=t[3],s=n[0],c=n[1],l=n[2],u=n[3];return e[0]=r*s+a*c,e[1]=i*s+o*c,e[2]=r*l+a*u,e[3]=i*l+o*u,e}function Mu(e,t,n){let r=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(n),c=Math.cos(n);return e[0]=r*c+a*s,e[1]=i*c+o*s,e[2]=r*-s+a*c,e[3]=i*-s+o*c,e}function Nu(e,t,n){let r=t[0],i=t[1],a=t[2],o=t[3],s=n[0],c=n[1];return e[0]=r*s,e[1]=i*s,e[2]=a*c,e[3]=o*c,e}function Pu(e,t){let n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=-n,e[3]=r,e}function Fu(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e}function Iu(e){return`mat2(`+e[0]+`, `+e[1]+`, `+e[2]+`, `+e[3]+`)`}function Lu(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)}function Ru(e,t,n,r){return e[2]=r[2]/r[0],n[0]=r[0],n[1]=r[1],n[3]=r[3]-e[2]*n[1],[e,t,n]}function zu(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e}function Bu(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e}function Vu(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function Hu(e,t){let n=e[0],r=e[1],i=e[2],a=e[3],o=t[0],s=t[1],c=t[2],l=t[3],u=ye();return Math.abs(n-o)<=u*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-s)<=u*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-c)<=u*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(a-l)<=u*Math.max(1,Math.abs(a),Math.abs(l))}function Uu(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e}function Wu(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e}var Gu=ju,Ku=Bu;Object.freeze(Object.defineProperty({__proto__:null,LDU:Ru,add:zu,adjoint:ku,copy:wu,determinant:Au,equals:Hu,exactEquals:Vu,frob:Lu,fromRotation:Pu,fromScaling:Fu,identity:Tu,invert:Ou,mul:Gu,multiply:ju,multiplyScalar:Uu,multiplyScalarAndAdd:Wu,rotate:Mu,scale:Nu,set:Eu,str:Iu,sub:Ku,subtract:Bu,transpose:Du},Symbol.toStringTag,{value:`Module`}));function qu(){return[1,0,0,1]}function Ju(e){return[e[0],e[1],e[2],e[3]]}function Yu(e,t,n,r){return[e,t,n,r]}Object.freeze(Object.defineProperty({__proto__:null,clone:Ju,create:qu,fromValues:Yu},Symbol.toStringTag,{value:`Module`}));var Xu=class{constructor(){this.vLeft=j(),this.vRight=j(),this.vMinSiblingLength=0,this.frame=new eu}setFrameFromUpVector(e){T(this.frame.up,e),E(ld,this.vLeft,this.vRight),F(ld,ld),d(cd,this.frame.up,M(ld,this.frame.up)),R(ud,ld,cd),F(ud,ud),nn(this.frame.right,ud,this.frame.up)}get foldingAngle(){return Math.PI-this.rotationAngle}},Zu=class extends Xu{get rotationFrameUp(){return this.frame.up}get rotationRight(){return ce}get rotationAngle(){return d(od,this.frame.up,M(this.frame.up,this.vLeft)),R(od,this.vLeft,od),ae(od,od),F(od,od),d(sd,this.frame.up,M(this.frame.up,this.vRight)),R(sd,this.vRight,sd),F(sd,sd),nn(ad,this.rotationFrameUp,this.vLeft),Math.sign(M(ad,this.vRight))*(Math.PI-Nt(M(od,sd)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength/Math.cos(.5*this.foldingAngle))}applyMiterStretch(e,t){let n=this.rotationAngle;if(Math.abs(n)<=0)return t;let r=St(Math.cos(.5*n));return l(e,(r-1+1)*t[0],t[1])}},Qu=class extends Xu{get rotationFrameUp(){let e=Math.sign(M(this.frame.right,this.vRight));return nn(td,this.vRight,this.vLeft),d(td,td,e),F(td,td)}get rotationRight(){let e=this.rotationFrameUp,t=M(e,this.frame.up),n=M(e,this.frame.right);return d(rd,this.frame.up,-n),d(id,this.frame.right,t),E(rd,rd,id),F(rd,rd),$u(nd,this.frame,rd),nd}get rotationAngle(){let e=Math.sign(M(this.frame.right,this.vRight));return ae(ad,this.vLeft),-e*(Math.PI-Nt(M(ad,this.vRight)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength*St(Math.cos(.5*this.foldingAngle)))}applyMiterStretch(e,t){let n=this.rotationAngle;if(Math.abs(n)===0)return t;let r=St(Math.cos(.5*n)),i=this.rotationRight,a=Eu(dd,1+(r-1)*i[0]*i[0],(r-1)*i[0]*i[1],(r-1)*i[0]*i[1],1+(r-1)*i[1]*i[1]);return ut(e,t,a)}};function $u(e,t,n){l(e,M(n,t.right),M(n,t.up))}function ed(e){switch(e){case 0:return new Zu;case 1:return new Qu}}var td=j(),nd=D(),rd=j(),id=j(),ad=j(),od=j(),sd=j(),cd=j(),ld=j(),ud=j(),dd=qu(),fd=class extends wo{constructor(){super(...arguments),this.ambient=Ft(.2,.2,.2),this.diffuse=Ft(.8,.8,.8),this.opacity=1,this.origin=j(),this.modelTransformation=null,this.mrrFactors=io,this.emissiveStrengthFromSymbol=0,this.emissiveSource=1,this.emissiveBaseColor=xt}get emissiveStrength(){return this.emissiveStrengthFromSymbol}},pd=class extends yi{constructor(e,t){super(e,t,Di(md(t))),this.shader=new Si(Co,()=>i(()=>import(`./Path.glsl-CoOMJhgQ.js`),__vite__mapDeps([58,59,2,3,22,23,24,56,42,36,28,60,46,35,30,38,47,44,26,27,29,61,34,43,39,62,63,64,65,41,66,67,48,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,40,33,37,31,45])))}initializePipeline(e){let{output:t,hasEmission:n,transparent:r,hasSlicePlane:i,doubleSidedMode:a,hasOccludees:o,oitPass:s}=e,c=s===0,l=s===2;return kr({blending:B(t)&&r?zr(s):null,culling:i&&!r&&a!==0?Or:null,depthTest:Fr(s),depthWrite:c||l?Dr:null,drawBuffers:bi(t,Vr(s,n)),colorWrite:Er,stencilWrite:o?ti:null,stencilTest:o?Ur:null,polygonOffset:c||l?null:Lr})}};function md(e){let t=wi().vec3f(`position`).vec4f16(`profileVertexAndNormal`).vec2i16(`profileRight`,{glNormalized:!0}).vec2i16(`profileUp`,{glNormalized:!0});return e.hasVVSize&&t.f32(`sizeFeatureAttribute`),e.hasVVColor&&t.f32(`colorFeatureAttribute`),e.hasVVOpacity&&t.f32(`opacityFeatureAttribute`),qi()&&t.vec4u8(`olidColor`),t.vec3f16(`profileAuxData`),t.freeze()}pd=N([Ce(`esri.views.3d.webgl-engine.materials.PathTechnique`)],pd);var Z=class extends Rr{constructor(e){super(),this.spherical=e,this.pbrMode=0,this.doubleSidedMode=0,this.emissionSource=0,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.transparent=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.snowCover=!1,this.textureCoordinateType=0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.draped=!1,this.overlayEnabled=!1}get discardInvisibleFragments(){return this.transparent}};N([V({count:7})],Z.prototype,`pbrMode`,void 0),N([V({count:3})],Z.prototype,`doubleSidedMode`,void 0),N([V({count:8})],Z.prototype,`emissionSource`,void 0),N([V()],Z.prototype,`receiveShadows`,void 0),N([V()],Z.prototype,`receiveAmbientOcclusion`,void 0),N([V()],Z.prototype,`hasVVSize`,void 0),N([V()],Z.prototype,`hasVVColor`,void 0),N([V()],Z.prototype,`hasVVOpacity`,void 0),N([V()],Z.prototype,`transparent`,void 0),N([V()],Z.prototype,`hasOccludees`,void 0),N([V()],Z.prototype,`terrainDepthTest`,void 0),N([V()],Z.prototype,`cullAboveTerrain`,void 0),N([V()],Z.prototype,`snowCover`,void 0);var hd=class extends Pr{constructor(e,t){super(e,vd),this.supportsEdges=!0,this._pp0=I(0,0,1),this._pp1=I(0,0,0),this.produces=new Map([[2,e=>(this.parameters.castShadows&&rr(e)||or(e))&&!this.transparent],[4,e=>(this.parameters.castShadows&&rr(e)||or(e))&&this.transparent]]),this._configuration=new Z(t.spherical)}get hasEmissions(){return this.parameters.emissiveStrength>0}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.transparent,this._configuration.hasOccludees=t.hasOccludees,B(e)?(this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType===`normal`?1:this.parameters.doubleSided&&this.parameters.doubleSidedType===`winding-order`?2:0,this._configuration.receiveShadows=t.shadowMap.enabled,this._configuration.receiveAmbientOcclusion=t.ssao!=null):this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=!1,this._configuration.pbrMode=this.parameters.usePBR?2:0,this._configuration.emissionSource=this.parameters.usePBR?1:0,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.snowCover=t.snowCover>0,this._configuration}isVisibleForOutput(e){return e!==3&&e!==5&&e!==4||this.parameters.castShadows}get visible(){return this.parameters.opacity>=ea}intersect(e,t,n,r,i,a){this._intersect(e,n,r,i,a)}intersectDraped(e,t,n,r){return this._pp0[0]=this._pp1[0]=n[0],this._pp0[1]=this._pp1[1]=n[1],this._intersect(e,t,this._pp0,this._pp1,r)}_intersect(e,t,n,r,i){let a=e;if(!ou(a))return;let o=a.path,s=ge(this.parameters.size);if(this.parameters.vvSize){let{offset:e,factor:t,minSize:n,maxSize:r,fallback:i}=this.parameters.vvSize,a=o.sizeAttributeValue;Number.isNaN(a)?(s[0]*=i[0],s[1]*=i[2]):(s[0]*=pt(e[0]+a*t[0],n[0],r[0]),s[1]*=pt(e[2]+a*t[2],n[2],r[2]))}let c=new Kr(t.tolerance,!1,t.options.normalRequired),l=Math.max(s[0],s[1]),u=e.boundingInfo;if(u==null)return void _d(o,s,n,r,c,i);let d=m(u.bbMin[0]-l,u.bbMin[1]-l,u.bbMin[2]-l,u.bbMax[0]+l,u.bbMax[1]+l,u.bbMax[2]+l),f=[r[0]-n[0],r[1]-n[1],r[2]-n[2]],p=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]),h=[p/f[0],p/f[1],p/f[2]];Qr(d,n,h,t.tolerance)&&_d(o,s,n,r,c,i)}createBufferWriter(){return new ei(md(this.parameters))}createGLMaterial(e){return new gd(e)}get transparent(){let{parameters:e}=this;return e.drivenOpacity||e.opacity<1}},gd=class extends ar{beginSlot(e){return this.getTechnique(pd,e)}};function _d(e,t,n,r,i,a){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(n,r,i,a)}var vd=class extends fd{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType=`normal`,this.castShadows=!0,this.hasSlicePlane=!1,this.drivenOpacity=!1,this.usePBR=!1}},yd=[`polyline`],bd=class extends Va{constructor(e,t,n,r){super(e,t,n,r,Td(t)),this._intrinsicSize=C(1,1),this._upVectorAlignment=1,this._stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){let e=this.symbolLayer,t=e.width==null?e.height:e.width,n=e.height==null?t:e.height;this._vvConvertOptions=new Gi({supports:{size:!0,color:!0,rotation:!1,opacity:!0},modelSize:[1,1,1],symbolSize:[t,1,n],unitInMeters:this._context.renderCoordsHelper.unitInMeters,fallbackColor:this._getFallbackOpacityAndColor(Ra),fallbackSize:[t,1,n]}),this._fastUpdates=this._context.renderer?.visualVariables?.length?Zi(this._context.renderer,this._vvConvertOptions):null;let r=e.anchor||`center`;this._upVectorAlignment=e.profileRotation===`heading`?0:1;let i=e.profile||`circle`;switch(i){default:case`circle`:this._profile=xu[r];break;case`quad`:this._profile=Su[r]}switch(e.join){case`round`:this._extruder=new $l(0,3);break;case`bevel`:this._extruder=new $l(0,1);break;case`miter`:this._extruder=new $l(.8*Math.PI,1);break;default:this._extruder=new Ql}switch(this._cap){case`none`:this._startCap=new ql,this._endCap=new ql;break;case`butt`:default:this._startCap=new Jl(this._profile,0),this._endCap=new Jl(this._profile,0,!0);break;case`square`:this._startCap=new Jl(this._profile,-.5),this._endCap=new Jl(this._profile,.5,!0);break;case`round`:{let e=i===`quad`;this._startCap=new Yl({profile:this._profile,flip:!1,breakNormals:e,subdivisions:3}),this._endCap=new Yl({profile:this._profile,flip:!0,breakNormals:e,subdivisions:3});break}}let o=this._materialColor,s=this._getCombinedOpacityAndColor(o),c=Vt(s),u=s[3],d=this.needsDrivenTransparentPass,f=e.material?.emissive,p={diffuse:c,ambient:c,emissiveStrengthFromSymbol:f?.strength??0,emissiveSource:1,opacity:u,drivenOpacity:d,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(l(this._intrinsicSize,t,n),!ya(this._intrinsicSize[0])||!ya(this._intrinsicSize[1])))throw new a(`graphics3dpathsymbollayer:invalid-size`,`Symbol sizes may not be negative values`);let m;this._fastUpdates?.visualVariables.size||on(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates?m=new hd({...p,...this._fastUpdates.materialParameters,size:ke(this._intrinsicSize)},this._context):(p.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,p.normalType=1,m=new $a(p,this._context)),m.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._materials[0]=m,this._updateTransparentDepedentMaterialParameters()}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,yd,this.symbolLayer.type))return null;let n=this.createElevationContextForGraphic(t);return this._createAs3DShape(e,n)}layerOpacityChanged(){let e=this._materialColor,t=this._getCombinedOpacity(e),n=this._materials[0];n&&(n.setParameters({opacity:t}),this._updateTransparentDepedentMaterialParameters())}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,pi)}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._materials[0]?.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}applyRendererDiff(e,t){for(let n in e.diff){if(n!==`visualVariables`||!Qi(this._fastUpdates,t,this._vvConvertOptions))return 0;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return 2}_getVertexData(e){let t=0,n=e.paths,r=[],i=e.spatialReference,a=this._context.elevationProvider.spatialReference,o=this._context.renderCoordsHelper.spatialReference;for(let e of n)t+=e.length;let s=be(3*t),c,l=0;for(let t of n){r.push({offset:l,numVertices:t.length});for(let n of t)s[l++]=n[0],s[l++]=n[1],s[l++]=e.hasZ?n[2]:0}return a==null||i.equals(a)||te(s,i,0,s,a,0,t)?(a==null||a.equals(o)?c=ie(s):(c=be(3*t),te(s,a,0,c,o,0,t)),{pathVertexDataInfos:r,vertexDataES:s,vertexDataRS:c}):null}_createAs3DShape(e,t){let{graphic:n,renderingInfo:r}=e,i=n.geometry,a=this._getVertexData(i);if(a==null)return this.logger.warn(`PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)`),null;if(a.pathVertexDataInfos.length===0)return i.paths.length!==0&&i.paths.some(e=>e.length>0)||this.logger.warn(`PathSymbol3DLayer geometry failed to be created (no paths were defined)`),null;let s=[],c=i.spatialReference,l=at(),u=this._context.renderCoordsHelper,d=new ci(a.vertexDataES),f=n.uid,p=Ei(a.vertexDataRS.length);for(let e of a.pathVertexDataInfos){let i=e.numVertices;if(i<2)continue;let m=e.offset;if(this._context.clippingExtent!=null&&(an(a.vertexDataES,m,i,l),!L(l,this._context.clippingExtent)))continue;let h=[],g=m+3*i;for(let e=m;e<g;e+=3){d.offset=e;let n=si(d,this._context.elevationProvider,t,u);O(Q,a.vertexDataRS[e],a.vertexDataRS[e+1],a.vertexDataRS[e+2]),u.setAltitude(Q,n),a.vertexDataRS[e]=Q[0],a.vertexDataRS[e+1]=Q[1],a.vertexDataRS[e+2]=Q[2],h.push(ed(this._upVectorAlignment))}let _=new Wl(h,a.vertexDataES,a.vertexDataRS,m,p);xd(_,this._upVectorAlignment,this._context.renderCoordsHelper);let v=new Gl(_,this._profile,this._extruder,this._startCap,this._endCap),y=null;if(this._fastUpdates){let e=this._fastUpdates.visualVariables,t=Xi(e.size?.field,n),r=Xi(e.color?.field,n),i=Xi(e.opacity?.field,n);y=new lu(v,t,r,i)}else{let e=ge(this._intrinsicSize);if(this._drivenProperties.size){let t=r.size??[`symbol-value`,`symbol-value`,`symbol-value`];e[0]*=Sd(t[0],t[2]===`symbol-value`?this.symbolLayer.height||0:t[2],this.symbolLayer.width||0),e[1]*=Sd(t[2],t[0]===`symbol-value`?this.symbolLayer.width||0:t[0],this.symbolLayer.height||0)}let t=new cu(v);t.bake(e);let n=this._getDrivenColor(r);n&&t.bakeVertexColors(n),y=t}let b=y.createGeometryData(),x=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:f,layerViewUid:this._context.layerViewUid}),S=new au(this._materials[0],b,y,c,this._stencilWidth,x);S.transformation=Oe(k(),o,v.path.origin),s.push(S)}if(s.length===0)return null;let m=new hi({geometries:s,layerViewUid:this._context.layerViewUid,graphicUid:f}),h=new Ua(this,m,null,(e,t,n,r,i)=>wd(e,t,r,i,this._upVectorAlignment),t,null);return h.alignedSampledElevation=0,h.needsElevationUpdates=pi(t.mode),h}_getDrivenColor(e){return this._hasDrivenColorOrOpacity?this._getDrivenUInt8ColorWithNaNSupport(e,this._materialColor,!1):null}get _materialColor(){return this.symbolLayer.material?.color}_getFallbackOpacityAndColor(e){return this._materialColor?.toUnitRGBA()??e}get _cap(){return this.symbolLayer.cap||`butt`}_updateTransparentDepedentMaterialParameters(){let e=this._materials[0];e&&e.setParameters({cullFace:e.transparent||this._cap===`none`?0:2})}};function xd(e,t,n){let{origin:r,positions:i}=e,a=e.offset;switch(t){default:case 0:for(let t of e.vertices)Q[0]=i[a++]+r[0],Q[1]=i[a++]+r[1],Q[2]=i[a++]+r[2],n.worldUpAtPosition(Q,Q),t.setFrameFromUpVector(Q);break;case 1:Q[0]=i[a]+r[0],Q[1]=i[a+1]+r[1],Q[2]=i[a+2]+r[2],n.worldUpAtPosition(Q,Q),gu(e,Q)}}function Sd(e,t,n){switch(e){case`symbol-value`:return n;case`proportional`:return t;default:return e}}function Cd(e,t,n,r){let i=0,{origin:a,vertices:o,positions:s,positionsES:c}=e,l=e.offset+3*o.length;for(let t=e.offset;t<l;t+=3)O(Q,c[t],c[t+1],c[t+2]),n(Q,Ed),i+=Ed.sampledElevation,Q[0]=s[t]+a[0],Q[1]=s[t+1]+a[1],Q[2]=s[t+2]+a[2],r.setAltitude(Q,Ed.z),s[t]=Q[0]-a[0],s[t+1]=Q[1]-a[1],s[t+2]=Q[2]-a[2];return e.updatePathVertexInformation(),i/o.length}function wd(e,t,n,r,i){let a=e.stageObject,o=a.geometries,s=0;for(let e of o){if(!ou(e))continue;let o=e.path,c=o.builder.path;s+=Cd(c,t,n,r),i!==0&&xd(c,i,r),o.onPathChanged(e),e.invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(e,`position`)}return s/o.length}function Td(e){return(e.material?.color?.a??0)===1}var Q=j(),Ed=new di;function Dd(e,t,n,r,i=1){if(n.isGeographic&&r===1){let e=be(t.length),r=t.length,i=Kt(n);for(let n=0;n<r;n+=3)qe(t,n,e,n,i);t=e}l($,1/0,1/0);for(let e=0;e<t.length;e+=3)$[0]=Math.min($[0],t[e]),$[1]=Math.min($[1],t[e+1]);let a=$[0]%i,o=$[1]%i,s=$[0]-a,c=$[1]-o;for(let n=0;n<t.length;n+=3){let r=n/3*4;e[r]=(t[n]-s)/i,e[r+1]=(t[n+1]-c)/i,e[r+2]=s/i,e[r+3]=c/i}}function Od(e,t,n,r,i=1){O(Md,1,0,0),O(Nd,0,1,0),O(Pd,0,0,1),Wd(kd,n),An(jd,n)&&zd(jd,Md,Nd,Pd,r,kd),l($,1/0,1/0),l(Fd,-1/0,-1/0);for(let e=0;e<n.length;e+=3){O(Ad,n[e],n[e+1],n[e+2]);let t=M(Md,Ad),r=M(Nd,Ad);$[0]=Math.min($[0],t),$[1]=Math.min($[1],r),Fd[0]=Math.max(Fd[0],t),Fd[1]=Math.max(Fd[1],r)}let a=M(Pd,kd);Kd(Id,$[0],$[1],a,Md,Nd,Pd),Kd(Ld,Fd[0],$[1],a,Md,Nd,Pd),Kd(Rd,$[0],Fd[1],a,Md,Nd,Pd),R(Ld,Ld,Id),d(Ld,Ld,.5),R(Rd,Rd,Id),d(Rd,Rd,.5),E(Id,Id,Ld),E(Id,Id,Rd);let o=$[0]%i,s=$[1]%i,c=$[0]-o,u=$[1]-s;for(let r=0;r<n.length;r+=3){O(Ad,n[r],n[r+1],n[r+2]);let a=r/3,o=4*a;e[o]=(M(Md,Ad)-c)/i,e[o+1]=(M(Nd,Ad)-u)/i,e[o+2]=c/i,e[o+3]=u/i;let s=9*a;for(let e=0;e<3;e++)t[s+e]=Id[e],t[s+e+3]=Ld[e],t[s+e+6]=Rd[e]}}var kd=j(),Ad=j(),jd=Mn(),Md=j(),Nd=j(),Pd=j(),$=D(),Fd=D(),Id=j(),Ld=j(),Rd=j();function zd(e,t,r,i,a,o){a==null?(O(Vd,1,0,0),O(Hd,0,1,0),O(Ud,0,0,1)):(a.basisMatrixAtPosition(o,Bd),O(Vd,Bd[0],Bd[1],Bd[2]),O(Hd,Bd[4],Bd[5],Bd[6]),O(Ud,Bd[8],Bd[9],Bd[10]));let s=Dn(e);M(s,Ud)<0&&d(s,s,-1),T(i,s);let c=M(s,Hd),l=M(s,Vd);Math.abs(c)>Math.abs(l)?(n(t,Vd,s,-l),F(t,t),nn(r,t,s),F(r,r),d(r,r,-1)):(n(r,Hd,s,-c),F(r,r),nn(t,r,s),F(t,t))}var Bd=k(),Vd=j(),Hd=j(),Ud=j();function Wd(e,t){O(Gd,0,0,0);for(let e=0;e<t.length-3;e+=3)Gd[0]+=t[e],Gd[1]+=t[e+1],Gd[2]+=t[e+2];d(e,Gd,1/(t.length/3-1))}var Gd=j();function Kd(e,t,n,r,i,a,o){O(e,t*i[0]+n*a[0]+r*o[0],t*i[1]+n*a[1]+r*o[1],t*i[2]+n*a[2]+r*o[2])}var qd=class extends yi{constructor(e,t){super(e,t,Di(Yd(t))),this.shader=new Si(To,()=>i(()=>import(`./Pattern.glsl-C4hxLCVk.js`),__vite__mapDeps([94,95,56,2,3,42,24,36,28,23,39,35,25,22,26,27,29,30,31,62,57,40,41,33,34,37,45,46,38,47,44,48])))}_setPipelineState(e,t){let{oitPass:n,output:r,hasEmission:i,cullFace:a,draped:o,hasOccludees:s,polygonOffset:c}=e,l=n===0;return kr({blending:B(r)?zr(n):null,culling:Ar(a),depthTest:o?null:Fr(n),depthWrite:Mr(e),drawBuffers:bi(r,Vr(n,i)),colorWrite:Er,stencilWrite:s?ti:null,stencilTest:s?t?Zr:Ur:null,polygonOffset:l?c?Jd:null:ri(e)})}initializePipeline(e){return this._occludeePipelineState=this._setPipelineState(e,!0),this._setPipelineState(e,!1)}getPipeline(e,t){return t?this._occludeePipelineState:super.getPipeline(e)}};qd=N([Ce(`esri.views.3d.webgl-engine.shaders.PatternTechnique`)],qd);var Jd={factor:1,units:1};function Yd(e){let t=wi().vec3f(`position`).vec4f(`uvMapSpace`);return e.draped||t.mat3f(`boundingRect`),e.hasVVColor?t.f32(`colorFeatureAttribute`):t.vec4u8(`color`),qi()&&t.vec4u8(`olidColor`),t.freeze()}var Xd=class extends Rr{constructor(){super(...arguments),this.cullFace=0,this.style=0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasOccludees=!1,this.enableOffset=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasVVColor=!1,this.draped=!1,this.textureCoordinateType=0,this.emissionSource=0,this.discardInvisibleFragments=!0,this.writeDepth=!0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasVVSize=!1,this.hasVVOpacity=!1,this.overlayEnabled=!1,this.snowCover=!1}};N([V({count:3})],Xd.prototype,`cullFace`,void 0),N([V({count:6})],Xd.prototype,`style`,void 0),N([V()],Xd.prototype,`hasVertexColors`,void 0),N([V()],Xd.prototype,`polygonOffset`,void 0),N([V()],Xd.prototype,`hasOccludees`,void 0),N([V()],Xd.prototype,`enableOffset`,void 0),N([V()],Xd.prototype,`terrainDepthTest`,void 0),N([V()],Xd.prototype,`cullAboveTerrain`,void 0),N([V()],Xd.prototype,`hasVVColor`,void 0),N([V()],Xd.prototype,`draped`,void 0);var Zd=class extends Ni{constructor(e){super(e,tf),this._configuration=new Xd,this.supportsEdges=!0,this.produces=new Map([[2,e=>ir(e)],[4,e=>B(e)],[5,e=>nr(e)],[19,e=>this.parameters.draped&&cr(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.draped=this.parameters.draped,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.enableOffset,this._configuration.terrainDepthTest=t.terrainDepthTest&&B(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration}get visible(){return this.parameters.color[3]>=ea}createGLMaterial(e){return new Qd(e)}createBufferWriter(){return new $d(Yd(this.parameters))}},Qd=class extends ar{beginSlot(e){return this.getTechnique(qd,e)}},$d=class extends ei{write(e,t,n,r,i,a){let o=Hr(n,r,this.layout,e,t,i,a);for(let t of this.layout.fields.keys()){let r=n.get(t),o=r?.indices;if(r&&o)switch(t){case`uvMapSpace`:{Bn(r.size===4);let e=i.getField(t,zn);e&&ni(r,e,a);break}case`boundingRect`:{Bn(r.size===9);let n=i.getField(t,Rn);n&&ef(r,e,n,a);break}}}return o}};function ef(e,t,n,r){let{data:i,indices:a}=e,o=t,s=n.typedBuffer,c=n.typedBufferStride,l=a.length;r*=c;for(let e=0;e<l;++e){let t=9*a[e],n=i[t],l=i[t+1],u=i[t+2];s[r]=o[0]*n+o[4]*l+o[8]*u+o[12],s[r+1]=o[1]*n+o[5]*l+o[9]*u+o[13],s[r+2]=o[2]*n+o[6]*l+o[10]*u+o[14];for(let e=3;e<9;++e)s[r+e]=i[t+e];r+=c}}var tf=class extends Yi{constructor(){super(...arguments),this.color=Ae(1,1,1,1),this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.hasOccludees=!1,this.style=2,this.draped=!0}};function nf(e,t){let n=e?.pattern;return n==null?new Fi(t):n.style===`none`||n.style===`solid`?(n.style===`none`&&(t.color=Ae(0,0,0,0),t.forceTransparentMode=!0),new Fi(t)):(t.style=rf(n.style),new Zd(t))}function rf(e){switch(e){case`horizontal`:return 0;case`vertical`:return 1;case`cross`:return 2;case`forward-diagonal`:return 3;case`backward-diagonal`:return 4;case`diagonal-cross`:return 5;default:return}}function af(e){return e.material instanceof Zd&&!e.material.parameters.draped}function sf(e,t){if(af(e)){let n=e.attributes.get(`position`).data,r=e.getMutableAttribute(`uvMapSpace`).data,i=e.getMutableAttribute(`boundingRect`).data;Od(r,i,n,t)}}function cf(e,t,n,r,i){let a=za(e,t,n,r,i),o=e.stageObject.geometries;for(let e of o)sf(e,i);return a}var lf=[`polyline`,`polygon`,`extent`],uf=class e extends Va{static{this.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,n,r){super(e,t,n,r,hf(t)),this._needsUV=!1,this._materials=[]}async doLoad(){this._fastUpdates=Zi(this._context.renderer,this._vvConvertOptions)}get _materialColor(){return this.symbolLayer.material?.color}_createMaterials(){if(this._materials.length>0)return;let e=this._materialColor,t=this._getCombinedOpacityAndColor(e);this._materials[0]=nf(this.symbolLayer,{color:t,forceTransparentMode:this.needsDrivenTransparentPass,discardInvisibleFragments:!0,polygonOffset:!1,hasVertexColors:!0,draped:this.draped,hasSlicePlane:this._context.slicePlaneEnabled,...this._fastUpdates?.materialParameters}),this._needsUV=this._materials[0]instanceof Zd;let n=this.symbolLayer.outline;if(mf(n)){let e=Ri(n.pattern);this._materials[1]=new ai({width:P(n.size),color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:e,cap:zs(n.patternCap||`butt`),screenSizePerspective:this._outlineScreenSizePerspective},this.view.state.isGlobal)}}get _outlineScreenSizePerspective(){return!this.draped&&gi(this._context.layer.screenSizePerspectiveEnabled)?this.view.screenSizePerspective.parameters:null}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,lf,this.symbolLayer.type))return null;let n=this._getDrivenUInt8Color(e.renderingInfo,this._materialColor,!1),r=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus(r.mode===`on-the-ground`),this._createMaterials(),this.draped?this._createAsOverlay(t,n):this._createAs3DShape(t,n,r)}applyRendererDiff(e,t){for(let n in e.diff){if(n!==`visualVariables`||!Qi(this._fastUpdates,t,this._vvConvertOptions))return 0;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return 2}layerOpacityChanged(){if(this._materials[0]!=null){let e=this._materials[0].parameters.color,t=this._materialColor,n=this._getCombinedOpacity(t);this._materials[0].setParameters({color:[e[0],e[1],e[2],n],forceTransparentMode:this.needsDrivenTransparentPass})}if(this._materials[1]!=null){let e=this._materials[1].parameters.color;this._materials[1].setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerScreenSizePerspectiveChanged(){this._materials[1]?.setParameters({screenSizePerspective:this._outlineScreenSizePerspective})}layerElevationInfoChanged(t,n,r){let i=this._elevationContext.mode,a=fi(e.elevationModeChangeTypes,r,i);if(a!==1)return a;let o=ui(i);return this.updateGraphics3DGraphicElevationInfo(t,n,()=>o)}slicePlaneEnabledChanged(){if(this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]){let e={hasSlicePlane:this._context.slicePlaneEnabled};this._materials[1].setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,n){let r=Ao(e.geometry);if(!r)return null;let i=Mo(r,this._context.elevationProvider,this._context.renderCoordsHelper,n),a=new ff(i,t,this._context.layerViewUid,e.uid),o=a.renderData.position.length/3;if(this._needsUV&&(a.uvMapSpace=Ei(4*o,!0),a.boundingRect=be(9*o),Od(a.uvMapSpace,a.boundingRect,a.renderData.position,this._context.renderCoordsHelper)),a.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(a),this._createAs3DShapeFill(e,a),this._materials[1]&&this._createAs3DShapeOutline(a),this._logGeometryCreationWarnings(a.renderData,r.rings,`rings`,`FillSymbol3DLayer`),a.outGeometries.length===0)return null;let s=new hi({geometries:a.outGeometries,castShadow:!1,layerViewUid:this._context.layerViewUid,graphicUid:e.uid}),c=new Ua(this,s,null,cf,n);return c.alignedSampledElevation=a.renderData.sampledElevation,c.needsElevationUpdates=ui(n.mode),c}_createAs3DShapeFill(e,t){let n=t.renderData.polygons;for(let{position:r,mapPositions:i,holeIndices:a,index:o,count:s}of n){if(this._context.clippingExtent!=null&&(u(i,df),!L(df,this._context.clippingExtent)))continue;let n=Do(i,a,this._context.elevationProvider.spatialReference);if(n.length===0)continue;let c=this._fastUpdates?.visualVariables.color,l=Oo({material:this._materials[0],indices:n,mapPositions:i,attributeData:{position:r,color:c?null:t.color,colorFeature:c?Xi(c.field,e):null,uvMapSpace:this._needsUV?Ti(t.uvMapSpace,4*o,4*s):null,boundingRect:this._needsUV?S(t.boundingRect,9*o,9*s):null,olidColor:t.olidColor}});t.outGeometries.push(l)}}_createAs3DShapeOutline(e){if(this._materials[1]==null)return;let t=e.renderData.outlines;for(let{mapPositions:n,position:r}of t){if(this._context.clippingExtent!=null&&(u(n,df),!L(df,this._context.clippingExtent)))continue;let t=ca(this._materials[1],{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:n,attributeData:{position:r}},e.olidColor);e.outGeometries.push(t)}}_createAsOverlay(e,t){let n=Ao(e.geometry);if(n==null)return null;this._materials[0].renderPriority=this._renderPriority+this._renderPriorityStep/2,this._materials[1]!=null&&(this._materials[1].renderPriority=this._renderPriority);let r=No(n,this._context.overlaySR),i=new pf(r,t,this._context.layerViewUid,e.uid),a=i.renderData.position.length/3;return this._needsUV&&(i.uvMapSpace=Ei(4*a,!0),Dd(i.uvMapSpace,i.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),i.outBoundingBox=Et(),i.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(i),this._createAsOverlayFill(e,i),this._materials[1]&&this._createAsOverlayOutline(i),this._logGeometryCreationWarnings(i.renderData,n.rings,`rings`,`FillSymbol3DLayer`),i.outGeometries.length===0?null:new bs(this,i.outGeometries,i.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e,t){let n=t.renderData.polygons;for(let{position:r,holeIndices:i,index:a,count:o}of n){let n=u(r,df);if(!L(n,this._context.clippingExtent))continue;let s=yn(r,i,3);if(s.length===0)continue;nt(t.outBoundingBox,n);let c=this._fastUpdates?.visualVariables.color,l=Oo({material:this._materials[0],indices:s,attributeData:{position:r,color:c?null:t.color,colorFeature:c?Xi(c.field,e):null,uvMapSpace:this._needsUV?Ti(t.uvMapSpace,4*a,4*o):null,olidColor:t.olidColor}});t.outGeometries.push(new Mi(l,t))}}_createAsOverlayOutline(e){if(this._materials[1]==null)return;let t=e.renderData.outlines;for(let n=0;n<t.length;++n){let{position:r}=t[n];if(u(r,df),!L(df,this._context.clippingExtent))continue;nt(e.outBoundingBox,df);let i=ca(this._materials[1],{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:r}},e.olidColor);e.outGeometries.push(new Mi(i,e))}}_getOutlineOpacity(){let e=this.symbolLayer?.outline?.color;return(this.draped?1:this._getLayerOpacity())*(e==null?0:e.a)}_getOutlineColor(){let e=this.symbolLayer?.outline?.color,t=this._getOutlineOpacity();return ga(e?.toUnitRGB(),t)}test(){return{...super.test(),createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,n)=>this._createAs3DShape(e,t,n)}}get _vvConvertOptions(){return new Gi({supports:{size:!1,color:!0,rotation:!1,opacity:!1},fallbackColor:this._materialColor?.toUnitRGBA()??w})}},df=at(),ff=class extends jo{constructor(e,t,n,r){super(e,n,r),this.color=t}},pf=class extends jo{constructor(e,t,n,r){super(e,n,r),this.color=t}};function mf(e){return e?.size!=null&&e.size>0&&e.color!=null&&(e.pattern==null||e.pattern.type!==`style`||e.pattern.style!==`none`)}function hf(e){return(e.material?.color?.a??0)===1}var gf=class{constructor(e,t=`center`,n=!1,r=D(),i=Ae(0,0,0,-1),a=`world`,o=j(),s=0){this.verticalOffset=e,this.anchor=t,this.hasLabelVerticalOffset=n,this.screenOffset=r,this.centerOffset=i,this.centerOffsetUnits=a,this.translation=o,this.elevationOffset=s}},_f=class{constructor(e,t=`center`,n=`center`,r=null,i=D(),a=!0){this.placement=e,this.horizontalPlacement=t,this.verticalPlacement=n,this.text=r,this.displaySize=i,this.isFocused=a}},vf=class e{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=bf(e.color),this.haloStyle=yf(e.halo.color),this.backgroundStyle=e.background.color[3]===0?null:bf(e.background.color)}fontString(e){let t=this.definition.font;return`${t.style} ${t.weight} ${e}px ${t.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(e,t){e.font=this.fontString(t),e.textAlign=`left`,e.textBaseline=`alphabetic`}static async fromSymbol(t,n){let r=t?.material?.color?.toUnitRGBA()??w,i=t.size==null?12:P(t.size),a=t.lineHeight,o=t.background?.color?.toUnitRGBA()??w,s={family:t.font?.family??`sans-serif`,decoration:t.font?.decoration??`none`,weight:t.font?.weight??`normal`,style:t.font?.style??`normal`},c=t.halo,l=c?.color!=null&&c.size>0?{size:P(c.size),color:c.color.toUnitRGBA()}:{size:0,color:w},u=new e({color:r,size:i,background:{color:o,padding:t.background==null?[0,0]:[.65*i,.5*i],borderRadius:t.background==null?0:i*(6/16)},lineSpacingFactor:a,font:s,halo:l,pixelRatio:n});if(t.font){let e=!1,n=u.fontString(i);try{e=(await document.fonts.load(n)).some(e=>!gr(e))}catch{Qt.getLogger(`esri.views.3d.webgl-engine.lib.TextRenderParameters`).warnOnce(`Failed to preload font '${n}'. Some text symbology may be rendered using the default browser font.`)}if(!e&&!xf.has(t.font.family))try{await hr(t.font)}catch{}}return u}};function yf(e){return`rgb(${e.slice(0,3).map(e=>Math.floor(255*e)).toString()})`}function bf(e){return`rgba(${e.slice(0,3).map(e=>Math.floor(255*e)).toString()},${e[3]})`}var xf=new Set([`Arial`,`Times New Roman`,`Courier New`,`serif`,`sans-serif`,`monospace`,`cursive`,`fantasy`,`system-ui`,`ui-serif`,`ui-sans-serif`,`ui-monospace`,`ui-rounded`,`math`,`emoji`,`fangsong`]),Sf=4096,Cf=class extends et{constructor(e){super(e),this.id=ln(),this.events=new zt,this._texture=null,this._atlas=new Df(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement(`canvas`),this._canvas.setAttribute(`id`,`textAtlasCanvas`),this._canvas.setAttribute(`style`,`display:none`),this._ctx=this._canvas.getContext(`2d`),this._stage=this.view.stage,this._stage.addTexture(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._texture=vt(this._texture),this._frameWorker=Bt(this._frameWorker),this.updating=!1,this.events.emit(`unloaded`)}get loaded(){return this._texture!=null}get texture(){return this._texture}static get maxSize(){return kf=mi.stableRendering?wf:0,[Sf-wf-kf,Sf-wf-kf-Tf]}load(e){if(this._texture)return this._texture;let t=new rn;return t.wrapMode=33071,t.samplingMode=9987,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,this._texture=new yt(e,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(Be.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._texture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=Bt(this._frameWorker),this._texture&&=(this._stage.removeTexture(this),vt(this._texture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.width=e.width,this._canvas.height=e.height}_resizeAtlas(e,t){let{width:n,height:r}=this._atlas;n===e&&r===t||(this._atlas.width=e,this._atlas.height=t,this._texture?.resize(e,t),this._texture?.updateData(0,0,0,n,r,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach(e=>this._uvCallbacks.get(e.textRenderer.key)?.forEach(t=>t(e.uv))),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(e,t,n,r){let i=this._atlas;if(i.width<n||i.height<r)return!1;let a=i.cursors.get(r);if(!a){if(i.height<i.nextY+r)return!1;a=[new Of(i.nextY)],i.cursors.set(r,a),i.nextY+=r}let o=a.find(e=>i.width>=e.x+n);if(o==null){if(i.height<i.nextY+r)return!1;o=new Of(i.nextY),i.nextY+=r,a.push(o)}return e.setNewPosition(o),this._elements.set(t,e),this._elementsToRender.set(t,e),o.x+=n,!0}_ensureCallbacks(e){let t=this._uvCallbacks.get(e);if(t)return t;let n=new Set;return this._uvCallbacks.set(e,n),n}_addCallback(e,t){this._ensureCallbacks(e).add(t)}_removeCallback(e,t){let n=this._uvCallbacks.get(e);return!(!n?.delete(t)||n.size!==0)&&(this._uvCallbacks.delete(e),!0)}_processAddition(e){let t=e.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,e);let n=this._atlas,r=e.textRenderer.renderedWidth,i=e.textRenderer.renderedHeight,a=r+wf,o=i+wf+Tf;if(!this._addAtlasElement(e,t,a,o)){if(this._canRepack)this._reset();else if(n.width<a){let e=ta(Math.max(a,1.5*n.width),Sf);this._resizeAtlas(e,n.height)}else{let e=n.nextY+o,t=ta(Math.max(e,1.5*n.height),Sf);if(t>n.height)this._resizeAtlas(n.width,t);else if(n.width<Sf){let e=ta(1.5*n.width,Sf);this._resizeAtlas(e,n.height)}}this._elements.set(t,e)}}_renderElement(e){let t=e.commitNewPosition(),n=e.textRenderer;this._ctx.clearRect(t[0]-wf,t[1]-wf,n.renderedWidth+2*wf,n.renderedHeight+2*wf),n.render(this._ctx,t[0],t[1]),this._uvCallbacks.get(n.key)?.forEach(t=>t(e.uv))}get readyToRun(){return this.updating}runTask(e){if(this._texture==null)return Ue;for(;this._needsRepack&&(this._canRepack||this._atlas.height<Sf&&this._atlas.height<Sf);){this._canRepack=this._needsRepack=!1;let t=this._elements;this._elements=new Map,t.forEach(e=>this._processAddition(e)),e.madeProgress()}if(this._elementsToRender.size>0){for(let[t,n]of this._elementsToRender){if(e.done)break;this._renderElement(n),this._elementsToRender.delete(t),e.madeProgress()}this._texture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(e,t){let n=e.key;this._addCallback(n,t);let r=this._elements.get(n);return r?Mt(r.uv,w)||t(r.uv):(r=new Ef(e),this._processAddition(r),this.setDirty()),{remove:()=>this._removeText(e,t)}}_removeText(e,t){let n=e.key;this._elements.get(n)&&this._removeCallback(n,t)&&(this._elements.delete(n),this._elementsToRender.delete(n),this._canRepack=!0)}setDirty(){this._texture&&(this.updating=!0)}get test(){}get usedMemory(){return(this._texture?.usedMemory??0)+(this._canvas?.width??0)*(this._canvas?.height??0)*4}};N([f({constructOnly:!0})],Cf.prototype,`view`,void 0),N([f({type:Boolean})],Cf.prototype,`updating`,void 0),Cf=N([Ce(`esri.views.3d.webgl-engine.lib.TextTextureAtlas`)],Cf);var wf=2,Tf=2,Ef=class{constructor(e){this.textRenderer=e,this._uv=Je(),this._newPosition=[0,0]}get uv(){if(this._xOffset==null||this._yOffset==null)return w;let{renderedWidth:e,renderedHeight:t}=this.textRenderer;return jt(this._uv,this._xOffset,this._yOffset+t,this._xOffset+e,this._yOffset)}setNewPosition(e){this._newPosition[0]=e.x,this._newPosition[1]=e.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}},Df=class{constructor(e,t){this.width=e,this.height=t,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=kf}},Of=class{constructor(e){this.y=e,this.x=kf}},kf=0,Af=class{constructor(e,t,n){this._renderer=new _o(e,t,n,Cf.maxSize)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){let e=po(jf,this._renderer.renderedWidth,this._renderer.renderedHeight),t=e.getContext(`2d`);return t.save(),this._renderer.render(t,0,0),t.restore(),new na(e,{wrap:{s:33071,t:33071},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0})}},jf={canvas:null},Mf=Ft(0,0,1),Nf=class extends Va{constructor(e,t,n,r){super(e,t,n,r),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){let e=_a(this.symbolLayer.size);if(e)throw new a(`graphics3dtextsymbollayer:invalid-size`,e)}await this._createTextRenderParameters()}async _createTextRenderParameters(){let e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await vf.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){let t=e.graphic,n=Ha(t.geometry);if(n==null)return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;let r=this.view.focusAreasView?.containsGeometry(n)??!0,i=this.symbolLayer.text;if(i==null||i===``)return null;let a=re(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(a!=null&&!x(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;let{verticalAlignment:o}=this.symbolLayer,s=new gf(a);ho(o,s.screenOffset);let c=new _f(s,this.symbolLayer.horizontalAlignment,go(o));return c.isFocused=r??c.isFocused,this._createAs3DShape(t,n,i,c)}get needsUpdateFocus(){return!0}createLabel(e,t,n,r,i){let a=e.graphic,o=Ha(a.geometry);if(o==null)return this.logger.warn(`unsupported geometry type for label: ${a.geometry.type}`),null;let s=this.view.focusAreasView?.containsGeometry(o)??!0,c=t.text;return!c||/^\s+$/.test(c)?null:(t.isFocused=s??t.isFocused,this._createAs3DShape(a,o,c,t,n,r,i))}createElevationContextForGraphic(e,t=0){let n=super.createElevationContextForGraphic(e);return n.addOffsetRenderUnits(t),n}updateElevationContextForGraphic(e,t,n=0){super.updateElevationContextForGraphic(e,t),e.addOffsetRenderUnits(n)}layerOpacityChanged(){return this.logger.warn(`layer opacity change not yet implemented in Graphics3DTextSymbolLayer`),!1}layerScreenSizePerspectiveChanged(e,t){let n=!this.draped&&this._context.screenSizePerspectiveEnabled,r=n?this.view.screenSizePerspective.labelParameters:null,i=n?this.view.screenSizePerspective.parameters:null;Pf(e,t,e=>{for(let t of e.stageObject.geometries)t.material.setParameters({screenSizePerspective:r,screenSizePerspectiveAlignment:i})})}layerElevationInfoChanged(e,t){return Pf(e,t,(e,t)=>{this.graphics3DGraphicLayerElevationInfoChanged(t,e)}),1}slicePlaneEnabledChanged(e,t){return Pf(e,t,e=>{for(let t of e.stageObject.geometries)t.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}terrainTransparencyChanged(){return this.draped}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return!1}graphics3DGraphicLayerElevationInfoChanged(e,t){let{elevationContext:n,metadata:r}=t;this.updateElevationContextForGraphic(n,e,r?.elevationOffset??0),t.needsElevationUpdates=ui(n.mode)||n.mode===`absolute-height`}updateGeometry(e,t){let n=e.geometry;if(this.draped||!n||!this._validateGeometry(n))return!1;let{elevationContext:r,stageObject:i}=t;if(r.mode!==this.getGeometryElevationMode(n))return!1;let a=Ha(n);if(!a)return!1;r.updateFeatureExpressionFeature(e,this._context.layer);let o=Da(i,this._context,a,r);if(o==null)return!1;let s=Ba(this._context,a);return i.geometries[0].localOrigin===s&&(t.alignedSampledElevation=o,La(t,a,this._context.elevationProvider),!0)}_defaultElevationInfoNoZ(){return If}_createAs3DShape(e,t,n,r,i,a=null,o=()=>r.placement.elevationOffset){let s=this.createElevationContextForGraphic(e,r.placement.elevationOffset),c=e.uid,l=null,u=null;if(a==null){let e=lo(r.horizontalPlacement);l=new Af(n,e,this._textRenderParameters);let t=null;if(this._context.sharedResources.textures!=null){u=this._context.sharedResources.textures.fromData(l.key,()=>l.create()),u.managedTexture.events.on(`unloaded`,()=>t=Qe(t));let e=this._context.stage.renderView.textures.acquire(u.managedTexture.id);if(e==null||dn(e))return u.release(),null;t=e}}let d=this.symbolLayer.occludedVisibility?.mode??`hidden`,f=this.view.basemapTerrain,p=!f.opaque&&!f.invisible,m=Ff(l,r),h={useVisibilityPixel:p&&d===`hidden`,occludedVisibilityMode:this.symbolLayer.occludedVisibility?.mode??`hidden`,occludedFragmentFade:!1,horizonCullingEnabled:this._context.spherical,screenOffset:r.placement.screenOffset,anchorPosition:m,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:r.placement.centerOffsetUnits,depthEnabled:!1,drawAsLabel:!0,isLabel:!0,isFocused:r.isFocused};if(e.geometry?.type===`polyline`&&(h.shaderPolygonOffset=1e-4),a?h.textureId=a.id:u&&(h.textureId=u.managedTexture.id),r.placement.verticalOffset!=null){let{screenLength:e,minWorldLength:t,maxWorldLength:n}=r.placement.verticalOffset;h.verticalOffset={screenLength:P(e),minWorldLength:t||0,maxWorldLength:n??1/0}}let g=this._context.graphicsCoreOwner.view.focusAreasView?.polygons.length,_={screenOffset:h.screenOffset,anchorPosition:m,centerOffsetUnits:h.centerOffsetUnits,verticalOffset:h.verticalOffset,shaderPolygonOffset:h.shaderPolygonOffset,useVisibilityPixel:h.useVisibilityPixel,occludedVisibilityMode:h.occludedVisibilityMode,isFocused:r.isFocused,focusStyle:this.view.map?.focusAreas.style??`none`};if(this._context.screenSizePerspectiveEnabled){let{parameters:e,labelParameters:t}=this.view.screenSizePerspective,n=uo(this._textRenderParameters);h.screenSizePerspective=t,h.screenSizePerspectiveMinPixelReferenceSize=n.maxHeight,h.screenSizePerspectiveAlignment=e,_.fontHeight=n.maxHeight}h.hasSlicePlane=this._context.slicePlaneEnabled;let v=this._context.spherical,y=i?JSON.stringify(_):``,b=i?.get(y);if(b==null){if(!r.isFocused&&g){let e=this.view.map?.focusAreas.style;h.color=ys(h.color,e),h.outlineColor=ys(h.outlineColor,e)}b=new ha(h,v),i?.set(y,b)}let x=r.placement.translation,S=l?C(l.displayWidth,l.displayHeight):ve,ee=r.placement.centerOffset,te=Mf,ne=a?Ae(0,0,0,0):null,re=fa(b,{normal:te,position:x,size:S,centerOffsetAndDistance:ee,uvi:ne}),ie=Ma(this._context,t,re,s,c);if(ie==null)return null;let ae=(t,n,i,a,s,c)=>{let l=o()||r.placement.elevationOffset;return this.updateElevationContextForGraphic(n,e,l),ja(t,n,i,a,s,c)},oe=new Ua(this,ie.object,u,ae,s);return oe.alignedSampledElevation=ie.sampledElevation,oe.hiddenIfDeconflicted=!0,oe.needsElevationUpdates=ui(s.mode)||s.mode===`absolute-height`,oe.getScreenSize=(e=D())=>(e[0]=l?l.displayWidth:r.displaySize[0],e[1]=l?l.displayHeight:r.displaySize[1],e),oe.metadata=new Fa(r.placement.elevationOffset,n),La(oe,t,this._context.elevationProvider),oe}};function Pf(e,t,n){e?.forEach(e=>{let r=t(e);r!=null&&n(r,e.graphic)})}function Ff(e,t){if(t.verticalPlacement===`baseline`){let n=fo[t.horizontalPlacement],r=e==null?0:e.baselineAnchorY;return C(n,r)}let n=mo(t.horizontalPlacement,t.verticalPlacement);return vo[n]}var If={mode:`relative-to-ground`,offset:0},Lf=class extends yi{constructor(e,t){super(e,t,qi()?Vi:ki),this.shader=new Si(Eo,()=>i(()=>import(`./WaterSurface.glsl-CU4Ima_e.js`),__vite__mapDeps([96,97,2,3,98,56,42,24,36,28,23,60,46,35,30,38,47,44,26,27,29,61,34,43,39,62,41,92,40,33,37,91,67,31,45,48])))}initializePipeline(e){let{oitPass:t,output:n,hasEmission:r,transparent:i,draped:a}=e;return kr({blending:n!==2&&n!==8&&n!==9&&i?zr(t):null,depthTest:a?null:Fr(t),depthWrite:Mr(e),drawBuffers:Vr(t,r),colorWrite:Er,polygonOffset:ri(e)})}};Lf=N([Ce(`esri.views.3d.webgl-engine.materials.WaterTechnique`)],Lf);var Rf=class extends ar{ensureResources(e){return this._techniques.context.waterTextures.ensureResources(e)}beginSlot(e){let t=this._techniques.context.waterTextures.passParameters;return this._material.setParameters({wavePerturbation:t.wavePerturbation,waveNormal:t.waveNormal}),this.getTechnique(Lf,e)}},zf=class extends Rr{constructor(e){super(),this.spherical=e,this.receiveShadows=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=0,this.emissionSource=0,this.pbrMode=3,this.occlusionPass=!1,this.useCustomDTRExponentForWater=!0,this.highStepCount=!0,this.useFillLights=!1,this.overlayEnabled=!1,this.snowCover=!1}get discardInvisibleFragments(){return this.transparent&&this.writeDepth}};N([V()],zf.prototype,`receiveShadows`,void 0),N([V()],zf.prototype,`transparent`,void 0),N([V()],zf.prototype,`enableOffset`,void 0),N([V()],zf.prototype,`writeDepth`,void 0),N([V()],zf.prototype,`screenSpaceReflections`,void 0),N([V()],zf.prototype,`cloudReflections`,void 0),N([V()],zf.prototype,`draped`,void 0),N([V()],zf.prototype,`terrainDepthTest`,void 0),N([V()],zf.prototype,`cullAboveTerrain`,void 0);var Bf=class extends Ni{constructor(e,t){super(e,Vf),this.visible=!0,this.produces=new Map([[2,e=>B(e)&&!this.parameters.transparent||ir(e)],[4,e=>B(e)&&this.parameters.transparent||ir(e)],[19,e=>this.parameters.draped&&B(e)||e===2||ir(e)],[20,e=>e===2]]),this._configuration=new zf(t.spherical)}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.writeDepth=!0,this._configuration.receiveShadows=B(e)&&t.shadowMap.enabled,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.screenSpaceReflections=t.ssr.lastFrameColor!=null,this._configuration.cloudReflections=t.clouds.data!=null,this._configuration.draped=this.parameters.draped,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.enableOffset,this._configuration.terrainDepthTest=t.terrainDepthTest&&B(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}update(e){return this.setParameters({timeElapsed:le(e.time)*this.parameters.animationSpeed},!1),this._animationEnabled(e.camera)&&e.dt>0}_animationEnabled(e){let t=Math.min(e.relativeElevation,e.distance);return Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<Hf}createGLMaterial(e){return new Rf(e)}createBufferWriter(){return new ei(qi()?Ii:Ai)}get test(){}},Vf=class extends Nr{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=C(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=Ae(0,0,0,0),this.transparent=!0,this.hasSlicePlane=!1,this.draped=!1,this.origin=j(),this.modelTransformation=null}},Hf=35e3,Uf={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},Wf=[`polyline`,`polygon`,`extent`],Gf=class e extends Va{static{this.unitSizeOfTexture=100}static{this.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,n,r){super(e,t,n,r)}async doLoad(){}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,Wf,this.symbolLayer.type))return null;let n=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus(n.mode===`on-the-ground`),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,n,t.uid)}ensureMaterial(){if(this._materials[0])return;let e=new Vf,t=this.symbolLayer.color.toUnitRGBA();t[3]*=this._getLayerOpacity(),e.color=t,e.transparent=t[3]<1||this.needsDrivenTransparentPass,e.waveDirection=this.symbolLayer.waveDirection==null?C(0,0):Kf(this.symbolLayer.waveDirection);let n=this.symbolLayer.waveStrength+`-`+this.symbolLayer.waterbodySize,r=Uf[n];e.waveStrength=r.waveStrength,e.waveTextureRepeat=r.textureRepeat,e.waveVelocity=r.waveVelocity,e.flowStrength=r.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.draped=this.draped,this._materials[0]=new Bf(e,this._context)}layerOpacityChanged(){if(this._materials[0]==null)return;let e=this._materials[0].parameters.color,t=this.symbolLayer.color.a*this._getLayerOpacity(),n=t<1||this.needsDrivenTransparentPass;this._materials[0].setParameters({color:[e[0],e[1],e[2],t],transparent:n})}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(t,n,r){let i=this._elevationContext.mode,a=fi(e.elevationModeChangeTypes,r,i);if(a!==1)return a;let o=ui(i);return this.updateGraphics3DGraphicElevationInfo(t,n,()=>o)}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}get needsDrivenTransparentPass(){return!1}_createAs3DShape(e,t,n){let r=Ao(e.geometry);if(r==null)return null;let i=Mo(r,this._context.elevationProvider,this._context.renderCoordsHelper,t),a=i.position.length/3,o=Ei(2*a);qf(o,i.mapPositions,a,this._context.elevationProvider.spatialReference);let s=new Qf(i,o,this._context.layerViewUid,e.uid);if(s.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(s),this._create3DShapeGeometries(s),this._logGeometryCreationWarnings(s.renderData,r.rings,`rings`,`WaterSymbol3DLayer`),s.outGeometries.length===0)return null;let c=new hi({geometries:s.outGeometries,castShadow:!1,layerViewUid:this._context.layerViewUid,graphicUid:n}),l=new Ua(this,c,null,za,t);return l.alignedSampledElevation=s.renderData.sampledElevation,l.needsElevationUpdates=ui(t.mode),l}_create3DShapeGeometries(e){let t=e.renderData.polygons,n=e.uvCoords;for(let{count:r,index:i,position:a,mapPositions:o,holeIndices:s}of t){if(this._context.clippingExtent!=null&&(u(o,Zf),!L(Zf,this._context.clippingExtent)))continue;let t=yn(o,s,3);if(t.length===0)continue;let c=Ti(n,2*i,2*r),l=ko({material:this._materials[0],indices:t,mapPositions:o,attributeData:{position:a,uv0:c}},e.olidColor);e.outGeometries.push(l)}}_createAsOverlay(e){let t=Ao(e.geometry);if(t==null)return null;this._materials[0].renderPriority=this._renderPriority;let n=No(t,this._context.overlaySR),r=n.position.length/3,i=Ei(2*r);qf(i,n.position,r,this._context.overlaySR);let a=new $f(n,i,this._context.layerViewUid,e.uid);return a.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(a),a.outBoundingBox=Et(),this._createAsOverlayWater(a),this._logGeometryCreationWarnings(a.renderData,t.rings,`rings`,`WaterSymbol3DLayer`),a.outGeometries.length===0?null:new bs(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(e){let t=e.uvCoords,n=e.renderData.polygons;for(let{position:r,holeIndices:i,index:a,count:o}of n){if(u(r,Zf),!L(Zf,this._context.clippingExtent))continue;nt(e.outBoundingBox,Zf);let n=yn(r,i,3);if(n.length===0)continue;let s=Ti(t,2*a,2*o),c=ko({material:this._materials[0],indices:n,attributeData:{position:r,uv0:s}},e.olidColor);e.outGeometries.push(new Mi(c,e))}}test(){return{...super.test(),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}};function Kf(e){let t=D(),n=b(e);return t[0]=Math.sin(n),t[1]=Math.cos(n),t}function qf(e,t,n,r){let i=c(r);Re(Yf);for(let e=0;e<n;e++)l(Xf,t[3*e],t[3*e+1]),Ut(Yf,Xf);en(Yf,Yf,i);let a=Yf[0]%Gf.unitSizeOfTexture,o=Yf[1]%Gf.unitSizeOfTexture;Jf[0]=Yf[0]-a,Jf[1]=Yf[1]-o;for(let r=0;r<n;r++)e[2*r]=(t[3*r]*i-Jf[0])/Gf.unitSizeOfTexture,e[2*r+1]=(t[3*r+1]*i-Jf[1])/Gf.unitSizeOfTexture}var Jf=D(),Yf=Zt(),Xf=D(),Zf=at(),Qf=class extends jo{constructor(e,t,n,r){super(e,n,r),this.uvCoords=t}},$f=class extends jo{constructor(e,t,n,r){super(e,n,r),this.uvCoords=t}};function ep(e,t,n,r){let i=np[e.type]?.[t.type]||tp[t.type];return i?new i(e,t,n,r):(Qt.getLogger(`esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory`).error(`GraphicsLayerFactory#make`,`unknown symbol type ${t.type}`),null)}var tp={icon:Os,object:Pl,line:Xs,path:bd,fill:uf,extrude:Uo,text:Nf,water:Gf},np={"mesh-3d":{fill:Nc}};export{ep as make};