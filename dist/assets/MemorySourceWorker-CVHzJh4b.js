import{Ap as e,BT as t,B_ as n,Dv as r,En as i,Ev as a,Fp as o,dd as s,mS as c}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./OptimizedFeatureSet-CTIqq8fn.js";import{i as l,n as u,r as d}from"./featureConversionUtils-_DSSMFQ2.js";import"./WhereClause-CO9FHcAq.js";import"./WhereClauseCache-Hc_hnaJ1.js";import"./PooledRBush-kIuSXR8J.js";import"./QueryEngineCapabilities-BJYIHckU.js";import{n as f,r as p,t as m}from"./clientSideDefaults-hJqezokg.js";import"./generateRendererUtils-3fX8Itfa.js";import"./utils-DD8h9sO0.js";import"./BoundsStore-Cb3Fp4W3.js";import"./timeSupport-DTr00ezP.js";import"./optimizedFeatureQueryEngineAdapter-DdSTa-WE.js";import{t as h}from"./FeatureStore-BI832uP0.js";import{t as g}from"./QueryEngine-BmSuo7NQ.js";import{c as _,l as v}from"./queryUtils-DcyDFw5_.js";import"./quantizationUtils-CGy9nkLl.js";import"./utils-DhzlDVJ-.js";import"./utils-DfE5TL5h.js";import"./SnappingCandidate-CSwuQTV6.js";import"./FixedIntervalBinParameters-Dvwocz3j.js";import{n as y,t as b}from"./objectIdUtils-Bw-IhBfb.js";import"./date-4JksS9rw.js";import{a as x,i as S,n as C,o as w,r as T,t as E}from"./sourceUtils-3L4uhiUn.js";var D=c,O={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:c},k={hasAttachments:!1,capabilities:`query, editing, create, delete, update`,useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsQueryAttachmentOrderByFields:!1,supportsQueryAttachmentWithTypeWildcard:!1,supportsQueryBins:!0,supportsQueryPivot:!1,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!0,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0,supportsQueryWithCacheHint:!0},queryBinsCapabilities:C};function A(e){return a(e)?e.z!=null:!!e.hasZ}function j(e){return a(e)?e.m!=null:!!e.hasM}var M=class{constructor(){this._queryEngine=null,this._nextObjectId=null}destroy(){this._queryEngine?.destroy(),this._queryEngine=this._createDefaultAttributes=null}async load(n){let r=[],{features:a}=n,c=this._inferLayerProperties(a,n.fields),l=n.fields||[],u=n.hasM==null?!!c.hasM:n.hasM,d=n.hasZ==null?!!c.hasZ:n.hasZ,v=!n.spatialReference&&!c.spatialReference,y=v?D:n.spatialReference||c.spatialReference,x=v?O:null,S=n.geometryType||c.geometryType,C=!S,w=n.objectIdField||c.objectIdField,T=n.timeInfo,E=new i(l);if(!C&&(v&&r.push({name:`feature-layer:spatial-reference-not-found`,message:`Spatial reference not provided or found in features. Defaults to WGS84`}),!S))throw new t(`feature-layer:missing-property`,`geometryType not set and couldn't be inferred from the provided features`);if(!w)throw new t(`feature-layer:missing-property`,`objectIdField not set and couldn't be found in the provided fields`);if(c.objectIdField&&w!==c.objectIdField&&(r.push({name:`feature-layer:duplicated-oid-field`,message:`Provided objectIdField "${w}" doesn't match the field name "${c.objectIdField}", found in the provided fields`}),w=c.objectIdField),w&&!c.objectIdField){let e=E.get(w);e?(w=e.name,e.type=`esriFieldTypeOID`,e.editable=!1,e.nullable=!1):l.unshift({alias:w,name:w,type:`esriFieldTypeOID`,editable:!1,nullable:!1})}for(let e of l){if(e.name??=e.alias,e.alias??=e.name,!e.name)throw new t(`feature-layer:invalid-field-name`,`field name is missing`,{field:e});if(e.name===w&&(e.type=`esriFieldTypeOID`),!s.jsonValues.includes(e.type))throw new t(`feature-layer:invalid-field-type`,`invalid type for field "${e.name}"`,{field:e});e.length??=o(e)}let A={};for(let t of l)if(t.type!==`esriFieldTypeOID`&&t.type!==`esriFieldTypeGlobalID`){let n=e(t);n!==void 0&&(A[t.name]=n)}if(T){if(T.startTimeField){let e=E.get(T.startTimeField);e?(T.startTimeField=e.name,e.type=`esriFieldTypeDate`):T.startTimeField=null}if(T.endTimeField){let e=E.get(T.endTimeField);e?(T.endTimeField=e.name,e.type=`esriFieldTypeDate`):T.endTimeField=null}if(T.trackIdField){let e=E.get(T.trackIdField);e?T.trackIdField=e.name:(T.trackIdField=null,r.push({name:`feature-layer:invalid-timeInfo-trackIdField`,message:`trackIdField is missing`,details:{timeInfo:T}}))}T.startTimeField||T.endTimeField||(r.push({name:`feature-layer:invalid-timeInfo`,message:`startTimeField and endTimeField are missing or invalid`,details:{timeInfo:T}}),T=null)}let j=E.dateFields.length?{timeZoneIANA:n.dateFieldsTimeZone??`UTC`}:null;this._createDefaultAttributes=m(A,w);let M={warnings:r,featureErrors:[],layerDefinition:{...k,drawingInfo:p(S),templates:f(A),extent:x,geometryType:S,objectIdField:w,fields:l,hasZ:d,hasM:u,timeInfo:T,dateFieldsTimeReference:j},assignedObjectIds:{}},N={type:`object-id`,fieldName:w};return this._queryEngine=new g({fieldsIndex:i.fromLayerJSON({fields:l,timeInfo:T,dateFieldsTimeReference:j}),geometryType:S,hasM:u,hasZ:d,featureIdInfo:N,spatialReference:y,featureStore:new h({geometryType:S,hasM:u,hasZ:d}),timeInfo:T}),a?.length?(this._nextObjectId=b(w,a)+1,await _(a,y),this._loadInitialFeatures(M,a)):(this._nextObjectId=1,M)}async applyEdits(e){let{spatialReference:t,geometryType:n}=this._queryEngine;return await Promise.all([E(t,n),_(e.adds,t),_(e.updates,t)]),this._applyEdits(e)}queryFeatures(e,t={}){return this._queryEngine.executeQuery(e,t.signal)}queryFeatureCount(e,t={}){return this._queryEngine.executeQueryForCount(e,t.signal)}queryObjectIds(e,t={}){return this._queryEngine.executeQueryForIds(e,t.signal)}queryExtent(e,t={}){return this._queryEngine.executeQueryForExtent(e,t.signal)}querySnapping(e,t={}){return this._queryEngine.executeQueryForSnapping(e,t.signal)}queryAttributeBins(e,t={}){return this._queryEngine.executeAttributeBinsQuery(e,t.signal)}_inferLayerProperties(e,t){let n,i,a=null,o=null,s=null;for(let t of e){let e=t.geometry;if(e!=null&&(a||=r(e),o||=e.spatialReference,n??=A(e),i??=j(e),a&&o&&n!=null&&i!=null))break}if(t&&t.length){let e=null;t.some(t=>{let n=t.type===`esriFieldTypeOID`,r=!t.type&&t.name&&t.name.toLowerCase()===`objectid`;return e=t,n||r})&&(s=e.name)}return{geometryType:a,spatialReference:o,objectIdField:s,hasM:i,hasZ:n}}async _loadInitialFeatures(e,t){let{geometryType:n,hasM:i,hasZ:a,objectIdField:o,spatialReference:s,featureStore:c,fieldsIndex:l}=this._queryEngine,u=[],f={type:`object-id`,fieldName:o};for(let i of t){if(i.uid!=null&&(e.assignedObjectIds[i.uid]=-1),i.geometry&&n!==r(i.geometry)){e.featureErrors.push(w(`Incorrect geometry type.`));continue}let t=this._createDefaultAttributes(),a=T(l,t,i.attributes,!0);a?e.featureErrors.push(a):(this._assignObjectId(t,i.attributes,!0),i.attributes=t,i.uid!=null&&(e.assignedObjectIds[i.uid]=i.attributes[o]),i.geometry!=null&&(i.geometry=v(i.geometry,i.geometry.spatialReference,s)),u.push(i))}c.addMany(d([],u,n,a,i,f));let{fullExtent:p,timeExtent:m}=await this._queryEngine.fetchRecomputedExtents();if(e.layerDefinition.extent=p,m){let{start:t,end:n}=m;e.layerDefinition.timeInfo.timeExtent=[t,n]}return e}async _applyEdits(e){let{adds:t,updates:n,deletes:r}=e,i={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t?.length&&this._applyAddEdits(i,t),n?.length&&this._applyUpdateEdits(i,n),r?.length){for(let e of r)i.deleteResults.push(S(e));this._queryEngine.featureStore.removeManyById(r)}let{fullExtent:a,timeExtent:o}=await this._queryEngine.fetchRecomputedExtents();return{extent:a,timeExtent:o,featureEditResults:i}}_applyAddEdits(e,t){let{addResults:n}=e,{geometryType:i,hasM:a,hasZ:o,objectIdField:s,spatialReference:c,featureStore:l,featureIdInfo:u,fieldsIndex:f}=this._queryEngine,p=[];for(let a of t){if(a.geometry&&i!==r(a.geometry)){n.push(w(`Incorrect geometry type.`));continue}let t=this._createDefaultAttributes(),o=T(f,t,a.attributes);if(o)n.push(o);else{if(this._assignObjectId(t,a.attributes),a.attributes=t,a.uid!=null){let t=a.attributes[s];e.uidToObjectId[a.uid]=t}if(a.geometry!=null){let e=a.geometry.spatialReference??c;a.geometry=v(x(a.geometry,e),e,c)}p.push(a),n.push(S(a.attributes[s]))}}l.addMany(d([],p,i,o,a,u))}_applyUpdateEdits({updateResults:e},t){let{geometryType:n,hasM:i,hasZ:a,objectIdField:o,spatialReference:s,featureStore:c,fieldsIndex:d,featureIdInfo:f}=this._queryEngine;for(let p of t){let{attributes:t,geometry:m}=p,h=t?.[o];if(h==null){e.push(w(`Identifier field ${o} missing`));continue}if(!c.has(h)){e.push(w(`Feature with object id ${h} missing`));continue}let g=l(c.getFeature(h),n,a,i);if(m!=null){if(n!==r(m)){e.push(w(`Incorrect geometry type.`));continue}let t=m.spatialReference??s;g.geometry=v(x(m,t),t,s)}if(t){let n=T(d,g.attributes,t);if(n){e.push(n);continue}}c.add(u(g,n,a,i,f)),e.push(S(h))}}_assignObjectId(e,t,n=!1){let r=this._queryEngine.objectIdField;n&&t&&isFinite(t[r])?e[r]=t[r]:e[r]=this._nextObjectId++}};export{M as default};