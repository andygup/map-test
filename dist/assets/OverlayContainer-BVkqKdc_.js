import{Ay as e,By as t,Fb as n,Fy as r,Is as i,Ms as a,Ny as o,Py as s,Xl as c,Yl as l,bS as u,fu as d,gD as f,ou as p,vD as m,vT as h}from"./index-ByaFsVj4.js";import{t as g}from"./VertexElementDescriptor-C9CNG143.js";import{k as _}from"./FeatureCommandQueue-BbpRY2Wt.js";import{t as v}from"./WGLContainer-CiXk9por.js";import{n as y}from"./vec3f32-BWuLbfSR.js";import{H as b,Lt as x,M as S,Mt as C,_ as w,a as T,c as E,jt as D,l as O,n as k,q as A,r as j,s as M,t as N,u as P,wt as F,z as I}from"./GraphShaderModule-VKGmZBI7.js";import{t as L}from"./utils-Bb-KLMVN.js";var R=class extends N{};f([T(0,I)],R.prototype,`pos`,void 0),f([T(1,I)],R.prototype,`uv`,void 0);var z=class extends k{},B=class extends P{};f([E(F)],B.prototype,`dvs`,void 0);var V=class extends P{};f([E(I)],V.prototype,`perspective`,void 0),f([E(I)],V.prototype,`texSize`,void 0),f([E(w)],V.prototype,`wrapAroundShift`,void 0),f([E(w)],V.prototype,`opacity`,void 0),f([E(S)],V.prototype,`texture`,void 0);var H=class extends j{constructor(){super(...arguments),this.type=`OverlayShader`}vertex(e){let t=e.uv.divide(this.config.texSize),n=new w(1).add(D(t,this.config.perspective)),r=new b(e.pos.add(new I(this.config.wrapAroundShift,0)),1),i=this.transform.dvs.multiply(r);return{uv:t,glPosition:new A(i.xy.multiply(n),0,n)}}fragment(e){let t=C(this.config.texture,e.uv).multiply(this.config.opacity),n=new O;return n.fragColor=t,n}};f([E(B)],H.prototype,`transform`,void 0),f([E(V)],H.prototype,`config`,void 0),f([m(0,M(R))],H.prototype,`vertex`,null),f([m(0,M(z))],H.prototype,`fragment`,null);var U=class extends x{constructor(){super(...arguments),this.type=25,this._mesh=null,this.shaders={overlay:new H}}render(e,t){let{context:n,painter:r}=e,i=this._getMesh(e,t);r.setPipelineState(L);let{isWrapAround:a,wrapAroundShift:o}=t.config,s={...t.config,wrapAroundShift:0},c={shader:this.shaders.overlay,uniforms:{transform:t.transform,config:s},defines:null,optionalAttributes:null,useComputeBuffer:!1};r.setPipelineState({...L,stencil:{write:!1,test:{compare:514,op:{fail:7680,zFail:7680,zPass:7681},mask:255}}}),r.submitDrawMeshUntyped(n,c,i,{stencilRef:0}),a&&(s.wrapAroundShift=o,r.submitDrawMeshUntyped(n,c,i,{stencilRef:0}))}shutdown(){h(this._mesh)}_getMesh(e,t){let{context:n}=e;if(this._mesh){let e=this._mesh.vertexBuffers.get(`positions`);if(!e)throw Error(`Buffer not found`);e.setData(t.position)}else{let e=t.index==null?t.position.length/2:t.index.length;this._mesh=new _(n,{vertex:{positions:{data:t.position,layout:[new g(`pos`,2,a.FLOAT,0,8)]},uvs:{data:t.tex,layout:[new g(`uv`,2,a.UNSIGNED_SHORT,0,4)]}},index:t.index==null?void 0:{index:{data:t.index}},groups:[{index:t.index==null?void 0:`index`,primitive:i.TRIANGLE_STRIP}],parts:[{group:0,start:0,count:e}]})}return this._mesh}},W=class extends v{constructor(){super(...arguments),this._viewStateId=-1,this._dvsMat3=c(),this._overlayTechnique=new U}get dvsMat3(){return this._dvsMat3}beforeRender(e){this._updateMatrices(e),this._updateOverlays(e,this.children);for(let t of this.children)t.beforeRender(e)}doRender(e){if(e.drawPhase!==1||!this.visible)return;super.doRender(e);let t=this._overlayTechnique;for(let n of this.children)n.draw(e,t)}onDetach(){this._overlayTechnique.shutdown()}_updateMatrices(i){let{state:a}=i,{id:c,size:u,pixelRatio:f,resolution:p,rotation:m,viewpoint:h,displayMat3:g}=a;if(this._viewStateId===c)return;let _=n(m),v=f*u[0],b=f*u[1];this._localOrigin=h.targetGeometry.clone();let{x,y:S}=this._localOrigin,C=d(x,a.spatialReference);this._localOrigin.x=C,this._localOrigin.y=S;let w=p*v,T=p*b,E=t(this._dvsMat3);r(E,E,g),e(E,E,l(v/2,b/2)),o(E,E,y(v/w,-b/T,1)),s(E,E,-_),this._viewStateId=c}_updateOverlays(e,t){let{state:r}=e,{rotation:i,spatialReference:a,worldScreenWidth:o,size:s,viewpoint:c}=r,l=this._localOrigin,d,f=0,m=u(a);if(m&&a.isWrappable){let e=s[0],t=s[1],l=n(i),u=Math.abs(Math.cos(l)),h=Math.abs(Math.sin(l)),g=Math.round(e*u+t*h),[_,v]=m.valid,y=p(a),{x:b,y:x}=c.targetGeometry,S=[b,x],C=[0,0];r.toScreen(C,S);let w=[0,0],T;T=g>o?.5*o:.5*g;let E=Math.floor((b+.5*y)/y),D=_+E*y,O=v+E*y,k=[C[0]+T,0];r.toMap(w,k),w[0]>O&&(f=y),k[0]=C[0]-T,r.toMap(w,k),w[0]<D&&(f=-y),d={worldWidth:y,xBounds:[_,v]}}for(let e of t)e.updateDrawCoords(l,f,r,d)}};export{W as t};