import{$T as e,AS as t,CE as n,ES as r,FE as i,Ji as a,LS as o,Od as s,SS as c,Xn as l,Xw as u,Yi as d,bh as f,hv as p,qC as m,qp as h,uh as g,xh as _,xu as v}from"./index-BN8X5Ryz.js";function y(e){return e?.applyEdits!=null}function b(e){return typeof e==`object`&&!!e&&`objectId`in e&&!!e.objectId}function x(e){return e.every(b)}function S(e){return typeof e==`object`&&!!e&&`globalId`in e&&!!e.globalId}function C(e){return e.every(S)}async function w(e,t,n,r={}){let o,s=`gdbVersion`in e?e.gdbVersion:null,c=r.gdbVersion??s;if(d(e)&&e.url)o=a(e.url,e.layerId,c,r.returnServiceEditsOption===`original-and-current-features`);else{o=u(),o.promise.then(t=>{(t.addedFeatures.length||t.updatedFeatures.length||t.deletedFeatures.length||t.addedAttachments.length||t.updatedAttachments.length||t.deletedAttachments.length)&&e.emit(`edits`,t)});let t={result:o.promise};e.emit(`apply-edits`,t)}try{let{results:a,edits:s}=await T(e,t,n,r),c=e=>e.filter(e=>!e.error).map(i),l={edits:s,addedFeatures:c(a.addFeatureResults),updatedFeatures:c(a.updateFeatureResults),deletedFeatures:c(a.deleteFeatureResults),addedAttachments:c(a.addAttachmentResults),updatedAttachments:c(a.updateAttachmentResults),deletedAttachments:c(a.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:a.editMoment?new Date(a.editMoment):null,globalIdToObjectId:r.globalIdToObjectId};return a.editedFeatureResults?.length&&(l.editedFeatures=a.editedFeatureResults),o.resolve(l),a}catch(e){throw o.reject(e),e}}async function T(t,n,r,i){if(await t.load(),!y(n))throw new e(`${t.type}-layer:no-editing-support`,`Layer source does not support applyEdits capability`,{layer:t});if(!f(t))throw new e(`${t.type}-layer:editing-disabled`,`Editing is disabled for layer`,{layer:t});let{edits:a,options:o}=await E(t,r,i);return a.addFeatures?.length||a.updateFeatures?.length||a.deleteFeatures?.length||a.addAttachments?.length||a.updateAttachments?.length||a.deleteAttachments?.length?{edits:a,results:await n.applyEdits(a,o)}:{edits:a,results:{addFeatureResults:[],updateFeatureResults:[],deleteFeatureResults:[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}}}async function E(t,r,i){let a=_(t),o=r&&(r.addFeatures||r.updateFeatures||r.deleteFeatures),s=r&&(r.addAttachments||r.updateAttachments||r.deleteAttachments),c=t.infoFor3D!=null;if(L(r,a,i,!!o,!!s,`${t.type}-layer`),!a.data.isVersioned&&i?.gdbVersion)throw new e(`${t.type}-layer:invalid-parameter`,`'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isVersioned'`);if(!a.editing.supportsRollbackOnFailure&&i?.rollbackOnFailureEnabled)throw new e(`${t.type}-layer:invalid-parameter`,`This layer does not support 'rollbackOnFailureEnabled' parameter. See: 'capabilities.editing.supportsRollbackOnFailure'`);let l={...i};if(l.rollbackOnFailureEnabled!=null||a.editing.supportsRollbackOnFailure||(l.rollbackOnFailureEnabled=!0),l.rollbackOnFailureEnabled||l.returnServiceEditsOption!==`original-and-current-features`||(!1===l.rollbackOnFailureEnabled&&n.getLogger(`esri.layers.graphics.editingSupport`).warn(`${t.type}-layer:invalid-parameter`,`'original-and-current-features' is valid for 'returnServiceEditsOption' only when 'rollBackOnFailure' is true, but 'rollBackOnFailure' was set to false. 'rollBackOnFailure' has been overwritten and set to true.`),l.rollbackOnFailureEnabled=!0),!a.editing.supportsReturnServiceEditsInSourceSpatialReference&&l.returnServiceEditsInSourceSR)throw new e(`${t.type}-layer:invalid-parameter`,`This layer does not support 'returnServiceEditsInSourceSR' parameter. See: 'capabilities.editing.supportsReturnServiceEditsInSourceSpatialReference'`);if(l.returnServiceEditsInSourceSR&&l.returnServiceEditsOption!==`original-and-current-features`)throw new e(`${t.type}-layer:invalid-parameter`,`'returnServiceEditsInSourceSR' is valid only when 'returnServiceEditsOption' is set to 'original-and-current-features'`);let u=I(r,a,`${t.type}-layer`),d=i?.globalIdUsed||c,f=t.fields.filter(e=>e.type===`big-integer`||e.type===`oid`&&(e.length||0)>=8);if(d){let{globalIdField:n}=t;if(n==null)throw new e(`${t.type}-layer:invalid-parameter`,`Layer does not specify a global id field.`);u.addFeatures.forEach(e=>N(e,n))}return u.addFeatures.forEach(e=>k(e,t,d,f)),u.updateFeatures.forEach(e=>j(e,t,d,f)),u.deleteFeatures.forEach(e=>A(e,t,d,f)),u.addAttachments.forEach(e=>M(e,t)),u.updateAttachments.forEach(e=>M(e,t)),c&&await z(u,t),{edits:await P(u),options:l}}function D(t,n,r,i){if(r){if(`attributes`in t&&!t.attributes[n.globalIdField])throw new e(`${n.type}-layer:invalid-parameter`,`Feature should have '${n.globalIdField}' when 'globalIdUsed' is true`);if(!(`attributes`in t)&&!t.globalId)throw new e(`${n.type}-layer:invalid-parameter`,"`'globalId' of the feature should be passed when 'globalIdUsed' is true")}if(i.length&&`attributes`in t)for(let r of i){let i=t.attributes[r.name];if(i!==void 0&&!h(r,i))throw new e(`${n.type}-layer:invalid-parameter`,`Big-integer field '${r.name}' of the feature must be less than ${2**53-1}`,{feature:t})}if(`geometry`in t&&t.geometry!=null){if(t.geometry.hasZ&&!1===n.capabilities?.data.supportsZ)throw new e(`${n.type}-layer:z-unsupported`,`Layer does not support z values while feature has z values.`);if(t.geometry.hasM&&!1===n.capabilities?.data.supportsM)throw new e(`${n.type}-layer:m-unsupported`,`Layer does not support m values while feature has m values.`)}}function O(n,i){if(`geometry`in n&&n.geometry?.type===`mesh`&&i.infoFor3D!=null&&i.spatialReference!=null){let{geometry:a}=n,{spatialReference:s,vertexSpace:l}=a,u=i.spatialReference,d=l.type===`local`,f=c(u),p=t(u,s),m=p||r(u)&&(r(s)||o(s));if(!(d&&f&&m||!d&&!f&&p))throw new e(`${i.type}-layer:mesh-unsupported`,`Uploading a mesh with a ${l.type} vertex space and a spatial reference wkid:${s.wkid} to a layer with a spatial reference wkid:${u.wkid} is not supported.`)}}function k(e,t,n,r){D(e,t,n,r),O(e,t)}function A(e,t,n,r){D(e,t,n,r)}function j(t,n,r,i){D(t,n,r,i),O(t,n);let a=_(n);if(`geometry`in t&&t.geometry!=null&&!a?.editing.supportsGeometryUpdate)throw new e(`${n.type}-layer:unsupported-operation`,`Layer does not support geometry updates.`)}function M(t,n){let{feature:r,attachment:i}=t;if(!r||`attributes`in r&&!r.attributes[n.globalIdField])throw new e(`${n.type}-layer:invalid-parameter`,`Attachment should have reference to a feature with 'globalId'`);if(!(`attributes`in r)&&!r.globalId)throw new e(`${n.type}-layer:invalid-parameter`,`Attachment should have reference to 'globalId' of the parent feature`);if(!i.globalId)throw new e(`${n.type}-layer:invalid-parameter`,`Attachment should have 'globalId'`);if(!i.data&&!i.uploadId)throw new e(`${n.type}-layer:invalid-parameter`,`Attachment should have 'data' or 'uploadId'`);if(!(i.data instanceof File&&i.data.name)&&!i.name)throw new e(`${n.type}-layer:invalid-parameter`,`'name' is required when attachment is specified as Base64 encoded string using 'data'`);if(!n.capabilities?.editing.supportsUploadWithItemId&&i.uploadId)throw new e(`${n.type}-layer:invalid-parameter`,`This layer does not support 'uploadId' parameter. See: 'capabilities.editing.supportsUploadWithItemId'`);if(typeof i.data==`string`){let t=m(i.data);if(t&&!t.isBase64)throw new e(`${n.type}-layer:invalid-parameter`,`Attachment 'data' should be a Blob, File or Base64 encoded string`)}}function N(e,t){let{attributes:n}=e;n[t]??(n[t]=g())}async function P(e){let t=e.addFeatures??[],n=e.updateFeatures??[],r=t.concat(n).map(e=>e.geometry),i=await v(r),a=t.length,o=n.length;return i.slice(0,a).forEach((e,n)=>t[n].geometry=e),i.slice(a,a+o).forEach((e,t)=>n[t].geometry=e),e}function F(e){return{addFeatures:Array.from(e?.addFeatures??[]),updateFeatures:Array.from(e?.updateFeatures??[]),deleteFeatures:e&&p.isCollection(e.deleteFeatures)?e.deleteFeatures.toArray():e.deleteFeatures||[],addAttachments:e.addAttachments||[],updateAttachments:e.updateAttachments||[],deleteAttachments:e.deleteAttachments||[]}}function I(t,n,r){let i=F(t);if(i.addFeatures?.length&&!n.operations.supportsAdd)throw new e(`${r}:unsupported-operation`,`Layer does not support adding features.`);if(i.updateFeatures?.length&&!n.operations.supportsUpdate)throw new e(`${r}:unsupported-operation`,`Layer does not support updating features.`);if(i.deleteFeatures?.length&&!n.operations.supportsDelete)throw new e(`${r}:unsupported-operation`,`Layer does not support deleting features.`);return i.addFeatures=i.addFeatures.map(R),i.updateFeatures=i.updateFeatures.map(R),i.addAssetFeatures=[],i}function L(t,n,r,i,a,o){if(!(t&&(i||a)||r?.usingTelecomOperations))throw new e(`${o}:missing-parameters`,`'addFeatures', 'updateFeatures', 'deleteFeatures', 'addAttachments', 'updateAttachments' or 'deleteAttachments' parameter is required`);if(!n.editing.supportsGlobalId&&r?.globalIdUsed&&!r.usingFeatureServiceEndpoint)throw new e(`${o}:invalid-parameter`,`This layer does not support 'globalIdUsed' parameter. See: 'capabilities.editing.supportsGlobalId'`);if(!n.editing.supportsGlobalId&&a)throw new e(`${o}:invalid-parameter`,`'addAttachments', 'updateAttachments' and 'deleteAttachments' are applicable only if the layer supports global ids. See: 'capabilities.editing.supportsGlobalId'`);if(!r?.globalIdUsed&&a)throw new e(`${o}:invalid-parameter`,`When 'addAttachments', 'updateAttachments' or 'deleteAttachments' is specified, globalIdUsed should be set to true`)}function R(e){let t=new s;return e.attributes||={},t.geometry=e.geometry,t.attributes=e.attributes,t}async function z(t,n){let{infoFor3D:r}=n;if(r==null)return;if(!l(r))throw new e(`${n.type}-layer:binary-gltf-asset-not-supported`,`3DObjectFeatureLayer requires binary glTF (.glb) support for updating mesh geometry.`);t.addAssetFeatures??=[];let{addAssetFeatures:i}=t;for(let e of t.addFeatures??[])B(e)&&i.push(e);for(let e of t.updateFeatures??[])B(e)&&i.push(e)}function B(e){return e?.geometry?.type===`mesh`}function V(t,n,r,i){if(!y(n))throw new e(`${t.type}-layer:no-editing-support`,`Layer source does not support applyEdits capability`,{layer:t});if(!n.uploadAssets)throw new e(`${t.type}-layer:no-asset-upload-support`,`Layer source does not support uploadAssets capability`,{layer:t});return n.uploadAssets(r,i)}export{b as a,R as c,S as d,F as i,L as l,x as n,I as o,P as r,C as s,w as t,V as u};