import{$l as e,BT as t,Cb as n,Cu as r,Db as i,Eu as a,Hc as o,JE as s,Nu as c,Ob as l,Rc as u,SE as d,Vc as f,Yl as p,ab as m,fb as h,fn as g,ig as _,mE as v,sE as y,uE as b,xb as x}from"./index-ByaFsVj4.js";import{t as S}from"./OptimizedGeometry-DX91by73.js";import{s as C,v as ee}from"./featureConversionUtils-C045qQF5.js";import{n as w}from"./labelPoint-DoaytHlZ.js";import{d as te}from"./rasterizingUtils-LzhctegF.js";import{t as ne}from"./BoundingBox-ClylkApr.js";import{n as re,t as ie}from"./TurboLine-CIru50vB.js";import{l as T,n as ae}from"./utils-Dm-H4TMy.js";import{_ as oe}from"./constants-TfCITEY_.js";import{n as se}from"./ComputedAttributeStorage-BSjVwTFB.js";import{$ as ce,A as le,C as ue,D as E,E as de,F as fe,G as pe,H as me,I as he,J as ge,K as _e,L as D,M as O,N as k,O as A,P as ve,R as j,S as M,T as N,U as ye,V as be,W as xe,X as Se,Y as Ce,Z as we,_ as Te,a as P,b as Ee,c as De,d as Oe,f as ke,g as Ae,h as je,i as Me,j as F,k as I,l as Ne,m as Pe,n as Fe,o as Ie,p as Le,q as Re,r as ze,s as Be,t as Ve,u as He,v as Ue,w as We,x as Ge,y as Ke,z as L}from"./PieChartMeshWriter-fq7F-t3g.js";function R(e){let{pixelDimensions:t,texelDimensions:n,baseSize:r,referenceSize:i,strokeWidth:a,sizeRatio:o}=e;if(t||=e.sprite.sdf?[0,0]:[e.sprite.width,e.sprite.height],n||=e.sprite.sdf?[0,0]:t,e.patternHeight!=null){let n=e.patternHeight/t[1];t[1]*=n,t[0]*=n}r===-1&&(r=t[1]),r=_(r),i=_(i),a=_(a);let s=(e.sprite.sdfDecodeCoeff??1)*o;return{...e,pixelDimensions:t,texelDimensions:n,baseSize:r,referenceSize:i,strokeWidth:a,sdfDecodeCoeff:s}}var z=64,qe=64,Je=2,Ye=class extends L{get vertexSpec(){return{createComputedParams:R,optionalAttributes:{zoomRange:E,value1Position2Value2:fe,lineLength:F},attributes:{id:O,bitset:j,pos:M,offset:I.marker,uv:We.marker,animationPointerAndBaseSizeAndReferenceSize:A,sizing:D,angle:ue}}}_write(e,t,n){let r=this.evaluatedMeshParams.sprite,{textureBinding:i}=r;e.recordStart(this.instanceId,this.attributeLayout,i);let a=t.getDisplayId();if(this.shift&&t.geometryType===`esriGeometryPolyline`){if(!n){let n=w.fromFeatureSetReaderCIM(t);n&&this._writeParticles(e,t,n)}}else if(this.evaluatedMeshParams.placement!=null)this._writePlacedMarkers(e,t);else if(t.geometryType===`esriGeometryPolygon`){let n=t.readCentroidForDisplay();if(!n)return;let[r,i]=n.coords;this._writeQuad(e,a,r,i)}else if(t.geometryType===`esriGeometryPoint`){let n=t.readXForDisplay(),r=t.readYForDisplay();this._writeQuad(e,a,n,r)}else{let n=t.readGeometryForDisplay();n&&n.forEachVertex((t,n)=>{this._writeQuad(e,a,t,n)})}e.recordEnd()}_writePlacedMarkers(e,t){let n=w.fromFeatureSetReaderCIM(t)?.clone();if(!n)return;let r=Be.getPlacement(n,-1,this.evaluatedMeshParams.placement,_(1),e.id);if(!r)return;let i=t.getDisplayId(),a=r.next(),o=null;for(;a!=null;){let t=a.tx,n=-a.ty;if(Math.abs(t)>1024||Math.abs(n)>1024){a=r.next();continue}let s=-a.getAngle();e.recordBounds(t,n,z,qe),this.shift?o&&this._writeQuad(e,i,o[0],o[1],void 0,s):this._writeQuad(e,i,t,n,void 0,s),o=[t,n],a=r.next()}}_writeParticles(e,t,n){let r=t.getDisplayId();for(;n.nextPath();){let t=[];for(;n.nextPoint();)t.push([n.x,n.y]);let i=Xe(t),a=0;for(let e=1;e<t.length;e++){let n=t[e][0]-t[e-1][0],r=t[e][1]-t[e-1][1],i=Math.sqrt(n*n+r*r);a+=i}let o=t=>{for(let n of i){let{a:i,b:o}=n;this._writeQuad(e,r,i.position[0],i.position[1],[i.distance-t,o.position[0],o.position[1],o.distance-t],this.evaluatedMeshParams.angleToLine?Math.atan2(i.direction[1],i.direction[0]):0,a,!0)}},{placement:s}=this.evaluatedMeshParams;if(!s||`placementTemplate`in s||s.type===`CIMMarkerPlacementOnVertices`){let e;if(s&&s.type!==`CIMMarkerPlacementOnVertices`)e=s.placementTemplate;else{e=[0];for(let t of i){let{a:n,b:r}=t,i=n.position[0]-r.position[0],a=n.position[1]-r.position[1],o=Math.sqrt(i*i+a*a);e.push(o)}}let t=-1*a;for(;t<(1+Je/2)*a;)for(let n of e)t+=n,o(t)}else s.type===`CIMMarkerPlacementAtExtremities`?s.extremityPlacement===`JustBegin`?o(1):s.extremityPlacement===`JustEnd`?(o(a-1),o(-1)):s.extremityPlacement===`Both`&&(o(1),o(a-1)):s.type===`CIMMarkerPlacementOnLine`&&(s.relativeTo===`LineBeginning`?o(1):s.relativeTo===`LineEnd`?(o(a-1),o(-1)):s.relativeTo===`LineMiddle`&&o(a/2))}}_writeQuad(e,t,n,r,i,a=0,o=0,s=!1){let c=this.evaluatedMeshParams.sprite,{rect:l}=c,u=l.x+4,d=l.y+4,f=l.x+l.width-4,p=l.y+l.height-4,m=e.vertexCount();s||e.recordBounds(n,r,z,z);let h={texXmin:u,texYmin:d,texXmax:f,texYmax:p,value1Position2Value2:i,angle:a/oe,lineLength:o};for(let i=0;i<4;i++)this._writeVertex(e,t,n,r,h);e.indexEnsureSize(6),e.indexWrite(m),e.indexWrite(m+1),e.indexWrite(m+2),e.indexWrite(m+1),e.indexWrite(m+3),e.indexWrite(m+2)}};function Xe(e){let t=[],n=0;for(let r=1;r<e.length;r++){let i=e[r-1],a=e[r],o=a[0]-i[0],s=a[1]-i[1],c=Math.sqrt(o*o+s*s),l=o/c,u=s/c;t.push({a:{position:i,distance:n,direction:[l,u]},b:{position:a,distance:n+c,direction:[l,u]}}),n+=c}return t}var Ze=class extends Ye{constructor(){super(...arguments),this.shift=!1}},Qe=class extends Ye{constructor(){super(...arguments),this.shift=!0}},B=class extends L{_write(e,t,n){let r=n??w.fromFeatureSetReaderCIM(t);if(!r)return;let i=this.evaluatedMeshParams.sprite,{textureBinding:a}=i;e.recordStart(this.instanceId,this.attributeLayout,a);let o=t.getDisplayId();this._writePoly(e,o,r.asOptimized()),e.recordEnd()}},$e=class extends B{constructor(){super(...arguments),this.vertexSpec={createComputedParams:R,attributes:{id:O,bitset:j,pos:M,offset:I.fill,tlbr:N,animationPointerAndBaseSizeAndReferenceSize:A,sizing:D},optionalAttributes:{zoomRange:E,value1Position2Value2:k,lineLength:ve}}}_writePoly(e,t,n){let r=this._clip(n);if(!r)return;n=r;let i=[],a=e.vertexCount(),o;if(Ee(i,n)){if(i.length===0)return;o=0;for(let r of i){let i=n.coords[2*r],a=n.coords[2*r+1];this._writeVertex(e,t,i,a),o++}}else{let{coords:r,lengths:i}=n,a=re(r,i);o=a.vertexCount;for(let n=0;n<a.buffer.length/2;n++){let r=a.buffer[2*n],i=a.buffer[2*n+1];this._writeVertex(e,t,r,i)}}if(o>0){e.indexEnsureSize(o);for(let t=0;t<o;t++)e.indexWrite(t+a)}}_clip(e){let t=this.hasEffects;return Ke(e,t?256:8)}},et=class{constructor(){this.id=0,this.bitset=0,this.indexCount=0,this.vertexCount=0,this.vertexFrom=0,this.vertexBounds=0,this.pathLength=0}},V=65535,tt=class extends B{constructor(){super(...arguments),this.vertexSpec={createComputedParams:R,attributes:{id:O,bitset:j,pos:M,offset:I.line,tlbr:N,animationPointerAndBaseSizeAndReferenceSize:A,sizing:D,accumulatedDistance:le,normal:de,segmentDirection:he},optionalAttributes:{zoomRange:E,value1Position2Value2:k,lineLength:F}},this._tessParams=new Ue,this._currentWrite=new et,this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0,wrapDistance:V,textured:!1},this._lineLength=0,this._lineTessellator=new ie((e,t,n,r,i,a,o,s,c,l,u)=>this._writeTesselatedVertex(e,t,n,r,i,a,o,s,c,l,u,this._lineLength),this._writeTriangle.bind(this),!1)}_writePoly(e,t,n){let r=Ge(w.fromOptimized(n,`esriGeometryPolyline`),64);if(r==null)return;let{_currentWrite:i,_tessellationOptions:a}=this,{baseSize:o,capType:s,joinType:c,miterLimit:l}=this.evaluatedMeshParams;a.halfWidth=_(.5*o),a.capType=me(s||`Round`),a.joinType=ye(c||`Round`),a.miterLimit=l||2,i.out=e,i.id=t,i.vertexCount=0,i.indexCount=0,i.vertexFrom=e.vertexCount(),i.vertexBounds=1;for(let{line:e,start:t,pathLength:n}of r){a.initialDistance=t%V,i.pathLength=n,this._lineLength=0;for(let t=1;t<e.length;t++){let n=e[t].x-e[t-1].x,r=e[t].y-e[t-1].y;this._lineLength+=Math.sqrt(n*n+r*r)}this._lineTessellator.tessellate(e,a,!1)}}_writeTesselatedVertex(e,t,n,r,i,a,o,s,c,l,u,d){let{out:f,id:p,vertexBounds:m,pathLength:h}=this._currentWrite;return this.hasEffects&&f.recordBounds(e,t,m,m),this._tessParams.extrusionOffsetX=o,this._tessParams.extrusionOffsetY=s,this._tessParams.normalX=c,this._tessParams.normalY=l,this._tessParams.directionX=i,this._tessParams.directionY=a,this._tessParams.distance=u,this._tessParams.pathLength=h,this._tessParams.lineLength=d,this._writeVertex(f,p,e,t,this._tessParams),this._currentWrite.vertexFrom+ this._currentWrite.vertexCount++}_writeTriangle(e,t,n){let{out:r}=this._currentWrite;r.indexEnsureSize(3),r.indexWrite(e),r.indexWrite(t),r.indexWrite(n),this._currentWrite.indexCount+=3}};function H(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e}function U(e,t){return Math.sqrt(e*e+t*t)}function W(e){let t=U(e[0],e[1]);e[0]/=t,e[1]/=t}function nt(e,t){return U(e[0]-t[0],e[1]-t[1])}function rt(e,t){return e[t+1]}function G(e){return e.length-1}function it(e){let t=0;for(let n=0;n<G(e);n++)t+=at(e,n);return t}function at(e,t,n=1){let[r,i]=rt(e,t);return[r,i]=[Math.round(r),Math.round(i)],Math.sqrt(r*r+i*i)*n}var ot=class e{constructor(e,t,n,r,i){this._segments=e,this._index=t,this._distance=n,this._xStart=r,this._yStart=i,this._done=!1}static create(t){return new e(t,0,0,t[0][0],t[0][1])}clone(){return new e(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(e){return this._index===e._index||e._index===this._index-1&&(this._distance===0||e._distance===1)||e._index===this._index+1&&(this._distance===1||e._distance===0)}leq(e){return this._index<e._index||this._index===e._index&&this._distance<=e._distance}geq(e){return this._index>e._index||this._index===e._index&&this._distance>=e._distance}get _segment(){return this._segments[this._index+1]}get angle(){let e=this.dy,t=(0*e+-1*-this.dx)/(1*this.length),n=Math.acos(t);return e>0&&(n=2*Math.PI-n),n}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){let{dx:e,dy:t}=this;return Math.sqrt(e*e+t*t)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<G(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(--this._index,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(e,t){let n=this.backwardLength;if(e<=n)return this._distance=(n-e)/this.length,this;let r=this.backwardLength;for(;this.prev();){if(r+this.length>e)return this._seekBackwards(e-r);r+=this.length}return this._distance=0,t?this:null}seek(e,t=!1){if(e<0)return this._seekBackwards(Math.abs(e),t);if(e<=this.remainingLength)return this._distance=(this.backwardLength+e)/this.length,this;let n=this.remainingLength;for(;this.next();){if(n+this.length>e)return this.seek(e-n,t);n+=this.length}return this._distance=1,t?this:null}};function K(e,t,n,r=!0){let i=it(e),a=ot.create(e),o=i/2;if(!r)return a.seek(o),void(a.x<512&&a.y<512&&a.x>=0&&a.y>=0&&n(a.clone(),0,o+0*t,i));let s=Math.max((i-t)/2,0),c=Math.floor(s/t),l=o-c*t;a.seek(l);for(let e=-c;e<=c;e++)a.x<512&&a.y<512&&a.x>=0&&a.y>=0&&n(a.clone(),e,o+e*t,i),a.seek(t)}function q(e,t){let n=t;for(let t=0;t<e.length;t++){let r=e[t];st(r,n);let i=[];i.push(r[0]);for(let e=1;e<r.length;e++){let[t,n]=r[e-1],[a,o]=r[e],s=a-t,c=o-n;i.push([s,c])}e[t]=i,r=i}return e}function st(e,t){let n=1e-6;if(t<=0)return;let r=e.length;if(r<3)return;let i=[],a=0;i.push(0);for(let t=1;t<r;t++)a+=nt(e[t],e[t-1]),i.push(a);t=Math.min(t,.2*a);let o=[];o.push(e[0][0]),o.push(e[0][1]);let s=e[r-1][0],c=e[r-1][1],l=H([0,0],e[0],e[1]);W(l),e[0][0]+=t*l[0],e[0][1]+=t*l[1],H(l,e[r-1],e[r-2]),W(l),e[r-1][0]+=t*l[0],e[r-1][1]+=t*l[1];for(let e=1;e<r;e++)i[e]+=t;i[r-1]+=t;let u=.5*t;for(let a=1;a<r-1;a++){let s=0,c=0,l=0;for(let r=a-1;r>=0&&!(i[r+1]<i[a]-u);r--){let o=u+i[r+1]-i[a],d=i[r+1]-i[r],f=i[a]-i[r]<u?1:o/d;if(Math.abs(f)<n)break;let p=f*f,m=f*o-.5*p*d,h=f*d/t,g=e[r+1],_=e[r][0]-g[0],v=e[r][1]-g[1];s+=h/m*(g[0]*f*o+.5*p*(o*_-d*g[0])-p*f*d*_/3),c+=h/m*(g[1]*f*o+.5*p*(o*v-d*g[1])-p*f*d*v/3),l+=h}for(let o=a+1;o<r&&!(i[o-1]>i[a]+u);o++){let r=u-i[o-1]+i[a],d=i[o]-i[o-1],f=i[o]-i[a]<u?1:r/d;if(Math.abs(f)<n)break;let p=f*f,m=f*r-.5*p*d,h=f*d/t,g=e[o-1],_=e[o][0]-g[0],v=e[o][1]-g[1];s+=h/m*(g[0]*f*r+.5*p*(r*_-d*g[0])-p*f*d*_/3),c+=h/m*(g[1]*f*r+.5*p*(r*v-d*g[1])-p*f*d*v/3),l+=h}o.push(s/l),o.push(c/l)}o.push(s),o.push(c);for(let t=0,n=0;t<r;t++)e[t][0]=o[n++],e[t][1]=o[n++]}var J=1,Y=0,ct=128;function lt(e,t,n){return v(`${e}${t}${n}`)}function ut(e,t,n,r,i){return v(`${e}${t}${n}${r*2**(28-i)}`)}function dt(e,t,n){return v(`${e}${t}${n}`)}function ft(e,t,n,r,i){return v(`${e}${i}${t}${n*2**(28-r)}`)}var pt=y(e=>{let t=0;if(e===0)return 1/0;for(;!(e%2);)t++,e/=2;return t}),mt=class extends P{constructor(){super(...arguments),this._zoomLevel=0}_write(e,t,n,r){if(this._zoomLevel=r||0,n!=null)throw Error(`InternalError: EffectGeometry not support for LabelMeshWriter`);switch(t.geometryType){case`esriGeometryPoint`:{let n=t.readXForDisplay(),r=t.readYForDisplay();this._writePoint(e,n,r,0,t);break}case`esriGeometryEnvelope`:case`esriGeometryPolygon`:{let n=t.readCentroidForDisplay();if(!n)return;let[r,i]=n.coords;this._writePoint(e,r,i,0,t);break}case`esriGeometryMultipoint`:{let n=0,r=w.fromFeatureSetReader(t);if(r?.nextPath())for(;r.nextPoint();)this._writePoint(e,r.x,r.y,n++,t);break}case`esriGeometryPolyline`:this._writeLines(e,t)}}_getMetricDir(){let{horizontalAlignment:e,verticalAlignment:t}=this.evaluatedMeshParams;return[e===`center`?0:e===`right`?-1:1,t===`middle`?0:t===`bottom`?-1:1]}_createLineLabelMetric(e,t,n,r,i,a){let[o,s]=this._getMetricDir(),c=this.evaluatedMeshParams.scaleInfo?.maxScale??0,l=this.evaluatedMeshParams.scaleInfo?.minScale??0,u=this.evaluatedMeshParams.labelClassId;return new T(e,u,t,n,r,i,o,s,c,l,a)}_writePoint(e,t,n,r,i){if(t<0||t>512||n<0||n>512)return;let a=this._getShaping();if(!a)return;let o=i.getDisplayId(),s=this.evaluatedMeshParams.labelClassId,c=lt(this.evaluatedMeshParams.layerId,i.getObjectId(),r),l=dt(i.getObjectId(),s,r),[u,d]=this._getMetricDir(),f=this.evaluatedMeshParams.scaleInfo?.maxScale??0,p=this.evaluatedMeshParams.scaleInfo?.minScale??0,m=this._getPointReferenceBounds()||{offsetX:0,offsetY:0,size:0};e.metricStart(new T(o,s,c,l,t,n,u,d,f,p,m)),this._writeGlyphs(e,o,t,n,a,0,m,void 0,!1),e.metricBoxWrite(a.boundsT),e.metricEnd()}_getPointReferenceBounds(){if(!this._references)return null;for(let e of this._references){let t=e.getBoundsInfo();if(t)return t}return null}_writeLines(e,t){let{scaleInfo:n,verticalAlignment:r}=this.evaluatedMeshParams,i=this.evaluatedMeshParams.repeatLabelDistance||128,a=this._getShaping(`middle`);if(!a)return;let o=(e,t,n,r)=>this._placeSubdivGlyphs(e,t,n,r),s=(a.bounds.width+i)/(1<<J);this._current={out:e,id:t.getDisplayId(),objId:t.getObjectId(),shaping:a,zoomRange:xe(n,this.getTileInfo()),referenceBounds:this._getPointReferenceBounds()||{offsetX:0,offsetY:0,size:0},offsetDirection:null,pathIndex:0},this._verticalPlacement=r===`bottom`?`above`:r===`top`?`below`:null,this._verticalPlacement?this._writeAboveAndBelowAlong(t,o,s):this._writeCenterAlong(t,o,s)}_writeAboveAndBelowAlong(e,t,n){let{repeatLabel:r}=this.evaluatedMeshParams,{shaping:i}=this._current,a=i.bounds.halfHeight,o=e.readGeometryForDisplay();if(!o)return;let s=ee(o,`esriGeometryPolyline`,1)??new S,c=X(s,a),l=X(s,-a),u=C(l,`esriGeometryPolyline`,!1,!1),d=C(c,`esriGeometryPolyline`,!1,!1),f=q(d.paths,i.bounds.width),p=q(u.paths,i.bounds.width);this._current.offsetDirection=`above`;for(let e=0;e<f.length;e++)this._current.pathIndex=e,K(f[e],n,t,!!r);this._current.offsetDirection=`below`;for(let e=0;e<p.length;e++)this._current.pathIndex=e,K(p[e],n,t,!!r)}_writeCenterAlong(e,t,n){let{repeatLabel:r}=this.evaluatedMeshParams,{shaping:i}=this._current,a=q(e.readLegacyGeometryForDisplay().paths,i.bounds.width);for(let e=0;e<a.length;e++)this._current.pathIndex=e,K(a[e],n,t,!!r)}_placeSubdivGlyphs(e,t,n,r){let{allowOverrun:i,labelPosition:a,repeatLabelDistance:o,layerId:s,labelClassId:c}=this.evaluatedMeshParams,{objId:l,shaping:u,pathIndex:d}=this._current,f=this._current.zoomRange[0],p=pt(t),m=this._current.shaping.bounds.width/(1<<J),h=Math.sqrt(o||ct)/(1<<J),g=Math.min(n,r-n),_=u.isMultiline?28:Math.log2(g/(h+m/2)),v=t===0?_:Math.min(p,_),y=Math.max(f,this._zoomLevel+J-v),b=this._zoomLevel-y,x=u.bounds.width/2*2**b,S=ut(s,l,d,t,this._zoomLevel),C=ft(l,d,t,this._zoomLevel,c);this._current.shaping.isMultiline?t===0&&this._placeStraight(e,y,S,C):i&&b<0?this._placeStraightAlong(e,f,S,C):a===`parallel`?this._placeStraightAlong(e,y,S,C):a===`curved`&&this._placeCurved(e,y,x,S,C)}_placeStraight(e,t,n,r){let{out:i,id:a,shaping:o,referenceBounds:s}=this._current,{x:c,y:l}=e;i.metricStart(this._createLineLabelMetric(a,n,r,c,l)),i.metricBoxWrite(o.boundsT);let u=e.angle*(180/Math.PI)%360,d=(e.angle*(180/Math.PI)+180)%360;if(!this._verticalPlacement||this._verticalPlacement===this._current.offsetDirection){let e={clipAngle:u,mapAligned:!0,isLineLabel:!0,minZoom:t};this._writeGlyphs(i,a,c,l,o,0,s,e,!1)}if(!this._verticalPlacement||this._verticalPlacement!==this._current.offsetDirection){let e={clipAngle:d,mapAligned:!0,isLineLabel:!0,minZoom:t};this._writeGlyphs(i,a,c,l,o,0,s,e,!1)}i.metricEnd()}_placeCurved(e,t,n,r,i){let{out:a,id:o}=this._current;a.metricStart(this._createLineLabelMetric(o,r,i,e.x,e.y));let s=e.clone(),c=e.angle*(180/Math.PI)%360,l=(e.angle*(180/Math.PI)+180)%360;this._verticalPlacement&&this._verticalPlacement!==this._current.offsetDirection||(this._placeFirst(s,t,1,c),this._placeBack(e,s,t,n,1,c),this._placeForward(e,s,t,n,1,c)),this._verticalPlacement&&this._verticalPlacement===this._current.offsetDirection||(this._placeFirst(s,t,0,l),this._placeBack(e,s,t,n,0,l),this._placeForward(e,s,t,n,0,l)),a.metricEnd()}_placeStraightAlong(t,n,i,o){let{out:s,id:c,shaping:l,zoomRange:u,referenceBounds:d}=this._current,{boxBorderLineColor:f,boxBackgroundColor:m}=this.evaluatedMeshParams,h=t.clone(),g=t.angle*(180/Math.PI)%360,v=(t.angle*(180/Math.PI)+180)%360,y=l.glyphs.length>0&&!(!f&&!m);if(s.metricStart(this._createLineLabelMetric(c,i,o,t.x,t.y)),y){let i=Math.max(n,u[0],0),o=Math.min(28,u[1]),f=r(e(),-t.angle),m={minZoom:i,maxZoom:o,clipAngle:g,mapAligned:!0,isLineLabel:!0},h=_(this.evaluatedMeshParams.offsetX),y=_(this.evaluatedMeshParams.offsetY);if(!this._verticalPlacement||this._verticalPlacement===this._current.offsetDirection){let n=p(h,-1*y),[r,i]=l.shapeBackground(a(e(),f,n));s.recordStart(this.instanceId,this.attributeLayout,l.glyphs[0].textureBinding),this._writeTextBox(s,c,t.x,t.y,i,d,m),s.recordEnd()}if(!this._verticalPlacement||this._verticalPlacement!==this._current.offsetDirection){let n=p(h,y),[r,i]=l.shapeBackground(a(e(),f,n));m.clipAngle=v,s.recordStart(this.instanceId,this.attributeLayout,l.glyphs[0].textureBinding),this._writeTextBox(s,c,t.x,t.y,i,d,m),s.recordEnd()}}this._verticalPlacement&&this._verticalPlacement!==this._current.offsetDirection||this._placeFirst(h,n,1,g,!0),this._verticalPlacement&&this._verticalPlacement===this._current.offsetDirection||this._placeFirst(h,n,0,v,!0),s.metricEnd()}_placeBack(e,t,n,r,i,a){let o=e.clone(),s=e.backwardLength+Y;for(;o.prev()&&!(s>=r);)this._placeOnSegment(o,t,s,n,-1,i,a),s+=o.length+Y}_placeForward(e,t,n,r,i,a){let o=e.clone(),s=e.remainingLength+Y;for(;o.next()&&!(s>=r);)this._placeOnSegment(o,t,s,n,1,i,a),s+=o.length+Y}_placeFirst(t,n,i,a,o=!1){let{out:s,id:c,shaping:l,zoomRange:u,referenceBounds:d}=this._current,f=l.glyphs,m=_(this.evaluatedMeshParams.offsetX),g=_(this.evaluatedMeshParams.offsetY),v=p(m,g),y=r(e(),-t.angle);h(v,v,y);for(let e of f){let r=e.x>l.bounds.x?i:1-i,f=r*t.remainingLength+(1-r)*t.backwardLength,p=Math.abs(e.x+e.width/2-l.bounds.x),m=Math.max(0,this._zoomLevel+Math.log2(p/(f+Y))),h=Math.max(n,o?0:m);if(e.maxZoom=Math.min(u[1],28),e.angle=t.angle+(1-i)*Math.PI,e.minZoom=Math.max(u[0],h),this._writeLineGlyph(s,c,t.x,t.y,e,a,d,!0),(i||this._current.offsetDirection)&&this._isVisible(e.minZoom,e.maxZoom)){let t=new ne(e.bounds.x+v[0],e.bounds.y+v[1],e.bounds.width,e.bounds.height);s.metricBoxWrite(t)}}}_placeOnSegment(t,n,i,a,o,s,c){let{out:l,id:u,shaping:d,referenceBounds:f}=this._current,m=d.glyphs,g=t.dx/t.length,v=t.dy/t.length,y={x:t.x+i*-o*g,y:t.y+i*-o*v},b=_(this.evaluatedMeshParams.offsetX),x=_(this.evaluatedMeshParams.offsetY),S=p(b,x),C=r(e(),-t.angle);h(S,S,C);for(let e of m){let n=e.x>d.bounds.x?s:1-s;if(!(n&&o===1||!n&&o===-1))continue;let r=Math.abs(e.x+e.width/2-d.bounds.x),p=Math.max(0,this._zoomLevel+Math.log2(r/i)-.1),m=Math.max(a,this._zoomLevel+Math.log2(r/(i+t.length+Y)));if(p!==0&&(e.angle=t.angle+(1-s)*Math.PI,e.minZoom=m,e.maxZoom=p,this._writeLineGlyph(l,u,y.x,y.y,e,c,f,!0),(s||this._current.offsetDirection)&&this._isVisible(e.minZoom,e.maxZoom))){let t=new ne(e.bounds.x+S[0],e.bounds.y+S[1],e.bounds.width,e.bounds.height);l.metricBoxWrite(t)}}}_writeLineGlyph(e,t,n,r,i,a,o,s){if(n<0||n>512||r<0||r>512)return;e.recordStart(this.instanceId,this.attributeLayout,i.textureBinding);let{texcoords:c,offsets:l}=i,{fontSize:u,haloSize:d,outlineSize:f}=this._textMeshTransformProps;this._writeQuad(e,t,n,r,{texcoords:c,offsets:l,fontSize:u,haloSize:d,outlineSize:f,color:be(this.evaluatedMeshParams.color),isBackground:!1,referenceBounds:o,minZoom:Math.max(this._current.zoomRange[0],i.minZoom),maxZoom:Math.min(this._current.zoomRange[1],i.maxZoom),clipAngle:a,mapAligned:s,isLineLabel:!0}),e.recordEnd()}_packedZoom(e){return Math.floor(e*10)/10}_isVisible(e,t){let n=Math.max(this._current.zoomRange[0],e),r=Math.min(this._current.zoomRange[1],t);n=this._packedZoom(n),r=this._packedZoom(r);let i=this._packedZoom(this._zoomLevel);return n<=i&&i<=r}};function X(e,t){let r=new S,{coords:a,lengths:o}=e,s=c(),u=c(),d=c(),f=c(),p=c(),h=c(),g=0;for(let e=0;e<o.length;e++){let c=o[e];for(let e=0;e<c;e++){let o=2*(e+g-1),_=2*(e+g),v=2*(e+g+1);e>0?n(s,a[o],a[o+1]):n(s,0,0),n(u,a[_],a[_+1]),e<c-1?n(d,a[v],a[v+1]):n(d,0,0),e===0?n(f,0,0):(m(f,u,s),l(f,f),n(f,f[1],-f[0])),e===c-1?n(p,0,0):(m(p,d,u),l(p,p),n(p,p[1],-p[0])),i(h,f,p),l(h,h);let y=h[0]*p[0]+h[1]*p[1];y!==0&&x(h,h,y),x(h,h,t),r.coords.push(u[0]+h[0],u[1]+h[1])}r.lengths.push(c),g+=c}return r}var Z=class extends se{constructor(e){super(),this._value=e}resize(e){}read(e,t){return this._value}readWithDefault(e,t,n){return this._value}hasArcadeDependency(e){return!1}},ht=()=>b.getLogger(`esri.views.2d.engine.webgl.shaderGraph.techniques.mesh.MeshWriterInputEvaluator`);async function Q(e,t,n,r){let{defaultValue:i,valueExpressionInfo:a,value:o}=t;if(a){if(a.type===`dictionary-template`)return{...t,computed:e.createDictionaryTemplateField(a,n),defaultValue:i};let{expression:o}=a,s=await e.createComputedField({expression:o},r);return s?{...t,computed:s,defaultValue:i}:null}return{...t,computed:new Z(o),defaultValue:i}}async function gt(e,t,n){let{valueExpressionInfo:r}=t,i=r.type===`dictionary-template`?e.createDictionaryTemplateField(r,n):await e.createComputedField({expression:r.expression});return i?{...t,computed:i}:null}function _t(e){return typeof e==`object`&&!!e&&(!(!(`valueExpressionInfo`in e)||!e.valueExpressionInfo)||`type`in e&&e.type===`Process`&&`op`in e&&e.op===`Random`)}function $(e){if(Array.isArray(e)){for(let t of e)if($(t))return!0}if(typeof e==`object`){if(_t(e))return!0;for(let t in e)if($(e[t]))return!0}return!1}var vt=class e{static async create(t,n,r,i){let a={},o=new Map,c=new Map,l=new Map,u=new Map,d=new Map,f=new Map;for(let e in r){let p=r[e];if(typeof p==`object`&&p)if(Array.isArray(p)){if(typeof p[0]==`object`)throw Error(`InternalError: Cannot handle ${e}. Nested array params are not supported`);a[e]=p}else{if(`valueExpressionInfo`in p){if(p.value){a[e]=p.value;continue}let n=await gt(t,p,i);if(!n){a[e]=p.defaultValue;continue}o.set(e,n),a[e]=null;continue}switch(p.type){case`cim-effect-infos`:if(p.effectInfos.some(e=>e.overrides.length)){c.set(e,{effects:await Promise.all(p.effectInfos.map(async e=>{let n=e.overrides.map(e=>Q(t,e,i,!1));return{effect:e.effect,compiledOverrides:(await Promise.all(n)).filter(s)}}))});break}a[e]=p.effectInfos.map(e=>e.effect);break;case`cim-marker-placement-param`:p.overrides.length&&l.set(e,{placementInfo:p,compiledOverrides:(await Promise.all(p.overrides.map(e=>Q(t,e,i,!1)))).filter(s)}),a[e]=p.placement;break;case`text-rasterization-param`:{if(p.overrides.length){let n=p.overrides.map(e=>Q(t,e,i,p.useLegacyLabelEvaluationRules??!1));u.set(e,{compiledOverrides:(await Promise.all(n)).filter(s),rasterizationParam:p,objectIdToResourceId:new Map});continue}let r={type:`cim-rasterization-info`,resource:p.resource};a[e]=await n.fetchResourceImmediate(r)??null;break}case`sprite-rasterization-param`:{if(p.overrides.length){let n=p.overrides.map(e=>Q(t,e,i,!1));u.set(e,{compiledOverrides:(await Promise.all(n)).filter(s),rasterizationParam:p,objectIdToResourceId:new Map});continue}if(p.resource.type===`animated`){u.set(e,{compiledOverrides:[],rasterizationParam:p,objectIdToResourceId:new Map});continue}let r={type:`cim-rasterization-info`,resource:p.resource};a[e]=await n.fetchResourceImmediate(r)??null;break}case`cim-marker-transform-param`:{let{params:n}=p;if($(n)){let r={compiledMarkerInfos:[]};await Promise.all(n.map(async e=>{let n={props:{}};for(let r in e)if(_t(e[r])){let a=await gt(t,e[r],i);n.compiledExpressionMap||=new Map;let o=n.compiledExpressionMap;a&&o.set(r,a)}else n.props[r]=e[r];r.compiledMarkerInfos.push(n)})),d.set(e,r)}else a[e]={type:`cim-marker-transform-info`,infos:n};break}case`animation-params`:{let{params:r}=p,i=Ce(r);if($(i)){let n=await Promise.all(i.map(e=>_e(e,t)));f.set(e,{params:n,propertyIdToResourceId:new Map,key:e})}else{let t=Se(i),r=await n.fetchResourceImmediate({type:`animation-info`,resource:t});r!=null&&r.type===`sprite`&&(a[e]={dataRow:r.rect.y,dataColumn:r.rect.x})}break}default:a[e]=p}}else a[e]=p}return new e(r,a,o,c,l,u,d,f)}constructor(e,t,n,r,i,a,o,s){this.inputMeshParams=e,this._resolvedMeshParams=t,this._dynamicProperties=n,this._dynamicEffectProperties=r,this._dynamicPlacementProperties=i,this._dynamicAsyncProperties=a,this._dynamicTransformProperties=o,this._dynamicAsyncAnimations=s,this.evaluator=e=>e,this._arcadeDependencies=new Set;for(let e of this._expressions())g(this._arcadeDependencies,e)}get hasDynamicProperties(){return!!(this._dynamicProperties.size||this._dynamicAsyncProperties.size||this._dynamicEffectProperties.size||this._dynamicTransformProperties.size||this._dynamicPlacementProperties.size||this._dynamicAsyncAnimations.size)}get evaluatedMeshParams(){return this._evaluatedMeshParams||=this.evaluator(this._resolvedMeshParams),this._evaluatedMeshParams}enqueueRequest(e,n,r){for(let i of this._dynamicAsyncProperties.values()){let a=d(i.rasterizationParam.resource);i.rasterizationParam.resource.type===`animated`&&i.rasterizationParam.resource.randomizeStartTime&&(a.primitiveName=`__RESERVED__PRIMITIVE__NAME__`,a.startGroup=ce(n.getObjectId()||0));for(let{primitiveName:e,propertyName:o,computed:s,defaultValue:c,valueExpressionInfo:l}of i.compiledOverrides)try{let t=i.rasterizationParam.resource.type===`animated`?a.primitiveName:e;ae(a,t,o,s,n,r,c)}catch(e){ht().errorOnce(new t(`invalid-arcade-expression`,`Encountered an error when evaluating the arcade expression`,{error:e,valueExpressionInfo:l}))}let o=e.enqueueRequest({type:`cim-rasterization-info`,resource:a});i.objectIdToResourceId.set(n.getObjectId(),o)}for(let t of this._dynamicAsyncAnimations.values()){let i=t.params.map(e=>ge(e,n,r)).map(we).map(e=>e.simplify()),a=pe(i),o=e.enqueueRequest({type:`animation-info`,resource:a});t.propertyIdToResourceId.set(n.getObjectId()+`.`+t.key,o)}}evaluateMeshParams(e,t,n){for(let[e,r]of this._dynamicProperties.entries())this._resolvedMeshParams[e]=r.computed.readWithDefault(t,n,r.defaultValue);for(let[e,r]of this._dynamicPlacementProperties.entries())for(let{computed:i,defaultValue:a,propertyName:o}of r.compiledOverrides){let s=i.readWithDefault(t,n,a);r.placementInfo.placement[o]=s,this._resolvedMeshParams[e]=r.placementInfo.placement}for(let[e,r]of this._dynamicEffectProperties.entries())for(let i of r.effects){for(let{computed:e,defaultValue:r,propertyName:a}of i.compiledOverrides){let o=e.readWithDefault(t,n,r);i.effect[a]=o}this._resolvedMeshParams[e]=r.effects.map(e=>e.effect)}for(let[e,r]of this._dynamicTransformProperties.entries()){let i={type:`cim-marker-transform-info`,infos:[]};for(let e of r.compiledMarkerInfos){let r={...e.props};if(e.compiledExpressionMap)for(let[i,a]of e.compiledExpressionMap){let e=a.computed.readWithDefault(t,n,a.defaultValue);r[i]=typeof e==`number`||typeof e==`boolean`?e:a.defaultValue}i.infos.push(r)}this._resolvedMeshParams[e]=i}for(let[n,r]of this._dynamicAsyncProperties.entries()){let i=r.objectIdToResourceId.get(t.getObjectId());if(i==null)continue;let a=e.getResource(i);this._resolvedMeshParams[n]=a}for(let[n,r]of this._dynamicAsyncAnimations.entries()){let i=r.propertyIdToResourceId.get(t.getObjectId()+`.`+n);if(i==null)continue;let a=e.getResource(i);this._resolvedMeshParams[n]={dataRow:a.rect.y,dataColumn:a.rect.x}}return this._evaluatedMeshParams=this.evaluator(this._resolvedMeshParams),this.evaluatedMeshParams}hasArcadeDependency(e){return this._arcadeDependencies.has(e)}*_expressions(){for(let e of this._dynamicProperties.values())yield e.computed;for(let e of this._dynamicEffectProperties.values())for(let t of e.effects)for(let e of t.compiledOverrides)yield e.computed;for(let e of this._dynamicPlacementProperties.values())for(let t of e.compiledOverrides)yield t.computed;for(let e of this._dynamicAsyncProperties.values())for(let t of e.compiledOverrides)yield t.computed;for(let e of this._dynamicTransformProperties.values())for(let t of e.compiledMarkerInfos)if(t.compiledExpressionMap!=null)for(let e of t.compiledExpressionMap.values())yield e.computed;for(let e of this._dynamicAsyncAnimations.values())for(let t of e.params)yield*Re(t)}},yt=class{async createMeshWriter(e,t,n,r,i){let a=this._getMeshWriter(r.techniqueType),o=await vt.create(e,t,r.inputParams,i),s=new a(r.id,o,r.optionalAttributes,n);return await s.loadDependencies(),s}_getMeshWriter(e){switch(e){case 13:return je;case 11:return Ae;case 9:return Le;case 26:return Pe;case 14:return He;case 24:return ke;case 27:return Ne;case 10:return Oe;case 21:return Fe;case 28:return Ve;case 30:return P;case 19:return Te;case 31:return ze;case 15:return Me;case 17:return De;case 18:return mt;case 2:return Ze;case 3:return Qe;case 0:return $e;case 1:return tt;default:throw Error(`Internal Error: Mesh writer not in the registry`)}}};export{Z as n,yt as t};