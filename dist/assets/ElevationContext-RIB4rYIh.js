const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/RibbonLine.glsl-CNRAGSkR.js","assets/RibbonLine.glsl-B6EO8Ip1.js","assets/index-CzMixifc.js","assets/index-CDgdHpAj.css","assets/MarkerSizing.glsl-CtCvR4o9.js","assets/FloatsPassUniform-Dhl7UDF5.js","assets/NoParameters-B66z9IwQ.js","assets/Uniform-CfHWJqSg.js","assets/VisualVariables.glsl-BbHLNeev.js","assets/AlphaCutoff-qYsC5qb0.js","assets/HighlightReadBitmap.glsl-yTX333eD.js","assets/glsl-B__sVAcg.js","assets/Texture2DBindUniform-BW-pj6EM.js","assets/Float3PassUniform-BIrLVK7_.js","assets/Float4PassUniform-CYWbrPzx.js","assets/ScreenSizePerspective.glsl-BlmhzUp0.js","assets/View.glsl-D5eT11ZQ.js","assets/Float3BindUniform-DnRIK6cJ.js","assets/Float3DrawUniform-UWnIK6YY.js","assets/FloatBindUniform-BPgZfINH.js","assets/Matrix4BindUniform-DNS5lGEU.js","assets/FloatPassUniform-D-_T45xB.js","assets/Slice.glsl-A8bL0Rkn.js","assets/ObjectAndLayerIdColor.glsl-DLOlMhcf.js","assets/PiUtils.glsl-D-ndpb0M.js","assets/TerrainDepthTest.glsl-BUpx6Cvv.js","assets/ReadDepth.glsl-DUk8QQwu.js","assets/Float2BindUniform-COpkFEGz.js","assets/Float4BindUniform-DtHi0dnJ.js","assets/Texture2DPassUniform-wY08hxIn.js","assets/OutputColorHighlightOLID.glsl-B38t8Aex.js","assets/Emissions.glsl-nadaueeL.js","assets/Texture2DDrawUniform-CV_1kucp.js","assets/ShaderBuilder-Dbc4jYz7.js","assets/videoUtils-CDhtaJ_j.js","assets/ManagedTexture-N0puH7JB.js","assets/image-CSnYJraV.js","assets/Util-YNFIi00s.js","assets/sdfPrimitives-CXbCDQbD.js"])))=>i.map(i=>d[i]);
import{$ as e,BS as t,Bf as n,Bi as r,Cl as i,Eb as a,Gg as o,Is as s,Iw as c,Ml as l,Nl as u,OT as d,Ol as f,Om as p,Q as m,Rf as h,Rm as g,Up as _,Vi as v,YE as y,Z as b,al as x,c_ as S,dD as ee,dl as te,dw as C,eT as w,gD as T,jl as E,kl as ne,mt as re,og as D,ol as O,ov as ie,sl as k,uD as ae,uE as A,u_ as j,vT as oe,yT as M,yl as N,ym as se,yw as P}from"./index-CzMixifc.js";import{D as ce,b as le,g as F,x as ue,y as de}from"./plane--nqwMDYx.js";import{t as fe}from"./computeTranslationToOriginAndRotation-DwwRDWAD.js";import{G as pe}from"./BufferView-BPABY7if.js";import{a as me,i as he}from"./Util-YNFIi00s.js";import{i as ge}from"./orientedBoundingBox-DQ8LQLAH.js";import{_ as _e,g as ve,h as ye,i as be,l as I,p as xe}from"./Emissions.glsl-nadaueeL.js";import{t as Se}from"./sphere-DkSdrT5o.js";import{d as Ce,n as we,o as Te,s as Ee}from"./lineSegment-WEn1ku7V.js";import{i as De}from"./hydratedFeatures-Cj67oeX-.js";import{a as Oe,n as ke,u as Ae}from"./renderState-DH1meWdn.js";import{B as je,E as Me,F as Ne,H as Pe,L as Fe,O as Ie,P as L,R as Le,S as Re,U as ze,V as Be,c as Ve,d as He,f as Ue,k as We,l as Ge,m as Ke,p as qe,s as Je,u as Ye}from"./DefaultBufferWriter-CAVJ0EqM.js";import{c as Xe}from"./MaterialUtil-BLN1UlUe.js";import{t as Ze}from"./Octree-Bwk-xF2H.js";import{a as Qe,i as $e,s as et}from"./SceneLighting-Bd70zCMB.js";import{a as tt}from"./FloatArray-DhcAaYJ8.js";import{d as nt,i as rt}from"./FloatsPassUniform-Dhl7UDF5.js";import{t as it}from"./AlphaCutoff-qYsC5qb0.js";import{r as at,t as ot}from"./RibbonLine.glsl-B6EO8Ip1.js";import{u as st}from"./graphicUtils-D4vcxFBm.js";function ct(e){return e===`position`}function lt(e,t){return e??=[],e.push(t),e}function ut(e,t){if(e==null)return null;let n=e.filter(e=>e!==t);return n.length===0?null:n}function dt(e,t,n,r,i){ft[0]=e.get(t,0),ft[1]=e.get(t,1),ft[2]=e.get(t,2),Xe(ft,R,3),n.set(i,0,R[0]),r.set(i,0,R[1]),n.set(i,1,R[2]),r.set(i,1,R[3]),n.set(i,2,R[4]),r.set(i,2,R[5])}var ft=S(),R=new Float32Array(6),pt=class{constructor(e={}){this.id=P(),this._highlightIds=new Set,this._shaderTransformation=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerViewUid=e.layerViewUid,e.isElevationSource&&(this.lastValidElevationBB=new mt),this._geometries=e.geometries?Array.from(e.geometries):[]}dispose(){this._geometries.length=0}get layer(){return this._layer}set layer(e){me(this._layer==null||e==null,`Object3D can only be added to a single Layer`),this._layer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e);for(let t of this._highlightIds)e.addHighlight(t);this._emit(`geometryAdded`,{object:this,geometry:e}),this._highlightIds.size&&this._emit(`highlightChanged`,this),this._invalidateBoundingVolume()}removeGeometry(e){let t=this._geometries.splice(e,1)[0];if(t){for(let e of this._highlightIds)t.removeHighlight(e);this._emit(`geometryRemoved`,{object:this,geometry:t}),this._highlightIds.size&&this._emit(`highlightChanged`,this),this._invalidateBoundingVolume()}}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t,n=!1){this._emit(`attributesChanged`,{object:this,geometry:e,attribute:t,sync:n}),ct(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(let e of this._geometries)e.visible=this._visible;this._emit(`visibilityChanged`,this)}}maskOccludee(){let e=new ze;for(let t of this._geometries)t.occludees=lt(t.occludees,e);return this._emit(`occlusionChanged`,this),e}removeOcclude(e){for(let t of this._geometries)t.occludees=ut(t.occludees,e);this._emit(`occlusionChanged`,this)}highlight(e){let t=new Pe(e);for(let e of this._geometries)e.addHighlight(t);return this._emit(`highlightChanged`,this),this._highlightIds.add(t),t}removeHighlight(e){this._highlightIds.delete(e);for(let t of this._geometries)t.removeHighlight(e);this._emit(`highlightChanged`,this)}removeStateID(e){e.channel===0?this.removeHighlight(e):this.removeOcclude(e)}getCombinedStaticTransformation(e,t){return p(t,this.transformation,e.transformation)}getCombinedShaderTransformation(e,t=h()){return p(t,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=new ht,this._validateBoundingVolume(this._bvWorldSpace,0)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=new ht,this._validateBoundingVolume(this._bvObjectSpace,1)),this._bvObjectSpace}_validateBoundingVolume(e,t){let n=t===1;for(let t of this._geometries){let r=t.boundingInfo;r&&gt(r,e,n?t.transformation:this.getCombinedShaderTransformation(t))}k(e.bounds.center,e.min,e.max,.5);for(let t of this._geometries){let r=t.boundingInfo;if(r==null)continue;let i=n?t.transformation:this.getCombinedShaderTransformation(t),a=ce(i);x(vt,r.center,i);let o=ne(vt,e.bounds.center),s=r.radius*a;e.bounds.radius=Math.max(e.bounds.radius,o+s)}}_invalidateBoundingVolume(){let e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this.layer&&e&&this.layer.notifyObjectBBChanged(this,e)}_emit(e,t){this.layer?.events.emit(e,t)}get geometries(){return this._geometries}get transformation(){return this._transformation??n}set transformation(e){this._transformation=g(this._transformation??h(),e),this._invalidateBoundingVolume(),this._emit(`transformationChanged`,this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?g(this._shaderTransformation??h(),e):null,this._invalidateBoundingVolume(),this._emit(`shaderTransformationChanged`,this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}get test(){}},mt=class{constructor(){this._data=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE]}get min(){return j(this._data[0],this._data[1],this._data[2])}get max(){return j(this._data[3],this._data[4],this._data[5])}minWith(e){let{_data:t}=this;t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2])}maxWith(e){let{_data:t}=this;t[3]=Math.max(t[3],e[0]),t[4]=Math.max(t[4],e[1]),t[5]=Math.max(t[5],e[2])}assignMinMax(e,t){for(let n=0;n<3;++n)this._data[0+n]=e[n],this._data[3+n]=t[n]}isEmpty(){return this._data[3]<this._data[0]&&this._data[4]<this._data[1]&&this._data[5]<this._data[2]}},ht=class extends mt{constructor(){super(...arguments),this.bounds=new Se}};function gt(e,t,n){let r=e.bbMin,i=e.bbMax;if(se(n)){let e=f(_t,n[12],n[13],n[14]);u(z,r,e),u(B,i,e),t.minWith(z),t.maxWith(B);return}if(x(z,r,n),O(r,i))return t.minWith(z),void t.maxWith(z);x(B,i,n),t.minWith(z),t.minWith(B),t.maxWith(z),t.maxWith(B);for(let e=0;e<3;++e)l(z,r),l(B,i),z[e]=i[e],B[e]=r[e],x(z,z,n),x(B,B,n),t.minWith(z),t.minWith(B),t.maxWith(z),t.maxWith(B)}var _t=S(),z=S(),B=S(),vt=S(),yt=[`layerObjectAdded`,`layerObjectRemoved`,`layerObjectsAdded`,`layerObjectsRemoved`,`transformationChanged`,`shaderTransformationChanged`,`visibilityChanged`,`occlusionChanged`,`highlightChanged`,`geometryAdded`,`geometryRemoved`,`attributesChanged`],bt=class{constructor(e,t,n=``){this.stage=e,this.apiLayerViewUid=n,this.id=P(),this.events=new ie,this.visible=!0,this.sliceable=!1,this._objectsAdded=[],this._handles=new M,this._objects=new Map,this._pickable=!0,this.visible=t?.visible??!0,this._pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??0,e.addLayer(this);for(let t of yt)this._handles.add(this.events.on(t,n=>e.handleEvent(t,n)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.removeLayer(this),this.invalidateSpatialQueryAccelerator())}get objects(){return this._objects}getObject(e){return ee(this._objects.get(e))}set pickable(e){this._pickable=e}get pickable(){return this._pickable&&this.visible}add(e){this._objects.set(e.id,e),e.layer=this,this.events.emit(`layerObjectAdded`,e),this._octree!=null&&this._objectsAdded.push(e)}remove(e){this._objects.delete(e.id)&&(this.events.emit(`layerObjectRemoved`,e),e.layer=null,this._octree!=null&&(y(this._objectsAdded,e)||this._octree.remove([e])))}addMany(e){for(let t of e)this._objects.set(t.id,t),t.layer=this;this.events.emit(`layerObjectsAdded`,e),this._octree!=null&&this._objectsAdded.push(...e)}removeMany(e){let t=[];for(let n of e)this._objects.delete(n.id)&&t.push(n);if(t.length!==0&&(this.events.emit(`layerObjectsRemoved`,t),t.forEach(e=>e.layer=null),this._octree!=null)){for(let e=0;e<t.length;)y(this._objectsAdded,t[e])?(t[e]=t[t.length-1],--t.length):++e;this._octree.remove(t)}}commit(){this.stage.commitLayer(this)}sync(){this.updatePolicy!==1&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){this._octree==null||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return this._octree==null&&this._objects.size>50?(this._octree=new Ze(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.values())):this._octree!=null&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded),this._objectsAdded.length=0),this._octree}invalidateSpatialQueryAccelerator(){this._octree=oe(this._octree),this._objectsAdded.length=0}get test(){}},xt=class{constructor(e,t){this.vec3=e,this.id=t}};function St(e,t,n,r){return new xt(j(e,t,n),r)}var Ct={stableRendering:!1},wt={rootOrigin:null},Tt=class extends Qe{constructor(e,n){super(e,n,Dt(n).locations),this.shader=new et(at,()=>t(()=>import(`./RibbonLine.glsl-CNRAGSkR.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]))),this.primitiveType=n.wireframe?s.LINES:s.TRIANGLE_STRIP}_makePipelineState(e,t){let{oitPass:n,output:r,hasEmission:i,hasOccludees:a,hasPolygonOffset:o}=e,s=n===0,c=n===2;return ke({blending:I(r)?Le(n):null,depthTest:Ne(n),depthWrite:je(e),drawBuffers:$e(r,Be(n,i)),colorWrite:Oe,stencilWrite:a?Ye:null,stencilTest:a?t?qe:Ve:null,polygonOffset:s||c?o?Et:null:Fe})}initializePipeline(e){if(e.occluder){let t=e.hasPolygonOffset?Et:null,{output:n,hasOccludees:r}=e;this._occluderPipelineTransparent=ke({blending:Ae,polygonOffset:t,depthTest:Ue,depthWrite:null,colorWrite:Oe,stencilWrite:null,stencilTest:r?Ge:null,drawBuffers:$e(n)}),this._occluderPipelineOpaque=ke({blending:Ae,polygonOffset:t,depthTest:r?Ue:Je,depthWrite:null,colorWrite:Oe,stencilWrite:r?He:null,stencilTest:r?Ke:null,drawBuffers:$e(n)}),this._occluderPipelineMaskWrite=ke({blending:null,polygonOffset:t,depthTest:Je,depthWrite:null,colorWrite:null,stencilWrite:r?Ye:null,stencilTest:r?qe:null,drawBuffers:$e(n)})}return this._occludeePipeline=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){if(t)return this._occludeePipeline;switch(e.occluder){case 12:return this._occluderPipelineTransparent??super.getPipeline(e);case 11:return this._occluderPipelineOpaque??super.getPipeline(e);default:ae(e.occluder);case void 0:case null:return this._occluderPipelineMaskWrite??super.getPipeline(e)}}};Tt=T([d(`esri.views.3d.webgl-engine.shaders.RibbonLineTechnique`)],Tt);var Et={factor:0,units:-4};function Dt(e){let t=tt().vec3f(`position`).vec4f16(`previousDelta`).vec4f16(`nextDelta`).f32(`u0`).vec2f16(`lineParameters`);return e.hasVVColor?t.f32(`colorFeatureAttribute`):t.vec4u8(`color`,{glNormalized:!0}),e.hasVVSize?t.f32(`sizeFeatureAttribute`):t.f32(`size`),e.hasVVOpacity&&t.f32(`opacityFeatureAttribute`),nt()&&t.vec4u8(`olidColor`),e.hasAnimation&&t.vec4f16(`timeStamps`),t}var V=class extends Ie{constructor(e){super(),this.spherical=e,this.capType=0,this.emissionSource=0,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.occluder=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.wireframe=!1,this.discardInvisibleFragments=!1,this.animation=2,this.hasScreenSizePerspective=!1,this.textureCoordinateType=0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasSliceTranslatedView=!0,this.overlayEnabled=!1,this.snowCover=!1}get hasAnimation(){return this.animation!==0}};T([L({count:3})],V.prototype,`capType`,void 0),T([L({count:8})],V.prototype,`emissionSource`,void 0),T([L()],V.prototype,`hasPolygonOffset`,void 0),T([L()],V.prototype,`writeDepth`,void 0),T([L()],V.prototype,`draped`,void 0),T([L()],V.prototype,`stippleEnabled`,void 0),T([L()],V.prototype,`stippleOffColorEnabled`,void 0),T([L()],V.prototype,`stipplePreferContinuous`,void 0),T([L()],V.prototype,`roundJoins`,void 0),T([L()],V.prototype,`applyMarkerOffset`,void 0),T([L()],V.prototype,`hasVVSize`,void 0),T([L()],V.prototype,`hasVVColor`,void 0),T([L()],V.prototype,`hasVVOpacity`,void 0),T([L()],V.prototype,`falloffEnabled`,void 0),T([L()],V.prototype,`innerColorEnabled`,void 0),T([L()],V.prototype,`hasOccludees`,void 0),T([L()],V.prototype,`occluder`,void 0),T([L()],V.prototype,`terrainDepthTest`,void 0),T([L()],V.prototype,`cullAboveTerrain`,void 0),T([L()],V.prototype,`wireframe`,void 0),T([L()],V.prototype,`discardInvisibleFragments`,void 0),T([L({count:4})],V.prototype,`animation`,void 0),T([L()],V.prototype,`hasScreenSizePerspective`,void 0);var Ot=class extends Me{constructor(e,t){super(e,At),this.produces=new Map([[2,e=>ye(e)||I(e)&&this.parameters.renderOccluded===8],[3,e=>_e(e)],[11,e=>xe(e)&&this.parameters.renderOccluded===8],[12,e=>xe(e)&&this.parameters.renderOccluded===8],[4,e=>I(e)&&this.parameters.writeDepth&&this.parameters.renderOccluded!==8],[9,e=>I(e)&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==8],[19,e=>ve(e)]]),this._configuration=new V(t)}getConfiguration(e,t){super.getConfiguration(e,t,this._configuration),this._configuration.oitPass=t.oitPass,this._configuration.draped=t.slot===19;let n=this.parameters.stipplePattern!=null&&e!==8;return this._configuration.stippleEnabled=n,this._configuration.stippleOffColorEnabled=n&&this.parameters.stippleOffColor!=null,this._configuration.stipplePreferContinuous=n&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.roundJoins=this.parameters.join===`round`,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=this.parameters.markerParameters!=null&&Pt(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&this.parameters.innerColor!=null,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.hasOccludees=t.hasOccludees,this._configuration.occluder=this.parameters.renderOccluded===8,this._configuration.terrainDepthTest=t.terrainDepthTest&&I(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.wireframe=this.parameters.wireframe,this._configuration.animation=this.parameters.animation,this._configuration.emissionSource=this.hasEmissions?1:0,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration}get visible(){return this.parameters.color[3]>=.003913894324853229||this.parameters.stipplePattern!=null&&(this.parameters.stippleOffColor?.[3]??0)>.003913894324853229}setParameters(e,t){e.animation=this.parameters.animation,super.setParameters(e,t)}intersectDraped({attributes:e,screenToWorldRatio:t},n,r,i,a){if(!n.options.selectionMode)return;let o=e.get(`size`),s=this.parameters.width;if(this.parameters.vvSize){let t=e.get(`sizeFeatureAttribute`).data[0];Number.isNaN(t)?s*=this.parameters.vvSize.fallback[0]:s*=C(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o&&(s*=o.data[0]);let c=r[0],l=r[1],u=(s/2+4)*t,d=Number.MAX_VALUE,f=0,p=e.get(`position`).data,m=Nt(this.parameters,e)?p.length-2:p.length-5;for(let e=0;e<m;e+=3){let t=p[e],n=p[e+1],r=(e+3)%p.length,i=c-t,a=l-n,o=p[r]-t,s=p[r+1]-n,u=C((o*i+s*a)/(o*o+s*s),0,1),m=o*u-i,h=s*u-a,g=m*m+h*h;g<d&&(d=g,f=e/3)}d<u*u&&i(a.distance,a.normal,f)}intersect(e,t,n,r,o,s){let{options:c,camera:d,rayBegin:p,rayEnd:m}=n;if(!c.selectionMode||!e.visible||!d)return;if(!he(t))return void A.getLogger(`esri.views.3d.webgl-engine.materials.RibbonLineMaterial`).error(`intersection assumes a translation-only matrix`);let h=e.attributes,g=h.get(`position`).data,_=this.parameters.width;if(this.parameters.vvSize){let e=h.get(`sizeFeatureAttribute`).data[0];Number.isNaN(e)||(_*=C(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0]))}else h.has(`size`)&&(_*=h.get(`size`).data[0]);let v=Ft;a(v,n.point);let y=_*d.pixelRatio/2+4*d.pixelRatio;f(X[0],v[0]-y,v[1]+y,0),f(X[1],v[0]+y,v[1]+y,0),f(X[2],v[0]+y,v[1]-y,0),f(X[3],v[0]-y,v[1]-y,0);for(let e=0;e<4;e++)if(!d.unprojectFromRenderScreen(X[e],Z[e]))return;ue(d.eye,Z[0],Z[1],Ht),ue(d.eye,Z[1],Z[2],Ut),ue(d.eye,Z[2],Z[3],Wt),ue(d.eye,Z[3],Z[0],Gt);let b=Number.MAX_VALUE,x=0,S=Nt(this.parameters,h)?g.length-2:g.length-5;for(let e=0;e<S;e+=3){H[0]=g[e]+t[12],H[1]=g[e+1]+t[13],H[2]=g[e+2]+t[14];let n=(e+3)%g.length;if(U[0]=g[n]+t[12],U[1]=g[n+1]+t[13],U[2]=g[n+2]+t[14],F(Ht,H)<0&&F(Ht,U)<0||F(Ut,H)<0&&F(Ut,U)<0||F(Wt,H)<0&&F(Wt,U)<0||F(Gt,H)<0&&F(Gt,U)<0)continue;let r=d.projectToRenderScreen(H,It),a=d.projectToRenderScreen(U,Lt);if(r==null||a==null)continue;if(r[2]<0&&a[2]>0){N(W,H,U);let e=d.frustum,t=-F(e[4],H)/te(W,le(e[4]));if(i(W,W,t),u(H,H,W),!d.projectToRenderScreen(H,r))continue}else if(r[2]>0&&a[2]<0){N(W,U,H);let e=d.frustum,t=-F(e[4],U)/te(W,le(e[4]));if(i(W,W,t),u(U,U,W),!d.projectToRenderScreen(U,a))continue}else if(r[2]<0&&a[2]<0)continue;r[2]=0,a[2]=0;let o=Ee(Te(r,a,Bt),v);o<b&&(b=o,l(Rt,H),l(zt,U),x=e/3)}if(b<y*y){let e=Number.MAX_VALUE;if(we(Te(Rt,zt,Bt),Te(p,m,Vt),G)){N(G,G,p);let t=E(G);i(G,G,1/t),e=t/ne(p,m)}s(e,G,x)}}get hasEmissions(){return this.parameters.emissiveStrength>0}createBufferWriter(){return new jt(Dt(this.parameters),this.parameters)}createGLMaterial(e){return new kt(e)}validateParameters(e){e.join!==`miter`&&(e.miterLimit=0),e.markerParameters!=null&&(e.markerScale=e.markerParameters.width/e.width)}update(e){return!!this.parameters.hasAnimation&&(this.setParameters({timeElapsed:c(e.time)},!1),e.dt!==0)}},kt=class extends be{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures?.release(this._stipplePattern),this._stipplePattern=null}beginSlot(e){let t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.getTechnique(Tt,e)}},At=class extends rt{constructor(){super(...arguments),this.width=0,this.color=e,this.join=`miter`,this.cap=0,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.wireframe=!1,this.timeElapsed=0,this.animation=0,this.animationSpeed=1,this.trailLength=1,this.startTime=0,this.endTime=1/0,this.fadeInTime=0,this.fadeOutTime=1/0,this.emissiveStrength=0}get transparent(){return this.color[3]<1||this.hasAnimation||this.stipplePattern!=null&&(this.stippleOffColor?.[3]??0)<1}get hasAnimation(){return this.animation!==0}},jt=class{constructor(e,t){this.layout=e,this._parameters=t;let n=t.stipplePattern?1:0;switch(this._parameters.join){case`miter`:case`bevel`:this.numJoinSubdivisions=n;break;case`round`:this.numJoinSubdivisions=1+n}}_isClosed(e){return Nt(this._parameters,e)}allocate(e){return this.layout.createBuffer(e)}elementCount(e){let t=e.get(`position`).indices.length/2+1,n=this._isClosed(e),r=n?2:4;return r+=((n?t:t-1)-(n?0:1))*(2*this.numJoinSubdivisions+4),r+=2,this._parameters.wireframe&&(r=2+4*(r-2)),r}write(e,t,n,r,i,a){let o=this.layout,s=n.get(`position`),c=s.indices,u=s.data.length/3,d=n.get(`distanceToStart`)?.data;c&&c.length!==2*(u-1)&&console.warn(`RibbonLineMaterial does not support indices`);let p=o.fields.has(`sizeFeatureAttribute`),m=1,h=null;if(p){let e=n.get(`sizeFeatureAttribute`);e.data.length===1?m=e.data[0]:h=e.data}else m=n.get(`size`)?.data[0]??1;let g=[1,1,1,1],_=0,v=null,y=o.fields.has(`colorFeatureAttribute`);if(y){let e=n.get(`colorFeatureAttribute`);e.data.length===1?_=e.data[0]:v=e.data}else g=n.get(`color`)?.data??g;let b=n.get(`timeStamps`)?.data,S=b&&o.fields.has(`timeStamps`),ee=o.fields.has(`opacityFeatureAttribute`),te=0,C=null;if(ee){let e=n.get(`opacityFeatureAttribute`);e.data.length===1?te=e.data[0]:C=e.data}let w=new Float32Array(i.buffer),T=pe(i.buffer),E=new Uint8Array(i.buffer),D=o.stride/4,O=a*D,ie=O,k=0,ae=d?(e,t,n)=>k=d[n]:(e,t,n)=>k+=ne(e,t),A=w.BYTES_PER_ELEMENT/T.BYTES_PER_ELEMENT,j=4/A,oe=nt(),M=(e,t,n,i,a,o,s,c)=>{w[O++]=t[0],w[O++]=t[1],w[O++]=t[2],Re(e,t,T,O*A),O+=j,Re(n,t,T,O*A),O+=j,w[O++]=c;let l=O*A;if(T[l++]=a,T[l++]=o,O=Math.ceil(l/A),y)w[O]=v?.[s]??_;else{let e=Math.min(4*s,g.length-4),t=4*O;E[t]=255*g[e],E[t+1]=255*g[e+1],E[t+2]=255*g[e+2],E[t+3]=255*g[e+3]}if(O++,w[O++]=h?.[s]??m,ee&&(w[O++]=C?.[s]??te),oe){let e=4*O;r?(E[e++]=r[0],E[e++]=r[1],E[e++]=r[2],E[e++]=r[3]):(E[e++]=0,E[e++]=0,E[e++]=0,E[e++]=0),O=Math.ceil(.25*e)}S&&(l=O*A,T[l++]=i[0],T[l++]=i[1],T[l++]=i[2],T[l++]=i[3],O=Math.ceil(l/A))};O+=D,f(q,s.data[0],s.data[1],s.data[2]),S&&re(Y,b[0],b[1],b[2],b[3]),e&&x(q,q,e);let N=this._isClosed(n);if(N){let t=s.data.length-3;f(K,s.data[t],s.data[t+1],s.data[t+2]),e&&x(K,K,e)}else f(J,s.data[3],s.data[4],s.data[5]),e&&x(J,J,e),M(q,q,J,Y,1,-4,0,0),M(q,q,J,Y,1,4,0,0),l(K,q),l(q,J),S&&re(Y,b[4],b[5],b[6],b[7]);let se=N?0:1,P=N?u:u-1;for(let t=se;t<P;t++){let n=(t+1)%u*3;f(J,s.data[n],s.data[n+1],s.data[n+2]),e&&x(J,J,e),ae(K,q,t),M(K,q,J,Y,0,-1,t,k),M(K,q,J,Y,0,1,t,k);let r=this.numJoinSubdivisions;for(let e=0;e<r;++e){let n=(e+1)/(r+1);M(K,q,J,Y,n,-1,t,k),M(K,q,J,Y,n,1,t,k)}if(M(K,q,J,Y,1,-2,t,k),M(K,q,J,Y,1,2,t,k),l(K,q),l(q,J),S){let e=(t+1)%u*4;re(Y,b[e],b[e+1],b[e+2],b[e+3])}}return N?(f(J,s.data[3],s.data[4],s.data[5]),e&&x(J,J,e),k=ae(K,q,P),M(K,q,J,Y,0,-1,se,k),M(K,q,J,Y,0,1,se,k)):(k=ae(K,q,P),M(K,q,q,Y,0,-5,P,k),M(K,q,q,Y,0,5,P,k)),Mt(w,ie+D,w,ie,D),O=Mt(w,O-D,w,O,D),this._parameters.wireframe&&this._addWireframeVertices(i,ie,O,D),null}_addWireframeVertices(e,t,n,r){let i=new Float32Array(e.buffer,n*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,n-t),o=0,s=e=>o=Mt(a,e,i,o,r);for(let e=0;e<a.length-1;e+=2*r)s(e),s(e+2*r),s(e+1*r),s(e+2*r),s(e+1*r),s(e+3*r)}};function Mt(e,t,n,r,i){for(let a=0;a<i;a++)n[r++]=e[t++];return r}function Nt(e,t){return e.isClosed?t.get(`position`).indices.length>2:!1}function Pt(e){return e.anchor===1&&e.hideOnShortSegments&&e.placement===`begin-end`&&e.worldSpace}var H=S(),U=S(),W=S(),G=S(),Ft=S(),It=D(),Lt=D(),Rt=S(),zt=S(),Bt=Ce(),Vt=Ce(),K=S(),q=S(),J=S(),Y=b(),X=[D(),D(),D(),D()],Z=[S(),S(),S(),S()],Ht=de(),Ut=de(),Wt=de(),Gt=de(),Kt=class{constructor(e){this._originSR=e,this._rootOriginId=`root/`+P(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){let t=this._origins.get(this._rootOriginId);if(t==null){let t=wt.rootOrigin;if(t!=null)return this._origins.set(this._rootOriginId,St(t[0],t[1],t[2],this._rootOriginId)),this.getOrigin(e);let n=St(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,n),n}let n=this._gridSize,r=Math.round(e[0]/n),i=Math.round(e[1]/n),a=Math.round(e[2]/n),o=`${r}/${i}/${a}`,s=this._origins.get(o),c=.5*n;if(N(Q,e,t.vec3),Q[0]=Math.abs(Q[0]),Q[1]=Math.abs(Q[1]),Q[2]=Math.abs(Q[2]),Q[0]<c&&Q[1]<c&&Q[2]<c){if(s){let t=Math.max(...Q);if(N(Q,e,s.vec3),Q[0]=Math.abs(Q[0]),Q[1]=Math.abs(Q[1]),Q[2]=Math.abs(Q[2]),Math.max(...Q)<t)return s}return t}return s||(s=St(r*n,i*n,a*n,o),this._origins.set(o,s)),s}_drawOriginBox(e,t=m(1,1,0,1)){let n=window.view,r=n.stage,i=t.toString();if(!this._objects.has(i)){this._material=new Ot({width:2,color:t},!1);let e=new bt(r,{pickable:!1}),n=new pt({castShadow:!1});e.add(n),this._objects.set(i,n)}let a=this._objects.get(i),s=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],c=s.length,l=Array(3*c),u=[],d=.5*this._gridSize;for(let t=0;t<c;t++)l[3*t]=e[0]+(1&s[t]?d:-d),l[3*t+1]=e[1]+(2&s[t]?d:-d),l[3*t+2]=e[2]+(4&s[t]?d:-d),t>0&&u.push(t-1,t);o(l,this._originSR,0,l,n.renderSpatialReference,0,c);let f=new We(this._material,[[`position`,new ge(l,u,3,!0)]],null,2);a.addGeometry(f)}get test(){}},Q=S(),qt=class{constructor(e,t=null,n=0){this.array=e,this.spatialReference=t,this.offset=n}};function Jt(e){return`array`in e}function Yt(e,t,n=`ground`){if(st(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,n);if(Jt(t)){let r=t.offset;return e.getElevation(t.array[r++],t.array[r++],t.array[r]||0,t.spatialReference??e.spatialReference,n)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,n)}function Xt(e,t,n,r,i,a,s,c,l,u,d){let f=dn[d.mode],p,m,h=0;if(o(e,t,n,r,l.spatialReference,i,c))return f?.requiresAlignment(d)?(h=f.applyElevationAlignmentBuffer(r,i,a,s,c,l,u,d),p=a,m=s):(p=r,m=i),o(p,l.spatialReference,m,a,u.spatialReference,s,c)?h:void 0}function Zt(e,t,n,r,i){let a=(st(e)?e.z:Jt(e)?e.array[e.offset+2]:e[2])||0;switch(n.mode){case`on-the-ground`:{let n=Yt(t,e,`ground`)??0;i.verticalDistanceToGround=0,i.sampledElevation=n,i.z=n;return}case`relative-to-ground`:{let o=Yt(t,e,`ground`)??0,s=n.geometryZWithOffset(a,r);i.verticalDistanceToGround=s,i.sampledElevation=o,i.z=s+o;return}case`relative-to-scene`:{let o=Yt(t,e,`scene`)??0,s=n.geometryZWithOffset(a,r);i.verticalDistanceToGround=s,i.sampledElevation=o,i.z=s+o;return}case`absolute-height`:{let o=n.geometryZWithOffset(a,r),s=Yt(t,e,`ground`)??0;i.verticalDistanceToGround=o-s,i.sampledElevation=s,i.z=o;return}default:i.z=0;return}}function Qt(e,t,n,r){return Zt(e,t,n,r,$),$.z}function $t(e,t,n){return t===`on-the-ground`&&n===`on-the-ground`?e.staysOnTheGround:t===n||t!==`on-the-ground`&&n!==`on-the-ground`?t==null||n==null?e.definedChanged:1:e.onTheGroundChanged}function en(e){return e===`relative-to-ground`||e===`relative-to-scene`}function tn(e){return e!==`absolute-height`}function nn(e,t,n,r,i){Zt(t,n,i,r,$),rn(e,$.verticalDistanceToGround);let a=$.sampledElevation,o=g(fn,e.transformation);return pn[0]=t.x,pn[1]=t.y,pn[2]=$.z,fe(t.spatialReference,pn,o,r.spatialReference)?e.transformation=o:console.warn(`Could not locate symbol object properly, it might be misplaced`),a}function rn(e,t){for(let n=0;n<e.geometries.length;++n){let r=e.geometries[n].getMutableAttribute(`centerOffsetAndDistance`);r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[n],`centerOffsetAndDistance`))}}function an(e,t,n,r,i,a){let o=0,s=a.spatialReference;t*=3,r*=3;for(let c=0;c<i;++c){let i=e[t],c=e[t+1],l=e[t+2],u=a.getElevation(i,c,l,s,`ground`)??0;o+=u,n[r]=i,n[r+1]=c,n[r+2]=u,t+=3,r+=3}return o/i}function on(e,t,n,r,i,a,o,s){let c=0,l=s.calculateOffsetRenderUnits(o),u=s.featureExpressionInfoContext,d=a.spatialReference;t*=3,r*=3;for(let o=0;o<i;++o){let i=e[t],o=e[t+1],s=e[t+2],f=a.getElevation(i,o,s,d,`ground`)??0;c+=f,n[r]=i,n[r+1]=o,n[r+2]=u==null?s+f+l:f+l,t+=3,r+=3}return c/i}function sn(e,t,n,r,i,a,o,s){let c=0,l=s.calculateOffsetRenderUnits(o),u=s.featureExpressionInfoContext,d=a.spatialReference;t*=3,r*=3;for(let o=0;o<i;++o){let i=e[t],o=e[t+1],s=e[t+2],f=a.getElevation(i,o,s,d,`scene`)??0;c+=f,n[r]=i,n[r+1]=o,n[r+2]=u==null?s+f+l:f+l,t+=3,r+=3}return c/i}function cn(e){let t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return t!==0||n!=null}function ln(e,t,n,r,i,a,o,s){let c=s.calculateOffsetRenderUnits(o),l=s.featureExpressionInfoContext;t*=3,r*=3;for(let a=0;a<i;++a){let i=e[t],a=e[t+1],o=e[t+2];n[r]=i,n[r+1]=a,n[r+2]=l==null?o+c:c,t+=3,r+=3}return 0}var un=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}},dn={"absolute-height":{applyElevationAlignmentBuffer:ln,requiresAlignment:cn},"on-the-ground":{applyElevationAlignmentBuffer:an,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:on,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:sn,requiresAlignment:()=>!0}},fn=h(),$=new un,pn=S(),mn=()=>A.getLogger(`esri.views.3d.layers.graphics.featureExpressionInfoUtils`);function hn(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}async function gn(e,t,n,r){let i=e?.expression;if(typeof i!=`string`)return null;let a=Cn(i);if(a!=null)return{cachedResult:a};let o=await _();w(n);let s=o.arcadeUtils,c=s.createSyntaxTree(i);return s.dependsOnView(c)?(r?.error(`Expressions containing '$view' are not supported on ElevationInfo`),{cachedResult:0}):{arcade:{func:s.createFunction(c),context:s.createExecContext(null,{sr:t}),modules:o}}}function _n(e,t,n){return e.arcadeUtils.createFeature(t.attributes,t.geometry,n)}function vn(e,t){if(e!=null&&!Sn(e)){if(!t||!e.arcade)return void mn().errorOncePerTick(`Arcade support required but not provided`);let n=t;n._geometry&&=De(n._geometry),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function yn(e){if(e!=null){if(Sn(e))return e.cachedResult;let t=e.arcade,n=t?.modules.arcadeUtils.executeFunction(t.func,t.context);return typeof n!=`number`&&(e.cachedResult=0,n=0),n}return 0}function bn(e,t=!1){let n=e?.featureExpressionInfo,r=n?.expression;return t||r===`0`||(n=null),n??null}var xn={cachedResult:0};function Sn(e){return e.cachedResult!=null}function Cn(e){return e===`0`?0:null}var wn=class e{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit=`meters`,this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.mode=null,this.centerInElevationSR=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=v(e)}get requiresSampledElevationInfo(){return this.mode!==`absolute-height`}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit=`meters`}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){let n=this.calculateOffsetRenderUnits(t);return this.featureExpressionInfoContext==null?e+n:n}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset,n=this.featureExpressionInfoContext;return n!=null&&(t+=yn(n)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=r(e.unit)?e.unit:`meters`,this.offsetElevationInfoUnits=e.offset??0}setFeatureExpressionInfoContext(e){this._featureExpressionInfoContext=e}updateFeatureExpressionInfoContextForGraphic(e,t,n){e.arcade?(this._featureExpressionInfoContext=hn(e),this.updateFeatureExpressionFeature(t,n)):this._featureExpressionInfoContext=e}updateFeatureExpressionFeature(e,t){let n=this.featureExpressionInfoContext;n?.arcade&&(n.cachedResult=void 0,vn(this._featureExpressionInfoContext,e.geometry?_n(n.arcade.modules,e,t):null))}static fromElevationInfo(t){let n=new e;return t!=null&&n.setFromElevationInfo(t),n}};export{ct as C,dt as S,Ot as _,Zt as a,bt as b,nn as c,rn as d,Qt as f,Kt as g,qt as h,xn as i,Xt as l,Yt as m,gn as n,en as o,un as p,bn as r,$t as s,wn as t,tn as u,Ct as v,pt as x,St as y};