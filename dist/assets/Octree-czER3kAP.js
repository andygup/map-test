import{Nl as e,Ul as t,Wl as n,_l as r,wT as i,x_ as a,yT as o,y_ as s}from"./index-BN8X5Ryz.js";import{r as c}from"./Util-BQgFCZvD.js";import{r as l}from"./ray-LkJ58wpZ.js";import{r as u}from"./sphere-d9-4vNcj.js";import{a as d}from"./frustum-LgSQ4wIS.js";var f=class r{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,t){this.objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new p,this._objectCount=0,t&&(t.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=t.maximumObjectsPerNode),t.maximumDepth!==void 0&&(this._maximumDepth=t.maximumDepth))}destroy(){this._degenerateObjects.clear(),p.clearPool(),M[0]=null,R.prune(),U.prune()}add(e){let t=Array.from(e);this._grow(t);let n=p.acquire();for(let e of t)++this._objectCount,this._isDegenerate(e)?this._degenerateObjects.add(e):(n.init(this._root),this._add(e,n));p.release(n)}remove(e,t=null){this._objectCount-=e.length;let n=p.acquire();for(let r of e){let e=t??this.objectToBoundingSphere(r);O(e.radius)?(n.init(this._root),g(r,e,n)):this._degenerateObjects.delete(r)}p.release(n),this._shrink()}update(e,t){if(!O(t.radius)&&this._isDegenerate(e))return;let n=N(e);this.remove(n,t),this.add(n)}forEachAlongRay(e,t,n){let r=l(e,t);m(this._root,e=>{if(!v(r,e))return!1;let t=e.node;return t.terminals.forAll(e=>{this._intersectsObject(r,e)&&n(e)}),t.residents!==null&&t.residents.forAll(e=>{this._intersectsObject(r,e)&&n(e)}),!0})}forEachAlongRayWithVerticalOffset(e,t,n,r){let i=l(e,t);m(this._root,e=>{if(!y(i,e,r))return!1;let t=e.node;return t.terminals.forAll(e=>{this._intersectsObjectWithOffset(i,e,r)&&n(e)}),t.residents!==null&&t.residents.forAll(e=>{this._intersectsObjectWithOffset(i,e,r)&&n(e)}),!0})}forEach(e){m(this._root,t=>{let n=t.node;return n.terminals.forAll(e),n.residents!==null&&n.residents.forAll(e),!0}),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(n,r,i,a=()=>!0,o=1/0){let s=1/0,c=1/0,l=null,u=E(n,r),f=e=>{if(--o,!a(e))return;let t=this.objectToBoundingSphere(e);if(!d(i,t))return;let u=D(n,r,t.center),f=u-t.radius,p=u+t.radius;f<s&&(s=f,c=p,l=e)};return h(this._root,a=>{if(o<=0||!d(i,a.bounds)||(e(F,u,a.halfSize),t(F,F,a.bounds.center),D(n,r,F)>c))return!1;let s=a.node;return s.terminals.forAll(e=>f(e)),s.residents!==null&&s.residents.forAll(e=>f(e)),!0},n,r),l}forEachInDepthRange(n,r,i,a,o,s,c){let l=-1/0,u=1/0,f={setRange:e=>{i===1?(l=Math.max(l,e.near),u=Math.min(u,e.far)):(l=Math.max(l,-e.far),u=Math.min(u,-e.near))}};f.setRange(a);let p=D(r,i,n),m=E(r,i),g=E(r,-i),_=e=>{if(!c(e))return;let t=this.objectToBoundingSphere(e),n=D(r,i,t.center)-p,a=n-t.radius,m=n+t.radius;a>u||m<l||!d(s,t)||o(e,f)};h(this._root,n=>{if(!d(s,n.bounds)||(e(F,m,n.halfSize),t(F,F,n.bounds.center),D(r,i,F)-p>u)||(e(F,g,n.halfSize),t(F,F,n.bounds.center),D(r,i,F)-p<l))return!1;let a=n.node;return a.terminals.forAll(e=>_(e)),a.residents!==null&&a.residents.forAll(e=>_(e)),!0},r,i)}forEachNode(e){m(this._root,t=>e(t.node,t.bounds,t.halfSize,t.depth))}forEachNeighbor(e,t){let r=t.radius,i=t.center,a=t=>{let a=this.objectToBoundingSphere(t),o=a.radius,s=r+o;return!(n(a.center,i)-s*s<=0)||e(t)},o=!0,s=e=>{o&&=a(e)};m(this._root,e=>{let t=e.bounds.radius,a=r+t;if(n(e.bounds.center,i)-a*a>0)return!1;let c=e.node;return c.terminals.forAll(s),o&&c.residents!==null&&c.residents.forAll(s),o}),o&&this.forEachDegenerateObject(s)}_intersectsObject(e,t){let n=this.objectToBoundingSphere(t);return!(n.radius>0)||n.intersectRay(e)}_intersectsObjectWithOffset(e,t,n){let r=this.objectToBoundingSphere(t);return!(r.radius>0)||n.applyToBoundingSphere(r).intersectRay(e)}_add(e,t){t.advanceTo(this.objectToBoundingSphere(e))?t.node.terminals.push(e):(t.node.residents.push(e),t.node.residents.length>this._maximumObjectsPerNode&&t.depth<this._maximumDepth&&this._split(t))}_split(e){let t=e.node.residents;e.node.residents=null;for(let n=0;n<t.length;n++){let r=p.acquire().init(e);this._add(t.at(n),r),p.release(r)}}_grow(e){if(w(e,e=>this.objectToBoundingSphere(e),z),O(z.radius)&&!this._fitsInsideTree(z))if(b(this._root.node))this._root.bounds.copyFrom(z),this._root.halfSize=1.25*this._root.bounds.radius,this._root.updateBoundsRadiusFromHalfSize();else{let e=this._rootBoundsForRootAsSubNode(z);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(z,e):this._growRootAsSubNode(e),p.release(e)}}_rebuildTree(e,t){B.center=t.bounds.center,B.radius=t.halfSize,w([e,B],e=>e,V);let n=p.acquire().init(this._root);this._root.initFrom(null,V,V.radius),this._root.increaseHalfSize(1.25),m(n,e=>(this.add(e.node.terminals.data),e.node.residents!==null&&this.add(e.node.residents.data),!0)),p.release(n)}_placingRootViolatesMaxDepth(e){let t=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E,n=0;return m(this._root,e=>(n=Math.max(n,e.depth),n+t<=this._maximumDepth)),n+t>this._maximumDepth}_rootBoundsForRootAsSubNode(e){let t=e.radius,n=e.center,r=-1/0,i=this._root.bounds.center,a=this._root.halfSize;for(let e=0;e<3;e++){let o=i[e]-a-(n[e]-t),s=n[e]+t-(i[e]+a),c=Math.max(0,Math.ceil(o/(2*a))),l=Math.max(0,Math.ceil(s/(2*a)))+1,u=2**Math.ceil(Math.log(c+l)*Math.LOG2E);r=Math.max(r,u),H[e].min=c,H[e].max=l}for(let e=0;e<3;e++){let t=H[e].min,n=H[e].max,o=(r-(t+n))/2;t+=Math.ceil(o),n+=Math.floor(o);let s=i[e]-a-t*a*2;P.center[e]=s+(n+t)*a}let o=r*a;return P.radius=o*j,p.acquire().initFrom(null,P,o,0)}_growRootAsSubNode(e){let t=this._root.node;z.center=this._root.bounds.center,z.radius=this._root.halfSize,this._root.init(e),e.advanceTo(z,null,!0),e.node.children=t.children,e.node.residents=t.residents,e.node.terminals=t.terminals}_shrink(){for(;;){let e=this._findShrinkIndex();if(e===-1)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let e=null,t=this._root.node.children,n=0,r=0;for(;r<t.length&&e==null;)n=r++,e=t[n];for(;r<t.length;)if(t[r++])return-1;return n}_isDegenerate(e){return!O(this.objectToBoundingSphere(e).radius)}_fitsInsideTree(e){let t=this._root.bounds,n=this._root.halfSize;return e.radius<=n&&e.center[0]>=t.center[0]-n&&e.center[0]<=t.center[0]+n&&e.center[1]>=t.center[1]-n&&e.center[1]<=t.center[1]+n&&e.center[2]>=t.center[2]-n&&e.center[2]<=t.center[2]+n}toJSON(){let{maximumDepth:e,maximumObjectsPerNode:t,_objectCount:n}=this,r=this._nodeToJSON(this._root.node);return{maximumDepth:e,maximumObjectsPerNode:t,objectCount:n,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:r}}}_nodeToJSON(e){let t=e.children.map(e=>e?this._nodeToJSON(e):null),n=e.residents?.map(e=>this.objectToBoundingSphere(e)),r=e.terminals?.map(e=>this.objectToBoundingSphere(e));return{children:t,residents:n,terminals:r}}static fromJSON(e){let t=new r(e=>e,{maximumDepth:e.maximumDepth,maximumObjectsPerNode:e.maximumObjectsPerNode});return t._objectCount=e.objectCount,t._root.initFrom(e.root.node,e.root.bounds,e.root.halfSize,e.root.depth),t}},p=class e{constructor(){this.bounds=new u,this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(t,n,r,i=this.depth){return this.node=t??e.createEmptyNode(),n&&this.bounds.copyFrom(n),this.halfSize=r,this.depth=i,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds.radius=this.halfSize*j}advance(t){let n=this.node.children[t];n||(n=e.createEmptyNode(),this.node.children[t]=n),this.node=n,this.halfSize/=2,this.depth++;let r=k[t];return this.bounds.center[0]+=r[0]*this.halfSize,this.bounds.center[1]+=r[1]*this.halfSize,this.bounds.center[2]+=r[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,t,n=!1){for(;;){if(this.isTerminalFor(e))return t?.(this,-1),!0;if(this.isLeaf()){if(!n)return t?.(this,-1),!1;this.node.residents=null}let r=this._childIndex(e);t?.(this,r),this.advance(r)}}isLeaf(){return this.node.residents!=null}isTerminalFor(e){return e.radius>this.halfSize/2}_childIndex(e){let t=this.bounds.center;return(t[0]<e.center[0]?1:0)+(t[1]<e.center[1]?2:0)+(t[2]<e.center[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new o({shrink:!0}),residents:new o({shrink:!0})}}static{this._pool=new i(()=>new e)}static acquire(){return e._pool.acquire()}static release(t){e._pool.release(t)}static clearPool(){e._pool.prune()}};function m(e,t){let n=p.acquire().init(e),r=[n];for(;r.length!==0;){if(n=r.pop(),t(n)&&!n.isLeaf())for(let e=0;e<n.node.children.length;e++)n.node.children[e]&&r.push(p.acquire().init(n).advance(e));p.release(n)}}function h(e,t,n,r=1){let i=p.acquire().init(e),a=[i];for(T(n,r,W);a.length!==0;){if(i=a.pop(),t(i)&&!i.isLeaf())for(let e=7;e>=0;--e){let t=W[e];i.node.children[t]&&a.push(p.acquire().init(i).advance(t))}p.release(i)}}function g(e,t,n){R.clear();let r=n.advanceTo(t,(e,t)=>{R.push(e.node),R.push(t)})?n.node.terminals:n.node.residents;if(r.removeUnordered(e),r.length===0)for(let e=R.length-2;e>=0&&_(R.data[e],R.data[e+1]);e-=2);}function _(e,t){return t>=0&&(e.children[t]=null),!!b(e)&&(e.residents===null&&(e.residents=new o({shrink:!0})),!0)}function v(e,t){return C(t.bounds.center,2*-t.halfSize,I),C(t.bounds.center,2*t.halfSize,L),c(e.origin,e.direction,I,L)}function y(e,t,n){return C(t.bounds.center,2*-t.halfSize,I),C(t.bounds.center,2*t.halfSize,L),n.applyToMinMax(I,L),c(e.origin,e.direction,I,L)}function b(e){if(e.terminals.length!==0)return!1;if(e.residents!==null)return e.residents.length===0;for(let t=0;t<e.children.length;t++)if(e.children[t])return!1;return!0}function x(e,t){e[0]=Math.min(e[0],t.center[0]-t.radius),e[1]=Math.min(e[1],t.center[1]-t.radius),e[2]=Math.min(e[2],t.center[2]-t.radius)}function S(e,t){e[0]=Math.max(e[0],t.center[0]+t.radius),e[1]=Math.max(e[1],t.center[1]+t.radius),e[2]=Math.max(e[2],t.center[2]+t.radius)}function C(e,t,n){n[0]=e[0]+t,n[1]=e[1]+t,n[2]=e[2]+t}function w(e,t,n){I[0]=1/0,I[1]=1/0,I[2]=1/0,L[0]=-1/0,L[1]=-1/0,L[2]=-1/0;for(let n of e){let e=t(n);O(e.radius)&&(x(I,e),S(L,e))}r(n.center,I,L,.5),n.radius=Math.max(L[0]-I[0],L[1]-I[1],L[2]-I[2])/2}function T(e,t,n){if(!U.length)for(let e=0;e<8;++e)U.push({index:0,distance:0});for(let n=0;n<8;++n){let r=k[n];U.data[n].index=n,U.data[n].distance=D(e,t,r)}U.sort((e,t)=>e.distance-t.distance);for(let e=0;e<8;++e)n[e]=U.data[e].index}function E(e,t){let n,r=1/0;for(let i=0;i<8;++i){let a=D(e,t,A[i]);a<r&&(r=a,n=A[i])}return n}function D(e,t,n){return t*(e[0]*n[0]+e[1]*n[1]+e[2]*n[2])}function O(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}var k=[a(-1,-1,-1),a(1,-1,-1),a(-1,1,-1),a(1,1,-1),a(-1,-1,1),a(1,-1,1),a(-1,1,1),a(1,1,1)],A=[a(-1,-1,-1),a(-1,-1,1),a(-1,1,-1),a(-1,1,1),a(1,-1,-1),a(1,-1,1),a(1,1,-1),a(1,1,1)],j=Math.sqrt(3),M=[null];function N(e){return M[0]=e,M}var P=new u,F=s(),I=s(),L=s(),R=new o,z=new u,B=new u,V=new u,H=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],U=new o,W=[0,0,0,0,0,0,0,0];export{f as t};