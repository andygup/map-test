import{A as e,AT as t,Ai as n,BT as r,C as i,DT as a,Dh as o,Di as s,GC as c,Ha as l,Jf as ee,Jw as te,L as u,M as d,MT as f,OT as p,Qf as m,RS as h,SC as ne,SE as g,_,ba as v,ca as y,gD as b,gw as re,iE as x,jT as ie,ji as ae,ma as oe,np as S,pa as se,uE as C,ud as w,vE as T,xa as E}from"./index-ByaFsVj4.js";import{n as D,t as O}from"./SceneService-sH-A36GQ.js";import"./originUtils-BJaUzj5W.js";import"./resourceUtils-C04-w-fM.js";import"./resourceUtils-DYI0vrsK.js";import"./saveUtils-BB0-rUbr.js";import{o as k,p as A,y as j}from"./elevationInfoUtils-CyQsBf6_.js";import{i as M,n as N,r as P,t as F}from"./PointCloudUniqueValueRenderer-C-G80tg6.js";var I=Symbol(`isPointCloudGraphicOrigin`),L,R=class extends v{get[(L=I,ee)](){return this.layer}get[E](){return this.layer}constructor(e){super(),this[L]=!0,this.type=`point-cloud`,this.layer=e}get id(){return this.layer.id}},z=class extends c{constructor(e){super(e),this.field=null,this.type=null}clone(){return console.warn(`.clone() is not implemented for `+this.declaredClass),null}};b([a({type:String,json:{write:{enabled:!0,isRequired:!0}}})],z.prototype,`field`,void 0),b([a({readOnly:!0,nonNullable:!0,json:{read:!1,write:{isRequired:!0}}})],z.prototype,`type`,void 0),z=b([p(`esri.layers.pointCloudFilters.PointCloudFilter`)],z);var B=z,V,H=V=class extends B{constructor(e){super(e),this.requiredClearBits=null,this.requiredSetBits=null,this.type=`bitfield`}clone(){return new V({field:this.field,requiredClearBits:g(this.requiredClearBits),requiredSetBits:g(this.requiredSetBits)})}};b([a({type:[x],json:{write:{enabled:!0,overridePolicy(){return{enabled:!0,isRequired:!this.requiredSetBits}}}}})],H.prototype,`requiredClearBits`,void 0),b([a({type:[x],json:{write:{enabled:!0,overridePolicy(){return{enabled:!0,isRequired:!this.requiredClearBits}}}}})],H.prototype,`requiredSetBits`,void 0),b([f({pointCloudBitfieldFilter:`bitfield`})],H.prototype,`type`,void 0),H=V=b([p(`esri.layers.pointCloudFilters.PointCloudBitfieldFilter`)],H);var U=H,W,G=W=class extends B{constructor(e){super(e),this.includedReturns=[],this.type=`return`}clone(){return new W({field:this.field,includedReturns:g(this.includedReturns)})}};b([a({type:[[`firstOfMany`,`last`,`lastOfMany`,`single`]],json:{write:{enabled:!0,isRequired:!0}}})],G.prototype,`includedReturns`,void 0),b([f({pointCloudReturnFilter:`return`})],G.prototype,`type`,void 0),G=W=b([p(`esri.layers.pointCloudFilters.PointCloudReturnFilter`)],G);var K=G,q,J=q=class extends B{constructor(e){super(e),this.mode=`exclude`,this.type=`value`,this.values=[]}clone(){return new q({field:this.field,mode:this.mode,values:g(this.values)})}};b([a({type:[`exclude`,`include`],json:{write:{enabled:!0,isRequired:!0}}})],J.prototype,`mode`,void 0),b([f({pointCloudValueFilter:`value`})],J.prototype,`type`,void 0),b([a({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],J.prototype,`values`,void 0),J=q=b([p(`esri.layers.pointCloudFilters.PointCloudValueFilter`)],J);var ce={key:`type`,base:B,typeMap:{value:J,bitfield:U,return:K}},Y,X=Y=class extends M{constructor(e){super(e),this.type=`point-cloud-rgb`,this.field=null}clone(){return new Y({...this.cloneProperties(),field:g(this.field)})}};b([f({pointCloudRGBRenderer:`point-cloud-rgb`})],X.prototype,`type`,void 0),b([a({type:String,json:{write:{isRequired:!0}}})],X.prototype,`field`,void 0),X=Y=b([p(`esri.renderers.PointCloudRGBRenderer`)],X);var le=X,Z={key:`type`,base:M,typeMap:{"point-cloud-class-breaks":P,"point-cloud-rgb":le,"point-cloud-stretch":N,"point-cloud-unique-value":F},errorContext:`renderer`},Q=i(),$=class extends D(se(u(d(e(l(y(oe(re(o))))))))){constructor(...e){super(...e),this.operationalLayerType=`PointCloudLayer`,this.popupEnabled=!0,this.popupTemplate=null,this.opacity=1,this.filters=[],this.fields=null,this.fieldsIndex=null,this.outFields=null,this.path=null,this.legendEnabled=!0,this.renderer=null,this.type=`point-cloud`,this.graphicOrigin=new R(this),this.rootPagePromise=null}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}get defaultPopupTemplate(){return this.attributeStorageInfo?this.createPopupTemplate():null}getFieldDomain(e){let t=this.fieldsIndex.get(e);return t?.domain?t.domain:null}readServiceFields(e,t,n){return Array.isArray(e)?e.map(e=>{let t=new w;return e.type===`FieldTypeInteger`&&((e=g(e)).type=`esriFieldTypeInteger`),t.read(e,n),t}):Array.isArray(t.attributeStorageInfo)?t.attributeStorageInfo.map(e=>new w({name:e.name,type:e.name===`ELEVATION`?`double`:`integer`})):null}set elevationInfo(e){e!=null&&e.mode!==`absolute-height`||this._set(`elevationInfo`,e),this._validateElevationInfo(e)}writeRenderer(e,t,n,r){T(`layerDefinition.drawingInfo.renderer`,e.write({},r),t)}load(e){return this.addResolvingPromise(this._load(e)),Promise.resolve(this)}async _load(e){await this.loadFromPortal({supportedTypes:[`Scene Service`]},e).catch(te),await this._fetchService(e?.signal),await this._fetchRootPageAndUpdateExtent(e?.signal)}async _fetchRootPageAndUpdateExtent(e){this.rootPagePromise=this._fetchRootPage(e);let{fullExtent:t}=this;if(t!=null&&!t.hasZ){let e=await this.rootPagePromise;O(t,e?.nodes?.[0]?.obb)}}async _fetchRootPage(e){let t=`${this.parsedUrl?.path??``}/nodepages/0`;try{return(await h(t,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:e})).data}catch(e){throw new r(`pointcloudlayer:root-page-missing`,`Root page missing.`,{error:e,url:t})}}createPopupTemplate(e){let t=_(this,e);return t&&(this._formatPopupTemplateReturnsField(t),this._formatPopupTemplateRGBField(t)),t}_formatPopupTemplateReturnsField(e){let t=this.fieldsIndex.get(`RETURNS`);if(!t)return;let n=e.fieldInfos?.find(e=>e.fieldName===t.name);if(!n)return;let r=new S({name:`pcl-returns-decoded`,title:t.alias||t.name,expression:`\n        var returnValue = $feature.${t.name};\n        return (returnValue % 16) + " / " + Floor(returnValue / 16);\n      `});e.expressionInfos=[...e.expressionInfos||[],r],n.fieldName=`expression/pcl-returns-decoded`}_formatPopupTemplateRGBField(e){let t=this.fieldsIndex.get(`RGB`);if(!t)return;let n=e.fieldInfos?.find(e=>e.fieldName===t.name);if(!n)return;let r=new S({name:`pcl-rgb-decoded`,title:t.alias||t.name,expression:`\n        var rgb = $feature.${t.name};\n        var red = Floor(rgb / 65536, 0);\n        var green = Floor((rgb - (red * 65536)) / 256,0);\n        var blue = rgb - (red * 65536) - (green * 256);\n\n        return "rgb(" + red + "," + green + "," + blue + ")";\n      `});e.expressionInfos=[...e.expressionInfos||[],r],n.fieldName=`expression/pcl-rgb-decoded`}async queryCachedStatistics(e,t){if(await this.load(t),!this.attributeStorageInfo)throw new r(`scenelayer:no-cached-statistics`,`Cached statistics are not available for this layer`);let n=this.fieldsIndex.get(e);if(!n)throw new r(`pointcloudlayer:field-unexisting`,`Field '${e}' does not exist on the layer`);for(let e of this.attributeStorageInfo)if(e.name===n.name){let n=ne(this.parsedUrl?.path??``,`./statistics/${e.key}`);return h(n,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:t?t.signal:null}).then(e=>e.data)}throw new r(`pointcloudlayer:no-cached-statistics`,`Cached statistics for this attribute are not available`)}async saveAs(e,t){return this._debouncedSaveOperations(1,{...t,getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:`point-cloud`},e)}async save(){return this._debouncedSaveOperations(0,{getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:`point-cloud`})}validateLayer(e){if(e.layerType&&e.layerType!==`PointCloud`)throw new r(`pointcloudlayer:layer-type-not-supported`,`PointCloudLayer does not support this layer type`,{layerType:e.layerType});if(isNaN(this.version.major)||isNaN(this.version.minor))throw new r(`layer:service-version-not-supported`,`Service version is not supported.`,{serviceVersion:this.version.versionString,supportedVersions:`1.x-2.x`});if(this.version.major>2)throw new r(`layer:service-version-too-new`,`Service version is too new.`,{serviceVersion:this.version.versionString,supportedVersions:`1.x-2.x`})}hasCachedStatistics(e){return this.attributeStorageInfo!=null&&this.attributeStorageInfo.some(t=>t.name===e)}_getTypeKeywords(){return[`PointCloud`]}_validateElevationInfo(e){A(C.getLogger(this),j(`Point cloud layers`,`absolute-height`,e)),A(C.getLogger(this),k(`Point cloud layers`,e))}};b([a({type:[`PointCloudLayer`]})],$.prototype,`operationalLayerType`,void 0),b([a(n)],$.prototype,`popupEnabled`,void 0),b([a({type:m,json:{name:`popupInfo`,write:!0}})],$.prototype,`popupTemplate`,void 0),b([a({readOnly:!0,json:{read:!1}})],$.prototype,`defaultPopupTemplate`,null),b([a({readOnly:!0,json:{write:!1,read:!1,origins:{"web-document":{write:!1,read:!1}}}})],$.prototype,`opacity`,void 0),b([a({type:[`show`,`hide`]})],$.prototype,`listMode`,void 0),b([a({types:[ce],json:{origins:{service:{read:{source:`filters`}}},name:`layerDefinition.filters`,write:!0}})],$.prototype,`filters`,void 0),b([a({type:[w]})],$.prototype,`fields`,void 0),b([a(Q.fieldsIndex)],$.prototype,`fieldsIndex`,void 0),b([ie(`service`,`fields`,[`fields`,`attributeStorageInfo`])],$.prototype,`readServiceFields`,null),b([a(Q.outFields)],$.prototype,`outFields`,void 0),b([a({readOnly:!0})],$.prototype,`attributeStorageInfo`,void 0),b([a(ae)],$.prototype,`elevationInfo`,null),b([a({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],$.prototype,`path`,void 0),b([a(s)],$.prototype,`legendEnabled`,void 0),b([a({types:Z,json:{origins:{service:{read:{source:`drawingInfo.renderer`}}},name:`layerDefinition.drawingInfo.renderer`,write:{target:{"layerDefinition.drawingInfo.renderer":{types:Z},"layerDefinition.drawingInfo.transparency":{type:Number}}}}})],$.prototype,`renderer`,void 0),b([t(`renderer`)],$.prototype,`writeRenderer`,null),b([a({json:{read:!1},readOnly:!0})],$.prototype,`type`,void 0),b([a({readOnly:!0})],$.prototype,`graphicOrigin`,void 0),$=b([p(`esri.layers.PointCloudLayer`)],$);var ue=$;export{ue as default};