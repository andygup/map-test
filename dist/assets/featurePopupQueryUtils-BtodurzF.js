import{$p as e,Wp as t,im as n,jp as r}from"./index-BN8X5Ryz.js";async function i(e,i,a,o){let s=Array(i.length),c=new Map,l=new Map,u=r(e.fieldsIndex,a.outFields),d=!0===e.capabilities?.operations?.supportsQuery&&e.queryFeatures!=null,f=o?.hasRequiredFields??t;for(let e=0;e<i.length;e++){let t=i[e];if(d&&!t.isAggregate){if(a.returnGeometry||!f(t,u)){let n=t.getObjectId();if(n!=null){c.set(n,{graphic:t,index:e});continue}let r=t.getGlobalId();if(r!=null){l.set(r,{graphic:t,index:e});continue}}s[e]=t}else s[e]=t}if(!d||!e.queryFeatures||c.size===0&&l.size===0)return s.filter(Boolean);let p=[],m=(e,t)=>{t&&(e.outFields??=[],e.outFields.includes(t)||e.outFields.push(t))};if(c.size>0){let t=a.clone();m(t,e.objectIdField),`uniqueIdFields`in e&&e.uniqueIdFields?.length&&(t.outFields??=[],t.outFields.push(...e.uniqueIdFields)),t.objectIds=Array.from(c.keys()),p.push({type:`object-id`,query:t,map:c})}let h=`globalIdField`in e?e.globalIdField:null;if(h!=null&&l.size>0){let e=a.clone();m(e,h);let t=Array.from(l.keys());e.where=n(a.where,`${h} IN (${t.map(e=>`'${e}'`).join(`,`)})`),p.push({type:`global-id`,query:e,map:l})}let g=o?.updateSourceAttributes??!1;for(let{type:t,query:n,map:r}of p)try{let i=await e.queryFeatures(n,o);for(let e of i.features){let n=t===`object-id`?e.getObjectId():e.getGlobalId();if(n==null)continue;let i=r.get(n);if(!i)continue;let{graphic:a,index:o}=i;if(g&&e.attributes){a.attributes??={};for(let t of u)t in e.attributes&&(a.attributes[t]=e.attributes[t])}let{geometry:c,origin:l}=a;e.geometry||=c,e.origin=l,s[o]=e}}catch{}return s.filter(Boolean)}async function a(t){if(t.expressionInfos?.length||Array.isArray(t.content)&&t.content.some(e=>e.type===`expression`))return e()}export{a as n,i as t};