import{BT as e,D_ as t,In as n,Of as r,Vr as i,Vt as a,Wp as o,bc as s,cc as c,dn as l,ey as u,fn as d,gp as f,j_ as p,jp as m,ks as h,mE as g,nn as _,pD as v,qp as ee,rd as te,tx as ne,uE as y,x_ as re}from"./index-CZ4oMP1N.js";import{r as b}from"./memoryEstimations-DQOvnrRz.js";import{i as ie,t as x}from"./timeSupport-DTr00ezP.js";import{a as S}from"./queryUtils-DcyDFw5_.js";import{c as C,i as w,n as T,r as E,t as D}from"./callExpressionWithCursor-BmfrFX6I.js";import{f as O,g as ae,u as oe}from"./utils-DS5dbHj4.js";import{c as k,l as A,u as se}from"./UpdateTracking2D-BiwypiBP.js";import{x as ce}from"./constants-BuH6TGxi.js";var le=1.25,j=class{get length(){return this._pos}constructor(e,t){this._pos=0;let n=t?this._roundToNearest(t,e.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(n),this._buffer=new e(this._array),this._ctor=e,this._i16View=new Int16Array(this._array)}_roundToNearest(e,t){let n=Math.round(e);return t===1?n:n+(t-n%t)}_ensureSize(e){if(this._pos+e>=this._buffer.length){let t=this._roundToNearest((this._array.byteLength+e*this._buffer.BYTES_PER_ELEMENT)*le,this._buffer.BYTES_PER_ELEMENT),n=new ArrayBuffer(t),r=new this._ctor(n);r.set(this._buffer,0),this._array=n,this._buffer=r,this._i16View=new Int16Array(this._array)}}ensureSize(e){this._ensureSize(e)}writeF32(e){this._ensureSize(1);let t=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=e,this._pos++,t}push(e){this._ensureSize(1);let t=this._pos;return this._buffer[this._pos++]=e,t}writeFixed(e){this._buffer[this._pos++]=e}setValue(e,t){this._buffer[e]=t}i1616Add(e,t,n){this._i16View[2*e]+=t,this._i16View[2*e+1]+=n}getValue(e){return this._buffer[e]}getValueF32(e){return new Float32Array(this._array,4*e,1)[0]}incr(e){if(this._buffer.length<e)throw Error(`Increment index overflows the target buffer`);this._buffer[e]++}decr(e){this._buffer[e]--}writeRegion(e){this._ensureSize(e.length);let t=this._pos;return this._buffer.set(e,this._pos),this._pos+=e.length,t}writeManyFrom(e,t,n){this._ensureSize(n-t);for(let r=t;r!==n;r++)this.writeFixed(e._buffer[r])}buffer(){let e=this._array.slice(0,4*this._pos);return this.destroy(),e}toArray(){return[...this._buffer]}seek(e){this._pos=e}destroy(){this._array=null,this._buffer=null}},M=6,N=4,P=class{constructor(e,t,n=0){let r=M*n*Uint32Array.BYTES_PER_ELEMENT,i=N*n*t.stride,a=t.stride/4,o=t.attributes.find(e=>e.name===`pos`||e.name===`position`);if(!o)throw Error(`InternalError: Unable to find position attribute`);this.layout={...t,position:o},this._indices=new j(Uint32Array,r),this._vertices=new j(Uint32Array,i),this._metrics=new j(Uint32Array,0),this._metricCountOffset=this._metrics.push(0),this._strideInt=a,this._instanceId=e}serialize(e){let t=this._indices.buffer(),n=this._vertices.buffer(),r=this._metrics.length?this._metrics.buffer():null;return e.push(t,n),{instanceId:this._instanceId,layout:this.layout,indices:t,vertices:n,metrics:r}}get strideInt(){return this._strideInt}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(e){this._vertices.ensureSize(e)}indexEnsureSize(e){this._indices.ensureSize(e)}writeIndex(e){this._indices.push(e)}writeVertex(e){this._vertices.push(e)}writeVertexRegion(e){this._vertices.writeRegion(e)}writeVertexF32(e){this._vertices.writeF32(e)}writeMetric(e){this._metrics.incr(this._metricCountOffset),e.serialize(this._metrics)}},F=class{constructor(e,t=0){this._id=e,this._sizeHint=t,this._entityRecordCountOffset=0,this._entityCountOffset=0,this._entityIdIndex=0,this._entitySortKeyIndex=0,this._didEntityStart=!1,this._instanceIdToVertexData=new Map,this._recordIndexStart=0,this._recordIndexCount=0,this._recordVertexStart=0,this._recordVertexCount=0,this._current={metric:null,writer:null,start:0,sortKey:0,instanceId:0,layoutHash:0,indexStart:0,vertexStart:0,textureKey:0,metricBoxLenPointer:0},this._entities=new j(Uint32Array,this._sizeHint*oe.byteSizeHint),this._entityCountOffset=this._entities.push(0)}get id(){return this._id}serialize(){let e=[],t=[],n=this._entities.buffer();for(let n of this._instanceIdToVertexData.values())t.push(n.serialize(e));return{message:{data:t,entities:n},transferList:e}}vertexStart(){return this._current.vertexStart??0}vertexCount(){return this._current.writer?.vertexCount??0}indexCount(){return this._current.writer?.indexCount??0}vertexEnsureSize(e){this._current.writer.vertexEnsureSize(e)}indexEnsureSize(e){this._current.writer.indexEnsureSize(e)}vertexWrite(e){this._current.writer.writeVertex(e)}vertexWriteRegion(e){this._current.writer.writeVertexRegion(e)}vertexWriteF32(e){this._current.writer.writeVertexF32(e)}recordBounds(e,t,n,r){}indexWrite(e){this._current.writer.writeIndex(e)}metricStart(e){this._current.metric=e,this._current.metric.recordStart=this.recordCount()}metricEnd(){let e=this._current.writer;this._current.metric&&(this._current.metric.recordCount=this.recordCount()-this._current.metric.recordStart),this._current.metric?.bounds.length&&this._current.metric?.recordCount&&e.writeMetric(this._current.metric),this._current.metric=null}metricBoxWrite(e){this._current.metric.bounds.push(e)}entityStart(e,t=e){this._entityIdIndex=this._entities.push(e),this._entitySortKeyIndex=this._entities.writeF32(t),this._entityRecordCountOffset=this._entities.push(0),this._didEntityStart=!0}entityRecordCount(){return this._entities.getValue(this._entityRecordCountOffset)}entityEnd(){this._didEntityStart&&=(this.entityRecordCount()===0?this._entities.seek(this._entityIdIndex):this._entities.incr(this._entityCountOffset),!1)}recordCount(){return this._entities.getValue(this._entityRecordCountOffset)}recordStart(e,t,n=0){this._current.writer=this._getVertexWriter(e,t),this._current.indexStart=this._current.writer.indexCount,this._current.vertexStart=this._current.writer.vertexCount,this._current.instanceId=e,this._current.layoutHash=t.hash,this._current.textureKey=n}recordEnd(e=0){let t=this._current.vertexStart,n=this._current.writer.vertexCount-t;if(!n)return!1;let r=this._current.indexStart,i=this._current.writer.indexCount-r;return this._recordIndexStart=r,this._recordIndexCount=i,this._recordVertexStart=t,this._recordVertexCount=n,this._entities.incr(this._entityRecordCountOffset),O.write(this._entities,this._current.instanceId,this._current.textureKey,r,i,t,n,e),!0}copyLast(e,t){let n=this._recordVertexStart+this._recordVertexCount;this._entities.incr(this._entityRecordCountOffset),O.write(this._entities,this._current.instanceId,this._current.textureKey,this._recordIndexStart+this._recordIndexCount,this._recordIndexCount,n,this._recordVertexCount,0);let r=this._current.writer.indexWriter,i=this._current.writer.vertexWriter,a=this._recordIndexStart+this._recordIndexCount,o=this._recordVertexCount;for(let e=this._recordIndexStart;e!==a;e++){let t=r.getValue(e);r.push(t+o)}let s=this._current.writer.layout.stride/Uint32Array.BYTES_PER_ELEMENT,c=this._recordVertexStart*s,l=(this._recordVertexStart+this._recordVertexCount)*s;for(let e=c;e!==l;e++){let t=i.getValue(e);i.push(t)}let u=this._current.writer.layout.position,d=u.packPrecisionFactor??1,f=u.offset/Uint32Array.BYTES_PER_ELEMENT,p=e*d,m=t*d;for(let e=n*s;e<=i.length;e+=s)i.i1616Add(e+f,p,m)}copyLastFrom(e,t,n){let r=e._entities.getValue(e._entityIdIndex);if(r!==this._entities.getValue(this._entityIdIndex)){let t=e._entities.getValueF32(e._entitySortKeyIndex);this.entityStart(r,t)}this.recordStart(e._current.instanceId,e._current.writer.layout,e._current.textureKey);let i=this._current.writer.layout.stride/Uint32Array.BYTES_PER_ELEMENT,a=this._current.vertexStart,o=e._current.vertexStart-a,s=this._current.writer.indexWriter,c=this._current.writer.vertexWriter,l=e._current.writer.indexWriter,u=e._current.writer.vertexWriter;for(let t=e._current.indexStart;t!==l.length;t++){let e=l.getValue(t);s.push(e-o)}for(let t=e._current.vertexStart*i;t!==u.length;t++){let e=u.getValue(t);c.push(e)}let d=this._current.writer.layout.position,f=d.packPrecisionFactor??1,p=d.offset/Uint32Array.BYTES_PER_ELEMENT,m=t*f,h=n*f;for(let e=a*i;e<=c.length;e+=i)c.i1616Add(e+p,m,h);this.recordEnd()}_getVertexWriter(e,t){let n=this._instanceIdToVertexData;return n.has(e)||n.set(e,new P(e,t,this._sizeHint)),n.get(e)}};function I(e){return`url`in e&&`urlHash`in e?{...e,url:``}:e}var L=class{},R=class extends L{constructor(e){super(),this._fetcher=e,this._controller=new AbortController,this._pendingIds=new Set,this._pendingRequests=[],this._resourceIdToResource=new Map}destroy(){this._controller.abort()}get _abortOptions(){return{signal:this._controller.signal}}enqueueRequest(e){let t=I(e.resource),n=g(JSON.stringify(t));return this._pendingIds.has(n)||(this._pendingIds.add(n),this._pendingRequests.push({...e,resourceId:n})),n}async fetchEnqueuedResources(){let e=this._pendingRequests;if(this._pendingIds.clear(),this._pendingRequests=[],e.length===0)return;let t=await this._fetcher.fetch(e,this._abortOptions);for(let n=0;n<t.length;n++){let r=e[n].resourceId;this._resourceIdToResource.set(r,t[n])}}async fetchResourceImmediate(e){let t=await this._fetcher.fetch([e]);if(t.length!==1)throw Error(`FeaturePipelineResourceProxy: failed to fetch resources`);return t[0]}async fetchDictionaryResourceImmediate(e){let t=await this._fetcher.fetchDictionary([e]);if(t.length!==1)throw Error(`FeaturePipelineResourceProxy: failed to fetch dictionary resources`);return t[0]}getResource(e){return this._resourceIdToResource.get(e)}},z=(e,t)=>e&&((...e)=>t.warn(`DEBUG:`,...e))||(()=>null),B=class{constructor(e){this.data=e,this._referenceCount=0}static{this.estimatedMemory=20}increment(){this._referenceCount+=1}decrement(){--this._referenceCount}empty(){return this._referenceCount===0}},V=class{constructor(){this._freeIdsGenerationA=[],this._freeIdsGenerationB=[],this._idCounter=1,this._freeIds=this._freeIdsGenerationA,this._objectIdToDisplayId=new Map}get usedMemory(){let e=0;return e+=b(this._freeIdsGenerationA),e+=b(this._freeIdsGenerationB),e+=this._objectIdToDisplayId.size*(B.estimatedMemory+8),e}createIdForObjectId(e){let t=this._objectIdToDisplayId.get(e);return t?t.increment():(t=new B(se(this._getFreeId(),!1)),t.increment(),this._objectIdToDisplayId.set(e,t)),t.data}releaseIdForObjectId(e){let t=this._objectIdToDisplayId.get(e);t&&(t.decrement(),t.empty()&&(this._objectIdToDisplayId.delete(e),this._freeIds.push(t.data)))}getDisplayIdForObjectId(e){let t=this._objectIdToDisplayId.get(e);return t==null?null:t.data}releaseAll(){for(let e of this._objectIdToDisplayId.values())this._freeIds.push(e.data);this._objectIdToDisplayId.clear()}incrementGeneration(){this._freeIds=this._freeIds===this._freeIdsGenerationA?this._freeIdsGenerationB:this._freeIdsGenerationA}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}},H=()=>y.getLogger(`esri.views.2d.layers.FeatureLayerView2D`),U={getAttribute:(e,t)=>e.readAttribute(t)};async function W(t,n){try{let r=await ee(t,n);return r.isStandardized||H().error(new e(`sql-parse-error`,`expression is not standardized`,{where:t})),(n,i)=>{let a=n.readArcadeFeature();try{return r.testFeatureCompiled(a,U,i.currentUser)}catch(n){return H().warn(new e(`sql-runtime-error`,`Encountered an error when evaluating where clause`,{where:t,error:n})),!0}}}catch(n){return H().warn(new e(`sql-runtime-error`,`Encountered an error when evaluating where clause`,{where:t,error:n})),e=>!0}}var G=1,ue=2,K=class t{constructor(e){this._geometryBounds=ne(),this._idToVisibility=new Map,this._serviceInfo=e}static async create(e){let n=new t(e);return await n.update(e.filterJSON,e.spatialReference),n}get hash(){return this._hash}check(e,t){return this._applyFilter(e,t)}invalidate(){this._idToVisibility.forEach((e,t)=>{this._idToVisibility.set(t,0)})}setKnownIds(e){for(let t of e)this._idToVisibility.set(t,G)}setTrue(e){let t=[],n=[],r=new Set(e);return this._idToVisibility.forEach((e,i)=>{let a=!!(this._idToVisibility.get(i)&G),o=r.has(i);!a&&o?t.push(i):a&&!o&&n.push(i),this._idToVisibility.set(i,o?G|ue:0)}),{show:t,hide:n}}createQuery(){let{geometry:e,spatialRel:t,where:n,timeExtent:r,objectIds:i}=this;return te.fromJSON({geometry:e,spatialRel:t,where:n,timeExtent:r,objectIds:i})}async update(e,t){this._hash=JSON.stringify(e);let n=await S(e,null,t);await Promise.all([this._setGeometryFilter(n),this._setIdFilter(n),this._setAttributeFilter(n),this._setTimeFilter(n)])}async _setAttributeFilter(e){if(!e?.where)return this._clause=null,void(this.where=null);this._clause=await W(e.where,this._serviceInfo.fieldsIndex),this.where=e.where}_setIdFilter(e){this._idsToShow=e?.objectIds&&new Set(e.objectIds),this._idsToHide=e?.hiddenIds&&new Set(e.hiddenIds),this.objectIds=e?.objectIds}async _setGeometryFilter(e){if(!e?.geometry)return this._spatialQueryOperator=null,this.geometry=null,void(this.spatialRel=null);let t=e.geometry,n=e.spatialRel??`esriSpatialRelIntersects`,r=await ie(n,t,this._serviceInfo.geometryType);u(this._geometryBounds,t),this._spatialQueryOperator=r,this.geometry=t,this.spatialRel=n}_setTimeFilter(t){if(this.timeExtent=this._timeOperator=null,t?.timeExtent){if(!this._serviceInfo.timeInfo){let n=new e(`feature-layer-view:time-filter-not-available`,`Unable to apply time filter, as layer doesn't have time metadata.`,t.timeExtent);y.getLogger(`esri.views.2d.layers.features.controllers.FeatureFilter`).error(n);return}this.timeExtent=t.timeExtent,this._timeOperator=x(this._serviceInfo.timeInfo,t.timeExtent,w.Shared)}}_applyFilter(e,t){return this._filterByGeometry(e)&&this._filterById(e)&&this._filterByTime(e)&&this._filterByExpression(e,t)}_filterByExpression(e,t){return!this.where||this._clause(e,t)}_filterById(e){return(!this._idsToHide?.size||!this._idsToHide.has(e.getObjectId()))&&(!this._idsToShow?.size||this._idsToShow.has(e.getObjectId()))}_filterByGeometry(e){if(!this.geometry)return!0;let t=e.readGeometryWorldSpace();return!!t&&this._spatialQueryOperator(t)}_filterByTime(e){return this._timeOperator==null||this._timeOperator(e)}};function de(e,t){if(!e||!t)return e;switch(t){case`radius`:case`distance`:return 2*e;case`diameter`:case`width`:return e;case`area`:return Math.sqrt(e)}return e}var q=()=>y.getLogger(`esri.views.layers.2d.features.support.AttributeStore`),J=z(!1,q()),fe={sharedArrayBuffer:v(`esri-shared-array-buffer`),atomics:v(`esri-atomics`)},pe=class{constructor(e,t,n){this.size=0,this.texelSize=4,this.dirtyStart=0,this.dirtyEnd=0;let{pixelType:r,layout:i,textureOnly:a}=t;this.textureOnly=a||!1,this.pixelType=r,this.layout=i,this._resetRange(),this.size=e,this.isLocal=n,a||(this.data=this._initData(r,e))}get usedMemory(){return this.data?.byteLength??0}get buffer(){return this.data?.buffer}unsetComponentAllTexels(e,t){let n=this.data;for(let r=0;r<this.size*this.size;r++)n[r*this.texelSize+e]&=~t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(e,t){let n=this.data;for(let r=0;r<this.size*this.size;r++)n[r*this.texelSize+e]|=255&t;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(e,t,n){let r=this.data;for(let i of n)r[i*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,i),this.dirtyEnd=Math.max(this.dirtyEnd,i)}setComponentTexel(e,t,n){this.data[n*this.texelSize+e]|=t,this.dirtyStart=Math.min(this.dirtyStart,n),this.dirtyEnd=Math.max(this.dirtyEnd,n)}unsetComponentTexel(e,t,n){this.data[n*this.texelSize+e]&=~t,this.dirtyStart=Math.min(this.dirtyStart,n),this.dirtyEnd=Math.max(this.dirtyEnd,n)}getData(e,t){let n=A(e);return this.data[n*this.texelSize+t]}setData(e,t,n){let r=A(e),i=1<<t;(this.layout&i)===0?q().error(`mapview-attributes-store`,`Tried to set a value for a texel's readonly component`):this.data!=null&&(this.data[r*this.texelSize+t]=n,this.dirtyStart=Math.min(this.dirtyStart,r),this.dirtyEnd=Math.max(this.dirtyEnd,r))}expand(e){if(this.size=e,!this.textureOnly){let t=this._initData(this.pixelType,e),n=this.data;t.set(n),this.data=t}}toMessage(){let e=this.dirtyStart,t=this.dirtyEnd,n=this.texelSize;if(e>t)return null;this._resetRange();let r=!this.isLocal,i=this.pixelType,a=this.layout,o=this.data;return{start:e,end:t,data:r&&o.slice(e*n,(t+1)*n)||null,pixelType:i,layout:a}}_initData(e,t){let n=ArrayBuffer,r=ae(e),i=new r(new n(t*t*4*r.BYTES_PER_ELEMENT));for(let e=0;e<i.length;e+=4)i[e+1]=255;return i}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}},me=class{constructor(e){this._client=e,this._filters=[],this._blocks=[],this._attributeComputeInfo=null,this._abortController=new AbortController,this._size=256,this._idsToHighlight=new Map,this._arcadeDependencies=new Set,this._initialized=!1,this.version=0,this._idGenerator=new V,this._epoch=1}destroy(){this._abortController.abort()}_initialize(){if(this._blockDescriptors!=null)return;let e=h.FLOAT;J(`Creating AttributeStore ${fe.sharedArrayBuffer?`with`:`without`} shared memory`),this._blockDescriptors=[{pixelType:h.UNSIGNED_BYTE,layout:1},{pixelType:h.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:h.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:e,layout:15},{pixelType:e,layout:15},{pixelType:e,layout:15},{pixelType:e,layout:15},{pixelType:h.FLOAT,layout:15}],this._blocks=this._blockDescriptors.map(()=>null)}get usedMemory(){let e=0;for(let t of this._blocks)t&&(e+=t.usedMemory);return e+=this._idGenerator.usedMemory,e}get hasHighlight(){return this._idsToHighlight.size>0}createDisplayIdForObjectId(e){return this._idGenerator.createIdForObjectId(e)}releaseDisplayIdForObjectId(e){return this._idGenerator.releaseIdForObjectId(e)}getDisplayIdForObjectId(e){return this._idGenerator.getDisplayIdForObjectId(e)}incrementDisplayIdGeneration(){this._idGenerator.incrementGeneration()}hasArcadeDependency(e){return this._arcadeDependencies.has(e)}releaseAllIds(){this._idGenerator.releaseAll()}async update(e,t,n,r=0){let a=i(this._schema,e);if(this.version=r,a&&(v(`esri-2d-update-debug`)&&console.debug(`Version[${r}] AttributeStore.update`,{changed:a}),this._schema=e,this._attributeComputeInfo=null,this._initialize(),e!=null))if(n&&(this._filters=await Promise.all(e.filters.map(e=>e?K.create({geometryType:n.geometryType,hasM:!1,hasZ:!1,timeInfo:n.timeInfo,fieldsIndex:n.fieldsIndex,spatialReference:n.outSpatialReference,filterJSON:e}):null))),e.type!==`multi`)this._attributeComputeInfo={type:`feature`,map:new Map},await Promise.all(e.bindings.map(async e=>{let n=await this._bind(t,e);this._updateReferences(n)}));else for(let n in this._attributeComputeInfo={type:`multi`,keyField:e.keyField,map:new Map},e.bindings){let r=e.bindings[n];await Promise.all(r.map(async e=>{let r=await this._bind(t,e,parseInt(n,10));this._updateReferences(r)}))}}setHighlight(e,t){let n=null;e.length===0&&t.length===0&&(n=this._getBlock(0),n.unsetComponentAllTexels(0,63));for(let{displayId:t,highlightFlags:r}of e){if(t==null||t===-1)continue;n||(n=this._getBlock(0),n.unsetComponentAllTexels(0,63));let e=A(t);n.setComponent(0,r,[e])}this._idsToHighlight.clear();for(let{objectId:t,highlightFlags:n}of e)this._idsToHighlight.set(t,n);for(let{objectId:e,highlightFlags:n}of t)this._idsToHighlight.set(e,n)}setData(e,t,n,r){let i=A(e);this._ensureSizeForTexel(i),this._getBlock(t).setData(e,n,r)}getData(e,t,n){return this._getBlock(t).getData(e,n)}getHighlightFlags(e){return this._idsToHighlight.get(e)||0}unsetAttributeData(e){let t=A(e);this._getBlock(0).setData(t,0,0)}referencesScale(){let e=this._attributeComputeInfo;if(!e)return!1;if(e.type===`multi`){for(let t of e.map.values())for(let{field:e}of t.values())if(e?.hasArcadeDependency(`scale`))return!0}else for(let{field:t}of e.map.values())if(t?.hasArcadeDependency(`scale`))return!0;return!1}setAttributeData(e,t,n,r){let i=A(e);this._ensureSizeForTexel(i),this._getBlock(0).setData(i,0,this.getFilterFlags(t,r));let a=this._attributeComputeInfo,o=null;a&&(o=a.type===`multi`?a.map.get(t.readAttribute(a.keyField)):a.map,o?.size&&o.forEach((e,r)=>{let a=r*1%4,o=Math.floor(r*1/4),s=this._getBlock(o+3),c=e.field?.read(t,n);e.valueRepresentation&&(c=de(c,e.valueRepresentation)),(c===null||isNaN(c)||c===1/0||c===-1/0)&&(c=1e-30),s.setData(i,a,c)}))}get epoch(){return this._epoch}sendUpdates(){let e=this._blocks.map(e=>e==null?null:e.toMessage()),t=this._getInitArgs();v(`esri-2d-log-updating`)&&console.log(`AttributeStore: _doSendUpdate.start`),this._client.update({initArgs:t,blockData:e,version:this.version,sendUpdateEpoch:this._epoch}),this._epoch+=1,v(`esri-2d-log-updating`)&&console.log(`AttributeStore: _doSendUpdate.end`)}_ensureSizeForTexel(e){for(;e>=this._size*this._size;)if(this._expand())return}async _bind(e,t,n){let r=await e.createComputedField(t),{valueRepresentation:i}=t,a=this._attributeComputeInfo;if(a.type===`multi`){let e=a.map.get(n)??new Map;e.set(t.binding,{field:r,valueRepresentation:i}),a.map.set(n,e)}else a.map.set(t.binding,{field:r,valueRepresentation:i});return r}_getInitArgs(){return this._initialized?null:(this._initialized=!0,this._getBlock(1),this._getBlock(2),this._getBlock(7),{blockSize:this._size,blockDescriptors:this._blocks.map(e=>e==null?null:{textureOnly:e.textureOnly,buffer:e.buffer,pixelType:e.pixelType})})}_getBlock(e){let t=this._blocks[e];if(t!=null)return t;J(`Initializing AttributeBlock at index ${e}`);let n=new pe(this._size,this._blockDescriptors[e],this._client.isLocal);return this._blocks[e]=n,this._initialized=!1,n}_expand(){if(this._size<this._schema.capabilities.maxTextureSize){let e=this._size<<=1;J(`Expanding block size to`,e,this._blocks);for(let t of this._blocks)t?.expand(e);return this._initialized=!1,this._size=e,0}return q().error(new e(`mapview-limitations`,`Maximum number of onscreen features exceeded.`)),-1}_updateReferences(e){d(this._arcadeDependencies,e)}isVisible(e){return!!(this._getBlock(0).getData(e,0)&64)}getFilterFlags(e,t){let n=0;for(let r=0;r<this._filters.length;r++){let i=!!(1<<r),a=this._filters[r];n|=(!i||a==null||a.check(e,t)?1:0)<<r}let r=0;if(this._idsToHighlight.size){let t=e.getObjectId();r=this.getHighlightFlags(t)}return n<<6|r}},Y=class{destroy(){}},he=class extends Y{constructor(e){super(),this._field=e}resize(e){throw Error(`Method not implemented.`)}read(e,t){return e.readAttribute(this._field)}readWithDefault(e,t){return e.readAttribute(this._field)}hasArcadeDependency(e){return!1}};function ge(e,t){let n=43758.5453*Math.sin(12.9898*e+78.233*t);return n-Math.floor(n)}var X=class e extends Y{static async create(t,n){let r=await l(t,n.spatialReference),i=g(t);return new e(r,i)}constructor(e,t){super(),this._compiled=e,this._cacheKey=t}resize(e){}read(e,t){return this.hasArcadeDependency(`scale`)||t.$view.timeZone!==`system`?D(this._compiled,e,t):this._readCached(e,t)}readWithDefault(e,t,n){return this.hasArcadeDependency(`scale`)||t.$view.timeZone!==`system`?E(this._compiled,e,t,n):this._readWithDefaultCached(e,t,n)}hasArcadeDependency(e){return this._compiled?.references(e)??!1}_getCacheKey(e){if(!this._compiled?.references(`timeProperties`))return this._cacheKey;let{currentStart:t,currentEnd:n}=e.$view.timeProperties;return this._cacheKey+ge(t??1,n??1)}_readCached(e,t){if(e.setCache(this._getCacheKey(t)),e.hasCachedValue())return e.getCachedValue();let n=D(this._compiled,e,t);return e.setCachedValue(n),n}_readWithDefaultCached(e,t,n){if(e.setCache(this._getCacheKey(t)),e.hasCachedValue())return e.getCachedValue();let r=E(this._compiled,e,t,n);return e.setCachedValue(r),r}};function _e(e,n){if(e==null)return``;let r=n.domain;if(r){if(r.type===`codedValue`||r.type===`coded-value`){let t=e;for(let e of r.codedValues)if(e.code===t)return e.name}else if(r.type===`range`){let{max:t,min:i}=o(n),a=+e;if(i!=null&&t!=null&&i<=a&&a<=t)return r.name}}let i=e;return f(n)?i=p(i,t(`short-date`)):m(n)&&(i=re(+i)),i||``}var ve=class e extends Y{static async create(t,r){let i=n(t);return new e(e=>i.replaceAll(/{[^}]*}/g,t=>{let n=t.slice(1,-1),r=e.metadata.fieldsIndex.get(n);if(r==null)return t;let i=e.readAttribute(n);return i==null?``:_e(i,r)}))}constructor(e){super(),this._evaluator=e}resize(e){}read(e,t){return this._evaluator(e)}readWithDefault(e,t,n){let r=this._evaluator(e);return T(r)?n:r}hasArcadeDependency(e){return!1}},ye=class extends Y{constructor(e,t){super(),this._template=e,this._parts=a(e.template,t)}resize(e){}read(e,t){return _(e,this._parts,this._template.textCase)}readWithDefault(e,t,n){return _(e,this._parts,this._template.textCase)}hasArcadeDependency(e){return!1}},be=class extends Y{constructor(e,t){super(),this._field=e,this._normalizationInfo=t}resize(e){throw Error(`Method not implemented.`)}read(e,t){return this._readNormalized(e)}readWithDefault(e,t){return this._readNormalized(e)}hasArcadeDependency(e){return!1}_readNormalized(e){let t=e.readAttribute(this._field);if(t==null)return null;let{normalizationField:n,normalizationTotal:r,normalizationType:i}=this._normalizationInfo,a=e.readAttribute(n);switch(i??`esriNormalizeByField`){case`esriNormalizeByField`:return a?a?t/a:void 0:null;case`esriNormalizeByLog`:return Math.log(t)*Math.LOG10E;case`esriNormalizeByPercentOfTotal`:return r?t/r*100:null}}},Z=()=>y.getLogger(`esri.views.2d.layers.features.support.ComputedAttributeStorage`),Q=4294967295;function $(e,t,n){if(!(e.length>t))for(;e.length<=t;)e.push(n)}var xe=class{constructor(e){this._numerics=[],this._strings=[],this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[],this._dirtyBitset=this.getBitset(this.createBitset()),this.compilationOptions=e}createBitset(){let e=this._bitsets.length;return this._bitsets.push(C.create(this._allocatedSize,k)),e+1}createDictionaryTemplateField(e,t){return new ye(e,t)}async createComputedField(t,n=!1){if(t.expression)try{if(!this.compilationOptions)throw Error(`InternalError: Compilation options not defined`);return n?await ve.create(t.expression,this.compilationOptions):await X.create(t.expression,this.compilationOptions)}catch(n){let r=new e(`featurelayer`,`Failed to compile arcade expression`,{error:n,expression:t.expression});return Z().error(r),null}if(t.normalizationType||t.normalizationField)return new be(t.field,t);if(t.field)return new he(t.field);let r=new e(`featurelayer`,`Unable to create computed field. No expression or field found`,{info:t});return Z().error(r),null}async createWhereClause(e){return e?W(e,this.compilationOptions.fields):null}getBitset(e){return this._bitsets[e-1]}getComputedNumeric(e,t){return this.getComputedNumericAtIndex(e&k,0)}setComputedNumeric(e,t,n){return this.setComputedNumericAtIndex(e&k,n,0)}getComputedString(e,t){return this.getComputedStringAtIndex(e&k,0)}setComputedString(e,t,n){return this.setComputedStringAtIndex(e&k,0,n)}getComputedNumericAtIndex(e,t){let n=e&k;return this._ensureNumeric(t,n),this._numerics[t][n]}setComputedNumericAtIndex(e,t,n){let r=e&k;this._ensureNumeric(t,r),this._numerics[t][r]=n}getPackedChunkId(e){let t=e&k;return this._ensureInstanceId(t),this._instanceIds[t]}setPackedChunkId(e,t){let n=e&k;this._ensureInstanceId(n),this._instanceIds[n]=t}getComputedStringAtIndex(e,t){let n=e&k;return this._ensureString(t,n),this._strings[t][n]}setComputedStringAtIndex(e,t,n){let r=e&k;this._ensureString(t,r),this._strings[t][r]=n}getXMin(e){return this._bounds[4*(e&k)]}getYMin(e){return this._bounds[4*(e&k)+1]}getXMax(e){return this._bounds[4*(e&k)+2]}getYMax(e){return this._bounds[4*(e&k)+3]}setBounds(e,t,n=!1){let r=e&k;if(!n&&!this._dirtyBitset.has(e))return this._bounds[4*r]!==Q;this._dirtyBitset.unset(e);let i=t.readGeometryWorldSpace();if($(this._bounds,4*r+4,0),!i||!i.coords.length)return this._bounds[4*r]=Q,this._bounds[4*r+1]=Q,this._bounds[4*r+2]=Q,this._bounds[4*r+3]=Q,!1;let a=1/0,o=1/0,s=-1/0,c=-1/0;return i.forEachVertex((e,t)=>{a=Math.min(a,e),o=Math.min(o,t),s=Math.max(s,e),c=Math.max(c,t)}),this._bounds[4*r]=a,this._bounds[4*r+1]=o,this._bounds[4*r+2]=s,this._bounds[4*r+3]=c,!0}getBounds(e,t){let n=this.getXMin(t),i=this.getYMin(t),a=this.getXMax(t),o=this.getYMax(t);return r(e,n,i,a,o),n!==Q}_ensureNumeric(e,t){this._numerics[e]||(this._numerics[e]=[]),$(this._numerics[e],t,0)}_ensureInstanceId(e){$(this._instanceIds,e,0)}_ensureString(e,t){this._strings[e]||(this._strings[e]=[]),$(this._strings[e],t,null)}};export{R as a,K as i,Y as n,I as o,me as r,F as s,xe as t};