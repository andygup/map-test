import{Aw as e,BT as t,Ld as n,Od as r,VT as i,Vd as a,dT as o,dv as s,kD as c,ng as l,pv as u,sD as d,tT as f,wg as p}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import{n as m}from"./measures-DjCw0e_k.js";import"./closestPointOnCurve-CwZL45U3.js";import"./Point2D-DJueHbCy.js";import"./Envelope2D-B7gkUj4e.js";import"./SpatialReference-CfUjvF_j.js";import"./Transformation2D-D07KwcEj.js";import"./SimpleGeometryCursor-BILtMaQf.js";import"./OperatorDefinitions-C5Pat-Jx.js";import"./OperatorProximity-0Hb8DnmN.js";import"./jsonConverter-CoA5-zxu.js";import"./FlatGeometry-BsPiiSVP.js";import"./apiConverter-Dsm0pxcs.js";import"./geodeticCurveType-CcdKHJt5.js";import"./geodeticAreaOperator-B2LzXjd-.js";import"./geodeticLengthOperator-BdZS0ajo.js";import"./Distance2DCalculator-CXhBP-8I-CYkwuMp9.js";import{n as h}from"./distanceOperator-Cfhn9VMw.js";import{t as g}from"./proximityOperator-DOGTxDst.js";import"./quatf64-D37SEdPg.js";import"./earcut-CEMcWA4Z.js";import"./plane-Da5EsY0J.js";import"./vectorStacks-Cuo89CNO.js";import"./projectPointToVector-BkRdoTqD.js";import"./spatialReferenceEllipsoidUtils-qw9wv8RL.js";import"./projectionZScaling-C8xhU_hX.js";import{i as _,r as v}from"./projectOperator-DWqbOm71.js";import"./dehydratedPoint-CWZQBefp.js";import"./projectVectorToVector-DGzn2p7I.js";import"./memoize-Dl61_jt0.js";import"./elevationInfoUtils-uoMH3ofe.js";import{s as y}from"./colorUtils-CzajW9E7.js";import{t as b}from"./GraphicsLayer-DBcl42yN.js";import"./networkEnums-DSwvS-2R.js";import"./ObjectStack-l5kM7JZu.js";import"./ray-LkJ58wpZ.js";import{i as x,n as S,r as C,t as w}from"./Stop-DH13WZls.js";import"./quantity-Co6flzuS.js";import"./geodesicUtils-D99LxQ6q.js";import{t as T}from"./SketchViewModel-BUSTPGCt.js";import"./isSupportedObject-CnaOA-Ng.js";import"./layerUtils-BZgsYerz.js";import"./SketchOptions-DjwJVzbR.js";import"./LineSnappingHint-CmFAetWF.js";import"./ParallelSnappingHint-CVYaPm-q.js";import"./snappingUtils-D3oTIKrZ.js";import"./vec3-B94Y7ih2.js";import"./sphere-d9-4vNcj.js";import"./constraints-Ch5tsKD8.js";import"./SnappingCandidate-DueCLuvH.js";import"./EdgeSnappingCandidate-CCg5Xb97.js";import"./DrapedEdgeSnappingCandidate-CqXt8QLN.js";import"./IntersectionSnappingHint-CvQZ8eWi.js";import"./IntersectionSnappingCandidate-C2uVyhEk.js";import"./LineSnappingCandidate-BNbhbOGH.js";import"./RightAngleTriangleSnappingCandidate-CqVuCsko.js";import"./RightAngleSnappingHint-tXLlHR_t.js";import"./viewUtils-GR2hLWLo.js";import"./viewUtils-H4dpIyqQ.js";import"./euclideanLengthMeasurementUtils-CvEUUrXw.js";import"./lineSegment-BudcKS0C.js";import"./triangle-46ad8nAb.js";import"./hitTestSelectUtils-DrV1belT.js";var E=Symbol(),D=20,O=class extends e{constructor(e){super(e),this._graphicsLayer=new b({listMode:`hide`,internal:!0}),this._updatingHandles=new p,this._debouncedHandleClick=f(async e=>{let t=this._graphicsLayer.graphics.at(0);if(t?.geometry?.type!==`point`)return;e.stopPropagation();let n=new w({geometry:t.geometry.clone(),locationType:`waypoint`,symbol:this.waypointSymbol.clone()}),r=await this._getWaypointIndex(n);this.interaction.layer.stops.add(n,r),this.interaction.layer.stops.forEach(e=>e.sequence=null),this.interaction.addNetworkFeature(n)}),this._debouncedHandlePointerMove=f(async e=>{if(!this.interaction.enabled||this.interaction.sketchActive||this.interaction.layer.stops.length<2||!this.interaction.layer.routeInfo?.geometry)return void this._clearWaypointManipulator();let{spatialReference:t}=this.view;await _();let n=v(this.interaction.layer.routeInfo?.geometry,t);if(!n)return void this._clearWaypointManipulator();let i=this.view.resolution*window.devicePixelRatio*D,{coordinate:a,distance:o,isEmpty:s}=g(n,this.view.toMap(e));if(s||o>i||this.interaction.layer.stops.map(({geometry:e})=>e).filter(d).map(e=>v(e,t)).filter(d).some(e=>h(e,a)<i))return void this._clearWaypointManipulator();this.addHandles(this.view.acquireCursor(`pointer`,`high`),E);let c=this._graphicsLayer.graphics.at(0);if(c)return void(c.geometry=a);let{waypointSymbol:l}=this,u=new r({geometry:a,symbol:l});this._graphicsLayer.graphics.destroyAll(),this._graphicsLayer.add(u)})}initialize(){this.view.map?.add(this._graphicsLayer),this._updatingHandles.add(()=>({enabled:this.interaction.enabled,graphic:this._graphicsLayer.graphics.at(0),symbol:this.waypointSymbol}),({enabled:e,graphic:t,symbol:n})=>{e?t&&(t.symbol=n):this._clearWaypointManipulator()},s),this.addHandles([this.view.on(`click`,e=>this._debouncedHandleClick(e).catch(o),l.TOOL),this.view.on(`pointer-move`,e=>this._debouncedHandlePointerMove(e).catch(o),l.TOOL)])}destroy(){this._graphicsLayer.removeFromParent(),this._graphicsLayer.graphics.destroyAll(),this._graphicsLayer.destroy(),this._updatingHandles.destroy()}get updating(){return!this._graphicsLayer.loaded||this._updatingHandles.updating}get waypointSymbol(){let e=this.interaction.layer.defaultSymbols.stops?.waypoint;if(e)return e;let{accentColor:t}=this.view.effectiveTheme;return new n({color:t,outline:new a({color:y(t),width:1.5}),size:10})}_clearWaypointManipulator(){this._graphicsLayer.graphics.destroyAll(),this.removeHandles(E)}async _getWaypointIndex(e){let{routeInfo:t,stops:n}=this.interaction.layer;if(n.length===2||!t?.geometry||!e.geometry)return 1;let{spatialReference:r}=this.view;await _();let i=v(t.geometry,r),a=v(e.geometry,r);if(!i||!a)return 1;let o=m(i,a)?.distanceAlong;if(!o)return 1;for(let e=1;e<n.length;e++){let t=n.at(e)?.geometry;if(!t)continue;let a=v(t,r);if(!a)continue;let s=m(i,a)?.distanceAlong;if(s!=null&&s>o)return e}return n.length-1}};c([t()],O.prototype,`interaction`,void 0),c([t()],O.prototype,`updating`,null),c([t()],O.prototype,`waypointSymbol`,null),c([t()],O.prototype,`view`,void 0),O=c([i(`esri.views.2d.layers.support.RouteLayerWaypointVisualization`)],O);function k(e,t){e.networkFeature=t}function A(e){let t=M(e.graphic);return{...e,networkFeature:t}}function j(e){let t=e.graphics.map(e=>M(e));return{...e,networkFeatures:t}}function M(e){return e.networkFeature}function N(e){return e?.type===`point`||e?.type===`polyline`||e?.type===`polygon`}var P=class extends e{constructor(e){super(e),this._createMode=null,this._graphicsLayer=new b({internal:!0,listMode:`hide`}),this._sketchViewModel=new T({layer:this._graphicsLayer}),this._updatingHandles=new p,this.enabled=!0,this._handleSketchViewModelEvents=async e=>{switch(e.type){case`update`:switch(e.state){case`active`:case`complete`:for(let t of e.graphics)M(t).geometry=N(t.geometry)?t.geometry.clone():null}break;case`undo`:case`redo`:break;case`delete`:for(let t of e.graphics){let e=M(t);this._removeNetworkFeature(e)}break;case`create`:if(e.graphic&&e.state===`complete`&&this._createMode){let t=e.graphic.geometry?.clone(),n=e.graphic.symbol?.clone();if(!t)break;switch(this._createMode){case`stop`:{if(t.type!==`point`)break;let{stops:n}=this.layer;if(n.length>0&&n.every(({geometry:e})=>!e)){n.at(0).geometry=t;break}if(n.length>1&&n.filter((e,t)=>t!==0).every(({geometry:e})=>!e)){n.at(1).geometry=t;break}let r=new w({geometry:t});n.add(r),k(e.graphic,r);break}case`point-barrier`:{if(t.type!==`point`)break;let r=new x({geometry:t,symbol:n});this.layer.pointBarriers.add(r),k(e.graphic,r);break}case`polyline-barrier`:{if(t.type!==`polyline`)break;let r=new S({geometry:t,symbol:n});this.layer.polylineBarriers.add(r),k(e.graphic,r);break}case`polygon-barrier`:{if(t.type!==`polygon`)break;let r=new C({geometry:t,symbol:n});this.layer.polygonBarriers.add(r),k(e.graphic,r);break}}}}(await this.view.whenLayerView(this.layer)).emit(e.type,e.type===`create`?A(e):j(e))}}initialize(){this._sketchViewModel.view=this.view,this.addHandles([u(()=>this.enabled,e=>{e?this._activate():this._deactivate()},s),u(()=>{let{stops:e,pointBarriers:t,polylineBarriers:n,polygonBarriers:r}=this.layer;return{stops:e,pointBarriers:t,polylineBarriers:n,polygonBarriers:r}},()=>{this.enabled&&this._loadClonedGraphics()}),this._sketchViewModel.on([`create`,`delete`,`redo`,`undo`,`update`],this._handleSketchViewModelEvents)]),this._routeLayerWaypointVisualization=new O({view:this.view,interaction:this})}destroy(){this._graphicsLayer.removeFromParent(),this._graphicsLayer.graphics.destroyAll(),this._graphicsLayer.destroy(),this._routeLayerWaypointVisualization?.destroy(),this._sketchViewModel.destroy(),this._updatingHandles.destroy()}get selectedNetworkFeatures(){return this._sketchViewModel.updateGraphics.map(e=>M(e))}get sketchActive(){return!!this._sketchViewModel.activeTool}get updating(){return(this._routeLayerWaypointVisualization?.updating??!0)||this._sketchViewModel.updating||this._updatingHandles.updating}addNetworkFeature(e){let t=e.toGraphic();this._graphicsLayer.add(t),k(t,e),this._sketchViewModel.update(t)}async create(e){if(this.enabled){switch(this._createMode=e,e){case`stop`:this.layer.defaultSymbols.stops?.unlocated&&(this._sketchViewModel.pointSymbol=this.layer.defaultSymbols.stops.unlocated.clone());break;case`point-barrier`:this.layer.defaultSymbols.pointBarriers&&(this._sketchViewModel.pointSymbol=this.layer.defaultSymbols.pointBarriers.clone());break;case`polyline-barrier`:this.layer.defaultSymbols.polylineBarriers&&(this._sketchViewModel.polylineSymbol=this.layer.defaultSymbols.polylineBarriers.clone());break;case`polygon-barrier`:this.layer.defaultSymbols.polygonBarriers&&(this._sketchViewModel.polygonSymbol=this.layer.defaultSymbols.polygonBarriers.clone())}switch(e){case`stop`:case`point-barrier`:return this._sketchViewModel.create(`point`);case`polyline-barrier`:return this._sketchViewModel.create(`polyline`);case`polygon-barrier`:return this._sketchViewModel.create(`polygon`)}}}delete(){for(let e of this.selectedNetworkFeatures)this.remove(e)}remove(e){let t=this._graphicsLayer.graphics.find(t=>M(t)===e);t&&(this._graphicsLayer.remove(t),this._removeNetworkFeature(e))}_activate(){this._loadClonedGraphics(),this.view.map.add(this._graphicsLayer)}_deactivate(){this._sketchViewModel.cancel(),this._graphicsLayer.removeFromParent(),this._graphicsLayer.graphics.destroyAll()}_loadClonedGraphics(){let e=[this.layer.stops,this.layer.pointBarriers,this.layer.polylineBarriers,this.layer.polygonBarriers].flatMap(e=>e.toArray().map(e=>{let t=e.toGraphic();return t.networkFeature=e,t}));this._graphicsLayer.graphics.destroyAll(),this._graphicsLayer.addMany(e)}_removeNetworkFeature(e){switch(e.type){case`stop`:this.layer.stops.remove(e);break;case`point-barrier`:this.layer.pointBarriers.remove(e);break;case`polyline-barrier`:this.layer.polylineBarriers.remove(e);break;case`polygon-barrier`:this.layer.polygonBarriers.remove(e)}}};c([t()],P.prototype,`_routeLayerWaypointVisualization`,void 0),c([t()],P.prototype,`enabled`,void 0),c([t({constructOnly:!0})],P.prototype,`layer`,void 0),c([t({readOnly:!0})],P.prototype,`selectedNetworkFeatures`,null),c([t()],P.prototype,`sketchActive`,null),c([t()],P.prototype,`updating`,null),c([t({constructOnly:!0})],P.prototype,`view`,void 0),P=c([i(`esri.views.2d.layers.support.RouteLayerInteraction`)],P);export{P as RouteLayerInteraction};