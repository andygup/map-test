import{aE as h,aF as d,aL as H,b2 as le,$ as nt,bS as pr,tW as dr,x as gr,b9 as M,b6 as ai,aq as F,tU as Ya,mB as Wa,tX as _r,ht as mr,hi as Go,rv as vr,gP as Zt,kj as qa,kl as ni,mM as fr,kk as Ke,tY as f,pB as br,oE as yr,cL as Mr,cA as re,au as oe,tZ as Sr,pb as Qa,hl as Nt,t_ as Uo,cd as x,cf as N,jG as D,c6 as zi,cw as lt,cG as ut,d9 as $,t6 as ci,pW as xe,fK as G,cS as xr,ho as T,t$ as Li,d3 as Ue,ck as vt,sY as Bo,jg as He,a8 as Hi,oS as hi,mW as wr,cM as W,hk as vn,dE as $a,ty as ki,e6 as ui,tl as Aa,px as fn,jI as mt,u0 as bn,u1 as Zo,jl as ne,cX as It,u2 as Or,u3 as Er,u4 as Tr,u5 as pa,fd as ke,hn as Y,cI as $r,Y as J,_ as Ja,th as Ar,u6 as Xo,j9 as it,u7 as Ir,u8 as Rr,jK as yn,hf as Dr,pl as jr,jH as Yo,go as et,pg as Pr,u9 as Mn,gO as Ne,ba as j,tV as rt,b4 as V,mN as Cr,gx as zr,ua as Lr,fJ as pi,hh as Ni,j7 as Ki,ub as Ia,nP as Sn,d8 as Hr,hp as bi,bm as se,uc as K,b1 as Vt,te as Ra,hm as kr,dB as xn,dC as wn,pZ as Ve,tz as Fe,ea as De,ti as Nr,hK as On,ud as En,jm as Wo,ue as Vr,bn as Fr,tJ as Da,uf as Gr,ug as Ur,uh as S,sZ as Br,dH as Yt,oG as Zr,ui as Xr,uj as Yr,sU as ja,dM as Wr,uk as Ka,ul as qo,gw as Vi,bx as qr,um as Qo,dt as Qr,un as Jr,e9 as Kr,uo as Jo,pp as Tn,ph as Ko,da as Mt,cF as St,hq as Be,up as tl,l5 as di,gX as ta,jb as tt,uq as ts,n1 as es,ur as Fi,us as is,cj as el,hN as Ft,nu as Pa,sW as as,sQ as il,ut as al,al as ns,db as xt,bb as nl,hA as ce,b3 as ea,uu as ol,uv as sl,bg as os,po as rl,uw as ss,l7 as rs,ux as ll,pN as cl,uy as hl,ru as ul,o_ as Gi,bk as ls,f as pl,uz as $n,dF as dl,fv as gl,uA as An,aK as _l,jr as ml,cC as gi,sz as vl,p5 as da,pD as fl,nv as In,uB as bl,cg as oi,uC as yl,ji as Rn,uD as Dn,jp as Ml,bR as Sl,kB as xl,dP as jn,ky as Pn,kz as Cn,aM as wl,tv as Ol,uE as zn,oL as Ln,uF as Hn,sV as El,mA as _i,lV as si,e7 as Tl,pt as $l,hH as fe,cN as Al}from"./index-C5AN6gIb.js";import{u as cs,x as Il,R as Rl,r as he,h as yi,y as hs,m as Ui,c as us,g as Dl}from"./Tooltip-BWAq0e_r.js";import{t as ps,a as jl,G as ia,M as Pl,j as Oe,w as we,c as Ca}from"./Laserlines.glsl-DEL4_FNC.js";import{r as Cl}from"./vec4f32-CjrfB-0a.js";import{z as Wt,m as ds,t as za,g as Ht,d as gs,C as _s,O as ms,j as aa,o as Mi,k as zl,b as La,u as Ll,s as ti,q as Hl,v as ga,w as Bi,x as vs,y as kl,A as Nl,B as Ha,D as fs}from"./OverlayCompositing.glsl-DsnZPVOs.js";import{a as Vl,u as Fl,Q as Gl,o as Ul,d as Dt,b as ka,c as Bl,e as Zl,f as Xl}from"./ColorMaterial.glsl-CD6ejSSs.js";import{X as bs,f as Yl,l as Zi,o as tn,P as ys,A as Ms,x as en,b as Xi,a8 as Wl,z as Ss,e as ql,j as wt,B as Ql,i as k,k as xs,C as an,D as nn,E as Jl,F as ws,H as Os,I as Es,O as Kl,U as on,V as be,t as tc,a7 as ec,s as ic,a9 as ac,G as nc,J as oc,K as sc,L as rc,ab as lc,ac as cc}from"./IntegerPassUniform-D4i1Uds1.js";import{r as hc,k as Na,T as Ts,V as $s,a as jt,R as uc,G as sn,e as Yi,E as rn,Z as kn,Y as pc,u as As,h as Is,x as dc,F as gc,b as Rs}from"./SnappingContext-DyM9dOsy.js";import{t as Nn}from"./DoubleArray-Bc_s-eRk.js";import{i as _c,y as mc}from"./BufferView-CNNe45YH.js";import{H as vc}from"./InterleavedLayout-Bq7Nk9sY.js";import{o as yt,f as _a,h as Vn,i as xi}from"./NormalAttribute.glsl-BsjrRndr.js";import{e as Ds,c as Fn,E as fc,b as bc,u as yc,i as Mc,j as Sc,A as xc}from"./VertexColor.glsl-BV8edxDv.js";import{s as js}from"./Util-DZ-J3OpH.js";import{O as ji,R as je}from"./enums-BlUEVwJR.js";import{S as ln,h as Ps,o as Cs,_ as cn,l as wc,s as Oc}from"./renderState-Clz7MxYz.js";import{E as Ec,F as Tc,a as $c,l as Ac,e as Ic,w as na,f as Rc,g as Dc,p as Pt,M as ri,m as jc,j as Ze,v as Pe,n as oa,S as Pc,z as Cc,i as Wi,D as Gn,U as zc,d as Lc,k as Hc,c as kc}from"./editPlaneUtils-DGDWT6Mq.js";import{x as Un,k as Nc,u as Vc}from"./hydratedFeatures-CMrptU6P.js";import{i as zs,p as Fc}from"./SelectedVertexTooltipInfo-CgNtL8iw.js";import{i as hn}from"./TranslateTooltipInfo-ob1DrpZt.js";import{y as Gc,z as Uc}from"./axisAngleDegrees-Bq-bfGg9.js";import{j as Ye}from"./persistable-BNHBAgp6.js";import"./Octree-CyDSDobB.js";import"./Indices-BRKmhTP5.js";import"./triangle-BDxswaYW.js";import{s as Bc,o as Zc,i as Xc}from"./ExtentScaleTooltipInfo-DhXR2bTg.js";import{a as Yc}from"./meshVertexSpaceUtils-CUbXRTTC.js";import{S as Wc}from"./GraphicManipulator-CN-1TMAN.js";import"./BindType-BmZEZMMh.js";import"./glUtil-C6KhMg1m.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./BufferObject-KHYTZLM-.js";import"./Texture-CTKIRDMu.js";import"./vec3f32-nZdmKIgz.js";import"./triangulationUtils-CsU-mkhu.js";import"./earcut-h7wdVcTx.js";import"./deduplicate-Bon-NhLh.js";import"./NestedMap-DgiGbX8E.js";import"./VertexArrayObject-itGszRJk.js";import"./floatRGBA-Ca01y9H_.js";import"./doublePrecisionUtils-B0owpBza.js";import"./requestImageUtils-CvlvwEvR.js";import"./PointSnappingHint-DjYXgixC.js";import"./MeshTransform-XUwO-bLO.js";import"./types-D0PSWh4d.js";import"./helpMessageUtils3d-ChbE8t4G.js";import"./multiOriginJSONSupportUtils-C0wm8_Yw.js";import"./resourceExtension-CvC0KOtE.js";import"./MeshLocalVertexSpace-CTAY8X8I.js";let qc=i=>({vnodeSelector:"",properties:void 0,children:void 0,text:i.toString(),domNode:null}),Ls=(i,t,e)=>{for(let a=0,n=t.length;a<n;a++){let o=t[a];Array.isArray(o)?Ls(i,o,e):o!=null&&o!==!1&&(typeof o=="string"&&(o=qc(o)),e.push(o))}};function Qc(i,t,e){if(Array.isArray(t))e=t,t=void 0;else if(t&&(typeof t=="string"||t.hasOwnProperty("vnodeSelector"))||e&&(typeof e=="string"||e.hasOwnProperty("vnodeSelector")))throw new Error("h called with invalid arguments");let a,n;return e&&e.length===1&&typeof e[0]=="string"?a=e[0]:e&&(n=[],Ls(i,e,n),n.length===0&&(n=void 0)),{vnodeSelector:i,properties:t,children:n,text:a===""?void 0:a,domNode:null}}const Bn={bottom:"esri-text-overlay-item-anchor-bottom","bottom-right":"esri-text-overlay-item-anchor-bottom-right","bottom-left":"esri-text-overlay-item-anchor-bottom-left",top:"esri-text-overlay-item-anchor-top","top-right":"esri-text-overlay-item-anchor-top-right","top-left":"esri-text-overlay-item-anchor-top-left",center:"esri-text-overlay-item-anchor-center",right:"esri-text-overlay-item-anchor-right",left:"esri-text-overlay-item-anchor-left"};let Q=class extends le{get position(){return[this.x,this.y]}set position(t){this._set("x",t[0]),this._set("y",t[1])}get _textShadowColor(){const{textColor:t,backgroundColor:e}=this,a=e.clone();return a.a*=t.a,a}get _textShadow(){const t=this._textShadowColor.toCss(!0);return`0 0 ${this._textShadowSize}px ${t}`}get padding(){return .5*this.fontSize}get _borderRadius(){return this.padding}constructor(t){super(t),this.x=0,this.y=0,this.text="-",this.fontSize=14,this.anchor="center",this.visible=!0,this.isDecoration=!0,this.backgroundColor=new nt([0,0,0,.6]),this.textColor=new nt([255,255,255]),this._textShadowSize=1}render(){return Qc("div",{classes:this._cssClasses(),styles:{left:Math.floor(this.x)+"px",top:Math.floor(this.y)+"px",visibility:this.visible?"visible":"hidden",fontSize:this.fontSize+"px",lineHeight:this.fontSize+"px",backgroundColor:this.backgroundColor.toCss(!0),color:this.textColor.toCss(!0),padding:this.padding+"px",borderRadius:this._borderRadius+"px",textShadow:this._textShadow}},[this.text])}renderCanvas(t){if(!this.visible)return;const e=t.font.replace(/^(.*?)px/,"");t.font=`${this.fontSize}px ${e}`;const a=this.padding,n=this._borderRadius,o=t.measureText(this.text).width,s=this.fontSize,r=Jc[this.anchor];t.textAlign="center",t.textBaseline="middle";const l=o+2*a,c=s+2*a,p=this.x+r.x*l,u=this.y+r.y*c;this._roundedRect(t,p,u,l,c,n),t.fillStyle=this.backgroundColor.toCss(!0),t.fill();const g=this.x+(r.x+.5)*l,_=this.y+(r.y+.5)*c;this._renderTextShadow(t,this.text,g,_),t.fillStyle=this.textColor.toCss(!0),t.fillText(this.text,g,_)}_renderTextShadow(t,e,a,n){t.lineJoin="miter",t.fillStyle=`rgba(${this._textShadowColor.r}, ${this._textShadowColor.g}, ${this._textShadowColor.b}, ${1/Va.length})`;const o=this._textShadowSize;for(const[s,r]of Va)t.fillText(e,a+o*s,n+o*r)}_roundedRect(t,e,a,n,o,s){t.beginPath(),t.moveTo(e,a+s),t.arcTo(e,a,e+s,a,s),t.lineTo(e+n-s,a),t.arcTo(e+n,a,e+n,a+s,s),t.lineTo(e+n,a+o-s),t.arcTo(e+n,a+o,e+n-s,a+o,s),t.lineTo(e+s,a+o),t.arcTo(e,a+o,e,a+o-s,s),t.closePath()}_cssClasses(){const t={"esri-text-overlay-item":!0};let e;for(e in Bn)t[Bn[e]]=this.anchor===e;return t}};h([d()],Q.prototype,"x",void 0),h([d()],Q.prototype,"y",void 0),h([d()],Q.prototype,"position",null),h([d()],Q.prototype,"text",void 0),h([d()],Q.prototype,"fontSize",void 0),h([d()],Q.prototype,"anchor",void 0),h([d()],Q.prototype,"visible",void 0),h([d()],Q.prototype,"isDecoration",void 0),h([d()],Q.prototype,"backgroundColor",void 0),h([d()],Q.prototype,"textColor",void 0),h([d()],Q.prototype,"_textShadowSize",void 0),h([d()],Q.prototype,"_textShadowColor",null),h([d()],Q.prototype,"_textShadow",null),h([d()],Q.prototype,"padding",null),h([d()],Q.prototype,"_borderRadius",null),Q=h([H("esri.views.overlay.TextOverlayItem")],Q);const Jc={bottom:{x:-.5,y:-1,textAlign:"center",textBaseline:"bottom"},"bottom-left":{x:0,y:-1,textAlign:"left",textBaseline:"bottom"},"bottom-right":{x:-1,y:-1,textAlign:"right",textBaseline:"bottom"},center:{x:-.5,y:-.5,textAlign:"center",textBaseline:"middle"},left:{x:0,y:-.5,textAlign:"left",textBaseline:"middle"},right:{x:-1,y:-.5,textAlign:"right",textBaseline:"middle"},top:{x:-.5,y:0,textAlign:"center",textBaseline:"top"},"top-left":{x:0,y:0,textAlign:"left",textBaseline:"top"},"top-right":{x:-1,y:0,textAlign:"right",textBaseline:"top"}},Va=[];for(let t=0;t<360;t+=360/16)Va.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)]);const Kc=Q,th=3025,eh={default:15,far:25};let Et=class extends le{constructor(t){super(t),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance="default",this._messagesUnits=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){const t=pr(async e=>{const a=await dr("esri/core/t9n/Units");gr(e),this._messagesUnits=a});this.addHandles([M(()=>[this.context!=null&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),...["vertex-add","vertex-update","vertex-remove"].map(e=>ai(()=>{var a;return(a=this.context)==null?void 0:a.editGeometryOperations},e,()=>this._update())),F(()=>t.abort()),M(()=>this._colors,e=>this._updateStyle(e))])}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return this._messagesUnits==null}get test(){}get _edgeDistancePixels(){return eh[this.edgeDistance]}get _colors(){var e;const t=((e=this.context)==null?void 0:e.view.effectiveTheme.textColor)??nt.fromArray([255,255,255]);return{textColor:t,backgroundColor:Ya(Wa(t,_r.Low),.6)}}_update(){if(this.destroyed)return;this._nextLabelIndex=0;const{context:t,stagedVertex:e}=this;if(!t)return this._destroyUnusedLabels();const{editGeometryOperations:a}=t,{components:n,geometry:o,coordinateHelper:s}=a.data;if(!o)return this._destroyUnusedLabels();const r=n.length;for(let l=0;l<r;++l){const c=ih(o,a,e,s,l);if(c.length<2||!ah(c,t.view,t.elevationInfo,s.spatialReference))continue;const p=r===1&&!mr(c);let u=oh,g=sh;this.toScreenPointArray(t,c[0],u);for(let _=1;_<c.length;++_){const m=c[_-1],v=c[_];this.toScreenPointArray(t,v,g),this._addLabel(t,m,u,v,g,p),[u,g]=[g,u]}}this._destroyUnusedLabels()}_updateStyle({textColor:t,backgroundColor:e}){const a=this._nextLabelIndex,n=this._labelInfos;for(let o=0;o<a;++o){const{label:s}=n[o];s.textColor=t,s.backgroundColor=e}}_addLabel(t,e,a,n,o,s){const{label:r}=this._getOrCreateLabel(t);if(!this.visible||Go(a,o)<th)return void(r.visible=!1);const{spatialReference:l}=t.editGeometryOperations.data,c=cs(e,n,l),p=this._messagesUnits,u=vr(t.view);r.text=p!=null&&c!=null?Il(p,c,u):"",r.visible=!0;const g=o[0]-a[0],_=o[1]-a[1];s?Zt(Ot,-_,g):Zt(Ot,_,-g),qa(Ot,Ot),ni(Ot,Ot,this._edgeDistancePixels),fr(We,a,o,.5),Ke(We,We,Ot),r.position=[We[0],We[1]],Math.abs(Ot[0])>Math.abs(Ot[1])?r.anchor=Ot[0]>0?"left":"right":r.anchor=-Ot[1]<0?"top":"bottom"}_getOrCreateLabel(t){var r;const e=this._labelInfos.length>this._nextLabelIndex,{textColor:a,backgroundColor:n}=this._colors;if(e){const l=this._labelInfos[this._nextLabelIndex++],{label:c}=l;return c.textColor=a,c.backgroundColor=n,l}const o=new Kc({anchor:"center",fontSize:8,textColor:a,backgroundColor:n});(r=t.view.overlay)==null||r.items.add(o);const s={label:o};return this._labelInfos.push(s),this._nextLabelIndex=this._labelInfos.length,s}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:t}){var e,a;(a=(e=this.context)==null?void 0:e.view.overlay)==null||a.items.remove(t),t.destroy()}};function ih(i,t,e,a,n){const o=[];if(t.data.components[n].iterateVertices(l=>{o.push(a.toXYZ(l.pos,f.get()))}),n===0&&e!=null&&o.push(a.toXYZ(e,f.get())),o.length<2)return o;const s=o[0],r=o[o.length-1];return i.type==="polygon"&&o.length>2&&!br(s,r)&&o.push(s),o}function ah(i,t,e,a){if(t.type==="2d")return!0;const n=yr(a)??1,o=Mr(a),s=r=>Sr(t,r,a,e,Qa)??0;for(let r=1;r<i.length;++r){const l=i[r-1],c=i[r],p=(c[0]-l[0])*n,u=(c[1]-l[1])*n,g=(s(c)-s(l))*o;if(Math.abs(g)/Math.sqrt(p*p+u*u)>nh)return!1}return!0}h([d()],Et.prototype,"context",void 0),h([d()],Et.prototype,"stagedVertex",void 0),h([d()],Et.prototype,"visible",void 0),h([d()],Et.prototype,"edgeDistance",void 0),h([d()],Et.prototype,"updating",null),h([d()],Et.prototype,"_messagesUnits",void 0),h([d()],Et.prototype,"_edgeDistancePixels",null),h([d()],Et.prototype,"_colors",null),Et=h([H("esri.views.interactive.SegmentLabels")],Et);const nh=re(5),Ot=oe(),We=oe(),oh=Nt(),sh=Nt();let qi=class extends Et{getCameraOrExtent({view:t}){return t.state.camera}toScreenPointArray({view:t,elevationInfo:e,editGeometryOperations:a},n,o=Nt()){const{spatialReference:s}=a.data.coordinateHelper;return Uo(n,s,e,t,Zn),t.state.camera.projectToScreen(Zn,o),o}};qi=h([H("esri.views.3d.interactive.SegmentLabels3D")],qi);const Zn=x();let rh=class extends ps{constructor(t){super(t),this._location=x(),this._direction=N(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=Cl(1,0,1,1),this._renderOccluded=D.OccludeAndTransparent,this.applyProperties(t)}createObject3DResourceFactory(t){return{view:t,createResources:e=>this._createObject3DResources(e),destroyResources:lh,recreateGeometry:(e,a)=>this._recreateObject3DGeometry(e,a),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(t){return{view:t,createResources:()=>this._createDrapedResources(),destroyResources:ch,recreateGeometry:e=>this._recreateDrapedGeometry(e)}}get location(){return this._location}set location(t){zi(this._location,t)||(lt(this._location,t),this._updateGeometry())}get direction(){return this._direction}set direction(t){zi(this._direction,t)||(lt(this._direction,t),this._updateGeometry())}setDirectionFromPoints(t,e){ut(this._direction,$(this._direction,e,t)),this._updateGeometry()}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this._updateMaterial())}get offset(){return this._offset}set offset(t){t!==this._offset&&(this._offset=t,this._updateGeometry())}get length(){return this._length}set length(t){t!==this._length&&(this._length=t,this._updateGeometry())}get color(){return this._color}set color(t){ci(t,this._color)||(xe(this._color,t),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}_createObject3DResources(t){const e=new Wt(this.materialParameters),a=new Array;return this._createObject3DGeometry(e,t,a),{material:e,geometries:a,forEach:n=>{n(e),a.forEach(n)}}}_recreateObject3DGeometry(t,e){t.geometries.length=0,this._createObject3DGeometry(t.material,e,t.geometries)}_createObject3DGeometry(t,e,a){const[n,o]=Xn(t);e.addGeometry(n),e.addGeometry(o),a.push(n),a.push(o),this._updateVerticesObject3D(e)}_createDrapedResources(){const t=new Wt(this.materialParameters),e=M(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});return{material:t,geometries:this._createDrapedGeometry(t),pixelRatioHandle:e}}_recreateDrapedGeometry(t){t.geometries=this._createDrapedGeometry(t.material)}_createDrapedGeometry(t){const e=Xn(t);return this._updateVerticesDraped(e),e.map(a=>new ds(a))}_updateMaterial(){var e,a;const{materialParameters:t}=this;(e=this.object3dResources.resources)==null||e.material.setParameters(t),(a=this.drapedResources.resources)==null||a.material.setParameters(t)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const t=this.object3dResources.object;t&&this._updateVerticesObject3D(t)}}_updateVerticesObject3D(t){const e=this.view.state.camera;e.projectToScreen(this.location,Oi),G(Ct,this.location,this.direction),e.projectToScreen(Ct,Ee),qa(Ee,xr(Ee,Ee,Oi)),this._updateVertexAttributesObject3D(e,t,0,Oi,Ee,1),this._updateVertexAttributesObject3D(e,t,1,Oi,Ee,-1)}_updateVertexAttributesObject3D(t,e,a,n,o,s){var u;const r=e.geometries[a],l=(u=r.getMutableAttribute(T.POSITION))==null?void 0:u.data;if(!l)return;const{start:c,end:p}=Yn(o,n,s,this.offset,this.width,this.length);t.unprojectFromScreen(Li(c),Ct),l[0]=Ct[0],l[1]=Ct[1],l[2]=Ct[2],t.unprojectFromScreen(Li(p),Ct),l[3]=Ct[0],l[4]=Ct[1],l[5]=Ct[2],e.geometryVertexAttributeUpdated(r,T.POSITION)}_updateVerticesDraped(t){const{view:{basemapTerrain:{overlayManager:e},state:{contentPixelRatio:a}}}=this,{location:n,width:o,length:s,offset:r}=this,l=hh;l.spatialReference=e.renderer.spatialReference,l.x=n[0],l.y=n[1];const c=this.view.overlayPixelSizeInMapUnits(l)*a,p=o*c,u=s*c,g=r*c;this._updateVertexAttributesDraped(t[0],p,u,g,-1),this._updateVertexAttributesDraped(t[1],p,u,g,1)}_updateVertexAttributesDraped(t,e,a,n,o){var u;const s=(u=t.getMutableAttribute(T.POSITION))==null?void 0:u.data;if(!s)return;const{location:r,direction:l}=this,{start:c,end:p}=Yn(l,r,o,n,e,a);s[0]=c[0],s[1]=c[1],s[2]=za,s[3]=p[0],s[4]=p[1],s[5]=za,t.invalidateBoundingInfo()}};function Xn(i){return[Ht(i,[x(),x()]),Ht(i,[x(),x()])]}function Yn(i,t,e,a,n,o){const s=ni(Wn,Zt(Wn,i[1]*e,i[0]*-e),a+n/2),r=Ke(wi,Ke(wi,Ke(wi,t,ni(wi,i,o/2)),s),s);return{start:r,end:Ke(qn,r,ni(qn,i,-o))}}function lh(i){i.geometries.length=0}function ch(i){i.pixelRatioHandle.remove(),i.geometries=[]}const Ct=x(),Wn=oe(),wi=oe(),qn=oe(),Oi=Nt(),Ee=Nt(),hh=Ue(0,0,void 0,null);let Hs=class extends jl{constructor(t){super(t),this._resources=null,this._transform=vt()}get object(){return this._resources!=null?this._resources.object:null}get transform(){return this._transform}set transform(t){Bo(this._transform,t),this._resources!=null&&(this._resources.object.transformation=this._transform)}recreate(){this.attached&&this.createResources()}recreateGeometry(){if(this._resources==null)return;const t=this._resources.object,e=this.view._stage;e.removeMany(t.geometries),t.removeAllGeometries(),this.createGeometries(t),t.visible=this.visible,e.addMany(t.geometries)}createResources(){this.destroyResources();const t=this.view._stage;if(!t)return;const e=new gs(t,{pickable:!1,updatePolicy:_s.SYNC}),a=new ms({castShadow:!1});a.transformation=this._transform,this.createExternalResources(),this.createGeometries(a),t.addMany(a.geometries),this.forEachExternalMaterial(n=>t.add(n)),t.add(a),e.add(a),a.visible=this.visible,this._resources={layer:e,object:a}}destroyResources(){const t=this.view._stage;this._resources!=null&&t&&(t.remove(this._resources.object),this._resources.layer.destroy(),this.forEachExternalMaterial(e=>{t.remove(e)}),t.removeMany(this._resources.object.geometries),this._resources.object.dispose(),this.destroyExternalResources(),this._resources=null)}updateVisibility(t){this._resources!=null&&(this._resources.object.visible=t)}},Fa=class extends Hs{constructor(t){super(t),this._material=null,this._texture=null,this._geometry=null,this._size=3,this._color=He(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=He(1,1,1,1),this._elevationInfo=null,this.applyProperties(t)}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get size(){return this._size}set size(t){if(t!==this._size){const e=this._preferredTextureSize;this._size=t,e<this._preferredTextureSize?this.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(t){ci(t,this._color)||(xe(this._color,t),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(t){this._pixelSnappingEnabled!==t&&(this._pixelSnappingEnabled=t,this._updateMaterial())}get primitive(){return this._primitive}set primitive(t){this._primitive!==t&&(this._primitive=t,this.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(t){t!==this._outlineSize&&(this._outlineSize=t,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(t){ci(t,this._outlineColor)||(xe(this._outlineColor,t),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this.recreateGeometry()}_updateMaterial(){this._material&&this._material.setParameters(this._materialParameters)}_updateSizeAttribute(){const t=this.object;if(t==null)return;const e=t.geometries[0];if(e==null)return;const a=e.getMutableAttribute(T.SIZE).data,n=this._geometrySize;a[0]=n,a[1]=n,t.geometryVertexAttributeUpdated(t.geometries[0],T.SIZE)}get _materialParameters(){var t;return{color:this._color,textureIsSignedDistanceField:!0,sampleSignedDistanceFieldTexelCenter:Vl(this._primitive),distanceFieldBoundingBox:uh,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:(t=this._texture)==null?void 0:t.id,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled,isDecoration:this.isDecoration}}get _geometrySize(){return this._size/ei}createExternalResources(){this._texture=Fl(this._primitive,this._preferredTextureSize),this._material=new Gl(this._materialParameters);const t=this.view._stage;this._texture.load(t.renderView.renderingContext),t.add(this._texture)}destroyExternalResources(){this._texture&&(this.view._stage.remove(this._texture),this._texture.dispose(),this._texture=null),this._material=null}createGeometries(t){const e=this._createRenderGeometry();e!=null&&t.addGeometry(e)}forEachExternalMaterial(t){this._material&&t(this._material)}get _preferredTextureSize(){return Hi(2*this._geometrySize,16,128)}calculateMapBounds(t){var n;const e=(n=this.object)==null?void 0:n.geometries[0];if(!e)return!1;const a=e.attributes.get(T.POSITION).data;return hi(a,this.view.renderCoordsHelper.spatialReference,Qn,this.view.spatialReference),wr(t,Qn),!0}_createRenderGeometry(){const{geometry:t,_material:e}=this;if(t==null||e==null)return null;const{renderCoordsHelper:a,elevationProvider:n}=this.view,o=aa(t,n,Mi.fromElevationInfo(this.elevationInfo),a),s=W(f.get(),t.x,t.y,o),r=f.get();hi(s,t.spatialReference,r,a.spatialReference);const l=this._geometrySize;return zl(e,null,r,null,[l,l],[0,0,0,1])}};const ei=Ul,uh=[ei/2,ei/2,1-ei/2,1-ei/2],Qn=x();let ph=class extends ps{constructor(t){super(t),this._maxSize=0,this._position=x(),this._up=x(),this._right=x(),this._renderOccluded=D.OccludeAndTransparent,this._color=He(1,0,0,1),this._outlineColor=He(0,0,0,1),this._outlineSize=0,this._size=32,this._outlineRenderOccluded=D.Opaque,this.applyProperties(t)}createObject3DResourceFactory(t){return{view:t,createResources:e=>this._createObject3DResources(e),destroyResources:()=>{},cameraChanged:()=>this._updateTransformObject3D()}}createDrapedResourceFactory(t){return{view:t,createResources:()=>this._createDrapedResources(),destroyResources:dh}}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateQuadMaterial())}get color(){return this._color}set color(t){xe(this._color,t),this._updateQuadMaterial()}get outlineColor(){return this._outlineColor}set outlineColor(t){xe(this._outlineColor,t),this._updateOutlineMaterial()}get outlineSize(){return this._outlineSize}set outlineSize(t){const e=this._outlineSize===0!=(t===0);this._outlineSize=t,e?this.recreateGeometry():this._updateOutlineMaterial()}get size(){return this._size}set size(t){t!==this._size&&(this._size=t,this._updateTransform())}get outlineRenderOccluded(){return this._outlineRenderOccluded}set outlineRenderOccluded(t){this._outlineRenderOccluded=t,this._updateOutlineMaterial()}set geometry({previous:t,center:e,next:a}){this._maxSize=Math.min(vn(e,t),vn(e,a))/3,ut(this._up,$(this._up,t,e)),ut(this._right,$(this._right,a,e)),lt(this._position,e),this.recreateGeometry()}_createObject3DResources(t){const e=new Dt(this._quadMaterialParameters),a=this._outlineSize===0?void 0:new Wt(this._outlineMaterialParameters);return this._createObject3DGeometries(t,e,a),{quadMaterial:e,outlineMaterial:a,forEach:n=>{n(e),a&&n(a)}}}_createObject3DGeometries(t,e,a){if(zi(this._up,$a)&&zi(this._right,$a))return;const n=this._createGeometries(e,a);for(const o of n)t.addGeometry(o);this._updateTransformObject3D(t)}_createDrapedResources(){const t=new Dt(this._quadMaterialParameters),e=this._outlineSize===0?void 0:new Wt(this._outlineMaterialParameters),a=this._createGeometries(t,e).map(n=>new ds(n));return this._setTransformDraped(a),{quadMaterial:t,outlineMaterial:e,geometries:a,pixelRatioHandle:M(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()})}}_createGeometries(t,e){const{up:a,right:n,corner:o}=this._getVertices(),s=gh(a,n,o,t);return e?[s,Ht(e,[a,o,n])]:[s]}_getVertices(){let t=this._up,e=this._right;const a=G(f.get(),t,e);return this.isDraped&&(t=lt(f.get(),t),e=lt(f.get(),e),t[2]=0,e[2]=0,a[2]=0),{up:t,right:e,corner:a}}_updateTransform(){this.isDraped?this.drapedResources.recreateGeometry():this._updateTransformObject3D()}_updateTransformObject3D(t=this.object3dResources.object){if(!t)return;const e=this.view.state.camera,a=this._size*e.computeScreenPixelSizeAt(this._position),n=Math.min(this._maxSize,a);ki(Jt,this._position),ui(Jt,Jt,[n,n,n]),t.transformation=Jt}_setTransformDraped(t){if(t.length===0)return;const{view:{basemapTerrain:{overlayManager:e},state:{contentPixelRatio:a}}}=this,{_position:n,_size:o}=this,s=lt(f.get(),n);s[2]=za;const r=_h;r.spatialReference=e.renderer.spatialReference,r.x=s[0],r.y=s[1];const l=o*(this.view.overlayPixelSizeInMapUnits(r)*a),c=Math.min(this._maxSize,l);ki(Jt,s),ui(Jt,Jt,[c,c,1]);for(const p of t)p.transformation=Jt}get _quadMaterialParameters(){return{color:this._color,forceTransparentMode:!0,writeDepth:!1,polygonOffset:!0,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateQuadMaterial(){var t,e;(t=this.object3dResources.resources)==null||t.quadMaterial.setParameters(this._quadMaterialParameters),(e=this.drapedResources.resources)==null||e.quadMaterial.setParameters(this._quadMaterialParameters)}get _outlineMaterialParameters(){return{color:this._outlineColor,width:this._outlineSize,renderOccluded:this._outlineRenderOccluded,isDecoration:this.isDecoration}}_updateOutlineMaterial(){var t,e,a,n;(e=(t=this.object3dResources.resources)==null?void 0:t.outlineMaterial)==null||e.setParameters(this._outlineMaterialParameters),(n=(a=this.drapedResources.resources)==null?void 0:a.outlineMaterial)==null||n.setParameters(this._outlineMaterialParameters)}};function dh(i){i.pixelRatioHandle.remove(),i.geometries=[]}function gh(i,t,e,a){return new bs(a,[[T.POSITION,new Aa([0,0,0,...t,...i,...e],[0,1,2,1,2,3],3,!0)]])}const Jt=vt(),_h=Ue(0,0,void 0,null);let mi=class extends hc{sortUniqueHints(t){return t.sort((e,a)=>(a instanceof fn?a.length:0)-(e instanceof fn?e.length:0))}visualizeIntersectionPoint(t,e){const{spatialReference:a,view:n}=e,o=qe(e);return mt(new Fa({view:n,primitive:"circle",geometry:bn(t.intersectionPoint,a),elevationInfo:t.isDraped?Zo:Qa,size:20,outlineSize:2,color:o.intersectionPointColor,outlineColor:o.intersectionPointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizePoint(t,e){const{view:a,spatialReference:n}=e,o=qe(e),s=Kt(t.point,t.domain,e);return mt(new Fa({view:a,primitive:"circle",geometry:bn(s,n),elevationInfo:Ei(t),size:20,outlineSize:2,color:o.pointColor,outlineColor:o.pointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizeLine(t,e){const{view:a,spatialReference:n}=e,o=qe(e),s=Kt(t.lineStart,t.domain,e),r=Kt(t.lineEnd,t.domain,e);return mt(mh(t.type,s,r,n,Ei(t),a,o,t.isDraped,t.fadeLeft,t.fadeRight))}visualizeParallelSign(t,e){const{view:a,spatialReference:n}=e,o=qe(e),{isDraped:s}=t,r=Ei(t),l=Kt(t.lineStart,t.domain,e),c=Kt(t.lineEnd,t.domain,e),p=me(l,n,r,a,s),u=me(c,n,r,a,s),g=ne(u,p,u,.5),_=new rh({view:a,attached:!1,offset:It.parallelLineHintOffset,length:It.parallelLineHintLength,width:It.parallelLineHintWidth,color:o.parallelSignColor,location:g,renderOccluded:s?D.OccludeAndTransparent:D.Opaque,isDraped:s,renderGroup:La.SnappingHint,isDecoration:!0});return _.setDirectionFromPoints(p,g),_.attached=!0,mt(_)}visualizeRightAngleQuad(t,e){const{view:a,spatialReference:n}=e,o=qe(e),s=Ei(t),{isDraped:r}=t,l=Kt(t.previousVertex,t.domain,e),c=Kt(t.centerVertex,t.domain,e),p=Kt(t.nextVertex,t.domain,e),u=me(l,n,s,a,r),g=me(c,n,s,a,r),_=me(p,n,s,a,r);return mt(new ph({view:a,attached:!0,color:r?o.rightAngleColorDraped:o.rightAngleColor,renderOccluded:r?D.OccludeAndTransparent:D.Transparent,outlineRenderOccluded:r?D.OccludeAndTransparent:D.Opaque,outlineColor:o.rightAngleOutlineColor,outlineSize:It.rightAngleHintOutlineSize,size:It.rightAngleHintSize,isDraped:r,geometry:{previous:u,center:g,next:_},renderGroup:La.SnappingHint,isDecoration:!0}))}};function qe(i){const{effectiveTheme:t}=i.view,e=nt.toUnitRGBA(t.accentColor),a=[0,0,0,0];return{intersectionPointColor:a,intersectionPointOutlineColor:e,pointColor:a,pointOutlineColor:e,lineColor:e,lineOutlineColor:void 0,parallelSignColor:e,rightAngleColor:e,rightAngleColorDraped:nt.toUnitRGBA(Ya(t.accentColor,.5)),rightAngleOutlineColor:e}}function Kt(i,t,{selfSnappingZ:e,view:a,spatialReference:n}){return t&Or.SELF&&Er(i)&&e!=null?Tr(i,e,a,n):i}function Ei(i){return i.isDraped?Zo:Qa}function mh(i,t,e,a,n,o,s,r=!1,l=!0,c=!0){const p=me(t,a,n,o,r),u=me(e,a,n,o,r),g=new ia({view:o,extensionType:Pl.FADED,start:p,end:u,isDraped:r,color:s.lineColor,renderOccluded:r?D.OccludeAndTransparent:D.Opaque,renderGroup:La.SnappingHint,isDecoration:!0});switch(i){case pa.TARGET:g.width=It.lineHintWidthTarget,g.fadedExtensions={start:0,end:It.lineHintFadedExtensions};break;case pa.REFERENCE_EXTENSION:g.width=It.lineHintWidthReference,g.fadedExtensions={start:0,end:0};break;case pa.REFERENCE:g.width=It.lineHintWidthReference,g.fadedExtensions={start:l?It.lineHintFadedExtensions:0,end:c?It.lineHintFadedExtensions:0}}return g.attached=!0,g}function me(i,t,e,a,n){const o=x();if(n){const s=a.basemapTerrain.overlayManager.renderer.spatialReference;hi(i,t,o,s)}else Uo(i,t,e,a,o);return o}function un(i){const t=i.graphic;return t?[M(()=>"visible"in i?i.visible:i.displaying,e=>{e&&t.notifyMeshTransformChanged({action:ka.EnableFastUpdates})},{...ke}),F(()=>t.notifyMeshTransformChanged({action:ka.DisableFastUpdates}))]:[]}function vh(i,t,e,a,n){const o=Nn(3*i.length),s=Nn(o.length);i.forEach((c,p)=>{o[3*p]=c[0],o[3*p+1]=c[1],o[3*p+2]=c.length>2?c[2]:0});const r=Ll(o,t,0,s,0,o,0,o.length/3,e,a,n),l=r!=null;return{numVertices:i.length,position:o,mapPositions:s,projectionSuccess:l,sampledElevation:r}}function fh(i,t){if(!t.screenSizeEnabled)return;const e=i.vertex;Yl(e,t),e.uniforms.add(new Zi("perScreenPixelRatio",(a,n)=>n.camera.perScreenPixelRatio),new Zi("screenSizeScale",a=>a.screenSizeScale)),e.code.add(Y`float computeRenderPixelSizeAt( vec3 pWorld ){
vec3 viewForward = - vec3(view[0][2], view[1][2], view[2][2]);
float viewDirectionDistance = abs(dot(viewForward, pWorld - cameraPosition));
return viewDirectionDistance * perScreenPixelRatio;
}
vec3 screenSizeScaling(vec3 position, vec3 anchor){
return position * screenSizeScale * computeRenderPixelSizeAt(anchor) + anchor;
}`)}function ks(i){const t=new tn,e=i.multipassEnabled&&i.output===yt.Color;t.include(Ds,i),t.include(fh,i),t.include(ys,i);const{vertex:a,fragment:n}=t;return n.include(Ms),en(a,i),n.uniforms.add(new Xi("uColor",o=>o.color)),t.attributes.add(T.POSITION,"vec3"),t.varyings.add("vWorldPosition","vec3"),e&&t.varyings.add("depth","float"),i.screenSizeEnabled&&t.attributes.add(T.OFFSET,"vec3"),i.shadingEnabled&&(Wl(a),t.attributes.add(T.NORMAL,"vec3"),t.varyings.add("vViewNormal","vec3")),a.code.add(Y`
    void main(void) {
      vWorldPosition = ${i.screenSizeEnabled?"screenSizeScaling(offset, position)":"position"};
  `),i.shadingEnabled&&a.code.add(Y`vec3 worldNormal = normal;
vViewNormal = (viewNormal * vec4(worldNormal, 1)).xyz;`),a.code.add(Y`
    ${e?"depth = (view * vec4(vWorldPosition, 1.0)).z;":""}
    gl_Position = transformPosition(proj, view, vWorldPosition);
  }
  `),e&&t.include(Ss,i),n.code.add(Y`
    void main() {
      discardBySlice(vWorldPosition);
      ${e?"terrainDepthTest(depth);":""}
    `),i.shadingEnabled?(n.uniforms.add(new ql("shadingDirection",o=>o.shadingDirection)),n.uniforms.add(new Xi("shadedColor",o=>bh(o.shadingTint,o.color))),n.code.add(Y`vec3 viewNormalNorm = normalize(vViewNormal);
float shadingFactor = 1.0 - clamp(-dot(viewNormalNorm, shadingDirection), 0.0, 1.0);
vec4 finalColor = mix(uColor, shadedColor, shadingFactor);`)):n.code.add(Y`vec4 finalColor = uColor;`),i.transparencyPassType===wt.ColorAlpha&&(t.outputs.add("fragColor","vec4",0),t.outputs.add("fragAlpha","float",1)),n.code.add(Y`
      ${i.output===yt.ObjectAndLayerIdColor?Y`finalColor.a = 1.0;`:""}
      if (finalColor.a < ${Y.float(Ql)}) {
        discard;
      }

      ${i.output===yt.Color?Y`fragColor = highlightSlice(finalColor, vWorldPosition); ${i.transparencyPassType===wt.ColorAlpha?Y`
                    fragColor = premultiplyAlpha(fragColor);
                    fragAlpha = fragColor.a;`:""}`:""}
    }
    `),t}function bh(i,t){const e=1-i[3],a=i[3]+t[3]*e;return a===0?(pe[3]=a,pe):(pe[0]=(i[0]*i[3]+t[0]*t[3]*e)/a,pe[1]=(i[1]*i[3]+t[1]*t[3]*e)/a,pe[2]=(i[2]*i[3]+t[2]*t[3]*e)/a,pe[3]=t[3],pe)}const pe=$r(),yh=Object.freeze(Object.defineProperty({__proto__:null,build:ks},Symbol.toStringTag,{value:"Module"}));let Ns=class Vs extends an{initializeProgram(t){return new nn(t.rctx,Vs.shader.get().build(this.configuration),Fs)}_setPipelineState(t){const e=this.configuration,a=t===wt.NONE,n=t===wt.FrontFace;return ln({blending:e.output===yt.Color&&e.transparent?a?Jl:ws(t):null,culling:Ps(e.cullFace),depthTest:{func:n?ji.LESS:e.shadingEnabled?ji.LEQUAL:ji.LESS},depthWrite:a?e.writeDepth?Cs:null:Os(t),drawBuffers:Es(t),colorWrite:cn,polygonOffset:a||n?null:Kl})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};Ns.shader=new on(yh,()=>Ja(()=>Promise.resolve().then(()=>Pp),void 0));let bt=class extends xs{constructor(){super(...arguments),this.output=yt.Color,this.cullFace=J.None,this.transparencyPassType=wt.NONE,this.hasSlicePlane=!1,this.transparent=!1,this.writeDepth=!0,this.screenSizeEnabled=!0,this.shadingEnabled=!0,this.multipassEnabled=!1,this.cullAboveGround=!1}};h([k({count:yt.COUNT})],bt.prototype,"output",void 0),h([k({count:J.COUNT})],bt.prototype,"cullFace",void 0),h([k({count:wt.COUNT})],bt.prototype,"transparencyPassType",void 0),h([k()],bt.prototype,"hasSlicePlane",void 0),h([k()],bt.prototype,"transparent",void 0),h([k()],bt.prototype,"writeDepth",void 0),h([k()],bt.prototype,"screenSizeEnabled",void 0),h([k()],bt.prototype,"shadingEnabled",void 0),h([k()],bt.prototype,"multipassEnabled",void 0),h([k()],bt.prototype,"cullAboveGround",void 0),h([k({constValue:!1})],bt.prototype,"occlusionPass",void 0);const Fs=new Map([[T.POSITION,0],[T.NORMAL,1],[T.OFFSET,2]]);let Ga=class extends Ar{constructor(t){super(t,new Sh),this.supportsEdges=!0,this.produces=new Map([[be.OPAQUE_MATERIAL,e=>e===yt.Highlight||_a(e)&&!this._isTransparent],[be.TRANSPARENT_MATERIAL,e=>_a(e)&&this._isTransparent&&this.parameters.writeDepth],[be.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>_a(e)&&this._isTransparent&&!this.parameters.writeDepth]]),this._configuration=new bt,this._vertexAttributeLocations=Fs}getConfiguration(t,e){return this._configuration.output=t,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._isTransparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.screenSizeEnabled=this.parameters.screenSizeEnabled,this._configuration.shadingEnabled=this.parameters.shadingEnabled,this._configuration.transparencyPassType=e.transparencyPassType,this._configuration.multipassEnabled=e.multipassEnabled,this._configuration.cullAboveGround=e.multipassTerrain.cullAboveGround,this._configuration}intersect(t,e,a,n,o,s){if(this.parameters.screenSizeEnabled){const r=t.attributes.get(T.OFFSET);Fn(t,a,n,o,{applyToVertex:(c,p,u,g)=>{const _=W(Jn,r.data[3*g],r.data[3*g+1],r.data[3*g+2]),m=W(wh,c,p,u);return it(_,_,this.parameters.screenSizeScale*a.camera.computeScreenPixelSizeAt(_)),G(m,m,_),[m[0],m[1],m[2]]},applyToAabb:c=>{const p=Ir(c,Jn);return Rr(c,this.parameters.screenSizeScale*a.camera.computeScreenPixelSizeAt(p))}},s)}else Fn(t,a,n,o,void 0,s)}createGLMaterial(t){return new Mh(t)}createBufferWriter(){return new xh(this.parameters.screenSizeEnabled)}get _isTransparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}},Mh=class extends tc{beginSlot(t){return this.ensureTechnique(Ns,t)}},Sh=class extends Xo{constructor(){super(...arguments),this.color=He(1,1,1,1),this.shadingTint=He(0,0,0,.25),this.shadingDirection=ut(x(),[.5,-.5,-.5]),this.screenSizeScale=14,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=J.None,this.screenSizeEnabled=!1,this.shadingEnabled=!0}},xh=class{constructor(t){this.screenSizeEnabled=t;const e=vc().vec3f(T.POSITION).vec3f(T.NORMAL);this.screenSizeEnabled&&e.vec3f(T.OFFSET),this.vertexBufferLayout=e}elementCount(t){return t.attributes.get(T.POSITION).indices.length}write(t,e,a,n,o){if(fc(a,this.vertexBufferLayout,t,e,n,o),this.screenSizeEnabled){if(!a.attributes.has(T.OFFSET))throw new Error(`${T.OFFSET} vertex attribute required for screenSizeEnabled ShadedColorMaterial`);{const s=a.attributes.get(T.OFFSET);js(s.size===3);const r=n.getField(T.OFFSET,_c);if(!r)throw new Error("unable to acquire view for "+T.OFFSET);bc(s,e,r,o)}}}};const Jn=x(),wh=x();let Kn=class extends Hs{constructor(t){super(t),this.view=null,this._renderOccluded=D.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=yn([1,127/255,0,1]),this._size=11,this._outlineColor=yn([0,0,0,.5]),this._outlineSize=1,this._elevationInfo=null,this.applyProperties(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(t){this._vertices=t,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(t){this._spatialReference=t,this.recreateGeometry()}get color(){return this._color}set color(t){ci(t,this._color)||(xe(this._color,t),this._updateMaterial())}get size(){return this._size}set size(t){t!==this._size&&(this._size=t,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(t){ci(t,this._outlineColor)||(xe(this._outlineColor,t),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(t){t!==this._outlineSize&&(this._outlineSize=t,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,screenSizeScale:this.size,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const t=this.vertices;if(t==null||t.length===0)return[];const e=.5,a=.5,n=vh(t,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Mi.fromElevationInfo(this.elevationInfo)),o=[],s=n.numVertices,r=n.position;for(let l=0;l<s;++l){const c=W(Oh,r[3*l],r[3*l+1],r[3*l+2]),p=to(this._vertexMaterial,e,c),u=to(this._vertexOutlineMaterial,a,c);o.push({vertexGeometry:p,vertexOutlineGeometry:u})}return o}createGeometries(t){const e=this._createRenderGeometries();for(const{vertexGeometry:a,vertexOutlineGeometry:n}of e)t.addGeometry(a),t.addGeometry(n)}createExternalResources(){this._vertexMaterial=new Ga({...this._vertexMaterialParameters,writeDepth:!0,cullFace:J.Back,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new Ga({...this._vertexOutlineMaterialParameters,forceTransparentMode:!0,writeDepth:!0,cullFace:J.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(t){t(this._vertexMaterial),t(this._vertexOutlineMaterial)}};const Oh=x();function to(i,t,e){return ti(i,t,16,16,{offset:e})}let Te=class extends Ec{constructor(t){super(t),this._activeVertexVisualElement=null,this._createGraphicState=null,this._outlineVisualElement=null,this._verticesVisualElement=null,this._verticalLineVisualElement=null,this._settings=new Oe({getTheme:()=>this.view.effectiveTheme}),this.geometryType=null,this.type="draw-3d"}initialize(){const{mode:t,offset:e,unit:a}=this.elevationInfo;this.internalGraphicsLayer.elevationInfo=new Dr({mode:t,offset:e,unit:a})}normalizeCtorArgs(t){if(!t.elevationInfo){const e=t.hasZ??!0;return{...t,elevationInfo:jr(e)}}return t}initializeGraphic(t){const{view:e}=this,a=this._createGraphicState=new Yo({graphic:t});return et([e.maskOccludee(t),e.trackGraphicState(a),M(()=>({element:this._outlineVisualElement,isDraped:a.isDraped}),({element:n,isDraped:o})=>{n&&(n.isDraped=o)},ke),Pr(()=>{Na(this.tooltipInfos.mesh,this.geometryToPlace)}),this._setupLoadingIndicator(a),...un(a)])}makeDrawOperation(){const{geometryType:t}=this,e=t!=="circle"&&t!=="rectangle";return new Tc({view:this.view,manipulators:this.manipulators,geometryType:$c(t),drawingMode:this.mode,hasZ:this.hasZ,defaultZ:this.defaultZ,snapToSceneEnabled:this.snapToScene,drawSurface:new Ac(this.view,this.elevationInfo,[this.internalGraphicsLayer]),elevationDrawSurface:new Ic(this.elevationInfo,this.defaultZ,this.view,this.internalGraphicsLayer),hasM:!1,elevationInfo:this.elevationInfo,snappingManager:this.snappingManager,snappingVisualizer:new mi,segmentLabels:e?new qi:null,labelOptions:this.sketchOptions.labels,isDraped:this._createGraphicState?this._createGraphicState.isDraped:Mn(this.hasZ,this.elevationInfo)==="on-the-ground",cursor:this.cursor,constraintsEnabled:!0})}onActiveVertexChanged(t){const{view:e}=this;if(this._activeVertexVisualElement)return this._activeVertexVisualElement.vertices=[t],this._activeVertexVisualElement.recreate(),this._updateVerticalLineVisualElement(t),F();const a=this._settings,n=a.manipulators.vertex,o=new Kn({view:e,spatialReference:e.spatialReference,vertices:[t],elevationInfo:this.internalGraphicsLayer.elevationInfo,size:n.size,outlineSize:n.outlineSize,renderOccluded:n.renderOccluded,attached:!1,isDecoration:!0});this._activeVertexVisualElement=o;const s=a.visualElements.zVerticalLine,r=new ia({view:e,extensionType:s.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:D.OccludeAndTransparent,isDecoration:!0});this._verticalLineVisualElement=r;const l=et([M(()=>a.visualElements.zVerticalLine,c=>c.apply(r),j),M(()=>({selectedColor:rt(a.colors.selected),outlineColor:rt(a.manipulators.vertex.outlineColor)}),({selectedColor:c,outlineColor:p})=>{o.color=c,o.outlineColor=p},j),F(()=>{this._activeVertexVisualElement=V(this._activeVertexVisualElement),this._verticalLineVisualElement=V(this._verticalLineVisualElement)})]);return o.attached=!0,this._updateVerticalLineVisualElement(t),l}_updateVerticalLineVisualElement(t){const e=this._verticalLineVisualElement;if(!e)return;const{renderCoordsHelper:a,elevationProvider:n}=this.view;W($e,t[0],t[1],t[2]),eo.setFromElevationInfo(this.elevationInfo),$e[2]=aa($e,n,eo,a),a.toRenderCoords($e,this.view.spatialReference,$e)?(e.setStartEndFromWorldDownAtLocation($e),e.attached=!0):e.attached=!1}onOutlineChanged(t){if(this._outlineVisualElement)return this._outlineVisualElement.geometry=t,F();const e=this.internalGraphicsLayer.elevationInfo,{view:a}=this,n=this._settings,o=new we({view:a,geometry:t,elevationInfo:e,isDraped:this._createGraphicState?this._createGraphicState.isDraped:Mn(this.hasZ,e)==="on-the-ground",attached:!1,isDecoration:!0});this._outlineVisualElement=o;const s=et([M(()=>n.visualElements.lineObjects.outline,r=>r.apply(o),j),M(()=>n.visualElements.lineObjects.shadowStyle,r=>r.apply(o),j),F(()=>{this._outlineVisualElement=V(this._outlineVisualElement)})]);return o.attached=!0,o.laserlineEnabled=!0,s}onRegularVerticesChanged(t){if(this._verticesVisualElement)return this._verticesVisualElement.vertices=t,F();const{view:e}=this,a=this._settings,n=a.manipulators.vertex,o=new Kn({view:e,spatialReference:e.spatialReference,vertices:t,elevationInfo:this.internalGraphicsLayer.elevationInfo,size:n.size,outlineSize:n.outlineSize,renderOccluded:n.renderOccluded,attached:!1,isDecoration:!0}),s=et([M(()=>({color:rt(a.manipulators.vertex.color),outlineColor:rt(a.manipulators.vertex.outlineColor)}),({color:r,outlineColor:l})=>{o.color=r,o.outlineColor=l},j),F(()=>{this._verticesVisualElement=V(this._verticesVisualElement)})]);return o.attached=!0,this._verticesVisualElement=o,s}updateGraphicGeometry(t){if(this.geometryType!=="mesh"||(t==null?void 0:t.type)!=="point")super.updateGraphicGeometry(t);else{const e=this.geometryToPlace;e==null||e.centerAt(t),Na(this.tooltipInfos.mesh,e);const a=this._graphic;e&&a.geometry===e||(a.geometry=e)}}_setupLoadingIndicator(t){const{drawOperation:e}=this;if(!this.geometryToPlace)return e.loading=!1,null;e.loading=!0;const a=F(()=>{e.loading=!1});let n;const o=()=>n&&cancelAnimationFrame(n);return et([Ne(()=>t.displaying,()=>{o(),n=requestAnimationFrame(()=>a.remove())},{...ke,once:!0}),F(o),a])}};h([d({constructOnly:!0})],Te.prototype,"elevationInfo",void 0),h([d({constructOnly:!0})],Te.prototype,"geometryType",void 0),h([d()],Te.prototype,"type",void 0),h([d({constructOnly:!0})],Te.prototype,"view",void 0),Te=h([H("esri.views.3d.interactive.editingTools.draw.DrawGraphicTool3D")],Te);const eo=new Mi,$e=x();function Eh(i){const t=pn(i);return Cr(Math.cos(t),Math.sin(t))}function pn(i){if(i==null||i.type!=="polyline"&&i.type!=="polygon")return 0;const t=i.type==="polyline"?i.paths:i.rings,e=zr();for(const a of t)for(let n=0;n<a.length-1;n++){const o=a[n],s=a[n+1],r=o[0]-s[0],l=o[1]-s[1];if(r*r+l*l>e)return Math.atan2(s[1]-o[1],s[0]-o[0])}return 0}function U(i){var t;return(t=i==null?void 0:i.operations)==null?void 0:t.data.geometry}function Me(i,t){return Th(i==null?void 0:i.data.coordinateHelper.hasZ(),t)}function Th(i,t){return!!i&&t.mode!=="on-the-ground"&&!Lr(t)}function Gs(i,t,e){function a(){const s=e(),r=s.sketchOptions.tooltips.effectiveEnabled?s.activeTooltipInfo:null;return{...s,activeTooltipInfo:r}}let n=!1;function o({activeTooltipInfo:s,sketchOptions:r}){n=!0,s&&(s.sketchOptions=r,Us(s,t)),i.info=s,n=!1}return et([M(a,o,ke),M(()=>{const s=a(),{activeTooltipInfo:r}=s;if(r)return{context:s,activeTooltipInfo:r,key:r.key,geometry:U(t)}},(s,r)=>{s&&!n&&r&&r.key!==s.key&&$h(s.activeTooltipInfo,t,s.context)},pi),t.on("committed",()=>o(a())),Ts(i)])}function $h(i,t,{callbacks:e}){const a=U(t);switch(a==null?void 0:a.type){case"mesh":Qi(i,a.origin,t,e),"orientation"in i&&"scale"in i&&Na(i,a,e);break;case"point":Qi(i,a,t,e)}}function Qi(i,t,e,a){var r,l,c,p;const{dx:n,dy:o,dz:s}=$s(i,t);n===0&&o===0&&s===0||((r=a.onMoveStart)==null||r.call(a),(l=e.operations)==null||l.move(n,o,s,jt.NEW_STEP),(c=a.onMove)==null||c.call(a,n,o,s),(p=a.onMoveStop)==null||p.call(a))}function Us(i,t){const e=U(t);if(!i||!e||e.type!=="mesh"&&e.type!=="point")return;const a=e.type==="mesh",n=a?e.origin:e;i.setLocationFromPoint(n),Bs(i,n,t),i.type==="transform-mesh"&&a&&uc(i,e),i.clearInputValues()}function Bs(i,t,e){var a;i.elevation.actual=Rl(t),i.elevation.visible=!!((a=e.operations)!=null&&a.data.coordinateHelper.hasZ()),i.elevation.readOnly=!1,i.elevation.showAsZ=!0}function Zs(i,t,e=Ki()){return Le(i,Ni(t),e),ut(e.direction,e.direction),e}function Le(i,t,e){return Ah(i,i.screenToRender(t,Ia(f.get())),e)}function Ah(i,t,e){const a=Ia(Sn(f.get(),t));if(a[2]=0,!i.unprojectFromRenderScreen(a,e.origin))return null;const n=Ia(Sn(f.get(),t));n[2]=1;const o=i.unprojectFromRenderScreen(n,f.get());return o==null?null:($(e.direction,o,e.origin),e)}class ct{constructor(t){var a;this.metadata=void 0,this._camera=new Hl,this._elevation={offset:0,override:null},this.collisionType={type:"point"},this.collisionPriority=0,this._renderObjects=new Array,this.autoScaleRenderObjects=!0,this._available=!0,this._noDisplayCount=0,this._radius=10,this._worldSized=!1,this.focusMultiplier=2,this.touchMultiplier=2.5,this.worldOriented=!1,this._modelTransform=vt(),this._worldFrame=null,this._renderLocation=x(),this._renderLocationDirty=!0,this._location=new se({x:0,y:0,z:0}),this._elevationAlignedLocation=new se,this._elevationAlignedLocationDirty=!0,this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.consumesClicks=!0,this.cursor=null,this.grabCursor=null,this._grabbing=!1,this.dragging=!1,this._hovering=!1,this._selected=!1,this._state=K.None,this._focused=!1,this.events=new Vt.EventEmitter,this._screenLocation={screenPointArray:Nt(),renderScreenPointArray:Ra(),pixelSize:0},this._screenLocationDirty=!0,this._engineResourcesAddedToStage=!1,this._attached=!1,this._location.spatialReference=t.view.spatialReference,Object.assign(this,t);const e=(a=this.view.state)==null?void 0:a.camera;e&&this._camera.copyFrom(e)}destroy(){this._applyObjectTransform=Ph,this._removeResourcesFromStage(),this._engineResources=null,this.view=null,this._camera=null}get _stage(){var t;return(t=this.view)==null?void 0:t._stage}get elevationInfo(){return this._elevationInfo}set elevationInfo(t){this._elevationInfo=t,this._elevationAlignedLocationDirty=!0,this._renderLocationDirty=!0,this._updateEngineObject()}get renderObjects(){return this._renderObjects}set renderObjects(t){this._removeResourcesFromStage(),this._engineResources=null,this._renderObjects=t.slice(),this._updateEngineObject()}set available(t){t!==this._available&&(this._available=t,this._updateEngineObject())}get available(){return this._available}disableDisplay(){return this._noDisplayCount++,this._noDisplayCount===1&&this._updateEngineObject(),F(()=>{this._noDisplayCount--,this._noDisplayCount===0&&this._updateEngineObject()})}set radius(t){t!==this._radius&&(this._radius=t,this._updateEngineObject())}get radius(){return this._radius}set worldSized(t){t!==this._worldSized&&(this._worldSized=t,this._updateEngineObject())}get worldSized(){return this._worldSized}get modelTransform(){return this._modelTransform}set modelTransform(t){io(t)&&(this._screenLocationDirty=!0),Bo(this._modelTransform,t),this._updateEngineObject()}get renderLocation(){return this._renderLocationDirty&&(this._renderLocationDirty=!1,this.view.renderCoordsHelper.toRenderCoords(this.elevationAlignedLocation,this._renderLocation),this.worldOriented?(this._worldFrame||(this._worldFrame=vt()),Ih(this.view,this._renderLocation,this._worldFrame)):this._worldFrame&&(this._worldFrame=null)),this._renderLocation}set renderLocation(t){this.view.renderCoordsHelper.fromRenderCoords(t,this._location),this.elevationAlignedLocation=this._location}get location(){return this._location}set location(t){Un(t,this._location),this._notifyLocationChanged()}_notifyLocationChanged(){this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!0,this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}get elevationAlignedLocation(){return this._elevationAlignedLocationDirty?(this._evaluateElevationAlignment(),this._updateElevationAlignedLocation(),this._elevationAlignedLocation):this._elevationAlignedLocation}set elevationAlignedLocation(t){Un(t,this._location),this._evaluateElevationAlignment(),this._location.z-=this._elevation.offset,this._updateElevationAlignedLocation(),this._updateEngineObject(),this.events.emit("location-update",{location:this._location})}_updateElevationAlignedLocation(){const t=this._elevation.override!=null?this._elevation.override:this.location.z||0;this._elevationAlignedLocation.x=this.location.x,this._elevationAlignedLocation.y=this.location.y,this._elevationAlignedLocation.z=t+this._elevation.offset,this._elevationAlignedLocation.spatialReference=Nc(this.location.spatialReference),this._renderLocationDirty=!0,this._screenLocationDirty=!0,this._elevationAlignedLocationDirty=!1}grabbableForEvent(){return!0}get grabbing(){return this._grabbing}set grabbing(t){t!==this._grabbing&&(this._grabbing=t,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get hovering(){return this._hovering}set hovering(t){t!==this._hovering&&(this._hovering=t,this._setFocused(this._hovering||this._grabbing),this._updateEngineObject())}get selected(){return this._selected}set selected(t){t!==this._selected&&(this._selected=t,this._updateEngineObject(),this.events.emit("select-changed",{action:t?"select":"deselect"}))}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._updateEngineObject())}updateStateEnabled(t,e){e?this.state|=t:this.state&=~t}_setFocused(t){t!==this._focused&&(this._focused=t,this.events.emit("focus-changed",{action:t===!0?"focus":"unfocus"}))}get focused(){return this._focused}get screenLocation(){return this._ensureScreenLocation(),this._screenLocation}_ensureScreenLocation(){if(!this._screenLocationDirty)return;this._screenLocation.pixelSize=this._camera.computeScreenPixelSizeAt(this.renderLocation),this._screenLocationDirty=!1;let t;if(io(this._modelTransform)){const e=this._calculateModelTransformOffset(jh);t=G(e,e,this.renderLocation)}else t=this.renderLocation;this._camera.projectToRenderScreen(t,this._screenLocation.renderScreenPointArray),this._camera.renderToScreen(this._screenLocation.renderScreenPointArray,this._screenLocation.screenPointArray)}get applyObjectTransform(){return this._applyObjectTransform}set applyObjectTransform(t){this._applyObjectTransform=t,this._screenLocationDirty=!0,this._updateEngineObject()}get attached(){return this._attached}intersectionDistance(t,e){if(!this.available)return null;const a=Ni(t,Rh),n=this._getCollisionRadius(e),o=-1*this.collisionPriority;switch(this.collisionType.type){case"point":if(Go(this.screenLocation.screenPointArray,a)<n*n)return this.screenLocation.renderScreenPointArray[2]+o;break;case"line":{const s=this.collisionType.paths,r=this._getWorldToScreenObjectScale(),l=this._calculateObjectTransform(r,Ti),c=n*this.screenLocation.pixelSize,p=Le(this._camera,a,ma);if(p==null)return null;for(const u of s){if(u.length===0)continue;const g=De(li,u[0],l);for(let _=1;_<u.length;_++){const m=De(oo,u[_],l),v=Vr(On(g,m,ao),p);if(v!=null&&v<c*c){const b=G(f.get(),g,m);it(b,b,.5);const y=En(f.get());return this._camera.projectToRenderScreen(b,y),y[2]+o}lt(g,m)}}break}case"disc":{const s=this.collisionType.direction,r=this.collisionType.offset??$a,l=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(l,Ti),p=n*this.screenLocation.pixelSize,u=Le(this._camera,a,ma);if(u==null)return null;const g=xn(no,c),_=wn(ro,s,g),m=De(lo,r,c);Ve(m,_,$i);const v=so;if(Fe($i,u,v)&&Wo(v,m)<p*p)return this.screenLocation.renderScreenPointArray[2]+o;break}case"ribbon":{const{paths:s,direction:r}=this.collisionType,l=this._getWorldToScreenObjectScale(),c=this._calculateObjectTransform(l,Ti),p=n*this._camera.computeScreenPixelSizeAt(this.renderLocation),u=Le(this._camera,a,ma);if(u==null)return null;const g=xn(no,c),_=wn(ro,r,g),m=this._calculateModelTransformPosition(lo);Ve(m,_,$i);const v=so;if(!Fe($i,u,v))break;for(const b of s){if(b.length===0)continue;const y=De(li,b[0],c);for(let O=1;O<b.length;O++){const A=De(oo,b[O],c),q=Nr(On(y,A,ao),v);if(q!=null&&q<p*p){const C=G(f.get(),y,A);it(C,C,.5);const ht=En(f.get());return this._camera.projectToRenderScreen(C,ht),ht[2]+o}lt(y,A)}}break}default:kr(this.collisionType)}return null}attach(t={manipulator3D:{}}){const e=this._stage;if(!e)return;const a=t.manipulator3D;a.engineLayerId==null?(this._engineLayer=new gs(e,{pickable:!1,updatePolicy:_s.SYNC}),a.engineLayerId=this._engineLayer.id):e!=null&&e.getObject&&(this._engineLayer=e.getObject(a.engineLayerId)),a.engineLayerReferences=(a.engineLayerReferences||0)+1,this._materialIdReferences=a.materialIdReferences,this._materialIdReferences==null&&(this._materialIdReferences=new Map,a.materialIdReferences=this._materialIdReferences),this._camera.copyFrom(this.view.state.camera),this._attached=!0,this._updateEngineObject(),Fr(this._location.spatialReference,this.view.spatialReference)||(this.location=new se({x:0,y:0,z:0,spatialReference:this.view.spatialReference}))}detach(t={manipulator3D:{}}){const e=t.manipulator3D;e.engineLayerReferences--;const a=e.engineLayerReferences===0;this._removeResourcesFromStage(),a&&(e.engineLayerId=null,V(this._engineLayer)),this._engineResources=null,this._engineLayer=null,this._materialIdReferences=null,this._attached=!1}onViewChange(){this._camera.copyFrom(this.view.state.camera),this._screenLocationDirty=!0,this._updateEngineObject()}onElevationChange(t){Da(this.location,co,t.spatialReference)&&Gr(t.extent,co)&&this._notifyLocationChanged()}_evaluateElevationAlignment(){if(this.elevationInfo==null)return;let t=null,e=0;const a=Ur(this.elevationInfo,this.location.spatialReference??this.view.elevationProvider.spatialReference);switch(this.elevationInfo.mode){case"on-the-ground":t=ga(this.view.elevationProvider,this.location,"ground")??0;break;case"relative-to-ground":e=(ga(this.view.elevationProvider,this.location,"ground")??0)+a;break;case"relative-to-scene":e=(ga(this.view.elevationProvider,this.location,"scene")??0)+a;break;case"absolute-height":e=a}return e!==this._elevation.offset||t!==this._elevation.override?(this._elevation.offset=e,void(this._elevation.override=t)):void 0}_updateEngineObject(){if(!this._attached)return;if(!this.available)return void this._removeResourcesFromStage();const t=this._getWorldToScreenObjectScale(),e=Ti;if(this.autoScaleRenderObjects===!0){const s=this._getFocusedSize(this._radius,this.focused)*t;this._calculateObjectTransform(s,e)}else this._calculateObjectTransform(t,e);const{objectsByState:a}=this._ensureEngineResources(),n=(this.focused?S.Focused:S.Unfocused)|(this.selected?S.Selected:S.Unselected),o=this._noDisplayCount>0;for(const{stateMask:s,objects:r}of a){if(o){for(const g of r)g.visible=!1;continue}const l=(s&S.All)!==S.None,c=(s&K.All)!==K.None,p=!l||(n&s)==(s&S.All),u=!c||(this.state&s)==(s&K.All);if(p&&u)for(const g of r)g.visible=!0,g.transformation=e;else for(const g of r)g.visible=!1}}_ensureEngineResources(){if(this._engineResources==null){const t=this._engineLayer,e=[],a=new Set;this.renderObjects.forEach(({geometry:{material:s}})=>{a.has(s)||(e.push(s),a.add(s))});const n=new Map;this._renderObjects.forEach(s=>{const r=new ms({castShadow:!1,geometries:[s.geometry]}),l=n.get(s.stateMask)||[];l.push(r),n.set(s.stateMask,l)});const o=[];n.forEach((s,r)=>o.push({stateMask:r,objects:s})),this._engineResources={objectsByState:o,layer:t,materials:e}}return this._addResourcesToStage(),this._engineResources}_addResourcesToStage(){const t=this._stage;if(this._engineResourcesAddedToStage||this._engineResources==null||!t)return;const{objectsByState:e,layer:a,materials:n}=this._engineResources;n.forEach(o=>{const s=this._materialIdReferences,r=s.get(o.id)||0;r===0&&t.add(o),s.set(o.id,r+1)}),e.forEach(({objects:o})=>{a.addMany(o),t.addMany(o)}),this._engineResourcesAddedToStage=!0}_removeResourcesFromStage(){const t=this._stage;if(!this._engineResourcesAddedToStage||this._engineResources==null||!t)return;const{objectsByState:e,layer:a,materials:n}=this._engineResources;e.forEach(({objects:o})=>{a.removeMany(o),t.removeMany(o)}),n.forEach(o=>{const s=this._materialIdReferences,r=s.get(o.id);r===1?(t.remove(o),s.delete(o.id)):s.set(o.id,r-1)}),this._engineResourcesAddedToStage=!1}_getCollisionRadius(t){return this._getFocusedSize(this.radius,!0)*(t==="touch"?this.touchMultiplier:1)}_getFocusedSize(t,e){return t*(e?this.focusMultiplier:1)}_getWorldToScreenObjectScale(){return this._worldSized?1:this.screenLocation.pixelSize}_calculateModelTransformPosition(t){const e=this._getWorldToScreenObjectScale(),a=this._calculateObjectTransform(e,Dh);return W(t,a[12],a[13],a[14])}_calculateModelTransformOffset(t){const e=this._calculateModelTransformPosition(t);return $(t,e,this.renderLocation)}_calculateObjectTransform(t,e){return Br(e,t,0,0,0,0,t,0,0,0,0,t,0,0,0,0,1),this._worldFrame&&Yt(e,e,this._worldFrame),Yt(e,e,this._modelTransform),e[12]+=this.renderLocation[0],e[13]+=this.renderLocation[1],e[14]+=this.renderLocation[2],e[15]=1,this._applyObjectTransform!=null&&this._applyObjectTransform(e),e}get test(){}}function io(i){return i[12]!==0||i[13]!==0||i[14]!==0}function Ih(i,t,e){switch(i.viewingMode){case"local":return ja(e),!0;case"global":{const a=Zr(i.renderCoordsHelper.spatialReference);return Xr(t,0,li,0,a.radius),Yr(re(li[0]),re(li[1]),e),!0}}}const Rh=Nt(),ao=Hr(),ma=Ki(),no=Wr(),Dh=vt(),Ti=vt(),$i=bi(),li=x(),oo=x(),so=x(),ro=x(),lo=x(),jh=x(),co=new se({x:0,y:0,z:0,spatialReference:null}),Ph=()=>{};var Rt;(function(i){i[i.NONE=0]="NONE",i[i.ANY=1]="ANY",i[i.Z=2]="Z",i[i.XY=4]="XY"})(Rt||(Rt={}));var R;(function(i){i[i.TRANSLATE_Z=0]="TRANSLATE_Z",i[i.TRANSLATE_XY=1]="TRANSLATE_XY",i[i.SCALE=2]="SCALE",i[i.ROTATE=3]="ROTATE",i[i.SCALE_ROTATE=4]="SCALE_ROTATE"})(R||(R={}));let Xs=class{constructor(){this.grabbingState=Rt.NONE,this.zManipulator=null,this.firstSelected=null,this.numSelected=0,this.firstGrabbedXY=null}update(t){this.grabbingState=Rt.NONE,this.zManipulator=null,this.numSelected=0,this.firstSelected=null,this.firstGrabbedXY=null,t.forEachManipulator((e,a)=>{if(a===R.TRANSLATE_Z&&(this.zManipulator=e),e instanceof ct&&(e.selected&&(this.numSelected===0&&(this.firstSelected=e),this.numSelected++),this.firstGrabbedXY==null&&e.grabbing&&a===R.TRANSLATE_XY&&(this.firstGrabbedXY=e)),e.grabbing)switch(this.grabbingState|=Rt.ANY,a){case R.TRANSLATE_Z:this.grabbingState|=Rt.Z;break;case R.TRANSLATE_XY:this.grabbingState|=Rt.XY}})}};function Ch(i){const{object:t}=i,e=zh(i),a=[e,Lh(i,e.visualElement)];return t.maskOccludee&&a.push(t.maskOccludee()),{visualElement:e.visualElement,remove:()=>Ka(a)}}function zh(i){const{view:t,object:e}=i,a=U(e),n=new we({view:t,geometry:Ua(a)?a:null,elevationInfo:e.elevationInfo,attached:!1,isDecoration:!0}),o=new Oe({getTheme:()=>t.effectiveTheme}),s=()=>{n.attached=e.visible},r=et([M(()=>o.visualElements.lineObjects.outline,l=>l.apply(n),j),M(()=>o.visualElements.lineObjects.shadowStyle,l=>l.apply(n),j),M(()=>e.visible,s),M(()=>e.isDraped,l=>{n.isDraped=l},j),e.on("committed",()=>{const l=U(e);n.geometry=Ua(l)?l:null}),mt(n)]);return s(),{visualElement:n,remove:()=>r.remove()}}function Lh(i,t){const{object:e,view:a}=i,n=[],o=e.elevationInfo,s=o.mode==="on-the-ground"||!o.offset&&o.mode!=="absolute-height",r=new Xs,l=new Oe({getTheme:()=>a.effectiveTheme}),c=l.visualElements,p=new ia({view:a,extensionType:c.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:D.OccludeAndTransparent,isDecoration:!0}),u=re(c.heightPlaneAngleCutoff),g=new Ca({view:a,attached:!1,angleCutoff:u,isDecoration:!0}),_=Vi(1);n.push(M(()=>({lineShadowStyle:l.visualElements.lineObjects.shadowStyle,pointShadowStyle:l.visualElements.pointObjects.shadowStyle,alpha:_.value}),({lineShadowStyle:O,pointShadowStyle:A,alpha:q})=>{O.apply(t,q),A.apply(p,q)},j));const m=Vi(1);n.push(M(()=>({heightPlane:l.visualElements.heightPlane,alpha:m.value}),({heightPlane:O,alpha:A})=>O.apply(g,A),j));const v=()=>{r.update(i);const O=U(e);if(!e.visible||s&&(e.isDraped||!Ua(O)||!O.hasZ))return t.laserlineEnabled=!1,p.attached=!1,void(g.attached=!1);t.laserlineEnabled=!0;const A=r.grabbingState&Rt.XY?c.laserlineAlphaMultiplier:1;_.value=A;const q=r.grabbingState&Rt.Z?c.laserlineAlphaMultiplier:1;m.value=q,Hh(p,r),kh(i,t,g,r)};n.push(M(()=>l.visualElements.zVerticalLine,O=>O.apply(p),j)),n.push(e.on("committed",v),M(()=>e.visible,v),t.events.on("attachment-origin-changed",v),mt(p),mt(g));const b=[],y=()=>{Ka(b),b.length=0,i.forEachManipulator(O=>b.push(O.events.on("grab-changed",v))),i.forEachManipulator(O=>b.push(O.events.on("select-changed",v))),v()};return y(),n.push(i.onManipulatorsChanged(y),qo(()=>et(b))),et(n)}function Hh(i,t){const e=t.numSelected===1?t.firstSelected:t.numSelected>1&&t.firstGrabbedXY!=null?t.firstGrabbedXY:null;e!=null?(i.setStartEndFromWorldDownAtLocation(e.renderLocation),i.attached=!0):i.attached=!1}function kh(i,t,e,a){if(a.numSelected>0){W(de,0,0,0);let n=0;i.forEachManipulator((o,s)=>{s===R.TRANSLATE_XY&&o.selected&&o instanceof ct&&(G(de,de,o.renderLocation),n++)}),n>0?(e.heightManifoldTarget=it(de,de,1/n),e.attached=!0):e.attached=!1}else{const n=t.attachmentOrigin;n!=null&&i.view.renderCoordsHelper.toRenderCoords(n,de)?(e.heightManifoldTarget=de,e.attached=!0):e.attached=!1}}function Ua(i){return i!=null&&(i.type==="polygon"||i.type==="polyline")}const de=x();function Nh(i){const t=[],e=Fh(i,t);return Vh(i,t,e),{visualElement:e,remove:()=>Ka(t)}}function Vh(i,t,e){const{view:a,object:n}=i,o=new Oe({getTheme:()=>a.effectiveTheme}),s=new ia({view:a,extensionType:o.visualElements.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:D.OccludeAndTransparent,isDecoration:!0});t.push(M(()=>o.visualElements.zVerticalLine,y=>y.apply(s),j));const r=new Ca({view:a,intersectsLineInfinite:!0,attached:!1,isDecoration:!0}),l=re(o.visualElements.heightPlaneAngleCutoff),c=new Ca({view:a,attached:!1,angleCutoff:l,isDecoration:!0}),p=n.elevationInfo,u=Mi.fromElevationInfo(p),g=p.mode==="on-the-ground"||!p.offset&&p.mode!=="absolute-height",_=new Xs,m=Vi(1);t.push(M(()=>({heightPlane:o.visualElements.heightPlane,alpha:m.value}),({heightPlane:y,alpha:O})=>y.apply(c,O),j));const v=Vi(1);t.push(M(()=>({shadowStyle:o.visualElements.pointObjects.shadowStyle,alpha:v.value}),({shadowStyle:y,alpha:O})=>y.apply(r,O),j));const b=()=>{_.update(i);let y=dn(U(n));const O=g&&(n.isDraped||y==null||!y.hasZ);let A=!0;if(O||y==null)A=!1;else{Qo(n.elevationInfo)&&(y=y.clone(),y.z=0);const Z=aa(y,a.elevationProvider,u,a.renderCoordsHelper);W(At,y.x,y.y,Z),hi(At,y.spatialReference,At,a.renderCoordsHelper.spatialReference),s.setStartEndFromWorldDownAtLocation(At),r.intersectsWorldUpAtLocation=At}const q=_.grabbingState&Rt.Z?o.visualElements.laserlineAlphaMultiplier:1;m.value=q;const C=Qr(Zh);!O&&n.visible&&e.calculateMapBounds(C)&&hi(Jr(C,At),a.spatialReference,At,a.renderCoordsHelper.spatialReference)?(c.heightManifoldTarget=At,c.attached=!0):c.attached=!1;const ht=_.grabbingState&Rt.XY?o.visualElements.laserlineAlphaMultiplier:1;v.value=ht;const E=A&&n.visible&&!O;r.attached=E,s.attached=E};t.push(M(()=>[n.visible,n.isDraped],b),n.on("committed",b)),i.forEachManipulator(y=>{t.push(y.events.on("grab-changed",b))}),t.push(mt(r)),t.push(mt(s)),t.push(mt(c)),b()}function Fh(i,t){const{view:e,object:a}=i,n=new Fa({view:e,geometry:dn(U(a)),elevationInfo:a.elevationInfo,isDecoration:!0});return Gh(i,n,t),t.push(mt(n)),n}function dn(i){return i==null?null:i.type==="point"?i:i.type==="mesh"?i.anchor.clone():null}function Gh(i,t,e){const{view:a,object:n}=i,o=()=>{t.attached=n.visible},s=new Oe({getTheme:()=>a.effectiveTheme});Uh(i,t,e),s.visualElements.pointObjects.outline.apply(t),e.push(M(()=>n.visible,o,j))}function Uh(i,t,e){const{view:a,object:n}=i;let o=null;const s=l=>{o!=null&&(o.remove(),o=null),n.isDraped&&l!=null&&(o=Bh(a,l,()=>{t.geometry=l}))},r=()=>{const l=dn(U(n));l!=null&&Qo(n.elevationInfo)&&(l.z=0),s(l),t.geometry=l};e.push(n.on("committed",r),qo(()=>o)),r()}function Bh(i,t,e){const a=i.elevationProvider.spatialReference;Kr(t,At,a);const n=At[0],o=At[1];return i.elevationProvider.on("elevation-change",s=>{Jo(s.extent,n,o)&&e()})}const At=x(),Zh=qr();function sa(i){var t;switch((t=U(i.object))==null?void 0:t.type){case"point":case"mesh":return Nh(i);case"polygon":case"polyline":return Ch(i);default:return null}}const Ys=128,kt=70,Xh=80,Ws=.02,Yh=54,Wh=100,qs=Math.ceil(kt/3*2),ve=160,va=.5,fa=24,Ae=9,qh=ve+30,ho=ve+53,Qh=60,Jh=23,Kh=5*Math.PI/12,tu=1*Math.PI/3,uo=10,po=.2,go=30,_o=53,mo=.2,vo=.3,eu=200,iu=3,au=1e6;let Si=class{constructor(){this._available=!0}set location(t){this._forEachManipulator3D(e=>e.location=t)}set elevationAlignedLocation(t){this._forEachManipulator3D(e=>e.elevationAlignedLocation=t)}set elevationInfo(t){this._forEachManipulator3D(e=>e.elevationInfo=t)}get renderLocation(){let t;return this._forEachManipulator3D(e=>{t||(t=e.renderLocation)}),t}get available(){return this._available}set available(t){this._available=t,this._forEachManipulator3D(e=>e.available=t)}get hovering(){return this.someManipulator(t=>t.hovering)}get grabbing(){return this.someManipulator(t=>t.grabbing)}get dragging(){return this.someManipulator(t=>t.dragging)}get selected(){return this.someManipulator(t=>t.selected)}hasManipulator(t){return this.someManipulator(e=>e===t)}someManipulator(t){let e=!1;return this.forEachManipulator(a=>{!e&&t(a)&&(e=!0)}),e}_forEachManipulator3D(t){this.forEachManipulator((e,a)=>{e instanceof ct&&t(e,a)})}},w=class{constructor(t,e=S.None){this.geometry=t,this.stateMask=e}};function ra(i,t){return Qs(i,()=>t)}function nu(i){return Qs(i,t=>t.plane)}function Qs(i,t){const e=x(),a=x();let n=!1;return o=>{const s=t(o);if(o.action==="start"){const c=Ni(o.screenStart,Li(Tn.get())),p=Le(i.state.camera,c,bo);p!=null&&(n=Fe(s,p,e))}if(!n)return null;const r=Ni(o.screenEnd,Li(Tn.get())),l=Le(i.state.camera,r,bo);return l==null?null:Fe(s,l,a)?{...o,renderStart:e,renderEnd:a,plane:s,ray:l}:null}}function ou(i,t,e=0,a=null,n=null){let o=null;return s=>{if(s.action==="start"&&(o=i.sceneIntersectionHelper.intersectElevationFromScreen(Nt(s.screenStart.x,s.screenStart.y),t,e,n),o!=null&&a!=null&&!Da(o,o,a))||o==null)return null;const r=i.sceneIntersectionHelper.intersectElevationFromScreen(Nt(s.screenEnd.x,s.screenEnd.y),t,e,n);return r!=null&&(a==null||Da(r,r,a))?{...s,mapStart:o,mapEnd:r}:null}}function vi(i,t,e,a=null,n=null){return ou(i,e,Ko(t,i,e),a,n)}function su(i,t,e,a){const n=e.toMap(i.screenStart);return n!=null?vi(t,n,e.elevationInfo,a):null}function ru(i,t){const e=cu,a=hu,n=bi();i.renderCoordsHelper.worldUpAtPosition(t,e);const o=St(Be(n),e,$(a,t,i.state.camera.eye));return St(o,o,e),Ve(t,o,n)}function Js(i,t,e){let a=null;const n=new na;return n.next(ra(i,ru(i,t))).next(lu(i,t)).next(Ks(i,e)).next(o=>{o.mapEnd.x=o.mapStart.x,o.mapEnd.y=o.mapStart.y,a=o}),o=>(a=null,n.execute(o),a)}function lu(i,t){const e=x(),a=Mt(t);i.renderCoordsHelper.worldUpAtPosition(t,e);const n=x(),o=x(),s=r=>($(r,r,t),tl(e,r,r),i.viewingMode==="global"&&Mt(r)*Math.sign(di(e,r))<.001-a&&$(r,it(r,e,.001),t),G(r,r,t),r);return r=>(r.renderStart=s(lt(n,r.renderStart)),r.renderEnd=s(lt(o,r.renderEnd)),r)}function Ks(i,t){const e=i.renderCoordsHelper;return a=>{const n=e.fromRenderCoords(a.renderStart,new se({spatialReference:t})),o=e.fromRenderCoords(a.renderEnd,new se({spatialReference:t}));return n!=null&&o!=null?{...a,mapStart:n,mapEnd:o}:null}}var fo;(function(i){i[i.GROUND=0]="GROUND",i[i.OTHER=1]="OTHER"})(fo||(fo={}));const cu=x(),hu=x(),bo=Ki();function la(i,t,e){const a=(n,o)=>{t({action:n,object:i,dxScreen:o.screenDeltaX,dyScreen:o.screenDeltaY})};return e((n,o,s)=>(o.next(r=>(r.action==="start"&&a("start",r),r)).next(Rc(i)).next(r=>{switch(r.action){case"start":case"update":(r.translationX||r.translationY||r.translationZ)&&a("update",r);break;case"end":a("end",r)}return r}),{steps:o,cancel:s=s.next(Dc(i)).next(r=>(a("end",{screenDeltaX:0,screenDeltaY:0}),r))}))}function tr(i){if((i==null?void 0:i.axis)==null)return 1;const{mapStart:t,mapEnd:e,axis:a}=i,n=[e.x-t.x,e.y-t.y];return n[0]*a[0]+n[1]*a[1]>0?1:-1}let uu=class extends Si{constructor(t){super(),this._handles=new ta,this._arrowManipulatorInfos=new Array,this._angle=0,this._scale=1,this._radius=kt,this._updateAfterDrag=!1,this.events=new Vt,this._tool=t.tool,this._view=t.view,this._opaqueMaterial=this._createMaterial(),this._transparentMaterial=this._createMaterial(.5),t.radius!=null&&(this._radius=t.radius),this._createManipulators(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}set orthogonalAvailable(t){this._arrowManipulatorInfos.length>=3&&(this._arrowManipulatorInfos[1].manipulator.available=t,this._arrowManipulatorInfos[3].manipulator.available=t)}destroy(){this._handles=V(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._arrowManipulatorInfos.length=0}forEachManipulator(t){for(const{manipulator:e}of this._arrowManipulatorInfos)t(e,R.TRANSLATE_XY)}createManipulatedObjectDragPipeline(t,e,a){if(!e.operations)return F();const n=e.operations.data.spatialReference,o=e.graphic;return la(e,a,s=>this.createDragPipeline((r,l,c,p,u)=>({steps:l,cancel:c}=t(r,l,c,p,u),s(r,l,c)),e.elevationInfo,n,o))}createDragPipeline(t,e,a,n){return et(this._arrowManipulatorInfos.map(({manipulator:o},s)=>Pt(o,(r,l,c,p,u)=>{const g=l.next(_=>({..._,manipulatorType:R.TRANSLATE_XY})).next(ri(this._view,r.elevationAlignedLocation)).next(vi(this._view,r.elevationAlignedLocation,e,a,n)).next(jc(r.location,this.angle+(s+1)*Math.PI*.5)).next(Ze());t(r,g,c,p,u)})))}get angle(){return this._angle}set angle(t){this._angle=t,this.dragging?this._updateAfterDrag=!0:this._updateManipulatorTransform()}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get radius(){return this._radius}set radius(t){this._radius!==t&&(this._radius=t,this._updateManipulators())}_updateManipulators(){for(let t=0;t<this._arrowManipulatorInfos.length;t++)this._updateArrowManipulator(this._arrowManipulatorInfos[t],t);this._updateManipulatorTransform()}_updateArrowManipulator({manipulator:t,transform:e},a){const n=this._radius/kt,o=Yh*n,s=o*Math.sqrt(3)/2,r=Bi(this._opaqueMaterial,s,o/2,o/2,Ws);vs(r,ki(tt.get(),W(f.get(),0,-s/3,0))),t.renderObjects=[new w(r,S.Focused),new w(r.instantiate({material:this._transparentMaterial}),S.Unfocused)],t.radius=s/3*2*1.2;const l=ts(tt.get(),a*Math.PI/2),c=ki(tt.get(),W(f.get(),0,Wh*n,0));Yt(e,l,c)}_createManipulators(){for(let t=0;t<4;t++){const e=this._createArrowManipulator(t);this._arrowManipulatorInfos.push(e)}this._updateManipulatorTransform()}_updateManipulatorTransform(){const t=this.angle,e=es(tt.get(),t,N(0,0,1));if(e==null)return;const a=Fi(tt.get(),W(f.get(),this.displayScale,this.displayScale,this.displayScale)),n=Yt(tt.get(),a,e);for(const o of this._arrowManipulatorInfos){const s=Yt(tt.get(),n,o.transform);o.manipulator.modelTransform=s}}_createArrowManipulator(t){const e=new ct({view:this._view,autoScaleRenderObjects:!1,worldOriented:!0,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:N(0,0,1)}}),a={manipulator:e,transform:vt()};return this._updateArrowManipulator(a,t),this._handles.add(e.events.on("drag",n=>{this._updateAfterDrag&&n.action==="end"&&!this.dragging&&(this._updateManipulatorTransform(),this._updateAfterDrag=!1)})),a}_createMaterial(t=1){const e=new Dt({cullFace:J.Back,renderOccluded:D.Transparent,isDecoration:!0});return this._handles.add(M(()=>nt.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>{a[3]*=t,e.setParameters({color:a})},j)),e}get test(){}},pu=class{constructor(){this._view=null,this._elevationInfo=null,this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&this._lastDragEvent!=null&&this._next!=null){const e=this._lastDragEvent.mapEnd,a=this._snap(this._lastDragEvent.screenEnd);if(a!=null){const n={action:"update",mapStart:this._lastDragEvent.mapStart,mapEnd:t===!0?a:e,screenStart:this._lastDragEvent.screenEnd,screenEnd:this._lastDragEvent.screenEnd};this._next.execute(n)}}this._enabled=t}_snap(t){const e=this._view!=null?this._view.toMap(t,{exclude:[]}):null;return e!=null&&this._view!=null&&(e.z=Ko(e,this._view,this._elevationInfo)),e}createDragEventPipelineStep(t,e){this._view=t,this._elevationInfo=e,this._lastDragEvent=null;const a=new na;return this._next=a,[n=>{if(this._lastDragEvent=n.action!=="end"?{...n}:null,this._enabled){const o=this._snap(n.screenEnd);return o!=null?{action:n.action,mapStart:n.mapStart,mapEnd:o,screenStart:n.screenStart,screenEnd:n.screenEnd}:null}return{action:n.action,mapStart:n.mapStart,mapEnd:n.mapEnd,screenStart:n.screenStart,screenEnd:n.screenEnd}},a]}},du=class extends Si{constructor(t){super(),this._handles=new ta,this._snapToScene=new pu,this._scale=1,this._radius=kt,this._view=t.view,this._tool=t.tool,this._discMaterial=this._createMaterial(),this._discMaterialTransparent=this._createMaterial(.5),t.snapToScene!=null&&(this.snapToScene=t.snapToScene),t.radius!=null&&(this._radius=t.radius),this._createManipulator(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles=V(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){t(this._manipulator,R.TRANSLATE_XY)}get displayScale(){return this._scale}set displayScale(t){this._scale=t,this._updateManipulatorTransform()}get snapToScene(){return this._snapToScene.enabled}set snapToScene(t){this._snapToScene.enabled=t}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}get discManipulator(){return this._manipulator}createManipulatedObjectDragPipeline(t,e,a){if(!e.operations)return F();const n=e.graphic,o=e.elevationInfo,s=e.operations.data.spatialReference;return la(e,a,r=>this.createDragPipeline((l,c,p,u,g)=>({steps:c,cancel:p}=t(l,c,p,u,g),r(l,c,p)),o,s,n))}createDragPipeline(t,e,a,n){const o=this._view;return Pt(this._manipulator,(s,r,l,c,p)=>{const u=r.next(ri(o,s.elevationAlignedLocation)).next(vi(o,s.elevationAlignedLocation,e,a,n)).next(...this._snapToScene.createDragEventPipelineStep(o,e)).next(g=>({...g,manipulatorType:R.TRANSLATE_XY})).next(Ze());t(s,u,l,c,p)})}_updateManipulatorTransform(){const t=Fi(tt.get(),W(f.get(),this.displayScale,this.displayScale,this.displayScale));this._manipulator.modelTransform=t}_createManipulator(){const t=this._view;this._manipulator=new ct({view:t,worldSized:!1,autoScaleRenderObjects:!1,focusMultiplier:1,touchMultiplier:1,collisionType:{type:"disc",direction:N(0,0,1)},worldOriented:!0}),this._updateManipulator()}_updateManipulator(){const t=kl(this._discMaterial,Ws,1,Ys,N(0,0,1),N(0,0,0));t.transformation=Fi(vt(),N(this._radius,this._radius,this._radius)),this._manipulator.renderObjects=[new w(t,S.Focused),new w(t.instantiate({material:this._discMaterialTransparent}),S.Unfocused)],this._manipulator.radius=Xh*(this._radius/kt)}_createMaterial(t=1){const e=new Dt({cullFace:J.Back,renderOccluded:D.Transparent,isDecoration:!0});return this._handles.add(M(()=>nt.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>{a[3]*=t,e.setParameters({color:a})},j)),e}get test(){}};function Xt(i,t=D.OccludeAndTransparent,e=!0){const a=is(i),n=!(i[3]<1);return e?new Ga({color:a,writeDepth:n,cullFace:J.Back,renderOccluded:t,isDecoration:!0}):new Dt({color:a,writeDepth:n,cullFace:J.Back,renderOccluded:t,isDecoration:!0})}function Qe(i,t=D.OccludeAndTransparent){const e=is(i);return new Dt({color:e,writeDepth:!0,cullFace:J.Front,renderOccluded:t,isDecoration:!0})}const er=Object.freeze({calloutLength:40,calloutWidth:1,discRadius:27,focusMultiplier:1.1}),gu=Object.freeze({autoScaleRenderObjects:!1,worldSized:!0});function ir(i,t,e,a){const n=$(f.get(),i,e),o=ar(n,St(f.get(),a,n),e,tt.get());el(o,o);const s=De(f.get(),t,o);return Math.atan2(s[1],s[0])}function ar(i,t,e,a){const n=ut(f.get(),i),o=ut(f.get(),t),s=St(f.get(),n,o);return a[0]=n[0],a[1]=n[1],a[2]=n[2],a[3]=0,a[4]=o[0],a[5]=o[1],a[6]=o[2],a[7]=0,a[8]=s[0],a[9]=s[1],a[10]=s[2],a[11]=0,a[12]=e[0],a[13]=e[1],a[14]=e[2],a[15]=1,a}function _u(i,t){const e=i.getViewForGraphic(t);return e!=null&&"computeAttachmentOrigin"in e?e.computeAttachmentOrigin(t,i.spatialReference):null}function nr(i,t){const e=t.origin;e==null?mu(i,U(t)):i.elevationAlignedLocation=e}function mu(i,t){if(t==null)return;const e=t.type==="mesh"?t.anchor:Bl(t);e!=null&&(i.location=Vc(e))}let vu=class extends Si{constructor(t){super(),this._radius=kt,this.events=new Vt,this._tool=t.tool,this._view=t.view;const e=new Oe({getTheme:()=>this._view.effectiveTheme});this._settings=e,t.radius!=null&&(this._radius=t.radius);const a=this._view.effectiveTheme.accentColor;this._materials={materialUnfocused:Xt(te(a,1,.25),D.Occlude),materialFocused:Xt(te(a,1,0),D.Occlude),materialOccludedUnfocused:Xt(te(a,.7,0),e.zManipulator.renderOccluded),materialOccludedFocused:Xt(te(a,.85,0),e.zManipulator.renderOccluded)},this._themeHandle=M(()=>this._view.effectiveTheme.accentColor,n=>{const o=te(n,1,.25),s=te(n,1,0),r=te(n,.7,0),l=te(n,.85,0),{materialUnfocused:c,materialFocused:p,materialOccludedUnfocused:u,materialOccludedFocused:g}=this._materials;c.setParameters({color:o}),p.setParameters({color:s}),u.setParameters({color:r}),g.setParameters({color:l})}),this._createManipulator(),this.forEachManipulator(n=>this._tool.manipulators.add(n))}destroy(){this._themeHandle=Ft(this._themeHandle),this._manipulator.applyObjectTransform=bu,this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){t(this._manipulator,R.TRANSLATE_Z)}createManipulatedObjectDragPipeline(t,e,a){if(!e.operations)return F();const n=e.operations.data.spatialReference;return la(e,a,o=>this.createDragPipeline((s,r,l,c,p)=>({steps:r,cancel:l}=t(s,r,l,c,p),o(s,r,l)),n))}createDragPipeline(t,e){const a=this._view;return Pt(this._manipulator,(n,o,s,r,l)=>{const c=o.next(p=>({...p,manipulatorType:R.TRANSLATE_Z})).next(Js(a,n.renderLocation,e)).next(Ze());t(n,c,s,r,l)})}get radius(){return this._radius}set radius(t){t!==this._radius&&(this._radius=t,this._updateManipulator())}_updateManipulator(){const t=this._settings,e=this._radius/kt,a=t.zManipulator.height*e,n=t.zManipulator.coneHeight*e,o=t.zManipulator.coneWidth*e,s=t.zManipulator.width*e,r=[N(0,0,0),N(0,0,a)],l=[N(0,0,0),N(0,0,a+n)],c=(b=>{const y=vt();return Pa(y,y,[0,0,a]),as(y,y,Math.PI/2),y})(),{materialUnfocused:p,materialFocused:u,materialOccludedUnfocused:g,materialOccludedFocused:_}=this._materials,m=Nl(p,r,s/2,16,!1),v=Ha(p,n,o/2,16,!1);v.transformation=c,this._manipulator.renderObjects=[new w(v,S.Unfocused),new w(m,S.Unfocused),new w(v.instantiate({material:u}),S.Focused),new w(m.instantiate({material:u}),S.Focused),new w(v.instantiate({material:g}),S.Unfocused),new w(m.instantiate({material:g}),S.Unfocused),new w(v.instantiate({material:_}),S.Focused),new w(m.instantiate({material:_}),S.Focused)],this._manipulator.radius=s/2+2,this._manipulator.collisionType={type:"line",paths:[l]}}_createManipulator(){const t=this._view,e=new ct({view:t,autoScaleRenderObjects:!1,worldSized:!1,selectable:!1,cursor:"ns-resize",elevationInfo:this.elevationInfo,worldOriented:!0,collisionPriority:1.6});e.applyObjectTransform=a=>{const n=t.state.camera,o=yo;t.renderCoordsHelper.toRenderCoords(this._manipulator.elevationAlignedLocation,o);const s=il(n.eye,o),r=n.computeRenderPixelSizeAtDist(s),l=$(Ie,o,n.eye);ut(l,l);const c=fu;t.renderCoordsHelper.worldUpAtPosition(yo,c);const p=Math.abs(di(l,c)),u=St(Ie,l,c),g=St(Ie,u,c),_=Hi(p,.01,1),m=1-Math.sqrt(1-_*_)/_/n.fullWidth,v=this._settings,b=this._radius/kt,y=v.zManipulator.width*b;it(g,ut(g,g),(1/m-1)*s+r*y),a[12]-=Ie[0],a[13]-=Ie[1],a[14]-=Ie[2]},this._manipulator=e,this._updateManipulator()}get test(){}};function te(i,t,e){const a=al(i,e);return a.a*=t,nt.toUnitRGBA(a)}const yo=x(),Ie=x(),fu=x(),bu=()=>{};let Se=class extends Si{constructor(t){super(),this._handles=new ta,this._interactive=!0;const{tool:e,view:a,snapToScene:n,radius:o}=t;this._view=a,this.xyManipulation=new du({tool:e,view:a,snapToScene:n,radius:o}),this.xyAxisManipulation=new uu({tool:e,view:a,radius:o}),this.zManipulation=new vu({tool:e,view:a,radius:o}),this.xyManipulation.available=t.xyAvailable,this.xyAxisManipulation.available=t.xyAxisAvailable,this.zManipulation.available=t.zAvailable,this._autoHideXYAxis(),this.forEachManipulator(s=>this._handles.add(s.events.on("grab-changed",()=>this._updateManipulatorInteractivity())))}destroy(){this._handles.destroy(),this.xyManipulation.destroy(),this.xyAxisManipulation.destroy(),this.zManipulation.destroy()}createManipulatedObjectDragPipeline(t,e,a){return et([this.xyManipulation.createManipulatedObjectDragPipeline((n,o,s,r,l)=>t(P.XY,n,o,s,r,l),e,a),this.xyAxisManipulation.createManipulatedObjectDragPipeline((n,o,s,r,l)=>t(P.XY_AXIS,n,o,s,r,l),e,a),this.zManipulation.createManipulatedObjectDragPipeline((n,o,s,r,l)=>t(P.Z,n,o,s,r,l),e,a)])}createDragPipeline(t,e,a,n){return et([this.xyManipulation.createDragPipeline((o,s,r,l,c)=>t(P.XY,o,s,r,l,c),e,a,n),this.xyAxisManipulation.createDragPipeline((o,s,r,l,c)=>t(P.XY_AXIS,o,s,r,l,c),e,a,n),this.zManipulation.createDragPipeline((o,s,r,l,c)=>t(P.Z,o,s,r,l,c),a)])}set snapToScene(t){this.xyManipulation.snapToScene=t}set angle(t){this.xyAxisManipulation.angle=t}set interactive(t){this._interactive!==t&&(this._interactive=t,this._updateManipulatorInteractivity())}set radius(t){this.xyAxisManipulation.radius=t,this.xyManipulation.radius=t,this.zManipulation.radius=t}set displayScale(t){this.xyManipulation.displayScale=t,this.xyAxisManipulation.displayScale=t}forEachManipulator(t){this.xyManipulation.forEachManipulator(e=>t(e,R.TRANSLATE_XY)),this.xyAxisManipulation.forEachManipulator(e=>t(e,R.TRANSLATE_XY)),this.zManipulation.forEachManipulator(e=>t(e,R.TRANSLATE_Z))}get _xyAxisVisible(){const t=this.xyManipulation.someManipulator(e=>e.focused)||this.xyAxisManipulation.someManipulator(e=>e.focused);return this._view.inputManager&&this._view.inputManager.latestPointerType==="touch"||t}_autoHideXYAxis(){const t=this.xyAxisManipulation,e=this.xyManipulation;if(ns("esri-mobile"))return;const a=[];e.forEachManipulator(o=>a.push(o)),t.forEachManipulator(o=>a.push(o));const n=()=>{const o=[];this._xyAxisVisible||t.forEachManipulator(s=>o.push(s.disableDisplay())),this._handles.remove(Mo),this._handles.add(o,Mo)};for(const o of a)this._handles.add(o.events.on("focus-changed",n));this._view.inputManager&&this._handles.add(Ne(()=>{var o;return(o=this._view.inputManager)==null?void 0:o.latestPointerType},n)),n()}_updateManipulatorInteractivity(){const t=this.grabbing;this.forEachManipulator(e=>{e.interactive=!t&&this._interactive||e.grabbing})}static radiusForSymbol(t){const e=t!=null&&t.type==="point-3d"&&t.symbolLayers;return e&&e.some(a=>a.type==="icon")?qs:kt}};const Mo="disable-xy-axis-display";var P;(function(i){i[i.XY=0]="XY",i[i.XY_AXIS=1]="XY_AXIS",i[i.Z=2]="Z"})(P||(P={}));let gn=class extends Si{constructor(t){var e,a;super(),this._view=t.view,this._tool=t.tool,this._object=t.object,this._manipulator=(a=(e=this._object).createManipulator)==null?void 0:a.call(e,{selectable:!0,cursor:"move"}),this.forEachManipulator(n=>this._tool.manipulators.add(n))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulator=null}forEachManipulator(t){this._manipulator&&t(this._manipulator,R.TRANSLATE_XY)}createManipulatedObjectDragPipeline(t){return la(this._object,t,e=>this.createDragPipeline(e))}createDragPipeline(t){if(!this._manipulator)return F();const e=this._view;return Pt(this._manipulator,(a,n,o,s,r)=>{var p;const l=(p=this._object.operations)==null?void 0:p.data.spatialReference,c=n.next(u=>l?u:null).next(su(r,e,this._object,l)).next(Pe()).next(Ze());t(a,c,o,s,r)})}},Ce=class extends he{constructor(t){super(t),this.type="translate-xy",this.distance=xt}};h([d()],Ce.prototype,"type",void 0),h([d()],Ce.prototype,"distance",void 0),Ce=h([H("esri.views.interactive.tooltip.infos.TranslateXYTooltipInfo")],Ce);let ye=class extends he{constructor(t){super(t),this.type="translate-z",this.distance=xt}clear(){this.distance=xt}};h([d()],ye.prototype,"type",void 0),h([d()],ye.prototype,"distance",void 0),ye=h([H("esri.views.interactive.tooltip.infos.TranslateZTooltipInfo")],ye);class So{constructor(t){this.objects=t,this.type="move-start"}}class xo{constructor(t,e,a){this.dx=t,this.dy=e,this.objects=a,this.type="move"}}let ba=class{constructor(t){this.objects=t,this.type="move-stop"}};const zt=Symbol("manipulators"),wo=Symbol("tooltips");let ft=class extends oa{constructor(i){super(i),this._infos=new Map,this.events=new Vt,this.objects=new nl,this.enableZ=!0,this.sketchOptions=new ce,this.type="move-3d",this._latestTooltipInfo=null,this._translateTooltipInfo=null,this._translateXYTooltipInfo=null,this._translateZTooltipInfo=null,this._updatingHandles=new ea,this._moveManipulation=null}initialize(){const{view:i}=this;this.tooltip=new yi({view:i}),this.addHandles([this.objects.on("change",e=>{e.removed.forEach(a=>this.removeHandles(a)),this._updateObjectInfos(e),this._setupFastTransformUpdates(e.added),this._refreshManipulators()}),this.objects.on("change",()=>this._connectTooltips())]);const t=this.objects.toArray();this._updateObjectInfos({added:t,removed:[]}),this._setupFastTransformUpdates(t),this._refreshManipulators(),this._connectTooltips(),this.finishToolCreation()}destroy(){this.tooltip=V(this.tooltip),this._moveManipulation=V(this._moveManipulation),this._set("view",null),this._updatingHandles.destroy()}onInputEvent(i){if(!this.destroyed&&!sn(i,this.tooltip))return super.onInputEvent(i)}get updating(){return this._updatingHandles.updating}get _shouldShowMovePointTooltip(){var e;const{objects:i}=this;if(i.length!==1)return!1;const t=(e=U(i.at(0)))==null?void 0:e.type;return t==="point"||t==="mesh"}get activeTooltipInfo(){return this._shouldShowMovePointTooltip?this._movePointTooltipInfo:this._latestTooltipInfo}reset(){}_updateObjectInfos({added:i,removed:t}){for(const e of i){if(ol(e)!==sl.SUPPORTED)continue;const a=new yu(e);this._infos.set(e,a)}for(const e of t)this._infos.delete(e)}_setupFastTransformUpdates(i){for(const t of i){const e=this._infos.get(t);this.addHandles(un(e.object),t)}}_refreshManipulators(){if(this.removeHandles(zt),this._moveManipulation=V(this._moveManipulation),this.manipulators.removeAll(),this._infos.size===0)return;const i=Array.from(this._infos.values());this._createManipulators(i),this._createVisualElements(i),this._updateMoveManipulation(i)}_createManipulators(i){for(const t of i){const e=t.object;t.manipulationXY=new gn({tool:this,view:this.view,object:e}),t.manipulationXY.forEachManipulator(a=>{this.addHandles([a.events.on("immediate-click",n=>{this.events.emit("immediate-click",{...n,object:e}),n.stopPropagation()}),a.events.on("grab-changed",({action:n})=>{n==="start"?this._showTooltip(P.XY):this._hideTooltip()})],zt)}),this.addHandles(t.manipulationXY.createDragPipeline((a,n,o,s)=>this._buildDragEventPipeline(i,P.XY,a,n,o,s)),zt)}this._createMoveManipulation(i)}_createMoveManipulation(i){var r;const t=new Se({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:i.length===1?Se.radiusForSymbol((r=i[0].object.graphic)==null?void 0:r.symbol):kt});this._moveManipulation=t,t.elevationInfo={mode:"absolute-height",offset:0},t.forEachManipulator(l=>{this.addHandles(l.events.on("immediate-click",c=>{const p=this.objects.at(0);!t.zManipulation.hasManipulator(l)&&this.objects.length===1&&p&&this.events.emit("immediate-click",{...c,object:p}),c.stopPropagation()}),zt)});const e=l=>c=>{this.addHandles([c.events.on("focus-changed",({action:p})=>{p==="focus"?this._showTooltip(l):this._hideTooltip()}),c.events.on("grab-changed",()=>{this._latestTooltipInfo&&(this._latestTooltipInfo.distance=xt)})],zt)};this._moveManipulation.xyManipulation.forEachManipulator(e(P.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(e(P.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(e(P.Z));const a=()=>this._updateMoveManipulation(i);for(const l of i)this.addHandles([l.object.on("committed",a),M(()=>l.object.visible,a)],zt);const n=i[i.length-1];this.addHandles(n.object.on("committed",()=>this._updateMoveManipulationAngle(n)),zt);const{object:o}=n,{operations:s}=o;if(s){const l=o.graphic;this.addHandles(t.createDragPipeline((c,p,u,g,_)=>this._buildDragEventPipeline(i,c,p,u,g,_),o.elevationInfo,s.data.spatialReference,l),zt)}this._updateMoveManipulationAngle(n)}_createVisualElements(i){for(const t of i){const e=t.object,a=sa({view:this.view,object:e,forEachManipulator:n=>{var o,s;(o=t.manipulationXY)==null||o.forEachManipulator(n),(s=this._moveManipulation)==null||s.forEachManipulator(n)},onManipulatorsChanged:()=>F()});a!=null&&(t.geometryRepresentation=a.visualElement,t.geometryRepresentation instanceof we&&this.addHandles([t.geometryRepresentation.events.on("attachment-origin-changed",()=>{t.object.isDraped||this._updateMoveManipulation(i)}),M(()=>t.object.isDraped,()=>this._updateMoveManipulation(i))],zt),this.addHandles(a,zt))}}_updateMoveManipulationAngle(i){this._moveManipulation&&(this._moveManipulation.angle=pn(U(i.object)))}_updateMoveManipulation(i){const t=Ue(0,0,0,this.view.spatialReference);let e=0,a=!1;const n=this._moveManipulation;if(n){for(const o of i){if(!o.object.visible)continue;this.enableZ&&Me(o.object.operations,o.object.elevationInfo)&&(a=!0);const s=o.geometryRepresentation instanceof we&&!o.object.isDraped?o.geometryRepresentation.attachmentOrigin:o.object.origin;if(s!=null){const{x:r,y:l,z:c}=s;t.x+=r,t.y+=l,c&&(t.z??(t.z=0),t.z+=c),e++}}e>0?(t.x/=e,t.y/=e,t.z??(t.z=0),t.z/=e,n.location=t,n.xyManipulation.available=!0,n.xyAxisManipulation.available=!0,n.zManipulation.available=a):n.available=!1}}_buildDragEventPipeline(i,t,e,a,n,o){const s=[],r=[];let l=null,c=null;const p=()=>{for(const u of s)u.dragging=!1;s.length=0,r.length=0,l=null,c=null,this._moveManipulation&&(this._moveManipulation.interactive=!0)};if(i.length===1&&t===P.XY){const u=i[0].object;({steps:a,cancel:n}=this._buildSnappingPipelineSteps(u,u.elevationInfo,a,n,o))}return n=n.next(u=>c==null?void 0:c(u)).next(()=>(r.length&&this.events.emit("move-stop",new ba(r)),this.destroyed||p(),null)),{steps:a=a.next(u=>{var g,_;if(u.action==="start"){s.length=0,r.length=0;for(const m of i)m.dragging||!((g=m.manipulationXY)!=null&&g.hasManipulator(e))&&((_=m.manipulationXY)!=null&&_.grabbing)||(s.push(m),r.push(m.object),m.dragging=!0);if(r.length!==0&&(this._moveManipulation&&(this._moveManipulation.interactive=!1),l=Pc(r),c=Cc(r),this._emitRecordUndo(),this.events.emit("move-start",new So(r)),this.destroyed))return null}return r.length!==0?u:null}).next(u=>l==null?void 0:l(u)).next(u=>(this._updateMoveTooltip(t,u),u)).next(u=>{switch(u.action){case"start":case"update":if(u.translationX||u.translationY||u.translationZ){const g=this.view.toScreen(u.mapStart),_=this.view.toScreen(u.mapEnd),m=_.x-g.x,v=_.y-g.y;if(this.events.emit("move",new xo(m,v,r)),this.destroyed)return null}break;case"end":if(this.events.emit("move-stop",new ba(r)),this.destroyed)return null;p()}return null}),cancel:n}}_connectTooltips(){let i;if(this.removeHandles(wo),this._shouldShowMovePointTooltip){const t=this.objects.at(0),{events:e}=this;this._movePointTooltipInfo??(this._movePointTooltipInfo=new zs({viewType:this.view.type,sketchOptions:this.sketchOptions}));const a={onMoveStart:()=>{this._emitRecordUndo(),e.emit("move-start",new So([t]))},onMove:()=>e.emit("move",new xo(0,0,[t])),onMoveStop:()=>e.emit("move-stop",new ba([t]))};i=Gs(this.tooltip,t,()=>({sketchOptions:this.sketchOptions,activeTooltipInfo:this._movePointTooltipInfo,callbacks:a}))}else i=M(()=>this.sketchOptions.tooltips.effectiveEnabled?this._latestTooltipInfo:null,t=>{this.tooltip.info=t},ke);this.addHandles(i,wo)}_showTooltip(i){this._shouldShowMovePointTooltip||this._updateMoveTooltip(i)}_hideTooltip(){var i;this._shouldShowMovePointTooltip||((i=this.tooltip)==null||i.clear(),this._latestTooltipInfo=null)}_updateMoveTooltip(i,t){if(this._shouldShowMovePointTooltip)return;const{sketchOptions:e}=this;switch(i){case P.XY:this._latestTooltipInfo=this._translateTooltipInfo??(this._translateTooltipInfo=new hn({sketchOptions:e})),ya(this._latestTooltipInfo,t,(a,n)=>Ui(a,n));break;case P.XY_AXIS:this._latestTooltipInfo=this._translateXYTooltipInfo??(this._translateXYTooltipInfo=new Ce({sketchOptions:e})),ya(this._latestTooltipInfo,t,(a,n)=>ss(Ui(a,n),tr(t)));break;case P.Z:this._latestTooltipInfo=this._translateZTooltipInfo??(this._translateZTooltipInfo=new ye({sketchOptions:e})),ya(this._latestTooltipInfo,t,hs)}this._latestTooltipInfo.sketchOptions=e}_emitRecordUndo(){const i=this.objects.toArray().map(t=>{var e;return(e=t.createUndoRecord)==null?void 0:e.call(t)}).filter(os);i.length>0&&this.events.emit("record-undo",{updates:i})}_buildSnappingPipelineSteps(i,t,e,a,n){const o=U(i);if(o==null||o.type!=="point"&&o.type!=="mesh")return{steps:e,cancel:a};const s=(o.type==="point"?o:o.anchor).clone(),r=new Yi({elevationInfo:t,pointer:n,editGeometryOperations:rn.fromGeometry(s,this.view.state.viewingMode),visualizer:new mi,excludeFeature:i.graphic}),l=this.snappingManager,{snappingStep:c,cancelSnapping:p}=Wi({snappingContext:r,snappingManager:l,updatingHandles:this._updatingHandles});return a=a.next(p),{steps:e=e.next(u=>(s.z=rl(this.view,s,i.elevationInfo,{mode:"absolute-height",offset:0}),{...u,snapOrigin:r.coordinateHelper.pointToVector(s)})).next(...c),cancel:a}}};h([d({constructOnly:!0,nonNullable:!0})],ft.prototype,"view",void 0),h([d()],ft.prototype,"objects",void 0),h([d({constructOnly:!0,nonNullable:!0})],ft.prototype,"enableZ",void 0),h([d({constructOnly:!0,type:ce})],ft.prototype,"sketchOptions",void 0),h([d({constructOnly:!0})],ft.prototype,"snappingManager",void 0),h([d()],ft.prototype,"type",void 0),h([d()],ft.prototype,"updating",null),h([d()],ft.prototype,"_latestTooltipInfo",void 0),h([d()],ft.prototype,"_shouldShowMovePointTooltip",null),h([d()],ft.prototype,"activeTooltipInfo",null),ft=h([H("esri.views.3d.interactive.editingTools.move.MoveTool3D")],ft);class yu{constructor(t){this.object=t,this.geometryRepresentation=null,this.manipulationXY=null,this.dragging=!1}}function ya(i,t,e){if(t==null||t.action==="end")return void(i.distance=xt);const{mapStart:a,mapEnd:n}=t,o=e(a,n);i.distance=o??xt}function Oo(i,t,e){const a=e.mode==="on-the-ground"?kn.XY:kn.XYZ;return new pc(i,a,t,0)}function Eo(i,t,e){const a=x();if(!i.renderCoordsHelper.toRenderCoords(t,a))return null;const n=To(i,t,Be(e.plane)),o=To(i,t,e.edgeDirection);if(n==null||o==null)return null;const s=St(x(),n,o);return Ve(a,s,bi())}function To(i,t,e){const a=Ue(t.x+e[0],t.y+e[1],t.z+e[2],t.spatialReference),n=x(),o=x();return i.renderCoordsHelper.toRenderCoords(t,n)&&i.renderCoordsHelper.toRenderCoords(a,o)?rs(o,n,o):null}function Mu(i,t,e){const a=Be(i),n=rs(x(),t,e),o=St(x(),n,a),s=St(x(),n,o);return ll(n[0],n[1],n[2],0,o[0],o[1],o[2],0,s[0],s[1],s[2],0,0,0,0,1)}function Su(i,t,e){const a=e.projectToRenderScreen(i,Ra()),n=e.projectToRenderScreen(t,Ra());return a!=null&&n!=null?cl($(a,a,n)):0}let _e=class extends he{constructor(t){super(t),this.type="reshape-edge-offset",this.distance=xt,this.area=null,this.totalLength=null}};h([d()],_e.prototype,"type",void 0),h([d()],_e.prototype,"distance",void 0),h([d()],_e.prototype,"area",void 0),h([d()],_e.prototype,"totalLength",void 0),_e=h([H("esri.views.interactive.tooltip.infos.ReshapeEdgeOffsetTooltipInfo")],_e);function xu(i,t){const e=t==null?void 0:t.type;return{edgeOffset:new _e({sketchOptions:i,viewType:e}),movePoint:new zs({sketchOptions:i,viewType:e}),selectedVertex:new Fc({sketchOptions:i,viewType:e}),translate:new hn({sketchOptions:i,viewType:e}),translateXY:new Ce({sketchOptions:i,viewType:e}),translateZ:new ye({sketchOptions:i,viewType:e})}}function wu(i,t,e){function a(){const s=e(),r=s.sketchOptions.tooltips.effectiveEnabled?s.activeTooltipInfo:null;return{...s,activeTooltipInfo:r}}let n=!1;function o(s){n=!0,Tu(t,s),i.info=s.activeTooltipInfo,n=!1}return et([M(a,o,ke),M(()=>{const s=a(),{activeTooltipInfo:r}=s;if(r&&"key"in r)return{context:s,activeTooltipInfo:r,key:r.key,geometry:U(t)}},(s,r)=>{s&&!n&&r&&r.key!==s.key&&Ou(s.activeTooltipInfo,t,s.context)},pi),t.on("committed",()=>o(a())),Ts(i)])}function Ou(i,t,{selectedVertexManipulatorInfo:e,callbacks:a}){const n=U(t);switch(n==null?void 0:n.type){case"mesh":i.type==="move-point"&&Qi(i,n.origin,t,a);break;case"point":i.type==="move-point"&&Qi(i,n,t,a);break;case"polyline":case"polygon":i.type==="selected-vertex"&&Eu(i,e,t,a)}}function Eu(i,t,e,a){var r,l,c,p;if((t==null?void 0:t.type)!=="vertex")return;const{dx:n,dy:o,dz:s}=$s(i,t.manipulator.location);n===0&&o===0&&s===0||((r=a.onReshapeStart)==null||r.call(a),(l=e.operations)==null||l.moveVertices([t.handle],n,o,s,jt.NEW_STEP),(c=a.onReshape)==null||c.call(a),(p=a.onReshapeStop)==null||p.call(a))}function Tu(i,{activeTooltipInfo:t,selectedVertexManipulatorInfo:e,sketchOptions:a}){if(t)switch(t.sketchOptions=a,t==null?void 0:t.type){case"move-point":Us(t,i);break;case"selected-vertex":$u(t,e,i)}}function $u(i,t,e){var o;if(!i||i.type!=="selected-vertex")return;const a=t==null?void 0:t.manipulator.location;i.setLocationFromPoint(a),Bs(i,a,e);const n=(o=e.operations)==null?void 0:o.data.geometry;switch(n==null?void 0:n.type){case"polygon":i.geometryType="polygon",i.totalLength.visible=!1,i.area.actual=As(n);break;case"polyline":i.geometryType="polyline",i.totalLength.actual=us(n),i.area.visible=!1}}function Au(i,t,{sketchOptions:e,tooltipInfos:a}){let n=null;switch(i){case P.XY:n=a.translate,Ma(n,t,(o,s)=>Ui(o,s));break;case P.XY_AXIS:n=a.translateXY,Ma(n,t,(o,s)=>ss(Ui(o,s),tr(t)));break;case P.Z:n=a.translateZ,Ma(n,t,hs)}return n.sketchOptions=e,n}function Ma(i,t,e){if(t!=null&&t.action!=="end"){const{mapStart:a,mapEnd:n}=t,o=e(a,n);i.distance=o??xt}else i.distance=xt}function Iu(i,t,{sketchOptions:e,tooltipInfos:a}){var s;const n=a.edgeOffset;if(n.distance=xt,t!=null&&t.action!=="end"){const r=i.operations,{mapEnd:l,signedDistance:c,operation:p}=t;if(c!=null&&r!=null){const u=r.data.coordinateHelper,g=c*p.selectedArrow;n.distance=Ru(i.isDraped,g,l,p.plane,u)}}const o=(s=i.operations)==null?void 0:s.data.geometry;return n.area=(o==null?void 0:o.type)==="polygon"?As(o):null,n.totalLength=(o==null?void 0:o.type)==="polyline"?us(o):null,n.sketchOptions=e,n}function Ru(i,t,e,a,n){if(i){const o=n.toXYZ(n.pointToVector(e)),s=hl(a,o,f.get()),r=ul(s,o,n.spatialReference);if(r!=null)return Gi(r.value*Math.sign(t),r.unit)}return Gi(t*ls(e.spatialReference),"meters")}const $o=Symbol();let z=class extends le{get grabbingOrDragging(){return this._numGrabbing+this._numDragging>0}get _operations(){return this.object.operations}constructor(i){super(i),this._selectedIndex=0,this._manipulatorHandles=new ta,this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0,this._reshapeEventState=L.NONE,this._updatingHandles=new ea,this._recreatingManipulators=!1,this._settings=new Oe({getTheme:()=>this.view.effectiveTheme}),this.events=new Vt,this.activeTooltipInfo=null,this._vertexLaserLineVisualElement=null}initialize(){const{view:i}=this,t=this._settings.manipulators,e=t.vertex;this.tooltipInfos=xu(this._sketchOptions,i),this._vertexManipulatorMaterial=Xt(rt(e.color),e.renderOccluded),this._vertexManipulatorOutlineMaterial=Qe(rt(e.outlineColor),e.renderOccluded),this._vertexManipulatorHoverOutlineMaterial=Qe(rt(e.hoverOutlineColor),e.renderOccluded);const a=t.edge;this._edgeManipulatorMaterial=Xt(rt(a.color),a.renderOccluded),this._edgeManipulatorOutlineMaterial=Qe(rt(a.outlineColor),a.renderOccluded);const n=t.edgeOffset;this._edgeOffsetManipulatorMaterial=Xt(rt(n.color),n.renderOccluded,!1),this._edgeOffsetManipulatorHoverMaterial=Xt(rt(n.hoverColor),n.renderOccluded,!1);const o=t.selected;this._selectedManipulatorMaterial=Xt(rt(o.color),o.renderOccluded),this._selectedManipulatorOutlineMaterial=Qe(rt(o.outlineColor),o.renderOccluded),this._selectedManipulatorHoverOutlineMaterial=Qe(rt(o.hoverOutlineColor),o.renderOccluded),this.tooltip=new yi({view:i}),this.addHandles([M(()=>{const s=this._settings.manipulators;return{vertexSettings:s.vertex,edgeSettings:s.edge,edgeOffsetSettings:s.edgeOffset,selectedSettings:s.selected}},({vertexSettings:s,edgeSettings:r,edgeOffsetSettings:l,selectedSettings:c})=>{s.applyColor(this._vertexManipulatorMaterial),s.applyOutline(this._vertexManipulatorOutlineMaterial),s.applyHoverOutline(this._vertexManipulatorHoverOutlineMaterial),r.applyColor(this._edgeManipulatorMaterial),r.applyOutline(this._edgeManipulatorOutlineMaterial),l.applyColor(this._edgeOffsetManipulatorMaterial),l.applyHover(this._edgeOffsetManipulatorHoverMaterial),c.applyColor(this._selectedManipulatorMaterial),c.applyOutline(this._selectedManipulatorOutlineMaterial),c.applyHoverOutline(this._selectedManipulatorHoverOutlineMaterial)}),M(()=>this.object.visible,s=>{for(const r of this._manipulatorInfos)r.manipulator.available=s,r.type==="edge"&&"edgeManipulator"in r&&(r.edgeManipulator.available=s)}),M(()=>this._numGrabbing+this._numDragging===0,s=>this._toggleAutoHideManipulators(s)),M(()=>({labels:this._segmentLabels,enabled:this._sketchOptions.labels.enabled,edgeOffsetEnabled:this.enableEdgeOffset}),({labels:s,enabled:r,edgeOffsetEnabled:l})=>{s!=null&&(s.visible=r,s.edgeDistance=l?"far":"default")},j),wu(this.tooltip,this.object,()=>this._tooltipsContext),ai(()=>this._operations,"vertex-update",s=>{this._updateManipulatorPositions(s.vertices)},{onListenerAdd:()=>this._recreateManipulators()}),ai(()=>{var s;return(s=this._operations)==null?void 0:s.data},"change",s=>{s.operation!=="undo"&&s.operation!=="redo"||this._recreateManipulators()})])}destroy(){this._segmentLabels=V(this._segmentLabels),this.tooltip=V(this.tooltip),this._removeManipulators(),this._updatingHandles.destroy()}get updating(){return this._updatingHandles.updating}get manipulators(){return this.tool.manipulators}get view(){return this.tool.view}get object(){return this.tool.object}get enableZShape(){return this.tool.enableZShape}get enableDeleteVertices(){return this.tool.enableDeleteVertices}get enableZVertex(){return this.tool.enableZVertex}get autoHideManipulators(){return this.tool.autoHideManipulators}get enableMoveObject(){return this.tool.enableMoveObject}get enableMidpoints(){return this.tool.enableMidpoints}get enableEdgeOffset(){return this.tool.enableEdgeOffset}get _sketchOptions(){return this.tool.sketchOptions}get _accentColor(){return this.view.effectiveTheme.accentColor}removeSelectedVertices(){const i=this._manipulatorInfos.filter(t=>t.manipulator.selected&&t.type==="vertex");return this._removeVertices(i),i.length}onManipulatorSelectionChanged(){this.events.emit("manipulators-changed")}_removeManipulators(){this._manipulatorHandles.removeAll(),this._moveManipulation=V(this._moveManipulation),this._objectMoveManipulation=V(this._objectMoveManipulation),this.manipulators.removeAll(),this._manipulatorInfos=[],this._numGrabbing=0,this._numDragging=0}_createManipulators(i){if(this._operations==null)return;const t=this.object.elevationInfo;for(const e of this._operations.data.components){const a=i==null?void 0:i.byComponentIndex.get(e.index);for(const n of e.vertices){const o=a==null?void 0:a.has(n.index);this._createVertexOrEdgeManipulator(n,t,o)}for(const n of e.edges)this._createVertexOrEdgeManipulator(n,t)}this._createObjectMoveManipulation(),this._createMoveManipulation(t),this._createVisualElements()}get canRedo(){return this._operations!=null&&this._operations.canRedo}get canUndo(){return this._operations!=null&&this._operations.canUndo}redo(){var i;return(i=this._operations)==null?void 0:i.redo()}undo(){var i;return this.events.emit("undo"),(i=this._operations)==null?void 0:i.undo()}_recreateManipulators(){var i,t;if(!this._recreatingManipulators){if(this._recreatingManipulators=!0,this._removeManipulators(),this._resetTooltip(),this._operations&&((t=(i=this._segmentLabels)==null?void 0:i.context)==null?void 0:t.editGeometryOperations)===this._operations||(this._segmentLabels=V(this._segmentLabels)),this._createManipulators(),!this._segmentLabels&&this._operations){const e=this._sketchOptions.labels;this._segmentLabels=new qi({context:{view:this.view,editGeometryOperations:this._operations,elevationInfo:this.object.elevationInfo,labelOptions:e},visible:e.enabled})}this._recreatingManipulators=!1}}_perObjectManipulatorDragAction(i,t){if(t.action==="end")return t;let e=0;const a=[],n=this._manipulatorInfos.some(s=>s.type==="vertex"&&s.manipulator.selected),o=i===ze.SELECTED_OR_ALL&&n;for(const s of this._manipulatorInfos)s.type==="vertex"&&(s.manipulator.grabbing||o&&!s.manipulator.selected||a.push(s),e++);if(this._moveVertices(a,t),a.length===e){if(this._updateEventState(L.MOVING),this.destroyed)return t;this.events.emit("move",{type:"move",dx:t.screenDeltaX,dy:t.screenDeltaY,object:this.object})}else{if(this._updateEventState(L.RESHAPING),this.destroyed)return t;this.events.emit("reshape",{type:"reshape",object:this.object})}return t}_toggleAutoHideManipulators(i){this.autoHideManipulators&&(i?this.removeHandles($o):this.tool.manipulators.forEach(({manipulator:t})=>{var a;const e=(a=t.disableDisplay)==null?void 0:a.call(t);e&&this.addHandles(e,$o)}))}_isMultiVertexSelection(){return this._manipulatorInfos.reduce((i,t)=>t.type==="vertex"&&t.manipulator.selected?i+1:i,0)>1}_perVertexManipulatorDragAction(i){if(this._updateEventState(L.RESHAPING),this.destroyed)return;const{mapDeltaX:t,mapDeltaY:e,mapDeltaZ:a}=i;if(!t&&!e&&!a)return;const n=[];for(const o of this._manipulatorInfos)o.type==="vertex"&&(o.manipulator.selected&&!o.manipulator.grabbing||o===i.info)&&n.push(o);this._moveVertices(n,i,jt.ACCUMULATE_STEPS),this.events.emit("reshape",{type:"reshape",object:this.object})}_updateEventState(i){if(i===this._reshapeEventState)return!1;switch(i){case L.NONE:if(this._numGrabbing!==0||this._numDragging!==0)return!1;switch(this._reshapeEventState){case L.MOVING:this.events.emit("move",{type:"move-stop",dx:0,dy:0,object:this.object});break;case L.RESHAPING:this.events.emit("reshape",{type:"reshape-stop",object:this.object})}break;case L.MOVING:switch(this._reshapeEventState){case L.NONE:this.events.emit("move",{type:"move-start",dx:0,dy:0,object:this.object});break;case L.RESHAPING:this.events.emit("reshape",{type:"reshape-stop",object:this.object}),this.destroyed||this.events.emit("move",{type:"move-start",dx:0,dy:0,object:this.object})}break;case L.RESHAPING:switch(this._reshapeEventState){case L.NONE:this.events.emit("reshape",{type:"reshape-start",object:this.object});break;case L.MOVING:this.events.emit("move",{type:"move-stop",dx:0,dy:0,object:this.object}),this.destroyed||this.events.emit("reshape",{type:"reshape-start",object:this.object})}}if(this.destroyed)return!1;const t=this._reshapeEventState!==i;return this._reshapeEventState=i,t}_createObjectMoveManipulation(){const{tool:i,view:t,object:e,_operations:a}=this;if(a){if(this._objectMoveManipulation=new gn({tool:i,view:t,object:e}),this.enableMoveObject){let n=null;this._manipulatorHandles.add(this._objectMoveManipulation.createDragPipeline((o,s,r)=>{s.next(l=>this._trackNumDragging(l)).next(l=>(l.action==="start"&&(n=a.createUndoGroup()),l)).next(l=>this._perObjectManipulatorDragAction(ze.ALL,l)).next(l=>(this._updateTranslateObjectTooltip(P.XY,l),l)).next(l=>{l.action==="end"&&(this._resetTooltip(),n=Ft(n))}),r.next(()=>this._onDragCancel(!0,()=>n=Ft(n)))})),this._objectMoveManipulation.forEachManipulator(o=>this._manipulatorHandles.add(this._watchAndUpdateGrabState(o,!1)))}else this._objectMoveManipulation.forEachManipulator(n=>{n.grabbable=!1,n.cursor=null});this._objectMoveManipulation.forEachManipulator(n=>this._manipulatorHandles.add(n.events.on("immediate-click",o=>{this._manipulatorInfos.some(s=>s.manipulator.selected)?this._clearSelection():this.events.emit("immediate-click",{...o,object:this.object}),o.stopPropagation()})))}}_createMoveManipulation(i){var r;const{object:t,tool:e,view:a,_operations:n}=this;if(!n)return;this._moveManipulation=new Se({tool:e,view:a,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZShape&&Me(t.operations,t.elevationInfo),snapToScene:!1,radius:Se.radiusForSymbol((r=t.graphic)==null?void 0:r.symbol)}),this._moveManipulation.forEachManipulator(l=>this.addHandles([l.events.on("immediate-click",c=>{this._moveManipulation.zManipulation.hasManipulator(l)||this._manipulatorInfos.some(p=>p.manipulator.selected)||this.events.emit("immediate-click",{...c,object:this.object}),c.stopPropagation()}),this._watchAndUpdateGrabState(l,!1)]));const o=l=>c=>{this.addHandles(c.events.on("focus-changed",({action:p})=>{p==="focus"?this._updateTranslateTooltip(l):this._resetTooltip()}))};this._moveManipulation.xyManipulation.forEachManipulator(o(P.XY)),this._moveManipulation.xyAxisManipulation.forEachManipulator(o(P.XY_AXIS)),this._moveManipulation.zManipulation.forEachManipulator(o(P.Z)),this._moveManipulation.elevationInfo={mode:"absolute-height",offset:0};const s=n.data.spatialReference;this.addHandles([this._moveManipulation.createDragPipeline((l,c,p,u,g)=>{const{snappingStep:_,cancelSnapping:m}=Wi({predicate:v=>!!v.info,snappingManager:e.snappingManager,snappingContext:new Yi({editGeometryOperations:n,elevationInfo:i,pointer:g,excludeFeature:t.graphic,visualizer:new mi}),updatingHandles:this._updatingHandles,useZ:!1});return u=u.next(v=>(this._onDragCancel(),v)).next(m),{steps:p=p.next(v=>this._trackNumDragging(v)).next(v=>{const b=this._manipulatorInfos.filter(y=>y.type==="vertex"&&y.manipulator.selected);return v.manipulatorType===R.TRANSLATE_XY&&b.length===1?{...v,info:b[0],snapOrigin:b[0].handle.pos}:v}).next(Gn(this.view,i,t.graphic??void 0)).next(..._).next(Pe()).next(v=>this._perObjectManipulatorDragAction(ze.SELECTED_OR_ALL,v)).next(v=>(this._updateTranslateTooltip(l,v),v)),cancel:u}},i,s,t.graphic),M(()=>t.visible,()=>this._updateMoveManipulationPosition(),j),t.on("committed",()=>{this._recreatingManipulators||this._updateMoveManipulationPosition()}),M(()=>t.isDraped,l=>{this._updateMoveManipulationPosition();const c="align-move-manipulation";l?this.addHandles(this.view.elevationProvider.on("elevation-change",()=>this._updateMoveManipulationPosition()),c):this.removeHandles(c)},j)])}_createVisualElements(){const{object:i,view:t}=this,e=sa({view:t,object:i,forEachManipulator:n=>{if(!this.destroyed&&!this._recreatingManipulators){this._objectMoveManipulation.forEachManipulator(n),this._moveManipulation.forEachManipulator(n);for(const o of this._manipulatorInfos)n(o.manipulator,R.TRANSLATE_XY)}},onManipulatorsChanged:n=>this.events.on("manipulators-changed",n)});e!=null&&(this._outlineVisualElement=e.visualElement instanceof we?e.visualElement:null);const a=this._outlineVisualElement;if(a!=null){const n=()=>{i.isDraped||this._updateMoveManipulationPosition()};this._manipulatorHandles.add(ai(()=>a.events,"attachment-origin-changed",n,{onListenerAdd:n}))}this._manipulatorHandles.add(e)}_createEdgeOffsetManipulator(i,t=this.object.elevationInfo){var m;const e=this._operations;if(i.component.vertices.length<=2||!e)return null;const a=this._settings.manipulators.edgeOffset,n=a.size/2,o=n+a.collisionPadding,s=n/o,r=s*Math.sqrt(3)/2;this._edgeOffsetManipulatorGeometryInside==null&&(this._edgeOffsetManipulatorGeometryInside=Bi(this._edgeOffsetManipulatorMaterial,r,s/2,s/2,a.height,a.offset)),this._edgeOffsetManipulatorGeometryOutside==null&&(this._edgeOffsetManipulatorGeometryOutside=Bi(this._edgeOffsetManipulatorMaterial,-r,s/2,s/2,a.height,-a.offset));const l=[new w(this._edgeOffsetManipulatorGeometryInside.instantiate(),S.Unfocused),new w(this._edgeOffsetManipulatorGeometryInside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),S.Focused),new w(this._edgeOffsetManipulatorGeometryOutside.instantiate(),S.Unfocused),new w(this._edgeOffsetManipulatorGeometryOutside.instantiate({material:this._edgeOffsetManipulatorHoverMaterial}),S.Focused)],c=new ct({view:this.view,renderObjects:l,elevationInfo:t.mode!=="on-the-ground"||$n((m=this.object.graphic)==null?void 0:m.symbol)?{mode:"absolute-height",offset:0}:t,worldOriented:!1,focusMultiplier:1,radius:o,available:this.object.visible,collisionType:{type:"disc",direction:N(0,0,1)},collisionPriority:1,metadata:{deleting:!1}}),p=new ct({view:this.view,worldSized:!0,worldOriented:!1,available:this.object.visible,collisionPriority:-10,cursor:this.enableMoveObject?"move":"default",metadata:{deleting:!1}}),u={manipulator:c,handle:i,locationUpdateHandle:null,type:"edge",selectedIndex:0,edgeManipulator:p,elevationInfo:t,visibilityHandle:null};this._autoHideEdgeOffsetManipulator(u,a.minSquaredEdgeLength),this._updateEdgeOffsetManipulator(u);const g=[];for(const v of[i.leftVertex,i.rightVertex]){const b=this._getManipulatorInfoFromHandle(v);b!=null&&g.push(b.manipulator.events.on("location-update",()=>this._updateEdgeOffsetManipulator(u)))}u.locationUpdateHandle=et(g),this._manipulatorHandles.add(u.locationUpdateHandle,c),this._manipulatorHandles.add([this._watchAndUpdateGrabState(c,!0),this._watchAndUpdateGrabState(p,!0)],c),this._manipulatorHandles.add(Pt(c,this._createEdgeOffsetPipeline(u,t)),c),this._manipulatorHandles.add(Pt(p,(v,b,y,O)=>{if(O==="touch")this._createEdgeOffsetPipeline(u,t)(v,b,y);else if(this.enableMoveObject){const A=this.object.graphic,q=e.data.spatialReference;b.next(C=>this._trackNumDragging(C)).next(ri(this.view,v.elevationAlignedLocation)).next(vi(this.view,v.elevationAlignedLocation,t,q,A)).next(Ze()).next(Pe()).next(C=>this._perObjectManipulatorDragAction(ze.ALL,C)).next(C=>(this._updateTranslateObjectTooltip(P.XY,C),C)).next(C=>{C.action==="end"&&this._resetTooltip()}),y.next(()=>this._onDragCancel(!v.metadata.deleting))}}),c);const _=v=>{this._manipulatorInfos.some(b=>b.manipulator.selected)?this._clearSelection():this.events.emit("immediate-click",{...v,object:this.object}),v.stopPropagation()};return this._manipulatorHandles.add([c.events.on("immediate-click",_),p.events.on("immediate-click",_),c.events.on("focus-changed",({action:v})=>{v==="focus"?this._updateEdgeOffsetTooltip(null):this._resetTooltip()})],c),this._manipulatorInfos.push(u),this.manipulators.add(c),this.manipulators.add(p),this.events.emit("manipulators-changed"),u}_autoHideEdgeOffsetManipulator(i,t){const e=i.manipulator,a=i.edgeManipulator,n=()=>{i.visibilityHandle=Ft(i.visibilityHandle);const o=this._getManipulatorInfoFromHandle(i.handle.leftVertex),s=this._getManipulatorInfoFromHandle(i.handle.rightVertex),r=o!=null&&s!=null&&Su(o.manipulator.renderLocation,s.manipulator.renderLocation,this.view.state.camera)<t;(!e.focused&&!a.focused||r)&&(e.grabbable=!r,a.grabbable=!r,i.visibilityHandle=et([e.disableDisplay(),F(()=>{e.grabbable=!0,a.grabbable=this.enableMoveObject})]))};this._manipulatorHandles.add([e.events.on("focus-changed",n),a.events.on("focus-changed",n),F(()=>{Ft(i.visibilityHandle),a.metadata.deleting=!0,this.manipulators.remove(a)})],e),n()}_updateEdgeOffsetManipulator(i){if(!this._operations)return;this._updateManipulatorPosition(i);const{coordinateHelper:t}=this._operations.data,e=Eo(this.view,i.manipulator.elevationAlignedLocation,Oo(t,i.handle,i.manipulator.elevationInfo)),a=this._getManipulatorInfoFromHandle(i.handle.leftVertex),n=this._getManipulatorInfoFromHandle(i.handle.rightVertex);if(a==null||n==null)return;const o=a.manipulator.renderLocation,s=n.manipulator.renderLocation,r=e!=null?Mu(e,o,s):dl;i.manipulator.modelTransform=r,i.edgeManipulator.elevationAlignedLocation=i.manipulator.elevationAlignedLocation,i.edgeManipulator.modelTransform=r;const l=Mt($(Ai,o,s))/2;i.edgeManipulator.collisionType={type:"line",paths:[[[-l,0,0],[l,0,0]]]}}_createEdgeOffsetPipeline(i,t){return(e,a,n)=>{const o=this._operations;if(!o)return;this._clearSelection();const{step:s,cleanup:r}=this._initializeEdgeOffset(i,t,o);a.next(l=>this._trackNumDragging(l)).next(ri(this.view,e.elevationAlignedLocation)).next(s).next(nu(this.view)).next(Ks(this.view,o.data.spatialReference)).next(Pe()).next(Du()).next(this._applyEdgeOffsetStep(i)).next(this._showEdgeOffsetTooltip()).next(l=>{l.action==="end"&&r()}),n.next(()=>{e.metadata.deleting||(r(),this._onDragCancel())})}}_initializeEdgeOffset(i,t,e){const{view:a}=this,n=Oo(e.data.coordinateHelper,i.handle,t),o=e.createUndoGroup(),s=Eo(a,i.manipulator.elevationAlignedLocation,n);if(n.requiresSplitEdgeLeft){const _=this._getManipulatorInfoFromHandle(i.handle.leftVertex.leftEdge);_!=null&&this._splitEdgeManipulator(_,1)}if(n.requiresSplitEdgeRight){const _=this._getManipulatorInfoFromHandle(i.handle.rightVertex.rightEdge);_!=null&&this._splitEdgeManipulator(_,0)}const r=()=>new _l({paths:[[i.handle.leftVertex.pos,i.handle.rightVertex.pos]],spatialReference:e.data.spatialReference}),l=this._settings,c=new we({view:a,isDraped:this.object.isDraped,geometry:r(),elevationInfo:i.elevationInfo,width:l.visualElements.lineObjects.outline.width,attached:!1,isDecoration:!0});let p;const u=()=>{this._cleanEdgeOffsetCollapsedEdges(i),p=Ft(p)},g=this.events.on("undo",u);return p=et([M(()=>rt(this._accentColor),_=>c.color=_,j),mt(c),M(()=>this.object.isDraped,_=>c.isDraped=_),this.object.on("committed",()=>c.geometry=r()),o,g]),c.attached=!0,{step:_=>n==null||s==null?(u(),null):{..._,operation:n,plane:s},cleanup:u}}_applyEdgeOffsetStep(i){return t=>{if(this.destroyed||t.operation==null)return t;this._updateEventState(L.RESHAPING);const{mapDeltaX:e,mapDeltaY:a,mapDeltaZ:n}=t;return(e||a||n)&&(this._offsetEdge(i,t),this.events.emit("reshape",{type:"reshape",object:this.object})),t}}_showEdgeOffsetTooltip(){return i=>(i.signedDistance!=null&&this.object.operations?this._updateEdgeOffsetTooltip(i):this._resetTooltip(),i)}_cleanEdgeOffsetCollapsedEdges(i){var r,l;if(!this._operations)return;const t=(r=i.handle.leftVertex.leftEdge)==null?void 0:r.leftVertex,e=i.handle.leftVertex,a=(l=i.handle.rightVertex.rightEdge)==null?void 0:l.rightVertex,n=i.handle.rightVertex,o=this._operations.data.coordinateHelper,s=[];if(t&&o.distance(t.pos,e.pos)<Sa){const c=this._getManipulatorInfoFromHandle(e);c!=null&&s.push(c)}if(o.distance(e.pos,n.pos)<Sa||a&&o.distance(a.pos,n.pos)<Sa){const c=this._getManipulatorInfoFromHandle(n);c!=null&&s.push(c)}s.length&&this._removeVertices(s)}_createVertexOrEdgeManipulator(i,t=this.object.elevationInfo,e=!1){var u;const{view:a,_operations:n}=this;if(!n)return null;const o=this._settings;if(i.type==="edge"){if(this.enableEdgeOffset)return this._createEdgeOffsetManipulator(i,t);if(!this.enableMidpoints)return null}if(this._vertexManipulatorGeometry==null||this._vertexManipulatorOutlineGeometry==null){const{size:g,outlineSize:_}=Ao(o.manipulators.vertex);this._vertexManipulatorGeometry=ti(this._vertexManipulatorMaterial,g,16,16),this._vertexManipulatorOutlineGeometry=ti(this._vertexManipulatorOutlineMaterial,_,16,16)}if(this._edgeManipulatorGeometry==null||this._edgeManipulatorOutlineGeometry==null){const{size:g,outlineSize:_}=Ao(o.manipulators.edge);this._edgeManipulatorGeometry=ti(this._edgeManipulatorMaterial,g,16,16),this._edgeManipulatorOutlineGeometry=ti(this._edgeManipulatorOutlineMaterial,_,16,16)}const s=(u=this._operations)==null?void 0:u.data.type,r=s==="point"||s==="mesh"?[]:[new w(this._vertexManipulatorGeometry.instantiate(),$t.Vertex|S.Unselected),new w(this._vertexManipulatorOutlineGeometry.instantiate(),$t.Vertex|S.Unfocused|S.Unselected),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),$t.Vertex|S.Focused|S.Unselected),new w(this._vertexManipulatorGeometry.instantiate({material:this._selectedManipulatorMaterial}),S.Selected),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorOutlineMaterial}),S.Selected|S.Unfocused),new w(this._vertexManipulatorOutlineGeometry.instantiate({material:this._selectedManipulatorHoverOutlineMaterial}),S.Selected|S.Focused)];this.enableMidpoints&&r.push(new w(this._edgeManipulatorGeometry.instantiate({material:this._vertexManipulatorMaterial}),$t.Edge|S.Focused|S.Unselected),new w(this._edgeManipulatorOutlineGeometry.instantiate({material:this._vertexManipulatorHoverOutlineMaterial}),$t.Edge|S.Focused|S.Unselected),new w(this._edgeManipulatorGeometry.instantiate(),$t.Edge|S.Unfocused|S.Unselected),new w(this._edgeManipulatorOutlineGeometry.instantiate(),$t.Edge|S.Unfocused|S.Unselected));const l=new ct({view:a,renderObjects:r,elevationInfo:t,focusMultiplier:1,touchMultiplier:1,available:this.object.visible,metadata:{deleting:!1}});l.selected=e,this._setTypeSpecificManipulatorSettings(l,i,t);const c=i.type==="edge"?{manipulator:l,handle:i,locationUpdateHandle:null,type:"edge",selectedIndex:0}:{manipulator:l,handle:i,type:"vertex",selectedIndex:0};if(this._manipulatorInfos.push(c),this.manipulators.add(l),this._updateManipulatorPosition(c),c.type==="edge"){const g=[];for(const _ of[c.handle.leftVertex,c.handle.rightVertex]){const m=this._getManipulatorInfoFromHandle(_);m!=null&&g.push(m.manipulator.events.on("location-update",()=>this._updateManipulatorPosition(c)))}c.locationUpdateHandle=et(g),this._manipulatorHandles.add(c.locationUpdateHandle,l)}this._manipulatorHandles.add(this._watchAndUpdateGrabState(l,!0),l);const p=Pt(l,(g,_,m,v)=>{let b=null;const{snappingStep:y,cancelSnapping:O}=Wi({predicate:()=>!this._isMultiVertexSelection(),snappingManager:this.tool.snappingManager,snappingContext:new Yi({editGeometryOperations:n,elevationInfo:t,pointer:v,excludeFeature:this.object.graphic,visualizer:new mi}),updatingHandles:this._updatingHandles,useZ:!1});m=m.next(A=>(this._onDragCancel(!g.metadata.deleting,()=>b=Ft(b)),A)).next(O),_.next(A=>this._trackNumDragging(A)).next(A=>{if(A.action==="start"&&this._operations&&(b=this._operations.createUndoGroup()),c.type==="edge"){const q=this._splitEdgeManipulator(c);return{...A,info:q,snapOrigin:q.handle.pos}}return{...A,info:c,snapOrigin:c.handle.pos}}).next(ri(this.view,g.elevationAlignedLocation)).next(vi(this.view,g.elevationAlignedLocation,this.object.elevationInfo,g.location.spatialReference,this.object.graphic)).next(Gn(this.view,t,this.object.graphic??void 0)).next(...y).next(Pe()).next(A=>{this._perVertexManipulatorDragAction(A),A.action==="end"&&(b=Ft(b)),this._resetTooltip()})});return this._manipulatorHandles.add([p,l.events.on("immediate-click",g=>this._manipulatorClickCallback(g,c)),l.events.on("select-changed",()=>{c.selectedIndex=++this._selectedIndex,this._updateMoveManipulationPosition(),this._resetTooltip()}),l.events.on("focus-changed",()=>{this._resetTooltip()})],l),this.events.emit("manipulators-changed"),c}_trackNumDragging(i){switch(i.action){case"start":this._numDragging++;break;case"end":this._numDragging--}return i}_onDragCancel(i=!0,t){switch(this._numDragging--,i&&this.undo(),this.tool.snappingManager!=null&&this.tool.snappingManager.doneSnapping(),this._resetTooltip(),this._reshapeEventState){case L.NONE:break;case L.MOVING:this.events.emit("move",{type:"move",dx:0,dy:0,object:this.object});break;case L.RESHAPING:this.events.emit("reshape",{type:"reshape",object:this.object})}t&&t(),this.destroyed||this._updateEventState(L.NONE)}_setTypeSpecificManipulatorSettings(i,t,e){var n,o;const a=this._settings;switch(t.type){case"vertex":{i.state=$t.Vertex,i.selectable=!0,i.cursor="move",i.collisionPriority=2;const{size:s,collisionPadding:r}=a.manipulators.vertex;i.radius=s/2+r,i.elevationInfo=e;const l=(n=this._operations)==null?void 0:n.data.type;i.interactive=l!=null&&l!=="point"&&l!=="mesh";break}case"edge":{i.state=$t.Edge,i.selectable=!1,i.cursor="copy",i.collisionPriority=-1;const{size:s,collisionPadding:r}=a.manipulators.edge;i.radius=s/2+r,i.elevationInfo=e.mode!=="on-the-ground"||$n((o=this.object.graphic)==null?void 0:o.symbol)?{mode:"absolute-height",offset:0}:e;break}}}_watchAndUpdateGrabState(i,t){return i.events.on("grab-changed",e=>this._onGrabStateChanged(i,t,e.action,e.pointerType))}_onGrabStateChanged(i,t,e,a="mouse"){if(!this._recreatingManipulators){if(e==="start")t&&this._updateSelection(i),this._numGrabbing++;else if(this._numGrabbing--,this._updateEventState(L.NONE),this.destroyed)return;this._moveManipulation.interactive=!this._numGrabbing,(a!=="touch"||this.enableEdgeOffset)&&(this._manipulatorInfos.forEach(n=>{var r;const{manipulator:o}=n,s=(r=this._operations)==null?void 0:r.data.type;o.interactive=o.grabbing||!this._numGrabbing&&s!=null&&s!=="point"&&s!=="mesh","edgeManipulator"in n&&(n.edgeManipulator.interactive=n.edgeManipulator.grabbing||!this._numGrabbing)}),this._objectMoveManipulation.forEachManipulator(n=>{n.interactive=n.grabbing||!this._numGrabbing}))}}_clearSelection(){for(const i of this._manipulatorInfos)i.manipulator.grabbing||(i.manipulator.selected=!1)}_updateSelection(i){i.grabbing&&!i.selected&&i.selectable&&(this._clearSelection(),i.selected=!0,this.events.emit("manipulators-changed"))}_removeManipulator(i){i!=null&&(i.manipulator.metadata.deleting=!0,this.manipulators.remove(i.manipulator),this._manipulatorHandles.remove(i.manipulator),gl(this._manipulatorInfos,i),this.events.emit("manipulators-changed"),this._resetTooltip())}_getManipulatorInfoFromHandle(i){if(i){for(const t of this._manipulatorInfos)if(i===t.handle)return t}return null}_updateManipulatorPositions(i){for(const t of i)this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(t))}_updateManipulatorPosition(i){const t=this._operations;if(i!=null&&t){if(i.type==="vertex")i.manipulator.location=t.data.coordinateHelper.vectorToDehydratedPoint(i.handle.pos,Je),i.manipulator.grabbing&&this._vertexLaserLineVisualElement!=null&&(this._vertexLaserLineVisualElement.visualElement.intersectsWorldUpAtLocation=i.manipulator.renderLocation);else if(i.type==="edge"){const e=this._getManipulatorInfoFromHandle(i.handle.leftVertex),a=this._getManipulatorInfoFromHandle(i.handle.rightVertex);if(e==null||a==null)return;const n=e.manipulator,o=a.manipulator;if(i.manipulator.elevationInfo!=null&&i.manipulator.elevationInfo.mode==="on-the-ground"){const s=n.location,r=o.location,l=.5,c=s.x+l*(r.x-s.x),p=s.y+l*(r.y-s.y),u=s.hasZ&&r.hasZ?0:void 0;i.manipulator.location=Ue(c,p,u,t.data.spatialReference)}else ne(Ai,n.renderLocation,o.renderLocation,.5),i.manipulator.renderLocation=Ai}}}_splitEdgeManipulator(i,t=.5){const e=this._operations,a=e.splitEdge(i.handle,t).createdVertex;i.locationUpdateHandle=Ft(i.locationUpdateHandle);const n=this.object.elevationInfo;let o;this.enableEdgeOffset?(this._removeManipulator(i),o=this._createVertexOrEdgeManipulator(a)):(o=i,o.handle=a,o.type="vertex",this._setTypeSpecificManipulatorSettings(i.manipulator,i.handle,n)),a.leftEdge&&this._createVertexOrEdgeManipulator(a.leftEdge),a.rightEdge&&this._createVertexOrEdgeManipulator(a.rightEdge),this._updateManipulatorPosition(o),this.enableEdgeOffset||this._resetTooltip(),this._updateSelection(i.manipulator);const s=this._updateEventState(L.RESHAPING),r=e.data.coordinateHelper.vectorToArray(o.handle.pos),l=e.data.components.indexOf(a.component);return this.events.emit("vertex-add",{type:"vertex-add",object:this.object,vertices:[{coordinates:r,componentIndex:l,vertexIndex:a.index}],added:r}),s&&this._updateEventState(L.NONE),o}_updateMoveManipulationPosition(){var r,l,c,p;const i=W(Ai,0,0,0);let t=0,e=!1,a=null,n=null;for(const u of this._manipulatorInfos)u.type==="vertex"&&(u.manipulator.selected?(t++,G(i,i,u.manipulator.renderLocation),a==null||u.selectedIndex>a.selectedIndex?(n=a,a=u):(n==null||u.selectedIndex>n.selectedIndex)&&(n=u)):e=!0);const o=this.object,s=(r=this._operations)==null?void 0:r.data.geometry;if(t===0){const u=o.visible&&this.enableMoveObject;this._moveManipulation.xyManipulation.available=u,this._moveManipulation.xyAxisManipulation.available=u,this._moveManipulation.xyAxisManipulation.orthogonalAvailable=u,this._moveManipulation.zManipulation.available=u&&this.enableZShape&&Me(this._operations,o.elevationInfo),this._moveManipulation.angle=pn(s),this._moveManipulation.radius=Se.radiusForSymbol((l=o.graphic)==null?void 0:l.symbol)}else{const u=o.visible;this._moveManipulation.xyManipulation.available=u,this._moveManipulation.xyAxisManipulation.available=u,this._moveManipulation.zManipulation.available=u&&this.enableZVertex&&Me(this._operations,this.object.elevationInfo),this._moveManipulation.xyAxisManipulation.orthogonalAvailable=u&&t!==1;let g=0;if(a!=null){const _=a.handle.pos,m=n!=null?n.handle.pos:(c=a.handle.leftEdge)!=null&&c.leftVertex?a.handle.leftEdge.leftVertex.pos:null,v=n==null&&((p=a.handle.rightEdge)!=null&&p.rightVertex)?a.handle.rightEdge.rightVertex.pos:null;m&&v?this._moveManipulation.xyAxisManipulation.available=!1:m?g=Io(m,_):v&&(g=Io(_,v))}this._moveManipulation.angle=g,this._moveManipulation.radius=qs}t!==0&&e?(it(i,i,1/t),Je.spatialReference=this._operations.data.spatialReference,Je.hasZ=!0,this.view.renderCoordsHelper.fromRenderCoords(i,Je),this._moveManipulation.elevationAlignedLocation=Je):this._outlineVisualElement==null||this.object.isDraped||this._outlineVisualElement.attachmentOrigin==null?nr(this._moveManipulation,this.object):this._moveManipulation.elevationAlignedLocation=this._outlineVisualElement.attachmentOrigin}_removeVertices(i){var a;const t=new Array,e=this._operations;if(e){for(const n of i){const o=n.handle.component;if(n.type==="vertex"&&e.canRemoveVertex(o)){t.push(n.handle),this._removeManipulator(n),this._removeManipulator(this._getManipulatorInfoFromHandle(n.handle.leftEdge)),this._removeManipulator(this._getManipulatorInfoFromHandle(n.handle.rightEdge));const s=e.removeVertices([n.handle]),r=(a=s.removedVertices)==null?void 0:a[0].createdEdge;r?this._createVertexOrEdgeManipulator(r):this.enableEdgeOffset&&o.vertices.length<=2&&this._removeManipulator(this._getManipulatorInfoFromHandle(o.edges[0]))}}if(t.length>0){const n=t.map(s=>{const r=e.data.components.indexOf(s.component);return{coordinates:e.data.coordinateHelper.vectorToArray(s.pos),componentIndex:r,vertexIndex:s.index}}),o=this._updateEventState(L.RESHAPING);if(this.destroyed||(this.events.emit("vertex-remove",{type:"vertex-remove",object:this.object,removed:n.map(s=>s.coordinates),vertices:n}),this.destroyed)||o&&(this._updateEventState(L.NONE),this.destroyed))return;this._updateMoveManipulationPosition()}}}_moveVertices(i,t,e=t.action==="start"?jt.NEW_STEP:jt.ACCUMULATE_STEPS){const a=this._operations;if(a){i.length>0&&a.moveVertices(i.map(n=>n.handle),t.mapDeltaX,t.mapDeltaY,t.mapDeltaZ,e);for(const n of i)this._updateManipulatorPosition(n)}}_offsetEdge(i,t){if(t.operation==null||t.signedDistance==null)return;const e=this._operations;if(!e)return;const a=t.operation.clone();a.distance=t.signedDistance,e.updateVertices([i.handle.leftVertex,i.handle.rightVertex],a),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(i.handle.leftVertex)),this._updateManipulatorPosition(this._getManipulatorInfoFromHandle(i.handle.rightVertex))}_manipulatorClickCallback(i,t){i.shiftKey||this._clearSelection(),t.type==="vertex"&&(t.manipulator.selected=!t.manipulator.selected,this.enableDeleteVertices&&i.button===An.Right&&this._removeVertices([t])),t.type==="edge"&&i.button===An.Left&&this._splitEdgeManipulator(t),i.stopPropagation()}_updateTranslateTooltip(i,t){this._defaultTooltipInfo!=null?this._resetTooltip():this._updateTranslateObjectTooltip(i,t)}_updateTranslateObjectTooltip(i,t){this.activeTooltipInfo=Au(i,t,this._tooltipsContext)}_updateEdgeOffsetTooltip(i){this.activeTooltipInfo=Iu(this.object,i,this._tooltipsContext)}_resetTooltip(){this.activeTooltipInfo=this._defaultTooltipInfo}get _defaultTooltipInfo(){var t;switch((t=this._operations)==null?void 0:t.data.type){case"polyline":case"polygon":return this._selectedVertexManipulatorInfo?this.tooltipInfos.selectedVertex:null;case"point":case"mesh":return this.tooltipInfos.movePoint;default:return null}}get _selectedVertexManipulatorInfo(){const i=this._manipulatorInfos.filter(t=>t.type==="vertex"&&t.manipulator.selected);return i.length===1?i[0]:null}get _tooltipsContext(){const{events:i}=this;return{sketchOptions:this._sketchOptions,tooltipInfos:this.tooltipInfos,activeTooltipInfo:this.activeTooltipInfo,selectedVertexManipulatorInfo:this._selectedVertexManipulatorInfo,callbacks:{onReshapeStart:()=>i.emit("reshape",{type:"reshape-start",object:this.object}),onReshape:()=>i.emit("reshape",{type:"reshape",object:this.object}),onReshapeStop:()=>i.emit("reshape",{type:"reshape-stop",object:this.object}),onMoveStart:()=>i.emit("move",{type:"move-start",object:this.object,dx:0,dy:0}),onMove:()=>i.emit("move",{type:"move",object:this.object,dx:0,dy:0}),onMoveStop:()=>i.emit("move",{type:"move-stop",object:this.object,dx:0,dy:0})}}}get test(){}};function Du(){return i=>{const{operation:t,mapEnd:e}=i;return t==null||e==null?i:(i.action==="start"&&t.selectArrowFromStartPoint(e),{...i,signedDistance:t.signedDistanceToPoint(e)})}}function Ao(i){const t=i.size/2,e=t+i.collisionPadding;return{size:t/e,outlineSize:(t+i.outlineSize)/e}}function Io(i,t){return Math.atan2(t[1]-i[1],t[0]-i[0])+Math.PI/2}h([d()],z.prototype,"_numGrabbing",void 0),h([d()],z.prototype,"_numDragging",void 0),h([d()],z.prototype,"grabbingOrDragging",null),h([d()],z.prototype,"_operations",null),h([d()],z.prototype,"_segmentLabels",void 0),h([d({constructOnly:!0})],z.prototype,"tool",void 0),h([d()],z.prototype,"tooltip",void 0),h([d()],z.prototype,"activeTooltipInfo",void 0),h([d({readOnly:!0})],z.prototype,"updating",null),h([d()],z.prototype,"manipulators",null),h([d()],z.prototype,"view",null),h([d()],z.prototype,"object",null),h([d()],z.prototype,"enableZShape",null),h([d()],z.prototype,"enableDeleteVertices",null),h([d()],z.prototype,"enableZVertex",null),h([d()],z.prototype,"autoHideManipulators",null),h([d()],z.prototype,"enableMoveObject",null),h([d()],z.prototype,"enableMidpoints",null),h([d()],z.prototype,"enableEdgeOffset",null),h([d()],z.prototype,"_sketchOptions",null),h([d()],z.prototype,"_accentColor",null),h([d()],z.prototype,"_tooltipsContext",null),z=h([H("esri.views.3d.interactive.editingTools.reshape.ReshapeOperation")],z);const Je=Ue(0,0,void 0,pl.WGS84),Ai=x(),Sa=1e-6;var $t,L,ze;(function(i){i.Vertex=K.Custom1,i.Edge=K.Custom2})($t||($t={})),function(i){i[i.NONE=0]="NONE",i[i.MOVING=1]="MOVING",i[i.RESHAPING=2]="RESHAPING"}(L||(L={})),function(i){i[i.ALL=0]="ALL",i[i.SELECTED_OR_ALL=1]="SELECTED_OR_ALL"}(ze||(ze={}));let X=class extends oa{constructor(t){super(t),this.events=new Vt,this.enableZShape=!0,this.enableZVertex=!0,this.enableMoveObject=!0,this.enableDeleteVertices=!0,this.autoHideManipulators=!1,this.enableMidpoints=!0,this.enableEdgeOffset=!1,this.type="reshape-3d",this.sketchOptions=new ce,this.snappingManager=null,this.automaticManipulatorSelection=!1}initialize(){const t=this._reshapeOperation=new z({tool:this});this.addHandles([t.events.on("reshape",e=>this.events.emit("reshape",e)),t.events.on("move",e=>this.events.emit("move",e)),t.events.on("vertex-add",e=>this.events.emit("vertex-add",e)),t.events.on("vertex-remove",e=>this.events.emit("vertex-remove",e)),t.events.on("immediate-click",e=>this.events.emit("immediate-click",{...e,object:this.object})),this.view.on("pointer-down",["Shift"],e=>e.stopPropagation())]),this.finishToolCreation()}destroy(){this._reshapeOperation=V(this._reshapeOperation)}get updating(){var t;return((this.object.updating??!1)||((t=this._reshapeOperation)==null?void 0:t.updating))??!1}get activeTooltipInfo(){var t;return((t=this._reshapeOperation)==null?void 0:t.activeTooltipInfo)??null}get tooltip(){var t;return((t=this._reshapeOperation)==null?void 0:t.tooltip)??null}onManipulatorSelectionChanged(){this._reshapeOperation&&this._reshapeOperation.onManipulatorSelectionChanged()}get canUndo(){return this._reshapeOperation.canUndo??!1}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping(),this._reshapeOperation.undo()}get canRedo(){return this._reshapeOperation.canRedo??!1}redo(){this.snappingManager!=null&&this.snappingManager.doneSnapping(),this._reshapeOperation.redo()}onInputEvent(t){const e=this._reshapeOperation;(!e||e.grabbingOrDragging||!sn(t,e.tooltip))&&this.enableDeleteVertices&&t.type==="key-down"&&ml.delete.includes(t.key)&&this._reshapeOperation.removeSelectedVertices()>0&&t.stopPropagation()}reset(){}get test(){}};h([d()],X.prototype,"_reshapeOperation",void 0),h([d()],X.prototype,"view",void 0),h([d({constructOnly:!0})],X.prototype,"object",void 0),h([d()],X.prototype,"enableZShape",void 0),h([d()],X.prototype,"enableZVertex",void 0),h([d()],X.prototype,"enableMoveObject",void 0),h([d()],X.prototype,"enableDeleteVertices",void 0),h([d()],X.prototype,"autoHideManipulators",void 0),h([d()],X.prototype,"enableMidpoints",void 0),h([d()],X.prototype,"enableEdgeOffset",void 0),h([d()],X.prototype,"type",void 0),h([d({type:ce})],X.prototype,"sketchOptions",void 0),h([d()],X.prototype,"snappingManager",void 0),h([d()],X.prototype,"updating",null),h([d()],X.prototype,"activeTooltipInfo",null),h([d()],X.prototype,"tooltip",null),h([d()],X.prototype,"automaticManipulatorSelection",void 0),X=h([H("esri.views.3d.interactive.editingTools.reshape.ReshapeTool3D")],X);let gt=class extends le{constructor(t){super(t),this._interactionState=null}initialize(){this.addHandles([Ne(()=>{const t=this._interactionState;return t&&t.angle!==t.previousAngle?{interactionState:t,angle:t.state.angle}:null},({interactionState:t})=>{this._updateMeshRotation(t)},pi),Ne(()=>{const t=this._interactionState;return t&&t.scale!==t.previousScale?{interactionState:t,scale:t.state.scale}:null},({interactionState:t})=>{this._updateMeshSize(t)},pi)])}get initialAngle(){var t;return((t=this._interactionState)==null?void 0:t.initialAngle)??0}get angle(){var a;const t=this.geometry.transform;if(t==null)return((a=this._interactionState)==null?void 0:a.angle)??0;const e=Gc(t.rotation)[2];return Math.abs(e)>.999999?re(Uc(t.rotation))*Math.sign(e):0}get angleClockwise(){return-this.angle}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){var t;return((t=this._interactionState)==null?void 0:t.scale)??1}startInteraction(){const t=new Gt({angle:this.angle});this._interactionState=t;const e=()=>{this._interactionState=null};return{state:t,done:e,cancel:()=>{t.cancel(),e()}}}createUndoRecord(){return this.object.createUndoRecord()}_updateMeshRotation(t){const{angle:e,previousAngle:a}=t;t.previousAngle=e;const n=gi(e-a);this.geometry.rotate(0,0,n,{origin:this.geometry.anchor})}_updateMeshSize(t){const{scale:e,previousScale:a}=t;t.previousScale=e;const n=e/a,o=this.geometry.anchor;this.geometry.scale(n,{origin:o})}};h([d({constructOnly:!0})],gt.prototype,"object",void 0),h([d({constructOnly:!0})],gt.prototype,"geometry",void 0),h([d({constructOnly:!0})],gt.prototype,"viewingMode",void 0),h([d()],gt.prototype,"initialAngle",null),h([d()],gt.prototype,"angle",null),h([d()],gt.prototype,"angleClockwise",null),h([d()],gt.prototype,"relativeAngle",null),h([d()],gt.prototype,"relativeAngleClockwise",null),h([d()],gt.prototype,"scale",null),h([d()],gt.prototype,"_interactionState",void 0),gt=h([H("esri.views.3d.interactive.editingTools.transform.ScaleRotateMeshAdapter")],gt);let Gt=class extends le{get state(){const{angle:t,scale:e}=this;return{angle:t,scale:e}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};h([d()],Gt.prototype,"angle",void 0),h([d()],Gt.prototype,"initialAngle",void 0),h([d()],Gt.prototype,"previousAngle",void 0),h([d()],Gt.prototype,"previousScale",void 0),h([d()],Gt.prototype,"scale",void 0),h([d()],Gt.prototype,"state",null),Gt=h([H("esri.views.3d.interactive.editingTools.transform.ScaleRotateMeshAdapter.InteractionState")],Gt);let B=class extends le{constructor(t){super(t),this.sizeAxis=null,this._interactionState=null}initialize(){this.addHandles(Ne(()=>this._interactionState!=null?this._interactionState.state:null,t=>{this._updateSymbol(t)},pi))}get initialAngle(){var t;return((t=this._interactionState)==null?void 0:t.initialAngle)??0}get angle(){return this._interactionState!=null?this._interactionState.angle:this._orientationReferenceSymbolLayer!=null?ju(this._orientationReferenceSymbolLayer.heading??0):0}get angleClockwise(){return-this.angle}get orientation(){return this.angle}get orientationClockwise(){return this.angleClockwise}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){var t;return((t=this._interactionState)==null?void 0:t.scale)??1}get size(){const t=this._sizeReferenceSymbolLayer;if(t==null)return null;const e=this.findLayerView(),a=this._graphicSymbol;if(e==null||a==null||a.type!=="point-3d")return null;const n=e.getSymbolLayerSize(a,t);if("size"in n&&n.size!=null)return n.size;const o=this.sizeAxis;return!("width"in n)||n.width==null||o!=null&&o!=="width"&&o!=="all"&&o!=="width-and-depth"?!("depth"in n)||t.depth==null||o!=null&&o!=="depth"&&o!=="all"&&o!=="width-and-depth"?!("height"in n)||t.height==null||o!=null&&o!=="height"&&o!=="all"?null:n.height:n.depth:n.width}get _sizeReferenceSymbolLayer(){const t=this._graphicSymbol;return t==null||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object")}get _orientationReferenceSymbolLayer(){const t=this._graphicSymbol;return t==null||t.symbolLayers.length===0?null:t.symbolLayers.find(e=>e.type==="object"&&e.heading!=null)}get _graphicSymbol(){var t;return((t=this.graphic)==null?void 0:t.symbol)!=null&&this.graphic.symbol.type==="point-3d"?this.graphic.symbol:null}set _graphicSymbol(t){this.graphic.symbol=t}startInteraction(){const t=this._graphicSymbol,e=this.findLayerView();if(this._interactionState!=null||t==null||e==null)return Pu;const a=t.symbolLayers.map(l=>l.type==="object"?e.getSymbolLayerSize(t,l):null).toArray(),n=t.clone(),o=this.angle,s=new Ut({originalSymbol:n,angle:o,initialSizes:a});this._interactionState=s;const r=()=>{this._interactionState=null};return{state:s,done:r,cancel:()=>{this._graphicSymbol=n,r()}}}createUndoRecord(){let t=this.graphic.symbol,e=null;return{undo:a=>{e=a.symbol,a.symbol=t},redo:a=>{t=a.symbol,a.symbol=e}}}_updateSymbol({scale:t,angle:e,originalSymbol:a,initialSizes:n}){const o=this._graphicSymbol;if(o==null||o.type!=="point-3d")return;const s=o.clone(),r=-gi(e-this.initialAngle);let l=!1;this._forEachObjectSymbolLayerPair(a,s,(c,p,u)=>{const g=(c.heading??0)+r;p.heading!==g&&(p.heading=g,l=!0);const _=n[u];if(_!=null&&"width"in _){_.width=this.sizeFilter(_.width),_.height=this.sizeFilter(_.height),_.depth=this.sizeFilter(_.depth);const m=_.width*t;p.width!==m&&(p.width=m,l=!0);const v=_.depth*t;p.depth!==v&&(p.depth=v,l=!0);const b=_.height*t;p.height!==b&&(p.height=b,l=!0)}}),l&&(this._graphicSymbol=s)}_forEachObjectSymbolLayerPair(t,e,a){t.symbolLayers.forEach((n,o)=>{const s=e.symbolLayers.at(o);n.type==="object"&&s.type==="object"&&a(n,s,o)})}};function ju(i){return-re(i)}h([d()],B.prototype,"initialAngle",null),h([d()],B.prototype,"angle",null),h([d()],B.prototype,"angleClockwise",null),h([d()],B.prototype,"orientation",null),h([d()],B.prototype,"orientationClockwise",null),h([d()],B.prototype,"relativeAngle",null),h([d()],B.prototype,"relativeAngleClockwise",null),h([d()],B.prototype,"scale",null),h([d()],B.prototype,"size",null),h([d()],B.prototype,"sizeAxis",void 0),h([d({constructOnly:!0})],B.prototype,"graphic",void 0),h([d()],B.prototype,"_interactionState",void 0),h([d({constructOnly:!0})],B.prototype,"findLayerView",void 0),h([d({constructOnly:!0})],B.prototype,"sizeFilter",void 0),h([d()],B.prototype,"_sizeReferenceSymbolLayer",null),h([d()],B.prototype,"_orientationReferenceSymbolLayer",null),h([d()],B.prototype,"_graphicSymbol",null),B=h([H("esri.views.3d.interactive.editingTools.transform.ScaleRotateObjectSymbol3DAdapter")],B);const Pu={state:{angle:0,scale:0},done:()=>{},cancel:()=>{}};let Ut=class extends le{get state(){const{originalSymbol:i,angle:t,initialAngle:e,scale:a,initialSizes:n}=this;return{originalSymbol:i,angle:t,initialAngle:e,scale:a,initialSizes:n}}constructor(i){super(i),this.angle=0,this.initialAngle=0,this.scale=1,this.initialAngle=i.angle}};h([d()],Ut.prototype,"originalSymbol",void 0),h([d()],Ut.prototype,"angle",void 0),h([d()],Ut.prototype,"initialAngle",void 0),h([d()],Ut.prototype,"initialSizes",void 0),h([d()],Ut.prototype,"scale",void 0),h([d()],Ut.prototype,"state",null),Ut=h([H("esri.views.3d.interactive.editingTools.transform.ScaleRotateObjectSymbol3DAdapter.InteractionState")],Ut);let Lt=class extends he{constructor(t){super(t),this.type="transform-absolute",this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic",this.size=null,this.sizePrecision=null,this.sizeUnit=null}};h([d()],Lt.prototype,"type",void 0),h([d()],Lt.prototype,"orientation",void 0),h([d()],Lt.prototype,"orientationPrecision",void 0),h([d()],Lt.prototype,"rotationType",void 0),h([d()],Lt.prototype,"size",void 0),h([d()],Lt.prototype,"sizePrecision",void 0),h([d()],Lt.prototype,"sizeUnit",void 0),Lt=h([H("esri.views.interactive.tooltip.infos.TransformAbsoluteTooltipInfo")],Lt);let Bt=class extends he{constructor(t){super(t),this.type="transform-rotate",this.rotation=null,this.rotationPrecision=null,this.orientation=null,this.orientationPrecision=null,this.rotationType="geographic"}};h([d()],Bt.prototype,"type",void 0),h([d()],Bt.prototype,"rotation",void 0),h([d()],Bt.prototype,"rotationPrecision",void 0),h([d()],Bt.prototype,"orientation",void 0),h([d()],Bt.prototype,"orientationPrecision",void 0),h([d()],Bt.prototype,"rotationType",void 0),Bt=h([H("esri.views.interactive.tooltip.infos.TransformRotateTooltipInfo")],Bt);let ie=class extends he{constructor(t){super(t),this.type="transform-scale",this.size=null,this.sizeUnit=null,this.sizePrecision=null}};h([d()],ie.prototype,"type",void 0),h([d()],ie.prototype,"scale",void 0),h([d()],ie.prototype,"size",void 0),h([d()],ie.prototype,"sizeUnit",void 0),h([d()],ie.prototype,"sizePrecision",void 0),ie=h([H("esri.views.interactive.tooltip.infos.TransformScaleTooltipInfo")],ie);var I;(function(i){i.ScaleIn=K.Custom2,i.ScaleOut=K.Custom3,i.RotateLeft=K.Custom4,i.RotateRight=K.Custom5,i.Unlocked=K.Custom7,i.DelayedFocused=K.Custom8,i.TouchInput=K.Custom12})(I||(I={}));let Tt=class extends le{get angle(){return this.adapter.angle}get scale(){return this.adapter.scale}set location(i){this._ringManipulator.location=i}set elevationAlignedLocation(i){this._ringManipulator.elevationAlignedLocation=i}get grabbing(){return this._ringManipulator.grabbing}set interactive(i){this._ringManipulator.interactive=i}get updating(){return!!this._activeAnimation}get tooltipEffectiveEnabled(){return this.sketchOptions.tooltips.effectiveEnabled&&this.tooltipEnabled}constructor(i){super(i),this.mode=null,this.tooltipEnabled=!0,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=eu,this._absoluteTooltipInfo=null,this._scaleTooltipInfo=null,this._rotateTooltipInfo=null,this.events=new Vt,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>{var t;return((t=this._scaleRotateDragData)==null?void 0:t.mode)==="scale"?this.adapter.scale:1}}initialize(){this.tooltip=new yi({view:this.tool.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this.addHandles([Ne(()=>!this.tooltipEffectiveEnabled,()=>this.tooltip.clear(),j),M(()=>{const{adapter:i}=this,{info:t}=this.tooltip;return t===this._absoluteTooltipInfo&&this.getFocused()?[t,i.size,i.orientationClockwise]:[null]},([i])=>{i&&this._updateFocusTooltip()}),M(()=>{const{adapter:i}=this;return[i.angle,i.scale]},()=>this._updateManipulatorTransform())])}destroy(){var i;(i=this._activeAnimation)==null||i.frameTask.remove(),this._activeAnimation=null,this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this.tooltip=V(this.tooltip)}startAnimation(i){this.cancelActiveAnimation(),i.start();const t=vl({update:({deltaTime:e})=>{i.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...i,frameTask:t}}cancelActiveAnimation(){var i;(i=this._activeAnimation)==null||i.frameTask.remove(),this._activeAnimation=V(this._activeAnimation)}forEachManipulator(i){i(this._ringManipulator,R.SCALE_ROTATE)}_createManipulator(){const i=this._createRingManipulator();this._ringManipulator=i,this.tool.manipulators.add(i);const t=this.tool.object,e=Pt(i,(a,n,o)=>{this._scaleRotateDragData=null;const s=this.adapter.startInteraction(),r={mode:"none",origin:oi(a.renderLocation),initialAngle:this.adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=r,this._updateDragState();const l=f.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(a.renderLocation,l),n.next(ra(this.tool.view,Ve(a.renderLocation,l,bi()))).next(c=>{const p=Be(c.plane),u=ir(c.renderStart,c.renderEnd,r.origin,p),g=yl.shortestSignedDiff(r.angle,u);r.angleDir=Hi(r.angleDir+g,-vo,vo),r.angle=u;const _=Cu(r,c),m=_-this.adapter.scale;if(r.scaleDir=Hi(r.scaleDir+m,-mo,mo),this._onScaleChanged(),r.mode==="none"){const v=this.mode||zu(c,c.plane,r.origin,this.tool.view.state.camera);if(v!=null){switch(v){case"rotate":this.tool.events.emit("rotate-start",{object:t,angle:0}),this.tool.events.emit("record-undo",{updates:[this.adapter.createUndoRecord()]});break;case"scale":this.tool.events.emit("scale-start",{object:t,xScale:1,yScale:1}),this.tool.events.emit("record-undo",{updates:[this.adapter.createUndoRecord()]})}r.mode=v}}switch(r.mode){case"rotate":s.state.angle=r.initialAngle+u;break;case"scale":s.state.scale=_,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),c.action){case"start":case"update":switch(r.mode){case"rotate":this.tool.events.emit("rotate",{object:t,angle:gi(r.angle)});break;case"scale":this.tool.events.emit("scale",{object:t,xScale:_,yScale:_})}break;case"end":switch(r.mode){case"rotate":this.tool.events.emit("rotate-stop",{object:t,angle:gi(r.angle)});break;case"scale":this.tool.events.emit("scale-stop",{object:t,xScale:_,yScale:_})}}return c.action==="end"&&(this.startAnimation(Ro(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),s.done()),c}).next(this._updateTooltipPipelineStep(r)),o.next(()=>{if(s.cancel(),this._scaleRotateDragData!=null){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.events.emit("rotate-stop",{object:t,angle:0});break;case"scale":this.tool.events.emit("scale-stop",{object:t,xScale:1,yScale:1})}this.startAnimation(Ro(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()})});this.addHandles([e,i.events.on("focus-changed",a=>{a.action==="focus"?this.startAnimation(Lu(this,()=>this._updateDelayedFocusedState(),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()}),i.events.on("immediate-click",a=>{a.stopPropagation()}),M(()=>this.tool.object.visible,a=>this._ringManipulator.available=a,j)])}_updateTooltipPipelineStep(i){return t=>{const{sketchOptions:e}=this,{visualVariables:a}=e.tooltips;if(!this.tooltipEffectiveEnabled)return t;if(t.action==="end")return this._updateFocusTooltip(),t;const{tooltip:n}=this;switch(i.mode){case"scale":{n.info=this._scaleTooltipInfo??(this._scaleTooltipInfo=new ie({sketchOptions:e}));const{size:o,scale:s}=this.adapter,r=a==null?void 0:a.size,l=n.info;l.sketchOptions=e,l.scale=fl(s),l.size=o!=null?Gi(o,"meters"):void 0,l.sizePrecision=Ri(r==null?void 0:r.valueType),l.sizeUnit=r==null?void 0:r.unit;break}case"rotate":{n.info=this._rotateTooltipInfo??(this._rotateTooltipInfo=new Bt({sketchOptions:e}));const{orientationClockwise:o,relativeAngleClockwise:s}=this.adapter,r=a==null?void 0:a.rotation,l=Ri(r==null?void 0:r.valueType),c=n.info;c.sketchOptions=e,c.rotation=s!=null?da(s,"radians","geographic"):void 0,c.rotationPrecision=l,c.rotationType=(r==null?void 0:r.rotationType)??"geographic",c.orientation=o!=null?da(o,"radians","geographic"):void 0,c.orientationPrecision=l;break}}return t}}_updateFocusTooltip(){const{sketchOptions:i,tooltip:t}=this,{visualVariables:e}=i.tooltips;if(this.tooltipEffectiveEnabled)if(this.getFocused()){const a=e==null?void 0:e.rotation,n=e==null?void 0:e.size,o=this.mode,{size:s,orientationClockwise:r}=this.adapter,l=r!=null&&(o==null||o==="rotate"),c=s!=null&&(o==null||o==="scale");t.info=this._absoluteTooltipInfo??(this._absoluteTooltipInfo=new Lt({sketchOptions:i}));const p=t.info;p.sketchOptions=i,p.orientation=l?da(r,"radians","geographic"):void 0,p.orientationPrecision=Ri(a==null?void 0:a.valueType),p.rotationType=(a==null?void 0:a.rotationType)??"geographic",p.size=c?Gi(s,"meters"):void 0,p.sizeUnit=n==null?void 0:n.unit,p.sizePrecision=Ri(n==null?void 0:n.valueType)}else t.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(I.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){var i;if(this._ringManipulator.updateStateEnabled(I.Unlocked,!(this._scaleRotateDragData!=null&&((i=this._scaleRotateDragData)==null?void 0:i.mode)!=="none")),this._scaleRotateDragData!=null)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(I.ScaleIn|I.ScaleOut,!1),this._ringManipulator.updateStateEnabled(I.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(I.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(I.RotateLeft|I.RotateRight,!1),this._ringManipulator.updateStateEnabled(I.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(I.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(I.ScaleIn|I.ScaleOut|I.RotateLeft|I.RotateRight,!1)}_updateManipulatorTransform(){const i=es(tt.get(),this.adapter.angle,N(0,0,1));if(i==null)return;const t=this.getScale(),e=Fi(tt.get(),W(f.get(),t,t,t));this._ringManipulator.modelTransform=Yt(tt.get(),e,i)}_createRingManipulator(){const i=(E,Z,ot)=>{const qt=[],Qt=Math.ceil(Ys*(Z-E)/(2*Math.PI));for(let at=0;at<Qt+1;at++){const Xe=E+at*(Z-E)/Qt;qt.push(N(ot*Math.cos(Xe),ot*Math.sin(Xe),0))}return qt},t=E=>i(0,2*Math.PI,E),e=E=>[[-E/2,0],[E/2,0],[E/2,va/2],[-E/2,va/2]],a=this._createMaterial(1),n=(E,Z,ot=a)=>fs(ot,e(Z),E,[],[],!1),o=t(ve),s=n(o,fa),r={left:new Array,right:new Array},l=[];for(let E=0;E<2;E++){const Z=E*Math.PI-Math.PI/4,ot=Math.PI/2-Kh,qt=Z+ot,Qt=Z+Math.PI/2-ot,at=i(qt,Qt,qh),Xe=n(at,Ae);l.push(at),l.push(i(qt,Qt,ho-fa/2)),r.left.push(Xe),r.right.push(Xe.instantiate());for(let ua=0;ua<2;ua++){const _n=ua===0,pt=vt();if(_n){ui(pt,pt,[1,-1,1]),In(pt,pt,-qt,[0,0,1]);const ue=Math.round(po*(at.length-1));pt[12]=at[ue][0],pt[13]=at[ue][1],pt[14]=at[ue][2]}else{In(pt,pt,Qt,[0,0,1]);const ue=Math.round((1-po)*(at.length-1));pt[12]=at[ue][0],pt[13]=at[ue][1],pt[14]=at[ue][2]}const mn=Bi(a,Qh,0,Jh,va);vs(mn,pt),(_n?r.left:r.right).push(mn)}}const c=[];for(let E=0;E<2;E++){const Z=E*Math.PI-Math.PI/4,ot=Math.PI/2-tu,qt=Z+ot,Qt=Z+Math.PI/2-ot,at=i(qt,Qt,ho);c.push(n(at,Ae))}const p=this._createMaterial(.66),u=this._createMaterial(.5),g=this._createMaterial(.33),_=t(ve+go),m=t(ve+_o),v=n(_,Ae,p),b=n(m,Ae,g),y=t(ve-go),O=t(ve-_o),A=n(y,Ae,p),q=n(O,Ae,g);let C=[new w(s,I.DelayedFocused),new w(s.instantiate({material:u}),S.None)];this.mode&&this.mode!=="scale"||(C=C.concat([...c.map(E=>new w(E,I.DelayedFocused|I.Unlocked)),new w(v,I.DelayedFocused|I.ScaleIn),new w(b,I.DelayedFocused|I.ScaleIn),new w(A,I.DelayedFocused|I.ScaleOut),new w(q,I.DelayedFocused|I.ScaleOut)])),this.mode&&this.mode!=="rotate"||(C=C.concat([...r.right.map(E=>new w(E.instantiate(),I.DelayedFocused|I.Unlocked)),...r.left.map(E=>new w(E,I.DelayedFocused|I.RotateLeft)),...r.right.map(E=>new w(E,I.DelayedFocused|I.RotateRight))]));const ht=[o,...l];return new ct({view:this.tool.view,renderObjects:C,autoScaleRenderObjects:!1,worldOriented:!0,radius:fa,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:this.tool.object.elevationInfo,collisionType:{type:"ribbon",paths:ht,direction:N(0,0,1)}})}_createMaterial(i){const t=new Dt({cullFace:J.Back,renderOccluded:D.Transparent,isDecoration:!0});return this.addHandles(M(()=>({color:bl(this.tool.view.effectiveTheme.accentColor,i)}),e=>t.setParameters(e),j)),t}get test(){}};function Cu(i,t){const e=$(f.get(),t.renderStart,i.origin),a=$(f.get(),t.renderEnd,i.origin),n=Mt(e),o=Mt(a);return n===0?0:o/n}function zu(i,t,e,a){const{renderStart:n,renderEnd:o}=i,s=Ii(n,a,f.get()),r=Ii(o,a,f.get());if(Wo(s,r)<uo*uo)return null;const l=$(f.get(),n,e),c=St(f.get(),l,Be(t)),p=n,u=G(f.get(),p,c),g=Ii(e,a,f.get()),_=s,m=Ii(u,a,f.get()),v=$(f.get(),m,_),b=$(f.get(),s,g),y=Rn(_,v),O=Rn(g,b);return Dn(y,r)<Dn(O,r)?"rotate":"scale"}function Ii(i,t,e){return t.projectToScreen(i,xa),W(e,xa[0],xa[1],0)}var Ge;function Ro(i,t){let e=null,a=1;const n=()=>a;return{start:()=>{a=i.getScale(),e=i.getScale,i.getScale=n,t()},update:o=>(a+=((a+1)/2-a)*Math.min(o*iu,1),t(),Math.abs(a-1)<.01?Ge.STOP:Ge.CONTINUE),destroy:()=>{e&&(i.getScale=e),t()}}}function Lu(i,t,e){let a=0,n=null;const o=()=>!1;return{start:()=>{n=i.getFocused,i.getFocused=o,a=0,t()},update:s=>(a+=s,!(n!=null&&n())||a>=e.delayMs?Ge.STOP:Ge.CONTINUE),destroy:()=>{n&&(i.getFocused=n),t()}}}function Ri(i){switch(i){case"integer":case"long":return 0;default:return null}}h([d({constructOnly:!0})],Tt.prototype,"tool",void 0),h([d({constructOnly:!0})],Tt.prototype,"adapter",void 0),h([d({constructOnly:!0})],Tt.prototype,"sketchOptions",void 0),h([d()],Tt.prototype,"mode",void 0),h([d()],Tt.prototype,"tooltipEnabled",void 0),h([d()],Tt.prototype,"_activeAnimation",void 0),h([d()],Tt.prototype,"updating",null),h([d()],Tt.prototype,"tooltipEffectiveEnabled",null),Tt=h([H("esri.views.3d.interactive.editingTools.transform.ScaleRotateTransform")],Tt),function(i){i[i.CONTINUE=0]="CONTINUE",i[i.STOP=1]="STOP"}(Ge||(Ge={}));const xa=Nt();let ii=class extends Is(he){constructor(t){super(t),this.type="transform-mesh",this.orientation=dc({actual:null,lockable:!1}),this.scale=gc({actual:null,lockable:!1}),this.allFields.forEach(e=>{e.lockable=!1,e.setActual(null)})}get key(){return{longitude:this.longitude.actual,latitude:this.latitude.actual,x:this.x.actual,y:this.y.actual,elevation:this.elevation.actual,geographic:this.geographic,orientation:this.orientation.actual,scale:this.scale.actual}}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation,this.orientation,this.scale]}};h([d()],ii.prototype,"key",null),h([d()],ii.prototype,"allFields",null),ii=h([H("esri.views.interactive.tooltip.infos.TransformMeshTooltipInfo")],ii);let Pi=class extends Is(he){constructor(t){super(t),this.type="transform-point",this.allFields.forEach(e=>{e.lockable=!1,e.setActual(null)})}get allFields(){return[this.longitude,this.latitude,this.x,this.y,this.elevation]}};h([d()],Pi.prototype,"allFields",null),Pi=h([H("esri.views.interactive.tooltip.infos.TransformPointTooltipInfo")],Pi);let dt=class extends oa{constructor(t){super(t),this.events=new Vt,this.enableZ=!0,this.enableRotation=!0,this.enableScaling=!0,this.sketchOptions=new ce,this.type="transform-3d",this._updatingHandles=new ea,this._scaleRotate=null}initialize(){var c,p;const{events:t,object:e,view:a}=this;this.tooltip=new yi({view:a}),this._moveManipulation=new Se({tool:this,view:a,snapToScene:this.snapToScene,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:this.enableZ&&Me(e.operations,e.elevationInfo),radius:Se.radiusForSymbol((c=e.graphic)==null?void 0:c.symbol)}),this._moveManipulation.forEachManipulator(u=>this.addHandles(u.events.on("immediate-click",g=>{t.emit("immediate-click",{...g,object:this.object}),g.stopPropagation()})));const n=e.elevationInfo;if(this._moveManipulation.elevationInfo=n,this.addHandles(un(e)),this._moveManipulation.createManipulatedObjectDragPipeline((u,g,_,m,v)=>{var b;if(u===P.XY){const{snappingStep:y,cancelSnapping:O}=Wi({snappingContext:new Yi({elevationInfo:n,pointer:v,editGeometryOperations:rn.fromGeometry(new se({spatialReference:(b=e.operations)==null?void 0:b.data.spatialReference}),a.state.viewingMode),visualizer:new mi,excludeFeature:e.graphic}),snappingManager:this.snappingManager,updatingHandles:this._updatingHandles,useZ:!1});m=m.next(O),_=_.next(zc(this.view,n)).next(...y)}return{steps:_,cancel:m}},e,u=>{const{action:g,object:_,dxScreen:m,dyScreen:v}=u,b={object:_,dxScreen:m,dyScreen:v};switch(g){case"start":this._emitRecordUndo(),t.emit("translate-start",b);break;case"update":t.emit("translate",b);break;case"end":t.emit("translate-stop",b)}}),this._moveManipulation.angle=this._scaleRotate!=null?this._scaleRotate.angle:0,this._scaleRotateAdapter=this._createScaleRotateAdapter(),this.addHandles(M(()=>this._scaleRotateAdapter.angle,()=>this._updateMoveAngle())),this.enableScaling||this.enableRotation){const u=this.enableScaling&&this.enableRotation?null:this.enableScaling?"scale":"rotate";this._scaleRotate=new Tt({tool:this,mode:u,adapter:this._scaleRotateAdapter,sketchOptions:this.sketchOptions,tooltipEnabled:((p=U(e))==null?void 0:p.type)!=="mesh"}),this.addHandles(this._scaleRotate.events.on("scale-changed",()=>this._onScaleChanged()))}this.addHandles([sa({view:this.view,object:e,forEachManipulator:u=>this._forEachManipulator(u),onManipulatorsChanged:()=>F()}),e.on("committed",()=>this._onGeometryChanged()),this._hideManipulatorsForObjectState(),M(()=>a.scale,()=>this._updateMoveAngle())].filter(os)),this._onGeometryChanged(),this._updateMoveAngle(),this._forEachManipulator(u=>{u instanceof ct&&this.addHandles(u.events.on("grab-changed",()=>this._updateManipulatorsInteractive()))});const o=a==null?void 0:a.type,{sketchOptions:s}=this;this._meshTooltipInfo=new ii({viewType:o,sketchOptions:s}),this._pointTooltipInfo=new Pi({viewType:o,sketchOptions:s});const r={object:e,dxScreen:0,dyScreen:0},l={onMoveStart:()=>{this._emitRecordUndo(),t.emit("translate-start",{...r})},onMove:()=>t.emit("translate",{...r}),onMoveStop:()=>t.emit("translate-stop",{...r}),onRotateStart:u=>{this._emitRecordUndo(),t.emit("rotate-start",{object:e,angle:u})},onRotate:u=>t.emit("rotate",{object:e,angle:u}),onRotateStop:u=>t.emit("rotate-stop",{object:e,angle:u}),onScaleStart:(u,g)=>{this._emitRecordUndo(),t.emit("scale-start",{object:e,xScale:u,yScale:g})},onScale:(u,g)=>t.emit("scale",{object:e,xScale:u,yScale:g}),onScaleStop:(u,g)=>t.emit("scale-stop",{object:e,xScale:u,yScale:g})};this.addHandles(Gs(this.tooltip,this.object,()=>({sketchOptions:this.sketchOptions,activeTooltipInfo:this.activeTooltipInfo,callbacks:l}))),this.finishToolCreation()}destroy(){this.tooltip.destroy(),this._moveManipulation.destroy(),this._scaleRotate=V(this._scaleRotate),this._scaleRotateAdapter=V(this._scaleRotateAdapter),this._updatingHandles.destroy(),this._set("view",null),this._set("object",null)}onInputEvent(t){if(!this.destroyed&&!sn(t,this.tooltip))return super.onInputEvent(t)}_updateManipulatorsInteractive(){this._scaleRotate!=null&&(this._scaleRotate.interactive=!this._moveManipulation.grabbing,this._moveManipulation.interactive=!this._scaleRotate.grabbing)}_createScaleRotateAdapter(){var e,a,n,o;const t=U(this.object);return(t==null?void 0:t.type)==="mesh"?new gt({object:this.object,geometry:t,viewingMode:this.view.state.viewingMode}):new B({graphic:this.object.graphic,sizeFilter:s=>this._enforceNonZeroSize(s),findLayerView:()=>this.view.allLayerViews.find(s=>{var r;return s.layer===((r=this.object.graphic)==null?void 0:r.layer)}),sizeAxis:((o=(n=(a=(e=this.sketchOptions)==null?void 0:e.tooltips)==null?void 0:a.visualVariables)==null?void 0:n.size)==null?void 0:o.axis)??null})}_forEachManipulator(t){var e,a;(e=this._moveManipulation)==null||e.forEachManipulator(t),(a=this._scaleRotate)==null||a.forEachManipulator(t)}_hideManipulatorsForObjectState(){return M(()=>this.object.visible,t=>{this._forEachManipulator(e=>e.available=t),this._moveManipulation.zManipulation.available=t&&this.enableZ&&Me(this.object.operations,this.object.elevationInfo)})}_emitRecordUndo(){this.events.emit("record-undo",{updates:[this.object.createUndoRecord()]})}set snapToScene(t){this._moveManipulation&&(this._moveManipulation.snapToScene=t),this._set("snapToScene",t)}get updating(){var t;return this._updatingHandles.updating||!!((t=this._scaleRotate)!=null&&t.updating)}get activeTooltipInfo(){var t,e,a;return((e=(t=this._scaleRotate)==null?void 0:t.tooltip)==null?void 0:e.info)!=null?null:((a=U(this.object))==null?void 0:a.type)==="mesh"?this._meshTooltipInfo:this._pointTooltipInfo}set location(t){this._moveManipulation.location=t,this._scaleRotate&&(this._scaleRotate.location=t)}set elevationAlignedLocation(t){this._moveManipulation.elevationAlignedLocation=t,this._scaleRotate&&(this._scaleRotate.elevationAlignedLocation=t)}reset(){}onHide(){var t;(t=this._scaleRotate)==null||t.cancelActiveAnimation()}_onScaleChanged(){this._scaleRotate!=null&&(this._moveManipulation.displayScale=this._scaleRotate.getScale())}_updateMoveAngle(){const{view:t}=this,e=t.state.viewingMode===Ml.Local||t.scale<au;this._moveManipulation.angle=e?this._scaleRotateAdapter.angle:0}_onGeometryChanged(){nr(this,this.object)}_enforceNonZeroSize(t){return t||this.view.state.camera.computeRenderPixelSizeAt(this._moveManipulation.renderLocation)}get test(){}};h([d({constructOnly:!0,nonNullable:!0})],dt.prototype,"view",void 0),h([d({constructOnly:!0,nonNullable:!0})],dt.prototype,"object",void 0),h([d({constructOnly:!0,nonNullable:!0})],dt.prototype,"enableZ",void 0),h([d()],dt.prototype,"enableRotation",void 0),h([d()],dt.prototype,"enableScaling",void 0),h([d({constructOnly:!0,type:ce})],dt.prototype,"sketchOptions",void 0),h([d({value:!1})],dt.prototype,"snapToScene",null),h([d({constructOnly:!0})],dt.prototype,"snappingManager",void 0),h([d({readOnly:!0})],dt.prototype,"type",void 0),h([d({readOnly:!0})],dt.prototype,"updating",null),h([d()],dt.prototype,"activeTooltipInfo",null),dt=h([H("esri.views.3d.interactive.editingTools.transform.TransformTool3D")],dt);let ee=class extends Sl(wl){constructor(t){super(t),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(t){return this.heading===t.heading&&this.tilt===t.tilt&&xl(this.position,t.position)&&this.width===t.width&&this.height===t.height}};h([d({readOnly:!0,json:{read:!1,write:!0}})],ee.prototype,"type",void 0),h([d({type:se}),Ye()],ee.prototype,"position",void 0),h([d({type:Number,nonNullable:!0,range:{min:0,max:360}}),Ye(),jn(i=>Pn.normalize(Cn(i),0,!0))],ee.prototype,"heading",void 0),h([d({type:Number,nonNullable:!0,range:{min:0,max:360}}),Ye(),jn(i=>Pn.normalize(Cn(i),0,!0))],ee.prototype,"tilt",void 0),h([d({type:Number,nonNullable:!0}),Ye()],ee.prototype,"width",void 0),h([d({type:Number,nonNullable:!0}),Ye()],ee.prototype,"height",void 0),ee=h([H("esri.analysis.SlicePlane")],ee);ns("mac");const Hu=2,ku=1.15,Nu=1.15,Vu=3,or=11,Ba=22.5,wa=40,Do=48,Fu=2.25,Gu=4,jo=1,Uu=.3,Bu=6,Zu=4;function sr(i){const t=new tn,{vertex:e,fragment:a,attributes:n,varyings:o}=t;return en(e,i),n.add(T.POSITION,"vec3"),n.add(T.UV0,"vec2"),o.add("vUV","vec2"),e.code.add(Y`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),a.uniforms.add(new Xi("backgroundColor",s=>s.backgroundColor),new Xi("gridColor",s=>s.gridColor),new Zi("gridWidth",s=>s.gridWidth)),a.code.add(Y`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
fragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),t}const Xu=Object.freeze(Object.defineProperty({__proto__:null,build:sr},Symbol.toStringTag,{value:"Module"}));let Yu=class rr extends an{initializeProgram(t){return new nn(t.rctx,rr.shader.get().build(this.configuration),Ol)}initializePipeline(){return ln({blending:wc(je.ONE,je.ONE,je.ONE_MINUS_SRC_ALPHA,je.ONE_MINUS_SRC_ALPHA),depthTest:{func:ji.LESS},colorWrite:cn})}};Yu.shader=new on(Xu,()=>Ja(()=>Promise.resolve().then(()=>Cp),void 0));function Wu(i,t){return ar(i.basis1,i.basis2,i.origin,t)}function qu(i,t,e,a){const n=t.worldUpAtPosition(i.origin,f.get()),o=f.get();switch(e){case fi.HEADING:lt(o,n);break;case fi.TILT:lt(o,i.basis1)}return Ve(i.origin,o,a)}function Qu(i,t,e,a){const n=Mt(a.basis1),o=Mt(a.basis2),s=lr(a),r=Za(a),l=W(f.get(),0,0,0);G(l,it(f.get(),a.basis1,t.direction[0]),it(f.get(),a.basis2,t.direction[1])),G(l,a.origin,l);let c=0,p=1;if(ca(t))t.direction[0]===1&&t.direction[1]===-1?c=zo:t.direction[0]===1&&t.direction[1]===1?c=Math.PI:t.direction[0]===-1&&t.direction[1]===1&&(c=3*Math.PI/2),p=r;else{const g=t.direction[0]!==0?1:2;c=g===1?zo:0,p=(g===1?o:n)-s}const u=ts(tt.get(),c);ui(u,u,W(f.get(),p,p,p)),Yt(u,e,u),u[12]=0,u[13]=0,u[14]=0,i.modelTransform=u,i.renderLocation=l}var Po;function lr(i){const t=Mt(i.basis1),e=Mt(i.basis2);return Uu*Math.min(t,e)}function Za(i){return lr(i)}function ca(i){return i.direction[0]!==0&&i.direction[1]!==0}(function(i){i[i.POSITIVE_X=0]="POSITIVE_X",i[i.POSITIVE_Y=1]="POSITIVE_Y",i[i.NEGATIVE_X=2]="NEGATIVE_X",i[i.NEGATIVE_Y=3]="NEGATIVE_Y"})(Po||(Po={}));const ae=K.Custom1;var fi,Co;(function(i){i[i.HEADING=1]="HEADING",i[i.TILT=2]="TILT"})(fi||(fi={})),function(i){i[i.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",i[i.HORIZONTAL=1]="HORIZONTAL",i[i.VERTICAL=2]="VERTICAL",i[i.TILTED=3]="TILTED"}(Co||(Co={}));const Xa=K.Custom2;Ki();const zo=Math.PI/2,Ci=K.Custom1,cr=K.Custom2;var Ji;(function(i){i[i.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",i[i.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"})(Ji||(Ji={}));let Ju=class extends ct{constructor(t,e){const a=new Wt({width:1,renderOccluded:D.OccludeAndTransparent,isDecoration:!0}),n=new Dt({cullFace:J.Back,renderOccluded:D.Opaque,isDecoration:!0}),o=new Dt({cullFace:J.Back,renderOccluded:D.Opaque,isDecoration:!0}),s=new Dt({cullFace:J.Back,renderOccluded:D.Opaque,isDecoration:!0}),r=new Dt({writeDepth:!1,cullFace:J.Front,renderOccluded:D.Transparent,isDecoration:!0});super({view:t,...Ku({offsetMode:e,tubeMaterial:n,tipMaterial:o,capMaterial:s,outlineMaterial:r,calloutMaterial:a})}),this._themeHandle=M(()=>t.effectiveTheme.accentColor,l=>{const c=Wa(l),p=nt.toUnitRGBA(l),u=nt.toUnitRGBA(c),g=nt.toUnitRGBA(nt.blendColors(c,l,.4)),_=nt.toUnitRGBA(nt.blendColors(c,l,.14));a.setParameters({color:p}),n.setParameters({color:_}),o.setParameters({color:u}),s.setParameters({color:g}),r.setParameters({color:p})},j)}destroy(){this._themeHandle.remove(),super.destroy()}};function Ku({offsetMode:i,tubeMaterial:t,tipMaterial:e,capMaterial:a,outlineMaterial:n,calloutMaterial:o}){const s=i===Ji.CENTER_ON_CALLOUT?wa:0,r=[N(s,0,-Do/2),N(s,0,Do/2)],l=ep(r),c=Lo({vertices:r,padding:0,materials:{tube:t,tip:e,cap:a}}),p=Lo({vertices:r,padding:Fu,materials:{tube:n,tip:n,cap:n}}),u=Ht(o,[[s,0,0],[s-wa,0,0]]),g=Ht(o,[[s,0,0],[s-wa,0,0]]);return{renderObjects:[...c.normal.map(_=>new w(_,S.Unfocused|ae)),...p.normal.map(_=>new w(_,S.Unfocused|ae)),new w(u,S.Unfocused|ae|Xa),...c.focused.map(_=>new w(_,S.Focused|ae)),...p.focused.map(_=>new w(_,S.Focused|ae)),new w(g,S.Focused|ae|Xa)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[l]},collisionPriority:1,radius:or,state:ae}}function Lo({vertices:i,padding:t,materials:e}){const a=n=>{const o=i.slice(0),s=$(f.get(),o[0],o[1]);ut(s,s);const r=$(f.get(),o[o.length-1],o[o.length-2]);if(ut(r,r),t>0){const E=it(x(),r,-t);o[o.length-1]=G(E,E,o[o.length-1]);const Z=it(x(),s,-t);o[0]=G(Z,Z,o[0])}const l=n?Nu:1,c=Ba*l,p=or*l,u=ja(tt.get());if(t>0){const E=c/4,Z=W(f.get(),0,E,0),ot=1+t/E;Pa(u,u,Z),ui(u,u,W(f.get(),ot,ot,ot)),Pa(u,u,it(Z,Z,-1/ot))}const g=ja(vt()),_=N(0,1,0),m=zn(vt(),Ln(Hn.get(),_,r));m[12]=o[o.length-1][0],m[13]=o[o.length-1][1],m[14]=o[o.length-1][2],Yt(m,m,u);const v=e.tube,b=tp(Vu*(n?ku:1)+t,o,v);b.transformation=g;const y=[b],O=e.tip,A=Ha(O,c,p,24,!1,!1,!0);A.transformation=m,y.push(A);const q=e.cap,C=Ha(q,c,p,24,!1,!0,!1);C.transformation=m,y.push(C);const ht=zn(vt(),Ln(Hn.get(),_,s));return ht[12]=o[0][0],ht[13]=o[0][1],ht[14]=o[0][2],Yt(ht,ht,u),y.push(A.instantiate({transformation:ht})),y.push(C.instantiate({transformation:ht})),y};return{normal:a(!1),focused:a(!0)}}function tp(i,t,e){const a=[];for(let o=0;o<12;o++){const s=o/12*2*Math.PI;a.push([Math.cos(s)*i,Math.sin(s)*i])}return fs(e,a,t,[],[],!1)}function ep(i,t){const e=$(x(),i[i.length-1],i[i.length-2]);ut(e,e),it(e,e,Ba),G(e,e,i[i.length-1]);{const a=$(x(),i[0],i[1]);return ut(a,a),it(a,a,Ba),G(a,a,i[0]),[a,...i,e]}}let ip=class{get _object(){return this._tool.object}get _operations(){return this._object.operations}constructor(t,e){this._tool=t,this._bounds=e,this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null;const a=this._tool,n=a.view;this.moveXYObjectManipulation=new gn({view:n,tool:a,object:this._object}),a.addHandles(this._createMoveXYObjectDragPipeline()),this.moveZManipulator=new Ju(n,Ji.CENTER_ON_CALLOUT),this.moveZManipulator.state|=Xa,a.manipulators.add(this.moveZManipulator),a.addHandles([this._createMoveZDragPipeline()]),a.addHandles([a.events.on("translate-stop",()=>{this._moveXYTooltipInfo=null,this._moveZTooltipInfo=null})])}destroy(){this.moveXYObjectManipulation.destroy(),this._tool.manipulators.remove(this.moveZManipulator),this.moveZManipulator.destroy()}forEachManipulator(t){this.moveXYObjectManipulation.forEachManipulator(t),t(this.moveZManipulator,R.TRANSLATE_Z)}updateManipulators(t,e){const a=this.moveZManipulator,n=El(tt.get(),t,Math.PI);n[12]=0,n[13]=0,n[14]=0,a.modelTransform=n,a.renderLocation=$(f.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.moveXYObjectManipulation.grabbing||this.moveXYObjectManipulation.dragging?this._computeMoveXYTooltipInfo():this.moveZManipulator.focused?this._computeMoveZTooltipInfo():null}_computeMoveXYTooltipInfo(){const t=this._tool,e=this._moveXYTooltipInfo??(this._moveXYTooltipInfo=new hn({sketchOptions:t.sketchOptions}));if(this.moveXYObjectManipulation.dragging){const a=this._bounds,n=a.mapBoundsStart.origin,o=a.mapBounds.origin,{renderSpatialReference:s}=t.view;if(!s)return null;const r=cs(n,o,s);if(r==null)return null;e.distance=r}else e.distance=xt;return e}_computeMoveZTooltipInfo(){const t=this._tool,e=this._moveZTooltipInfo??(this._moveZTooltipInfo=new ye({sketchOptions:t.sketchOptions}));if(this.moveZManipulator.dragging){const a=this._bounds,n=a.mapBoundsStart.origin,o=a.mapBounds.origin,{renderSpatialReference:s}=t.view;if(!s)return null;const r=Dl(n,o,s);if(r==null)return null;e.distance=r}else e.distance=xt;return e}_createMoveXYObjectDragPipeline(){return this.moveXYObjectManipulation.createDragPipeline((t,e,a)=>this._applyObjectMoveSteps(e,a))}_createMoveZDragPipeline(){if(!this._operations)return F();const t=this._operations.data.spatialReference;return Pt(this.moveZManipulator,(e,a,n)=>{const o=oi(e.renderLocation),s=a.next(Js(this._tool.view,o,t)).next(Ze());this._applyObjectMoveSteps(s,n)})}_applyObjectMoveSteps(t,e){const{_tool:a,_object:n}=this,o=t.next(s=>(s.action==="start"&&(a.inputState={type:"move"},this._bounds.backupMapBounds(),a.events.emit("translate-start",{object:n,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY})),s)).next(Pe()).next(this._moveDragUpdateGeometry()).next(s=>{const r={object:n,dxScreen:s.screenDeltaX,dyScreen:s.screenDeltaY};switch(s.action){case"start":case"update":(s.mapEnd.x-s.mapStart.x||s.mapEnd.y-s.mapStart.y||(s.mapEnd.z??0)-(s.mapStart.z??0))&&a.events.emit("translate",r);break;case"end":a.inputState=null,a.events.emit("translate-stop",r)}return s});return e.next(()=>{a.inputState!=null&&a.events.emit("translate-stop",{object:n,dxScreen:0,dyScreen:0}),a.cancel()}),o}_moveDragUpdateGeometry(){const t=this._tool;return e=>{if(t.inputState==null||t.inputState.type!=="move")return e;const a=e.action==="start"?jt.NEW_STEP:jt.ACCUMULATE_STEPS;if(this._operations){const n=this._operations.move(e.mapDeltaX,e.mapDeltaY,e.mapDeltaZ,a);this._bounds.updateMapBoundsFromOperation(n)}return e}}};const ap="theme-style";function np(i,t){return lp(rp(op(sp(i),t)),t.size)}function op(i,{accentColor:t,contrastColor:e}){const a=t.toHex(),n=t.a,o=e.toHex(),s=e.a,r=i.getElementsByTagNameNS("http://www.w3.org/2000/svg","style").namedItem(ap);return r&&(r.innerHTML=`
      .contrast-fill { fill: ${o}; fill-opacity: ${s}; }
      .contrast-stroke { stroke: ${o}; stroke-opacity: ${s};  }
      .accent-fill { fill: ${a}; fill-opacity: ${n}; }
      .accent-stroke { stroke: ${a}; stroke-opacity:  ${n}; }`),i}function sp(i){const t=i.split(",")[1],e=atob(t);return new DOMParser().parseFromString(e,"image/svg+xml")}function rp(i){const t=new XMLSerializer().serializeToString(i);return`data:image/svg+xml;base64,${btoa(t)}`}function lp(i,t){const e=new Image(t,t);return e.src=i,e}const cp="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1NiIgaGVpZ2h0PSI1NiIgZmlsbD0ibm9uZSIgdmVyc2lvbj0iMi4wIj48c3R5bGUgaWQ9InRoZW1lLXN0eWxlIj4uY29udHJhc3QtZmlsbHtmaWxsOiNmZmZ9LmNvbnRyYXN0LXN0cm9rZXtzdHJva2U6I2ZmZn0uYWNjZW50LWZpbGx7ZmlsbDojZmY3ZjAwO2ZpbGwtb3BhY2l0eTouNX08L3N0eWxlPjxwYXRoIGQ9Ik0yOCAwYTI4IDI4IDAgMSAxIDAgNTYgMjggMjggMCAwIDEgMC01NiIgY2xhc3M9ImFjY2VudC1maWxsIi8+PHBhdGggc3Ryb2tlLXdpZHRoPSI0Ljk5IiBkPSJNMjAuMDUgNDAuODZhMTUuMDUgMTUuMDUgMCAwIDAgMTcuMTQtMS41IDE1LjA1IDE1LjA1IDAgMCAwIDQuNDctMTYuNjUgMTUuMDUgMTUuMDUgMCAwIDAtMjIuNzItNy4xNSAxNS4wNSAxNS4wNSAwIDAgMC01LjUgNy4xNSIgY2xhc3M9ImNvbnRyYXN0LXN0cm9rZSIvPjxwYXRoIGQ9Im0xMC45NyAzNS41NyA1LjM4IDEyLjA3IDcuNzktMTMuNDd6IiBjbGFzcz0iY29udHJhc3QtZmlsbCIvPjwvc3ZnPg==",Ho=64;function hp(i,t){const{accentColor:e,contrastColor:a,preMultiplyAlpha:n}=t;return i.fromData(`heading-rotate:[accent:${e},contrast:${a},size:${Ho}]`,()=>new ec(np(cp,{accentColor:e,contrastColor:a,size:Ho}),{mipmap:!0,reloadable:!0,preMultiplyAlpha:n}))}function hr(i){const t=new tn,{vertex:e,fragment:a}=t;return en(e,i),t.include(Ds,i),t.attributes.add(T.POSITION,"vec3"),t.attributes.add(T.UV0,"vec2"),i.perspectiveInterpolation&&t.attributes.add(T.PERSPECTIVEDIVIDE,"float"),t.varyings.add("vpos","vec3"),i.multipassEnabled&&t.varyings.add("depth","float"),e.code.add(Y`
    void main(void) {
      vpos = position;
      ${i.multipassEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}
      vTexCoord = uv0;
      gl_Position = transformPosition(proj, view, vpos);

      ${i.perspectiveInterpolation?"gl_Position *= perspectiveDivide;":""}
    }
  `),t.include(ys,i),t.include(Ss,i),a.uniforms.add(new ic("tex",n=>n.texture),new Zi("opacity",n=>n.opacity)),t.varyings.add("vTexCoord","vec2"),i.transparencyPassType===wt.ColorAlpha&&(t.outputs.add("fragColor","vec4",0),t.outputs.add("fragAlpha","float",1)),a.include(Ms),a.code.add(Y`
    void main() {
      discardBySlice(vpos);
      ${i.multipassEnabled?"terrainDepthTest(depth);":""}
      fragColor = texture(tex, vTexCoord) * opacity;

      if (fragColor.a < ${Y.float(ac)}) {
        discard;
      }

      fragColor = highlightSlice(fragColor, vpos);
      ${i.transparencyPassType===wt.ColorAlpha?Y`
              fragColor = premultiplyAlpha(fragColor);
              fragAlpha = fragColor.a;`:""}
      ${i.output===yt.ObjectAndLayerIdColor?Y`
              fragColor = vec4(0,0,0,1);`:""}
    }
    `),t}const up=Object.freeze(Object.defineProperty({__proto__:null,build:hr},Symbol.toStringTag,{value:"Module"}));class ha extends an{initializeProgram(t){return new nn(t.rctx,ha.shader.get().build(this.configuration),ur)}_setPipelineState(t,e){const a=this.configuration,n=t===wt.NONE,o=t===wt.FrontFace;return ln({blending:a.output===yt.Color&&a.transparent?n?pp:ws(t):null,culling:Ps(a.cullFace),depthTest:{func:nc(t)},depthWrite:n?a.writeDepth?Cs:null:Os(t),drawBuffers:Es(t),colorWrite:cn,stencilWrite:a.hasOccludees?oc:null,stencilTest:a.hasOccludees?e?sc:rc:null,polygonOffset:n||o?null:lc(a.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipeline(t){return t?this._occludeePipelineState:super.getPipeline()}}ha.shader=new on(up,()=>Ja(()=>Promise.resolve().then(()=>zp),void 0));const pp=Oc(je.ONE,je.ONE_MINUS_SRC_ALPHA);class _t extends xs{constructor(){super(...arguments),this.output=yt.Color,this.cullFace=J.None,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.transparencyPassType=wt.NONE,this.multipassEnabled=!1,this.cullAboveGround=!1,this.perspectiveInterpolation=!0}}h([k({count:yt.COUNT})],_t.prototype,"output",void 0),h([k({count:J.COUNT})],_t.prototype,"cullFace",void 0),h([k()],_t.prototype,"hasSlicePlane",void 0),h([k()],_t.prototype,"transparent",void 0),h([k()],_t.prototype,"enableOffset",void 0),h([k()],_t.prototype,"writeDepth",void 0),h([k()],_t.prototype,"hasOccludees",void 0),h([k({count:wt.COUNT})],_t.prototype,"transparencyPassType",void 0),h([k()],_t.prototype,"multipassEnabled",void 0),h([k()],_t.prototype,"cullAboveGround",void 0),h([k()],_t.prototype,"perspectiveInterpolation",void 0),h([k({constValue:!1})],_t.prototype,"occlusionPass",void 0);const ur=new Map([[T.POSITION,0],[T.UV0,2],[T.PERSPECTIVEDIVIDE,3]]);let dp=class extends Zl{constructor(t){super(t,new mp),this.supportsEdges=!0,this.produces=new Map([[be.OPAQUE_MATERIAL,e=>Vn(e)||xi(e)&&!this.parameters.transparent],[be.TRANSPARENT_MATERIAL,e=>xi(e)&&this.parameters.transparent&&this.parameters.writeDepth],[be.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,e=>xi(e)&&this.parameters.transparent&&!this.parameters.writeDepth],[be.DRAPED_MATERIAL,e=>xi(e)||Vn(e)]]),this._vertexAttributeLocations=ur,this._configuration=new _t}getConfiguration(t,e){return this._configuration.output=t,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=e.transparencyPassType,this._configuration.enableOffset=e.camera.relativeElevation<cc,this._configuration.multipassEnabled=e.multipassEnabled,this._configuration.cullAboveGround=e.multipassTerrain.cullAboveGround,this._configuration.perspectiveInterpolation=this.parameters.perspectiveInterpolation,this._configuration}createGLMaterial(t){return new gp(t)}createBufferWriter(){const t=Xl.clone();return this.parameters.perspectiveInterpolation&&t.f32(T.PERSPECTIVEDIVIDE),new _p(t)}},gp=class extends yc{constructor(t){super({...t,...t.material.parameters})}_updateParameters(t){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(ha,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&(this._material.setParameters({hasOccludees:t.hasOccludees}),this._updateParameters(t))}beginSlot(t){return this._output===yt.Color&&this._updateOccludeeState(t),this._updateParameters(t)}};class _p extends Mc{write(t,e,a,n,o){for(const s of this.vertexBufferLayout.fields.keys()){const r=a.attributes.get(s);if(r)if(s===T.PERSPECTIVEDIVIDE){js(r.size===1);const l=n.getField(s,mc);l&&Sc(r,l,o)}else xc(s,r,t,e,n,o)}}}class mp extends Xo{constructor(){super(...arguments),this.transparent=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.cullFace=J.None,this.hasOccludees=!1,this.opacity=1,this.textureId=null,this.initTextureTransparent=!0,this.perspectiveInterpolation=!1}}class vp extends ct{constructor(t,e){const a=new dp({transparent:!0,writeDepth:!1,renderOccluded:D.Opaque,isDecoration:!0}),n=er.calloutWidth,o=new Wt({width:n,renderOccluded:D.OccludeAndTransparent,isDecoration:!0});super({view:t,...fp({imageMaterial:a,calloutMaterial:o})}),this._currentTexture=null,this._themeHandle=M(()=>t.effectiveTheme.accentColor,s=>{const r=Ya(s,.5),l=Wa(s),c=this._currentTexture,p=e(r,l);a.setParameters({textureId:p.texture.id}),o.setParameters({color:nt.toUnitRGBA(s)}),this._currentTexture=p,c==null||c.release()},j)}destroy(){var t;this._themeHandle.remove(),(t=this._currentTexture)==null||t.release(),super.destroy()}}function fp({imageMaterial:i,calloutMaterial:t}){const{focusMultiplier:e,calloutLength:a,discRadius:n}=er,o=n*e,s=(p,u)=>{const g=[0,1,2,2,3,0];return new bs(u,[[T.POSITION,new Aa([a-p,-p,0,a+p,-p,0,a+p,p,0,a-p,p,0],g,3,!0)],[T.UV0,new Aa([0,0,1,0,1,1,0,1],g,2,!0)]])},r=Ht(t,[[0,0,0],[a-n,0,0]]),l=Ht(t,[[0,0,0],[a-o,0,0]]),c=ae;return{autoScaleRenderObjects:!1,collisionPriority:1,collisionType:{type:"disc",direction:[0,0,1],offset:[a,0,0]},focusMultiplier:e,radius:n,renderObjects:[new w(s(n,i),S.Unfocused|c),new w(r,S.Unfocused|c),new w(s(o,i),S.Focused|c),new w(l,S.Focused|c)],state:c}}let bp=class{get _object(){return this._tool.object}get _operations(){return this._object.operations}constructor(t,e,a){var r;this._tool=t,this._bounds=e,this._snapRotation=a,this._rotateTooltipInfo=null,this._startAngle=0,this._endAngle=0;const n=this._tool,o=n.view,s=!((r=o._stage)!=null&&r.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result);this.rotateManipulator=new vp(o,(l,c)=>hp(o.textures,{accentColor:l,contrastColor:c,preMultiplyAlpha:s})),n.addHandles([this.rotateManipulator.events.on("grab-changed",l=>this._onRotateGrab(l)),this._createRotateDragPipeline(this.rotateManipulator)]),n.manipulators.add(this.rotateManipulator),n.addHandles([n.events.on("rotate-start",l=>this._startAngle=l.angle),n.events.on("rotate",l=>this._endAngle=l.angle),n.events.on("rotate-stop",()=>{this._startAngle=0,this._endAngle=0})])}destroy(){this._tool.manipulators.remove(this.rotateManipulator),this.rotateManipulator.destroy()}forEachManipulator(t){t(this.rotateManipulator,R.ROTATE)}updateManipulators(t,e){const a=this._bounds.mapBounds.plane[2]<0?Math.PI:0,n=as(tt.get(),t,a);n[12]=0,n[13]=0,n[14]=0,this.rotateManipulator.modelTransform=n,this.rotateManipulator.renderLocation=G(f.get(),e.origin,e.basis1)}getUpdatedTooltipInfo(){return this.rotateManipulator.focused?this._computeRotateTooltipInfo():null}_computeRotateTooltipInfo(){const t=this._rotateTooltipInfo??(this._rotateTooltipInfo=new Bc({sketchOptions:this._tool.sketchOptions}));return t.angle=this._startAngle-this._endAngle,t}_onRotateGrab({action:t,screenPoint:e}){const a=this._tool,n=this._bounds;if(t!=="start"||!e)return;const o=qu(n.displayBounds,a.view.renderCoordsHelper,fi.HEADING,bi()),s=Zs(a.view.state.camera,e);Fe(o,s,f.get())&&(n.backupMapBounds(),a.inputState={type:"rotate",rotatePlane:o})}_createRotateDragPipeline(t){const{_tool:e,_object:a}=this;return Pt(t,(n,o,s)=>{const r=e.inputState;r!=null&&(o.next(l=>(l.action==="start"&&e.events.emit("rotate-start",{object:a,angle:0}),l)).next(ra(e.view,r.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(r)).next(...this._snapRotation()).next(this._rotateDragUpdateGeometry()).next(l=>{const c={object:a,angle:gi(l.rotateAngle)};switch(l.action){case"start":case"update":e.events.emit("rotate",c);break;case"end":e.inputState=null,e.events.emit("rotate-stop",c)}return l}),s.next(()=>{e.inputState!=null&&e.events.emit("rotate-stop",{object:a,angle:0}),e.cancel()}))})}_rotateDragRenderPlaneToRotate(t){return e=>{const a=Be(t.rotatePlane),n=ir(e.renderStart,e.renderEnd,this._bounds.displayBounds.origin,a);return{...e,rotateAxis:a,rotateAngle:n}}}_rotateDragUpdateGeometry(){const t=this._bounds;return e=>{const a=lt(x(),t.mapBoundsStart.origin),n=e.action==="start"?jt.NEW_STEP:jt.ACCUMULATE_STEPS;if(this._operations){const o=this._operations.rotate(a,e.rotateAngle,n,Rs.REPLACE);_i(t.mapBoundsStart,t.mapBounds),t.updateMapBoundsFromOperation(o)}return e}}};class yp extends ct{constructor(t,e){const a=ca(e),n=a?Gu:jo,o=n*Hu,s=jo,r={renderOccluded:D.OccludeAndTransparent,isDecoration:!0},l=new Wt({...r,width:n}),c=new Wt({...r,width:o}),p=new Wt({...r,width:s});super({view:t,...gu,...Mp({isCorner:a,unfocusedMaterial:l,focusedMaterial:c,outlineMaterial:p})}),this._themeHandle=M(()=>t.effectiveTheme.accentColor,u=>{const g=nt.toUnitRGBA(u);l.setParameters({color:g}),c.setParameters({color:g}),p.setParameters({color:g})},j)}destroy(){this._themeHandle.remove(),super.destroy()}}function Mp({isCorner:i,unfocusedMaterial:t,focusedMaterial:e,outlineMaterial:a}){const n=i?[N(1,0,0),N(0,0,0),N(0,1,0)]:[N(1,0,0),N(-1,0,0)];return{renderObjects:[new w(Ht(t,n),S.Unfocused|Ci),new w(Ht(e,n),S.Focused|Ci),new w(Ht(a,n),cr)],collisionType:{type:"line",paths:[n]},radius:i?Bu:Zu,state:Ci}}class Sp{constructor(t,e){this._tool=t,this.mapBounds=si(),this.mapBoundsStart=si(),this.displayBounds=si(),t.addHandles(ai(()=>t.object,"modified-externally",()=>this._resetMapBounds(),{onListenerAdd:()=>this._resetMapBounds()})),this._onDisplayBoundsChanged=e}get displayBoundsMargin(){var o,s;const{view:t,object:e}=this._tool,a=U(e),n=((o=t.pointsOfInterest)==null?void 0:o.centerOnSurfaceFrequent.location)??((s=a==null?void 0:a.extent)==null?void 0:s.center);return n?xp*t.pixelSizeAt(n):0}backupMapBounds(){_i(this.mapBounds,this.mapBoundsStart)}updateDisplayBounds(){var t;this._calculateDisplayBounds(),(t=this._onDisplayBoundsChanged)==null||t.call(this)}updateMapBoundsFromOperation(t){Lc(t,this.mapBounds),this.updateDisplayBounds()}updateMapBoundsFromOperationInverse(t){Hc(t,this.mapBounds),this.updateDisplayBounds()}_resetMapBounds(){this._calculateMapBounds(),this.updateDisplayBounds()}_calculateMapBounds(){var p;const{view:t,attachmentOrigin:e,object:a}=this._tool,n=(p=a.operations)==null?void 0:p.data;if(!n)return;const o=n.geometry;this.spatialReference=o.spatialReference;const s=Eh(o);ni(s,s,-1);const r=t.spatialReference,l=o.spatialReference,c=e?t.pixelSizeAt(e)*Tl(r)/ls(l):0;kc(s,n,wp*c,this.mapBounds)}_calculateDisplayBounds(){const{view:t,attachmentOrigin:e}=this._tool,a=(e==null?void 0:e.z)??aa(this.mapBounds.origin,t.elevationProvider,Mi.fromElevationInfo(this._tool.object.elevationInfo),t.renderCoordsHelper),n=_i(this.mapBounds);n.origin[2]=a??0,Op(n,t.renderCoordsHelper,this.spatialReference,this.displayBoundsMargin,this.displayBounds)}}const xp=10,wp=80;function Op(i,t,e,a=0,n){n||(n=si()),t.toRenderCoords(i.origin,e,n.origin);const o=f.get();G(o,i.origin,i.basis1),G(o,o,i.basis2),t.toRenderCoords(o,e,o);const s=f.get();G(s,i.origin,i.basis1),$(s,s,i.basis2),t.toRenderCoords(s,e,s);const r=f.get();$(r,i.origin,i.basis1),$(r,r,i.basis2),t.toRenderCoords(r,e,r);const l=f.get();$(l,i.origin,i.basis1),G(l,l,i.basis2),t.toRenderCoords(l,e,l);const c=ne(f.get(),o,s,.5);$(c,c,n.origin);const p=ne(f.get(),r,l,.5);$(p,n.origin,p),ne(n.basis1,c,p,.5);const u=ne(f.get(),l,o,.5);$(u,u,n.origin);const g=ne(f.get(),s,r,.5);$(g,n.origin,g),ne(n.basis2,u,g,.5);const _=St(f.get(),n.basis1,n.basis2),m=St(_,_,n.basis1);return ut(m,m),it(n.basis2,m,di(n.basis2,m)),it(n.basis1,n.basis1,1+a/Mt(n.basis1)),it(n.basis2,n.basis2,1+a/Mt(n.basis2)),$l(n),n}function ko(i,t,e){return $(Re,$(Re,i.origin,i.basis1),i.basis2),fe(Di,Re,i.basis1,2),fe(Ea,Di,i.basis2,2),fe(Oa,Re,i.basis2,2),Re[2]=Di[2]=Ea[2]=Oa[2]=t,Zc({topLeft:Oa,topRight:Ea,bottomRight:Di,bottomLeft:Re,spatialReference:e})}const Oa=x(),Ea=x(),Di=x(),Re=x();class Ep{get _object(){return this._tool.object}get _operations(){return this._object.operations}get zMax(){if(!this._zMaxDirty||!this._operations)return this._zMax;const t=this._operations.data;if(t.geometry.hasZ){const e=t.coordinateHelper;this._zMax=Number.NEGATIVE_INFINITY;for(const a of t.components)for(const n of a.vertices){const o=e.getZ(n.pos)??0;this._zMax=Math.max(o,this._zMax)}}else this._zMax=0;return this._zMaxDirty=!1,this._zMax}constructor(t,e,a){this._tool=t,this._bounds=e,this._preserveAspectRatioStep=a,this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._scaleTooltipInfo=null,this._displayBoundsStart=si(),this._displayBoundsMarginStart=0,this._startScale=oe(),this._endScale=oe(),this._sizeStart=null,this._zMax=0,this._zMaxDirty=!0;const n=this._tool,o=n.view;this.resizeManipulators=this._resizeHandles.map(s=>{const r=new yp(o,s);return n.addHandles([r.events.on("grab-changed",l=>this._onResizeGrab(l)),this._createResizeDragPipeline(r,s)]),r}),n.manipulators.addMany(this.resizeManipulators),n.addHandles([n.events.on("scale-start",s=>{Zt(this._startScale,s.xScale,s.yScale),Zt(this._endScale,s.xScale,s.yScale)}),n.events.on("scale",s=>{Zt(this._endScale,s.xScale,s.yScale)}),n.events.on("scale-stop",()=>{Zt(this._startScale,0,0),Zt(this._endScale,0,0)})]),this._operations&&n.addHandles(this._operations.data.on("change",()=>{var s;((s=n.inputState)==null?void 0:s.type)!=="resize"&&(this._zMaxDirty=!0)}))}destroy(){this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()})}forEachManipulator(t){this.resizeManipulators.forEach(e=>t(e,R.SCALE))}updateManipulators(t,e){this.resizeManipulators.forEach((a,n)=>{Qu(a,this._resizeHandles[n],t,e)})}getUpdatedTooltipInfo(){return this.resizeManipulators.some(t=>t.focused)?this._computeScaleTooltipInfo():null}_computeScaleTooltipInfo(){const t=this._tool,e=this._scaleTooltipInfo??(this._scaleTooltipInfo=new Xc({sketchOptions:t.sketchOptions})),a=ko(this._bounds.mapBounds,this.zMax,this._bounds.spatialReference);return a==null?null:(e.xSize=a.xSize,e.ySize=a.ySize,this._sizeStart!=null&&this.resizeManipulators.some(n=>n.dragging)?(e.xScale=a.xSize.value/this._sizeStart.xSize.value,e.yScale=a.ySize.value/this._sizeStart.ySize.value):(e.xScale=1,e.yScale=1),e)}_onResizeGrab({action:t,screenPoint:e}){const a=this._tool,n=this._bounds;if(t!=="start"||!e)return;const o=Zs(a.view.state.camera,e);Fe(n.displayBounds.plane,o,f.get())&&(n.backupMapBounds(),_i(n.displayBounds,this._displayBoundsStart),this._displayBoundsMarginStart=n.displayBoundsMargin,this._sizeStart=ko(n.mapBoundsStart,this.zMax,n.spatialReference),a.inputState={type:"resize"})}_createResizeDragPipeline(t,e){const{_tool:a,_object:n}=this;return Pt(t,(o,s,r)=>{a.inputState!=null&&(s.next(l=>(l.action==="start"&&a.events.emit("scale-start",{object:n,xScale:1,yScale:1}),l)).next(ra(a.view,this._displayBoundsStart.plane)).next(l=>({...l,handle:e})).next(this._resizeDragRenderPlaneToFactors()).next(...this._preserveAspectRatioStep()).next(this._resizeDragUpdateGeometry()).next(l=>{const c={object:n,xScale:l.factor1,yScale:l.factor2};switch(l.action){case"start":case"update":a.events.emit("scale",c);break;case"end":a.inputState=null,a.events.emit("scale-stop",c)}return l}),r.next(()=>{a.inputState!=null&&a.events.emit("scale-stop",{object:n,xScale:1,yScale:1}),a.cancel()}))})}_resizeDragRenderPlaneToFactors(){const t=this._bounds;return e=>{const a=this._displayBoundsStart,n=e.handle.direction,o=t.displayBoundsMargin,s=this._displayBoundsMarginStart,r=lt(f.get(),a.origin);fe(r,r,a.basis1,-n[0]),fe(r,r,a.basis2,-n[1]);const l=$(f.get(),e.renderEnd,r),c=$(f.get(),e.renderStart,r),p=ca(e.handle),u=Za(a),g=Za(t.displayBounds)/u,_=(m,v)=>{if(m===0)return 1;let b=Mt(v),y=.5*m*di(v,l)/b;const O=y<0?-1:1;p&&(y+=(b-.5*m*di(v,c)/b)*O*g);const A=b<1.5*s?1:No;return b=Math.max(b-s,No),O>0&&(y-=o),O*Math.max(O*(y/b),A)};return{...e,factor1:_(n[0],a.basis1),factor2:_(n[1],a.basis2)}}}_resizeDragUpdateGeometry(){const t=this._bounds;return e=>{const a=lt(x(),t.mapBoundsStart.origin);fe(a,a,t.mapBoundsStart.basis1,-e.handle.direction[0]),fe(a,a,t.mapBoundsStart.basis2,-e.handle.direction[1]);const n=Zt(oe(),t.mapBoundsStart.basis1[0],t.mapBoundsStart.basis1[1]);qa(n,n);const o=e.action==="start"?jt.NEW_STEP:jt.ACCUMULATE_STEPS;if(this._operations){const s=this._operations.scale(a,n,e.factor1,e.factor2,o,Rs.REPLACE);_i(t.mapBoundsStart,t.mapBounds),t.updateMapBoundsFromOperation(s)}return e}}}const No=1e-6;class Tp{constructor(){this._lastDragEvent=null,this._next=null,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&this._lastDragEvent!=null&&this._next!=null){const e={...this._lastDragEvent,action:"update"};t&&Vo(e),this._next.execute(e)}this._enabled=t}createDragEventPipelineStep(){this._lastDragEvent=null;const t=new na;return this._next=t,[e=>(this._lastDragEvent=e.action!=="end"?{...e}:null,this._enabled&&Vo(e),e),t]}get test(){}}function Vo(i){const t=ca(i.handle)?Math.max(Math.abs(i.factor1),Math.abs(i.factor2)):i.handle.direction[0]===0?Math.abs(i.factor2):Math.abs(i.factor1);i.factor1=i.factor1<0?-t:t,i.factor2=i.factor2<0?-t:t}let $p=class{constructor(){this._lastDragEvent=null,this._next=null,this.incrementRadians=re(5),this._enabled=!1}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&this._lastDragEvent!=null&&this._next!=null){const e={...this._lastDragEvent,action:"update"};t&&this._adjustRotation(e),this._next.execute(e)}this._enabled=t}createDragEventPipelineStep(){this._lastDragEvent=null;const t=new na;return this._next=t,[e=>(this._lastDragEvent=e.action!=="end"?{...e}:null,this._enabled&&this._adjustRotation(e),e),t]}_adjustRotation(t){t.rotateAngle=Math.round(t.rotateAngle/this.incrementRadians)*this.incrementRadians}},st=class extends oa{get updating(){return!!this.object.updating}constructor(i){super(i),this.events=new Vt,this.enableZ=!0,this.enableScaling=!0,this.enableRotation=!0,this.sketchOptions=new ce,this._preserveAspectRatio=new Tp,this._snapRotation=new $p,this.grabbing=!1,this.inputState=null,this._attachmentOrigin=null,this.type="transform-3d",this._outlineVisualElement=null}initialize(){const{view:i,object:t}=this,e=this._bounds=new Sp(this,()=>this._updateManipulators());this._extentMove=new ip(this,e),this._extentScale=new Ep(this,e,()=>this._preserveAspectRatio.createDragEventPipelineStep()),this._extentRotate=new bp(this,e,()=>this._snapRotation.createDragEventPipelineStep()),this.addHandles([M(()=>this.enableZ,()=>this._updateManipulatorAvailability(this._extentMove.moveZManipulator,R.TRANSLATE_Z)),M(()=>this.enableScaling,()=>this._extentScale.forEachManipulator(s=>this._updateManipulatorAvailability(s,R.SCALE))),M(()=>this.enableRotation,()=>this._updateManipulatorAvailability(this._extentRotate.rotateManipulator,R.ROTATE))]),this._updateManipulators(),this._updateAllManipulatorAvailability();const a=sa({view:i,object:t,forEachManipulator:s=>this._forEachManipulator(s),onManipulatorsChanged:()=>F()});if(a!=null){const{visualElement:s}=a;s instanceof we&&(this._outlineVisualElement=s,this.addHandles(s.events.on("attachment-origin-changed",()=>this._bounds.updateDisplayBounds()))),this.addHandles(a)}this.addHandles([t.on("committed",()=>this._onGeometryChanged()),M(()=>this.object.visible,()=>this._updateAllManipulatorAvailability()),M(()=>this.object.isDraped,()=>this._graphicDrapedChanged(),j),M(()=>{var s;return(s=i.pointsOfInterest)==null?void 0:s.centerOnSurfaceFrequent.location},()=>e.updateDisplayBounds())]);const n=s=>{this.addHandles(s.events.on("grab-changed",()=>{this.grabbing=s.grabbing,this._updateAllManipulatorAvailability()}))};this._forEachManipulator(n);const o=(s,r)=>{this.addHandles(s.events.on("immediate-click",l=>{r===R.TRANSLATE_XY&&this.events.emit("immediate-click",{...l,object:t}),l.stopPropagation()}))};this._forEachManipulator(o),this._initializeTooltip(),this.finishToolCreation()}destroy(){this._extentMove.destroy(),this._extentScale.destroy(),this._extentRotate.destroy(),this.tooltip.destroy(),this._set("view",null),this._set("object",null)}_initializeTooltip(){const{view:i}=this,t=this.tooltip=new yi({view:i}),e=()=>{t.info=this._getUpdatedTooltipInfo()};this.addHandles([M(()=>this.sketchOptions.tooltips.effectiveEnabled,e),this.events.on("translate-start",e),this.events.on("translate",e),this.events.on("translate-stop",()=>this.tooltip.clear()),this.events.on("rotate-start",e),this.events.on("rotate",e),this.events.on("rotate-stop",e),this.events.on("scale-start",e),this.events.on("scale",e),this.events.on("scale-stop",e)]),this._forEachManipulator(a=>{this.addHandles([a.events.on("focus-changed",e),a.events.on("grab-changed",e),a.events.on("drag",n=>{n.action==="cancel"?this.tooltip.clear():e()})])})}_getUpdatedTooltipInfo(){return this.sketchOptions.tooltips.effectiveEnabled?this._extentMove.getUpdatedTooltipInfo()??this._extentScale.getUpdatedTooltipInfo()??this._extentRotate.getUpdatedTooltipInfo():null}_onGeometryChanged(){this._bounds.updateDisplayBounds()}_graphicDrapedChanged(){this.removeHandles(Fo),this._bounds.updateDisplayBounds(),this.object.isDraped&&this.addHandles(this.view.elevationProvider.on("elevation-change",i=>{this._attachmentOrigin!=null&&Jo(i.extent,this._attachmentOrigin.x,this._attachmentOrigin.y)&&this._bounds.updateDisplayBounds()}),Fo)}_updateManipulators(){if(!this.visible)return;const i=this._bounds.displayBounds,t=Wu(i,tt.get());this._extentMove.updateManipulators(t,i),this._extentScale.updateManipulators(t,i),this._extentRotate.updateManipulators(t,i)}_updateAllManipulatorAvailability(){this._forEachManipulator((i,t)=>this._updateManipulatorAvailability(i,t))}_updateManipulatorAvailability(i,t){const e=this.grabbing&&!i.grabbing;if(i.interactive=!e,i instanceof ct){const a=this.object.visible,n=this.enableZ&&Me(this.object.operations,this.object.elevationInfo);switch(t){case R.ROTATE:i.available=a&&this.enableRotation;break;case R.SCALE:i.available=a&&(this.enableScaling||this.enableRotation||n),i.interactive=!e&&this.enableScaling,i.state=this.enableScaling?Ci:cr;break;case R.TRANSLATE_Z:i.available=a&&n;break;default:i.available=a}}}_forEachManipulator(i){this._extentMove.forEachManipulator(i),this._extentScale.forEachManipulator(i),this._extentRotate.forEachManipulator(i)}get preserveAspectRatio(){return this._preserveAspectRatio.enabled}set preserveAspectRatio(i){this._preserveAspectRatio.enabled=i,this._set("preserveAspectRatio",i)}get snapRotation(){return this._snapRotation.enabled}set snapRotation(i){this._snapRotation.enabled=i,this._set("snapRotation",i)}get attachmentOrigin(){var t,e,a;const i=this.object.isDraped?null:(t=this._outlineVisualElement)==null?void 0:t.attachmentOrigin;return this._attachmentOrigin=i??this.object.origin??((a=(e=U(this.object))==null?void 0:e.extent)==null?void 0:a.center),this._attachmentOrigin}reset(){}cancel(){var i;if(this.canUndo){const t=(i=this.object.operations)==null?void 0:i.undo();t&&this._bounds.updateMapBoundsFromOperationInverse(t)}this.inputState=null}get canUndo(){var i;return!!((i=this.object.operations)!=null&&i.canUndo)}undo(){var i;if(this.inputState!=null)this.view.activeTool=null;else if(this.canUndo){const t=(i=this.object.operations)==null?void 0:i.undo();t&&this._bounds.updateMapBoundsFromOperationInverse(t)}}get canRedo(){var i;return!!((i=this.object.operations)!=null&&i.canRedo)}redo(){var i;if(this.canRedo){const t=(i=this.object.operations)==null?void 0:i.redo();t&&this._bounds.updateMapBoundsFromOperation(t)}}get test(){}};h([d()],st.prototype,"updating",null),h([d({constructOnly:!0,nonNullable:!0})],st.prototype,"view",void 0),h([d({constructOnly:!0,nonNullable:!0})],st.prototype,"object",void 0),h([d()],st.prototype,"enableZ",void 0),h([d()],st.prototype,"enableScaling",void 0),h([d()],st.prototype,"enableRotation",void 0),h([d({constructOnly:!0,type:ce})],st.prototype,"sketchOptions",void 0),h([d()],st.prototype,"preserveAspectRatio",null),h([d()],st.prototype,"snapRotation",null),h([d()],st.prototype,"grabbing",void 0),h([d()],st.prototype,"inputState",void 0),h([d({readOnly:!0})],st.prototype,"type",void 0),h([d()],st.prototype,"tooltip",void 0),st=h([H("esri.views.3d.interactive.editingTools.transform.ExtentTransformTool")],st);const Fo="draped-elevation-changes";function Ap(i){return i!=null&&i.type==="mesh"?Ip(i):Rp(i)}function Ip(i){return Yc(i.vertexSpace)?Dp(i,i.transform,i.vertexSpace):jp(i)}function Rp(i){let t=i,e=null;return{undo(a){e=a.geometry,a.geometry=t},redo(a){t=a.geometry,a.geometry=e}}}function Dp(i,t,e){let a=t==null?void 0:t.clone(),n=oi(e.origin),o=null,s=null;return{undo:()=>{var r;o=(r=i.transform)==null?void 0:r.clone(),s=oi(e.origin),i.transform=a,i.vertexSpace.origin=n},redo:()=>{var r;a=(r=i.transform)==null?void 0:r.clone(),n=oi(e.origin),i.transform=o,i.vertexSpace.origin=s}}}function jp(i){let t,e=i.vertexAttributes.clonePositional();return{undo:()=>{t=i.vertexAttributes.clonePositional(),i.vertexAttributes=e},redo:()=>{e=i.vertexAttributes.clonePositional(),i.vertexAttributes=t}}}const Ta=Symbol();let ge=class extends Vt.EventedAccessor{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}get elevationInfo(){return Al(this.graphic)}get visible(){return this._graphicState.displaying}get isDraped(){return this._graphicState.isDraped}get origin(){return _u(this.view,this.graphic)}constructor(i){super(i),this._updatingHandles=new ea}destroy(){this._operations=V(this._operations),this._updatingHandles.destroy()}initialize(){this._graphicState=new Yo({graphic:this.graphic}),this._graphicState.on("changed",()=>this.emit("committed")),this.addHandles(this.view.trackGraphicState(this._graphicState)),this.addHandles(this._updatingHandles.add(()=>this.graphic.geometry,i=>{var e,a;const t=(e=this._operations)==null?void 0:e.data.geometry;if(i!==t){if(!i||(i==null?void 0:i.type)==="multipoint"||(i==null?void 0:i.type)==="extent")return V(this._operations),this.removeHandles(Ta),void(this._operations=null);if((a=this._operations)!=null&&a.trySetGeometry(i))this.emit("modified-externally");else{V(this._operations),this.removeHandles(Ta);const n=rn.fromGeometry(i,this.view.state.viewingMode);this._operations=n,this.addHandles(n.data.on("change",()=>this.graphic.geometry=n.data.geometry),Ta)}}},j))}createManipulator(i){return new Wc({view:this.view,graphic:this.graphic,...i})}maskOccludee(){return this.view.maskOccludee(this.graphic)}endInteraction(){const i=this.graphic.geometry;(i==null?void 0:i.type)==="mesh"&&this.graphic.notifyMeshTransformChanged({action:ka.UpdateFastLocalOrigin})}toMap(i){return this.view.toMap(i,{include:[this.graphic]})}createUndoRecord(){const{graphic:{geometry:i}}=this;return Ap(i)}};h([d({constructOnly:!0})],ge.prototype,"view",void 0),h([d({constructOnly:!0})],ge.prototype,"graphic",void 0),h([d()],ge.prototype,"_operations",void 0),h([d()],ge.prototype,"operations",null),h([d()],ge.prototype,"updating",null),ge=h([H("esri.views.3d.interactive.editingTools.ManipulatedObject3DGraphic")],ge);const Pp=Object.freeze(Object.defineProperty({__proto__:null,build:ks},Symbol.toStringTag,{value:"Module"})),Cp=Object.freeze(Object.defineProperty({__proto__:null,build:sr},Symbol.toStringTag,{value:"Module"})),zp=Object.freeze(Object.defineProperty({__proto__:null,build:hr},Symbol.toStringTag,{value:"Module"}));export{Te as DrawGraphicTool3D,st as ExtentTransformTool,ge as ManipulatedObject3DGraphic,ft as MoveTool3D,X as ReshapeTool3D,dt as TransformTool3D};
