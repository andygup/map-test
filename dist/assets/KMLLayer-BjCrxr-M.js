import{A as e,AT as t,DT as n,Dh as r,FC as i,Ha as a,Jw as o,L as s,Li as c,M as l,OT as u,Q_ as d,Vh as f,WC as p,Y_ as m,Z_ as h,ax as g,ba as _,cv as v,dE as y,gD as b,iv as x,j as S,jT as C,nv as w,rE as T,tv as E,ua as D,wx as O,xa as k}from"./index-CzMixifc.js";import{a as A,i as j,n as M,t as N}from"./kmlUtils-eVLP8DlM.js";var P=Symbol(`isKMLGraphicOrigin`),F,I=class extends _{get[(F=P,k)](){return this.layer}constructor(e,t){super(),this[F]=!0,this.type=`kml`,this.layer=e,this.sublayer=t}get id(){return`${this.layer.id}:__${this.sublayer.id}__`}},L,R=L=class extends v(p(f)){constructor(...e){super(...e),this.description=null,this.fullExtent=null,this.id=null,this.networkLink=null,this.parent=null,this.sublayers=null,this.title=null,this.sourceJSON=null,this.layer=null,this.addHandles([d(()=>this.sublayers,`after-add`,({item:e})=>{e.parent=this,e.layer=this.layer},h),d(()=>this.sublayers,`after-remove`,({item:e})=>{e.layer=e.parent=null},h),w(()=>this.sublayers,(e,t)=>{if(t)for(let e of t)e.layer=e.parent=null;if(e)for(let t of e)t.parent=this,t.layer=this.layer},h),w(()=>this.layer,e=>{if(this.sublayers)for(let t of this.sublayers)t.layer=e},h)])}initialize(){E(()=>this.networkLink).then(()=>E(()=>!0===this.visible)).then(()=>this.load())}load(e){if(!this.networkLink||this.networkLink.viewFormat)return;let t=e==null?null:e.signal,n=this._fetchService(this._get(`networkLink`)?.href??``,t).then(e=>{let t=N(e.sublayers);this.fullExtent=g.fromJSON(t),this.sourceJSON=e;let n=T(x.ofType(L),M(L,e));this.sublayers?this.sublayers.addMany(n):this.sublayers=n,this.layer?.emit(`sublayer-update`),this.layer&&this.layer.notifyChange(`visibleSublayers`)});return this.addResolvingPromise(n),Promise.resolve(this)}get visible(){return this._get(`visible`)}set visible(e){this._get(`visible`)!==e&&(this._set(`visible`,e),this.layer&&this.layer.notifyChange(`visibleSublayers`))}readVisible(e,t){return!!t.visibility}get origin(){return this.layer?new I(this.layer,this):null}_fetchService(e,t){return A(e,this.layer.outSpatialReference,this.layer.refreshInterval,t).then(e=>j(e.data))}};b([n()],R.prototype,`description`,void 0),b([n({type:g})],R.prototype,`fullExtent`,void 0),b([n()],R.prototype,`id`,void 0),b([n({readOnly:!0,value:null})],R.prototype,`networkLink`,void 0),b([n({json:{write:{allowNull:!0}}})],R.prototype,`parent`,void 0),b([n({type:x.ofType(R),json:{write:{allowNull:!0}}})],R.prototype,`sublayers`,void 0),b([n({value:null,json:{read:{source:`name`,reader:e=>y(e)}}})],R.prototype,`title`,void 0),b([n({value:!0})],R.prototype,`visible`,null),b([C(`visible`,[`visibility`])],R.prototype,`readVisible`,null),b([n()],R.prototype,`sourceJSON`,void 0),b([n()],R.prototype,`layer`,void 0),b([n()],R.prototype,`origin`,null),R=L=b([u(`esri.layers.support.KMLSublayer`)],R);var z=[`kml`,`xml`],B=class extends D(S(e(s(l(a(r)))))){constructor(...e){super(...e),this._visibleFolders=[],this.allSublayers=new m({getCollections:()=>[this.sublayers],getChildrenFunction:e=>e.sublayers}),this.outSpatialReference=O.WGS84,this.path=null,this.legendEnabled=!1,this.operationalLayerType=`KML`,this.sublayers=null,this.type=`kml`,this.url=null}initialize(){this.addHandles([w(()=>this.sublayers,(e,t)=>{t&&t.forEach(e=>{e.parent=null,e.layer=null}),e&&e.forEach(e=>{e.parent=this,e.layer=this})},h),this.on(`sublayer-update`,()=>this.notifyChange(`fullExtent`))])}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}get sublayerById(){let e=new Map;for(let t of this.allSublayers)e.set(t.id,t);return e}readSublayersFromItemOrWebMap(e,t){this._visibleFolders=t.visibleFolders}readSublayers(e,t,n){return M(R,t,n,this._visibleFolders)}writeSublayers(e,t){let n=[],r=e.toArray();for(;r.length;){let e=r[0];e.networkLink||(e.visible&&n.push(e.id),e.sublayers&&r.push(...e.sublayers.toArray())),r.shift()}t.visibleFolders=n}get title(){let e=this._get(`title`);return e&&this.originOf(`title`)!==`defaults`?e:this.url?i(this.url,z)||`KML`:e}set title(e){this._set(`title`,e)}get visibleSublayers(){let e=this.sublayers,t=[],n=e=>{e.visible&&(t.push(e),e.sublayers&&e.sublayers.forEach(n))};return e?.forEach(n),t}get fullExtent(){return this._recomputeFullExtent()}load(e){let t=e==null?null:e.signal;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:[`KML`],supportsData:!1},e).catch(o).then(()=>this._fetchService(t))),Promise.resolve(this)}destroy(){super.destroy(),this.allSublayers.destroy()}async _fetchService(e){let t=await Promise.resolve().then(()=>this.resourceInfo?{ssl:!1,data:this.resourceInfo}:A(this.url??``,this.outSpatialReference,this.refreshInterval,e)),n=j(t.data);n&&this.read(n,{origin:`service`})}_recomputeFullExtent(){let e=null;this.extent!=null&&(e=this.extent.clone());let t=n=>{if(n.sublayers)for(let r of n.sublayers.items)t(r),r.visible&&r.fullExtent&&(e==null?e=r.fullExtent.clone():e.union(r.fullExtent))};return t(this),e}};b([n({readOnly:!0})],B.prototype,`allSublayers`,void 0),b([n({readOnly:!0})],B.prototype,`sublayerById`,null),b([n({type:O})],B.prototype,`outSpatialReference`,void 0),b([n({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],B.prototype,`path`,void 0),b([n({readOnly:!0,json:{read:!1,write:!1}})],B.prototype,`legendEnabled`,void 0),b([n({type:[`show`,`hide`,`hide-children`]})],B.prototype,`listMode`,void 0),b([n({type:[`KML`]})],B.prototype,`operationalLayerType`,void 0),b([n({})],B.prototype,`resourceInfo`,void 0),b([n({type:x.ofType(R),json:{write:{ignoreOrigin:!0}}})],B.prototype,`sublayers`,void 0),b([C([`web-map`,`portal-item`],`sublayers`,[`visibleFolders`])],B.prototype,`readSublayersFromItemOrWebMap`,null),b([C(`service`,`sublayers`,[`sublayers`])],B.prototype,`readSublayers`,null),b([t(`sublayers`)],B.prototype,`writeSublayers`,null),b([n({readOnly:!0,json:{read:!1}})],B.prototype,`type`,void 0),b([n({json:{origins:{"web-map":{read:{source:`title`}}},write:{ignoreOrigin:!0}}})],B.prototype,`title`,null),b([n(c)],B.prototype,`url`,void 0),b([n({readOnly:!0})],B.prototype,`visibleSublayers`,null),b([n({type:g})],B.prototype,`extent`,void 0),b([n()],B.prototype,`fullExtent`,null),B=b([u(`esri.layers.KMLLayer`)],B);var V=B;export{V as default};