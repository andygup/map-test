import{$T as e,CE as t,DS as n,En as r,Lx as i,Px as a,SC as o,ZS as s,Z_ as c,kC as l,xd as u,zC as d}from"./index-BN8X5Ryz.js";import{t as f}from"./OptimizedFeatureSet-CLjmRHYn.js";import{a as p,s as m,u as h}from"./featureConversionUtils-o9-cJXzl.js";import{r as g}from"./clientSideDefaults-Iizf0eUh.js";import{n as _,r as v,t as y}from"./geojson-Dz-UDVkw.js";import{r as b}from"./sourceUtils-DJLVoxjN.js";var x=()=>t.getLogger(`esri.layers.ogc.ogcFeatureUtils`),S=`startindex`,C=new Set([S,`offset`]),w=`http://www.opengis.net/def/crs/`,T=`${w}OGC/1.3/CRS84`;async function E(t,n,i={},a=5){let{links:c}=t,l=V(c,`items`,`application/geo+json`)||V(c,`http://www.opengis.net/def/rel/ogc/1.0/items`,`application/geo+json`);if(l==null)throw new e(`ogc-feature-layer:missing-items-page`,`Missing items url`);let{apiKey:f,customParameters:p,signal:m}=i,h=d(l.href,t.landingPage.url),_={limit:a,...p,token:f},b=o(h,_),C={accept:`application/geo+json`},{data:w}=await s(b,{signal:m,headers:C}),T=H(b,a,w.links)??S;y(w);let E=w.numberMatched,D=v(w,{geometryType:n.geometryType}),O=n.fields||D.fields||[],k=n.hasZ==null?D.hasZ:n.hasZ,A=D.geometryType,j=n.objectIdField||D.objectIdFieldName||`OBJECTID`,M=n.timeInfo,N=O.find(({name:e})=>e===j);if(N)N.editable=!1,N.nullable=!1;else{if(!D.objectIdFieldType)throw new e(`ogc-feature-layer:missing-feature-id`,`Collection geojson require a feature id as a unique identifier`);O.unshift({name:j,alias:j,type:D.objectIdFieldType===`number`?`esriFieldTypeOID`:`esriFieldTypeString`,editable:!1,nullable:!1})}if(j!==D.objectIdFieldName){let e=O.find(({name:e})=>e===D.objectIdFieldName);e&&(e.type=`esriFieldTypeInteger`)}O===D.fields&&D.unknownFields.length>0&&x().warn({name:`ogc-feature-layer:unknown-field-types`,message:`Some fields types couldn't be inferred from the features and were dropped`,details:{unknownFields:D.unknownFields}});for(let t of O){if(t.name??=t.alias,t.alias??=t.name,t.type!==`esriFieldTypeOID`&&t.type!==`esriFieldTypeGlobalID`&&(t.editable=t.editable==null||!!t.editable,t.nullable=t.nullable==null||!!t.nullable),!t.name)throw new e(`ogc-feature-layer:invalid-field-name`,`field name is missing`,{field:t});if(!u.jsonValues.includes(t.type))throw new e(`ogc-feature-layer:invalid-field-type`,`invalid type for field "${t.name}"`,{field:t})}if(M){let e=new r(O);if(M.startTimeField){let t=e.get(M.startTimeField);t?(M.startTimeField=t.name,t.type=`esriFieldTypeDate`):M.startTimeField=null}if(M.endTimeField){let t=e.get(M.endTimeField);t?(M.endTimeField=t.name,t.type=`esriFieldTypeDate`):M.endTimeField=null}if(M.trackIdField){let t=e.get(M.trackIdField);t?M.trackIdField=t.name:(M.trackIdField=null,x().warn({name:`ogc-feature-layer:invalid-timeInfo-trackIdField`,message:`trackIdField is missing`,details:{timeInfo:M}}))}M.timeReference||={timeZoneIANA:`UTC`},M.startTimeField||M.endTimeField||(x().warn({name:`ogc-feature-layer:invalid-timeInfo`,message:`startTimeField and endTimeField are missing`,details:{timeInfo:M}}),M=void 0)}return{drawingInfo:A?g(A):null,extent:B(t),geometryType:A,fields:O,hasZ:!!k,objectIdField:j,paginationParameter:T,timeInfo:M,featureCount:E}}async function D(t,n={}){let{links:r,url:i}=t,a=V(r,`data`,`application/json`)??V(r,`http://www.opengis.net/def/rel/ogc/1.0/data`,`application/json`);if(!a)throw new e(`ogc-feature-layer:missing-collections-page`,`Missing collections url`);let{apiKey:o,customParameters:c,signal:l}=n,u=d(a.href,i),{data:f}=await s(u,{signal:l,headers:{accept:`application/json`},query:{...c,token:o}});for(let e of f.collections)e.landingPage=t;return f}async function O(t,n={}){let{links:r,url:i}=t,a=V(r,`conformance`,`application/json`)||V(r,`http://www.opengis.net/def/rel/ogc/1.0/conformance`,`application/json`);if(a==null)throw new e(`ogc-feature-layer:missing-conformance-page`,`Missing conformance url`);let{apiKey:o,customParameters:c,signal:l}=n,u=d(a.href,i),{data:f}=await s(u,{signal:l,headers:{accept:`application/json`},query:{...c,token:o}});return f}async function k(e,t={}){let{apiKey:n,customParameters:r,signal:i}=t,{data:a}=await s(e,{signal:i,headers:{accept:`application/json`},query:{...r,token:n}});return a.url=e,a}async function A(e,t={}){let{links:n,url:r}=e,i=V(n,`service-desc`,`application/vnd.oai.openapi+json;version=3.0`);if(i==null)return x().warn(`ogc-feature-layer:missing-openapi-page`,`The OGC API-Features server does not have an OpenAPI page.`),null;let{apiKey:a,customParameters:o,signal:c}=t,l=d(i.href,r),{data:u}=await s(l,{signal:c,headers:{accept:`application/vnd.oai.openapi+json;version=3.0`},query:{...o,token:a}});return u}function j(e){let t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),n=t?.groups;if(!n)return null;let{authority:r,code:a}=n;switch(r.toLowerCase()){case`ogc`:switch(a.toLowerCase()){case`crs27`:return i.GCS_NAD_1927.wkid;case`crs83`:return 4269;case`crs84`:case`crs84h`:return i.WGS84.wkid;default:return null}case`esri`:case`epsg`:{let e=Number.parseInt(a,10);return Number.isNaN(e)?null:e}default:return null}}async function M(e,t,n){let r=await N(e,t,n);return h(r)}async function N(t,o,c){let{collection:{links:l,landingPage:{url:u}},layerDefinition:h,maxRecordCount:g,queryParameters:{apiKey:v,customParameters:y},spatialReference:x,supportedCrs:S}=t,C=V(l,`items`,`application/geo+json`)||V(l,`http://www.opengis.net/def/rel/ogc/1.0/items`,`application/geo+json`);if(!C)throw new e(`ogc-feature-layer:missing-items-page`,`Missing items url`);let{geometry:w,num:T,start:E,timeExtent:D,where:O}=o;if(o.objectIds)throw new e(`ogc-feature-layer:query-by-objectids-not-supported`,`Queries with object ids are not supported`);let k=i.fromJSON(x),A=o.outSpatialReference??k,j=A.isWGS84?null:F(A,S),M=z(w,S),N=L(D),P=R(O),I=T??(E==null?g:10),B=E===0?void 0:E,{fields:H,geometryType:U,hasZ:W,objectIdField:G,paginationParameter:K}=h,q=d(C.href,u),{data:J}=await s(q,{...c,query:{...y,...M,crs:j,datetime:N,query:P,limit:I,[K]:B,token:v},headers:{accept:`application/geo+json`}}),Y=_(J,{geometryType:U,hasZ:W,objectIdField:G}),X=Y.length===I&&!!V(J.links??[],`next`,`application/geo+json`),Z=new r(H);for(let e of Y){let t={};b(Z,t,e.attributes,!0);for(let e of Z.fields)e.nullable&&!(e.name in t)&&(t[e.name]=null);t[G]=e.attributes[G],e.attributes=t}if(!j&&A.isWebMercator){for(let e of Y)if(e.geometry!=null&&U!=null){let t=m(e.geometry,U,W,!1);t.spatialReference=i.WGS84,e.geometry=p(a(t,A))}}for(let e of Y)e.objectId=e.attributes[G];let Q=j||!j&&A.isWebMercator?A.toJSON():n,$=new f;return $.exceededTransferLimit=X,$.features=Y,$.fields=H,$.geometryType=U,$.hasZ=W,$.spatialReference=Q,$}function P(e){return e!=null&&e.type===`extent`}function F(e,t){let{isWebMercator:n,wkid:r,latestWkid:i}=e;if(!r&&!i)return null;let a=n?t[3857]??t[102100]??t[102113]??t[900913]:r&&t[r]||i&&t[i];return a?`${w}${a}`:null}function I(e){if(!e)return``;let{xmin:t,ymin:n,xmax:r,ymax:i}=e;return`${t},${n},${r},${i}`}function L(e){if(!e)return null;let{start:t,end:n}=e;return`${t==null?`..`:t.toISOString()}/${n==null?`..`:n.toISOString()}`}function R(e){return e&&e!==`1=1`?e:null}function z(e,t){if(!P(e))return null;let{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:I(e)};let r=F(n,t);return r==null?n.isWebMercator?{bbox:I(a(e,i.WGS84))}:null:{bbox:I(e),"bbox-crs":r}}function B(e){let t=e.extent?.spatial;if(!t)return null;let n=t.bbox[0],r=n.length===4,[a,o]=n,s=r?void 0:n[2];return{xmin:a,ymin:o,xmax:r?n[2]:n[3],ymax:r?n[3]:n[4],zmin:s,zmax:r?void 0:n[5],spatialReference:i.WGS84.toJSON()}}function V(e,t,n){return e.find(({rel:e,type:r})=>e===t&&r===n)??e.find(({rel:e,type:n})=>e===t&&!n)}function H(e,t,n){if(!n)return;let r=V(n,`next`,`application/geo+json`),i=l(r?.href)?.query;if(!i)return;let a=l(e).query,o=Object.keys(a??{});return Object.entries(i).filter(([e])=>!o.includes(e)).find(([e,n])=>C.has(e.toLowerCase())&&Number.parseInt(n,10)===t)?.[0]}export{N as a,A as c,k as i,D as l,M as n,E as o,O as r,w as s,j as t,T as u};