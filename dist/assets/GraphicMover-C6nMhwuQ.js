import{Aw as e,BT as t,FE as n,Ld as r,Rd as i,VT as a,Vd as o,kD as s,ng as c,od as l,pv as u,rd as d,uv as f,vv as p}from"./index-BN8X5Ryz.js";import{i as m}from"./layerViewUtils-CJcMVuwG.js";import{t as h}from"./GraphicsLayer-DBcl42yN.js";import{n as g,r as _}from"./layerUtils-BZgsYerz.js";import{a as v}from"./drawUtils-BUBS53Cs.js";var y=class extends e{constructor(e){super(e),this._layerViewCache=new Map,this.highlightName=d,this.view=null}add(e,t){let n=!e||Array.isArray(e)?e:[e];if(!n?.length)return;let r=t??this.highlightName;n.forEach(e=>this._highlight(e,r))}getKeyForFeature(e){let t=e.getObjectId();return t==null?`uid:${e.uid}`:`oid:${t}`}remove(e){let t=!e||Array.isArray(e)?e:[e];t?.length&&t.forEach(e=>e&&this._removeHighlight(this.getKeyForFeature(e)))}removeByKey(e){e?.forEach(e=>e&&this._removeHighlight(e))}removeAll(){this.removeAllHandles()}update(e,t){this.remove(e),this.add(e,t)}_highlight(e,t){let n=e.layer??e.sourceLayer;if(!n)return;let r=this._layerViewCache.get(n);if(r)return void this.addHandles(r.highlight(e,{name:t}),this.getKeyForFeature(e));let i=g(this.view,n);m(i)&&(this._layerViewCache.set(n,i),this.addHandles(i.highlight(e,{name:t}),this.getKeyForFeature(e)))}_removeHighlight(e){this.removeHandles(e)}};s([t()],y.prototype,`_layerViewCache`,void 0),s([t()],y.prototype,`highlightName`,void 0),s([t()],y.prototype,`view`,void 0),y=s([a(`esri.views.draw.support.HighlightHelper`)],y);var b=y,x=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-click`}},S=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-double-click`}},C=class{constructor(e,t,n,r,i,a,o,s,c,l){this.graphic=e,this.allGraphics=t,this.index=n,this.x=r,this.y=i,this.dx=a,this.dy=o,this.totalDx=s,this.totalDy=c,this.viewEvent=l,this.defaultPrevented=!1,this.type=`graphic-move-start`}preventDefault(){this.defaultPrevented=!0}},w=class{constructor(e,t,n,r,i,a,o,s,c,l){this.graphic=e,this.allGraphics=t,this.index=n,this.x=r,this.y=i,this.dx=a,this.dy=o,this.totalDx=s,this.totalDy=c,this.viewEvent=l,this.defaultPrevented=!1,this.type=`graphic-move`}preventDefault(){this.defaultPrevented=!0}},T=class{constructor(e,t,n,r,i,a,o,s,c,l){this.graphic=e,this.allGraphics=t,this.index=n,this.x=r,this.y=i,this.dx=a,this.dy=o,this.totalDx=s,this.totalDy=c,this.viewEvent=l,this.defaultPrevented=!1,this.type=`graphic-move-stop`}preventDefault(){this.defaultPrevented=!0}},E=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-pointer-over`}},D=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-pointer-out`}},O=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-pointer-down`}},k=class{constructor(e,t,n,r,i){this.graphic=e,this.index=t,this.x=n,this.y=r,this.viewEvent=i,this.type=`graphic-pointer-up`}},A=`indicator-symbols`,j=class extends p{constructor(e){super(e),this._activeGraphic=null,this._dragEvent=null,this._hoverGraphic=null,this._indicators=[],this._initialDragGeometry=null,this._layerViews=null,this.type=`graphic-mover`,this.callbacks={onGraphicClick(){},onGraphicDoubleClick(){},onGraphicMoveStart(){},onGraphicMove(){},onGraphicMoveStop(){},onGraphicPointerOver(){},onGraphicPointerOut(){},onGraphicPointerDown(){},onGraphicPointerUp(){}},this.enableMoveAllGraphics=!1,this.graphics=[],this.highlightName=null,this.highlightsEnabled=!1,this.indicatorsEnabled=!1,this._defaultLayer=new h({listMode:`hide`,internal:!0,title:`GraphicMover highlight layer`}),this.layer=this._defaultLayer,this.view=null}initialize(){_(this.view,this.layer),this._highlightHelper=new b({view:this.view}),this.refresh(),this.addHandles([u(()=>this.graphics.length,()=>this.refresh()),f(()=>this.view?.ready,()=>{this.addHandles([this.view.on(`immediate-click`,e=>this._clickHandler(e),c.TOOL),this.view.on(`double-click`,e=>this._doubleClickHandler(e),c.TOOL),this.view.on(`pointer-down`,e=>this._pointerDownHandler(e),c.TOOL),this.view.on(`pointer-move`,e=>this._pointerMoveHandler(e),c.TOOL),this.view.on(`pointer-up`,e=>this._pointerUpHandler(e),c.TOOL),this.view.on(`drag`,e=>this._dragHandler(e),c.TOOL),this.view.on(`key-down`,e=>this._keyDownHandler(e),c.TOOL)])},{once:!0,initial:!0}),u(()=>this.view,e=>{this._highlightHelper.removeAll(),this._highlightHelper.view=e}),u(()=>[this.highlightsEnabled,this.highlightName],()=>{this._highlightHelper?.removeAll(),this._setUpHighlights()})])}destroy(){this._removeIndicators(),this.view.map?.remove(this.layer),this._defaultLayer.destroy(),this.reset()}get state(){let e=this.view.ready,t=this.graphics.length>0,n=this._activeGraphic;return e&&t?n?`moving`:`active`:e?`ready`:`disabled`}refresh(){this.reset(),this._setup()}reset(){this._activeGraphic=null,this._hoverGraphic=null,this._dragEvent=null,this._highlightHelper.removeAll()}updateGeometry(e,t){let n=this.graphics[e];n&&(n.set(`geometry`,t),this._setUpIndicators())}_setup(){this._setUpHighlights(),this._setUpIndicators(),this._syncLayerViews()}_clickHandler(e){let t=this._findTargetGraphic(l(e));if(t){let n=new x(t,this.graphics.indexOf(t),e.x,e.y,e);this.emit(`graphic-click`,n),this.callbacks.onGraphicClick?.(n)}}_doubleClickHandler(e){let t=this._findTargetGraphic(l(e));if(t){let n=new S(t,this.graphics.indexOf(t),e.x,e.y,e);this.emit(`graphic-double-click`,n),this.callbacks.onGraphicDoubleClick?.(n)}}_pointerDownHandler(e){let t=this._findTargetGraphic(l(e));if(t){this._activeGraphic=t;let{x:n,y:r}=e,i=new O(t,this.graphics.indexOf(t),n,r,e);this.emit(`graphic-pointer-down`,i),this.callbacks.onGraphicPointerDown?.(i)}else this._activeGraphic=null}_pointerUpHandler(e){if(this._activeGraphic){let{x:t,y:n}=e,r=this.graphics.indexOf(this._activeGraphic),i=new k(this._activeGraphic,r,t,n,e);this.emit(`graphic-pointer-up`,i),this.callbacks.onGraphicPointerUp?.(i),this._hoverGraphic=this._activeGraphic}}_pointerMoveHandler(e){if(this._dragEvent)return;let t=this._findTargetGraphic(l(e));if(t){let{x:n,y:r}=e;if(this._hoverGraphic){if(this._hoverGraphic===t)return;let i=this.graphics.indexOf(this._hoverGraphic),a=new D(this.graphics[i],i,n,r,e);this._hoverGraphic=null,this.emit(`graphic-pointer-out`,a),this.callbacks.onGraphicPointerOut?.(a)}let i=this.graphics.indexOf(t),a=new E(t,i,n,r,e);this._hoverGraphic=t,this.emit(`graphic-pointer-over`,a),this.callbacks.onGraphicPointerOver?.(a);return}if(this._hoverGraphic){let{x:t,y:n}=e,r=this.graphics.indexOf(this._hoverGraphic),i=new D(this.graphics[r],r,t,n,e);this._hoverGraphic=null,this.emit(`graphic-pointer-out`,i),this.callbacks.onGraphicPointerOut?.(i)}}_dragHandler(e){if(e.action!==`start`&&!this._dragEvent||!this._activeGraphic?.geometry)return;e.action===`start`&&this._removeIndicators(),e.stopPropagation();let{action:t,x:r,y:i}=e,a=this.graphics.indexOf(this._activeGraphic),o=this._dragEvent?r-this._dragEvent.x:0,s=this._dragEvent?i-this._dragEvent.y:0,c=r-e.origin.x,l=i-e.origin.y,u=t===`start`?this._activeGraphic.geometry:this._initialDragGeometry,d=v(u,c,l,this.view);if(this._activeGraphic.geometry=d,this.enableMoveAllGraphics&&this.graphics.forEach(e=>{e!==this._activeGraphic&&(e.geometry=v(e.geometry,o,s,this.view))}),this._dragEvent=e,t===`start`){this._initialDragGeometry=n(u);let t=new C(this._activeGraphic,this.graphics,a,r,i,o,s,c,l,e);this.emit(`graphic-move-start`,t),this.callbacks.onGraphicMoveStart?.(t),t.defaultPrevented&&this._activeGraphic.set(`geometry`,u)}else if(t===`update`){let t=new w(this._activeGraphic,this.graphics,a,r,i,o,s,c,l,e);this.emit(`graphic-move`,t),this.callbacks.onGraphicMove?.(t),t.defaultPrevented&&(this._activeGraphic.geometry=u)}else{let t=new T(this._activeGraphic,this.graphics,a,r,i,o,s,c,l,e);this._dragEvent=null,this._activeGraphic=null,this._setUpIndicators(),this.emit(`graphic-move-stop`,t),this.callbacks.onGraphicMoveStop?.(t),t.defaultPrevented&&(this.graphics[a].set(`geometry`,this._initialDragGeometry),this._setUpIndicators()),this._initialDragGeometry=null}}_keyDownHandler(e){e.key!==`a`&&e.key!==`d`&&e.key!==`n`||this.state!==`moving`||e.stopPropagation()}_findTargetGraphic(e){let t=this.view.toMap(e),n=this.graphics;this._syncLayerViews();let r=this._layerViews.flatMap(e=>`graphicsViews`in e?Array.from(e.graphicsViews(),e=>e.hitTest(t)).flat():e.graphicsView.hitTest(t)).filter(e=>n.includes(e)).sort((e,t)=>n.indexOf(e)-n.indexOf(t));return r.length?r[0]:null}_syncLayerViews(){this._layerViews=[];let e=new Set;for(let t of this.graphics){let n=g(this.view,t.layer);n&&e.add(n)}this._layerViews=[...e]}_setUpHighlights(){this.highlightsEnabled&&this.graphics.length&&this._highlightHelper.add(this.graphics,this.highlightName)}_setUpIndicators(){if(this._removeIndicators(),this.indicatorsEnabled){for(let e of this.graphics){let t=e.clone();t.symbol=M(e),this._indicators.push(t),this.addHandles(u(()=>e.symbol,()=>this._setUpIndicators()),A)}this.layer.addMany(this._indicators)}}_removeIndicators(){this.removeHandles(A),this._indicators.length&&(this.layer.removeMany(this._indicators),this._indicators.forEach(e=>e.destroy()),this._indicators=[])}};function M(e){if(e.symbol==null)return null;switch(e.symbol.type){case`cim`:return new r({style:`circle`,size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}});case`picture-marker`:{let{xoffset:t,yoffset:n,height:i,width:a}=e.symbol;return new r({xoffset:t,yoffset:n,size:i===a?a:Math.max(i,a),style:`square`,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case`simple-marker`:{let{xoffset:t,yoffset:n,size:i,style:a}=e.symbol;return new r({xoffset:t,yoffset:n,style:a===`circle`?`circle`:`square`,size:i+2,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}case`simple-fill`:return new i({color:[0,0,0,0],outline:{style:`dash`,color:[255,127,0,1],width:1}});case`simple-line`:return new o({color:[255,127,0,1],style:`dash`,width:1});case`text`:{let{xoffset:t,yoffset:n}=e.symbol;return new r({xoffset:t,yoffset:n,size:12,color:[0,0,0,0],outline:{color:[255,127,0,1],width:1}})}default:return null}}s([t()],j.prototype,`_activeGraphic`,void 0),s([t({readOnly:!0})],j.prototype,`type`,void 0),s([t()],j.prototype,`callbacks`,void 0),s([t()],j.prototype,`enableMoveAllGraphics`,void 0),s([t()],j.prototype,`graphics`,void 0),s([t()],j.prototype,`highlightName`,void 0),s([t()],j.prototype,`highlightsEnabled`,void 0),s([t()],j.prototype,`indicatorsEnabled`,void 0),s([t()],j.prototype,`_defaultLayer`,void 0),s([t()],j.prototype,`layer`,void 0),s([t({readOnly:!0})],j.prototype,`state`,null),s([t()],j.prototype,`view`,void 0),j=s([a(`esri.views.draw.support.GraphicMover`)],j);var N=j;export{b as n,N as t};