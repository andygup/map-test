const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lclayout-DPnToWbl.js","assets/_commonjsHelpers-4rFoZa9I.js"])))=>i.map(i=>d[i]);
import{A as e,AT as t,Ag as n,Ai as r,BS as i,BT as a,C as o,Ca as s,D as c,DT as l,Da as u,Dh as d,Di as f,Ea as p,Ed as m,Fg as h,Fi as g,Fn as _,Gf as v,H as y,Ha as b,Hp as x,Hr as S,Ii as C,Jf as w,K_ as ee,LS as te,N as ne,NT as re,O as ie,OT as T,Oa as ae,Od as oe,Ov as se,P as ce,Pn as E,Qf as le,R as ue,RS as de,S as fe,SE as D,Sa as pe,T as me,Ta as he,U as ge,Ui as _e,Wi as ve,Zf as ye,Zp as be,_ as xe,_v as O,_w as Se,aE as k,ax as A,bE as j,ba as Ce,da as we,du as Te,ea as Ee,gD as M,ha as De,j as Oe,k as ke,ki as Ae,kv as je,la as Me,mS as N,mp as Ne,na as Pe,px as Fe,qp as Ie,rd as P,rh as Le,tT as Re,ta as ze,uE as Be,ua as Ve,ud as F,vd as He,vv as Ue,wa as We,wh as Ge,wx as I,xa as Ke,z as qe,zi as Je}from"./index-ByaFsVj4.js";import{t as Ye}from"./OptimizedGeometry-DX91by73.js";import{n as Xe}from"./OptimizedFeatureSet-DAaREXtE.js";import{a as Ze}from"./featureConversionUtils-C045qQF5.js";import{i as Qe,t as $e}from"./Relationship-CJ80l_Hk.js";import{t as L}from"./GraphQueryStreaming-DvkpF8XJ.js";import{n as et,t as tt}from"./QueryEngineCapabilities-COyCnRVj.js";import{r as nt}from"./clientSideDefaults-8lL7sncR.js";import{n as rt}from"./utils-CTZ6h8kz.js";import{F as it,I as at,L as ot,p as R,s as st,v as ct}from"./knowledgeGraphService-DMm7HDLL.js";import{a as z,i as B,n as V,o as H,r as lt,t as U}from"./constants-DP4YtCHp.js";import{t as ut}from"./GraphicsLayer-DwoVChbR.js";import{t as dt}from"./FeatureStore-B4F50Cpk.js";import{t as ft}from"./QueryEngine-D34fwTUK.js";var pt=class{constructor(){this.version=``,this.queryResult=new mt}},mt=class{constructor(){this.featureResult=new ht}},ht=class{constructor(){this.objectIdFieldName=``,this.uniqueIdField=new gt,this.globalIdFieldName=``,this.geohashFieldName=``,this.geometryProperties=new _t,this.geometryType=null,this.spatialReference=new I,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new vt,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},gt=class{constructor(){this.name=``,this.isSystemMaintained=!1}},_t=class{constructor(){this.shapeAreaFieldName=``,this.shapeLengthFieldName=``,this.units=``}},vt=class{constructor(){this.quantizeOriginPosition=`upperLeft`,this.scale=new yt,this.translate=new bt}},yt=class{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}},bt=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},xt=class{constructor(){this.name=``,this.fieldType=`esriFieldTypeString`,this.alias=``,this.sqlType=`sqlTypeVarchar`,this.domain=``,this.defaultValue=``}},St=class{constructor(){this.attributes=[],this.compressedGeometry=new Ct,this.centroid=new Ct,this.aggregateGeometries=[]}},Ct=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}},wt=[`ELEMENTUID`,`TYPENAME`],Tt={upperLeft:0,lowerLeft:1},Et={sqlTypeBigInt:0,sqlTypeBinary:1,sqlTypeBit:2,sqlTypeChar:3,sqlTypeDate:4,sqlTypeDecimal:5,sqlTypeDouble:6,sqlTypeFloat:7,sqlTypeGeometry:8,sqlTypeGUID:9,sqlTypeInteger:10,sqlTypeLongNVarchar:11,sqlTypeLongVarbinary:12,sqlTypeLongVarchar:13,sqlTypeNChar:14,sqlTypeNVarChar:15,sqlTypeOther:16,sqlTypeReal:17,sqlTypeSmallInt:18,sqlTypeSqlXml:19,sqlTypeTime:20,sqlTypeTimestamp:21,sqlTypeTimestamp2:22,sqlTypeTinyInt:23,sqlTypeVarbinary:24,sqlTypeVarchar:25};function Dt(e){let t=new pt;t.version=e.version;let n=e.get_query_result();if(n.results_type.value!==0)throw Error(`Got a non-feature collection type`);let r=n.get_feature_result(),i=t.queryResult.featureResult;i.objectIdFieldName=r.objectid_field_name,i.exceededTransferLimit=r.exceeded_transfer_limit,i.hasM=r.has_m,i.hasZ=r.has_z,i.geometryType=j(it,r.geometry_type.value),i.globalIdFieldName=r.globalid_field_name,i.geohashFieldName=r.geohash_field_name;let a=i.uniqueIdField,o=r.unique_id_field;a.name=o.name,a.isSystemMaintained=o.isSystemMaintained;let s=i.geometryProperties,c=r.geometry_properties;s.shapeAreaFieldName=c.shapeAreaFieldName,s.shapeLengthFieldName=c.shapeLengthFieldName,s.units=c.units;let l=i.spatialReference,u=r.spatial_reference;l.wkid=u.wkid,l.latestWkid=u.latestWkid,l.vcsWkid=u.vcsWkid,l.latestVcsWkid=u.latestVcsWkid,l.wkt=u.wkt,i.transform=jt(r.transform);let d=i.fields,f=i.fieldNameToAttributeIndexMap,p=r.fields,m=p.size();for(let e=0;e<m;e++){let t=p.get(e),n=kt(t);d.push(n),f[n.name]=e,t.delete()}p.delete();let h=i.values,g=r.values_count();for(let e=0;e<g;e++)h.push(r.get_value_at(e));let _=i.features,v=r.features,y=v.size();if(y>0){for(let e of wt)if(f[e]===void 0)throw Error(`Feature collection missing required attribute: ${e}`)}for(let e=0;e<y;e++){let t=new St,n=v.get(e),r=t.attributes,i=n.attributes_count();for(let e=0;e<i;e++)r.push(n.get_attribute_at(e));let a=n.get_compressed_geometry();a&&(t.compressedGeometry=Ot(a),t.centroid=Ot(n.get_centroid()));let o=t.aggregateGeometries,s=n.aggregate_geometries,c=s.size();for(let e=0;e<c;e++){let t=s.get(e),n=Ot(t);o.push(n),t.delete()}s.delete(),_.push(t),n.delete()}v.delete();let b=i.geometryFields,x=r.geometry_fields,S=x.size();for(let e=0;e<S;e++){let t=x.get(e),n=At(t);b.push(n),t.delete()}return x.delete(),t}function Ot(e){let t=new Ct;t.geometryType=j(it,e.geometry_type.value);let n=[],r=[];for(let t=0;t<e.lengths.length;t++)n.push(e.lengths[t]);for(let t=0;t<e.coords.length;t++)r.push(e.coords[t]);return t.lengths=n,t.coords=r,t}function kt(e){let t=new xt;return t.name=e.name,t.alias=e.alias,t.fieldType=j(at,e.field_type.value),t.sqlType=j(Et,e.sql_type.value),t.domain=e.domain,t.defaultValue=e.default_value,t}function At(e){let t=kt(e);return t.geometryType=j(it,e.geometry_type.value),t}function jt(e){let t=new vt;t.quantizeOriginPosition=j(Tt,e.quantizeOriginPosition.value);let n=t.scale,r=e.scale;n.xScale=r.xScale,n.yScale=r.yScale,n.mScale=r.mScale,n.zScale=r.zScale;let i=t.translate,a=e.translate;return i.xTranslate=a.xTranslate,i.yTranslate=a.yTranslate,i.mTranslate=a.mTranslate,i.zTranslate=a.zTranslate,t}async function Mt(e,t){let n=[],r={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&n.push(It(e.entitiesUrl,t).then(e=>{Bt(e,r)})),e.relationshipsUrl&&n.push(It(e.relationshipsUrl,t).then(e=>{Bt(e,r)})),await Promise.all(n),r}async function Nt(e,t,n){t??=!1;let r={generateAllSublayers:t,namedTypeDefinitions:new Map};return await Rt(e,n).then(e=>{Vt(e,r)}),r}async function Pt(e){let t=await ot(),n=new t.MapOfObjectIdentifierSets;Ft(n,t,e);let r=new t.MapOfObjectIdentifierSetsEncoder;try{r.set_map_of_identifier_sets(n),r.encode();let e=r.get_encoding_result();if(e.error.error_code!==0)throw new a(`knowledge-graph:layer-support-utils`,e.error.error_message);let t=structuredClone(e.get_byte_buffer());return r.delete(),t}finally{n.delete()}}function Ft(e,t,n){for(let[r,i]of n.namedTypeDefinitions){if(!i.members||i.useAllData)continue;let n=i.members.keys(),a=!1,o=!0,s=new t.ObjectIdArray,c=new t.StringArray,l=new t.GlobalIdArray,u=new t.IdentifierArray,d=new t.ObjectIdentifierSet;for(let e of n)o&&=(a=!isNaN(Number(e)),!1),a?s.add_objectid(Number(e)):(c.add_string(e),l.add_globalid(e)),u.add_identifier(e);d.set_oid_array(s),d.set_string_array(c),d.set_globalid_array(l),d.set_identifier_array(u),s.delete(),c.delete(),l.delete(),u.delete(),e.put_identifier_set(r,d),d.delete()}return e}async function It(e,t){let n=await de(e,{responseType:`array-buffer`,signal:t?.signal});return Lt(await n.data)}async function Lt(e){let t=new(await(ot())).FeatureCollectionDecoder,n=t.decode(new Uint8Array(e));if(n.error_code!==0)throw new a(`knowledge-graph:layer-support-utils`,n.error_message);let r=t.get_feature_collection(),i=Dt(r);return t.delete(),i}async function Rt(e,t){let n=await de(e,{responseType:`array-buffer`,signal:t?.signal}),r=await n.data;return zt(new Uint8Array(r))}async function zt(e){let t=new(await(ot())).MapOfObjectIdentifierSetsDecoder,n=t.decode(new Uint8Array(e)),r=new Map;if(n.error_code!==0)throw new a(`knowledge-graph:layer-support-utils`,n.error_message);let i=t.get_map_of_identifier_sets(),o=i.keys,s=o.size();for(let e=0;e<s;e++){let t=o.get(e),n=i.query_identifier_set(t),s=[];if(n.id_array_type.value===1){let e=n.get_globalid_array(),t=e.count();for(let n=0;n<t;n++)s.push(e.get_globalid_at(n))}else if(n.id_array_type.value===3){let e=n.get_identifier_array(),t=e.count();for(let n=0;n<t;n++)s.push(e.get_identifier_at(n).toString())}else if(n.id_array_type.value===2){let e=n.get_string_array(),t=e.count();for(let n=0;n<t;n++)s.push(e.get_string_at(n))}else{if(n.id_array_type.value!==0)throw new a(`knowledge-graph:layer-support-utils`,`Tried to encode an unexpected ID Array type.`);{let e=n.get_oid_array(),t=e.count();for(let n=0;n<t;n++)s.push(e.get_objectid_at(n).toString())}}r.set(t,s)}return t.delete(),r}function Bt(e,t){if(!e?.queryResult?.featureResult)return t;let{hasZ:n,hasM:r}=e.queryResult.featureResult,i=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(let a of e.queryResult.featureResult.features){let e=a.attributes[i.TYPENAME],o=k(t.namedTypeDefinitions,e,()=>({useAllData:!1,members:new Map})),s=a.attributes[i.ELEMENTUID];if(a.compressedGeometry?.coords?.length>0){let e=a.compressedGeometry.lengths;a.compressedGeometry.geometryType===`esriGeometryPoint`&&(e=[]),o.members.set(s,{id:s,linkChartLocation:new Ye(e,a.compressedGeometry.coords,n,r)})}else o.members.set(s,{id:s})}return t}function Vt(e,t){for(let[n,r]of e){let e=k(t.namedTypeDefinitions,n,()=>({useAllData:!1,members:new Map}));for(let t of r)e.members.has(t)||e.members.set(t,{id:t})}return t}var Ht={fetchAndConvertSerializedLinkChart:(e,t)=>Mt(e,t)},Ut=(e,t)=>{if(e.type===`column-reference`)return e.column===t.systemOidFieldName?`ID(n)`:`n.${e.column}`;if(e.type===`string`)return`'${e.value}'`;if(e.type===`number`)return`${e.value}`;if(e.type===`binary-expression`&&t.supportedSqlTypes.has(e.left.type)&&t.supportedSqlTypes.has(e.right.type)&&t.supportedSqlOperators.has(e.operator))return`${Ut(e.left,t)} ${e.operator} ${Ut(e.right,t)}`;if(e.type===`binary-expression`&&e.operator===`LIKE`){let n=``;if(e.left.type===`function`&&e.left.args.value[0].type===`column-reference`)n+=`lower(n.${e.left.args.value[0].column})`;else{if(e.left.type!==`column-reference`)return t.unsupportedOperationFound=!0,``;n+=`lower(n.${e.left.column})`}if(n+=` CONTAINS (`,e.right.type!==`string`)return t.unsupportedOperationFound=!0,``;{let t=e.right.value;t.startsWith(`%`)&&(t=t.slice(1)),t.endsWith(`%`)&&(t=t.slice(0,-1)),n+=`'${t.toLowerCase()}')`}return n}return t.unsupportedOperationFound=!0,``},W=class e{constructor(){this._featureLookup=new Map}static getInstance(){return e.instance||=new e,e.instance}static resetInstance(){e.instance&&=null}deleteFromStore(e){e.forEach(e=>{this._featureLookup.delete(e)})}readFromStoreByList(e){let t=[];return e.forEach(e=>{let n=this.readFromStoreById(e);n&&t.push(n)}),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,t,n){let r=[];return e.forEach(e=>{if(!e?.id)return;e.properties||=[];let i=null;n&&e.properties[n]&&(i=Ze(e.properties[n])),`originId`in e&&`destinationId`in e&&(e.properties.ESRI__OriginID=e.originId,e.properties.ESRI__DestID=e.destinationId),e.properties[t]=e.id;let a=e.properties;if(e.id){let t=this._featureLookup.get(e.id);if(t?.attributes){a={...t.attributes,...a};let e=n&&a[n];e!=null&&(a[n]=Ue(e)),i??=t.geometry}}let o=new Xe(i?.clone(),a,null,e.id);this._featureLookup.set(`${e.typeName?`${e.typeName}__${e.id}`:e.id}`,o),r.push(o)}),r}},Wt,G=null;function Gt(){return Wt||(Wt=i(()=>import(`./lclayout-DPnToWbl.js`),__vite__mapDeps([0,1])).then(e=>e.l).then(({default:e})=>e({locateFile:e=>te(`esri/libs/linkchartlayout/${e}`)})).then(e=>{Kt(e)}),Wt)}function Kt(e){G=e}var qt={right:0,left:1,top:2,bottom:3},Jt={none:0,"start-only":1,"start-and-end":2};function Yt(e){let t={timeDirection:`right`,timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:`start-and-end`,showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...e?.toJSON(),eventsTicksVisualization:e?.eventsTicksVisualization??`start-and-end`};return{...t,timeDirection:{value:qt[t.timeDirection]??qt.right},eventsTicksVisualization:{value:Jt[t.eventsTicksVisualization]??Jt[`start-and-end`]}}}function K(e,t,n,r,i,a){let o=n.length,s=i.length,c=Float64Array.BYTES_PER_ELEMENT,l=Uint32Array.BYTES_PER_ELEMENT,u=Uint8Array.BYTES_PER_ELEMENT,d=16+o*(u+2*c)+s*(2*l),f=G._malloc(d);try{let u=f+16-f%16,d=u+o*c,p=d+o*c,m=p+s*l,h=m+s*l,g=()=>[G.HEAPF64.subarray(u>>3,(u>>3)+o),G.HEAPF64.subarray(d>>3,(d>>3)+o),G.HEAPU32.subarray(p>>2,(p>>2)+s),G.HEAPU32.subarray(m>>2,(m>>2)+s),G.HEAPU8.subarray(h,h+o)],[_,v,y,b,x]=g();_.set(n),v.set(r),y.set(i),b.set(a),x.set(t);let S=e(o,h,u,d,s,p,m),C=null,w=null;if(S.value===0){let e=G.getLayoutLinksTypes(),t=G.getLayoutLinksVerticesEndIndices(),n=G.getLayoutLinksVertices(),r=G.countLayoutLinksVertices();!s||e&&t?r&&!n?S.value=1:(C={types:new Uint8Array(G.HEAPU8.subarray(e,e+s)),vertexEndIndex:new Uint32Array(G.HEAPU32.subarray(t>>2,(t>>2)+s)),vertices:new Float64Array(G.HEAPF64.subarray(n>>3,(n>>3)+2*r))},w=G.getAuxiliaryGraphicElements()):S.value=1}let[ee,te,ne,re,ie]=g();return n.set(ee),r.set(te),i.set(ne),a.set(re),t.set(ie),{status:S.value,links:C,graphics:w}}finally{G._free(f),G.cleanupLayout()}}var Xt,Zt,Qt,$t,en,tn,nn;(function(e){function t(){return G.getMinIdealEdgeLength()}function n(e,t,n,r,i,a,o=2,s=1,c=-1){return K((t,n,r,i,a,l,u)=>G.applyForceDirectedLayout(e,t,n,r,i,a,l,u,o,s,c),t,n,r,i,a)}e.getMinIdealEdgeLength=t,e.apply=n})(Xt||={}),function(e){function t(e,t,n,r,i,a,o=2,s=1,c=-1){return K((t,n,r,i,a,l,u)=>G.applyCommunityLayout(e,t,n,r,i,a,l,u,o,s,c),t,n,r,i,a)}e.apply=t}(Zt||={}),function(e){function t(e,t,n,r,i,a){return K((t,n,r,i,a,o,s)=>G.applySimpleLayout(e,t,n,r,i,a,o,s),t,n,r,i,a)}e.apply=t}(Qt||={}),function(e){function t(e,t,n,r,i,a){return K((t,n,r,i,a,o,s)=>G.applyHierarchicalLayout(e,t,n,r,i,a,o,s),t,n,r,i,a)}e.apply=t}($t||={}),function(e){function t(e,t,n,r,i,a){return K((t,n,r,i,a,o,s)=>G.applyRadialTreeLayout(e,t,n,r,i,a,o,s),t,n,r,i,a)}e.apply=t}(en||={}),function(e){function t(e,t,n,r,i,a){return K((t,n,r,i,a,o,s)=>G.applySmartTreeLayout(e,t,n,r,i,a,o,s),t,n,r,i,a)}e.apply=t}(tn||={}),function(e){function t(e,t,n,r,i,a,o,s,c,l,u,d){return K((t,n,r,o,s,f,p)=>{if(i.length!==t||a.length!==t||c.length!==s||l.length!==s)return{value:1};let m=Float64Array.BYTES_PER_ELEMENT,h=G._malloc(16+t*m),g=G._malloc(16+t*m),_=G._malloc(16+s*m),v=G._malloc(16+s*m),y=h+16-h%16,b=g+16-g%16,x=_+16-_%16,S=v+16-v%16;try{return G.HEAPF64.subarray(y>>3,(y>>3)+t).set(i),G.HEAPF64.subarray(b>>3,(b>>3)+t).set(a),G.HEAPF64.subarray(x>>3,(x>>3)+s).set(c),G.HEAPF64.subarray(S>>3,(S>>3)+s).set(l),G.applyChronologicalLayout(e,t,n,r,o,y,b,s,f,p,x,S,u,Yt(d))}finally{G._free(h),G._free(g),G._free(_),G._free(v)}},t,n,r,o,s)}e.apply=t}(nn||={}),re()({none:`none`,startAndEnd:`start-and-end`,startOnly:`start-only`}),re()({absoluteValue:`absolute-value`,multiplier:`multiplier`});var rn=new Map([[`basic-grid`,`basic-grid`],[`geographic-organic-standard`,`geographic-organic-standard`],[`hierarchical-bottom-to-top`,`hierarchical-bottom-to-top`],[`hierarchical-top-to-bottom`,`hierarchical-bottom-to-top`],[`organic-community`,`organic-community`],[`organic-fusiform`,`organic-standard`],[`organic-leaf-circle`,`organic-standard`],[`organic-standard`,`organic-standard`],[`radial-node-centric`,`radial-root-centric`],[`radial-root-centric`,`radial-root-centric`],[`tree-bottom-to-top`,`tree-left-to-right`],[`tree-left-to-right`,`tree-left-to-right`],[`tree-right-to-left`,`tree-left-to-right`],[`tree-top-to-bottom`,`tree-left-to-right`],[`chronological-mono-timeline`,`chronological-mono-timeline`],[`chronological-multi-timeline`,`chronological-multi-timeline`]]);function an(e,t){let n=new Map;if(t.dataModel?.relationshipTypes)for(let e of t.dataModel.relationshipTypes)e.name&&n.set(e.name,[]);for(let t of e)n.has(t.typeName)&&n.get(t.typeName)?.push(t.id);return n}async function on(e,t,n){let r=[],i=an(e,t),a={},o=[];for(let[e,t]of i){if(t.length<1)continue;let n=`${e}_ids`;a[n]=t,o.push(`MATCH (n)-[r:${e}]->(m) WHERE id(r) in $${n} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(o.length===0)return[];let s=o.join(` UNION `),c=new L({openCypherQuery:s,bindParameters:a}),l=(await R(t,c,n?.requestOptions)).resultRowsStream.getReader();for(;;){let{done:e,value:t}=await l.read();if(e)break;for(let e of t)r.push({id:e[0],typeName:e[1]}),r.push({id:e[2],typeName:e[3]})}return r}var sn=e=>rn.get(e)??`radial-root-centric`;function cn(e){if(!e.spatialReference.isWGS84)throw new a(`knowledge-graph:layer-support-utils`,`The utilsExtentToInBoundsRings function only supports WGS84 spatial references.`);return e.clone().normalize().map(e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]])}var q=class extends Se{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;let t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach(n=>{n.name&&(t.set(n.name,`entity`),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(n.name),n.properties?.forEach(e=>{e.geometryType&&e.geometryType!==`esriGeometryNull`&&this.geographicLookup.set(n.name,{name:e.name??``,geometryType:e.geometryType})}))}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(n=>{n.name&&(t.set(n.name,`relationship`),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(n.name),n.properties?.forEach(e=>{e.geometryType&&e.geometryType!==`esriGeometryNull`&&this.geographicLookup.set(n.name,{name:e.name??``,geometryType:e.geometryType})}))}),e.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,r)=>{if(t.get(r)===`entity`)this.entityTypeNames.add(r);else{if(t.get(r)!==`relationship`)return Be.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(r);this.relationshipTypeNames.add(r)}let i=new Map;n.members?.forEach(e=>{k(this.memberIdTypeLookup,e.id,()=>new Set).add(r)}),this.sublayerCaches.set(r,i)})}addToLayer(e){e.forEach(({typeName:e,id:t})=>{if(!this.inclusionModeDefinition)throw new a(`knowledge-graph:layer-data-manager`,`You cannot add to a layer's exclusion list if it was not created with an exclusion list originally`);if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){let n=this.inclusionModeDefinition.namedTypeDefinitions.get(e);n.members||=new Map,n.members.set(t,{id:t}),k(this.memberIdTypeLookup,t,()=>new Set).add(e)}}else{let n=new Map;n.set(t,{id:t}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:n}),k(this.memberIdTypeLookup,t,()=>new Set).add(e)}})}getById(e){return W.getInstance().readFromStoreById(e)}async getData(e,t,n){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let r;if(r=e||new P({where:`1=1`,outFields:[`*`]}),t.parentCompositeLayer.type===`link-chart`){let e=t.parentCompositeLayer,n=this._processingCacheUpdatesLookup.get(t.objectType.name??``),i=r.outFields;i&&i.length===1&&i[0]===`ESRI__ID`&&r.where===`1=1`||await Promise.all(n??[]);let a=this.sublayerCaches.has(t.objectType.name??``)?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],o=[];return a.forEach(n=>{if(this.relationshipTypeNames.has(t.objectType.name)){n.geometry=e.relationshipLinkChartDiagramLookup.get(n.attributes[t.objectIdField]);let r=this.memberIdTypeLookup.get(n.attributes[V]),i=this.memberIdTypeLookup.get(n.attributes[H]),a=this._isEndEntitySpatial(r,n,V),o=this._isEndEntitySpatial(i,n,H);n.attributes[U]=Number(a&&o)}else{n.geometry=e.entityLinkChartDiagramLookup.get(n.attributes[t.objectIdField]);let r=this.geographicLookup.get(t.objectType.name);r&&n.attributes[r.name]?n.attributes[U]=1:n.attributes[U]=0}n.attributes[lt]=n.geometry,o.push(n)}),o}return this.retrieveDataFromService(r,t,n)}async getConnectedRecordIds(e,t,n){let r=[],i=``,a=this._getNamedTypeIdMapFromNodeIds(e);if(t&&t?.length!==0){for(let e of t)i=i+e+`|`;i=i.slice(0,-1)}let o={},s=[];for(let[e,n]of a){let r=`${e}_ids`;o[r]=n,t&&t?.length!==0?s.push(`MATCH (n:${e}) WHERE id(n) IN $${r} WITH n MATCH (n)-[r:${i}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):s.push(`MATCH (n:${e}) WHERE id(n) IN $${r} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!s.length)return r;let c=s.join(` UNION `),l=(await R(this.knowledgeGraph,new L({openCypherQuery:c,bindParameters:o}),{signal:n?.signal})).resultRowsStream.getReader();for(;;){let{done:e,value:t}=await l.read();if(e)break;for(let e=0;e<t.length;e++){let n=t[e];r.push({id:n[0],typeName:n[1]}),r.push({id:n[2],typeName:n[3]})}}return r}async getRelationshipsBetweenNodes(e,t,n){let r=this._getNamedTypeIdMapFromNodeIds(e);if(r.size===0)return[];let i={relationshipExclusionIds:t,possibleConnectionEntityIds:e},a=[];for(let[e,t]of r.entries()){let n=`${e}_ids`;i[n]=t,a.push(`MATCH (n:${e}) WHERE id(n) IN $${n} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}let o=a.join(` UNION `),s=[],c=(await R(this.knowledgeGraph,new L({openCypherQuery:o,bindParameters:i}),{signal:n?.signal})).resultRowsStream.getReader();for(;;){let{done:e,value:t}=await c.read();if(e)break;for(let e=0;e<t.length;e++){let n=t[e];s.push({id:n[0],typeName:n[1]})}}return s}async getRelationshipsFromNodes(e,t,n,r){let i=this._getNamedTypeIdMapFromNodeIds(e);if(i.size===0||t.length===0)return[];let a={relationshipExclusionIds:n,possibleConnectionEntityIds:t},o=[];for(let[e,t]of i.entries()){let n=`${e}_ids`;a[n]=t,o.push(`MATCH (n:${e}) WHERE id(n) IN $${n} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}let s=o.join(` UNION `),c=new Map,l=(await R(this.knowledgeGraph,new L({openCypherQuery:s,bindParameters:a}),{signal:r?.signal})).resultRowsStream.getReader();for(;;){let{done:e,value:t}=await l.read();if(e)break;for(let e=0;e<t.length;e++){let n=t[e],r=c.get(n[1]);r||(r=new Set,c.set(n[1],r)),r.add(n[0])}}let u=[];for(let[e,t]of c)for(let n of t)u.push({id:n,typeName:e});return u}async refreshCacheContent(e,t,n,r=!0,i){let o=W.getInstance(),s=[],c=new Map,l=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(e=>{e.name&&l.set(e.name,e)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(e=>{e.name&&l.set(e.name,e)}),e||this.inclusionModeDefinition?e?e.forEach(e=>{if(this.memberIdTypeLookup.has(e))for(let t of this.memberIdTypeLookup.get(e))c.has(t)?c.get(t)?.push(e):c.set(t,[e])}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{e.useAllData?c.set(t,null):e.members&&e.members.forEach(e=>{c.has(t)&&c.get(t)!==null?c.get(t)?.push(e.id):c.set(t,[e.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(e=>{e.name&&c.set(e.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(e=>{e.name&&c.set(e.name,null)}));for(let[e,u]of c){let c=new Set(u),d=new Promise((s,d)=>{(async()=>{let s=new Set,d=[],f,p=``,m=!1;if(t||l.get(e)?.properties?.forEach(e=>{e.name&&s.add(e.name)}),n&&this.geographicLookup.has(e)){let t=this.geographicLookup.get(e)?.name;t&&s.add(t)}if(this.entityTypeNames.has(e))p=`MATCH (n:${e}) ${u?`WHERE id(n) IN $ids `:``}return ID(n)`,s.forEach(e=>{p+=`, n.${e}`,d.push(e)});else{if(!this.relationshipTypeNames.has(e))throw new a(`knowledge-graph:layer-data-manager`,`The graph type of ${e} could not be determined. Was this type set in the KG data model and inclusion definition?`);m=!0,p=`MATCH ()-[n:${e}]->() ${u?`WHERE id(n) IN $ids `:``}return ID(n), id(startNode(n)), id(endNode(n))`,s.forEach(e=>{p+=`, n.${e}`,d.push(e)})}f=new L(u?{openCypherQuery:p,bindParameters:{ids:u}}:{openCypherQuery:p});let h=(await R(this.knowledgeGraph,f,{signal:i?.signal})).resultRowsStream.getReader();for(;;){let{done:t,value:n}=await h.read();if(t)break;let i=[];for(let e=0;e<n.length;e++){let t=n[e],r=0,a=0,o={properties:{}};for(o.id=t[r],r++,a++,m&&(o.originId=t[r],r++,a++,o.destinationId=t[r],r++,a++,k(this.nodeConnectionsLookup,o.originId,()=>new Set).add(o.id),k(this.nodeConnectionsLookup,o.destinationId,()=>new Set).add(o.id),k(this.relationshipConnectionsLookup,o.id,()=>[o.originId,o.destinationId]));r<t.length;r++)o.properties[d[r-a]]=t[r];c.delete(o.id),i.push(o)}let a=o.writeToStore(i,B,this.geographicLookup.get(e)?.name);this.sublayerCaches.has(e)||this.sublayerCaches.set(e,new Map),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(e)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(e,{useAllData:!1,members:new Map}),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(e).members=new Map);let s=this.sublayerCaches.get(e);a.forEach(t=>{s?.set(t.attributes[B],t),r&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.has(t.attributes.ESRI__ID)&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(e).members.set(t.attributes.ESRI__ID,{id:t.attributes.ESRI__ID}),k(this.memberIdTypeLookup,t.attributes.ESRI__ID,()=>new Set).add(e))})}let g=this.inclusionModeDefinition?.namedTypeDefinitions.get(e);if(g)for(let e of c)g.members?.delete(e)})().then(()=>{s(null)}).catch(e=>{e.name===`AbortError`?s(null):d(e)})});s.push(d),this._processingCacheUpdatesLookup.get(e)?.push(d)}if(await Promise.all(s),i?.signal?.aborted)throw Re()}removeFromLayer(e){let t=new Set,n=new Set(e.map(e=>e.id));for(let n of e)t.add(n.typeName),this.memberIdTypeLookup.get(n.id)?.size===1?this.memberIdTypeLookup.delete(n.id):this.memberIdTypeLookup.get(n.id)?.delete(n.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((e,t)=>{t===n.typeName&&e.members?.has(n.id)&&e.members.delete(n.id)});t.forEach(e=>{this.sublayerCaches.get(e)?.forEach((t,r)=>{n.has(r)&&this.sublayerCaches.get(e)?.delete(r)})})}async retrieveDataFromService(e,t,r){let i=W.getInstance(),o=new Set,s=[],c,l=``,u=[],d=t.graphType===`relationship`,f=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,p=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name),m=!f&&p?Array.from(p).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&e.objectIds!=null&&(m=e.objectIds);else if(e.objectIds!=null&&m&&m.length>0){let t=e.objectIds;e.objectIds=m.filter(e=>t.includes(e))}else if(e.objectIds!=null)m=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=m}if(e.outFields!=null){let n=e.outFields;n.includes(`*`)?t.fields.forEach(e=>{o.add(e.name)}):n.forEach(e=>{e!==`ESRI__ID`&&e!==t.geometryFieldName&&o.add(e)})}if(e.geometry!=null){let r=e.geometry,i,u=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,f=u?.spatialReference,p=u?.serviceCapabilities?.geometryCapabilities,m=p?.geometryMaxBoundingRectangleSizeX,g=p?.geometryMaxBoundingRectangleSizeY;if(r.type===`point`){let e=r;e.spatialReference?.isWGS84||(await n(e.spatialReference,N),e=h(e,N)),i=new A({spatialReference:N,xmin:e.x-1e-4,ymin:e.y-1e-4,xmax:e.x+1e-4,ymax:e.y+1e-4})}else r?.extent?.spatialReference&&!r.spatialReference?.isWGS84?(await n(r.extent.spatialReference,N),i=h(r.extent,N)):i=r.extent;if(m&&g&&f){if(f.wkid!==4326){let e=new A({spatialReference:f,xmax:m,ymax:g}),t=h(e,N);m=t.xmax,g=t.ymax}if(i.xmax-i.xmin>m)throw new a(`knowledge-graph:layer-data-manager`,`Extent x bounds should be within ${m}° latitude, limit exceeded`);if(i.ymax-i.ymin>g)throw new a(`knowledge-graph:layer-data-manager`,`Extent y bounds should be within ${g}° longitude, limit exceeded`)}if(e.where!=null&&e.where!==`1=1`){let n=await Ie(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(e=>{n.fieldNames.includes(e.name)&&o.add(e.name)})}l=d?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&o.add(t.geometryFieldName),o.forEach(e=>{l+=`, n.${e}`,s.push(e)}),c=new L({openCypherQuery:l,bindParameters:{param_filter_geom:new je({rings:cn(i)})}})}else{let n=``;if(e.where!=null&&e.where!==`1=1`){let r=await Ie(e.where,t.fieldsIndex);t.fields.forEach(e=>{r.fieldNames.includes(e.name)&&o.add(e.name)});let i={systemOidFieldName:B,supportedSqlTypes:new Set([`column-reference`,`string`,`number`,`binary-expression`]),supportedSqlOperators:new Set([`=`,`<`,`<=`,`<>`,`>`,`>=`,`AND`,`OR`,`LIKE`]),unsupportedOperationFound:!1};n=Ut(r.parseTree,i),i.unsupportedOperationFound&&(n=``)}let r=``;r=d?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let i=!1;m&&(i=!0,r+=` WHERE ID(n) IN $ids`),n&&(r+=i?` AND`:` WHERE`,r+=` ${n}`),r+=` return ID(n)`,d&&(r+=`, id(startNode(n)), id(endNode(n))`),e.returnGeometry&&t.geometryFieldName&&o.add(t.geometryFieldName),o.forEach(e=>{r+=`, n.${e}`,s.push(e)}),c=new L(m?{openCypherQuery:r,bindParameters:{ids:m}}:{openCypherQuery:r})}let g=(await R(t.parentCompositeLayer.dataManager.knowledgeGraph,c,r)).resultRowsStream.getReader();for(;;){let{done:e,value:n}=await g.read();if(e)break;let r=[];for(let e=0;e<n.length;e++){let t=n[e],i=0,a=0,o={properties:{}};for(o.id=t[i],i++,a++,d&&(o.originId=t[i],i++,a++,o.destinationId=t[i],i++,a++);i<t.length;i++)o.properties[s[i-a]]=t[i];r.push(o)}u=u.concat(i.writeToStore(r,B,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return u}_isEndEntitySpatial(e,t,n){for(let r of e??[])if(this.entityTypeNames.has(r)){let e=this.geographicLookup.get(r),i=e&&this.sublayerCaches.get(r)?.get(t.attributes[n]);if(e&&i?.attributes[e.name])return!0}return!1}_getNamedTypeIdMapFromNodeIds(e){let t=new Map;return e.forEach(e=>{if(this.memberIdTypeLookup.has(e))for(let n of this.memberIdTypeLookup.get(e)){if(!this.entityTypeNames.has(n))return;t.has(n)?t.get(n)?.push(e):t.set(n,[e])}}),t}};M([l()],q.prototype,`knowledgeGraph`,void 0),M([l()],q.prototype,`inclusionModeDefinition`,void 0),M([l()],q.prototype,`entityTypeNames`,void 0),M([l()],q.prototype,`relationshipTypeNames`,void 0),M([l()],q.prototype,`geographicLookup`,void 0),M([l()],q.prototype,`sublayerCaches`,void 0),M([l()],q.prototype,`nodeConnectionsLookup`,void 0),M([l()],q.prototype,`relationshipConnectionsLookup`,void 0),M([l()],q.prototype,`memberIdTypeLookup`,void 0),q=M([T(`esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager`)],q);var ln=Symbol(`isKnowledgeGraphGraphicOriginSymbol`),un,dn=class extends Ce{get[(un=ln,w)](){return this.sublayer}get[ye](){return this.sublayer}get[Ke](){return this.sublayer}constructor(e,t){super(),this[un]=!0,this.type=`knowledge-graph`,this.layer=e,this.sublayer=t}get id(){return this.layer.id}},fn=Symbol(`isLinkChartGraphicOriginSymbol`),pn,mn=class extends Ce{get[(pn=fn,Ke)](){return this.layer}constructor(e,t){super(),this[pn]=!0,this.type=`link-chart`,this.layer=e,this.sublayer=t}get id(){return`${this.layer.id}:__${this.sublayer.id}__`}},hn=o(),gn=e=>{let t=e,n=class extends t{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return M([l(hn.fields)],n.prototype,`fields`,void 0),M([l(hn.fieldsIndex)],n.prototype,`fieldsIndex`,void 0),n=M([T(`esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase`)],n),n},_n=u,J=class extends Se{constructor(e){super(e),this.entityAdds=void 0,this.entityUpdates=void 0,this.entityDeletes=void 0,this.relationshipAdds=void 0,this.relationshipUpdates=void 0,this.relationshipDeletes=void 0,this.options=void 0}};M([l()],J.prototype,`entityAdds`,void 0),M([l()],J.prototype,`entityUpdates`,void 0),M([l()],J.prototype,`entityDeletes`,void 0),M([l()],J.prototype,`relationshipAdds`,void 0),M([l()],J.prototype,`relationshipUpdates`,void 0),M([l()],J.prototype,`relationshipDeletes`,void 0),M([l()],J.prototype,`options`,void 0),J=M([T(`esri.rest.knowledgeGraph.GraphApplyEdits`)],J);var vn={initializeLayersFromClientData:async(e,t,n)=>{if(t||=[...e.layers,...e.tables].map(e=>e.graphTypeName),t?.length===0)return;let r=new Map;for(let n of t)r.set(n,yn(e,n));let i=await ct(e.dataManager.knowledgeGraph,Array.from(r.values()),{requestOptions:{signal:n?.signal}});for(let t of[...e.layers,...e.tables]){let n=t.objectType.name;if(n==null)continue;let r=i.get(yn(e,n));if(r){let e=JSON.parse(r);typeof e!=`object`||!e||e.hasOwnProperty(`showLabels`)||(e.showLabels=!1),t.read(e,{origin:`service`})}}},getInclusionDefinitionFromCypherResults:async(e,t,n)=>{let r=Ln(e.dataModel),i=(await R(e,t,n)).resultRowsStream.getReader();for(;;){let{done:e,value:t}=await i.read();if(e)break;for(let e of t)for(let t of e)Y(t,r)}return r},getInclusionDefinitionFromIdTypePairs:(e,t)=>{let n=Ln(e.dataModel);for(let{id:e,typeName:r}of t){let t=n.namedTypeDefinitions.get(r);if(!t)throw new a(`WebLinkChart:data-model-desync`,`The provided id-type pairs contained a named type not reflected in the provided knowledge graph data model.`);t.members?.set(e,{id:e})}return n}},yn=(e,t)=>e.type===`knowledge-graph`?`${t}/Map`:`${t}/LinkChart/LinkChartSubLayer`;async function bn(e,t,n){return vn.initializeLayersFromClientData(e,t,n)}var xn=`#4a0932.#b31515.#18382e.#a64f1b.#102432.#8c213f.#ed9310.#2c6954.#144d59.#ffc730.#75351e.#454f4b.#78b1c2.#191921.#8f8f82.#9be0c0.#dbb658.#87b051.#11495c.#c43541.#9c5596.#44498b.#ad9d63.#86afb3.#5c98ca.#b0bfa2.#73241f.#b86b53.#d9d78c.#3e756d.#f260a1.#a0d17d.#c27c30.#eb82eb.#ffdf3c.#ffb259.#ab52b3.#3cccb4.#0095ba.#d92b30`.split(`.`),Sn=`#8f8f82`;function Cn(e){return e<0||e>=xn.length?new Le(Sn):new Le(xn[e])}function wn(e){let t=e.toArray();return new v({data:{type:`CIMSymbolReference`,symbol:{type:`CIMLineSymbol`,symbolLayers:[{type:`CIMSolidStroke`,enable:!0,style:`solid`,width:.75,color:t},{type:`CIMVectorMarker`,enable:!0,size:6,markerPlacement:{type:`CIMMarkerPlacementOnLine`,angleToLine:!0,relativeTo:`LineMiddle`},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:`CIMMarkerGraphic`,geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:`CIMPolygonSymbol`,symbolLayers:[{type:`CIMSolidFill`,enable:!0,color:t}]}}]}]}}})}function Tn(e){let t=`ESRI__ID`,n=4;for(let r of e)if(r.name){if(r.name.toLowerCase()===`name`){t=r.name;break}r.name.toLowerCase().includes(`name`)?(t=r.name,n=2):r.fieldType===`esriFieldTypeString`&&n>3&&(t=r.name,n=3)}return t}function En(e,t,n){let r={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:`normal`}},i=new E({labelExpressionInfo:new _({expression:n===`ESRI__ID`?`${t}`:`$feature.${n}`}),labelPlacement:`above-center`,symbol:new m(r)}),a=new E({labelExpressionInfo:new _({expression:`'${t}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:`center-along`,labelPosition:`parallel`,repeatLabel:!1,symbol:new m({...r,yoffset:`12px`})});return e===`entity`?[i]:[a]}function Dn(e,t,n){let r={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:`bold`}},i=n===`ESRI__ID`?`${e}`:`$feature.${n}`;return t===`point`?[new E({labelExpressionInfo:new _({expression:i}),labelPlacement:`above-center`,symbol:new m(r)})]:t===`polyline`?[new E({labelExpressionInfo:new _({expression:i}),labelPlacement:`center-along`,repeatLabel:!0,symbol:new m(r)})]:t===`polygon`?[new E({labelExpressionInfo:new _({expression:i}),labelPlacement:`always-horizontal`,symbol:new m(r)})]:null}var On={capabilities:[],allowGeometryUpdates:!1,serviceCapabilities:{geometryCapabilities:{supportsZValues:!1,supportsMValues:!1}}};function kn(e){let{capabilities:t,allowGeometryUpdates:n,serviceCapabilities:{geometryCapabilities:{supportsZValues:r,supportsMValues:i}}}=e?.serviceDefinition||On,a=e?.dataModel.arcgisManaged?t:t.filter(e=>e===`Query`),o=new Set(a);return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,isBranchVersioned:!1,supportsAttachment:!1,supportsM:i,supportsZ:r},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:o.has(`Create`),supportsDelete:o.has(`Delete`),supportsEditing:o.has(`Editing`),supportsChangeTracking:!1,supportsQuery:o.has(`Query`),supportsQueryBins:!1,supportsQueryPivot:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:o.has(`Update`),supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},query:et,queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},queryAttributeBins:tt,editing:{supportsGeometryUpdate:!!e?.dataModel.arcgisManaged&&n,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:o.has(`Delete`),supportsUpdateByAnonymous:!1,supportsUpdateByOthers:o.has(`Update`),supportsAsyncApplyEdits:!1,zDefault:void 0}}}async function An(e,t){let r=new J,i=t.graphTypeName,a=t.graphType,o=t.parentCompositeLayer.type===`knowledge-graph`?t.geometryFieldName:null,s=!!t.fieldsIndex.get(o)?.editable,c=e=>{let n={...e};for(let e of t.fields)e.editable||delete n[e.name];for(let t of Object.keys(e))t.includes(`ESRI__`)&&delete n[t];return n},l=async e=>{await n(e.spatialReference,I.WGS84);let t=h(e,I.WGS84);return t.type===`point`?t.normalize():(await Te(t))[0]};for(let t of e.addFeatures??[]){let e=c(t.attributes);Ge(t.sourceLayer)&&t.sourceLayer.graphTypeName===i&&(a===`entity`?(r.entityAdds||=[],o&&t.geometry&&(e[o]=await l(t.geometry)),r.entityAdds.push(new Qe({properties:e,typeName:i}))):(r.relationshipAdds||=[],r.relationshipAdds.push(new $e({properties:e,typeName:i}))))}for(let t of e.updateFeatures??[]){let e=t.attributes[B],n=c(t.attributes);Ge(t.sourceLayer)&&t.sourceLayer.graphTypeName===i&&(a===`entity`?(r.entityUpdates||=[],o&&s&&t.geometry&&(n[o]=await l(t.geometry)),r.entityUpdates.push(new Qe({id:e,properties:n,typeName:i}))):(r.relationshipUpdates||=[],r.relationshipUpdates.push(new $e({id:e,properties:n,typeName:i}))))}let u=new Map;for(let t of e.deleteFeatures??[])if(be(t)){let e=t,n=k(u,e.sourceLayer.graphTypeName,()=>({typeName:e.sourceLayer.graphTypeName,ids:[]}));e.sourceLayer.graphTypeName===i&&n.ids.push(e.attributes.ESRI__ID)}else t.objectId&&typeof t.objectId==`string`&&k(u,i,()=>({typeName:i,ids:[]})).ids.push(t.objectId);for(let e of u.values())e.ids.length>0&&(a===`entity`?(r.entityDeletes||=[],r.entityDeletes.push({typeName:e.typeName,ids:e.ids})):(r.relationshipDeletes||=[],r.relationshipDeletes.push({typeName:e.typeName,ids:e.ids})));return r}function jn(e,t){let n={addFeatureResults:[],updateFeatureResults:[],deleteFeatureResults:[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]};for(let r of e.editResults)if(r.typeName===t){for(let e of r.adds)n.addFeatureResults.push({objectId:e.id,globalId:e.id});for(let e of r.updates)n.updateFeatureResults.push({objectId:e.id,globalId:e.id});for(let e of r.deletes)n.deleteFeatureResults.push({objectId:e.id,globalId:e.id})}return n}function Mn(e){if(!e.objectType)return null;let t=[];for(let n of e.fields)!n.name.includes(`ESRI__`)&&n.editable&&n.type!==`geometry`&&t.push(new _n({fieldName:n.name}));return new pe({elements:t})}function Nn(e){if(!e.objectType)return null;let t=null;switch(e.geometryType){case`point`:case`multipoint`:t=`point`;break;case`polyline`:t=`line`;break;case`polygon`:t=`polygon`;break;default:t=null}return[new me({name:e.graphTypeName,drawingTool:t,prototype:{}})]}function Pn(e){return!(!e||typeof e!=`object`||Array.isArray(e))&&`id`in e&&`typeName`in e}function Fn(e){return!(!e||typeof e!=`object`||Array.isArray(e))&&e&&`path`in e&&Array.isArray(e.path)}function In(e){return!(!e||typeof e!=`object`||Array.isArray(e)||`id`in e)&&`properties`in e&&typeof e.properties==`object`}function Ln(e){let t={namedTypeDefinitions:new Map,generateAllSublayers:!1},{entityTypes:n,relationshipTypes:r}=e,i=[...n,...r];for(let e of i)t.namedTypeDefinitions.set(e.name,{useAllData:!1,members:new Map});return t}function Y(e,t){if(e&&typeof e==`object`){if(Pn(e)){let n=t.namedTypeDefinitions.get(e.typeName);if(!n)throw new a(`WebLinkChart:data-model-desync`,`The query result contained a named type not reflected in the provided knowledge graph data model.`);n.members.set(e.id,{id:e.id})}else if(Fn(e))for(let n of e.path)Y(n,t);else if(Array.isArray(e))for(let n of e)Y(n,t);else if(In(e))for(let n of Object.values(e.properties??{}))Y(n,t)}}function X(e){if(!e.json)return e;e.json.write=Rn(e.json.write);let t=e.json.origins;if(!t)return e;let n;for(n in t){let e=t[n];e&&(e.write=Rn(e.write))}return e}function Rn(e){return typeof e==`object`&&e?(!1!==e.enabled&&(e.overridePolicy=zn(e)),e):!0===e?Z():e}function zn(e){let{target:t,writer:n,overridePolicy:r,...i}=e;return function(e,t){let n=Bn.call(this,e,t);return n.enabled?{...i,...n}:n}}function Z(){return{overridePolicy:Bn}}function Bn(e,t){let n=!!this.geometryType,r={enabled:n};return n&&(r={...r,...Q.call(this,e,t)}),r}function Q(e,t){return{ignoreOrigin:this.originIdOf(t)>0}}var $=class extends gn(ze(ue(_e(Ve(ce(ie(e(Oe(b(d)))))))))){constructor(e){super(e),this.blendMode=`normal`,this.charts=null,this.definitionExpression=null,this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=B,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{let e=new MessageChannel;return new ee(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{let n=P.fromJSON(e);return this.queryFeaturesJSON(n,t)}}}),[e.port2]})},this.type=`knowledge-graph-sublayer`,this.useViewTime=!0,this.visible=!0}get capabilities(){return this.parent?this.parent.sublayerCapabilities:kn(null)}get userHasUpdateItemPrivileges(){return!!this.parent?.userHasUpdateItemPrivileges}get editingEnabled(){return this._isOverridden(`editingEnabled`)?this._get(`editingEnabled`):this.capabilities.operations.supportsEditing}set editingEnabled(e){this._overrideIfSome(`editingEnabled`,e)}get isTable(){return this.parentCompositeLayer?.type!==`link-chart`&&this.geometryFieldName==null}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(e){let t=this._normalizeFeatureReduction(e);this._set(`featureReduction`,t)}get fields(){let e=[],t=new Map;for(let e of this.parent?.knowledgeGraph.dataModel.domains??[])t.set(e.name,e);return this.objectType?.properties?.forEach(n=>{let r=n.fieldType===`esriFieldTypeOID`?`esriFieldTypeInteger`:n.fieldType,i=F.fromJSON({name:n.name,type:r,alias:n.alias,defaultValue:n.defaultValue,editable:n.editable,nullable:n.nullable,domain:n.domain&&t.has(n.domain)?t.get(n.domain).toJSON():void 0});e.push(i)}),e.push(F.fromJSON({name:this.objectIdField,type:`esriFieldTypeString`,alias:this.objectIdField,editable:!1}),F.fromJSON({name:z,type:`esriFieldTypeInteger`,alias:z,editable:!1}),F.fromJSON({name:U,type:`esriFieldTypeInteger`,alias:U,editable:!1})),e}get formTemplate(){return this._isOverridden(`formTemplate`)?this._get(`formTemplate`):Mn(this)}set formTemplate(e){this._overrideIfSome(`formTemplate`,e)}get geometryType(){if(this.parentCompositeLayer?.type===`link-chart`)return this.graphType===`relationship`?`polyline`:`point`;let e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.geometryType;return t&&t!==`esriGeometryNull`?O.fromJSON(t):null}get geometryFieldName(){return this.parentCompositeLayer?.type===`link-chart`?lt:this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name)?.name??null}get graphicOrigin(){if(!this.parent)return null;switch(this.parent.type){case`knowledge-graph`:return new dn(this.parent,this);case`link-chart`:return new mn(this.parent,this)}}get graphTypeName(){return this.objectType?.name}set graphTypeName(e){this._set(`graphTypeName`,e)}get hasM(){let e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.name;return(t?this.objectType?.properties?.[t]:null)?.hasM??!1}get hasZ(){let e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.name;return(t?this.objectType?.properties?.[t]:null)?.hasZ??!1}set labelingInfo(e){this._set(`labelingInfo`,e)}get labelingInfo(){if(this._isOverridden(`labelingInfo`))return this._get(`labelingInfo`);if(!this.objectType||!this.parentCompositeLayer||!this.graphTypeName)return null;let e=this.objectType.properties?Tn(this.objectType.properties):`ESRI__ID`;return this.parentCompositeLayer.type===`link-chart`?En(this.graphType,this.graphTypeName,e):Dn(this.graphTypeName,this.geometryType,e)}set renderer(e){x(e,this.fieldsIndex),this._set(`renderer`,e)}get renderer(){if(this._isOverridden(`renderer`))return this._get(`renderer`);let e=this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel,t=[...e?.entityTypes??[],...e?.relationshipTypes??[]].map(e=>e.name).indexOf(this.graphTypeName),n=Cn(t);if(this.parentCompositeLayer?.type===`link-chart`){if(this.graphType===`relationship`)return new S({type:`simple`,symbol:wn(n)});let e=y(nt(O.toJSON(`point`)).renderer);return rt(e.symbol,n),e}let r=y(nt(O.toJSON(this.geometryType)).renderer);return rt(r.symbol,n),r}get spatialReference(){return this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel?.spatialReference??I.WGS84}get templates(){return this._isOverridden(`templates`)?this._get(`templates`):Nn(this)}set templates(e){this._overrideIfSome(`templates`,e)}set timeInfo(e){this._set(`timeInfo`,e)}get title(){return this._isOverridden(`title`)?this._get(`title`):this.graphTypeName}set title(e){this._set(`title`,e)}writeTitle(e,t){t.title=e??`Layer`}createPopupTemplate(e){return xe(this,e)}createQuery(){return new P({where:`1=1`,outFields:[`*`]})}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){return this.fields.find(t=>t.name===e)?.domain||null}async queryFeatures(e,t){await this.load();let{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(e),i=this.graphicOrigin,a=De.fromJSON(await r.executeQuery(n.toJSON(),t?.signal));return a.features.forEach(e=>{e.sourceLayer=this,e.origin=i}),a}async queryFeaturesJSON(e,t){await this.load();let{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(e);return await r.executeQuery(n.toJSON(),t?.signal)}async queryFeatureCount(e,t){await this.load();let{resolvedQuery:n,queryEngine:r}=await this._setupQueryObjects(e);return r.executeQueryForCount(n.toJSON(),t?.signal)}async queryExtent(e={},t){await this.load();let n={...e,returnGeometry:!0},{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(n),a=await i.executeQueryForExtent(r.toJSON(),t?.signal),o;return o=a.extent?.xmin!=null&&a.extent?.xmax!=null&&a.extent?.ymin!=null&&a.extent?.ymax!=null?new A(a.extent):new A,{count:a.count,extent:o}}async queryObjectIds(e,t){await this.load();let n=P.from(e),r;if(this.parentCompositeLayer.type===`link-chart`&&this._cachedQueryEngine)r=this._cachedQueryEngine;else{let e=await this.parentCompositeLayer.dataManager.getData(n,this,t);r=this.loadQueryEngine(e)}return await r.executeQueryForIds(n.toJSON(),t?.signal)}async applyEdits(e){if(!this.parentCompositeLayer.dataManager.knowledgeGraph)throw new a(`knowledge-graph-sublayer:no-knowledge-graph`,`ApplyEdits cannot be executed because the parent does not have a Knowledge Graph model.  This is usually caused by the layer not yet being loaded`);let t=await An(e,this);t.options={cascadeDelete:!0,cascadeProvenanceDelete:!!this.parent?.knowledgeGraph.serviceDefinition.supportsProvenance||void 0};let n=await st(this.parentCompositeLayer.dataManager.knowledgeGraph,t),r=jn(n,this.graphTypeName),i={addedFeatures:r.addFeatureResults,updatedFeatures:r.updateFeatureResults,deletedFeatures:r.deleteFeatureResults,addedAttachments:r.addAttachmentResults,deletedAttachments:r.deleteAttachmentResults,updatedAttachments:r.updateAttachmentResults,exceededTransferLimit:!1,historicMoment:new Date,edits:void 0};return this.emit(`edits`,i),this.emit(`apply-edits`,{result:Promise.resolve(i)}),this.parentCompositeLayer.type===`link-chart`&&await this.parentCompositeLayer.refreshLinkChartCache([...i.addedFeatures.map(e=>e.globalId),...i.updatedFeatures.map(e=>e.globalId),...i.deletedFeatures.map(e=>e.globalId)]),r}loadQueryEngine(e){let t=new dt({geometryType:O.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),n=new ft({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:O.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,featureIdInfo:{type:`object-id`,fieldName:this.objectIdField},spatialReference:this.spatialReference.toJSON(),timeInfo:this.timeInfo?.toJSON(),featureStore:t});return n.featureStore.addMany(e),n}async refreshCachedQueryEngine(){let e=await this.parentCompositeLayer.dataManager.getData(new P({where:`1=1`,outFields:[B]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}load(e){return this.addResolvingPromise(this.parent.load(e).then(()=>Ne(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(e,t){let r=P.from(e),i=r.geometry;if(i&&!i.spatialReference?.isWGS84&&(await n(i.spatialReference,N),r.geometry=h(i instanceof je||i instanceof se||i instanceof Fe?i:i.extent,N)),this.parentCompositeLayer.type===`link-chart`&&this._cachedQueryEngine)return{resolvedQuery:r,queryEngine:this._cachedQueryEngine};let a=await this.parentCompositeLayer.dataManager.getData(r,this,t);return{resolvedQuery:r,queryEngine:this.loadQueryEngine(a)}}};function Vn(e,t,n){let r=[[`ESRI__AGGREGATION_COUNT`,z],[`ESRI__ORIGIN_ID`,V],[`ESRI__DESTINATION_ID`,H],[`ESRI__LAYOUT_GEOMETRY`,lt]];try{for(let t of e)for(let[e,n]of r)t.labelExpression=t.labelExpression?.replaceAll(e,n),t.labelExpressionInfo?.expression&&(t.labelExpressionInfo.expression=t.labelExpressionInfo.expression.replaceAll(e,n))}catch(e){Be.getLogger(this).warn(`Error updating labelingInfo`,e)}return fe(e,t,n)}M([l(X(D(we)))],$.prototype,`blendMode`,void 0),M([l({readOnly:!0})],$.prototype,`capabilities`,null),M([l({readOnly:!0})],$.prototype,`userHasUpdateItemPrivileges`,null),M([l({type:Boolean})],$.prototype,`editingEnabled`,null),M([l()],$.prototype,`isTable`,null),M([l({json:{origins:{"web-scene":{write:!1}},write:Z()}})],$.prototype,`charts`,void 0),M([l({readOnly:!0})],$.prototype,`defaultPopupTemplate`,null),M([l({type:String,json:{origins:{service:{read:!1}},name:`layerDefinition.definitionExpression`,write:{ignoreOrigin:!0}}})],$.prototype,`definitionExpression`,void 0),M([l(X(D(Ee)))],$.prototype,`displayFilterEnabled`,void 0),M([l(X(D(Pe)))],$.prototype,`displayFilterInfo`,void 0),M([l(X(D(Me)))],$.prototype,`effect`,void 0),M([l({type:Je})],$.prototype,`elevationInfo`,void 0),M([l(X(D(ve)))],$.prototype,`featureEffect`,void 0),M([l(X(D(qe)))],$.prototype,`featureReduction`,null),M([l()],$.prototype,`fields`,null),M([l({type:pe})],$.prototype,`formTemplate`,null),M([l()],$.prototype,`geometryType`,null),M([l()],$.prototype,`geometryFieldName`,null),M([l({readOnly:!0})],$.prototype,`graphicOrigin`,null),M([l({type:[`entity`,`relationship`],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],$.prototype,`graphType`,void 0),M([l({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],$.prototype,`graphTypeName`,null),M([l()],$.prototype,`hasM`,null),M([l()],$.prototype,`hasZ`,null),M([l({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],$.prototype,`id`,void 0),M([l({type:Boolean,value:!0,nonNullable:!0,json:{name:`showLabels`,default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],$.prototype,`labelsVisible`,void 0),M([l({type:[E],json:{name:`layerDefinition.drawingInfo.labelingInfo`,read:Vn,write:Z()}})],$.prototype,`labelingInfo`,null),M([l({readOnly:!0,json:{read:!1,write:{writer(e,t){switch(this.parentCompositeLayer?.type){case`link-chart`:t.layerType=`LinkChartSubLayer`;break;case`knowledge-graph`:t.layerType=this.geometryType?`KnowledgeGraphSubLayer`:`KnowledgeGraphSubTable`}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],$.prototype,`layerType`,void 0),M([l(X(D(f)))],$.prototype,`legendEnabled`,void 0),M([l(X(D(g)))],$.prototype,`maxScale`,void 0),M([l(X(D(Ae)))],$.prototype,`minScale`,void 0),M([l()],$.prototype,`objectIdField`,void 0),M([l()],$.prototype,`objectType`,void 0),M([l(X(D(C)))],$.prototype,`opacity`,void 0),M([l(X(D(ne)))],$.prototype,`orderBy`,void 0),M([l({clonable:!1})],$.prototype,`parent`,void 0),M([l()],$.prototype,`parentCompositeLayer`,void 0),M([l(X(D(r)))],$.prototype,`popupEnabled`,void 0),M([l({type:le,json:{name:`popupInfo`,write:{ignoreOrigin:!0}}})],$.prototype,`popupTemplate`,void 0),M([l({type:Number,json:{write:{overridePolicy:Q}}})],$.prototype,`refreshInterval`,void 0),M([l({types:ge,json:{name:`layerDefinition.drawingInfo.renderer`,write:Z()}})],$.prototype,`renderer`,null),M([l()],$.prototype,`source`,void 0),M([l()],$.prototype,`spatialReference`,null),M([l({type:me})],$.prototype,`templates`,null),M([l({type:ke,json:{name:`layerDefinition.timeInfo`,write:{overridePolicy:Q},origins:{"web-document":{name:`layerDefinition.timeInfo`,read:!0,write:{overridePolicy:Q}},"portal-item":{name:`layerDefinition.timeInfo`,read:!0,write:{overridePolicy:Q}}}}})],$.prototype,`timeInfo`,null),M([l({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],$.prototype,`title`,null),M([t(`title`)],$.prototype,`writeTitle`,null),M([l({json:{read:!1}})],$.prototype,`type`,void 0),M([l(X(D(c)))],$.prototype,`useViewTime`,void 0),M([l({type:Boolean,json:{name:`visibility`,write:Z()}})],$.prototype,`visible`,void 0),$=M([T(`esri.layers.knowledgeGraph.KnowledgeGraphSublayer`)],$);export{Nt as _,sn as a,en as c,tn as d,Zt as f,Ht as g,W as h,q as i,$t as l,Gt as m,bn as n,on as o,Xt as p,kn as r,Qt as s,$ as t,nn as u,Pt as v};