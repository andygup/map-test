import{$T as e,CE as t,PE as n,_s as r,kD as i,kT as a,ys as o}from"./index-BN8X5Ryz.js";import{n as s,r as c}from"./ProgramTemplate-B9k_04Md.js";import{t as l}from"./ShaderBuilder-BLOqjpgt.js";var u=class{constructor(){this.drawPhase=217}startup(){}shutdown(e){}};function d(e){return e.split(` `).map((e,t)=>t>0?e.charAt(0).toUpperCase()+e.slice(1):e).join(``)}function f(e,t){let n=[];for(n.push(t);n.length;){let t=n.pop();if(typeof t==`object`&&!e.has(t.uid)){e.add(t.uid);for(let e of t.children)n.push(e)}}}var p=class e{constructor(){this.uid=e.NodeCount++,this._debugName=null,this._isMutable=!1,this.isImplicit=!1}static{this.NodeCount=0}get isMutable(){return this._isMutable}setMutable(){return this._isMutable=!0,this}setDebugName(t){return t=d(t),this._debugName=t,this.isImplicit&&this.children[0]instanceof e&&this.children[0].setDebugName(t),this}get debugInfo(){return{name:this._debugName??``}}cloneInto(e){e._debugName=this._debugName,e._isMutable=this._isMutable,e.isImplicit=this.isImplicit,e.uid=this.uid}};function m(e){return typeof e==`object`?e.clone():e}var h=class extends p{constructor(){super(...arguments),this.shaderType=`primitive-node`}},g=class e extends p{constructor(e){super(),this.child=e,this.shaderType=`scope-node`}get children(){return[this.child]}clone(){let t=new e(m(this.child));return this.cloneInto(t),t}},_=class e extends p{constructor(e,t,n){super(),this.property=e,this.target=t,this.returnType=n,this.shaderType=`property-access-node`}get children(){let e=[this.target];return typeof this.property!=`string`&&e.push(this.property),e}clone(){let t=new e(this.property,m(this.target),this.returnType);return this.cloneInto(t),t}},ee=class e extends p{constructor(e,t,n,r){super(),this.x=e,this.y=t,this.target=n,this.returnType=r,this.shaderType=`property-access-2d-node`}get children(){return[this.target,this.x,this.y]}clone(){let t=new e(this.x,this.y,m(this.target),this.returnType);return this.cloneInto(t),t}},te=class e extends p{constructor(e,t,n){super(),this.condition=e,this.ifTrue=t,this.ifFalse=n,this.shaderType=`condition-node`}get children(){return[this.condition,this.ifTrue,this.ifFalse]}clone(){let t=m(this.ifTrue),n=this.ifFalse?m(this.ifFalse):null,r=new e(this.condition,t,n);return this.cloneInto(r),r}},ne=class e extends p{constructor(e,t,n,r){super(),this.captureList=e,this.returnType=t,this.generator=r,this.shaderType=`block-node`,n&&(this.subgraph=new g(n))}get children(){return Object.keys(this.captureList).map(e=>this.captureList[e]).concat(this.subgraph??[])}clone(){let t={};for(let e in this.captureList)t[e]=m(this.captureList[e]);let n=new e(t,this.returnType,this.subgraph?m(this.subgraph.child):this.subgraph,this.generator);return this.cloneInto(n),n}},v=class e extends p{constructor(e,t,n,r,i,a=!1){super(),this.token=e,this._children=t,this.isInfix=n,this.isPropertyAccess=r,this.returnType=i,this.isTernary=a,this.shaderType=`function-node`}get children(){return this._children}clone(){let t=new e(this.token,this._children.map(m),this.isInfix,this.isPropertyAccess,this.returnType,this.isTernary);return this.cloneInto(t),t}},y,b,re,ie,x,ae,oe,se,ce,le,ue,de,fe,pe;function me(e){switch(e.type){case`bool`:case`bvec2`:case`bvec3`:case`bvec4`:return A;case`float`:case`vec2`:case`vec3`:case`vec4`:return T;case`int`:case`ivec2`:case`ivec3`:case`ivec4`:return M;case`uint`:case`uvec2`:case`uvec3`:case`uvec4`:return k;default:throw Error(`Unable to handle type`)}}function he(e){for(let t of[[`float`,`vec2`,`vec3`,`vec4`],[`int`,`ivec2`,`ivec3`,`ivec4`],[`uint`,`uvec2`,`uvec3`,`uvec4`],[`bool`,`bvec2`,`bvec3`,`bvec4`]])if(t.includes(e))return t.map(e=>Me[e]);throw Error(`Unable to find type family`)}function ge(e){return new Proxy(e,{get(t,n){if(n===`constructor`)return new Proxy(t.constructor,{construct:(e,t,n)=>ge(new e(...t))});if(n in t)return t[n];if(typeof n==`string`){let t=he(e.type);return P(e,n,t[n.length-1])}}})}function S(e){return new Proxy(e,{construct:(e,t,n)=>ge(new e(...t))})}function _e(e){return new Proxy(e,{get(t,n){if(n in t)return t[n];if(typeof n==`string`){let t=parseInt(n,10);if(!isNaN(t))return P(e,`[${t}]`,e.elementType.constructor)}}})}function ve(e){return new Proxy(e,{construct:(e,t,n)=>_e(new e(...t))})}var C=class extends Error{},w=class extends h{static{y=this}static{this.type=`array`}constructor(e,t){super(),this.elementType=e,this.size=t,this.children=[],this.type=`array`}clone(){let e=new y(this.elementType,this.size);return super.cloneInto(e),e}get(e,t){let n=new M(e),r=t==null?null:new M(t);return r==null?P(this,n,this.elementType.constructor):F(this,n,r,me(this.elementType.constructor))}last(){return this.get(this.size-1)}first(){return this.get(0)}findIndex(e,t,n){return Be(this,e,t,n)}glslFindIndex(e,t,n){return Ve(this,e,t,n)}static ofType(e,t){return new Proxy(y,{construct:(n,r)=>new y(new e,t)})}};w=y=i([ve],w);var ye=class e extends h{static{this.type=`array-2d`}constructor(e,t,n,r=!1){super(),this.elementType=e,this.xSize=t,this.ySize=n,this.isRowMajor=r,this.children=[],this.type=`array-2d`}clone(){let t=new e(this.elementType,this.xSize,this.ySize,this.isRowMajor);return super.cloneInto(t),t}get size(){return this.xSize*this.ySize}get(e,t){return this.isRowMajor?this._getRowMajor(e,t):this._getColumnMajor(e,t)}_getColumnMajor(e,t){let n=new M(e);return P(this,new M(t).add(n.multiply(this.xSize)),this.elementType.constructor)}_getRowMajor(e,t){let n=new M(e),r=new M(t);return P(this,n.add(r.multiply(this.ySize)),this.elementType.constructor)}static ofType(t,n,r,i=!1){return new Proxy(w,{construct:(a,o)=>new e(new t,n,r,i)})}},be=class e extends h{constructor(){super(...arguments),this.type=`sampler2D`,this.children=[]}static{this.type=`sampler2D`}clone(){let t=new e;return t.children=this.children.map(m),super.cloneInto(t),t}},T=class e extends h{static{this.type=`float`}constructor(e){super(),this.type=`float`,this.children=[e]}clone(){let t=new e(m(this.children[0]));return super.cloneInto(t),t}multiply(t){return V(this,typeof t==`number`?j(t,e):t)}divide(t){return H(this,typeof t==`number`?j(t,e):t)}add(t){return U(this,typeof t==`number`?j(t,e):t)}subtract(t){return W(this,typeof t==`number`?j(t,e):t)}},E=class extends h{static{b=this}static{this.type=`vec2`}constructor(e,t){super(),this.type=`vec2`,this.children=[e,t].filter(e=>e!=null)}clone(){let e=new b(m(this.children[0]),m(this.children[1]));return super.cloneInto(e),e}get 0(){return P(this,`[0]`,T)}get 1(){return P(this,`[1]`,T)}get 2(){throw new C}get 3(){throw new C}multiply(e){return V(this,typeof e==`number`?j(e,T):e)}divide(e){return H(this,typeof e==`number`?j(e,T):e)}add(e){return U(this,typeof e==`number`?j(e,T):e)}subtract(e){return W(this,typeof e==`number`?j(e,T):e)}};E=b=i([S],E);var D=class extends h{static{re=this}static{this.type=`vec3`}constructor(e,t,n){super(),this.type=`vec3`,this.children=[e,t,n].filter(e=>e!=null)}get 0(){return P(this,`[0]`,T)}get 1(){return P(this,`[1]`,T)}get 2(){return P(this,`[2]`,T)}get 3(){throw new C}clone(){let e=new re(m(this.children[0]),m(this.children[1]),m(this.children[2]));return super.cloneInto(e),e}multiply(e){return V(this,typeof e==`number`?j(e,T):e)}divide(e){return H(this,typeof e==`number`?j(e,T):e)}add(e){return U(this,typeof e==`number`?j(e,T):e)}subtract(e){return W(this,typeof e==`number`?j(e,T):e)}};D=re=i([S],D);var O=class extends h{static{ie=this}static{this.type=`vec4`}constructor(e,t,n,r){super(),this.type=`vec4`,this.children=[e,t,n,r].filter(e=>e!=null)}clone(){let e=new ie(m(this.children[0]),m(this.children[1]),m(this.children[2]),m(this.children[3]));return super.cloneInto(e),e}get 0(){return P(this,`[0]`,T)}get 1(){return P(this,`[1]`,T)}get 2(){return P(this,`[2]`,T)}get 3(){return P(this,`[3]`,T)}multiply(e){return V(this,typeof e==`number`?j(e,T):e)}divide(e){return H(this,typeof e==`number`?j(e,T):e)}add(e){return U(this,typeof e==`number`?j(e,T):e)}subtract(e){return W(this,typeof e==`number`?j(e,T):e)}};O=ie=i([S],O);var k=class extends h{static{x=this}static{this.type=`uint`}constructor(e){super(),this.type=`uint`,this.children=[e]}clone(){let e=new x(m(this.children[0]));return super.cloneInto(e),e}multiply(e){return V(this,j(e,x))}add(e){return U(this,j(e,x))}subtract(e){return W(this,j(e,x))}divide(e){return H(this,j(e,x))}};k=x=i([S],k);var xe=class extends h{static{ae=this}static{this.type=`uvec2`}constructor(e,t){super(),this.type=`uvec2`,this.children=[e,t].filter(e=>e!=null)}clone(){let e=new ae(m(this.children[0]),m(this.children[1]));return super.cloneInto(e),e}get 0(){return P(this,`[0]`,M)}get 1(){return P(this,`[1]`,M)}get 2(){throw new C}get 3(){throw new C}multiply(e){return V(this,typeof e==`number`?j(e,k):e)}divide(e){return H(this,typeof e==`number`?j(e,k):e)}add(e){return U(this,typeof e==`number`?j(e,k):e)}subtract(e){return W(this,typeof e==`number`?j(e,k):e)}};xe=ae=i([S],xe);var Se=class extends h{static{oe=this}static{this.type=`uvec3`}constructor(e,t,n){super(),this.type=`uvec3`,this.children=[e,t,n].filter(e=>e!=null)}clone(){let e=new oe(m(this.children[0]),m(this.children[1]),m(this.children[2]));return super.cloneInto(e),e}get 0(){return P(this,`[0]`,k)}get 1(){return P(this,`[1]`,k)}get 2(){return P(this,`[2]`,k)}get 3(){throw new C}multiply(e){return V(this,typeof e==`number`?j(e,k):e)}divide(e){return H(this,typeof e==`number`?j(e,k):e)}add(e){return U(this,typeof e==`number`?j(e,k):e)}subtract(e){return W(this,typeof e==`number`?j(e,k):e)}};Se=oe=i([S],Se);var Ce=class extends h{static{se=this}static{this.type=`uvec4`}constructor(e,t,n,r){super(),this.type=`uvec4`,this.children=[e,t,n,r].filter(e=>e!=null)}clone(){let e=new se(m(this.children[0]),m(this.children[1]),m(this.children[2]),m(this.children[3]));return super.cloneInto(e),e}get 0(){return P(this,`[0]`,k)}get 1(){return P(this,`[1]`,k)}get 2(){return P(this,`[2]`,k)}get 3(){return P(this,`[3]`,k)}multiply(e){return V(this,typeof e==`number`?j(e,k):e)}divide(e){return H(this,typeof e==`number`?j(e,k):e)}add(e){return U(this,typeof e==`number`?j(e,k):e)}subtract(e){return W(this,typeof e==`number`?j(e,k):e)}};Ce=se=i([S],Ce);var A=class e extends h{static{this.type=`bool`}constructor(e){super(),this.type=`bool`,this.children=[e]}and(e){return st(this,e)}or(e){return rt(this,e)}xor(e){return at(this,e)}clone(){let t=new e(m(this.children[0]));return super.cloneInto(t),t}},we=class extends h{static{ce=this}static{this.type=`bvec2`}constructor(e,t){super(),this.type=`bvec2`,this.children=[e,t].filter(e=>e!=null)}all(){return ft(this)}any(){return pt(this)}clone(){let e=new ce(m(this.children[0]),m(this.children[1]));return super.cloneInto(e),e}};we=ce=i([S],we);var Te=class extends h{static{le=this}static{this.type=`bvec3`}constructor(e,t,n){super(),this.type=`bvec3`,this.children=[e,t,n].filter(e=>e!=null)}all(){return ft(this)}any(){return pt(this)}clone(){let e=new le(m(this.children[0]),m(this.children[1]),m(this.children[2]));return super.cloneInto(e),e}};function j(e,t){return typeof e==`number`?new t(e):e}Te=le=i([S],Te);var Ee=class extends h{static{ue=this}static{this.type=`bvec4`}constructor(e,t,n,r){super(),this.type=`bvec4`,this.children=[e,t,n,r].filter(e=>e!=null)}all(){return ft(this)}any(){return pt(this)}clone(){let e=new ue(m(this.children[0]),m(this.children[1]),m(this.children[2]),m(this.children[3]));return super.cloneInto(e),e}};Ee=ue=i([S],Ee);var M=class e extends h{static{this.type=`int`}constructor(e){super(),this.type=`int`,this.children=[e]}multiply(t){return V(this,j(t,e))}add(t){return U(this,j(t,e))}subtract(t){return W(this,j(t,e))}divide(t){return H(this,j(t,e))}clone(){let t=new e(m(this.children[0]));return super.cloneInto(t),t}},N=class extends h{static{de=this}static{this.type=`ivec2`}constructor(e,t){super(),this.type=`ivec2`,this.children=[e,t].filter(e=>e!=null)}clone(){let e=new de(m(this.children[0]),m(this.children[1]));return super.cloneInto(e),e}get 0(){return P(this,`[0]`,M)}get 1(){return P(this,`[1]`,M)}get 2(){throw new C}get 3(){throw new C}multiply(e){return V(this,typeof e==`number`?j(e,M):e)}divide(e){return H(this,typeof e==`number`?j(e,M):e)}add(e){return U(this,typeof e==`number`?j(e,M):e)}subtract(e){return W(this,typeof e==`number`?j(e,M):e)}};N=de=i([S],N);var De=class extends h{static{fe=this}static{this.type=`ivec3`}constructor(e,t,n){super(),this.type=`ivec3`,this.children=[e,t,n].filter(e=>e!=null)}clone(){let e=new fe(m(this.children[0]),m(this.children[1]),m(this.children[2]));return super.cloneInto(e),e}get 0(){return P(this,`[0]`,M)}get 1(){return P(this,`[1]`,M)}get 2(){return P(this,`[2]`,M)}get 3(){throw new C}multiply(e){return V(this,typeof e==`number`?j(e,M):e)}divide(e){return H(this,typeof e==`number`?j(e,M):e)}add(e){return U(this,typeof e==`number`?j(e,M):e)}subtract(e){return W(this,typeof e==`number`?j(e,M):e)}};De=fe=i([S],De);var Oe=class extends h{static{pe=this}static{this.type=`ivec4`}constructor(e,t,n,r){super(),this.type=`ivec4`,this.children=[e,t,n,r].filter(e=>e!=null)}clone(){let e=new pe(m(this.children[0]),m(this.children[1]),m(this.children[2]),m(this.children[3]));return super.cloneInto(e),e}get 0(){return P(this,`[0]`,M)}get 1(){return P(this,`[1]`,M)}get 2(){return P(this,`[2]`,M)}get 3(){return P(this,`[3]`,M)}multiply(e){return V(this,typeof e==`number`?j(e,M):e)}divide(e){return H(this,typeof e==`number`?j(e,M):e)}add(e){return U(this,typeof e==`number`?j(e,M):e)}subtract(e){return W(this,typeof e==`number`?j(e,M):e)}};Oe=pe=i([S],Oe);var ke=class e extends h{static{this.type=`mat2`}constructor(e,t,n,r){super(),this.type=`mat2`,this.children=[e,t,n,r]}clone(){let t=new e(m(this.children[0]),m(this.children[1]),m(this.children[2]),m(this.children[3]));return super.cloneInto(t),t}get(e,t){return F(this,new M(e),new M(t),T)}multiply(e){return V(this,e)}},Ae=class e extends h{static{this.type=`mat3`}static identity(){return new e(1,0,0,0,1,0,0,0,1)}static fromRotation(t){let n=zt(t),r=bt(t);return new e(r,n,0,ze(n),r,0,0,0,1)}constructor(e,t,n,r,i,a,o,s,c){super(),this.type=`mat3`,this.children=[e,t,n,r,i,a,o,s,c]}add(e){return U(this,e)}multiply(e){return V(this,e)}get(e,t){return F(this,new M(e),new M(t),T)}clone(){let t=new e(m(this.children[0]),m(this.children[1]),m(this.children[2]),m(this.children[3]),m(this.children[4]),m(this.children[5]),m(this.children[6]),m(this.children[7]),m(this.children[8]));return super.cloneInto(t),t}},je=class e extends h{static{this.type=`mat4`}static identity(){return new e(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}constructor(e,t,n,r,i,a,o,s,c,l,u,d,f,p,m,h){super(),this.type=`mat4`,this.children=[e,t,n,r,i,a,o,s,c,l,u,d,f,p,m,h]}static fromColumns(t,n,r,i){return new e(t.x,t.y,t.z,t.w,n.x,n.y,n.z,n.w,r.x,r.y,r.z,r.w,i.x,i.y,i.z,i.w)}multiply(e){return V(this,e)}get(e,t){return F(this,new M(e),new M(t),T)}clone(){let t=new e(m(this.children[0]),m(this.children[1]),m(this.children[2]),m(this.children[3]),m(this.children[4]),m(this.children[5]),m(this.children[6]),m(this.children[7]),m(this.children[8]),m(this.children[9]),m(this.children[10]),m(this.children[11]),m(this.children[12]),m(this.children[13]),m(this.children[14]),m(this.children[15]));return super.cloneInto(t),t}},Me={float:T,vec2:E,vec3:D,vec4:O,int:M,ivec2:N,ivec3:De,ivec4:Oe,uint:k,uvec2:xe,uvec3:Se,uvec4:Ce,bool:A,bvec2:we,bvec3:Te,bvec4:Ee},Ne=(...e)=>new M(...e),Pe=(...e)=>new T(...e),Fe=(...e)=>new E(...e),Ie=(...e)=>new D(...e),Le=(...e)=>new O(...e),Re=(...e)=>new Ae(...e);function P(e,t,n){let r=new n(new _(t,e,n));return r.isImplicit=!0,r}function F(e,t,n,r){let i=new r(new ee(t,n,e,r));return i.isImplicit=!0,i}function I(e,t,n,r=null){if(r){let i=new r,a=new r(new v(e,[t,n],!0,!1,i));return a.isImplicit=!0,a}if(t.type===`float`||t.type===`int`){let r=new n.constructor(new v(e,[t,n],!0,!1,n.constructor));return r.isImplicit=!0,r}if((t.type===`mat2`||t.type===`mat3`||t.type===`mat4`)&&n.type!==`float`){let r=new n.constructor(new v(e,[t,n],!0,!1,n.constructor));return r.isImplicit=!0,r}let i=new t.constructor(new v(e,[t,n],!0,!1,t.constructor));return i.isImplicit=!0,i}function L(e,t,n=t.constructor){let r=new n(new v(e,[t],!1,!1,n));return r.isImplicit=!0,r}function R(e,t,n,r=t.constructor){let i=new r(new v(e,[t,n],!1,!1,r));return i.isImplicit=!0,i}function z(e,t,n,r,i=t.constructor){let a=new i(new v(e,[t,n,r],!1,!1,i));return a.isImplicit=!0,a}function ze(e){return V(e,Pe(-1))}function B(e,t,n,r){return new t(new ne(e,t,n,r))}function Be(e,t,n=0,r=e.size){let i=new M(n).setMutable().setDebugName(`FindIndexIterator`),a=t(e.get(i)).setDebugName(`FindIndexPredicate`);return B({iter:i},M,a,({out:e,iter:t,subgraph:n})=>`\n${e} = -1;\n\nfor (; ${t} < ${r}; ${t}++) {\n\n${n.body}\n\n  if (${n.varName}) {\n    ${e} = ${t};\n    break;\n  }\n\n}\n`).setDebugName(`FindIndexBlock`)}function Ve(e,t,n=0,r=e.size){return B({array:e},M,null,({out:e,array:i})=>`\n${e} = -1;\nfor (int i = ${n}; i < ${r}; i++) {\n  bool condition;\n  ${t({array:i,i:`i`,out:`condition`})}\n  if (condition) {\n    ${e} = i;\n    break;\n  }\n}\n`).setDebugName(`GlslFindIndexBlock`)}function He(e,t,n){let r=typeof t==`function`?t():t,i=typeof n==`function`?n():n,a=new r.constructor(new te(e,r,i));return a.isImplicit=!0,a}function Ue(...e){let t=e.map(([e,t])=>typeof t==`function`?[e,t()]:[e,t]),n=t[0][1].constructor,r=t.findIndex(e=>!0===e[0]);if(r===-1)throw Error("A cond must have a fallthrough case with `true`/; ");let i=t.slice(0,r),a=t[r][1],o=new n(i.reduceRight((e,t)=>He(t[0],t[1],e),a));return o.isImplicit=!0,o}function V(e,t){return I(`*`,e,t)}function H(e,t){return I(`/`,e,t)}function U(e,t){return I(`+`,e,t)}function W(e,t){return I(`-`,e,t)}function We(e,t){return I(`%`,e,t)}function Ge(e,t){return I(`<<`,e,t)}function Ke(e,t){return I(`>>`,e,t)}function qe(e,t){return I(`&`,e,t)}function Je(e,t){return I(`|`,e,t)}function Ye(e,t){return I(`^`,e,t)}function Xe(e){return L(`~`,e)}function Ze(e,t){return I(`==`,e,t,A)}function Qe(e,t){return I(`!=`,e,t,A)}function $e(e,t){return I(`<`,e,t,A)}function et(e,t){return I(`<=`,e,t,A)}function tt(e,t){return I(`>`,e,t,A)}function nt(e,t){return I(`>=`,e,t,A)}function rt(...e){return e.length<=1?e[0]:e.slice(1).reduce((e,t)=>it(e,t),e[0])}function it(e,t){return I(`||`,e,t,A)}function at(...e){return e.length<=1?e[0]:e.slice(1).reduce((e,t)=>ot(e,t),e[0])}function ot(e,t){return I(`^^`,e,t,A)}function st(...e){return e.length<=1?e[0]:e.slice(1).reduce((e,t)=>ct(e,t),e[0])}function ct(e,t){return I(`&&`,e,t,A)}function lt(e){return L(`abs`,e)}function ut(e){return L(`acos`,e)}function dt(e){return L(`acosh`,e)}function ft(e){return L(`all`,e,A)}function pt(e){return L(`any`,e,A)}function mt(e){return L(`asin`,e)}function ht(e){return L(`asinh`,e)}function gt(e,t){return t==null?L(`atan`,e):R(`atan`,e,t,e.constructor)}function _t(e){return L(`atanh`,e)}function vt(e){return L(`ceil`,e)}function yt(e,t,n){return z(`clamp`,e,t,n,e.constructor)}function bt(e){return L(`cos`,e)}function xt(e){return L(`cosh`,e)}function St(e,t){return R(`distance`,e,t,T)}function Ct(e,t){return R(`dot`,e,t,T)}function wt(e){return L(`exp`,e)}function Tt(e){return L(`floor`,e)}function Et(e){return L(`fract`,e)}function Dt(e){return L(`length`,e,T)}function Ot(e){return L(`log`,e)}function kt(e){return L(`log2`,e)}function At(e,t){return R(`max`,e,t)}function jt(e,t){return R(`min`,e,t)}function Mt(e,t,n){return z(`mix`,e,t,n)}function Nt(e,t){return R(`mod`,e,t)}function Pt(e){return L(`normalize`,e)}function Ft(e){return e.type===`bool`?L(`!`,e):L(`not`,e)}function It(e,t){return R(`pow`,e,t)}function Lt(e){return L(`round`,e)}function Rt(e){return L(`sign`,e)}function zt(e){return L(`sin`,e)}function Bt(e){return L(`sinh`,e)}function Vt(e,t,n){return z(`smoothstep`,e,t,n)}function Ht(e){return L(`sqrt`,e)}function Ut(e,t){return R(`step`,e,t,t.constructor)}function Wt(e){return L(`tan`,e)}function Gt(e){return L(`tanh`,e)}function Kt(e,t,n){return z(`texelFetch`,e,t,n,O)}function qt(e,t){return R(`texture`,e,t,O)}function Jt(e,t){let{initialValue:n,xRange:r,yRange:i,callback:a}=t,[o,s]=r,[c,l]=i,u=new M(0).setMutable().setDebugName(`iterX`),d=new M(0).setMutable().setDebugName(`iterY`),f=n.setMutable().setDebugName(`accumulator`),p=a(f,e.get(u,d),u,d).setDebugName(`callback`);return B({iterX:u,iterY:d,accumulator:f},n.constructor,p,({out:e,iterX:t,iterY:n,accumulator:r,subgraph:i})=>`\nfor (${n} = ${c}; ${n} < ${l}; ${n}++) {\n  for (${t} = ${o}; ${t} < ${s}; ${t}++) {\n\n  ${i.body}\n\n  ${r} = ${i.varName};\n  }\n}\n${e} = ${r};\n`).setDebugName(`reduce2DBody`)}var G=5;function Yt(e){for(let t of e.rootOutputNodes())e.shouldPruneOutputNode(t)||(t.variableName=K(e,t.node))}function Xt(e,t){let n=``;return typeof t!=`boolean`&&typeof t!=`number`&&t.debugInfo.name&&(n=`${t.debugInfo.name}_`),`${n}v${e.varCount++}`}function K(e,t,n=!1){if(typeof t==`number`||typeof t==`boolean`)return t.toString();let r=e.getEmit(t);if(r)return r;switch(t.shaderType){case`scope-node`:r=Zt(e,t);break;case`primitive-node`:r=rn(e,t,n);break;case`function-node`:r=nn(e,t);break;case`property-access-node`:r=en(e,t);break;case`property-access-2d-node`:r=tn(e,t);break;case`text-node`:r=t.text;break;case`block-node`:r=$t(e,t);break;case`condition-node`:r=Qt(e,t)}return e.setEmit(t,r),r}function q(e,t,n){let r=t.split(`
`);for(let t of r)if(t.trim().length){{let t=``;n!=null&&(t+=`/*id:${n??`000`}*/   `),e.body+=t.padEnd(14)}e.body+=` `.repeat(e.indent)+t+`
`}}function Zt(e,t){let n=new t.child.constructor;n.setDebugName(t.debugInfo.name);let r=K(e,n,!0);return q(e,`{ /*ScopeStart: ${t.uid} ${t.debugInfo.name}*/`),e.indent+=2,q(e,`${r} = ${K(e,t.child)};`),e.indent-=2,q(e,`} /*ScopeEnd: ${t.uid} ${t.debugInfo.name}*/`),r}function Qt(e,t){let n=K(e,new t.ifTrue.constructor,!0);q(e,`if (${K(e,t.condition)}) {`),e.indent+=2;let r=e.createSubgraphContext(),i=K(r,t.ifTrue);if(e.body+=r.body,i&&q(e,`${n} = ${i};`),e.indent-=2,q(e,`}`),t.ifFalse){q(e,`else {`),e.indent+=2;let r=e.createSubgraphContext(),i=K(r,t.ifFalse);e.body+=r.body,i&&q(e,`${n} = ${i};`),e.indent-=2,q(e,`}`)}return n}function $t(e,t){let{captureList:n,generator:r,returnType:i}=t,a={};for(let t in n){if(!n[t])continue;a[t]=K(e,n[t])}let o=K(e,new i,!0);if(a.out=o,t.subgraph){let n=e.createSubgraphContext(),r=K(n,t.subgraph.child),i=n.body;a.subgraph={varName:r,body:i}}let s=r(a);return q(e,`{
`),e.indent+=2,q(e,s),e.indent-=2,q(e,`}
`),o}function en(e,t){let n=K(e,t.target);return typeof t.property==`string`&&t.property.includes(`[`)?`${n}${t.property}`:typeof t.property==`string`?`${n}.${t.property}`:`${n}[${K(e,t.property)}]`}function tn(e,t){return`${K(e,t.target)}[${K(e,t.x)}][${K(e,t.y)}]`}function nn(e,t){let n=t.returnType.type;if(t.isInfix){let[r,i]=t.children.map(t=>K(e,t)),a=Xt(e,t);return q(e,`${n.padEnd(G)} ${a} = ${r} ${t.token} ${i};`,t.uid),a}let r=t.children.map(t=>K(e,t)).join(`, `),i=Xt(e,t);return q(e,`${n.padEnd(G)} ${i} = ${t.token}(${r});`,t.uid),i}function rn(e,t,n=!1){let r=e.getInput(t);if(r)return r.isUsed=!0,r.variableName;let i=t.children.length===1&&t.children[0]?.type===t.type;if(!t.isMutable&&(t.isImplicit||i))return K(e,t.children[0]);let a=Xt(e,t);if(n)return q(e,`${t.type.padEnd(G)} ${a};`,t.uid),a;let o=!t.debugInfo.name&&!t.isMutable;if(o){if(t.type===`float`&&typeof t.children[0]==`number`)return Number.isInteger(t.children[0])?t.children[0].toFixed(1):t.children[0].toString();if(t.type===`int`&&typeof t.children[0]==`number`&&Number.isInteger(t.children[0])||t.type===`bool`&&typeof t.children[0]==`boolean`)return t.children[0].toString()}let s=t.children.map(t=>K(e,t)).join(`, `);return t.type===`array`?(q(e,`${t.type.padEnd(G)} ${a} = [${s}];`,t.uid),a):o?`${t.type}(${s})`:(q(e,`${t.type.padEnd(G)} ${a} = ${t.type}(${s});`,t.uid),a)}var J=class e{constructor(e,t,n,r=[]){this.variableName=e,this.variableInputType=t,this.node=n,this.qualifiers=r,this.type=`shader-input`,this.isUsed=!1}clone(){return new e(this.variableName,this.variableInputType,m(this.node),[...this.qualifiers])}},Y=class e{constructor(e,t,n,r=[]){this.outVariableName=e,this.outVariableType=t,this.node=n,this.qualifiers=r,this.type=`shader-output`}clone(){let t=new e(this.outVariableName,this.outVariableType,m(this.node),[...this.qualifiers]);return t.variableName=this.variableName,t}},an=class e{static createVertex(t,n,r,i,a,o){let s=[];for(let e in t){let n=t[e],i=r.get(e);i?s.push(new J(i,`builtin`,n)):s.push(new J(`a_`+e,`in`,n))}for(let e of i){let t=e.uniformHydrated;s.push(new J(e.uniformName,`uniform`,t))}let c=[];for(let e in n){let t=n[e];if(e===`glPosition`)c.push(new Y(`gl_Position`,`builtin`,t));else if(e===`glPointSize`)c.push(new Y(`gl_PointSize`,`builtin`,t));else{let n=on(t),r=[];n&&r.push(n),c.push(new Y(`v_`+e,`out`,t,r))}}return new e(s,c,a,o)}static createFragment(t,n,r,i,a,o){let s=[],c=Array.from(a.rootOutputNodes());for(let e in t){let n=t[e],i=r.get(e);if(i){s.push(new J(i,`builtin`,n));continue}let a=c.find(e=>e.node===n);a&&s.push(new J(a.outVariableName,`in`,n))}for(let e of i){let t=e.uniformHydrated;s.push(new J(e.uniformName,`uniform`,t))}let l=[];for(let e in n){let t=n[e],i=r.get(e);switch(e){case`discard`:l.push(new Y(null,`discard`,t));break;case`fragData0`:l.push(new Y(`fragData0`,`fragData0`,t));break;case`fragData1`:l.push(new Y(`fragData1`,`fragData1`,t));break;case`fragData2`:l.push(new Y(`fragData2`,`fragData2`,t));break;case`fragData3`:l.push(new Y(`fragData3`,`fragData3`,t));break;default:i?l.push(new Y(i,`builtin`,t)):l.push(new Y(e,`out`,t))}}return new e(s,l,o)}constructor(e,t,n,r){this.type=`shader-graph-context`,this.indent=0,this.body=``,this.varCount=0,this._inputShaderTypesByNodeUid=new Map,this._nodeEmitMap=new Map;for(let t of e)this._inputShaderTypesByNodeUid.set(t.node.uid,t);this._outputShaderTypes=t,this._transformFeedbackBindings=n,this._transformFeedbackNames=new Set(n.map(e=>`v_`+e.propertyKey)),this._usedInFragmentShader=r}shouldPruneOutputNode(e){return!!this._usedInFragmentShader&&e.outVariableType!==`builtin`&&!this._transformFeedbackNames.has(e.outVariableName)&&!this._usedInFragmentShader.has(e.node.uid)}setEmit(e,t){this._nodeEmitMap.set(e.uid,t)}getEmit(e){return this._nodeEmitMap.get(e.uid)}inputs(){return this._inputShaderTypesByNodeUid.values()}getInput(e){return this._inputShaderTypesByNodeUid.get(e.uid)}*rootOutputNodes(){for(let e of this._outputShaderTypes)yield e}*nodes(){let e=[];for(let t of this._outputShaderTypes.values())e.push(t.node);for(;e.length;){let t=e.pop();typeof t!=`number`&&typeof t!=`boolean`&&e.push(...t.children.filter(Boolean)),yield t}}*nodesOfTypeOrFunction(){for(let e of this.nodes())typeof e!=`number`&&typeof e!=`boolean`&&(yield e)}createSubgraphContext(){let e=this.clone();return e.body=``,e.indent=this.indent+2,e._nodeEmitMap=new Map(this._nodeEmitMap),e}clone(){let t=new e([],this._outputShaderTypes,this._transformFeedbackBindings,this._usedInFragmentShader);return t._inputShaderTypesByNodeUid=this._inputShaderTypesByNodeUid,t.indent=this.indent,t.body=this.body,t.varCount=this.varCount,t._nodeEmitMap=this._nodeEmitMap,t}insertVertexShader(e){e.vertex.code.add(``),this._insertInputs(e,`vertex`),e.vertex.code.add(``),e.vertex.code.add(`// OUTPUTS: `),e.vertex.code.add(`// --------------------------------------------------------- `);for(let t of this.rootOutputNodes()){let n=t.outVariableType===`builtin`;if(!this.shouldPruneOutputNode(t))if(n)e.vertex.code.add(`// ${t.outVariableType.padEnd(7)} ${t.node.type.padEnd(9)} ${t.outVariableName};`);else{let n=[...t.qualifiers,t.outVariableType].join(` `);e.vertex.code.add(`${n.padEnd(10)} ${t.node.type.padEnd(9)} ${t.outVariableName};`)}}e.vertex.code.add(``),e.vertex.code.add(`void main() {`),e.vertex.code.add(`  `+this.body.split(`
`).join(`
  `));for(let t of this.rootOutputNodes())this.shouldPruneOutputNode(t)||e.vertex.code.add(`  ${t.outVariableName} = ${t.variableName};`);e.vertex.code.add(`}`)}insertFragmentShader(e){this._insertInputs(e,`fragment`),e.fragment.code.add(``),e.fragment.code.add(`// OUTPUTS: `),e.fragment.code.add(`// --------------------------------------------------------- `);let t=0;for(let n of this.rootOutputNodes())n.outVariableType===`builtin`?e.fragment.code.add(`// ${n.outVariableType.padEnd(7)} ${n.node.type.padEnd(9)} ${n.outVariableName};`):n.outVariableType===`discard`||e.outputs.add(n.outVariableName,n.node.type,t++);e.fragment.code.add(``),e.fragment.code.add(`void main() {`),e.fragment.code.add(`  `+this.body.split(`
`).join(`
  `));let n=Array.from(this.rootOutputNodes()),r=n.find(e=>e.outVariableType===`discard`),i=n.filter(e=>e.outVariableType!==`discard`);r&&(e.fragment.code.add(`  if (${r.variableName}) {`),e.fragment.code.add(`    discard;`),e.fragment.code.add(`  }`),e.fragment.code.add(`  `));for(let t of i)e.fragment.code.add(`  ${t.outVariableName} = ${t.variableName};`);e.fragment.code.add(`}`)}_insertInputs(e,t){e[t].code.add(`// INPUTS: `),e[t].code.add(`// --------------------------------------------------------- `);for(let n of this.inputs())if(n.isUsed&&n.variableInputType!==`builtin`)if(n.node.type===`array`)e[t].code.add(`${n.variableInputType.padEnd(10)} ${n.node.elementType.type.padEnd(9)} ${n.variableName}[${n.node.size}];`);else if(n.node.type===`array-2d`)e[t].code.add(`${n.variableInputType.padEnd(10)} ${n.node.elementType.type.padEnd(9)} ${n.variableName}[${n.node.size}]; // Emulated 2D Array. Not supported by ES3.0`);else{let r=[...n.qualifiers,n.variableInputType].join(` `);e[t].code.add(` ${r.padEnd(10)} ${n.node.type.padEnd(9)} ${n.variableName};`)}}};function on(e){switch(e.type){case`float`:case`vec2`:case`vec3`:case`vec4`:return null;case`int`:case`ivec2`:case`ivec3`:case`ivec4`:case`uint`:case`uvec2`:case`uvec3`:case`uvec4`:case`bool`:case`bvec2`:case`bvec3`:case`bvec4`:return`flat`;case`mat2`:case`mat3`:case`mat4`:case`array`:case`sampler2D`:case`array-2d`:throw Error(`InternalError: ${e.type} is not a valid output type`)}}function sn(e,t,n){let i=new o(t.width,t.height);return i.dataType=t.dataType,t.depth&&(i.depth=t.depth),t.flipped&&(i.flipped=t.flipped),t.hasMipmap&&(i.hasMipmap=t.hasMipmap),i.internalFormat=t.internalFormat,t.isImmutable&&(i.isImmutable=t.isImmutable),t.isOpaque&&(i.isOpaque=t.isOpaque),t.maxAnisotropy&&(i.maxAnisotropy=t.maxAnisotropy),i.pixelFormat=t.pixelFormat,t.preMultiplyAlpha&&(i.preMultiplyAlpha=t.preMultiplyAlpha),t.samplingMode&&(i.samplingMode=t.samplingMode),t.target&&(i.target=t.target),t.unpackAlignment&&(i.unpackAlignment=t.unpackAlignment),t.wrapMode&&(i.wrapMode=t.wrapMode),new r(e,i,n)}var cn=()=>t.getLogger(`esri.views.2d.engine.webgl.shaderGraph.typed.TypedShaderProgram`);function X(t,n,r){let i=n.length;if(i!==r){let a=new e(`Invalid Uniform`,`Invalid length, expected ${r} but got ${i}`,{uniformName:t,values:n});cn().errorOnce(a)}}var ln=class{constructor(e,t,n,r,i,a){this.debugName=e,this.vertexShader=t,this.fragmentShader=n,this._locations=r,this._uniformBindings=i,this._transformFeedbackBindings=a,this._vao=null,this._temporaryTextures=[]}destroy(){this._program=a(this._program),this.cleanupTemporaryTextures()}[Symbol.dispose](){this.destroy()}setUniforms(e){this._uniforms=e}validate(e){if(!this._validation){let t=this._validateWebGL2(e);t.type===`error`&&(t.error=`Validation failed for ShaderModule '${this.debugName}'\n${t.error}`),this._validation=t}return this._validation}cleanupTemporaryTextures(){for(let e of this._temporaryTextures)e.dispose();this._temporaryTextures=[]}bind(e){let t=this._uniforms;if(!this._program){let t=[];for(let e of this._transformFeedbackBindings??[]){let{index:n,propertyKey:r}=e;t[n]=`v_${r}`}this._program=new s(e,this.vertexShader,this.fragmentShader,this._locations,new Map,t)}let r=this._program;e.useProgram(r);for(let i of this._uniformBindings){let{shaderModulePath:a,uniformName:o,uniformType:s,uniformArrayLength:c}=i,l=n(a,t);if(l==null){if(s===`sampler2D`)continue;throw Error(`Failed to find uniform value for ${a}`)}switch(s===`array`||s===`array-2d`?i.uniformArrayElementType:s){case`sampler2D`:{let{unit:t,texture:n}=l;if(r.setUniform1i(o,t),`type`in n)e.bindTexture(n,t);else{let r=sn(e,n.descriptor,n.data);e.bindTexture(r,t)}break}case`int`:if(!c){r.setUniform1i(o,l);break}X(i.uniformName,l,c),r.setUniform1iv(o,l);break;case`float`:if(!c){r.setUniform1f(o,l);break}X(i.uniformName,l,c),r.setUniform1fv(o,l);break;case`vec2`:if(!c){r.setUniform2f(o,l[0],l[1]);break}X(i.uniformName,l,c),r.setUniform2fv(o,l.flat());break;case`vec3`:if(!c){r.setUniform3f(o,l[0],l[1],l[2]);break}X(i.uniformName,l,c),r.setUniform3fv(o,l.flat());break;case`vec4`:if(!c){r.setUniform4f(o,l[0],l[1],l[2],l[3]);break}X(i.uniformName,l,c),r.setUniform4fv(o,l.flat());break;case`mat3`:r.setUniformMatrix3fv(o,l);break;case`mat4`:r.setUniformMatrix4fv(o,l);break;default:throw Error(`Unable to set uniform for type ${s}`)}}}_validateWebGL2(e){let t=e.gl,n=dn(t,35633,this.vertexShader);if(n.type===`error`)return n;let r=dn(t,35632,this.fragmentShader);if(r.type===`error`)return r;let i=n.value,a=r.value,o=t.createProgram();return t.attachShader(o,i),t.attachShader(o,a),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)?(t.deleteProgram(o),{type:`ok`,value:null}):{type:`error`,error:`Failed to link shader:\nvalidated: ${t.getProgramParameter(o,t.VALIDATE_STATUS)}, gl error ${t.getError()}, vertex: ${t.getShaderParameter(i,t.COMPILE_STATUS)}, fragment: ${t.getShaderParameter(a,t.COMPILE_STATUS)}, info log: ${t.getProgramInfoLog(o)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`}}};function un(e){let t=e.match(/\d+:(\d+):/);if(t?.index!==void 0&&t?.length>1){let e=t.index+t[0].length;return{lineNumber:parseInt(t[1],10),offset:e}}return null}function dn(e,t,n){let r=e.createShader(t),i=c(n,t);if(e.shaderSource(r,i),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){let i=e.getShaderInfoLog(r)??``,a=``,o=i.split(`
`),s=new Map,c=[];for(let e of o){let t=un(i);if(!t){c.push(e);continue}let n=s.get(t.lineNumber);n||(n=[],s.set(t.lineNumber,n)),n.push({text:e,offset:t.offset})}let l=Array.from(s.entries()).sort();for(let[e,t]of l){let r=n.split(`
`),i=Math.max(e-2,0),o=Math.min(e+2,r.length);for(let n=i;n!==o;n++)if(a+=`${(n+1).toString().padEnd(4)}${r[n]}\n`,n===e-1){let e=r[n].length;a+=`    `+Array(e).join(`^`)+`
`;for(let{text:e,offset:n}of t)a+=`      `+e.slice(n).trim()+`
`}}for(let e of c)a+=e+`
`;let u=`Failed to compile ${t===35633?`vertex`:`fragment`} shader:\n\n${a}`;return e.deleteShader(r),{type:`error`,error:u}}return{type:`ok`,value:r}}function Z(e){return new e}function Q(e,t,n){let r=e.constructor[t]??[];e.constructor.hasOwnProperty(t)||Object.defineProperty(e.constructor,t,{value:r.slice()}),e.constructor[t].push(n)}function fn(e,t){return(n,r)=>{Q(n,`locations`,{typeCtor:t,propertyKey:r,parameterIndex:null,index:e})}}var pn=e=>(t,n)=>{Q(t,`builtins`,{builtin:e,propertyKey:n})},mn=e=>(t,n,r)=>{Q(t,`inputs`,{inputCtor:e,propertyKey:n,parameterIndex:r})},hn=e=>(t,n)=>{Q(t,`uniforms`,{typeCtor:e,propertyKey:n})},gn=e=>(t,n)=>{Q(t,`options`,{typeCtor:e,propertyKey:n})},_n=(e,t)=>{Q(e,`defines`,{propertyKey:t})},vn=(e,t)=>(n,r)=>{n.constructor.builtins.push({builtin:e,propertyKey:r,typeCtor:t})},yn=class{static{this.builtins=[]}};i([vn(`gl_VertexID`,M)],yn.prototype,`glVertexID`,void 0);var bn=class{},$=class{static{this.builtins=[]}};i([vn(`gl_FragCoord`,O)],$.prototype,`glFragCoord`,void 0),i([vn(`gl_PointCoord`,E)],$.prototype,`glPointCoord`,void 0);var xn=class{};i([pn(`gl_FragDepth`)],xn.prototype,`glFragDepth`,void 0);var Sn=class{constructor(){this.type=`uniform-group`}get _uniforms(){return this.constructor.uniforms??[]}},Cn=class{constructor(){this.logShader=!1,this.computeAttributes={}}get vertexInput(){let e=this._shaderModuleClass.inputs.findLast(e=>e.propertyKey===`vertex`&&e.parameterIndex===0);if(!e)throw Error(`Unable to find vertex input parameter`);return e}get computeInput(){return this._shaderModuleClass.inputs.findLast(e=>e.propertyKey===`vertex`&&e.parameterIndex===1)}get fragmentInput(){let e=this._shaderModuleClass.inputs.findLast(e=>e.propertyKey===`fragment`);if(!e)throw Error(`Unable to find fragment input parameter`);return e}get transformFeedbackBindings(){return this.fragmentInput.inputCtor.transformFeedbackBindings??[]}get locations(){return[...this.vertexInput.inputCtor.locations,...this.computeInput?.inputCtor.locations??[]]}get locationsMap(){let e=new Map,n=new Set;for(let r of this.locations)n.has(r.index)?t.getLogger(`esri.views.2d.engine.webgl.shaderGraph.GraphShaderModule`).warnOnce(`mapview-rendering`,`Unable to assigned attribute ${r.propertyKey} to ${r.index}. Index already in use`,{locationsMap:e}):(e.set(r.propertyKey,r.index),n.add(r.index));return e}get locationInfo(){if(!this._locationInfo){let e=this.locationsMap,t=Array.from(e.entries()).map(([e,t])=>`${e}.${t}`).join(`.`),n=this.computeAttributes;this._locationInfo={stringHash:t,locations:e,computeAttributeMap:n}}return this._locationInfo}get renamedLocationsMap(){let e=new Map;for(let t of this.locations)e.set(`a_`+t.propertyKey,t.index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){let e=new Set;for(let t of this._options)e.add(t.propertyKey);this._optionPropertyKeys=e}return this._optionPropertyKeys}get _shaderModuleClass(){return this.constructor}get _defines(){return this._shaderModuleClass.defines??[]}get _options(){return this._shaderModuleClass.options??[]}get _uniforms(){return this._shaderModuleClass.uniforms??[]}getProgram(e,t,n,r){try{let{vertex:i,fragment:a,uniformBindings:o}=this._generateShaders(e,t,n,r);return new ln(this.type,i,a,this.renamedLocationsMap,o,this.transformFeedbackBindings)}catch{return new ln(this.type,``,``,this.renamedLocationsMap,[],this.transformFeedbackBindings)}}getDebugUniformClassInfo(e){let t=this._options.find(t=>t.propertyKey===e);if(t)return{type:`option`,className:t.typeCtor};let n=this._uniforms.find(t=>t.propertyKey===e);if(!n)throw Error(`Unable to find uniform class type for property: ${e}`);return{type:`required`,className:n.typeCtor}}getShaderKey(e,t,n,r){let i=Object.keys(e).map(t=>`${t}.${e[t]}`).join(`.`),a=Object.keys(n).map(e=>`${e}.${n[e]}`).join(`.`),o=Object.keys(r).map(e=>`${e}.${r[e]}`).join(`.`),s=Object.keys(t).filter(e=>this.optionPropertyKeys.has(e)&&t[e]).join(`.`);return`${this.type}.${i}.${a}.${o}.${s}`}_generateShaders(e,t,n,r){let i=[];this._setDefines(n),this._setOptionalUniforms(i,t),this._setRequiredUniforms(i);let a=this._hydrateVertexInput(r),o=this._injectPackPrecisionFactor(a,e),s=this._hydrateComputeInput(),c=s&&this._injectComputePackPrecisionFactor(s,e),l=this.vertex(o,c),u=this._hydrateFragmentInput(l),d=this.fragment(u),p=new Set;for(let e in d){let t=d[e];f(p,t)}let m=this._getVertexInputBuiltins(),h={};for(let[e,t]of Object.entries(a))h[e]=t;if(s!=null)for(let[e,t]of Object.entries(s))h[e]=t;let g=an.createVertex(h,l,m,i,this.transformFeedbackBindings,p);Yt(g);let _=this._getFragmentInputBuiltins(d);_.set(`glPointCoord`,`gl_PointCoord`),_.set(`glFragCoord`,`gl_FragCoord`);let ee=an.createFragment(u,d,_,i,g,this.transformFeedbackBindings);Yt(ee);let te=this._createShaderBuilder(g,ee),ne=te.generate(`vertex`),v=te.generate(`fragment`);return this.logShader&&(console.log(ne),console.log(v)),{vertex:ne,fragment:v,uniformBindings:i}}_setDefines(e){for(let t in e)this[t]=e[t]}_setOptionalUniforms(e,t){for(let n of this._options)t[n.propertyKey]?this[n.propertyKey]=this._hydrateUniformGroup(e,n):this[n.propertyKey]=null}_setRequiredUniforms(e){for(let t of this._uniforms)this[t.propertyKey]=this._hydrateUniformGroup(e,t)}_hydrateUniformGroup(e,t){let n=new t.typeCtor;for(let r of n._uniforms??[]){let i=Z(r.typeCtor),a=`u_${t.propertyKey}_${r.propertyKey}`,o=i.type,s=[t.propertyKey,r.propertyKey].join(`.`);if(`type`in r.typeCtor&&r.typeCtor.type===`array`){let t=i;e.push({shaderModulePath:s,uniformName:a,uniformType:o,uniformArrayLength:t.size,uniformArrayElementType:t.elementType.type,uniformHydrated:i})}else if(`type`in r.typeCtor&&r.typeCtor.type===`array-2d`){let t=i;e.push({shaderModulePath:s,uniformName:a,uniformType:o,uniformArrayLength:t.size,uniformArrayElementType:t.elementType.type,uniformHydrated:i})}else e.push({shaderModulePath:s,uniformName:a,uniformType:o,uniformHydrated:i});n[r.propertyKey]=i}return n}_hydrateVertexInput(e){let t=this.vertexInput.inputCtor,n=t.locations.reduce((t,n)=>!1===e[n.propertyKey]?t:{...t,[n.propertyKey]:Z(n.typeCtor)},{});for(let{propertyKey:e,typeCtor:r}of t.builtins)n[e]=Z(r);return n}_hydrateComputeInput(){return this.computeInput==null?null:this.computeInput.inputCtor.locations.reduce((e,t)=>({...e,[t.propertyKey]:Z(t.typeCtor)}),{})}_injectPackPrecisionFactor(e,t){let n={};for(let r in e){let i=e[r],a=t[r];if(a){if(i.type!==`float`&&i.type!==`vec2`&&i.type!==`vec3`&&i.type!==`vec4`)throw Error(`InternalError: packPrecisionFactor requires GenType, but found ${i.type}`);n[r]=i.divide(new T(a))}else n[r]=i}return n}_injectComputePackPrecisionFactor(e,t){let n={},r=new Map;for(let e in this.computeAttributes)for(let t of this.computeAttributes[e]??[])r.set(t,e);for(let i in e){let a=e[i],o=r.get(i);if(!o)continue;let s=t[o];if(s){if(a.type!==`float`&&a.type!==`vec2`&&a.type!==`vec3`&&a.type!==`vec4`)throw Error(`InternalError: packPrecisionFactor requires GenType, but found ${a.type}`);n[i]=a.divide(new T(s))}else n[i]=a}return n}_hydrateFragmentInput(e){let t={};for(let n in e)t[n]=e[n];for(let{propertyKey:e,typeCtor:n}of $.builtins)t[e]=Z(n);return t}_getVertexInputBuiltins(){let e=this.vertexInput.inputCtor,t=new Map;for(let{builtin:n,propertyKey:r}of e.builtins)t.set(r,n);return t}_getFragmentInputBuiltins(e){let t=e.constructor,n=new Map;for(let e of t.builtins??[])n.set(e.propertyKey,e.builtin);return n}_createShaderBuilder(e,t){let n=new l;return this._insertDebugInfo(n),e.insertVertexShader(n),t.insertFragmentShader(n),n}_insertDebugInfo(e){e.vertex.code.add(`// DEFINES: `),e.vertex.code.add(`// --------------------------------------------------------- `);for(let t of this._defines)this[t.propertyKey]?e.vertex.code.add(`//   ${t.propertyKey}: true`):e.vertex.code.add(`//   ${t.propertyKey}: false`);e.vertex.code.add(``),e.vertex.code.add(`// OPTIONS: `),e.vertex.code.add(`// --------------------------------------------------------- `);for(let t of this._options)this[t.propertyKey]?e.vertex.code.add(`//   ${t.propertyKey}: true`):e.vertex.code.add(`//   ${t.propertyKey}: false`)}};export{Gt as $,Et as A,Ne as At,At as B,A as C,ht as Ct,lt as D,Pe as Dt,qe as E,Bt as Et,Ft as F,Tt as Ft,N as G,D as H,M as I,He as It,Mt as J,dt as K,It as L,u as Lt,be as M,qt as Mt,kt as N,B as Nt,Ge as O,vt as Ot,Xe as P,St as Pt,Rt as Q,ut as R,nt as S,Ye as St,st as T,yt as Tt,jt as U,Qe as V,$e as W,Wt as X,et as Y,_t as Z,T as _,Vt as _t,fn as a,Ie as at,Nt as b,ye as bt,hn as c,Dt as ct,bn as d,Ut as dt,Re as et,ln as f,Le as ft,Je as g,bt as gt,w as h,ke as ht,_n as i,Ht as it,Ue as j,Ct as jt,We as k,zt as kt,xn as l,Jt as lt,rt as m,Lt as mt,$ as n,ze as nt,gn as o,gt as ot,Pt as p,mt as pt,O as q,Cn as r,xt as rt,mn as s,je as st,yn as t,wt as tt,Sn as u,Ke as ut,Ze as v,Fe as vt,at as w,Ae as wt,tt as x,Ot as xt,V as y,Kt as yt,E as z};