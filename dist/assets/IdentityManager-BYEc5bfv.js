const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/calcite-button-Cg-28g-X.js","assets/index-ByaFsVj4.js","assets/index-DiFef-Um.css","assets/controllers-BfIx9yqU.js","assets/useSetFocus-ClsE_5Rm.js","assets/dom-DR7u6Enw.js","assets/form-B1_xOzdb.js","assets/guid-CL9r11ws.js","assets/interactive-aQaaPYrF.js","assets/label-DezmwjkL.js","assets/logger-dsalWiU9.js","assets/observers-CqKY93PD.js","assets/useT9n-BRpF4HW6.js","assets/calcite-icon-0-auIIje.js","assets/calcite-loader-GtMhoJfo.js","assets/static-uBIZnnXo.js","assets/calcite-dialog-Q8ZN2V4F.js","assets/FloatingArrow-BRWs2lO6.js","assets/keyed-Bo3iAr7H.js","assets/calcite-action-menu-Cn-MaBtG.js","assets/floating-ui-BFxAKspu.js","assets/debounce-Dcuk9yc4.js","assets/key-NNODzVeo.js","assets/openCloseComponent-BYOM6qG3.js","assets/dynamicClasses-DbfUCjG2.js","assets/calcite-panel-BV-0H5sJ.js","assets/calcite-action-_mPfZstf.js","assets/calcite-scrim-BU7XK0ls.js","assets/calcite-input-diOA5HTx.js","assets/calcite-input-BtgglXxo.js","assets/calcite-input-message-DJZ2Bbay.js","assets/calcite-label-COWstktg.js","assets/calcite-notice-H1bphe6A.js"])))=>i.map(i=>d[i]);
import{BC as e,BS as t,BT as n,Bo as r,CC as i,DC as a,DT as o,EC as s,FT as c,GC as l,Io as u,Kw as d,Lo as f,Lw as p,OT as m,RC as h,RS as g,Xa as _,Ya as v,_C as ee,_E as y,_g as b,aC as x,aT as S,cC as C,gC as w,gD as T,hC as te,iC as ne,lC as re,lv as E,nT as D,pC as O,sv as k,wE as A,xE as j,y_ as M,zC as ie}from"./index-ByaFsVj4.js";var N=class extends k{constructor(e){super(e),this._oAuthCred=null,this.tokenRefreshBuffer=2,e?._oAuthCred&&(this._oAuthCred=e._oAuthCred)}initialize(){this.resources=this.resources||[],this.creationTime??=Date.now()}refreshToken(){return x.refreshToken(this)}refreshServerTokens(){return x.refreshServerTokens(this)}emitTokenChange(e){clearTimeout(this._refreshTimer);let t=x,n=this.server?t.findServerInfo(this.server):null,r=n?.owningSystemUrl,i=r?t.findServerInfo(r):null;!1===e||r&&this.scope!==`portal`&&(!i?.webTierAuth||t.normalizeWebTierAuth)||this.expires==null&&this.validity==null||this._startRefreshTimer(),this.emit(`token-change`)}destroy(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null,this._oAuthCred&&=(this._oAuthCred.destroy(),null);let e=x,t=e.credentials.indexOf(this);t>-1&&e.credentials.splice(t,1),this.emitTokenChange(),this.emit(`destroy`)}toJSON(){let e=A({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),t=this.resources;return t&&t.length>0&&(e.resources=t.slice()),e}_startRefreshTimer(){clearTimeout(this._refreshTimer);let e=6e4*this.tokenRefreshBuffer,t=2**31-1,n=(this.validity?this.creationTime+6e4*this.validity:this.expires)-Date.now();n<0?n=0:n>t&&(n=t),this._refreshTimer=setTimeout(this.refreshToken.bind(this),n>e?n-e:n)}};T([o()],N.prototype,`creationTime`,void 0),T([o()],N.prototype,`expires`,void 0),T([o()],N.prototype,`isAdmin`,void 0),T([o()],N.prototype,`oAuthState`,void 0),T([o()],N.prototype,`resources`,void 0),T([o()],N.prototype,`scope`,void 0),T([o()],N.prototype,`server`,void 0),T([o()],N.prototype,`ssl`,void 0),T([o()],N.prototype,`token`,void 0),T([o()],N.prototype,`tokenRefreshBuffer`,void 0),T([o()],N.prototype,`userId`,void 0),T([o()],N.prototype,`validity`,void 0),N=T([c(`esri.identity.Credential`)],N);var P=N,F=`esri-identity-modal`,I={base:F,info:`${F}__info`,notice:`${F}__notice`},L=`ArcGIS Online`,R=class extends v{constructor(e,t){super(e,t),this.container=document.createElement(`div`),this.error=null,this.oAuthPrompt=!1,this.open=!1,this.signingIn=!1,this.server=null,this.resource=null,this._usernameInputNode=null,this._passwordInputNode=null,document.body.appendChild(this.container)}loadDependencies(){return _({button:()=>t(()=>import(`./calcite-button-Cg-28g-X.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15])),dialog:()=>t(()=>import(`./calcite-dialog-Q8ZN2V4F.js`),__vite__mapDeps([16,1,2,3,17,18,19,4,5,20,21,7,22,11,23,12,15,24,6,8,10,25,26,13,14,27])),input:()=>t(()=>import(`./calcite-input-diOA5HTx.js`),__vite__mapDeps([28,3,1,2,29,4,5,6,8,22,9,12,18,15,7,10,11,13,30])),label:()=>t(()=>import(`./calcite-label-COWstktg.js`),__vite__mapDeps([31,1,2,5,7,9])),notice:()=>t(()=>import(`./calcite-notice-H1bphe6A.js`),__vite__mapDeps([32,1,2,3,4,5,7,10,11,23,12,13]))})}get title(){return this.commonMessages?.auth.signIn}render(){let{open:e,title:t,messages:n,signingIn:r,oAuthPrompt:i,server:a,resource:o,error:s}=this,{info:c,oAuthInfo:l,lblItem:u,invalidUser:d,noAuthService:p,lblUser:m,lblPwd:h,lblCancel:g,lblSigning:_,lblOk:v}=n;return f(`div`,{class:this.classes(I.base,b(this.container))},f(`form`,{bind:this,onsubmit:this._submit},f(`calcite-dialog`,{bind:this,heading:t,modal:!0,open:e,outsideCloseDisabled:!0,scale:`s`,widthScale:`s`,onCalciteDialogClose:this._cancel,onCalciteDialogOpen:this._focusUsernameInput},f(`div`,{class:I.info},M(i?l:c,{server:a&&/\.arcgis\.com/i.test(a)?L:a,resource:`(${o||u})`})),s?f(`calcite-notice`,{class:I.notice,icon:`exclamation-mark-triangle`,kind:`danger`,open:!0},f(`div`,{slot:`message`},s.details?.httpStatus?d:p)):null,i?null:[f(`calcite-label`,null,m,f(`calcite-input`,{afterCreate:e=>this._usernameInputNode=e,autocomplete:`off`,bind:this,name:`username`,required:!0,spellcheck:!1,type:`text`,value:``})),f(`calcite-label`,null,h,f(`calcite-input`,{afterCreate:e=>this._passwordInputNode=e,bind:this,name:`password`,required:!0,type:`password`,value:``}))],f(`calcite-button`,{appearance:`outline`,bind:this,onclick:this._cancel,slot:`footer-end`,type:`button`},g),f(`calcite-button`,{loading:!!r,slot:`footer-end`,type:`submit`},r?_:v))))}_focusUsernameInput(){return r(()=>this._usernameInputNode)}_cancel(){this._set(`signingIn`,!1),this.open=!1,this._usernameInputNode&&(this._usernameInputNode.value=``),this._passwordInputNode&&(this._passwordInputNode.value=``),this.emit(`cancel`)}_submit(e){e.preventDefault(),this._set(`signingIn`,!0);let t=this.oAuthPrompt?{}:{username:this._usernameInputNode?.value,password:this._passwordInputNode?.value};this.emit(`submit`,t)}};T([o({readOnly:!0})],R.prototype,`container`,void 0),T([o(),u(`esri/t9n/common`)],R.prototype,`commonMessages`,void 0),T([o()],R.prototype,`error`,void 0),T([o(),u(`esri/identity/t9n/identity`)],R.prototype,`messages`,void 0),T([o()],R.prototype,`oAuthPrompt`,void 0),T([o()],R.prototype,`open`,void 0),T([o()],R.prototype,`signingIn`,void 0),T([o()],R.prototype,`server`,void 0),T([o({readOnly:!0})],R.prototype,`title`,null),T([o()],R.prototype,`resource`,void 0),R=T([m(`esri.identity.IdentityModal`)],R);var z=R,B=`esriJSAPIOAuth`,V=class{constructor(e,t){this.oAuthInfo=null,this.storage=null,this.appId=null,this.codeVerifier=null,this.expires=null,this.refreshToken=null,this.ssl=null,this.stateUID=null,this.token=null,this.userId=null,this.oAuthInfo=e,this.storage=t,this._init()}isValid(){let e=!1;if(this.oAuthInfo&&this.userId&&(this.refreshToken||this.token)){if(this.expires==null&&this.refreshToken)e=!0;else if(this.expires){let t=Date.now();this.expires>t&&(this.expires-t)/1e3>60*this.oAuthInfo.minTimeUntilExpiration&&(e=!0)}}return e}save(){if(!this.storage)return!1;let e=this._load(),t=this.oAuthInfo;if(t?.authNamespace&&t.portalUrl){let n=e[t.authNamespace];n||=e[t.authNamespace]={},this.appId||=t.appId,n[t.portalUrl]={appId:this.appId,codeVerifier:this.codeVerifier,expires:this.expires,refreshToken:this.refreshToken,ssl:this.ssl,stateUID:this.stateUID,token:this.token,userId:this.userId};try{this.storage.setItem(B,JSON.stringify(e))}catch(e){return console.warn(e),!1}return!0}return!1}destroy(){let e=this._load(),t=this.oAuthInfo;if(t?.appId&&t?.portalUrl&&(this.expires==null||this.expires>Date.now())&&(this.refreshToken||this.token)){let e=t.portalUrl.replace(/^http:/i,`https:`)+`/sharing/rest/oauth2/revokeToken`;g(e,{authMode:`anonymous`,keepAlive:!0,method:`post`,query:{f:`json`,auth_token:this.refreshToken||this.token,client_id:t.appId,token_type_hint:this.refreshToken?`refresh_token`:`access_token`}})}if(t?.authNamespace&&t.portalUrl&&this.storage){let n=e[t.authNamespace];if(n){delete n[t.portalUrl];try{this.storage.setItem(B,JSON.stringify(e))}catch(e){console.log(e)}}}t&&(t._oAuthCred=null,this.oAuthInfo=null)}_init(){let e=this._load(),t=this.oAuthInfo;if(t?.authNamespace&&t.portalUrl){let n=e[t.authNamespace];n&&(n=n[t.portalUrl],n&&(this.appId=n.appId,this.codeVerifier=n.codeVerifier,this.expires=n.expires,this.refreshToken=n.refreshToken,this.ssl=n.ssl,this.stateUID=n.stateUID,this.token=n.token,this.userId=n.userId))}}_load(){let e={};if(this.storage){let t=this.storage.getItem(B);if(t)try{e=JSON.parse(t)}catch(e){console.warn(e)}}return e}};V.prototype.declaredClass=`esri.identity.OAuthCredential`;var H,U=class extends l{static{H=this}constructor(e){super(e),this._oAuthCred=null,this.appId=null,this.authNamespace=`/`,this.expiration=20160,this.flowType=`auto`,this.forceLogin=!1,this.forceUserId=!1,this.locale=null,this.minTimeUntilExpiration=30,this.popup=!1,this.popupCallbackUrl=`oauth-callback.html`,this.popupWindowFeatures=`height=490,width=800,resizable,scrollbars,status`,this.portalUrl=`https://www.arcgis.com`,this.preserveUrlHash=!1,this.userId=null}clone(){return H.fromJSON(this.toJSON())}};T([o({json:{write:!0}})],U.prototype,`appId`,void 0),T([o({json:{write:!0}})],U.prototype,`authNamespace`,void 0),T([o({json:{write:!0}})],U.prototype,`expiration`,void 0),T([o({json:{write:!0}})],U.prototype,`flowType`,void 0),T([o({json:{write:!0}})],U.prototype,`forceLogin`,void 0),T([o({json:{write:!0}})],U.prototype,`forceUserId`,void 0),T([o({json:{write:!0}})],U.prototype,`locale`,void 0),T([o({json:{write:!0}})],U.prototype,`minTimeUntilExpiration`,void 0),T([o({json:{write:!0}})],U.prototype,`popup`,void 0),T([o({json:{write:!0}})],U.prototype,`popupCallbackUrl`,void 0),T([o({json:{write:!0}})],U.prototype,`popupWindowFeatures`,void 0),T([o({json:{write:!0}})],U.prototype,`portalUrl`,void 0),T([o({json:{write:!0}})],U.prototype,`preserveUrlHash`,void 0),T([o({json:{write:!0}})],U.prototype,`userId`,void 0),U=H=T([m(`esri.identity.OAuthInfo`)],U);var W=U,G=class extends l{constructor(e){super(e),this.adminTokenServiceUrl=null,this.currentVersion=null,this.hasPortal=null,this.hasServer=null,this.owningSystemUrl=null,this.owningTenant=null,this.server=null,this.shortLivedTokenValidity=null,this.tokenServiceUrl=null,this.webTierAuth=null}};T([o({json:{write:!0}})],G.prototype,`adminTokenServiceUrl`,void 0),T([o({json:{write:!0}})],G.prototype,`currentVersion`,void 0),T([o({json:{write:!0}})],G.prototype,`hasPortal`,void 0),T([o({json:{write:!0}})],G.prototype,`hasServer`,void 0),T([o({json:{write:!0}})],G.prototype,`owningSystemUrl`,void 0),T([o({json:{write:!0}})],G.prototype,`owningTenant`,void 0),T([o({json:{write:!0}})],G.prototype,`server`,void 0),T([o({json:{write:!0}})],G.prototype,`shortLivedTokenValidity`,void 0),T([o({json:{write:!0}})],G.prototype,`tokenServiceUrl`,void 0),T([o({json:{write:!0}})],G.prototype,`webTierAuth`,void 0),G=T([m(`esri.identity.ServerInfo`)],G);var K=G,q={},J=e=>{let t=new h(e.owningSystemUrl).host,n=new h(e.server).host,r=/.+\.arcgis\.com$/i;return r.test(t)&&r.test(n)},Y=(e,t)=>!!(J(e)&&t&&t.some(t=>t.test(e.server))),X=null,Z=null;try{X=window.localStorage,Z=window.sessionStorage}catch{}var Q=class extends E{constructor(){super(),this._portalConfig=globalThis.esriGeowConfig,this.serverInfos=[],this.oAuthInfos=[],this.credentials=[],this._soReqs=[],this._xoReqs=[],this._portals=[],this._defaultOAuthInfo=null,this._defaultTokenValidity=60,this.dialog=null,this.tokenValidity=null,this.normalizeWebTierAuth=!1,this._appOrigin=window.origin===`null`?window.location.origin:window.origin,this._appUrlObj=w(window.location.href),this._busy=null,this._rejectOnPersistedPageShow=!1,this._oAuthLocationParams=null,this._gwTokenUrl=`/sharing/rest/generateToken`,this._agsRest=`/rest/services`,this._agsPortal=/\/sharing(\/|$)/i,this._agsAdmin=/(https?:\/\/[^/]+\/[^/]+)\/admin\/?(\/.*)?$/i,this._adminSvcs=/\/rest\/admin\/services(\/|$)/i,this._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:`maps.arcgis.com`,tokenServiceUrl:`https://www.arcgis.com/sharing/rest/generateToken`},{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:`mapsdev.arcgis.com`,tokenServiceUrl:`https://dev.arcgis.com/sharing/rest/generateToken`},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:`mapsdevext.arcgis.com`,tokenServiceUrl:`https://devext.arcgis.com/sharing/rest/generateToken`},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:`mapsqa.arcgis.com`,tokenServiceUrl:`https://qaext.arcgis.com/sharing/rest/generateToken`},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,customBaseUrl:`maps.arcgis.com`,tokenServiceUrl:`https://www.arcgis.com/sharing/rest/generateToken`}],this._legacyFed=[],this._regexSDirUrl=/http.+\/rest\/services\/?/gi,this._regexServerType=/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|KnowledgeGraphServer|MapServer|MissionServer|MobileServer|NAServer|NetworkDiagramServer|OGCFeatureServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer|VideoServer)).*/gi,this._gwUser=/http.+\/users\/([^/]+).*/i,this._gwItem=/http.+\/items\/([^/]+).*/i,this._gwGroup=/http.+\/groups\/([^/]+).*/i,this._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i,this._createDefaultOAuthInfo=!0,this._hasTestedIfAppIsOnPortal=!1,this._getPlatformSelfError=null,this._getOAuthLocationParams(),window.addEventListener(`pageshow`,e=>{this._pageShowHandler(e)})}registerServers(e){let t=this.serverInfos;t?(e=e.filter(e=>!this.findServerInfo(e.server)),this.serverInfos=t.concat(e)):this.serverInfos=e,e.forEach(e=>{e.owningSystemUrl&&this._portals.push(e.owningSystemUrl),e.hasPortal&&this._portals.push(e.server)})}registerOAuthInfos(e){let t=this.oAuthInfos;if(t){for(let n of e){let e=this.findOAuthInfo(n.portalUrl);e&&t.splice(t.indexOf(e),1)}this.oAuthInfos=t.concat(e)}else this.oAuthInfos=e}registerToken(e){e={...e};let t=this._sanitizeUrl(e.server),n=this._isServerRsrc(t),r,i=this.findServerInfo(t),a=!0;i||(i=new K,i.server=this._getServerInstanceRoot(t),n?i.hasServer=!0:(i.tokenServiceUrl=this._getTokenSvcUrl(t),i.hasPortal=!0),this.registerServers([i])),r=this._findCredential(t),r?(delete e.server,Object.assign(r,e),a=!1):(r=new P({userId:e.userId,server:i.server??void 0,token:e.token,expires:e.expires,ssl:e.ssl,scope:n?`server`:`portal`}),r.resources=[t],this.credentials.push(r)),r.emitTokenChange(!1),a||r.refreshServerTokens()}toJSON(){return A({serverInfos:this.serverInfos.map(e=>e.toJSON()),oAuthInfos:this.oAuthInfos.map(e=>e.toJSON()),credentials:this.credentials.map(e=>e.toJSON())})}initialize(e){if(!e)return;typeof e==`string`&&(e=JSON.parse(e));let t=e.serverInfos,n=e.oAuthInfos,r=e.credentials;if(t){let e=[];t.forEach(t=>{t.server&&t.tokenServiceUrl&&e.push(t.declaredClass?t:new K(t))}),e.length&&this.registerServers(e)}if(n){let e=[];n.forEach(t=>{t.appId&&e.push(t.declaredClass?t:new W(t))}),e.length&&this.registerOAuthInfos(e)}r&&r.forEach(e=>{e.server&&e.token&&e.expires&&e.expires>Date.now()&&((e=e.declaredClass?e:new P(e)).emitTokenChange(),this.credentials.push(e))})}findServerInfo(e){let t;e=this._sanitizeUrl(e);for(let n of this.serverInfos)if(this._hasSameServerInstance(n.server,e)){t=n;break}return t}findOAuthInfo(e){let t;e=this._sanitizeUrl(e);for(let n of this.oAuthInfos)if(this._hasSameServerInstance(n.portalUrl,e)){t=n;break}return t}findCredential(e,t){if(!e)return;let n;e=this._sanitizeUrl(e);let r=this._isServerRsrc(e)?`server`:`portal`;if(t){for(let i of this.credentials)if(this._hasSameServerInstance(i.server,e)&&t===i.userId&&i.scope===r){n=i;break}}else for(let t of this.credentials)if(this._hasSameServerInstance(t.server,e)&&this._getIdenticalSvcIdx(e,t)!==-1&&t.scope===r){n=t;break}return n}getCredential(e,t){let r,i=!1,a=!0;t&&(i=!(!t.token&&!t.credential),r=t.error,a=!1!==t.prompt),t={...t},e=this._sanitizeUrl(e);let o=new AbortController,s=p();if(t.signal&&D(t.signal,()=>{o.abort()}),D(o,()=>{s.reject(new n(`identity-manager:user-aborted`,`ABORTED`))}),d(o))return s.promise;t.signal=o.signal;let c=this._isAdminResource(e),l=i?this.findCredential(e):null,u;if(l&&r?.details?.httpStatus===498)l.destroy();else if(l)return u=new n(`identity-manager:not-authorized`,`You are currently signed in as: '`+l.userId+`'. You do not have access to this resource: `+e,{error:r}),s.reject(u),s.promise;let f=this._findCredential(e,t);if(f)return s.resolve(f),s.promise;let m=this.findServerInfo(e);if(m)!m.hasPortal&&m.server&&m.owningSystemUrl&&this._hasSameServerInstance(m.server,m.owningSystemUrl)&&(m.hasPortal=!0),!m.hasServer&&this._isServerRsrc(e)&&(m._restInfoPms=this._getTokenSvcUrl(e),m.hasServer=!0);else{let t=this._getTokenSvcUrl(e);if(!t)return u=new n(`identity-manager:unknown-resource`,`Unknown resource - could not find token service endpoint.`),s.reject(u),s.promise;m=new K,m.server=this._getServerInstanceRoot(e),typeof t==`string`?(m.tokenServiceUrl=t,m.hasPortal=!0):(m._restInfoPms=t,m.hasServer=!0),this.registerServers([m])}return m.hasPortal&&m._selfReq===void 0&&(a||O(m.tokenServiceUrl,this._appOrigin)||this._gwDomains.some(e=>e.tokenServiceUrl===m.tokenServiceUrl))&&(m._selfReq={owningTenant:t?.owningTenant,selfDfd:this._getPortalSelf(m.tokenServiceUrl.replace(this._rePortalTokenSvc,`/sharing/rest/portals/self`),e)}),this._enqueue(e,m,t,s,c)}getResourceName(e){return this._isRESTService(e)?e.replace(this._regexSDirUrl,``).replace(this._regexServerType,``)||``:this._gwUser.test(e)&&e.replace(this._gwUser,`$1`)||this._gwItem.test(e)&&e.replace(this._gwItem,`$1`)||this._gwGroup.test(e)&&e.replace(this._gwGroup,`$1`)||``}generateToken(e,t,r){let i=this._rePortalTokenSvc.test(e.tokenServiceUrl),a=new h(this._appOrigin),o=e.shortLivedTokenValidity,s,c,l,u,d,f,p,m;t&&(m=this.tokenValidity||o||this._defaultTokenValidity,m>o&&o>0&&(m=o)),r&&(s=r.isAdmin,c=r.serverUrl,l=r.token,f=r.signal,p=r.ssl,e.customParameters=r.customParameters),s?u=e.adminTokenServiceUrl:(u=e.tokenServiceUrl,d=new h(u.toLowerCase()),e.webTierAuth&&r?.serverUrl&&!p&&a.scheme===`http`&&(O(a.uri,u,!0)||d.scheme===`https`&&a.host===d.host&&a.port===`7080`&&d.port===`7443`)&&(u=u.replace(/^https:/i,`http:`).replace(/:7443/i,`:7080`)));let _={query:{request:`getToken`,username:t?.username,password:t?.password,serverUrl:c,token:l,expiration:m,referer:s||i?this._appOrigin:null,client:s?`referer`:null,f:`json`,...e.customParameters},method:`post`,authMode:`anonymous`,useProxy:this._useProxy(e,r),signal:f};return i||(_.withCredentials=!1),g(u,_).then(r=>{let i=r.data;if(!i?.token)return new n(`identity-manager:authentication-failed`,`Unable to generate token`);let a=e.server;return q[a]||(q[a]={}),t&&(q[a][t.username]=t.password),i.validity=m,i})}isBusy(){return!!this._busy}async checkSignInStatus(e){return(await this.checkAppAccess(e,``)).credential}checkAppAccess(e,t,r){let i=!1;return this.getCredential(e,{prompt:!1}).then(a=>{let o,s={f:`json`};if(a.scope===`portal`)if(t&&(this._doPortalSignIn(e)||r?.force))o=a.server+`/sharing/rest/oauth2/validateAppAccess`,s.client_id=t;else{if(!a.token)return{credential:a};o=a.server+`/sharing/rest`}else{if(!a.token)return{credential:a};o=a.server+`/rest/services`}return a.token&&(s.token=a.token),g(o,{query:s,authMode:`anonymous`}).then(e=>{if(!1===e.data.valid)throw new n(`identity-manager:not-authorized`,`You are currently signed in as: '${a.userId}'.`,e.data);return i=!!e.data.viewOnlyUserTypeApp,{credential:a}}).catch(e=>{if(e.name===`identity-manager:not-authorized`)throw e;let t=e.details?.httpStatus;if(t===498)throw a.destroy(),new n(`identity-manager:not-authenticated`,`User is not signed in.`);if(t===400)throw new n(`identity-manager:invalid-request`,`Bad request`);return{credential:a}})}).then(e=>({credential:e.credential,viewOnly:i}))}setOAuthResponseHash(e){e&&(e.startsWith(`#`)&&(e=e.slice(1)),this._processOAuthPopupParams(i(e)))}setOAuthRedirectionHandler(e){this._oAuthRedirectFunc=e}setProtocolErrorHandler(e){this._protocolFunc=e}signIn(e,t,r={}){let i=p(),a=()=>{c?.remove(),l?.remove(),this.dialog?.destroy(),this.dialog=c=l=null},o=()=>{a(),this._oAuthDfd=null,i.reject(new n(`identity-manager:user-aborted`,`ABORTED`))};r.signal&&D(r.signal,()=>{o()});let s=new z({open:!0,resource:this.getResourceName(e),server:t.server});this.dialog=s,this.emit(`dialog-create`);let c=s.on(`cancel`,o),l=s.on(`submit`,e=>{this.generateToken(t,e,{isAdmin:r.isAdmin,signal:r.signal}).then(n=>{a();let o=new P({userId:e.username,server:t.server??void 0,token:n.token,expires:n.expires==null?null:Number(n.expires),ssl:!!n.ssl,isAdmin:r.isAdmin,validity:n.validity});i.resolve(o)}).catch(e=>{s.error=e,s.signingIn=!1})});return i.promise}oAuthSignIn(e,t,r,i){this._oAuthDfd=p();let o=this._oAuthDfd,s;i?.signal&&D(i.signal,()=>{let e=this._oAuthDfd&&this._oAuthDfd.oAuthWin_;e&&!e.closed?e.close():this.dialog&&d()}),o.resUrl_=e,o.sinfo_=t,o.oinfo_=r;let c=r._oAuthCred;if(c.storage&&(r.flowType===`authorization-code`||r.flowType===`auto`&&t.currentVersion>=8.4)){let e=crypto.getRandomValues(new Uint8Array(32));s=a(e),c.codeVerifier=s,e=crypto.getRandomValues(new Uint8Array(32)),c.stateUID=a(e),c.save()||(c.codeVerifier=s=null)}else c.codeVerifier=null;let l,u;this._getCodeChallenge(s).then(n=>{let a=!i||!1!==i.oAuthPopupConfirmation;if(!r.popup||!a)return void this._doOAuthSignIn(e,t,r,n);let o=new z({oAuthPrompt:!0,server:t.server,open:!0});this.dialog=o,this.emit(`dialog-create`),l=o.on(`cancel`,d),u=o.on(`submit`,()=>{f(),this._doOAuthSignIn(e,t,r,n)})});let d=()=>{f(),this._oAuthDfd=null,o.reject(new n(`identity-manager:user-aborted`,`ABORTED`))},f=()=>{l?.remove(),u?.remove(),this.dialog?.destroy(),this.dialog=null};return o.promise}async refreshToken(e){let t=this.findServerInfo(e.server),n=t?.owningSystemUrl,r=!!n&&e.scope===`server`,i=r&&Y(t,this._legacyFed),a=t.webTierAuth,o=a&&this.normalizeWebTierAuth,s=q[e.server],c=s?.[e.userId],l,u=e.resources&&e.resources[0],d=r?this.findServerInfo(n):null,f={username:e.userId,password:c};if(a&&!o)return;r&&!d&&this.serverInfos.some(e=>(this._isIdProvider(n,e.server)&&(d=e),!!d));let p=d?this.findCredential(d.server,e.userId):null;if(!r||p){if(!i){if(r)l={serverUrl:u,token:p?.token,ssl:p?.ssl};else if(o)f=null,l={ssl:e.ssl};else{if(!c){let n;return u&&(u=this._sanitizeUrl(u),e._enqueued=1,n=this._enqueue(u,t,null,null,e.isAdmin,e),n.then(()=>{e._enqueued=0,e.refreshServerTokens()}).catch(()=>{e._enqueued=0})),n}e.isAdmin&&(l={isAdmin:!0})}return this.generateToken(r?d:t,r?null:f,l).then(t=>{e.token=t.token,e.expires=t.expires==null?null:Number(t.expires),e.creationTime=Date.now(),e.validity=t.validity,e.emitTokenChange(),e.refreshServerTokens()}).catch(()=>{})}p?.refreshToken()}}refreshServerTokens(e){e.scope===`portal`&&this.credentials.forEach(t=>{let n=this.findServerInfo(t.server),r=n?.owningSystemUrl;t!==e&&t.userId===e.userId&&r&&t.scope===`server`&&(this._hasSameServerInstance(e.server,r)||this._isIdProvider(r,e.server))&&(Y(n,this._legacyFed)?(t.token=e.token,t.expires=e.expires,t.creationTime=e.creationTime,t.validity=e.validity,t.emitTokenChange()):t.refreshToken())})}destroyCredentials(){this.credentials&&this.credentials.slice().forEach(e=>{e.destroy()}),this.emit(`credentials-destroy`)}enablePostMessageAuth(e=`https://www.arcgis.com/sharing/rest`){this._postMessageAuthHandle&&this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=S(window,`message`,t=>{if((t.origin===this._appOrigin||t.origin.endsWith(`.arcgis.com`))&&t.data?.type===`arcgis:auth:requestCredential`){let n=t.source;this.getCredential(e).then(e=>{n.postMessage({type:`arcgis:auth:credential`,credential:{expires:e.expires,server:e.server,ssl:e.ssl,token:e.token,userId:e.userId}},t.origin)}).catch(e=>{n.postMessage({type:`arcgis:auth:error`,error:{name:e.name,message:e.message}},t.origin)})}})}disablePostMessageAuth(){this._postMessageAuthHandle&&=(this._postMessageAuthHandle.remove(),null)}_getOAuthLocationParams(){let e=window.location.hash;if(e){e.startsWith(`#`)&&(e=e.slice(1));let t=i(e),n=!1;if(t.access_token&&t.expires_in&&t.state&&t.hasOwnProperty(`username`))try{t.state=JSON.parse(t.state),t.state.portalUrl&&(this._oAuthLocationParams=t,n=!0)}catch{}else if(t.error&&t.error_description&&(console.log(`IdentityManager OAuth Error: `,t.error,` - `,t.error_description),t.error===`access_denied`&&(n=!0,t.state)))try{t.state=JSON.parse(t.state)}catch{}n&&(window.location.hash=t.state?.hash||``)}let t=window.location.search;if(t){t.startsWith(`?`)&&(t=t.slice(1));let e=i(t),n=!1;if(e.code&&e.state)try{e.state=JSON.parse(e.state),e.state.portalUrl&&e.state.uid&&(this._oAuthLocationParams=e,n=!0)}catch{}else if(e.error&&e.error_description&&(console.log(`IdentityManager OAuth Error: `,e.error,` - `,e.error_description),e.error===`access_denied`&&(n=!0,e.state)))try{e.state=JSON.parse(e.state)}catch{}if(n){let t={...e};[`code`,`error`,`error_description`,`message_code`,`persist`,`state`].forEach(e=>{delete t[e]});let n=C(t),r=window.location.pathname+(n?`?${n}`:``)+(e.state?.hash||``);window.history.replaceState(window.history.state,``,r)}}}_getOAuthToken(e,t,n,r,i){return e=e.replace(/^http:/i,`https:`),g(`${e}/sharing/rest/oauth2/token`,{authMode:`anonymous`,method:`post`,query:r&&i?{grant_type:`authorization_code`,code:t,redirect_uri:r,client_id:n,code_verifier:i}:{grant_type:`refresh_token`,refresh_token:t,client_id:n}}).then(e=>e.data)}async _getCodeChallenge(e){if(e&&globalThis.isSecureContext){let t=new TextEncoder().encode(e),n=await crypto.subtle.digest(`SHA-256`,t);return a(new Uint8Array(n))}return null}_pageShowHandler(e){if(e.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow){let e=new n(`identity-manager:user-aborted`,`ABORTED`);this._errbackFunc(e)}}_findCredential(e,t){let n,r,i,a,o=-1,s=t?.token,c=t?.resource,l=this._isServerRsrc(e)?`server`:`portal`,u=this.credentials.filter(t=>this._hasSameServerInstance(t.server,e)&&t.scope===l);if(e=c||e,u.length)if(u.length===1){if(n=u[0],i=this.findServerInfo(n.server),r=i?.owningSystemUrl,a=r?this.findCredential(r,n.userId):void 0,o=this._getIdenticalSvcIdx(e,n),!s)return o===-1&&n.resources.push(e),this._addResource(e,a),n;o!==-1&&(n.resources.splice(o,1),this._removeResource(e,a))}else{let t,n;if(u.some(s=>(n=this._getIdenticalSvcIdx(e,s),n!==-1&&(t=s,i=this.findServerInfo(t.server),r=i?.owningSystemUrl,a=r?this.findCredential(r,t.userId):void 0,o=n,!0))),s)t&&(t.resources.splice(o,1),this._removeResource(e,a));else if(t)return this._addResource(e,a),t}}_findOAuthInfo(e){let t=this.findOAuthInfo(e);if(!t){for(let n of this.oAuthInfos)if(this._isIdProvider(n.portalUrl,e)){t=n;break}}return t}_addResource(e,t){t&&this._getIdenticalSvcIdx(e,t)===-1&&t.resources.push(e)}_removeResource(e,t){let n=-1;t&&(n=this._getIdenticalSvcIdx(e,t),n>-1&&t.resources.splice(n,1))}_useProxy(e,t){return t?.isAdmin&&!O(e.adminTokenServiceUrl,this._appOrigin)||!this._isPortalDomain(e.tokenServiceUrl)&&String(e.currentVersion)===`10.1`&&!O(e.tokenServiceUrl,this._appOrigin)}_getOrigin(e){let t=new h(e);return t.scheme+`://`+t.host+(t.port==null?``:`:`+t.port)}_getServerInstanceRoot(e){let t=e.toLowerCase(),n=t.indexOf(this._agsRest);return n===-1&&this._isAdminResource(e)&&(n=this._agsAdmin.test(e)?e.replace(this._agsAdmin,`$1`).length:e.search(this._adminSvcs)),n!==-1||ie(t)||(n=t.indexOf(`/sharing`)),n===-1&&t.endsWith(`/`)&&(n=t.length-1),n>-1?e.slice(0,n):e}_hasSameServerInstance(t,n){return t.endsWith(`/`)&&(t=t.slice(0,-1)),t=t.toLowerCase(),n=this._getServerInstanceRoot(n).toLowerCase(),t=e(t),n=e(n),(t=t.slice(Math.max(0,t.indexOf(`:`))))===(n=n.slice(Math.max(0,n.indexOf(`:`))))}_sanitizeUrl(e){let t=(y.request.proxyUrl||``).toLowerCase(),n=t?e.toLowerCase().indexOf(t+`?`):-1;return n!==-1&&(e=e.slice(n+t.length+1)),e=ee(e),w(e).path}_isRESTService(e){return e.includes(this._agsRest)}_isAdminResource(e){return this._agsAdmin.test(e)||this._adminSvcs.test(e)}_isServerRsrc(e){return this._isRESTService(e)||this._isAdminResource(e)}_isIdenticalService(e,t){let n=!1;if(this._isRESTService(e)&&this._isRESTService(t)){let r=this._getSuffix(e).toLowerCase(),i=this._getSuffix(t).toLowerCase();if(n=r===i,!n){let e=/(.*)\/(MapServer|FeatureServer|UtilityNetworkServer).*/gi;n=r.replaceAll(e,`$1`)===i.replaceAll(e,`$1`)}}else this._isAdminResource(e)&&this._isAdminResource(t)?n=!0:this._isServerRsrc(e)||this._isServerRsrc(t)||!this._isPortalDomain(e)||(n=!0);return n}_isPortalDomain(e){let t=new h(e.toLowerCase()),n=this._portalConfig,r=this._gwDomains.some(e=>e.regex.test(t.uri));return!r&&n&&(r=this._hasSameServerInstance(this._getServerInstanceRoot(n.restBaseUrl),t.uri)),r||y.portalUrl&&(r=O(t,y.portalUrl,!0)),r||=this._portals.some(e=>this._hasSameServerInstance(e,t.uri)),r||=this._agsPortal.test(t.path),r}_isIdProvider(e,t){let n=-1,r=-1;this._gwDomains.forEach((i,a)=>{n===-1&&i.regex.test(e)&&(n=a),r===-1&&i.regex.test(t)&&(r=a)});let i=!1;if(n>-1&&r>-1&&(n===0||n===4?r!==0&&r!==4||(i=!0):n===1?r!==1&&r!==2||(i=!0):n===2?r===2&&(i=!0):n===3&&r===3&&(i=!0)),!i){let n=this.findServerInfo(t),r=n?.owningSystemUrl;r&&J(n)&&this._isPortalDomain(r)&&this._isIdProvider(e,r)&&(i=!0)}return i}_getIdenticalSvcIdx(e,t){let n=-1;for(let r=0;r<t.resources.length;r++){let i=t.resources[r];if(this._isIdenticalService(e,i)){n=r;break}}return n}_getSuffix(e){return e.replace(this._regexSDirUrl,``).replace(this._regexServerType,`$1`)}_getTokenSvcUrl(e){let t,n,r;if(this._isRESTService(e)||this._isAdminResource(e)){let r=this._getServerInstanceRoot(e);return t=r+`/admin/generateToken`,n=g(e=r+`/rest/info`,{query:{f:`json`}}).then(e=>e.data),{adminUrl:t,promise:n}}if(this._isPortalDomain(e)){let t=``;if(this._gwDomains.some(n=>(n.regex.test(e)&&(t=n.tokenServiceUrl),!!t)),t||this._portals.some(n=>(this._hasSameServerInstance(n,e)&&(t=n+this._gwTokenUrl),!!t)),t||(r=e.toLowerCase().indexOf(`/sharing`),r!==-1&&(t=e.slice(0,r)+this._gwTokenUrl)),t||=this._getOrigin(e)+this._gwTokenUrl,t){let n=new h(e).port;/^http:\/\//i.test(e)&&n===`7080`&&(t=t.replace(/:7080/i,`:7443`)),t=t.replace(/http:/i,`https:`)}return t}}_processOAuthResponseParams(e,t,n){let r=t._oAuthCred;if(e.code){let i=r.codeVerifier;return r.codeVerifier=null,r.stateUID=null,r.save(),this._getOAuthToken(n.server,e.code,t.appId,this._getRedirectURI(t,!0),i).then(i=>{let a=new P({userId:i.username,server:n.server??void 0,token:i.access_token,expires:Date.now()+1e3*i.expires_in,ssl:i.ssl,oAuthState:e.state,_oAuthCred:r});return t.userId=a.userId,r.storage=i.persist?X:Z,r.refreshToken=i.refresh_token,r.token=null,r.expires=i.refresh_token_expires_in?Date.now()+1e3*i.refresh_token_expires_in:null,r.userId=a.userId,r.ssl=a.ssl,r.save(),a})}let i=new P({userId:e.username,server:n.server??void 0,token:e.access_token,expires:Date.now()+1e3*Number(e.expires_in),ssl:e.ssl===`true`,oAuthState:e.state,_oAuthCred:r});return t.userId=i.userId,r.storage=e.persist?X:Z,r.refreshToken=null,r.token=i.token,r.expires=i.expires,r.userId=i.userId,r.ssl=i.ssl,r.save(),Promise.resolve(i)}_processOAuthPopupParams(e){let t=this._oAuthDfd;if(this._oAuthDfd=null,t)if(clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle?.remove(),e.error){let r=e.error===`access_denied`,i=new n(r?`identity-manager:user-aborted`:`identity-manager:authentication-failed`,r?`ABORTED`:`OAuth: `+e.error+` - `+e.error_description);t.reject(i)}else this._processOAuthResponseParams(e,t.oinfo_,t.sinfo_).then(e=>{t.resolve(e)}).catch(e=>{t.reject(e)})}_setOAuthResponseQueryString(e){e&&(e.startsWith(`?`)&&(e=e.slice(1)),this._processOAuthPopupParams(i(e)))}async _exchangeToken(e,t,n){return(await g(`${e}/sharing/rest/oauth2/exchangeToken`,{authMode:`anonymous`,method:`post`,query:{f:`json`,client_id:t,token:n}})).data.token}async _getPlatformSelf(e,t){if(this._getPlatformSelfError&&Date.now()-this._getPlatformSelfError[1]<1e3)throw this._getPlatformSelfError[0];e=e.replace(/^http:/i,`https:`);try{let n=await g(`${e}/sharing/rest/oauth2/platformSelf`,{authMode:`anonymous`,headers:{"X-Esri-Auth-Client-Id":t,"X-Esri-Auth-Redirect-Uri":window.location.href.replace(/#.*$/,``)},method:`post`,query:{f:`json`,expiration:30},withCredentials:!0});return this._getPlatformSelfError=null,n.data}catch(e){throw e.details?.messageCode===`OAUTH_0066`&&(this._getPlatformSelfError=[e,Date.now()]),e}}_getPortalSelf(e,t){let n;return this._gwDomains.some(t=>(t.regex.test(e)&&(n=t.customBaseUrl),!!n)),n?Promise.resolve({allSSL:!0,currentVersion:`8.4`,customBaseUrl:n,portalMode:`multitenant`,supportsOAuth:!0}):(this._appOrigin.startsWith(`https:`)?e=e.replace(/^http:/i,`https:`).replace(/:7080/i,`:7443`):/^http:/i.test(t)&&(e=e.replace(/^https:/i,`http:`).replace(/:7443/i,`:7080`)),g(e,{query:{f:`json`},authMode:`anonymous`,withCredentials:!0}).then(e=>e.data))}_doPortalSignIn(e){let t=this._portalConfig,n=window.location.href,r=this.findServerInfo(e);return!(!t&&!this._isPortalDomain(n)||!(r?r.hasPortal||r.owningSystemUrl&&this._isPortalDomain(r.owningSystemUrl):this._isPortalDomain(e))||!(this._isIdProvider(n,e)||t&&(this._hasSameServerInstance(this._getServerInstanceRoot(t.restBaseUrl),e)||this._isIdProvider(t.restBaseUrl,e))||O(n,e,!0)))}_checkProtocol(e,t,r,i){let a=!0,o=i?t.adminTokenServiceUrl:t.tokenServiceUrl;return o.trim().toLowerCase().startsWith(`https:`)&&!this._appOrigin.startsWith(`https:`)&&te(o)&&(a=!!this._protocolFunc&&!!this._protocolFunc({resourceUrl:e,serverInfo:t}),!a)&&r(new n(`identity-manager:aborted`,`Aborted the Sign-In process to avoid sending password over insecure connection.`)),a}_enqueue(e,t,n,r,i,a){return r||=p(),r.resUrl_=e,r.sinfo_=t,r.options_=n,r.admin_=i,r.refresh_=a,this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(e),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(r)):this._xoReqs.push(r):this._doSignIn(r),r.promise}_doSignIn(e){this._busy=e,this._rejectOnPersistedPageShow=!1;let t=t=>{let n=e.options_?.resource,r=e.resUrl_,i=e.refresh_,a=!1;this.credentials.includes(t)||(i&&this.credentials.includes(i)?(i.userId=t.userId,i.token=t.token,i.expires=t.expires,i.validity=t.validity,i.ssl=t.ssl,i.creationTime=t.creationTime,a=!0,t=i):this.credentials.push(t)),t.resources||=[],t.resources.includes(n||r)||t.resources.push(n||r),t.scope=this._isServerRsrc(r)?`server`:`portal`,t.emitTokenChange();let o=this._soReqs,s={};this._soReqs=[],o.forEach(e=>{if(!this._isIdenticalService(r,e.resUrl_)){let n=this._getSuffix(e.resUrl_);s[n]||(s[n]=!0,t.resources.push(e.resUrl_))}}),e.resolve(t),o.forEach(e=>{this._hasSameServerInstance(this._getServerInstanceRoot(r),e.resUrl_)?e.resolve(t):this._soReqs.push(e)}),this._busy=e.resUrl_=e.sinfo_=e.refresh_=null,a||this.emit(`credential-create`,{credential:t}),this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},r=t=>{e.reject(t),this._busy=e.resUrl_=e.sinfo_=e.refresh_=null,this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},i=(a,o,s,c)=>{let l=e.sinfo_,u=!e.options_||!1!==e.options_.prompt,d=l.hasPortal&&this._findOAuthInfo(e.resUrl_),f,p;if(a)t(new P({userId:a,server:l.server??void 0,token:s??void 0,expires:c==null?null:Number(c),ssl:!!o}));else if(window!==window.parent&&this._appUrlObj.query?.[`arcgis-auth-origin`]&&this._appUrlObj.query?.[`arcgis-auth-portal`]&&this._hasSameServerInstance(this._getServerInstanceRoot(this._appUrlObj.query[`arcgis-auth-portal`]),e.resUrl_)){window.parent.postMessage({type:`arcgis:auth:requestCredential`},this._appUrlObj.query[`arcgis-auth-origin`]);let i=S(window,`message`,e=>{e.source===window.parent&&e.data&&(e.data.type===`arcgis:auth:credential`?(i.remove(),e.data.credential.expires<Date.now()?r(new n(`identity-manager:credential-request-failed`,`Parent application's token has expired.`)):t(new P(e.data.credential))):e.data.type===`arcgis:auth:error`&&(i.remove(),e.data.error.name===`tokenExpiredError`?r(new n(`identity-manager:credential-request-failed`,`Parent application's token has expired.`)):r(n.fromJSON(e.data.error))))});D(e.options_?.signal,()=>{i.remove()})}else if(d){let a=d._oAuthCred;if(!a){let e=new V(d,X),t=new V(d,Z);e.isValid()&&t.isValid()?e.expires>t.expires?(a=e,t.destroy()):(a=t,e.destroy()):a=e.isValid()?e:t,d._oAuthCred=a}if(a.isValid()){f=new P({userId:a.userId??void 0,server:l.server??void 0,token:a.token??void 0,expires:a.expires,ssl:a.ssl??void 0,_oAuthCred:a});let n=d.appId!==a.appId&&this._doPortalSignIn(e.resUrl_);n||a.refreshToken?(e._pendingDfd=a.refreshToken?this._getOAuthToken(l.server,a.refreshToken,a.appId).then(e=>(f.expires=Date.now()+1e3*e.expires_in,f.token=e.access_token,f)):Promise.resolve(f),e._pendingDfd.then(e=>n?this._exchangeToken(e.server,d.appId,e.token).then(t=>(e.token=t,e)).catch(()=>e):e).then(e=>{t(e)}).catch(e=>{let t=e.details?.httpStatus;t>0&&t!==404?(a.destroy(),i()):r(e)})):t(f)}else if(this._oAuthLocationParams&&this._hasSameServerInstance(d.portalUrl,this._oAuthLocationParams.state.portalUrl)&&(this._oAuthLocationParams.access_token||this._oAuthLocationParams.code&&this._oAuthLocationParams.state.uid===a.stateUID&&a.codeVerifier)){let n=this._oAuthLocationParams;this._oAuthLocationParams=null,e._pendingDfd=this._processOAuthResponseParams(n,d,l).then(e=>{t(e)}).catch(r)}else{let i=()=>{u?e._pendingDfd=this.oAuthSignIn(e.resUrl_,l,d,e.options_).then(t,r):(p=new n(`identity-manager:not-authenticated`,`User is not signed in.`),r(p))};this._doPortalSignIn(e.resUrl_)?e._pendingDfd=this._getPlatformSelf(l.server,d.appId).then(e=>{O(e.portalUrl,this._appOrigin,!0)?(f=new P({userId:e.username,server:l.server??void 0,expires:Date.now()+1e3*e.expires_in,token:e.token}),t(f)):i()}).catch(i):i()}}else if(u){if(this._checkProtocol(e.resUrl_,l,r,e.admin_)){let n=e.options_;e.admin_&&(n||={},n.isAdmin=!0),e._pendingDfd=this.signIn(e.resUrl_,l,n).then(t,r)}}else p=new n(`identity-manager:not-authenticated`,`User is not signed in.`),r(p)},a=()=>{let n=e.sinfo_,i=n.owningSystemUrl,a=e.options_,o,s,c,l;if(a&&(o=a.token,s=a.error,c=a.prompt),l=this._findCredential(i,{token:o,resource:e.resUrl_}),!l){for(let e of this.credentials)if(this._isIdProvider(i,e.server)){l=e;break}}if(l){let i=this.findCredential(e.resUrl_,l.userId);if(i)t(i);else if(Y(n,this._legacyFed)){let e=l.toJSON();e.server=n.server,e.resources=null,t(new P(e))}else (e._pendingDfd=this.generateToken(this.findServerInfo(l.server),null,{serverUrl:e.resUrl_,token:l.token,signal:e.options_.signal,ssl:l.ssl})).then(r=>{t(new P({userId:l?.userId,server:n.server??void 0,token:r.token,expires:r.expires==null?null:Number(r.expires),ssl:!!r.ssl,isAdmin:e.admin_,validity:r.validity}))},r)}else this._busy=null,o&&(e.options_.token=null),(e._pendingDfd=this.getCredential(i.replace(/\/?$/,`/sharing`),{resource:e.resUrl_,owningTenant:n.owningTenant,signal:e.options_.signal,token:o,error:s,prompt:c})).then(()=>{this._enqueue(e.resUrl_,e.sinfo_,e.options_,e,e.admin_)},t=>{e.resUrl_=e.sinfo_=e.refresh_=null,e.reject(t)})};this._errbackFunc=r;let o=e.sinfo_.owningSystemUrl,s=this._isServerRsrc(e.resUrl_),c=e.sinfo_._restInfoPms;c?c.promise.then(t=>{let n=e.sinfo_;if(n._restInfoPms){n.adminTokenServiceUrl=n._restInfoPms.adminUrl,n._restInfoPms=null,n.tokenServiceUrl=(j(`authInfo.tokenServicesUrl`,t)||j(`authInfo.tokenServiceUrl`,t)||j(`tokenServiceUrl`,t))??null,n.shortLivedTokenValidity=j(`authInfo.shortLivedTokenValidity`,t)??null,n.currentVersion=t.currentVersion,n.owningTenant=t.owningTenant;let e=n.owningSystemUrl=t.owningSystemUrl;e&&this._portals.push(e)}s&&n.owningSystemUrl?a():i()},()=>{e.sinfo_._restInfoPms=null;let t=new n(`identity-manager:server-identification-failed`,`Unknown resource - could not find token service endpoint.`);r(t)}):s&&o?a():e.sinfo_._selfReq?e.sinfo_._selfReq.selfDfd.then(t=>{let n={},r,i,a,o;return t&&(r=t.user?.username,n.username=r,n.allSSL=t.allSSL,i=t.supportsOAuth,o=parseFloat(t.currentVersion),t.portalMode===`multitenant`&&(a=t.customBaseUrl),e.sinfo_.currentVersion=o),e.sinfo_.webTierAuth=!!r,r&&this.normalizeWebTierAuth?this.generateToken(e.sinfo_,null,{ssl:n.allSSL}).catch(()=>null).then(e=>(n.portalToken=e?.token,n.tokenExpiration=e?.expires,n)):!r&&i&&o>=4.4&&!this._findOAuthInfo(e.resUrl_)?this._generateOAuthInfo({portalUrl:e.sinfo_.server,customBaseUrl:a,owningTenant:e.sinfo_._selfReq.owningTenant}).catch(()=>null).then(()=>n):n}).catch(()=>null).then(t=>{e.sinfo_._selfReq=null,t?i(t.username,t.allSSL,t.portalToken,t.tokenExpiration):i()}):i()}_generateOAuthInfo(e){let t,n=null,r=e.portalUrl,i=e.customBaseUrl,a=e.owningTenant,o=!this._defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal;if(o){n=this._appUrlObj.path;let e=n.search(/\/(apps|home)\//);n=e>-1?n.slice(0,e):null}return o&&n?(this._hasTestedIfAppIsOnPortal=!0,t=g(n+`/sharing/rest`,{query:{f:`json`}}).then(()=>{this._defaultOAuthInfo=new W({appId:`arcgisonline`,popupCallbackUrl:n+`/home/oauth-callback.html`})})):t=Promise.resolve(),t.then(()=>{if(this._defaultOAuthInfo)return r=r.replace(/^http:/i,`https:`),g(r+`/sharing/rest/oauth2/validateRedirectUri`,{query:{accountId:a,client_id:this._defaultOAuthInfo.appId,redirect_uri:s(this._defaultOAuthInfo.popupCallbackUrl),f:`json`}}).then(e=>{if(e.data.valid){let t=this._defaultOAuthInfo.clone();e.data.urlKey&&i?t.portalUrl=`https://`+e.data.urlKey.toLowerCase()+`.`+i:t.portalUrl=r,t.popup=window!==window.top||!(O(r,this._appOrigin)||this._gwDomains.some(e=>e.regex.test(r)&&e.regex.test(this._appOrigin))),this.oAuthInfos.push(t)}})})}_doOAuthSignIn(e,t,r,i){let a=r._oAuthCred,o={portalUrl:r.portalUrl};!r.popup&&r.preserveUrlHash&&window.location.hash&&(o.hash=window.location.hash),a.stateUID&&(o.uid=a.stateUID);let s={client_id:r.appId,response_type:a.codeVerifier?`code`:`token`,state:JSON.stringify(o),expiration:r.expiration,locale:r.locale,redirect_uri:this._getRedirectURI(r,!!a.codeVerifier)};r.forceLogin&&(s.force_login=!0),r.forceUserId&&r.userId&&(s.prepopulatedusername=r.userId),!r.popup&&this._doPortalSignIn(e)&&(s.redirectToUserOrgUrl=!0),a.codeVerifier&&(s.code_challenge=i||a.codeVerifier,s.code_challenge_method=i?`S256`:`plain`);let c=r.portalUrl.replace(/^http:/i,`https:`)+`/sharing/oauth2/authorize`,l=c+`?`+C(s);if(r.popup){let e=window.open(l,`esriJSAPIOAuth`,r.popupWindowFeatures);if(e)e.focus(),this._oAuthDfd.oAuthWin_=e,this._oAuthIntervalId=setInterval(()=>{if(e.closed){clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle.remove();let e=this._oAuthDfd;if(e){let t=new n(`identity-manager:user-aborted`,`ABORTED`);e.reject(t)}}},500),this._oAuthOnPopupHandle=S(window,[`arcgis:auth:hash`,`arcgis:auth:location:search`],e=>{e.type===`arcgis:auth:hash`?this.setOAuthResponseHash(e.detail):this._setOAuthResponseQueryString(e.detail)});else{let e=new n(`identity-manager:popup-blocked`,`ABORTED`);this._oAuthDfd.reject(e)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:s,authorizeUrl:c,resourceUrl:e,serverInfo:t,oAuthInfo:r}):window.location.href=l}_getRedirectURI(e,t){let n=window.location.href.replace(/#.*$/,``);if(e.popup)return s(e.popupCallbackUrl);if(t){let e=w(n);return e.query&&[`code`,`error`,`error_description`,`message_code`,`persist`,`state`].forEach(t=>{delete e.query[t]}),re(e.path,e.query)}return n}};Q.prototype.declaredClass=`esri.identity.IdentityManagerBase`;var $=new Q;ne($);export{$ as default};