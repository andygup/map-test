import{AS as e,BT as t,CE as n,VT as r,Zl as i,dl as a,kD as o,ll as s,oT as c,ol as l,sl as u}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import"./earcut-CEMcWA4Z.js";import"./layerViewUtils-CJcMVuwG.js";import"./VertexAttributeLocations-BScEla0R.js";import"./VertexElementDescriptor-Cl_nC_ty.js";import"./BoundingBox-Dtf81F-g.js";import"./config-Dk3C6lVr.js";import"./WGLContainer-jm6ZclzQ.js";import"./utils-B0heZPZY.js";import"./ProgramTemplate-B9k_04Md.js";import"./VertexArrayObject-ChtD6bwg.js";import"./BufferObject-B3_aJU6V.js";import"./VertexBuffer-Ra4pb4dR.js";import"./vec3f32-DDMWoxUL.js";import"./Container-uEjPEzbR.js";import"./GraphShaderModule-AgkKIWM0.js";import"./FramebufferObject-BoYk_2uK.js";import"./ShaderBuilder-BLOqjpgt.js";import"./bitmapUtils-53gkfkJ0.js";import"./Bitmap-BoQaGe8r.js";import{t as d}from"./LayerView2D-Bgb1zyoa.js";import{t as f}from"./LayerView-DQaVI2FN.js";import{t as p}from"./RefreshableLayerView-DdPullJP.js";import"./TileContainer-BL1bFhTv.js";import{r as m,t as h}from"./imageUtils-t8860LTw.js";var g=[0,0],_=class extends p(m(d(f))){constructor(){super(...arguments),this._tileStrategy=null,this._fetchQueue=null,this.layer=null}get tileMatrixSet(){let{activeLayer:t}=this.layer,{tileMatrixSet:n}=t;if(n&&e(n.tileInfo?.spatialReference,this.view.spatialReference))return n;let r=this._getTileMatrixSetBySpatialReference(t);return r&&r.id!==t.tileMatrixSetId?(t.tileMatrixSetId=r.id,r):null}update(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume()}attach(){let e=this.tileMatrixSet?.tileInfo;e&&(this._tileInfoView=new s(e),this._fetchQueue=new u({tileInfoView:this._tileInfoView,concurrency:16,process:(e,t)=>this.fetchTile(e,t),scheduler:this.scheduler,priority:i.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new l({cachePolicy:`keep`,resampling:!0,acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView}),this.addAttachHandles(this._updatingHandles.add(()=>[this.layer?.activeLayer?.styleId,this.tileMatrixSet],()=>this.doRefresh())),super.attach())}detach(){super.detach(),this._tileStrategy?.destroy(),this._fetchQueue?.destroy(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(t){return this.layer.activeLayer.tileMatrixSets?.some(n=>e(n.tileInfo?.spatialReference,t))??!1}async doRefresh(){if(this.attached){if(this.suspended)return this._tileStrategy.clear(),void this.requestUpdate();this._fetchQueue.reset(),this._tileStrategy.refresh(e=>this._updatingHandles.addPromise(this._enqueueTileFetch(e)))}}acquireTile(e){let t=this._bitmapView.createTile(e),n=t.bitmap;return[n.x,n.y]=this._tileInfoView.getTileCoords(g,t.key),n.resolution=this._tileInfoView.getTileResolution(t.key),[n.width,n.height]=this._tileInfoView.tileInfo.size,this._updatingHandles.addPromise(this._enqueueTileFetch(t)),this._bitmapView.addChild(t),this.requestUpdate(),t}releaseTile(e){this._fetchQueue.abort(e.key.id),this._bitmapView.removeChild(e),e.once(`detach`,()=>e.destroy()),this.requestUpdate()}async fetchTile(e,t={}){let n=`tilemapCache`in this.layer?this.layer.tilemapCache:null,{signal:r,resamplingLevel:i=0}=t;if(!n)return this._fetchImage(e,r);let o=new a(0,0,0,0),s;try{await n.fetchAvailabilityUpsample(e.level,e.row,e.col,o,{signal:r}),s=await this._fetchImage(o,r)}catch(n){if(c(n))throw n;if(i<3){let n=this._tileInfoView.getTileParentId(e.id);if(n){let r=new a(n),o=await this.fetchTile(r,{...t,resamplingLevel:i+1});return h(this._tileInfoView,o,r,e)}}throw n}return h(this._tileInfoView,s,o,e)}canResume(){return super.canResume()&&this.tileMatrixSet!==null}async _enqueueTileFetch(e){if(!this._fetchQueue.has(e.key.id)){try{let t=await this._fetchQueue.push(e.key);e.bitmap.source=t,e.bitmap.width=this._tileInfoView.tileInfo.size[0],e.bitmap.height=this._tileInfoView.tileInfo.size[1],e.once(`attach`,()=>this.requestUpdate())}catch(e){c(e)||n.getLogger(this).error(e)}this.requestUpdate()}}async _fetchImage(e,t){return this.layer.fetchImageBitmapTile(e.level,e.row,e.col,{signal:t})}_getTileMatrixSetBySpatialReference(t){return t.tileMatrixSets?.find(t=>e(t.tileInfo?.spatialReference,this.view.spatialReference))}};o([t({readOnly:!0})],_.prototype,`tileMatrixSet`,null),_=o([r(`esri.views.2d.layers.WMTSLayerView2D`)],_);var v=_;export{v as default};