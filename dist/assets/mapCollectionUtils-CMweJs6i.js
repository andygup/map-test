import{Sg as e,aE as t,aT as n,gT as r,hv as i,lv as a,mT as o,nE as s}from"./index-BN8X5Ryz.js";function c(e,t,n){let r=n?.createCollection?.()??new i,o=n?.recycleItems?new l:null,s=(e,t=0)=>{if(!e?.length)return;let n=r.splice(t,e.length);o?o.processRemoved(e):n.forEach(d)},c=(e,n=0)=>{if(!e?.length)return;let i=[];for(let n of e){let e=o?.use(n);if(e)i.push(e);else{let e=t(n);o?.register(n,e),i.push(e)}}r.addMany(i,n)},u=a(e,`after-splice`,({added:e,start:t,removed:n})=>{s(n,t),c(e,t)},{sync:!0,onListenerRemove:e=>s(e.items),onListenerAdd:e=>c(e.items)});return r.addHandles(u),r}var l=class{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(e){if(!e?.length)return;let{_removedItemCandidates:t}=this;for(let n of e)this._getItem(n)?.markRemoved()&&(t.add(n),this._queueGarbageCollection())}use(e){let t=this._getItem(e);return t&&(t.removed=!1),t?.item}register(e,t){this._originalToMapped.set(e,new u(t))}_getItem(e){return this._originalToMapped.get(e)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask(()=>this._garbageCollectCandidates()))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;let{_removedItemCandidates:e}=this,t=Array.from(e);e.clear(),t.forEach(e=>this._garbageCollectIfRemoved(e))}_garbageCollectIfRemoved(e){let{_originalToMapped:t}=this,n=this._getItem(e);n?.removed&&(d(n.item),t.delete(e))}},u=class{constructor(e){this.item=e,this.removed=!1}markRemoved(){return this.removed=!0,!0}};function d(e){typeof e==`object`&&e&&(`destroy`in e&&typeof e.destroy==`function`?e.destroy():t(e))}function f(t,a,l){let u=new i,f=c(t,t=>e(async e=>{let r=await a(t,e);if(n(e))throw d(r),o();return r}),l),p=()=>null,m=async e=>{let t=await e.promise,n=f.indexOf(e);n<0||u.splice(n,1,t)};u.addMany(f.items.map(p));for(let e of f)r(m(e));let h=f.on(`after-splice`,({added:e,start:t,deleteCount:n})=>{let i=u.splice(t,n);for(let e of i)d(e);if(e?.length){u.addMany(e.map(p),t);for(let t of e)r(m(t))}});return u.addHandles([s(f),h]),u}export{f as n,c as t};