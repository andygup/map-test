import{A as e,AT as t,BT as n,DT as r,Dd as i,Dg as a,Dh as o,Ed as s,Fg as c,Ha as l,Hb as u,L as d,LT as f,M as p,OT as m,Od as h,Og as g,SE as _,Sg as v,Ub as y,Vb as b,Xb as x,_S as S,ax as C,ba as w,du as T,ex as E,g as D,gD as O,iv as k,jT as A,jd as j,ua as M,ud as N,vE as P,vd as F,wg as I,wx as L,xa as R}from"./index-CzMixifc.js";import{t as z}from"./GraphicsLayer-CSZ-X1QF.js";import{t as B}from"./objectIdUtils-CDGh-k0K.js";var V=Symbol(`isMapNotesGraphicOriginSymbol`),H,U=class extends w{get[(H=V,R)](){return this.layer}constructor(e,t){super(),this[H]=!0,this.type=`map-notes`,this.layer=e,this.sublayer=t}get id(){return`${this.layer.id}:__${this.sublayer.id}__`}};function W(e){return e.featureCollectionType===`markup`||e.layers.some(e=>e.layerDefinition.visibilityField!=null||!G(e))}function G({layerDefinition:e,featureSet:t}){let n=e.geometryType??t.geometryType;return Y.find(t=>n===t.geometryTypeJSON&&e.drawingInfo?.renderer?.symbol?.type===t.identifyingSymbol.type)}function K(){return new C({xmin:-180,ymin:-90,xmax:180,ymax:90})}var q=new N({name:`OBJECTID`,alias:`OBJECTID`,type:`oid`,nullable:!1,editable:!1}),J=new N({name:`title`,alias:`Title`,type:`string`,nullable:!0,editable:!0,length:255}),Y=[{geometryType:`polygon`,geometryTypeJSON:`esriGeometryPolygon`,id:`polygonLayer`,layerId:0,title:`Polygons`,identifyingSymbol:new h().toJSON()},{geometryType:`polyline`,geometryTypeJSON:`esriGeometryPolyline`,id:`polylineLayer`,layerId:1,title:`Polylines`,identifyingSymbol:new j().toJSON()},{geometryType:`multipoint`,geometryTypeJSON:`esriGeometryMultipoint`,id:`multipointLayer`,layerId:2,title:`Multipoints`,identifyingSymbol:new i().toJSON()},{geometryType:`point`,geometryTypeJSON:`esriGeometryPoint`,id:`pointLayer`,layerId:3,title:`Points`,identifyingSymbol:new i().toJSON()},{geometryType:`point`,geometryTypeJSON:`esriGeometryPoint`,id:`textLayer`,layerId:4,title:`Text`,identifyingSymbol:new s().toJSON()}],X=class extends M(e(d(p(l(o))))){constructor(e){super(e),this.capabilities={operations:{supportsMapNotesEditing:!0}},this.featureCollections=null,this.featureCollectionJSON=null,this.featureCollectionType=`notes`,this.legendEnabled=!1,this.listMode=`hide-children`,this.minScale=0,this.maxScale=0,this.spatialReference=L.WGS84,this.sublayers=new k(Y.map(e=>new Z({id:e.id,layerId:e.layerId,title:e.title,layer:this}))),this.title=`Map Notes`,this.type=`map-notes`,this.visibilityMode=`inherited`}readCapabilities(e,t,n){return{operations:{supportsMapNotesEditing:!W(t)&&n?.origin!==`portal-item`}}}readFeatureCollections(e,t,n){if(!W(t))return null;let r=t.layers.map(e=>{let t=new D;return t.read(e,n),t});return new k({items:r})}readLegacyfeatureCollectionJSON(e,t){return W(t)?_(t.featureCollection):null}get fullExtent(){let e=this.spatialReference,t=b();return this.sublayers==null?this.featureCollectionJSON?.layers.some(e=>e.layerDefinition.extent)&&this.featureCollectionJSON.layers.forEach(n=>{let r=v(n.layerDefinition.extent,e).geometry;r!=null&&E(t,r,t)}):this.sublayers.forEach(({fullBounds:e})=>e==null?t:E(t,e,t),t),u(t,y)?v(K(),e).geometry:x(t,e)}readMinScale(e,t){for(let e of t.layers)if(e.layerDefinition.minScale!=null)return e.layerDefinition.minScale;return 0}readMaxScale(e,t){for(let e of t.layers)if(e.layerDefinition.maxScale!=null)return e.layerDefinition.maxScale;return 0}get multipointLayer(){return this._findSublayer(`multipointLayer`)}get pointLayer(){return this._findSublayer(`pointLayer`)}get polygonLayer(){return this._findSublayer(`polygonLayer`)}get polylineLayer(){return this._findSublayer(`polylineLayer`)}readSpatialReference(e,t){return t.layers.length?L.fromJSON(t.layers[0].layerDefinition.spatialReference):L.WGS84}readSublayers(e,t,n){if(W(t))return null;let r=[],i=t.layers.reduce((e,t)=>Math.max(e,t.layerDefinition.id??-1),-1)+1;for(let e of t.layers){let{layerDefinition:t,featureSet:n}=e,a=t.id??i++,o=G(e);if(o!=null){let e=new Z({id:o.id,title:t.name,layerId:a,layer:this,graphics:n.features.map(({geometry:e,symbol:t,attributes:n,popupInfo:r})=>F.fromJSON({attributes:n,geometry:e,symbol:t,popupTemplate:r}))});r.push(e)}}return new k(r)}writeSublayers(e,t,r,i){let{minScale:a,maxScale:o}=this;if(e==null)return;let s=e.some(e=>e.graphics.length>0);if(!this.capabilities.operations.supportsMapNotesEditing)return void(s&&i?.messages?.push(new n(`map-notes-layer:editing-not-supported`,`New map notes cannot be added to this layer`)));let c=[],l=this.spatialReference.toJSON();e:for(let t of e)for(let e of t.graphics)if(e.geometry!=null){l=e.geometry.spatialReference.toJSON();break e}for(let t of Y){let n=e.find(e=>t.id===e.id);this._writeMapNoteSublayer(c,n,t,a,o,l,i)}P(`featureCollection.layers`,c,t)}get textLayer(){return this._findSublayer(`textLayer`)}load(e){return this.addResolvingPromise(this.loadFromPortal({supportedTypes:[`Feature Collection`]},e)),Promise.resolve(this)}read(e,t){`featureCollection`in e&&(e=_(e),Object.assign(e,e.featureCollection)),super.read(e,t)}async beforeSave(){if(this.sublayers==null)return;let e=null,t=[];for(let n of this.sublayers)for(let r of n.graphics)if(r.geometry!=null){let n=r.geometry;e?S(n.spatialReference,e)||(g(n.spatialReference,e)||a()||await I(),r.geometry=c(n,e)):e=n.spatialReference,t.push(r)}let n=await T(t.map(e=>e.geometry));t.forEach((e,t)=>e.geometry=n[t])}_findSublayer(e){return this.sublayers==null?null:this.sublayers?.find(t=>t.id===e)??null}_writeMapNoteSublayer(e,t,n,r,i,a,o){let s=[];if(t!=null){for(let e of t.graphics)this._writeMapNote(s,e,n.geometryType,o);this._normalizeObjectIds(s,q),e.push({layerDefinition:{name:t.title,drawingInfo:{renderer:{type:`simple`,symbol:_(n.identifyingSymbol)}},id:t.layerId,geometryType:n.geometryTypeJSON,minScale:r,maxScale:i,objectIdField:`OBJECTID`,fields:[q.toJSON(),J.toJSON()],spatialReference:a},featureSet:{features:s,geometryType:n.geometryTypeJSON}})}}_writeMapNote(e,t,n,r){if(t==null)return;let{geometry:i,symbol:a,popupTemplate:o}=t;if(i==null)return;if(i.type!==n)return void r?.messages?.push(new f(`map-notes-layer:invalid-geometry-type`,`Geometry "${i.type}" cannot be saved in "${n}" layer`,{graphic:t}));if(a==null)return void r?.messages?.push(new f(`map-notes-layer:no-symbol`,`Skipping map notes with no symbol`,{graphic:t}));let s={attributes:{...t.attributes},geometry:i.toJSON(),symbol:a.toJSON()};o!=null&&(s.popupInfo=o.toJSON()),e.push(s)}_normalizeObjectIds(e,t){let n=t.name,r=B(n,e)+1,i=new Set;for(let t of e){t.attributes||={};let{attributes:e}=t;(e[n]==null||i.has(e[n]))&&(e[n]=r++),i.add(e[n])}}};O([r({readOnly:!0})],X.prototype,`capabilities`,void 0),O([A([`portal-item`,`web-map`],`capabilities`,[`layers`])],X.prototype,`readCapabilities`,null),O([r({readOnly:!0})],X.prototype,`featureCollections`,void 0),O([A([`web-map`,`portal-item`],`featureCollections`,[`layers`])],X.prototype,`readFeatureCollections`,null),O([r({readOnly:!0,json:{origins:{"web-map":{write:{enabled:!0,target:`featureCollection`}}}}})],X.prototype,`featureCollectionJSON`,void 0),O([A([`web-map`,`portal-item`],`featureCollectionJSON`,[`featureCollection`])],X.prototype,`readLegacyfeatureCollectionJSON`,null),O([r({readOnly:!0,json:{read:!0,write:{enabled:!0,ignoreOrigin:!0}}})],X.prototype,`featureCollectionType`,void 0),O([r({readOnly:!0})],X.prototype,`fullExtent`,null),O([r({readOnly:!0,json:{origins:{"web-map":{write:{target:`featureCollection.showLegend`,overridePolicy(){return{enabled:this.featureCollectionJSON!=null}}}}}}})],X.prototype,`legendEnabled`,void 0),O([r({type:[`show`,`hide`,`hide-children`]})],X.prototype,`listMode`,void 0),O([r({type:Number,nonNullable:!0,json:{write:!1}})],X.prototype,`minScale`,void 0),O([A([`web-map`,`portal-item`],`minScale`,[`layers`])],X.prototype,`readMinScale`,null),O([r({type:Number,nonNullable:!0,json:{write:!1}})],X.prototype,`maxScale`,void 0),O([A([`web-map`,`portal-item`],`maxScale`,[`layers`])],X.prototype,`readMaxScale`,null),O([r({readOnly:!0})],X.prototype,`multipointLayer`,null),O([r({value:`ArcGISFeatureLayer`,type:[`ArcGISFeatureLayer`]})],X.prototype,`operationalLayerType`,void 0),O([r({readOnly:!0})],X.prototype,`pointLayer`,null),O([r({readOnly:!0})],X.prototype,`polygonLayer`,null),O([r({readOnly:!0})],X.prototype,`polylineLayer`,null),O([r({type:L})],X.prototype,`spatialReference`,void 0),O([A([`web-map`,`portal-item`],`spatialReference`,[`layers`])],X.prototype,`readSpatialReference`,null),O([r({readOnly:!0,json:{origins:{"web-map":{write:{ignoreOrigin:!0}}}}})],X.prototype,`sublayers`,void 0),O([A(`web-map`,`sublayers`,[`layers`])],X.prototype,`readSublayers`,null),O([t(`web-map`,`sublayers`)],X.prototype,`writeSublayers`,null),O([r({readOnly:!0})],X.prototype,`textLayer`,null),O([r()],X.prototype,`title`,void 0),O([r({readOnly:!0,json:{read:!1}})],X.prototype,`type`,void 0),X=O([m(`esri.layers.MapNotesLayer`)],X);var Z=class extends z{constructor(e){super(e),this.visibilityMode=`inherited`}initialize(){for(let e of this.graphics)e.sourceLayer=this.layer;this.graphics.on(`after-add`,e=>{e.item.sourceLayer=this.layer,e.item.origin=this.graphicOrigin}),this.graphics.on(`after-remove`,e=>{e.item.sourceLayer=null,e.item.origin=null})}get fullExtent(){let e=this.layer?.spatialReference,t=this.fullBounds;return e?t==null?v(K(),e).geometry:x(t,e):null}get fullBounds(){let e=this.layer?.spatialReference;if(!e)return null;let t=b();return this.graphics.forEach(n=>{let r=n.geometry==null?null:v(n.geometry,e).geometry;r!=null&&E(t,r.type===`point`?r:r.extent,t)}),u(t,y)?null:t}get graphicOrigin(){return new U(this.layer,this)}get sublayers(){return this.graphics}};O([r({readOnly:!0})],Z.prototype,`fullExtent`,null),O([r({readOnly:!0})],Z.prototype,`fullBounds`,null),O([r({readOnly:!0})],Z.prototype,`graphicOrigin`,null),O([r({readOnly:!0})],Z.prototype,`sublayers`,null),O([r()],Z.prototype,`layer`,void 0),O([r()],Z.prototype,`layerId`,void 0),O([r({readOnly:!0})],Z.prototype,`visibilityMode`,void 0),Z=O([m(`esri.layers.MapNotesLayer.MapNotesSublayer`)],Z);var Q=X;export{Q as default};