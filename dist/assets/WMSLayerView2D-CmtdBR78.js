import{BT as e,DT as t,OT as n,ax as r,eT as i,gD as a,nv as o,qw as s,uE as c,vT as l}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./OptimizedFeatureSet-CTIqq8fn.js";import"./featureConversionUtils-_DSSMFQ2.js";import"./earcut-BF1-mB58.js";import"./layerViewUtils-RSw-QNoB.js";import"./tagSymbols-CazaFvX8.js";import"./VertexAttributeLocations-CfzeuYMz.js";import"./VertexElementDescriptor-ju-1bdWe.js";import{t as u}from"./ExportWMSImageParameters-BoUFQfmf.js";import"./BoundingBox-CLkiiRfJ.js";import"./config-BSvujflG.js";import"./WGLContainer-D_aBMsnu.js";import"./utils-DS5dbHj4.js";import"./ProgramTemplate-BXau1qoF.js";import"./VertexArrayObject-DEfjd5y-.js";import"./BufferObject-q8zuTMny.js";import"./VertexBuffer-xVpphTb4.js";import"./vec3f32-B2H3-fiA.js";import"./Container-BuEih3Ua.js";import"./GraphShaderModule-D5RCsL2_.js";import"./FramebufferObject-BhBPSr-C.js";import"./ShaderBuilder-D3cV1oap.js";import"./bitmapUtils-SuGDUZFe.js";import"./Bitmap-CiNUpq9T.js";import{t as d}from"./BitmapContainer-ChYmxUus.js";import{t as f}from"./LayerView2D-BsKgTWnO.js";import{t as p}from"./ExportStrategy-BtFJEMJc.js";import{t as m}from"./LayerView-2jeNRFkG.js";import{t as h}from"./RefreshableLayerView-CXmtIjA5.js";import{t as g}from"./timeSupport-CpSaGF8C.js";var _=r=>{let o=r,s=class extends o{initialize(){this.exportImageParameters=new u({layer:this.layer})}destroy(){this.exportImageParameters=l(this.exportImageParameters)}get exportImageVersion(){return this.exportImageParameters?.commitProperty(`version`),this.commitProperty(`timeExtent`),(this._get(`exportImageVersion`)||0)+1}get timeExtent(){return g(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}async fetchPopupFeaturesAtLocation(t,n){let{layer:r}=this;if(!t)throw new e(`wmslayerview:fetchPopupFeatures`,`Nothing to fetch without area`,{layer:r});let{popupEnabled:a}=r;if(!a)throw new e(`wmslayerview:fetchPopupFeatures`,`popupEnabled should be true`,{popupEnabled:a});let o=this.createFetchPopupFeaturesQuery(t);if(!o)return[];let{extent:s,width:c,height:l,x:u,y:d}=o;if(!(s&&c&&l))throw new e(`wmslayerview:fetchPopupFeatures`,`WMSLayer does not support fetching features.`,{extent:s,width:c,height:l});let f=await r.fetchFeatureInfo(s,c,l,u,d);return i(n),f}};return a([t()],s.prototype,`exportImageParameters`,void 0),a([t({readOnly:!0})],s.prototype,`exportImageVersion`,null),a([t()],s.prototype,`layer`,void 0),a([t({readOnly:!0})],s.prototype,`timeExtent`,null),s=a([n(`esri.views.layers.WMSLayerView`)],s),s},v=class extends _(h(f(m))){constructor(){super(...arguments),this.bitmapContainer=new d}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}update(e){this.strategy.update(e).catch(e=>{s(e)||c.getLogger(this).error(e)})}attach(){let{layer:e}=this,{imageMaxHeight:t,imageMaxWidth:n}=e;this.bitmapContainer=new d,this.container.addChild(this.bitmapContainer),this.strategy=new p({container:this.bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:t,imageMaxWidth:n,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.addAttachHandles(o(()=>this.exportImageVersion,()=>this.requestUpdate()))}detach(){this.strategy=l(this.strategy),this.container.removeAllChildren()}viewChange(){}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQuery(e){let{view:t,bitmapContainer:n}=this,{x:i,y:a}=e,{spatialReference:o}=t,s,c=0,l=0;if(n.children.some(e=>{let{width:t,height:n,resolution:u,x:d,y:f}=e,p=d+u*t,m=f-u*n;return i>=d&&i<=p&&a<=f&&a>=m&&(s=new r({xmin:d,ymin:m,xmax:p,ymax:f,spatialReference:o}),c=t,l=n,!0)}),!s)return null;let u=s.width/c,d=Math.round((i-s.xmin)/u),f=Math.round((s.ymax-a)/u);return{extent:s,width:c,height:l,x:d,y:f}}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,t,n,r){return this.layer.fetchImageBitmap(e,t,n,{timeExtent:this.timeExtent,...r})}};a([t()],v.prototype,`strategy`,void 0),v=a([n(`esri.views.2d.layers.WMSLayerView2D`)],v);var y=v;export{y as default};