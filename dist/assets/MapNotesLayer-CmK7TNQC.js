import{$T as e,A as t,AS as n,BT as r,FE as i,Fg as a,Id as o,Kg as s,L as c,Ld as l,Lx as u,M as d,Ng as f,Od as p,Rd as m,Rg as h,Rh as g,UT as _,Ua as v,VT as y,Vd as b,WT as x,XT as S,ba as C,bd as w,ex as T,g as E,hv as D,jE as O,kD as k,lx as A,nx as j,px as M,tx as N,ua as P,vx as F,xa as I,xu as L,zg as R}from"./index-BN8X5Ryz.js";import{t as z}from"./GraphicsLayer-DBcl42yN.js";import{t as B}from"./objectIdUtils-Ye-ovgo-.js";var V=Symbol(`isMapNotesGraphicOriginSymbol`),H,U=class extends C{get[(H=V,I)](){return this.layer}constructor(e,t){super(),this[H]=!0,this.type=`map-notes`,this.layer=e,this.sublayer=t}get id(){return`${this.layer.id}:__${this.sublayer.id}__`}};function W(e){return e.featureCollectionType===`markup`||e.layers.some(e=>e.layerDefinition.visibilityField!=null||!G(e))}function G({layerDefinition:e,featureSet:t}){let n=e.geometryType??t.geometryType;return Y.find(t=>n===t.geometryTypeJSON&&e.drawingInfo?.renderer?.symbol?.type===t.identifyingSymbol.type)}function K(){return new F({xmin:-180,ymin:-90,xmax:180,ymax:90})}var q=new w({name:`OBJECTID`,alias:`OBJECTID`,type:`oid`,nullable:!1,editable:!1}),J=new w({name:`title`,alias:`Title`,type:`string`,nullable:!0,editable:!0,length:255}),Y=[{geometryType:`polygon`,geometryTypeJSON:`esriGeometryPolygon`,id:`polygonLayer`,layerId:0,title:`Polygons`,identifyingSymbol:new m().toJSON()},{geometryType:`polyline`,geometryTypeJSON:`esriGeometryPolyline`,id:`polylineLayer`,layerId:1,title:`Polylines`,identifyingSymbol:new b().toJSON()},{geometryType:`multipoint`,geometryTypeJSON:`esriGeometryMultipoint`,id:`multipointLayer`,layerId:2,title:`Multipoints`,identifyingSymbol:new l().toJSON()},{geometryType:`point`,geometryTypeJSON:`esriGeometryPoint`,id:`pointLayer`,layerId:3,title:`Points`,identifyingSymbol:new l().toJSON()},{geometryType:`point`,geometryTypeJSON:`esriGeometryPoint`,id:`textLayer`,layerId:4,title:`Text`,identifyingSymbol:new o().toJSON()}],X=class extends P(t(c(d(v(g))))){constructor(e){super(e),this.capabilities={operations:{supportsMapNotesEditing:!0}},this.featureCollections=null,this.featureCollectionJSON=null,this.featureCollectionType=`notes`,this.legendEnabled=!1,this.listMode=`hide-children`,this.minScale=0,this.maxScale=0,this.spatialReference=u.WGS84,this.sublayers=new D(Y.map(e=>new Z({id:e.id,layerId:e.layerId,title:e.title,layer:this}))),this.title=`Map Notes`,this.type=`map-notes`,this.visibilityMode=`inherited`}readCapabilities(e,t,n){return{operations:{supportsMapNotesEditing:!W(t)&&n?.origin!==`portal-item`}}}readFeatureCollections(e,t,n){if(!W(t))return null;let r=t.layers.map(e=>{let t=new E;return t.read(e,n),t});return new D({items:r})}readLegacyfeatureCollectionJSON(e,t){return W(t)?i(t.featureCollection):null}get fullExtent(){let e=this.spatialReference,t=T();return this.sublayers==null?this.featureCollectionJSON?.layers.some(e=>e.layerDefinition.extent)&&this.featureCollectionJSON.layers.forEach(n=>{let r=f(n.layerDefinition.extent,e).geometry;r!=null&&M(t,r,t)}):this.sublayers.forEach(({fullBounds:e})=>e==null?t:M(t,e,t),t),N(t,j)?f(K(),e).geometry:A(t,e)}readMinScale(e,t){for(let e of t.layers)if(e.layerDefinition.minScale!=null)return e.layerDefinition.minScale;return 0}readMaxScale(e,t){for(let e of t.layers)if(e.layerDefinition.maxScale!=null)return e.layerDefinition.maxScale;return 0}get multipointLayer(){return this._findSublayer(`multipointLayer`)}get pointLayer(){return this._findSublayer(`pointLayer`)}get polygonLayer(){return this._findSublayer(`polygonLayer`)}get polylineLayer(){return this._findSublayer(`polylineLayer`)}readSpatialReference(e,t){return t.layers.length?u.fromJSON(t.layers[0].layerDefinition.spatialReference):u.WGS84}readSublayers(e,t,n){if(W(t))return null;let r=[],i=t.layers.reduce((e,t)=>Math.max(e,t.layerDefinition.id??-1),-1)+1;for(let e of t.layers){let{layerDefinition:t,featureSet:n}=e,a=t.id??i++,o=G(e);if(o!=null){let e=new Z({id:o.id,title:t.name,layerId:a,layer:this,graphics:n.features.map(({geometry:e,symbol:t,attributes:n,popupInfo:r})=>p.fromJSON({attributes:n,geometry:e,symbol:t,popupTemplate:r}))});r.push(e)}}return new D(r)}writeSublayers(t,n,r,i){let{minScale:a,maxScale:o}=this;if(t==null)return;let s=t.some(e=>e.graphics.length>0);if(!this.capabilities.operations.supportsMapNotesEditing)return void(s&&i?.messages?.push(new e(`map-notes-layer:editing-not-supported`,`New map notes cannot be added to this layer`)));let c=[],l=this.spatialReference.toJSON();e:for(let e of t)for(let t of e.graphics)if(t.geometry!=null){l=t.geometry.spatialReference.toJSON();break e}for(let e of Y){let n=t.find(t=>e.id===t.id);this._writeMapNoteSublayer(c,n,e,a,o,l,i)}O(`featureCollection.layers`,c,n)}get textLayer(){return this._findSublayer(`textLayer`)}load(e){return this.addResolvingPromise(this.loadFromPortal({supportedTypes:[`Feature Collection`]},e)),Promise.resolve(this)}read(e,t){`featureCollection`in e&&(e=i(e),Object.assign(e,e.featureCollection)),super.read(e,t)}async beforeSave(){if(this.sublayers==null)return;let e=null,t=[];for(let r of this.sublayers)for(let i of r.graphics)if(i.geometry!=null){let r=i.geometry;e?n(r.spatialReference,e)||(R(r.spatialReference,e)||h()||await a(),i.geometry=s(r,e)):e=r.spatialReference,t.push(i)}let r=await L(t.map(e=>e.geometry));t.forEach((e,t)=>e.geometry=r[t])}_findSublayer(e){return this.sublayers==null?null:this.sublayers?.find(t=>t.id===e)??null}_writeMapNoteSublayer(e,t,n,r,a,o,s){let c=[];if(t!=null){for(let e of t.graphics)this._writeMapNote(c,e,n.geometryType,s);this._normalizeObjectIds(c,q),e.push({layerDefinition:{name:t.title,drawingInfo:{renderer:{type:`simple`,symbol:i(n.identifyingSymbol)}},id:t.layerId,geometryType:n.geometryTypeJSON,minScale:r,maxScale:a,objectIdField:`OBJECTID`,fields:[q.toJSON(),J.toJSON()],spatialReference:o},featureSet:{features:c,geometryType:n.geometryTypeJSON}})}}_writeMapNote(e,t,n,r){if(t==null)return;let{geometry:i,symbol:a,popupTemplate:o}=t;if(i==null)return;if(i.type!==n)return void r?.messages?.push(new S(`map-notes-layer:invalid-geometry-type`,`Geometry "${i.type}" cannot be saved in "${n}" layer`,{graphic:t}));if(a==null)return void r?.messages?.push(new S(`map-notes-layer:no-symbol`,`Skipping map notes with no symbol`,{graphic:t}));let s={attributes:{...t.attributes},geometry:i.toJSON(),symbol:a.toJSON()};o!=null&&(s.popupInfo=o.toJSON()),e.push(s)}_normalizeObjectIds(e,t){let n=t.name,r=B(n,e)+1,i=new Set;for(let t of e){t.attributes||={};let{attributes:e}=t;(e[n]==null||i.has(e[n]))&&(e[n]=r++),i.add(e[n])}}};k([r({readOnly:!0})],X.prototype,`capabilities`,void 0),k([x([`portal-item`,`web-map`],`capabilities`,[`layers`])],X.prototype,`readCapabilities`,null),k([r({readOnly:!0})],X.prototype,`featureCollections`,void 0),k([x([`web-map`,`portal-item`],`featureCollections`,[`layers`])],X.prototype,`readFeatureCollections`,null),k([r({readOnly:!0,json:{origins:{"web-map":{write:{enabled:!0,target:`featureCollection`}}}}})],X.prototype,`featureCollectionJSON`,void 0),k([x([`web-map`,`portal-item`],`featureCollectionJSON`,[`featureCollection`])],X.prototype,`readLegacyfeatureCollectionJSON`,null),k([r({readOnly:!0,json:{read:!0,write:{enabled:!0,ignoreOrigin:!0}}})],X.prototype,`featureCollectionType`,void 0),k([r({readOnly:!0})],X.prototype,`fullExtent`,null),k([r({readOnly:!0,json:{origins:{"web-map":{write:{target:`featureCollection.showLegend`,overridePolicy(){return{enabled:this.featureCollectionJSON!=null}}}}}}})],X.prototype,`legendEnabled`,void 0),k([r({type:[`show`,`hide`,`hide-children`]})],X.prototype,`listMode`,void 0),k([r({type:Number,nonNullable:!0,json:{write:!1}})],X.prototype,`minScale`,void 0),k([x([`web-map`,`portal-item`],`minScale`,[`layers`])],X.prototype,`readMinScale`,null),k([r({type:Number,nonNullable:!0,json:{write:!1}})],X.prototype,`maxScale`,void 0),k([x([`web-map`,`portal-item`],`maxScale`,[`layers`])],X.prototype,`readMaxScale`,null),k([r({readOnly:!0})],X.prototype,`multipointLayer`,null),k([r({value:`ArcGISFeatureLayer`,type:[`ArcGISFeatureLayer`]})],X.prototype,`operationalLayerType`,void 0),k([r({readOnly:!0})],X.prototype,`pointLayer`,null),k([r({readOnly:!0})],X.prototype,`polygonLayer`,null),k([r({readOnly:!0})],X.prototype,`polylineLayer`,null),k([r({type:u})],X.prototype,`spatialReference`,void 0),k([x([`web-map`,`portal-item`],`spatialReference`,[`layers`])],X.prototype,`readSpatialReference`,null),k([r({readOnly:!0,json:{origins:{"web-map":{write:{ignoreOrigin:!0}}}}})],X.prototype,`sublayers`,void 0),k([x(`web-map`,`sublayers`,[`layers`])],X.prototype,`readSublayers`,null),k([_(`web-map`,`sublayers`)],X.prototype,`writeSublayers`,null),k([r({readOnly:!0})],X.prototype,`textLayer`,null),k([r()],X.prototype,`title`,void 0),k([r({readOnly:!0,json:{read:!1}})],X.prototype,`type`,void 0),X=k([y(`esri.layers.MapNotesLayer`)],X);var Z=class extends z{constructor(e){super(e),this.visibilityMode=`inherited`}initialize(){for(let e of this.graphics)e.sourceLayer=this.layer;this.graphics.on(`after-add`,e=>{e.item.sourceLayer=this.layer,e.item.origin=this.graphicOrigin}),this.graphics.on(`after-remove`,e=>{e.item.sourceLayer=null,e.item.origin=null})}get fullExtent(){let e=this.layer?.spatialReference,t=this.fullBounds;return e?t==null?f(K(),e).geometry:A(t,e):null}get fullBounds(){let e=this.layer?.spatialReference;if(!e)return null;let t=T();return this.graphics.forEach(n=>{let r=n.geometry==null?null:f(n.geometry,e).geometry;r!=null&&M(t,r.type===`point`?r:r.extent,t)}),N(t,j)?null:t}get graphicOrigin(){return new U(this.layer,this)}get sublayers(){return this.graphics}};k([r({readOnly:!0})],Z.prototype,`fullExtent`,null),k([r({readOnly:!0})],Z.prototype,`fullBounds`,null),k([r({readOnly:!0})],Z.prototype,`graphicOrigin`,null),k([r({readOnly:!0})],Z.prototype,`sublayers`,null),k([r()],Z.prototype,`layer`,void 0),k([r()],Z.prototype,`layerId`,void 0),k([r({readOnly:!0})],Z.prototype,`visibilityMode`,void 0),Z=k([y(`esri.layers.MapNotesLayer.MapNotesSublayer`)],Z);var Q=X;export{Q as default};