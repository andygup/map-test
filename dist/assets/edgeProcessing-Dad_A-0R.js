import{Ml as e,Nl as t,Ol as n,c_ as r,dl as i,fw as a,kl as o,lD as s,ll as c,nw as l,oT as u,rl as d,vl as f,yl as p}from"./index-ByaFsVj4.js";import{t as m}from"./deduplicate-BsMx4rdl.js";import{r as h}from"./VertexAttributeLocations-BMy2FGBT.js";import{a as g,s as _}from"./FloatArray-CclVVn1u.js";import{t as v}from"./TextureBackedBufferLayout-BKch40yL.js";import{n as y}from"./Normals-DayQW_Jq.js";var b=g().vec3f(`position`).u16(`componentIndex`,{integer:!0}).freeze(),x=g().vec2u8(`sideness`).freeze(),S=_(x),C=g().vec3f(`position0`).vec3f(`position1`).vec2i16(`normalCompressed`).u16(`componentIndex`,{integer:!0}).u8(`variantOffset`,{glNormalized:!0}).u8(`variantStroke`).u8(`variantExtension`,{glNormalized:!0}).freeze(),w=g().vec3f(`position0`).vec3f(`position1`).vec2i16(`normalCompressed`).vec2i16(`normal2Compressed`).u16(`componentIndex`,{integer:!0}).u8(`variantOffset`,{glNormalized:!0}).u8(`variantStroke`).u8(`variantExtension`,{glNormalized:!0}).freeze(),T=_(C,1),E=_(w,1);h([S,T]),h([S,E]),new v([{name:`color`,type:`vec4unorm8`},{name:`lineWidth`,type:`u8`},{name:`extensionLength`,type:`u8`},{name:`materialType`,type:`u8`},{name:`opacity`,type:`unorm8`},{name:`elevationOffset`,type:`f32`}]);var D=class{constructor(){this.position0=r(),this.position1=r(),this.faceNormal0=r(),this.faceNormal1=r(),this.componentIndex=0,this.cosAngle=0}},O=-1;function k(t,r,a){let s=t.vertices.position,c=t.vertices.componentIndex,l=P.position0,u=P.position1,d=P.faceNormal0,f=P.faceNormal1,{edges:p,normals:m}=A(t),h=p.length/4,g=r.allocate(h),_=0,v=h,y=a?.allocate(v),b=0,x=0,S=0;j.length=0;for(let e=0;e<h;++e){let t=4*e;s.getVec(p.data[t],l),s.getVec(p.data[t+1],u);let n=j.pushNew();n.index=4*e,n.length=o(l,u)}j.sort((e,t)=>t.length-e.length);let C=[],w=[];j.forAll(({length:t,index:o})=>{let h=p.data[o],v=p.data[o+1],T=p.data[o+2],E=p.data[o+3],D=E===O;if(s.getVec(h,l),s.getVec(v,u),D){let t=3*T;n(d,m.data[t],m.data[t+1],m.data[t+2]),e(f,d),P.componentIndex=c.get(h),P.cosAngle=i(d,f)}else{let t=3*T;if(n(d,m.data[t],m.data[t+1],m.data[t+2]),t=3*E,n(f,m.data[t],m.data[t+1],m.data[t+2]),P.componentIndex=c.get(h),P.cosAngle=i(d,f),te(P,ae))return;P.cosAngle<-.9999&&e(f,d)}x+=t,S++,D||ee(P,se)?(r.write(g,_++,P),C.push(t)):ne(P,z)&&(y&&a&&a.write(y,b++,P),w.push(t))});let T=new Float32Array(C.reverse()),E=new Float32Array(w.reverse()),D=y&&a?{instancesData:y.slice(0,b),lodInfo:{lengths:E}}:void 0;return{regular:{instancesData:g.slice(0,_),lodInfo:{lengths:T}},silhouette:D,averageEdgeLength:x/S}}function ee(e,t){return e.cosAngle<t}function te(e,t){return e.cosAngle>t}function ne(e,t){let n=l(e.cosAngle);return c(F,e.position1,e.position0),n*(i(f(ie,e.faceNormal0,e.faceNormal1),F)>0?-1:1)>t}function A(e){let t=e.faces.length/3,n=e.faces,r=e.neighbors,i=e.vertices.position;M.length=N.length=0;for(let e=0;e<t;e++){let t=3*e,a=r[t],o=r[t+1],s=r[t+2],c=n[t],l=n[t+1],u=n[t+2];i.getVec(c,I),i.getVec(l,L),i.getVec(u,R),p(L,L,I),p(R,R,I),f(I,L,R),d(I,I),N.pushArray(I),(a===O||c<l)&&(M.push(c),M.push(l),M.push(e),M.push(a)),(o===O||l<u)&&(M.push(l),M.push(u),M.push(e),M.push(o)),(s===O||u<c)&&(M.push(u),M.push(c),M.push(e),M.push(s))}return{edges:M,normals:N}}var re=class{constructor(){this.index=0,this.length=0}},j=new u({allocator:e=>e||new re,deallocator:null}),M=new u({deallocator:null}),N=new u({deallocator:null}),P=new D,ie=r(),F=r(),I=r(),L=r(),R=r(),z=a(4),ae=Math.cos(z),oe=a(35),se=Math.cos(oe);function B(e,t,n){let r=t/3,i=new Uint32Array(n+1),a=new Uint32Array(n+1),o=(e,t)=>{e<t?i[e+1]++:a[t+1]++};for(let t=0;t<r;t++){let n=e[3*t],r=e[3*t+1],i=e[3*t+2];o(n,r),o(r,i),o(i,n)}let s=0,c=0;for(let e=0;e<n;e++){let t=i[e+1],n=a[e+1];i[e+1]=s,a[e+1]=c,s+=t,c+=n}let l=new Uint32Array(6*r),u=i[n],d=(e,t,n)=>{if(e<t){let r=i[e+1]++;l[2*r]=t,l[2*r+1]=n}else{let r=a[t+1]++;l[2*u+2*r]=e,l[2*u+2*r+1]=n}};for(let t=0;t<r;t++){let n=e[3*t],r=e[3*t+1],i=e[3*t+2];d(n,r,t),d(r,i,t),d(i,n,t)}let f=(e,t)=>{let n=2*e,r=t-e;for(let e=1;e<r;e++){let t=l[n+2*e],r=l[n+2*e+1],i=e-1;for(;i>=0&&l[n+2*i]>t;i--)l[n+2*i+2]=l[n+2*i],l[n+2*i+3]=l[n+2*i+1];l[n+2*i+2]=t,l[n+2*i+3]=r}};for(let e=0;e<n;e++)f(i[e],i[e+1]),f(u+a[e],u+a[e+1]);let p=new Int32Array(3*r),m=(t,n)=>t===e[3*n]?0:t===e[3*n+1]?1:t===e[3*n+2]?2:-1,h=(e,t)=>{let n=m(e,t);p[3*t+n]=-1},g=(e,t,n,r)=>{let i=m(e,t);p[3*t+i]=r;let a=m(n,r);p[3*r+a]=t};for(let e=0;e<n;e++){let t=i[e],n=i[e+1],r=a[e],o=a[e+1];for(;t<n&&r<o;){let n=l[2*t],i=l[2*u+2*r];n===i?(g(e,l[2*t+1],i,l[2*u+2*r+1]),t++,r++):n<i?(h(e,l[2*t+1]),t++):(h(i,l[2*u+2*r+1]),r++)}for(;t<n;)h(e,l[2*t+1]),t++;for(;r<o;)h(l[2*u+2*r],l[2*u+2*r+1]),r++}return p}var V=.7,H=class{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?le:ce}write(e,t,n){Y.seed=this._edgeHashFunction(n);let r=Y.getIntRange(0,255),i=Y.getIntRange(0,this.settings.variants-1),a=Y.getFloat(),o=255*(.5*ue(-(1-Math.min(a/V,1))+Math.max(0,a-V)/(1-V),1.2)+.5);e.position0.setVec(t,n.position0),e.position1.setVec(t,n.position1),e.componentIndex.set(t,n.componentIndex),e.variantOffset.set(t,r),e.variantStroke.set(t,i),e.variantExtension.set(t,o)}},U=new Float32Array(6),W=new Uint32Array(U.buffer),G=new Uint32Array(1);function ce(e){return U[0]=e.position0[0],U[1]=e.position0[1],U[2]=e.position0[2],U[3]=e.position1[0],U[4]=e.position1[1],U[5]=e.position1[2],G[0]=31*(31*(31*(31*(31*(166811+W[0])+W[1])+W[2])+W[3])+W[4])+W[5],G[0]}function le(e){let t=U;t[0]=q(e.position0[0]),t[1]=q(e.position0[1]),t[2]=q(e.position0[2]),t[3]=q(e.position1[0]),t[4]=q(e.position1[1]),t[5]=q(e.position1[2]),G[0]=5381;for(let e=0;e<W.length;e++)G[0]=31*G[0]+W[e];return G[0]}var K=1e4;function q(e){return Math.round(e*K)/K}function ue(e,t){return Math.abs(e)**t*Math.sign(e)}var de=class{constructor(){this._commonWriter=new H}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return C.createBuffer(e)}write(e,n,r){this._commonWriter.write(e,n,r),t(J,r.faceNormal0,r.faceNormal1),d(J,J);let{typedBuffer:i,typedBufferStride:a}=e.normalCompressed;y(i,n,J[0],J[1],J[2],a)}},fe=class{constructor(){this._commonWriter=new H}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return w.createBuffer(e)}write(e,t,n){this._commonWriter.write(e,t,n);{let{typedBuffer:r,typedBufferStride:i}=e.normalCompressed;y(r,t,n.faceNormal0[0],n.faceNormal0[1],n.faceNormal0[2],i)}{let{typedBuffer:r,typedBufferStride:i}=e.normal2Compressed;y(r,t,n.faceNormal1[0],n.faceNormal1[1],n.faceNormal1[2],i)}}},J=r(),Y=new s;function X(e){let t=Z(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return Q.updateSettings(e.writerSettings),$.updateSettings(e.writerSettings),k(t,Q,$)}function Z(e,t,n,r){if(t){let t=B(n,r,e.count);return new pe(n,r,t,e)}let i=m(e.buffer,e.stride/4,{originalIndices:n}),a=B(i.indices,r,i.uniqueCount);return{faces:i.indices,facesLength:i.indices.length,neighbors:a,vertices:b.createView(i.buffer)}}var pe=class{constructor(e,t,n,r){this.faces=e,this.facesLength=t,this.neighbors=n,this.vertices=r}},Q=new de,$=new fe,me=g().vec3f(`position0`).vec3f(`position1`),he=g().vec3f(`position0`).vec3f(`position1`).u16(`componentIndex`,{integer:!0});export{k as a,me as i,X as n,b as o,Z as r,he as t};