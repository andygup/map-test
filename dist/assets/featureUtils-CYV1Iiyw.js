import{D_ as e,Ip as t,P_ as n,Pp as r,S_ as i,Up as a,Vp as o,dh as s,hE as c,j_ as l,lp as u,pD as d,ph as f,uE as p,w_ as m,x_ as h}from"./index-CZ4oMP1N.js";import{i as g,s as _}from"./utils-DhzlDVJ-.js";var v=`esri.widgets.Feature.support.featureUtils`,y=()=>p.getLogger(v),b=/href=(""|'')/gi,x=/(\{([^{\r\n]+)\})/g,ee=/'/g,S=/^\s*expression\//i,C=/(\n)/gi,te=/[\u00A0-\u9999<>&]/gim,ne=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,re=/^(?:mailto:|tel:)/,w=`relationships/`,T=e(`short-date-short-time`);function ie(e){if(e!=null)return(e.sourceLayer||e.layer)??void 0}async function ae({type:e,value:t,event:n}){try{return typeof t==`function`?t(n):await t}catch(r){y().error(`error`,`An error occurred when calling the "${e}" function`,{error:r,graphic:n.graphic,value:t});return}}function oe(e=``){if(e)return!re.test(e.trim().toLowerCase())}function E(e){return!!e&&S.test(e)}function se(e,t){if(!t||!E(t)||!e)return;let n=t.replace(S,``).toLowerCase();return e.find(({name:e})=>e.toLowerCase()===n)}function D({fieldInfo:e,graphic:t}){return!(!e?.fieldName||E(e.fieldName)||J(e.fieldName)||t?.isAggregate||t?.popupTemplate)}function ce({expressionInfos:e,fieldInfo:t,graphic:n,isContentFieldInfos:r,layer:i}){if(!t?.fieldName)return null;let a=se(e,t.fieldName);if(a)return a.title||null;if(f(i)&&D({fieldInfo:t,graphic:n})){let e=i.getFieldAlias(t.fieldName);return r?t.label||e||t.fieldName:e||t.fieldName}return t.label||t.fieldName}function O({fieldInfo:e,isContentFieldInfos:t,layer:n}){if(!e?.fieldName)return null;if(f(n)){let r=n.popupTemplate||n.fieldConfigurations?n.getFieldConfiguration(e.fieldName)?.fieldFormat:u(e,n.getField(e.fieldName));return t&&e.fieldFormat||r}return null}function k(e,t){return`{${t.get(e.toLowerCase())?.fieldName||e}}`}function A(e){return e.replaceAll(b,``)}function j(e,t){let n=M(t,e);return n?n.name:e}function le(e,t){return e&&e.map(e=>j(e,t))}function M(e,t){return e&&typeof e.getField==`function`&&t?e.getField(t)??null:null}function N(e){return`${e}`.trim()}function ue({attributes:e,globalAttributes:t,layer:n,text:r,expressionAttributes:i,fieldInfoMap:a}){return r?P({formattedAttributes:t,template:I(r,{...t,...i,...e},n),fieldInfoMap:a}):``}function P({formattedAttributes:e,template:t,fieldInfoMap:n}){return N(A(c(c(t,e=>k(e,n)),e)))}function de(e,t,n=!1){let r=t[e];typeof r==`string`&&(t[e]=(n?encodeURIComponent(r):r).replaceAll(ee,`%27`))}function fe(e,t=!1){let n={...e};return Object.keys(n).forEach(e=>de(e,n,t)),n}function pe(e,t,n){let r=(t=N(t))&&!t.startsWith(`{`);return c(e,fe(n,r||!1))}function F(e,t){return e.replaceAll(x,(e,n,r)=>{let i=M(t,r);return i?`{${i.name}}`:n})}function I(e,t,n){let r=F(e,n);return r&&r.replaceAll(ne,(e,n,r)=>pe(e,n||r,t))}function L(e,t){let n=t?.fieldFormat?.type===`number`||t?.format&&t.format.dateFormat==null&&(t.format.places!=null||t.format.digitSeparator!=null);if(typeof e==`string`&&n){let t=Number(e);if(!isNaN(t))return t}return e}function R(e){return typeof e==`object`&&!!e&&`fieldsIndex`in e&&`geometryType`in e&&`getField`in e&&`load`in e&&`loaded`in e&&`objectIdField`in e&&`spatialReference`in e&&`type`in e&&(e.type===`feature`||e.type===`scene`||e.type===`subtype-group`||e.type===`subtype-sublayer`||e.type===`sublayer`)&&`when`in e}function z(e){return typeof e==`object`&&!!e&&`createQuery`in e&&`queryFeatureCount`in e&&`queryObjectIds`in e&&`queryRelatedFeatures`in e&&`queryRelatedFeaturesCount`in e&&`relationships`in e}function B(e){return R(e)&&z(e)}function me(e){return!(!(e&&typeof e==`object`&&`createQuery`in e&&`getField`in e&&`queryFeatureCount`in e&&`queryFeatures`in e&&`queryObjectIds`in e&&`capabilities`in e&&`fields`in e&&`fieldsIndex`in e&&`type`in e)||e.type!==`feature`&&e.type!==`subtype-group`&&e.type!==`subtype-sublayer`&&e.type!==`sublayer`||!(`when`in e))&&(e.type===`subtype-sublayer`&&`parent`in e&&e.parent&&typeof e.parent==`object`?`globalIdField`in e.parent:`globalIdField`in e)}function he(e){return!!e&&typeof e==`object`&&`sourceLayer`in e&&B(e.sourceLayer)}function V(e,n){let{fieldInfos:r,fieldName:a,graphic:o,isContentFieldInfos:s,layer:c,preventPlacesFormatting:l,timeZone:u}=n,d=W(r,a),p=M(c,a),g=f(c)&&D({fieldInfo:d,graphic:o}),v=g?null:d?.format,y=g?O({fieldInfo:d,layer:c,isContentFieldInfos:s}):null,b=y?.type===`number`;if(d&&!t(a)){let t=p?.type,n=y?.type===`date-time`,r=v?.dateFormat;if(t===`date`||t===`date-only`||t===`time-only`||t===`timestamp-offset`||n||r)return _(e,{format:n?void 0:r,fieldFormat:n?y:void 0,fieldType:t,timeZoneOptions:{layerTimeZone:c&&`preferredTimeZone`in c?c.preferredTimeZone:null,viewTimeZone:u,datesInUnknownTimezone:!(!c||!(`datesInUnknownTimezone`in c))&&!!c.datesInUnknownTimezone}})}if(typeof e==`string`&&t(a)&&v)return H(e,v);if(typeof(e=L(e,{format:b?void 0:v,fieldFormat:b?y:void 0}))==`string`||e==null||v==null&&y==null)return G(e);let x=b?m(y):v?i(v):void 0;return h(e,l?{...x,minimumFractionDigits:0,maximumFractionDigits:20}:x)}function H(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(`,`)?U(e,`,`,`, `,t):e.includes(`;`)?U(e,`;`,`; `,t):e.includes(` `)?U(e,` `,` `,t):h(Number(e),i(t))}function U(e,t,n,r){return e.trim().split(t).map(e=>h(Number(e),i(r))).join(n)}function W(e,t){if(e?.length&&t)return e.find(e=>e.fieldName?.toLowerCase()===t.toLowerCase())}function ge({fieldName:e,graphic:t,layer:n}){if(J(e)||!n||typeof n.getFeatureType!=`function`)return null;let{typeIdField:r}=n;if(!r||e!==r)return null;let i=n.getFeatureType(t);return i?i.name:null}function _e({fieldName:e,value:t,graphic:n,layer:r}){if(J(e)||!r||typeof r.getFieldDomain!=`function`)return null;let i=n&&r.getFieldDomain(e,{feature:n,excludeImpliedDomains:d(`esri-widget-legacy-field-domain-calculation`)});return i&&i.type===`coded-value`?i.getName(t):null}function ve(e,t,r,i){let{creatorField:a,creationDateField:o,editorField:s,editDateField:c}=e;if(!t)return;let u=n(i&&`preferredTimeZone`in i?i.preferredTimeZone:null,!(!i||!(`datesInUnknownTimezone`in i))&&!!i.datesInUnknownTimezone,r,T,`date`),d={...T,...u},f=t[c];if(typeof f==`number`){let e=t[s];return{type:`edit`,date:l(f,d),user:e}}let p=t[o];if(typeof p==`number`){let e=t[a];return{type:`create`,date:l(p,d),user:e}}return null}function ye(e,t){let n=new Map;if(!e)return n;for(let r of e){if(!r.fieldName)continue;let e=j(r.fieldName,t);r.fieldName=e,n.set(e.toLowerCase(),r)}return n}function be(e){let t=[];if(!e)return t;let{fieldInfos:n,content:r}=e;return n&&t.push(...n),r&&Array.isArray(r)&&r.forEach(e=>{if(e.type===`fields`){let n=e?.fieldInfos;n&&t.push(...n)}}),t}function xe(e){return e.replaceAll(te,e=>`&#${e.charCodeAt(0)};`)}function G(e){return typeof e==`string`?e.replaceAll(C,`<br class="esri-text-new-line" />`):e}function K(e){let{fieldInfoMap:t,fieldInfos:n,fieldName:r,graphic:i,isContentFieldInfos:a,layer:s,timeZone:c,value:l}=e;if(l==null)return``;let u=_e({fieldName:r,value:l,graphic:i,layer:s});if(u)return u;let d=ge({fieldName:r,graphic:i,layer:s});if(d)return d;if(t.get(r.toLowerCase()))return V(l,{fieldInfos:n||Array.from(t.values()),fieldName:r,graphic:i,isContentFieldInfos:a,layer:s,timeZone:c});let f=s?.fieldsIndex?.get(r);return f&&(g(f)||o(f))?_(l,{fieldType:f.type,timeZoneOptions:{layerTimeZone:s&&`preferredTimeZone`in s?s.preferredTimeZone:null,viewTimeZone:c,datesInUnknownTimezone:!(!s||!(`datesInUnknownTimezone`in s))&&!!s.datesInUnknownTimezone}}):G(l)}function Se({attributes:e,fieldInfoMap:t,fieldInfos:n,graphic:r,isContentFieldInfos:i,layer:a,relatedInfos:o,timeZone:s}){let c={};return o?.forEach(e=>De({attributes:c,relatedInfo:e,fieldInfoMap:t,fieldInfos:n,layer:a,timeZone:s})),e&&Object.keys(e).forEach(o=>{let l=e[o];c[o]=K({fieldInfoMap:t,fieldInfos:n,fieldName:o,graphic:r,isContentFieldInfos:i,layer:a,timeZone:s,value:l})}),c}async function q(e,t){let{layer:n,graphic:r,outFields:i,objectIds:a,returnGeometry:o,spatialReference:c}=e,l=a[0];if(typeof l!=`number`&&typeof l!=`string`){let e={layer:n,graphic:r,objectId:l,requiredFields:i};return y().warn(`Could not query required fields for the specified feature. The feature's ID is invalid.`,e),null}if(!s(n)?.operations?.supportsQuery){let e={layer:n,graphic:r,requiredFields:i,returnGeometry:o};return y().warn(`The specified layer cannot be queried. The following fields will not be available.`,e),null}let u=n.createQuery();return u.objectIds=a,u.outFields=i?.length?i:[n.objectIdField],u.returnGeometry=!!o,u.returnZ=!!o,u.returnM=!!o,u.outSpatialReference=c,(await n.queryFeatures(u,t)).features[0]}async function Ce(e){if(!e.expressionInfos?.length)return!1;let t=await a(),{arcadeUtils:{hasGeometryFunctions:n}}=t;return n(e)}async function we(e){if(!e.expressionInfos?.length)return!1;let t=await a(),{arcadeUtils:{requiresTrack:n}}=t;return n(e)}async function Te({graphic:e,popupTemplate:t,layer:n,spatialReference:i},a){if(!n||!t||(typeof n.load==`function`&&await n.load(a),!e.attributes))return;let o=n.objectIdField,s=e.attributes[o];if(s==null)return;let c=[s],l=new Set(await t.getRequiredFields(n.fieldsIndex));n.timeInfo?.trackIdField==null||l.has(n.timeInfo.trackIdField)||await we(t)&&l.add(n.timeInfo.trackIdField);let u=r(e,l),d=u?[]:l.has(o)?[...l]:[...l,o],f=t.returnGeometry||await Ce(t);if(u&&!f)return;let p=await q({layer:n,graphic:e,outFields:d,objectIds:c,returnGeometry:f,spatialReference:i},a);p&&(p.geometry&&(e.geometry=p.geometry),p.attributes&&(e.attributes={...e.attributes,...p.attributes}))}function J(e=``){return!!e&&e.includes(w)}function Ee(e){return e?`${w}${e.layerId}/${e.fieldName}`:``}function Y({attributes:e,graphic:t,relatedInfo:n,fieldInfos:r,fieldInfoMap:i,layer:a,timeZone:o}){e&&t&&n&&Object.keys(t.attributes).forEach(s=>{let c=Ee({layerId:n.relation.id.toString(),fieldName:s}),l=t.attributes[s];e[c]=K({fieldName:c,fieldInfos:r,fieldInfoMap:i,layer:a,value:l,graphic:t,timeZone:o})})}function De({attributes:e,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:a}){e&&t&&(t.relatedFeatures?.forEach(o=>Y({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:a})),t.relatedStatsFeatures?.forEach(o=>Y({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:i,timeZone:a})))}var X=e=>{if(!e)return!1;let t=e.toUpperCase();return t.includes(`CURRENT_TIMESTAMP`)||t.includes(`CURRENT_DATE`)||t.includes(`CURRENT_TIME`)},Z=({layer:e,method:t,query:n,definitionExpression:r})=>{if(!e.capabilities?.query?.supportsCacheHint||t===`attachments`)return;let i=n.where==null?null:n.where,a=n.geometry==null?null:n.geometry;X(r)||X(i)||a?.type===`extent`||n.resultType===`tile`||(n.cacheHint=!0)},Oe=({query:e,layer:t,method:n})=>{Z({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??``}`})},ke=({queryPayload:e,layer:t,method:n})=>{Z({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??``}`})};function Ae(e,t,n){return e&&t&&n?t.type===`sublayer`?$({layers:t.layer?.allSublayers,map:e,relatedLayer:t,relationship:n})||$({layers:t.layer?.subtables,map:e,relatedLayer:t,relationship:n}):$({layers:e.allLayers,map:e,relatedLayer:t,relationship:n})||$({layers:e.allTables,map:e,relatedLayer:t,relationship:n}):null}function je(e,t){return e&&`utilityNetworks`in e&&t?e.utilityNetworks?.find(e=>e.isUtilityLayer(t)):null}function Q(e,t){return e?.allTables.find(e=>e.type===`feature`&&e.layerId===t.id&&e.url===t.layer?.url)}function $({map:e,relationship:t,relationship:{relatedTableId:n},relatedLayer:r,layers:i}){if(!i)return null;for(let a of i){if(a.type===`map-image`){let n=$({layers:a.sublayers,map:e,relatedLayer:r,relationship:t})||$({layers:a.subtables,map:e,relatedLayer:r,relationship:t});if(n)return n;continue}if(!B(a))continue;if(r.type===`sublayer`){if(a!==r&&a.id===n)return a.isTable?Q(e,a):a;continue}let i=r.type===`scene`&&r.associatedLayer?r.associatedLayer.url:r.url;if(!i)return null;if(a.type!==`sublayer`){if(a!==r&&a.url===i&&a.layerId===n)return a}else if(a!==r&&a.layer?.url===i&&a.id===n)return a.isTable?Q(e,a):a}return null}export{ie as A,V as C,he as D,ye as E,j as M,ve as O,q as S,ae as T,xe as _,D as a,J as b,ue as c,R as d,z as f,G as g,Te as h,je as i,Se as j,Ae as k,O as l,ke as m,F as n,le as o,B as p,Oe as r,P as s,oe as t,E as u,me as v,W as w,ce as x,be as y};