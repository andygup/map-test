import{$T as e,Bp as t,DS as n,En as r,Gp as i,Lv as a,Rv as o,Z_ as s,xd as c}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import{i as l,n as u,r as d}from"./featureConversionUtils-o9-cJXzl.js";import"./WhereClause-CATd9kVz.js";import"./closestPointOnCurve-CwZL45U3.js";import"./WhereClauseCache-BO4WYMj9.js";import"./PooledRBush-BH7_Gu1G.js";import"./QueryEngineCapabilities-CxeEdoTy.js";import{n as f,r as p,t as m}from"./clientSideDefaults-Iizf0eUh.js";import"./generateRendererUtils-DGV_dTnd.js";import"./utils-DCGMUq-q.js";import"./BoundsStore-DE7p6f_c.js";import"./timeSupport-vK4lVcYW.js";import"./optimizedFeatureQueryEngineAdapter-DQyaY_b1.js";import{t as h}from"./FeatureStore-DxVA8hqB.js";import{t as g}from"./QueryEngine-CD8WljsT.js";import{c as _,l as v}from"./queryUtils-DGU5ISbw.js";import"./utils-Bftaersa.js";import"./utils-BizEctJo.js";import"./SnappingCandidate-4DPnOY6Y.js";import"./FixedIntervalBinParameters-CMgMaWGN.js";import{n as y,t as b}from"./objectIdUtils-Ye-ovgo-.js";import"./date-DluEMNTt.js";import{a as x,i as S,n as C,o as w,r as T,t as E}from"./sourceUtils-DJLVoxjN.js";var D=n,O={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:n},k={hasAttachments:!1,capabilities:`query, editing, create, delete, update`,useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsQueryAttachmentOrderByFields:!1,supportsQueryAttachmentWithTypeWildcard:!1,supportsQueryBins:!0,supportsQueryPivot:!1,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!0,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0,supportsQueryWithCacheHint:!0},queryBinsCapabilities:C};function A(e){return a(e)?e.z!=null:!!e.hasZ}function j(e){return a(e)?e.m!=null:!!e.hasM}var M=class{constructor(){this._queryEngine=null,this._nextObjectId=null}destroy(){this._queryEngine?.destroy(),this._queryEngine=this._createDefaultAttributes=null}async load(n){let a=[],{features:o}=n,s=this._inferLayerProperties(o,n.fields),l=n.fields||[],u=n.hasM==null?!!s.hasM:n.hasM,d=n.hasZ==null?!!s.hasZ:n.hasZ,v=!n.spatialReference&&!s.spatialReference,y=v?D:n.spatialReference||s.spatialReference,x=v?O:null,S=n.geometryType||s.geometryType,C=!S,w=n.objectIdField||s.objectIdField,T=n.timeInfo,E=new r(l);if(!C&&(v&&a.push({name:`feature-layer:spatial-reference-not-found`,message:`Spatial reference not provided or found in features. Defaults to WGS84`}),!S))throw new e(`feature-layer:missing-property`,`geometryType not set and couldn't be inferred from the provided features`);if(!w)throw new e(`feature-layer:missing-property`,`objectIdField not set and couldn't be found in the provided fields`);if(s.objectIdField&&w!==s.objectIdField&&(a.push({name:`feature-layer:duplicated-oid-field`,message:`Provided objectIdField "${w}" doesn't match the field name "${s.objectIdField}", found in the provided fields`}),w=s.objectIdField),w&&!s.objectIdField){let e=E.get(w);e?(w=e.name,e.type=`esriFieldTypeOID`,e.editable=!1,e.nullable=!1):l.unshift({alias:w,name:w,type:`esriFieldTypeOID`,editable:!1,nullable:!1})}for(let t of l){if(t.name??=t.alias,t.alias??=t.name,!t.name)throw new e(`feature-layer:invalid-field-name`,`field name is missing`,{field:t});if(t.name===w&&(t.type=`esriFieldTypeOID`),!c.jsonValues.includes(t.type))throw new e(`feature-layer:invalid-field-type`,`invalid type for field "${t.name}"`,{field:t});t.length??=i(t)}let A={};for(let e of l)if(e.type!==`esriFieldTypeOID`&&e.type!==`esriFieldTypeGlobalID`){let n=t(e);n!==void 0&&(A[e.name]=n)}if(T){if(T.startTimeField){let e=E.get(T.startTimeField);e?(T.startTimeField=e.name,e.type=`esriFieldTypeDate`):T.startTimeField=null}if(T.endTimeField){let e=E.get(T.endTimeField);e?(T.endTimeField=e.name,e.type=`esriFieldTypeDate`):T.endTimeField=null}if(T.trackIdField){let e=E.get(T.trackIdField);e?T.trackIdField=e.name:(T.trackIdField=null,a.push({name:`feature-layer:invalid-timeInfo-trackIdField`,message:`trackIdField is missing`,details:{timeInfo:T}}))}T.startTimeField||T.endTimeField||(a.push({name:`feature-layer:invalid-timeInfo`,message:`startTimeField and endTimeField are missing or invalid`,details:{timeInfo:T}}),T=null)}let j=E.dateFields.length?{timeZoneIANA:n.dateFieldsTimeZone??`UTC`}:null;this._createDefaultAttributes=m(A,w);let M={warnings:a,featureErrors:[],layerDefinition:{...k,drawingInfo:p(S),templates:f(A),extent:x,geometryType:S,objectIdField:w,fields:l,hasZ:d,hasM:u,timeInfo:T,dateFieldsTimeReference:j},assignedObjectIds:{}},N={type:`object-id`,fieldName:w};return this._queryEngine=new g({fieldsIndex:r.fromLayerJSON({fields:l,timeInfo:T,dateFieldsTimeReference:j}),geometryType:S,hasM:u,hasZ:d,featureIdInfo:N,spatialReference:y,featureStore:new h({geometryType:S,hasM:u,hasZ:d}),timeInfo:T}),o?.length?(this._nextObjectId=b(w,o)+1,await _(o,y),this._loadInitialFeatures(M,o)):(this._nextObjectId=1,M)}async applyEdits(e){let{spatialReference:t,geometryType:n}=this._queryEngine;return await Promise.all([E(t,n),_(e.adds,t),_(e.updates,t)]),this._applyEdits(e)}queryFeatures(e,t={}){return this._queryEngine.executeQuery(e,t.signal)}queryFeatureCount(e,t={}){return this._queryEngine.executeQueryForCount(e,t.signal)}queryObjectIds(e,t={}){return this._queryEngine.executeQueryForIds(e,t.signal)}queryExtent(e,t={}){return this._queryEngine.executeQueryForExtent(e,t.signal)}querySnapping(e,t={}){return this._queryEngine.executeQueryForSnapping(e,t.signal)}queryAttributeBins(e,t={}){return this._queryEngine.executeAttributeBinsQuery(e,t.signal)}_inferLayerProperties(e,t){let n,r,i=null,a=null,s=null;for(let t of e){let e=t.geometry;if(e!=null&&(i||=o(e),a||=e.spatialReference,n??=A(e),r??=j(e),i&&a&&n!=null&&r!=null))break}if(t&&t.length){let e=null;t.some(t=>{let n=t.type===`esriFieldTypeOID`,r=!t.type&&t.name&&t.name.toLowerCase()===`objectid`;return e=t,n||r})&&(s=e.name)}return{geometryType:i,spatialReference:a,objectIdField:s,hasM:r,hasZ:n}}async _loadInitialFeatures(e,t){let{geometryType:n,hasM:r,hasZ:i,objectIdField:a,spatialReference:s,featureStore:c,fieldsIndex:l}=this._queryEngine,u=[],f={type:`object-id`,fieldName:a};for(let r of t){if(r.uid!=null&&(e.assignedObjectIds[r.uid]=-1),r.geometry&&n!==o(r.geometry)){e.featureErrors.push(w(`Incorrect geometry type.`));continue}let t=this._createDefaultAttributes(),i=T(l,t,r.attributes,!0);i?e.featureErrors.push(i):(this._assignObjectId(t,r.attributes,!0),r.attributes=t,r.uid!=null&&(e.assignedObjectIds[r.uid]=r.attributes[a]),r.geometry!=null&&(r.geometry=v(r.geometry,r.geometry.spatialReference,s)),u.push(r))}c.addMany(d([],u,n,i,r,f));let{fullExtent:p,timeExtent:m}=await this._queryEngine.fetchRecomputedExtents();if(e.layerDefinition.extent=p,m){let{start:t,end:n}=m;e.layerDefinition.timeInfo.timeExtent=[t,n]}return e}async _applyEdits(e){let{adds:t,updates:n,deletes:r}=e,i={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t?.length&&this._applyAddEdits(i,t),n?.length&&this._applyUpdateEdits(i,n),r?.length){for(let e of r)i.deleteResults.push(S(e));this._queryEngine.featureStore.removeManyById(r)}let{fullExtent:a,timeExtent:o}=await this._queryEngine.fetchRecomputedExtents();return{extent:a,timeExtent:o,featureEditResults:i}}_applyAddEdits(e,t){let{addResults:n}=e,{geometryType:r,hasM:i,hasZ:a,objectIdField:s,spatialReference:c,featureStore:l,featureIdInfo:u,fieldsIndex:f}=this._queryEngine,p=[];for(let i of t){if(i.geometry&&r!==o(i.geometry)){n.push(w(`Incorrect geometry type.`));continue}let t=this._createDefaultAttributes(),a=T(f,t,i.attributes);if(a)n.push(a);else{if(this._assignObjectId(t,i.attributes),i.attributes=t,i.uid!=null){let t=i.attributes[s];e.uidToObjectId[i.uid]=t}if(i.geometry!=null){let e=i.geometry.spatialReference??c;i.geometry=v(x(i.geometry,e),e,c)}p.push(i),n.push(S(i.attributes[s]))}}l.addMany(d([],p,r,a,i,u))}_applyUpdateEdits({updateResults:e},t){let{geometryType:n,hasM:r,hasZ:i,objectIdField:a,spatialReference:s,featureStore:c,fieldsIndex:d,featureIdInfo:f}=this._queryEngine;for(let p of t){let{attributes:t,geometry:m}=p,h=t?.[a];if(h==null){e.push(w(`Identifier field ${a} missing`));continue}if(!c.has(h)){e.push(w(`Feature with object id ${h} missing`));continue}let g=l(c.getFeature(h),n,i,r);if(m!=null){if(n!==o(m)){e.push(w(`Incorrect geometry type.`));continue}let t=m.spatialReference??s;g.geometry=v(x(m,t),t,s)}if(t){let n=T(d,g.attributes,t);if(n){e.push(n);continue}}c.add(u(g,n,i,r,f)),e.push(S(h))}}_assignObjectId(e,t,n=!1){let r=this._queryEngine.objectIdField;n&&t&&isFinite(t[r])?e[r]=t[r]:e[r]=this._nextObjectId++}};export{M as default};