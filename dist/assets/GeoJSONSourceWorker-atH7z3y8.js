import{Ap as e,BT as t,B_ as n,Dv as r,En as i,Fp as a,RS as o,_S as s,dd as c,dg as l,mS as u,qw as d,uE as f}from"./index-ByaFsVj4.js";import"./memoryEstimations-C5pKF3kD.js";import"./OptimizedGeometry-DX91by73.js";import"./OptimizedFeatureSet-DAaREXtE.js";import{a as p,i as m,n as h,r as g,s as _}from"./featureConversionUtils-C045qQF5.js";import"./WhereClause-BExEDKCy.js";import"./WhereClauseCache-DsaoFJQA.js";import"./PooledRBush-7ERPfn8O.js";import"./QueryEngineCapabilities-COyCnRVj.js";import{n as v,r as y,t as b}from"./clientSideDefaults-8lL7sncR.js";import"./generateRendererUtils-D58mgMfu.js";import"./utils-2pGpZYJj.js";import"./BoundsStore-CXNHxGlb.js";import"./timeSupport-BE8MSrm_.js";import"./optimizedFeatureQueryEngineAdapter-CqB9xdgB.js";import{t as x}from"./FeatureStore-B4F50Cpk.js";import{t as S}from"./QueryEngine-D34fwTUK.js";import{c as C,l as w}from"./queryUtils-DJQEBA7c.js";import"./quantizationUtils-CzrQVcZ1.js";import"./utils-WI4_77dW.js";import"./utils-BV18to1a.js";import"./SnappingCandidate-BMrZX9Ey.js";import"./FixedIntervalBinParameters-CVvi6EKG.js";import"./date-DKxAu4UK.js";import{n as T,r as E,t as D}from"./geojson-DV2DU2io.js";import{a as O,i as k,n as A,o as j,r as M,t as N}from"./sourceUtils-CsjYU-YT.js";var P={hasAttachments:!1,capabilities:`query, editing, create, delete, update`,useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsQueryAttachmentOrderByFields:!1,supportsQueryAttachmentWithTypeWildcard:!1,supportsQueryBins:!0,supportsQueryPivot:!1,supportsQueryWithCacheHint:!0,supportsQueryWithDistance:!0,supportsQueryWithResultType:!0,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0},queryBinsCapabilities:A},F=class{constructor(){this._queryEngine=null,this._snapshotFeatures=async e=>{let t=await this._fetch(e);return this._createFeatures(t)}}destroy(){this._queryEngine?.destroy(),this._queryEngine=this._createDefaultAttributes=null}async load(n,r={}){this._loadOptions={url:n.url,customParameters:n.customParameters};let o=[],[s]=await Promise.all([n.url?this._fetch(r?.signal):null,this._checkProjection(n.spatialReference)]),l=E(s,{geometryType:n.geometryType}),d=n.fields||l.fields||[],f=n.hasZ==null?l.hasZ:n.hasZ,p=l.geometryType,m=n.objectIdField||l.objectIdFieldName||`__OBJECTID`,h=n.spatialReference||u,g=n.timeInfo;d===l.fields&&l.unknownFields.length>0&&o.push({name:`geojson-layer:unknown-field-types`,message:`Some fields types couldn't be inferred from the features and were dropped`,details:{unknownFields:l.unknownFields}});let _=new i(d),C=_.get(m);C?(C.type!==`esriFieldTypeString`&&(C.type=`esriFieldTypeOID`),C.editable=!1,C.nullable=!1,m=C.name):(C={alias:m,name:m,type:l.objectIdFieldType===`string`?`esriFieldTypeString`:`esriFieldTypeOID`,editable:!1,nullable:!1},d.unshift(C));let w={};for(let n of d){if(n.name??=n.alias,n.alias??=n.name,!n.name)throw new t(`geojson-layer:invalid-field-name`,`field name is missing`,{field:n});if(!c.jsonValues.includes(n.type))throw new t(`geojson-layer:invalid-field-type`,`invalid type for field "${n.name}"`,{field:n});if(n.name!==C.name){let t=e(n);t!==void 0&&(w[n.name]=t)}n.length??=a(n)}if(g){if(g.startTimeField){let e=_.get(g.startTimeField);e?(g.startTimeField=e.name,e.type=`esriFieldTypeDate`):g.startTimeField=null}if(g.endTimeField){let e=_.get(g.endTimeField);e?(g.endTimeField=e.name,e.type=`esriFieldTypeDate`):g.endTimeField=null}if(g.trackIdField){let e=_.get(g.trackIdField);e?g.trackIdField=e.name:(g.trackIdField=null,o.push({name:`geojson-layer:invalid-timeInfo-trackIdField`,message:`trackIdField is missing`,details:{timeInfo:g}}))}g.startTimeField||g.endTimeField||(o.push({name:`geojson-layer:invalid-timeInfo`,message:`startTimeField and endTimeField are missing`,details:{timeInfo:g}}),g=null)}let T=p?y(p):void 0,D=_.dateFields.length?{timeZoneIANA:`UTC`}:null,O={warnings:o,featureErrors:[],layerDefinition:{...P,drawingInfo:T??void 0,templates:v(w),extent:void 0,geometryType:p,objectIdField:m,fields:d,hasZ:!!f,timeInfo:g,dateFieldsTimeReference:D}},k={type:`object-id`,fieldName:m};this._queryEngine=new S({fieldsIndex:i.fromLayerJSON({fields:d,timeInfo:g,dateFieldsTimeReference:D}),geometryType:p,hasM:!1,hasZ:f,featureIdInfo:k,spatialReference:h,timeInfo:g,featureStore:new x({geometryType:p,hasM:!1,hasZ:f})});let A=this._queryEngine.fieldsIndex.requiredFields.indexOf(C);A>-1&&this._queryEngine.fieldsIndex.requiredFields.splice(A,1),this._createDefaultAttributes=b(w,m);let j=this._createFeatures(s);this._objectIdGenerator=this._createObjectIdGenerator(this._queryEngine,j);let M=this._normalizeFeatures(j,O.featureErrors);this._queryEngine.featureStore.addMany(M);let{fullExtent:N,timeExtent:F}=await this._queryEngine.fetchRecomputedExtents();if(O.layerDefinition.extent=N,F){let{start:e,end:t}=F;O.layerDefinition.timeInfo.timeExtent=[e,t]}return O}async applyEdits(e){let{spatialReference:t,geometryType:n}=this._queryEngine;return await Promise.all([N(t,n),C(e.adds,t),C(e.updates,t)]),await this._waitSnapshotComplete(),this._applyEdits(e)}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),await this._queryEngine.executeQueryForSnapping(e,t.signal)}async queryAttributeBins(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeAttributeBinsQuery(e,t.signal)}async refresh(e){this._loadOptions.customParameters=e,this._snapshotTask?.abort(),this._snapshotTask=l(this._snapshotFeatures),this._snapshotTask.promise.then(e=>{this._queryEngine.featureStore.clear(),this._objectIdGenerator=this._createObjectIdGenerator(this._queryEngine,e);let t=this._normalizeFeatures(e);t&&this._queryEngine.featureStore.addMany(t)},e=>{this._queryEngine.featureStore.clear(),d(e)||f.getLogger(`esri.layers.GeoJSONLayer`).error(new t(`geojson-layer:refresh`,`An error occurred during refresh`,{error:e}))}),await this._waitSnapshotComplete();let{fullExtent:n,timeExtent:r}=await this._queryEngine.fetchRecomputedExtents();return{extent:n,timeExtent:r}}_createFeatures(e){if(e==null)return[];let{geometryType:t,hasZ:n,objectIdField:r}=this._queryEngine,i=T(e,{geometryType:t,hasZ:n,objectIdField:r});if(!s(this._queryEngine.spatialReference,u))for(let e of i)e.geometry!=null&&(e.geometry=p(w(_(e.geometry,this._queryEngine.geometryType,this._queryEngine.hasZ,!1),u,this._queryEngine.spatialReference)));return i}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _fetch(e){let{url:t,customParameters:n}=this._loadOptions,r=(await o(t??``,{responseType:`json`,query:{...n},signal:e})).data;return D(r),r}_normalizeFeatures(e,t){let{objectIdField:n,fieldsIndex:r}=this._queryEngine,i=[];for(let a of e){let e=this._createDefaultAttributes(),o=M(r,e,a.attributes,!0);o?t?.push(o):(this._assignObjectId(e,a.attributes,!0),a.attributes=e,a.objectId=e[n],i.push(a))}return i}async _applyEdits(e){let{adds:t,updates:n,deletes:r}=e,i={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t?.length&&this._applyAddEdits(i,t),n?.length&&this._applyUpdateEdits(i,n),r?.length){for(let e of r)i.deleteResults.push(k(e));this._queryEngine.featureStore.removeManyById(r)}let{fullExtent:a,timeExtent:o}=await this._queryEngine.fetchRecomputedExtents();return{extent:a,timeExtent:o,featureEditResults:i}}_applyAddEdits(e,t){let{addResults:n}=e,{geometryType:i,hasM:a,hasZ:o,objectIdField:s,spatialReference:c,featureStore:l,fieldsIndex:u}=this._queryEngine,d=[],f={type:`object-id`,fieldName:s};for(let a of t){if(a.geometry&&i!==r(a.geometry)){n.push(j(`Incorrect geometry type.`));continue}let t=this._createDefaultAttributes(),o=M(u,t,a.attributes);if(o)n.push(o);else{if(this._assignObjectId(t,a.attributes),a.attributes=t,a.uid!=null){let t=a.attributes[s];e.uidToObjectId[a.uid]=t}if(a.geometry!=null){let e=a.geometry.spatialReference??c;a.geometry=w(O(a.geometry,e),e,c)}d.push(a),n.push(k(a.attributes[s]))}}l.addMany(g([],d,i,o,a,f))}_applyUpdateEdits({updateResults:e},t){let{geometryType:n,hasM:i,hasZ:a,objectIdField:o,spatialReference:s,featureStore:c,fieldsIndex:l}=this._queryEngine,u={type:`object-id`,fieldName:o};for(let d of t){let{attributes:t,geometry:f}=d,p=t?.[o];if(p==null){e.push(j(`Identifier field ${o} missing`));continue}if(!c.has(p)){e.push(j(`Feature with object id ${p} missing`));continue}let g=m(c.getFeature(p),n,a,i);if(f!=null){if(n!==r(f)){e.push(j(`Incorrect geometry type.`));continue}let t=f.spatialReference??s;g.geometry=w(O(f,t),t,s)}if(t){let n=M(l,g.attributes,t);if(n){e.push(n);continue}}c.add(h(g,n,a,i,u)),e.push(k(p))}}_createObjectIdGenerator(e,t){let n=e.fieldsIndex.get(e.objectIdField);if(n.type===`esriFieldTypeString`)return()=>n.name+`-`+Date.now().toString(16);let r=-1/0;for(let e of t)e.objectId&&(r=Math.max(r,e.objectId));return r=Math.max(0,r)+1,()=>r++}_assignObjectId(e,t,n=!1){let r=this._queryEngine.objectIdField;e[r]=n&&r in t?t[r]:this._objectIdGenerator()}async _checkProjection(e){try{await C(u,e)}catch{throw new t(`geojson-layer`,`Projection not supported`)}}};export{F as default};