import{$T as e,Aw as t,BT as n,Bv as r,CE as i,Ed as a,Ix as o,VT as s,hv as c,iw as l,kD as u,kv as d,lv as f,mv as p,nd as m,ns as h,os as g,pv as _,rs as v,tg as y,vE as b,vx as x,zT as S}from"./index-BN8X5Ryz.js";import{a as C}from"./layerViewUtils-CJcMVuwG.js";import{t as w}from"./Container-uEjPEzbR.js";function T(e){return typeof e==`object`&&!!e&&e.type===`2d`&&e.view2dType===`linkchart`}var E=class extends t{constructor(){super(...arguments),this._idToCounters=new a}get size(){return this._idToCounters.size}get objectIds(){return this._idToCounters.keys()}get highlightNamesByObjectId(){return D(this._idToCounters)}add(e,t){let n=!1;for(let r of e){let e=b(this._idToCounters,r,()=>(n=!0,new Map)),i=e.get(t)??0;i||(n=!0),e.set(t,i+1)}return n}delete(e,t){let n=!1;for(let r of e){let e=this._idToCounters.get(r);if(!e)continue;let i=e.get(t);i!=null&&(i--,i>0?e.set(t,i):(e.delete(t),n=!0),e.size===0&&(this._idToCounters.delete(r),n=!0))}return n}};function*D(e){for(let[t,n]of e)yield[t,n.keys()]}E=u([s(`esri.views.2d.layers.support.HighlightCounter`)],E);var O=class extends l{get version(){return this.commitVersionProperties(),(this._get(`version`)||0)+1}};u([n({readOnly:!0})],O.prototype,`version`,null),O=u([s(`esri.views.layers.support.ClipArea`)],O);var k,A=k=class extends O{constructor(e){super(e),this.type=`rect`,this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new k({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty(`left`),this.commitProperty(`right`),this.commitProperty(`top`),this.commitProperty(`bottom`)}};u([n({type:[Number,String],json:{write:!0}})],A.prototype,`left`,void 0),u([n({type:[Number,String],json:{write:!0}})],A.prototype,`right`,void 0),u([n({type:[Number,String],json:{write:!0}})],A.prototype,`top`,void 0),u([n({type:[Number,String],json:{write:!0}})],A.prototype,`bottom`,void 0),A=k=u([s(`esri.views.layers.support.ClipRect`)],A);var j,M={base:o,key:`type`,typeMap:{extent:x,polygon:r}},N=j=class extends O{constructor(e){super(e),this.type=`geometry`,this.geometry=null}clone(){return new j({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty(`geometry`)}};u([n({types:M,json:{read:d,write:!0}})],N.prototype,`geometry`,void 0),N=j=u([s(`esri.views.layers.support.GeometryClipArea`)],N);var P=class extends O{constructor(e){super(e),this.type=`path`,this.path=[]}commitVersionProperties(){this.commitProperty(`path`)}};u([n({type:[[[Number]]],json:{write:!0}})],P.prototype,`path`,void 0),P=u([s(`esri.views.layers.support.Path`)],P);var F=c.ofType({key:`type`,base:null,typeMap:{rect:A,path:P,geometry:N}}),I=new(c.ofType(m)),L=t=>{let r=t,a=class extends r{constructor(){super(...arguments),this._highlightCounter=new E,this.attached=!1,this.clips=new F,this.highlights=null,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this._visibleAtCurrentScale=!0}initialize(){let t=this.view?.spatialReferenceLocked??!0;this.view?.spatialReference&&t&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new e(`layerview:spatial-reference-incompatible`,`The spatial reference of this layer does not meet the requirements of the view`,{layer:this.layer}))):(this.container||=new w,this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([_(()=>this.suspended,e=>{this.container&&(this.container.visible=!e)},p),_(()=>this.updateSuspended,e=>{this.view&&!e&&this.updateRequested&&this.view.requestUpdate()},p),_(()=>this.layer?.opacity??1,e=>{this.container&&(this.container.opacity=e)},p),_(()=>this.layer&&`blendMode`in this.layer?this.layer.blendMode:`normal`,e=>{this.container&&(this.container.blendMode=e)},p),_(()=>this.layer&&`effect`in this.layer?this.layer.effect:null,e=>{this.container&&(this.container.effect=e)},p),_(()=>this._mergedHighlights.items.map(e=>({name:e.name,options:{fillColor:e.color,haloColor:e.haloColor,fillOpacity:e.fillOpacity,haloOpacity:e.haloOpacity,haloWidth:e.haloWidth,haloBlur:e.haloBlur}})),()=>{this.container.highlightGradient=g(this.container.highlightGradient,this._mergedHighlights.items)},p),_(()=>this._mergedHighlights.items.map(e=>e.name),()=>{this._processHighlight()}),f(()=>this.clips,`change`,()=>{this.container&&(this.container.clips=this.clips)},p),_(()=>({scale:this.view?.scale,scaleRange:this.layer&&`effectiveScaleRange`in this.layer?this.layer.effectiveScaleRange:null}),({scale:e,scaleRange:t})=>{let n=C(t,e);n!==this._visibleAtCurrentScale&&(this._visibleAtCurrentScale=n)},p)],`constructor`),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(e=>{e===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get highlightOptions(){return this._logHighlightOptionsDeprecation(),v(this)}set highlightOptions(e){this._logHighlightOptionsDeprecation(),h(this,e)}_logHighlightOptionsDeprecation(){S(i.getLogger(this),"`LayerView.highlightOptions` is deprecated in favor of View.highlights",{replacement:`View.highlights`,version:`4.34`,see:`https://arcg.is/inbTa1#highlights`,warnOnce:!0})}get hasHighlight(){return this._highlightCounter.size>0}get _mergedHighlights(){if(!this.view)return I;if(!this.highlights)return this.view.highlights;let e=this.view.highlights.clone();for(let t of this.highlights){let n=e.find(e=>e.name===t.name);n&&n.assignFrom(t)}return e}get highlightIds(){return Array.from(this._highlightCounter.objectIds)}get scheduler(){return this.view.scheduler}get spatialReferenceSupported(){let e=this.view?.spatialReference;return e==null||this.supportsSpatialReference(e)}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this._updatingHandles?.updating||this.container.transitioning)}get visibleAtCurrentScale(){return this._visibleAtCurrentScale}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles(`attach`),this.detach(),this.updateRequested=!1)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.updateSuspended||this.view.requestUpdate())}processUpdate(e){!this.isFulfilled()||this.isResolved()?(this._set(`updateParameters`,e),this.updateRequested&&!this.updateSuspended&&(this.updateRequested=!1,this.update(e))):this.updateRequested=!1}hitTest(e,t){return Promise.resolve(null)}supportsSpatialReference(e){return!0}canResume(){if(!this.spatialReferenceSupported)return!1;switch(this.layer?.type){case`link-chart`:case`knowledge-graph-sublayer`:case`graphics`:break;default:if(T(this.view)&&!this.view.inGeographicLayout)return!1}return!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){let e=super.getSuspendInfo(),t=!this.spatialReferenceSupported;return t&&(e.spatialReferenceNotSupported=t),e}addAttachHandles(e){this.addHandles(e,`attach`)}_addHighlights(e,t){this._highlightCounter.add(e,t)&&this._processHighlight()}_removeHighlights(e,t){this._highlightCounter.delete(e,t)&&this._processHighlight()}_processHighlight(){}_getHighlights(){let e=[];for(let[t,n]of this._highlightCounter.highlightNamesByObjectId){let r=this._getHighlightBits(n);e.push({objectId:t,highlightFlags:r})}return e}_getHighlightBits(e){let t=new Set(e),n=1,r=0;if(!this.view)return 0;let i=this._mergedHighlights;for(let{name:e}of i)t.delete(e)&&(r=n),n<<=1;return r}};return u([n()],a.prototype,`attached`,void 0),u([n({type:F,set(e){let t=y(e,this._get(`clips`),F);this._set(`clips`,t)}})],a.prototype,`clips`,void 0),u([n()],a.prototype,`container`,void 0),u([n({type:m})],a.prototype,`highlightOptions`,null),u([n({type:c.ofType(m)})],a.prototype,`highlights`,void 0),u([n()],a.prototype,`_mergedHighlights`,null),u([n()],a.prototype,`moving`,void 0),u([n({readOnly:!0})],a.prototype,`spatialReferenceSupported`,null),u([n({readOnly:!0})],a.prototype,`updateParameters`,void 0),u([n()],a.prototype,`updateRequested`,void 0),u([n()],a.prototype,`updating`,null),u([n()],a.prototype,`view`,void 0),u([n()],a.prototype,`_visibleAtCurrentScale`,void 0),u([n({readOnly:!0})],a.prototype,`visibleAtCurrentScale`,null),a=u([s(`esri.views.2d.layers.LayerView2D`)],a),a};export{N as n,L as t};