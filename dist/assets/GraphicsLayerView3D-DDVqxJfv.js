const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/LineCallout.glsl-BrbLpQfv.js","assets/LineCallout.glsl-D6ln7DXm.js","assets/index-BN8X5Ryz.js","assets/index-CWJhHB6-.css","assets/Slice.glsl-DU3Ivhcc.js","assets/Float3DrawUniform-ua6q6ZtZ.js","assets/Uniform-C_fuiTP5.js","assets/glsl-BMw-Ib6r.js","assets/HUDVisibility.glsl-DO8Yaq72.js","assets/VerticalOffset.glsl-VrGhTlbS.js","assets/ScreenSizePerspective.glsl-BuhoSJZ3.js","assets/Float3PassUniform-SaBA6LBM.js","assets/View.glsl-CPcmVaet.js","assets/Float3BindUniform-BDFedz_d.js","assets/FloatBindUniform-CXY5KrrB.js","assets/Matrix4BindUniform-D7U89BGU.js","assets/Float4PassUniform-C4TO8dd0.js","assets/BooleanBindUniform-Dgbi5WXL.js","assets/Float4BindUniform-DpoBnM9l.js","assets/FloatPassUniform-CSAt82xV.js","assets/Texture2DBindUniform-Btzx3XRx.js","assets/ReadDepth.glsl-CX2bpX_x.js","assets/Float2BindUniform-D7Jg9GMR.js","assets/Float2PassUniform-DUyrQoTC.js","assets/ShaderBuilder-BLOqjpgt.js","assets/NoParameters-BDE7RvXT.js","assets/Graphics3DSymbolLayerFactory-DSz3WE0x.js","assets/ColorMaterial.glsl-Bt7WM1mm.js","assets/Transform.glsl-2U1BxklA.js","assets/VisualVariables.glsl-1DqsizMu.js","assets/FloatsPassUniform-DKsLDw29.js","assets/AlphaCutoff-WIqqBGOV.js","assets/HighlightReadBitmap.glsl-BBr-esSE.js","assets/ObjectAndLayerIdColor.glsl-BHzrt-xI.js","assets/VertexColor.glsl-_MhPfHih.js","assets/TerrainDepthTest.glsl-D7e23Ppb.js","assets/OutputColorHighlightOLID.glsl-CoP020fC.js","assets/Emissions.glsl-C_Yvv-sZ.js","assets/Texture2DDrawUniform-jqrXjxoW.js","assets/Texture2DPassUniform-DFWoDpEL.js","assets/DefaultMaterial.glsl-pmrJSA2T.js","assets/ReadShadowMap.glsl-DMCvezCI.js","assets/PiUtils.glsl-IDKkXUQy.js","assets/MixExternalColor.glsl-D0GjeJQe.js","assets/SnowCover.glsl-DvDl-UAS.js","assets/SSAO.glsl-xhx5R_Qb.js","assets/ScreenSpacePass.glsl-QJ_LkLYn.js","assets/CameraSpace.glsl-BqHBV5nH.js","assets/SSAOBlur.glsl-C8iS6qjP.js","assets/Float2DrawUniform-3WoZLC1o.js","assets/SceneLighting-LJvcoD7s.js","assets/sphere-d9-4vNcj.js","assets/vectorStacks-Cuo89CNO.js","assets/quatf64-D37SEdPg.js","assets/vec3-B94Y7ih2.js","assets/plane-Da5EsY0J.js","assets/ray-LkJ58wpZ.js","assets/ObjectStack-l5kM7JZu.js","assets/projectPointToVector-BkRdoTqD.js","assets/projectVectorToVector-DGzn2p7I.js","assets/dehydratedPoint-CWZQBefp.js","assets/frustum-LgSQ4wIS.js","assets/lineSegment-BudcKS0C.js","assets/orientedBoundingBox-Bd4igSGQ.js","assets/quat-C8PgLo31.js","assets/computeTranslationToOriginAndRotation-0WDVmpJG.js","assets/spatialReferenceEllipsoidUtils-qw9wv8RL.js","assets/HUDIntersectorResult-C5AENPbM.js","assets/VertexAttributeLocations-BScEla0R.js","assets/VertexElementDescriptor-Cl_nC_ty.js","assets/renderState-BaFdYDAL.js","assets/IntegerPassUniform-CdQB44QJ.js","assets/Matrix4PassUniform-CDJEQqiQ.js","assets/MaterialUtil-CcE5uVnF.js","assets/Normals.glsl-Dm_iDce_.js","assets/HUDMaterial.glsl-CIbE2wvS.js","assets/HighlightApply.glsl-C2uw2Uqi.js","assets/HighlightDownsample.glsl-CHTjOIMl.js","assets/HighlightCellGridScreenSpacePass.glsl-BYepSulG.js","assets/HighlightBlur.glsl-Bcasx3G3.js","assets/HighlightToSingle.glsl-DnQ7SOsv.js","assets/LineMarker.glsl-DnVbe9A2.js","assets/MarkerSizing.glsl-nslzooYm.js","assets/NativeLine.glsl-D7AF8cgC.js","assets/OverlayCompositing.glsl-qGsngx-I.js","assets/Path.glsl-Cftlm3XW.js","assets/NormalUtils.glsl-CQqskpJG.js","assets/Pattern.glsl-D9hftdA3.js","assets/RealisticTree.glsl-DAC1hFJj.js","assets/RibbonLine.glsl-CfmEn9-p.js","assets/TextureOnly.glsl-DvvGRcsb.js","assets/WaterSurface.glsl-U1ahhBf-.js","assets/weather-D4qJROgB.js","assets/earcut-CEMcWA4Z.js","assets/indexUtils-BSuZn8vT.js","assets/Indices-tJiSUK6w.js","assets/vec3-B5yu4INg.js","assets/vec4-BLZ_ZPtE.js","assets/BidiEngine-DvXbVJau.js","assets/CIMSymbolHelper-B2DBxDPE.js","assets/rasterizingUtils-BsmZb-O9.js","assets/labelPoint-1O-zXr9b.js","assets/OptimizedGeometry-BQJ7w5VU.js","assets/memoryEstimations-D_IbKyOk.js","assets/GeometryUtils-B-8QW9FG.js","assets/Rect-LbcnjDUG.js","assets/BoundingBox-Dtf81F-g.js","assets/NestedMap-BpsBVffk.js","assets/devEnvironmentUtils-Yxtjm7qW.js","assets/vec3f32-DDMWoxUL.js","assets/FloatArray-Dt98pDp2.js","assets/BufferView-BW77W5ev.js","assets/Util-BQgFCZvD.js","assets/types-BEunqM4i.js","assets/graphicUtils-Ct1OT6JD.js","assets/meshVertexSpaceUtils-s2jLb8qI.js","assets/MeshLocalVertexSpace-vomIk0sx.js","assets/hydratedFeatures-Cf3ay5ZM.js","assets/DefaultBufferWriter-BGKzMKkp.js","assets/triangle-46ad8nAb.js","assets/MeshComponent-BFk18JiH.js","assets/MeshMaterialMetallicRoughness-Bdr2gXmV.js","assets/meshCloneUtils-BXMzy817.js","assets/meshProperties-CbjLwdbT.js","assets/Normals-B0YlgMdD.js","assets/axisAngleDegrees-DzAS4tF-.js","assets/deduplicate-D-tDe87s.js","assets/projectMeshVertexPositions-DdUIdZ5I.js","assets/vertexSpaceConversion-Dz87RqR7.js","assets/triangulationUtils-DNxIB1ux.js","assets/SnappingCandidate-4DPnOY6Y.js","assets/videoUtils-CRYmuPNe.js","assets/ManagedTexture-DgNSfAYU.js","assets/image-CmtRVQsT.js","assets/pointUtils-BP9nRZeK.js","assets/ElevationContext-BzXFRbX1.js","assets/Octree-czER3kAP.js","assets/primitiveObjectSymbolUtils-fz701Tc0.js","assets/Intersector-DL9RPLNy.js","assets/symbolColorUtils-KqO0oQTm.js","assets/DefaultMaterial-BVbzHMdq.js","assets/VertexBuffer-Ra4pb4dR.js","assets/BufferObject-B3_aJU6V.js","assets/cimSymbolUtils-CLt57XQ8.js","assets/utils-BGjabRH0.js","assets/webStyleSymbolUtils-DnfhffQg.js","assets/DefaultLayouts-D2eBAPD-.js","assets/TextureBackedBufferLayout-C3PSJOOo.js","assets/VertexArrayObject-ChtD6bwg.js","assets/objectResourceUtils-BGpN_4t9.js","assets/resourceUtils-BhD6CfOV.js","assets/placementUtils-BiPNPByu.js","assets/sdfPrimitives-BR6xMvJc.js"])))=>i.map(i=>d[i]);
import{$S as e,$T as t,$l as n,$p as r,AS as i,Af as a,Aw as o,BT as s,Bv as c,CD as l,CE as u,Cf as d,ED as f,ET as p,Ex as ee,Fd as te,Ff as ne,Gd as m,Gg as re,Gr as ie,Hl as ae,Id as oe,If as se,J as ce,Jf as le,Ju as ue,Kd as de,Kr as h,Lg as fe,Lx as pe,Mf as me,Nb as he,Nl as g,Od as ge,Q as _e,Ql as ve,Rh as ye,Rl as _,SE as be,Sf as xe,Sw as Se,TE as Ce,TT as we,Ud as Te,Ul as Ee,Um as De,Uu as Oe,VT as v,Vi as ke,Vr as Ae,Vw as je,Xl as Me,Xw as Ne,Yb as Pe,Yu as Fe,Z as Ie,Zb as Le,Zl as y,_v as Re,aD as ze,ap as Be,au as b,av as Ve,ax as He,cT as Ue,cf as We,cv as Ge,dv as Ke,eu as qe,ex as Je,fv as Ye,gD as Xe,gS as Ze,gT as Qe,gx as $e,hf as et,hg as tt,hl as nt,hv as rt,ig as it,jT as x,jn as at,jr as ot,kD as S,kl as st,lv as ct,mf as lt,mv as ut,mx as C,n_ as w,oT as dt,pT as T,pl as ft,pv as E,px as pt,qr as mt,rE as D,rg as ht,sD as gt,sS as _t,sm as vt,sx as yt,t_ as bt,uf as xt,uv as St,vv as Ct,vx as wt,wT as Tt,wg as Et,xg as Dt,xl as Ot,yT as kt,y_ as O,yg as At,yl as jt,ym as Mt,zf as k,zg as Nt,zl as Pt,zr as Ft}from"./index-BN8X5Ryz.js";import{n as It}from"./memoryEstimations-D_IbKyOk.js";import{t as Lt}from"./OptimizedGeometry-BQJ7w5VU.js";import{n as Rt}from"./OptimizedFeatureSet-CLjmRHYn.js";import{a as zt}from"./featureConversionUtils-o9-cJXzl.js";import"./quatf64-D37SEdPg.js";import"./quat-C8PgLo31.js";import"./MeshLocalVertexSpace-vomIk0sx.js";import"./meshVertexSpaceUtils-s2jLb8qI.js";import"./Indices-tJiSUK6w.js";import{C as Bt,b as Vt,g as Ht,n as Ut,r as Wt,y as Gt}from"./plane-Da5EsY0J.js";import"./vectorStacks-Cuo89CNO.js";import{t as Kt}from"./projectPointToVector-BkRdoTqD.js";import{t as qt}from"./computeTranslationToOriginAndRotation-0WDVmpJG.js";import"./BufferView-BW77W5ev.js";import"./Util-BQgFCZvD.js";import"./spatialReferenceEllipsoidUtils-qw9wv8RL.js";import{n as Jt}from"./PooledRBush-BH7_Gu1G.js";import"./types-BEunqM4i.js";import{n as Yt}from"./dehydratedPoint-CWZQBefp.js";import{t as Xt}from"./projectVectorToVector-DGzn2p7I.js";import"./symbolColorUtils-KqO0oQTm.js";import{i as Zt}from"./orientedBoundingBox-Bd4igSGQ.js";import{i as Qt,l as $t}from"./Emissions.glsl-C_Yvv-sZ.js";import"./glsl-BMw-Ib6r.js";import"./Uniform-C_fuiTP5.js";import"./Float3DrawUniform-ua6q6ZtZ.js";import"./Float3PassUniform-SaBA6LBM.js";import"./FloatPassUniform-CSAt82xV.js";import"./Texture2DDrawUniform-jqrXjxoW.js";import"./Texture2DPassUniform-DFWoDpEL.js";import"./NoParameters-BDE7RvXT.js";import{a as en,r as tn,t as nn}from"./layerViewUtils-CJcMVuwG.js";import{r as rn}from"./popupUtils-z3ynpNjO.js";import"./memoize-Dl61_jt0.js";import{h as an}from"./elevationInfoUtils-uoMH3ofe.js";import{t as A}from"./optimizedFeatureQueryEngineAdapter-DQyaY_b1.js";import"./ObjectStack-l5kM7JZu.js";import{r as on}from"./ray-LkJ58wpZ.js";import"./HUDIntersectorResult-C5AENPbM.js";import"./Intersector-DL9RPLNy.js";import"./videoUtils-CRYmuPNe.js";import"./VertexAttributeLocations-BScEla0R.js";import"./VertexElementDescriptor-Cl_nC_ty.js";import"./vec3-B94Y7ih2.js";import"./sphere-d9-4vNcj.js";import{d as sn,o as cn}from"./lineSegment-BudcKS0C.js";import"./triangle-46ad8nAb.js";import"./dehydratedFeatureComparison-BCFMkftR.js";import{t as ln}from"./hydratedFeatures-Cf3ay5ZM.js";import"./BufferObject-B3_aJU6V.js";import"./VertexBuffer-Ra4pb4dR.js";import"./vec3f32-DDMWoxUL.js";import"./ShaderBuilder-BLOqjpgt.js";import{t as un}from"./LayerView-DQaVI2FN.js";import{t as dn}from"./highlightOptionsUtils-DmkXKeuF.js";import{a as fn,c as pn,n as j,r as mn}from"./dehydratedFeatures-D5ZOMtMh.js";import{a as hn,i as gn,n as _n,o as vn}from"./renderState-BaFdYDAL.js";import"./image-CmtRVQsT.js";import"./frustum-LgSQ4wIS.js";import{D as yn,E as bn,O as xn,P as M,T as Sn,k as Cn,x as wn,y as Tn}from"./DefaultBufferWriter-BGKzMKkp.js";import{C as En,a as Dn,b as On,g as kn,n as An,o as jn,p as Mn,r as Nn,s as Pn,t as Fn}from"./ElevationContext-BzXFRbX1.js";import{a as In}from"./MaterialUtil-CcE5uVnF.js";import"./Octree-czER3kAP.js";import{a as Ln,d as Rn,s as zn}from"./SceneLighting-LJvcoD7s.js";import"./ScreenSpacePass.glsl-QJ_LkLYn.js";import"./Float2BindUniform-D7Jg9GMR.js";import"./ReadDepth.glsl-CX2bpX_x.js";import{a as Bn,s as Vn}from"./FloatArray-Dt98pDp2.js";import"./Float4BindUniform-DpoBnM9l.js";import"./CameraSpace.glsl-BqHBV5nH.js";import"./Texture2DBindUniform-Btzx3XRx.js";import"./Float2PassUniform-DUyrQoTC.js";import"./Float3BindUniform-BDFedz_d.js";import"./Float4PassUniform-C4TO8dd0.js";import"./FloatBindUniform-CXY5KrrB.js";import"./Matrix4BindUniform-D7U89BGU.js";import"./Matrix4PassUniform-CDJEQqiQ.js";import"./FloatsPassUniform-DKsLDw29.js";import"./IntegerPassUniform-CdQB44QJ.js";import"./HighlightReadBitmap.glsl-BBr-esSE.js";import"./Float2DrawUniform-3WoZLC1o.js";import"./Slice.glsl-DU3Ivhcc.js";import"./ObjectAndLayerIdColor.glsl-BHzrt-xI.js";import"./VisualVariables.glsl-1DqsizMu.js";import{t as Hn}from"./AlphaCutoff-WIqqBGOV.js";import"./ScreenSizePerspective.glsl-BuhoSJZ3.js";import"./View.glsl-CPcmVaet.js";import"./MarkerSizing.glsl-nslzooYm.js";import"./RibbonLine.glsl-CfmEn9-p.js";import"./ManagedTexture-DgNSfAYU.js";import"./sdfPrimitives-BR6xMvJc.js";import"./PiUtils.glsl-IDKkXUQy.js";import"./TerrainDepthTest.glsl-D7e23Ppb.js";import"./OutputColorHighlightOLID.glsl-CoP020fC.js";import{c as Un,l as Wn,t as Gn}from"./graphicUtils-Ct1OT6JD.js";import"./VerticalOffset.glsl-VrGhTlbS.js";import"./HUDVisibility.glsl-DO8Yaq72.js";import"./BooleanBindUniform-Dgbi5WXL.js";import"./HUDMaterial.glsl-CIbE2wvS.js";import"./Transform.glsl-2U1BxklA.js";import"./VertexColor.glsl-_MhPfHih.js";import{A as Kn,C as qn,D as Jn,M as Yn,N as Xn,b as Zn,c as Qn,h as $n,i as er,l as tr,n as nr,s as rr,t as ir,u as ar,v as or,x as sr,y as cr}from"./pointUtils-BP9nRZeK.js";import"./primitiveObjectSymbolUtils-fz701Tc0.js";import"./MixExternalColor.glsl-D0GjeJQe.js";import"./DefaultMaterial-BVbzHMdq.js";import"./SnowCover.glsl-DvDl-UAS.js";import"./DefaultMaterial.glsl-pmrJSA2T.js";import"./ReadShadowMap.glsl-DMCvezCI.js";import"./SSAOBlur.glsl-C8iS6qjP.js";import"./SSAO.glsl-xhx5R_Qb.js";import"./Normals.glsl-Dm_iDce_.js";import"./RealisticTree.glsl-DAC1hFJj.js";import{n as lr}from"./LineCallout.glsl-D6ln7DXm.js";var ur=e=>{let t=e,n=class extends t{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),Fe(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){let e=new AbortController,t=e.signal;this.addHandles(D(()=>e.abort())),await Ye(()=>this.view.defaultsFromMap?.heightModelInfoReady,t),T(t);let n=ue(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(n)throw n}};return S([s()],n.prototype,`view`,void 0),S([s()],n.prototype,`slicePlaneEnabled`,void 0),n=S([v(`esri.views.3d.layers.LayerView3D`)],n),n};async function dr(e,t,n,r,i){let{elevationProvider:a,renderCoordsHelper:o}=e,{elevationInfo:s}=t,{pointsInFeatures:c,spatialReference:l}=r,u=pe.fromJSON(l),d=Nn(s,!0),f=await An(d,u,i);T(i);let p=[],ee=new Set,te=new Set,ne=new Fn,m=Yt(0,0,0,pe.WGS84),re=new Mn,ie=O();m.spatialReference=u;let ae=e.elevationProvider.spatialReference??e.spatialReference;for(let{objectId:e,points:r}of c){let c=n(e);if(c==null){for(let e of r)p.push(e.z??0);ee.add(e);continue}c.isDraped&&te.add(e);let l=c.graphic.geometry;ne.setFromElevationInfo(an(l,s)),f&&ne.updateFeatureExpressionInfoContextForGraphic(f,c.graphic,t);for(let{x:e,y:t,z:n}of r)m.x=e,m.y=t,m.z=n??0,await Kt(m,ie,ae,{signal:i}),Dn(ie,a,ne,o,re),p.push(re.z)}return{elevations:p,drapedObjectIds:te,failedObjectIds:ee}}function fr(e){return e==null||e.type===`simple`||e.type===`unique-value`||e.type===`class-breaks`||e.type===`dictionary`||e.type===`heatmap`}function pr(e,n){if(e==null)return null;if(!fr(e))return new t(`renderer-conversion-3d:unsupported-renderer`,`Unsupported renderer of type '${e.type}'`,{renderer:e});switch(e.type){case`simple`:return hr(e,n);case`unique-value`:return gr(e,n);case`class-breaks`:return _r(e,n);case`dictionary`:case`heatmap`:return null}return null}function mr(e,n){if(!n)return null;if(Array.isArray(n)||(n=[n]),n.length>0){let r=n.map(e=>e.details.symbol.type||e.details.symbol.declaredClass).filter(e=>!!e);r.sort();let i=[];return r.forEach((e,t)=>{t!==0&&e===r[t-1]||i.push(e)}),new t(`renderer-conversion-3d:unsupported-symbols`,`Renderer contains symbols (${i.join(`, `)}) which are not supported in 3D`,{renderer:e,symbolErrors:n})}return null}function hr(e,t){let n={...ie,...t,cimFallbackEnabled:!0};return mr(e,h(e.symbol,n).error)}function gr(e,t){let n={...ie,...t,cimFallbackEnabled:!0},r=e.uniqueValueInfos?.map(e=>h(e.symbol,n).error).filter(gt),i=h(e.defaultSymbol,n);return i.error&&r?.unshift(i.error),mr(e,r)}function _r(e,t){let n={...ie,...t,cimFallbackEnabled:!0},r=e.classBreakInfos.map(e=>h(e.symbol,n).error).filter(gt),i=h(e.defaultSymbol,n);return i.error&&r.unshift(i.error),mr(e,r)}var vr=class{constructor(e,t,n){this.maximumTotalNumberOfVertices=e,this.maximumNumberOfFeatures=t,this.averageSymbolComplexity=n}},yr=class{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,n){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,n)}async queryElevation(e,t,n,r,i){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,i,n,r)}},br=a(),N=class extends o{constructor(e){super(e),this.events=new Re,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(e,t)=>`graphic`in e?e.graphic.attributes[t]:A.getAttribute(e,t),getAttributeAsTimestamp(e,t){let n=this.getAttribute(e,t);return typeof n==`number`?n:new Date(n).getTime()},getAttributes:e=>`graphic`in e?e.graphic.attributes:A.getAttributes(e),getObjectId:e=>`graphic`in e?j(e.graphic,this.objectIdField)??void 0:A.getObjectId(e),getGeometry:e=>`graphic`in e?e.getAsOptimizedGeometry(this.hasZ,this.hasM):A.getGeometry(e),getCentroid:(e,t)=>{if(`graphic`in e){let n=null;e.centroid==null?e.graphic.geometry.type===`point`&&re(e.graphic.geometry,xr,this.viewSpatialReference)&&(n=xr):n=e.centroid;let r=Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return n==null?(r[0]=0,r[1]=0,r[2]=0,r[3]=0):(r[0]=n.x,r[1]=n.y,t.hasZ&&(r[2]=n.hasZ?n.z:0),t.hasM&&(r[t.hasZ?3:2]=n.hasM?n.m:0)),new Lt([],r,t.hasZ,t.hasM)}return A.getCentroid(e,t)},cloneWithGeometry:(e,t,n)=>`graphic`in e?new Rt(t,this.featureAdapter.getAttributes(e),null,this.featureAdapter.getObjectId(e)):A.cloneWithGeometry(e,t,n)}}forEachInBounds(e,t){this.getSpatialIndex().forEachInBounds(e,t)}forEachBounds(e,t){let n=this.getSpatialIndex();for(let r of e){let e=this.featureAdapter.getObjectId(r);n.getBounds(e,br)!=null&&t(br)}}};S([s({constructOnly:!0})],N.prototype,`getSpatialIndex`,void 0),S([s({constructOnly:!0})],N.prototype,`forEach`,void 0),S([s({constructOnly:!0})],N.prototype,`hasZ`,void 0),S([s({constructOnly:!0})],N.prototype,`hasM`,void 0),S([s({constructOnly:!0})],N.prototype,`objectIdField`,void 0),S([s({constructOnly:!0})],N.prototype,`viewSpatialReference`,void 0),S([s({constructOnly:!0})],N.prototype,`featureSpatialReference`,void 0),N=S([v(`esri.views.3d.layers.graphics.Graphics3DFeatureStore`)],N);var xr={type:`point`,x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null},Sr=class{constructor(e,t,n){this.graphic=e,this.renderingInfo=t,this.layer=n}},Cr=class{constructor(e,t,n,r){this.scheduler=e,this.schedule=t,this.layerViewUid=n,this.compressionTracker=r,this.sharedResources=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}get spherical(){return this.stage.view.state.viewingMode===1}},wr=class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}},Tr=class extends Ln{constructor(t,n){super(t,n,Vn(Er)),this.shader=new zn(lr,()=>e(()=>import(`./LineCallout.glsl-BrbLpQfv.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25])))}initializePipeline(e){let{hudDepth:t,terrainDepthTest:n}=e,r={func:n?519:513};return _n(t?{depthTest:r,depthWrite:gn}:{blending:vn(1,770,771,771),depthTest:r,colorWrite:hn})}};Tr=S([v(`esri.views.3d.webgl-engine.shaders.LineCalloutTechnique`)],Tr);var Er=Bn().vec3f(`position`).vec3f(`normal`).vec2f16(`uv0`).vec4f(`centerOffsetAndDistance`),P=class extends xn{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.useVisibilityPixel=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hudDepth=!1,this.hudDepthAlignStart=!1,this.terrainDepthTest=!1,this.draped=!1}};S([M()],P.prototype,`screenCenterOffsetUnitsEnabled`,void 0),S([M()],P.prototype,`useVisibilityPixel`,void 0),S([M()],P.prototype,`hasVerticalOffset`,void 0),S([M()],P.prototype,`hasScreenSizePerspective`,void 0),S([M()],P.prototype,`hudDepth`,void 0),S([M()],P.prototype,`hudDepthAlignStart`,void 0),S([M()],P.prototype,`terrainDepthTest`,void 0);var Dr=class extends bn{constructor(e,t){super(e,Ar),this.intersectDraped=void 0,this.produces=new Map([[16,e=>$t(e)],[17,e=>$t(e)]]),this._configuration=new P(t),this._uniqueMaterialIdentifier=Or(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.useVisibilityPixel=this.parameters.useVisibilityPixel,this._configuration.hasVerticalOffset=this.parameters.verticalOffset!=null,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration.hudDepth=t.slot===17,this._configuration.hudDepthAlignStart=!!this.parameters.hudDepthAlignStart,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits===`screen`,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration}get visible(){return this.parameters.color[3]>=.003913894324853229||(this.parameters.borderColor?.[3]??0)>=.003913894324853229}intersect(){}createGLMaterial(e){return new kr(e)}createBufferWriter(){return new Mr}validateParameters(e){this._uniqueMaterialIdentifier=Or(e)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}};function Or({renderOccluded:e,isDecoration:t,horizontalScreenOffset:n,color:r,size:i,useVisibilityPixel:a,shaderPolygonOffset:o,hudDepthAlignStart:s,centerOffsetUnits:c,hasSlicePlane:l,screenSizePerspective:u,verticalOffset:d,borderColor:f}){return Ce`${e}:${t}:${n}:[${r}]:${i}:${a}:${o}:${s}:${c}:${l}:${u!=null}:{${d?.screenLength}:${d?.minWorldLength}:${d?.maxWorldLength}}:[${f}]`}var kr=class extends Qt{beginSlot(e){return this.getTechnique(Tr,e)}},Ar=class extends yn{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=_e(0,0,0,1),this.size=1,this.useVisibilityPixel=!1,this.shaderPolygonOffset=1e-5,this.hudDepthAlignStart=!1,this.centerOffsetUnits=`world`,this.hasSlicePlane=!1}},jr=[b(0,0),b(1,0),b(0,1),b(1,0),b(1,1),b(0,1)],Mr=class{constructor(){this.layout=Er}elementCount(e){return 6*e.get(`position`).indices.length}write(e,t,n,r,i,a){Sn(n.get(`position`),e,i.position,a,6),Tn(n.get(`normal`),t,i.normal,a,6),wn(n.get(`centerOffsetAndDistance`),i.centerOffsetAndDistance,a,6);for(let e=0;e<jr.length;++e)i.uv0.setVec(a+e,jr[e]);return null}},Nr=class e extends rr{static{this.elevationModeChangeTypes={definedChanged:1,staysOnTheGround:1,onTheGroundChanged:2}}constructor(e,t){super(e,null,t,Lr),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new Dr(this._materialParameters,this._context.spherical)}_perInstanceMaterialParameters(e){let t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||`world`,t}get _materialParameters(){let e=new Ar,t=this.symbol,n=t.callout;if(n.color){let t=n.color.toUnitRGBA();t[3]*=this._getLayerOpacity(),e.color=t}else e.color=ce;if(e.size=tt(n.size||0),t.verticalOffset){let{screenLength:n,minWorldLength:r,maxWorldLength:i}=t.verticalOffset;e.verticalOffset={screenLength:tt(n),minWorldLength:r||0,maxWorldLength:i??1/0}}e.borderColor=n.border?.color==null?null:n.border.color.toUnitRGBA();let r=t.symbolLayers.at(0).type===`object`,i=t.type===`label-3d`;return e.useVisibilityPixel=!1,r&&(e.shaderPolygonOffset=0),e.hudDepthAlignStart=i,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null,e}_defaultElevationInfoNoZ(){return Ir}createGraphics3DGraphic(e,t){let n=e.renderingInfo,r=e.graphic,i=this.createElevationContextForGraphic(r,n.elevationOffset||0),a=n.symbol,o=this._elevationContext.mode===`on-the-ground`&&(a.type===`cim`||!a.symbolLayers.some(e=>e.type===`object`||e.type===`text`));if(a.type!==`label-3d`&&o||a.type===`point-3d`&&a.symbolLayers.every(e=>e.type===`text`&&!m(e)))return null;let s=Un(r.geometry);return s==null?null:this._createAs3DShape(s,i,n,r.uid,t)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerScreenSizePerspectiveChanged(){let e=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null;this._materials[0]?.setParameters({screenSizePerspective:e})}layerElevationInfoChanged(t,n,r){let i=this._elevationContext.mode,a=Pn(e.elevationModeChangeTypes,r,i);return a!==1||t?.forEach(e=>{let t=n(e);t!=null&&this.graphics3DGraphicLayerElevationInfoChanged(e.graphic,t)}),a}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}createElevationContextForGraphic(e,t=0){let n=super.createElevationContextForGraphic(e);return n.addOffsetRenderUnits(t),n}updateElevationContextForGraphic(e,t,n=0){super.updateElevationContextForGraphic(e,t),e.addOffsetRenderUnits(n)}graphics3DGraphicLayerElevationInfoChanged(e,t){let{elevationContext:n,metadata:r}=t;this.updateElevationContextForGraphic(n,e,r?.elevationOffset??0),t.needsElevationUpdates=jn(n.mode)}computeComplexity(){return new qn({verticesPerFeature:6})}_getOrCreateMaterial(e,t){let n=this._perInstanceMaterialParameters(e),r=Or(n);if(r===this._materials[0]?.uniqueMaterialIdentifier)return this._materials[0];if(t){let e=t.get(r);return e??(e=new Dr(n,this._context.spherical),t.set(r,e)),e}return new Dr(n,this._context.spherical)}_createAs3DShape(e,t,n,r,i){let a=this._context.layerViewUid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerViewUid:a}),s=this._getOrCreateMaterial(n,i),c=new Cn(s,Pr(n),null,1,o),l=er(this._context,e,c,t,r);if(l==null)return null;let u=new ar(this,l.object,null,$n,t);return u.hiddenIfDeconflicted=!0,u.metadata=new tr(n.elevationOffset),u.alignedSampledElevation=l.sampledElevation,u.needsElevationUpdates=jn(t.mode),nr(u,e,this._context.elevationProvider),u}};function Pr(e){let{translation:t,centerOffset:n}=e,r=new Zt(t?[t[0],t[1],t[2]]:[0,0,0],Fr,3,!0),i=new Zt(n?[n[0],n[1],n[2],n[3]]:[0,0,0,1],Fr,4,!0);return[[`position`,r],[`normal`,new Zt([0,0,1],Fr,3,!0)],[`centerOffsetAndDistance`,i]]}var Fr=[0],Ir={mode:`relative-to-ground`,offset:0},Lr={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},Rr=class extends Xn{constructor(e,t,n=O(),r=Ie(),i=0,a=`world`,o=0){super(e,t),this.translation=n,this.centerOffset=r,this.horizontalScreenOffset=i,this.centerOffsetUnits=a,this.elevationOffset=o}},zr=()=>u.getLogger(`esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory`);function Br(e,t){if(!de(e))return zr().error(`Graphics3DCalloutSymbolLayerFactory#make`,`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;let n=Vr[e.callout.type];return n?new n(e,t):(zr().error(`Graphics3DCalloutSymbolLayerFactory#make`,`unknown or unsupported callout type ${e.callout.type}`),null)}var Vr={line:Nr};function Hr(e,t,n,r){return e!=null&&(i(t,r)?(He(n,e),!0):(F[0]=e[0],F[1]=e[1],F[2]=0,!!w(F,t,0,F,r,0)&&(n[0]=F[0],n[1]=F[1],F[0]=e[2],F[1]=e[3],F[2]=0,!!w(F,t,0,F,r,0)&&(n[2]=F[0],n[3]=F[1],!0))))}var F=O(),Ur=new Tt(()=>a(),e=>se(e,d),null,10,5),Wr=C(),Gr=class{get labelLayers(){return this._labelLayers||Xe}get extent(){return this._extent}get isElevationSource(){return this.layers.some(e=>e?.isElevationSource)}constructor(e,t,n){this.graphic=e,this.graphics3DSymbol=t,this.layers=n,this._visibleFlags=255,++t.referenced,n.every(e=>e&&`hiddenIfDeconflicted`in e&&e.hiddenIfDeconflicted)&&(this._visibleFlags|=256)}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic(t=>{t.initialize(e),Kr(this._visibleFlags,1,t)})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.layers==null}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||=[],this._labelLayers.push(e),e.initialize(t),Kr(this._visibleFlags,16,e)}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),Kr(this._visibleFlags,1,e))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(t=>{t.type===`draped`&&(e=!0)}),e}isVisible(e=1,t=0){let n=this._visibleFlags;return qr(n,e,t|16*t|(256&n?0:8))}setVisibilityFlag(e,t,n){let r=e*t;return n!==((this._visibleFlags&r)===r)&&(n?this._visibleFlags|=r:this._visibleFlags&=~r,e===1&&this._forEachSymbolLayerGraphic(e=>Kr(this._visibleFlags,1,e)),this._forEachLabelGraphic(e=>Kr(this._visibleFlags,16,e)),!0)}getVisibilityFlag(e,t){return(this._visibleFlags&e*t)!==0}computeExtent(e){if(!this._extent){let t=this.graphic.geometry;if(t==null)return!1;this._extent=C(),pn(t,this._extent);let n=t.spatialReference;if(!i(n,e)&&!Hr(this._extent,n,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||=this._convertGraphicToOptimizedGeometry(this.graphic,e,t),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,n){let r=e.geometry;return r.type!==`mesh`&&r.type!==`extent`||(r=c.fromExtent(r.type===`mesh`?r.extent:r)),zt(r,t,n)}get usedMemory(){let e=It(this.graphic.attributes);return this._forEachSymbolLayerGraphic(t=>e+=t.usedMemory),e}computeAttachmentOrigin(){let e={render:{origin:O(),num:0},draped:{origin:Oe(),num:0}};for(let t of this.layers)t?.computeAttachmentOrigin(e);return e.render.num>1&&g(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&he(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,n,r,i){return i||={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]},i.boundingBox?k(i.boundingBox):i.boundingBox=k(),i.requiresDrapedElevation=!1,await Dt(this.layers,async a=>{if(a==null)return;let o=a.type===`draped`?t:e,s=Ur.acquire(),c=await a.getProjectedBoundingBox(o,n,i.screenSpaceObjects,r,s);isFinite(c[2])&&isFinite(c[5])||(i.requiresDrapedElevation=!0),c&&et(i.boundingBox,s),Ur.release(s)}),xe(i.boundingBox)||$e(We(i.boundingBox,Wr))?i:null}needsElevationUpdates(){for(let e of this.layers)if(e!=null&&(e.type===`object3d`||e.type===`lod-instance`)&&e.needsElevationUpdates)return!0;return this._labelLayers?.some(e=>e?.needsElevationUpdates??!1)??!1}alignWithElevation(e,t,n){this._forEachRenderedGraphic(r=>{r.type!==`object3d`&&r.type!==`lod-instance`||r.alignWithElevation(e,t,n)})}alignWithAbsoluteElevation(e,t,n){this._forEachRenderedGraphic(r=>{r.type===`object3d`&&r.alignWithAbsoluteElevation(e,t,n)})}addObjectStateSet(e){this._forEachSymbolLayerGraphic(t=>t.addObjectState(e))}removeObjectState(e){this._forEachSymbolLayerGraphic(t=>t.removeObjectState(e))}updateHighlights(e){this._forEachSymbolLayerGraphic(t=>t.updateHighlights(e))}_forEachGraphicList(e,t){e?.forEach(e=>e&&t(e))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this.labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){}};function Kr(e,t,n){let r=t===1?`hiddenIfDeconflicted`in n&&n.hiddenIfDeconflicted?0:8:256&e?0:8;n.setVisibility(qr(e,t,r))}function qr(e,t,n=0){let r=(t===1?15:255)&~n;return(e&r)===r}var Jr=2216,Yr=4096;function Xr(e){return Jr+Yr*e.symbolLayers.length+e.complexity.memory.resourceBytes}var Zr=class extends Qn{set symbol(e){this._symbol=e,e.symbolLayers.forEach((t,n)=>{let r=this.symbolLayers[n];r!=null&&(r.symbol=e,r.symbolLayer=t)})}get symbol(){return this._symbol}constructor(e,t,n){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=n,this._destroyed=!1,this.symbolLayers=[],this.referenced=0,this._extentPadding=0}async doLoad(t){let n=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(n=this._backgroundLayers.concat(n));let r=n.length;for(;this.symbolLayers.length<n.length;)this.symbolLayers.push(null);this.symbolLayers.length=n.length;let i=[];if(!Qr){let{make:t}=await e(async()=>{let{make:e}=await import(`./Graphics3DSymbolLayerFactory-DSz3WE0x.js`);return{make:e}},__vite__mapDeps([26,2,3,27,28,22,6,14,7,25,4,5,29,30,31,32,20,11,16,33,34,35,21,12,13,15,36,37,19,38,39,24,40,41,42,18,43,44,45,46,47,23,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,17,71,72,73,9,10,74,75,8,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152]));Qr=t}for(let e=0;e<r;e++){let a=n.at(e);if(!1===a.enabled)continue;$r.renderPriority=1-(1+e)/r,$r.renderPriorityStep=1/r,$r.ignoreDrivers=a.ignoreDrivers;let o=Qr(this.symbol,a,this._context,$r),s=Ue(t,()=>{this.symbolLayers[e]=null,o.destroy()});s&&i.push(s),this.symbolLayers[e]=o}if(await Dt(this.symbolLayers,async(e,t)=>{if(e!=null)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}}),i.forEach(e=>e.remove()),T(t),this.symbolLayers.length&&!this.symbolLayers.some(e=>!!e))throw Error()}getSymbolLayerSize(e){let t=this.symbolLayers[e];return t==null?null:t.getCachedSize()}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>e?.queryForSnapping)}get needsUpdateFocus(){return this.symbolLayers.some(e=>!0===e?.needsUpdateFocus)}createGraphics3DGraphic(e,t){let{graphic:n}=e,r=this.symbolLayers.map(t=>t?.createGraphics3DGraphic(e)??null);return new Gr(n,t||this,r)}get complexity(){return or(this.symbolLayers.map(e=>e?.complexity))}globalPropertyChanged(e,t){let n=this.symbolLayers.length;for(let r=0;r<n;r++){let n=this.symbolLayers[r];if(n!=null&&!n.globalPropertyChanged(e,t,e=>{let t=e.layers[r];return t instanceof ar?t:null}))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus===1?this.symbolLayers.reduce((n,r)=>n!==0&&r!=null?Math.min(n,r.applyRendererDiff(e,t)):n,2):0}prepareSymbolPatch(e){if(this.loadStatus===2||e.diff.type!==`partial`)return;let t=e.diff.diff;if(!t.symbolLayers||t.symbolLayers.type!==`partial`)return;let n=t.symbolLayers.diff;this.symbolLayers.forEach((t,r)=>{if(t==null)return;let i=n[r];if(i){let n={diff:i,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(n),e.symbolStatePatches.push(...n.symbolLayerStatePatches),n.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((e,t)=>{let i=e.layers[r];i!=null&&n.graphics3DGraphicPatches.forEach(e=>e(i,t))})}})}updateGeometry(e){return this._updateGeometryOrTransform(e,(t,n)=>!!t.updateGeometry&&t.updateGeometry(e.graphic,n))}updateTransform(e,t,n,r){return this._updateGeometryOrTransform(e,(e,i)=>!!e.updateTransform&&e.updateTransform(i,t,n,r))}_updateGeometryOrTransform(e,t){for(let n=0;n<this.symbolLayers.length;n++){let r=this.symbolLayers[n];if(r==null)continue;let i=e.layers[n];if(!i||!t(r,i))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){let n=this.symbolLayers[t];if(n==null)continue;let r=e.layers[t];r!=null&&n.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=!1,t=!1;for(let n of this.symbolLayers)if(n!=null){if(n.loadStatus===0)return 3;n.isFastUpdatesEnabled()?t=!0:e=!0}return t?e?2:1:e?0:4}async queryForSnapping(e,t,n,r){let i=this.symbolLayers.filter(gt).filter(e=>e.queryForSnapping!=null).map(i=>i.queryForSnapping(e,t,n,r)),a=await Promise.all(i);return T(r),a.flat()}destroy(){if(!this.destroyed){super.destroy();for(let e of this.symbolLayers)e?.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}get usedMemory(){return Xr(this)}},Qr=null,$r=new wr,ei=class extends Zr{constructor(e,t,n){super(e,t,n),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=Br(this.symbol,t))}async doLoad(e){let t=this._calloutSymbolLayer?At(this._calloutSymbolLayer.load()):null;try{await super.doLoad(e),T(e)}catch(e){throw this._calloutSymbolLayer?.abortLoad(),e}t&&await t}destroy(){super.destroy(),this._calloutSymbolLayer=x(this._calloutSymbolLayer)}createGraphics3DGraphic(e,t){let n=super.createGraphics3DGraphic(e,t);if(this._calloutSymbolLayer!=null&&n!=null){let t=this._createCalloutGraphic(e);t&&n.setCalloutGraphic(t)}return n}globalPropertyChanged(e,t){return!!super.globalPropertyChanged(e,t)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(e,t,e=>e.calloutLayer))}updateGeometry(e){let t=super.updateGeometry(e);if(t&&this._calloutSymbolLayer){let t=e.calloutLayer;if(t)return this._calloutSymbolLayer.updateGeometry?.(e.graphic,t)??!1}return t}_createCalloutGraphic(e){let t=e.renderingInfo;return e.renderingInfo=new Rr(t.renderer,t.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(e)}};function ti(e,t,n){return e.type===`point-3d`?new ei(e,t,n):new Zr(e,t,n)}var ni=class extends Qn{constructor(e,t,n){super(t),this.symbol=e,this._convert=n,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return this.graphics3DSymbol==null?null:this.graphics3DSymbol.getSymbolLayerSize(e)}get symbolLayers(){return this.graphics3DSymbol==null?[]:this.graphics3DSymbol.symbolLayers}get extentPadding(){return this.graphics3DSymbol==null?0:this.graphics3DSymbol.extentPadding}async doLoad(e){let t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),this.graphics3DSymbol!=null&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return this.graphics3DSymbol==null?null:this.graphics3DSymbol.createGraphics3DGraphic(e,this)}get complexity(){return this.graphics3DSymbol==null?cr:this.graphics3DSymbol.complexity}globalPropertyChanged(e,t){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return this.graphics3DSymbol==null?0:this.graphics3DSymbol.applyRendererDiff(e,t)}prepareSymbolPatch(e){this.graphics3DSymbol!=null&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.updateGeometry(e)}updateTransform(e,t,n,r){return this.graphics3DSymbol?.updateTransform(e,t,n,r)??!1}onRemoveGraphic(){}get needsUpdateFocus(){return!1}getFastUpdateStatus(){return this.graphics3DSymbol?.getFastUpdateStatus()??3}destroy(){this.graphics3DSymbol!=null&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}get usedMemory(){return Xr(this)}},ri=class{constructor(e,t,n,r){this.total=e,this.visible=t,this.missing=n,this.pending=r}},ii=class{constructor(e){this._graphicsCore=e,this._idToState=new Map,this._states=new Set;let t=e.owner.layer?.objectIdField;t?(this._getGraphicId=e=>j(e,t),this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicByObjectId(e)):(this._getGraphicId=e=>e.uid,this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicById(e))}destroy(){this._idToState.clear(),this._states.forEach((e,t)=>this.remove(t))}add(e){let t=D(()=>this.remove(e));if(this._states.has(e))return t;let n=this._getGraphicId(e.graphic),r=this._getGraphics3DGraphicById(n);return this._states.has(e)||this._states.add(e),this._ensureStateList(n).push(e),e.displaying=r?.isVisible()??!1,e.isDraped=r?.isDraped??!1,e.tracking=!0,r!=null&&e.emit(`changed`),t}remove(e){if(this._states.has(e)){if(this._idToState.size){let t=this._getGraphicId(e.graphic),n=this._idToState.get(t);n&&(ze(n,e),n.length===0&&this._idToState.delete(t))}this._states.delete(e),e.tracking=!1,e.displaying=!1}}addGraphic(e){this._forEachState(e.graphic,t=>{t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit(`changed`)})}removeGraphic(e){this._forEachState(e.graphic,e=>{e.displaying=!1,e.isDraped=!1})}updateGraphicGeometry(e){this._forEachState(e.graphic,e=>e.emit(`changed`))}updateGraphicVisibility(e){this._forEachState(e.graphic,t=>t.displaying=e.isVisible())}updateGraphicError(e,t){this._forEachState(e,e=>e.error=t)}allGraphicsDeleted(){this._states.forEach(e=>e.displaying=!1)}_ensureStateList(e){let t=this._idToState.get(e);if(t)return t;let n=[];return this._idToState.set(e,n),n}_forEachState(e,t){if(this._states.size===0||this._idToState.size===0)return;let n=this._getGraphicId(e);this._idToState.get(n)?.forEach(t)}},I=class extends o{constructor(e){super(e),this._index=new Jt(9,f(`esri-csp-restrictions`)?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[`.extent[0]`,`.extent[1]`,`.extent[2]`,`.extent[3]`]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(e){this._addMany(e)}destroy(){this._missing.clear(),this._index=x(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(e,t,n){t!=null&&t.equals(this.spatialReference)&&(L.minX=e[0],L.minY=e[1],L.maxX=e[2],L.maxY=e[3],this.update(),this._index.search(L,e=>n(e.graphic.uid)))}add(e){this._missing.add(e),this.updating=!0}remove(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);if(!e.extent)return;this._index.remove(e);let t=j(e.graphic,this._get(`objectIdField`));t!=null&&this._boundsByFeature.delete(t)}_addMany(e){if(e.length===0)return;let t=this._get(`objectIdField`);for(let n of e){n.computeExtent(this.spatialReference);let e=j(n.graphic,t);e!=null&&this._boundsByFeature.set(e,n.extent)}this._index.load(e)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(e,t){L.minX=e[0],L.minY=e[1],L.maxX=e[2],L.maxY=e[3],this.update(),this._index.search(L,e=>{t(e)})}getBounds(e,t){this.update();let n=this._boundsByFeature.get(e);return n?xt(t,n):null}};S([s({constructOnly:!0})],I.prototype,`spatialReference`,void 0),S([s({constructOnly:!0})],I.prototype,`hasZ`,void 0),S([s({constructOnly:!0})],I.prototype,`hasM`,void 0),S([s({constructOnly:!0})],I.prototype,`objectIdField`,void 0),S([s()],I.prototype,`updating`,void 0),S([s({readOnly:!0})],I.prototype,`updatingRemaining`,null),I=S([v(`esri.views.3d.layers.graphics.SpatialIndex2D`)],I);var L={minX:0,minY:0,maxX:0,maxY:0},ai=class{constructor(e=`scene`){this.context=e,this.extent=Je(),this.spatialReference=null}},oi=1,si=Symbol(`layerHandles`),R=class extends Ct{get spatialReference(){return this.view.spatialReference}constructor(e){super(e),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=new Rn(this.view.state.viewingMode),this._intersector.options.store=0;let e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];let t=this.stageLayer.events;this.addHandles([t.on([`layerObjectAdded`,`layerObjectRemoved`,`transformationChanged`,`shaderTransformationChanged`],e=>this._objectChanged(e)),t.on([`geometryAdded`,`geometryRemoved`],({object:e})=>this._objectChanged(e)),t.on(`attributesChanged`,({attribute:e,object:t})=>En(e)&&this._objectChanged(t))],si)}destroy(){this.removeHandles(si)}elevationInfoChanged(){let e=this.layer==null?null:this.layer.elevationInfo;if(e!=null&&e.mode!==`on-the-ground`){let t=_t(this.layer.spatialReference),n=ke(e.unit??`meters`);this._elevationOffset=(e.offset??0)*n/t}else this._elevationOffset=0}getElevation(e,t,n,r){if(B[0]=e,B[1]=t,B[2]=n,!this._renderCoordsHelper.toRenderCoords(B,r,B))return u.getLogger(this).error(`could not project point for elevation alignment`),null;let i=this._elevationOffset,a=this._zmin+i,o=this._zmax+i;return this._renderCoordsHelper.setAltitude(li,o,B),this._renderCoordsHelper.setAltitude(ui,a,B),this._intersector.reset(li,ui,null),this._intersector.intersect(this._intersectLayers,null,oi,null,e=>!!e.lastValidElevationBB),this._intersector.results.min.getIntersectionPoint(B)?this._renderCoordsHelper.getAltitude(B):null}_objectChanged(e){let t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;k(z);let n=e.lastValidElevationBB;n.isEmpty()||this._expandExtent(t,n.min,n.max,z);let{min:r,max:i}=e.boundingVolumeWorldSpace;this._expandExtent(t,r,i,z),We(z,ci.extent),this._zmin=Math.min(this._zmin,z[2]),this._zmax=Math.max(this._zmax,z[5]),ci.spatialReference=t,this.emit(`elevation-change`,ci),ci.spatialReference=null,n.assignMinMax(r,i)}_computeLayerExtent(e,t){return k(z),e!=null&&t.objects.forEach(t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,z)),z}_expandExtent(e,t,n,r){for(let i=0;i<8;++i)B[0]=1&i?t[0]:n[0],B[1]=2&i?t[1]:n[1],B[2]=4&i?t[2]:n[2],this._renderCoordsHelper.fromRenderCoords(B,B,e),me(r,B);return r}};S([s({constructOnly:!0})],R.prototype,`layer`,void 0),S([s({constructOnly:!0})],R.prototype,`stageLayer`,void 0),S([s({constructOnly:!0})],R.prototype,`view`,void 0),S([s()],R.prototype,`spatialReference`,null),R=S([v(`esri.views.3d.layers.support.StageLayerElevationProvider`)],R);var z=k(),ci=new ai,B=O(),li=O(),ui=O();function di(e,t,n){if(e==null||n==null)return!1;let r=!0;return V[0]=e.xmin==null?0:e.xmin,V[1]=e.ymin==null?0:e.ymin,V[2]=e.zmin==null?0:e.zmin,r&&=w(V,e.spatialReference,0,V,n,0),t[0]=V[0],t[1]=V[1],V[0]=e.xmax==null?0:e.xmax,V[1]=e.ymax==null?0:e.ymax,V[2]=e.zmax==null?0:e.zmax,r&&=w(V,e.spatialReference,0,V,n,0),t[2]=V[0],t[3]=V[1],e.xmin??(t[0]=-1/0),e.ymin??(t[1]=-1/0),e.xmax??(t[2]=1/0),e.ymax??(t[3]=1/0),r}var V=O(),fi=class{constructor(){this._pendingCompressionTasks=it(0)}get compressing(){return!!this._pendingCompressionTasks.value}increment(){this._pendingCompressionTasks.value++}decrement(){this._pendingCompressionTasks.value--}},pi,mi=O(),hi=a(),H=class extends o{static{pi=this}static{this.tmpVec=O()}get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){return this._spatialIndex||(this._spatialIndex=new I({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get deconflictor(){return this._deconflictor}get labeler(){return this._labeler}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return this.currentRenderer!=null&&this.currentRenderer.type===`dictionary`?0:this._forcedUpdatePolicy??this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){return!!(this.dataUpdating||this._elevationAlignment?.updating||this._scaleVisibility?.updating||this._filterVisibility?.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this._updateQueue.updating||this.readyToRun)}get dataUpdating(){return!!(this._graphicsWaitingForSymbol.size>0||this._pendingUpdates.size>0||this._spatialIndex?.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.updating||this._loadingSymbols>0||this.compressionTracker.compressing)}get readyToRun(){return this._pendingUpdates.size>0||!!this._spatialIndex?.updating||this._dataUpdateQueue.readyToRun||this._updateQueue.readyToRun||this._focusAreasGraphicsQueue.length>0}get suspendedOrOutsideOfView(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){let e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?.graphics3D.minTotalNumberOfFeatures??0,n=e?.graphics3D.maxTotalNumberOfFeatures??0,r=e?.graphics3D.maxNumberOfDrawCalls??0,i=e?.graphics3D.maxTotalNumberOfVertices??0,a=this.averageSymbolComplexity,o=Math.max(1,a?.verticesPerFeature??1),s=a&&a.drawCallsPerFeature>0&&r>0?r/a.drawCallsPerFeature:n,c=Math.ceil(i/o),l=Math.max(t,Math.min(n,c,s)),u=this._get(`displayFeatureLimit`);return u&&u.maximumTotalNumberOfVertices===i&&u.averageSymbolComplexity===a&&u.maximumNumberOfFeatures===l?u:new vr(i,l,a)}get averageSymbolComplexity(){let e=Zn(this._symbolComplexities),t=this._get(`averageSymbolComplexity`);return e.numComplexities===0||t!=null&&(e.estimated&&(t.verticesPerFeature>=e.verticesPerFeature||t.verticesPerCoordinate>=e.verticesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.verticesPerFeature===e.verticesPerFeature&&t.verticesPerCoordinate===e.verticesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}get usedMemory(){let e=this.labelsEnabled?(this.averageSymbolComplexity?.memory.bytesPerFeatureLabel??0)*this._numberOfGraphics:0,t=this._getSymbolComplexitiesUsed().reduce((e,t)=>e+t.memory.resourceBytes,0);if(this._symbolMaterials==null){this._symbolMaterials=[];for(let e of this._symbols.values())if(e!=null){for(let t of e.symbolLayers)if(t)for(let e of t.materials)e&&this._symbolMaterials.push(e)}}let n=this.owner.view.stage.renderer,r=this.owner.view.overlayManager.renderer,i=this._symbolMaterials.reduce((e,t)=>e+((n.getMaterialRenderer(t)||r.getMaterialRenderer(t))?.usedMemory??0),0);return this._usedMemory+e+t+i}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){let e=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*e}if(this.averageSymbolComplexity!=null){let e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(e){let t=e;if(t.type===`web-style`)return t.clone();let n=this._symbolConversionCache.get(t.id);if(n!=null)return n;let r=h(t,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(t),cimFallbackEnabled:!0}),i=r.symbol||null;return i==null&&r.error&&u.getLogger(this).error(r.error.message),this._symbolConversionCache.set(t.id,i),i}_getSymbolComplexitiesUsedOrRenderer(e){if(e==null)return[];let t=e.symbols,n=`backgroundFillSymbol`in e?e.backgroundFillSymbol:null;if(!n&&!t.length)return[];let r=[],i=this._getSymbolComplexityUsedOrRenderer(n);i!=null&&r.push(i);for(let e of t){let t=this._getSymbolComplexityUsedOrRenderer(e);t!=null&&r.push(t)}return r}_getSymbolComplexityUsedOrRenderer(e){if(e==null)return null;let t=this._symbols.get(e.id);if(t!=null)return t.complexity;let n=this._getConvertedSymbol(e);return n==null?null:sr(n)}_getSymbolComplexitiesUsed(){let e=[];return this._symbols.forEach(t=>{t!=null&&e.push(t.complexity)}),e}get _objectIdField(){return this.layer.objectIdField}constructor(e){super(e),this._propertiesPool=new ht({computedExtent:()=>new wt},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._frameTaskHandle=Me,this._dataUpdateQueue=new n,this._updateQueue=new n,this._focusAreasGraphicsQueue=new Ve,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._elevationAlignment=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this.compressionTracker=new fi,this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new kt,this.preferredUpdatePolicy=1,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this._unusedSymbolsCache=e.owner.view.resourceController.memoryController.newCache(`graphics-3d-unused-symbols`,e=>e.destroy()),this.symbolCreationContext=new Cr(e.owner.view.resourceController.scheduler,(e,t)=>this._updateQueue.push(e,t),e.owner.layerViewUid,this.compressionTracker)}initialize(){this._featureStore=new N({objectIdField:this.owner.layer?.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:e=>this.graphics3DGraphics.forEach(e)});let e=(e,t,n)=>this.spatialIndex.queryGraphicUIDsInExtent(e,t,n),{componentFactories:t}=this;this._elevationAlignment=t.elevationAlignment?.(this,e),this._scaleVisibility=t.scaleVisibility?.(this,e),this._filterVisibility=t.filterVisibility?.({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:e=>this.modifyGraphics3DGraphicVisibilities(t=>t.setVisibilityFlag(1,4,e(j(t.graphic,this._objectIdField)))),setAllFeaturesVisibility:e=>this.modifyGraphics3DGraphicVisibilities(t=>t.setVisibilityFlag(1,4,e)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(1,4,!0))}),this._deconflictor=t.deconflictor?.(this),this._labeler=t.labeler?.(this,this._scaleVisibility),this._objectStates=t.objectStates?.(this),this._initializeAbortController=new AbortController,this.addHandles(St(()=>this.owner.view.state.highlights,()=>{let{highlightOrderMap:e}=this.owner.view.state;this.graphics3DGraphics.forEach(t=>t.updateHighlights(e))})),this._initializePromise=this._initializeAsync()}async _initializeAsync(){let e=this._initializeAbortController?.signal,t=this.owner.view;this._viewElevationProvider=new yr(this._viewSpatialReference,t),this._initializeStage(t,this.owner.layerViewUid);let n=t.sharedSymbolResources;this.symbolCreationContext.sharedResources=n,this.currentRenderer!=null&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.renderCoordsHelper=t.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new kn(t.renderSpatialReference),this.symbolCreationContext.elevationProvider=t.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);let r=Nn(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=await An(r,this._viewSpatialReference,e,u.getLogger(this)),T(e),this.symbolCreationContext.screenSizePerspectiveEnabled=In(this.layer.screenSizePerspectiveEnabled),this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,`drapeSourceType`in this.owner){let{owner:e}=this;this.symbolCreationContext.drapeSourceRenderer=t.overlayManager.registerGeometryDrapeSource(e)}this.addHandles([E(()=>this.suspendedOrOutsideOfView,()=>this._updateQueue.unshift(()=>this._updateLayerVisibility(),null).catch(Qe)),E(()=>In(this.layer?.screenSizePerspectiveEnabled),e=>{e!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=e,this._screenSizePerspectiveEnabledChange())}),E(()=>this.owner.slicePlaneEnabled,e=>this._slicePlaneEnabledChange(!!e)),E(()=>this.owner.view.state?.rasterPixelRatio,()=>this._pixelRatioChange()),E(()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,e=>this._physicalBasedRenderingChange(e)),E(()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,e=>this._skipHighSymbolLoDsChange(e)),E(()=>this.owner.view.focusAreasView?.polygons,()=>this._updateFocusedLabels()),E(()=>this.owner.view.map?.focusAreas.style,()=>this.recreateAllGraphicsAndSymbols()),E(()=>!!t.basemapTerrain&&!t.basemapTerrain.opaque&&!t.basemapTerrain.invisible,()=>this.terrainTransparencyChange()),St(()=>t.basemapTerrain?.tilingScheme,e=>{e.spatialReference.equals(this.symbolCreationContext.overlaySR)||t.basemapTerrain.spatialReference==null||(this.symbolCreationContext.overlaySR=t.basemapTerrain.spatialReference),this.hasHandles(`loaded-graphics`)?this.recreateAllGraphics():this.addHandles([ct(()=>this.owner?.loadedGraphics,`change`,e=>{this._graphicsCollectionChanged(e),this._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],`loaded-graphics`)},{initial:!0}),E(()=>this.effectiveUpdatePolicy,e=>{this.stageLayer!=null&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===0,e===1&&this.runTask(ve)},ut)]),this._frameTaskHandle=t.resourceController.scheduler.registerTask(y.GRAPHICS_CORE,this),this.layer&&`featureReduction`in this.layer&&this.addHandles(E(()=>this.layer.featureReduction,()=>this._deconflictor?.featureReductionChange())),this.notifyChange(`averageSymbolComplexity`),this.rendererChange(this.owner.renderer).catch(()=>{}),this._initializeAbortController=null}_abortInitialize(){this._initializeAbortController=we(this._initializeAbortController)}_updateFocusedLabels(){this._focusAreasGraphicsQueue.clear(),this.forEachGraphics3DSymbol((e,t)=>{t&&e.needsUpdateFocus&&t.forEach(e=>{this._focusAreasGraphicsQueue.push(e)})})}destroy(){if(this._unusedSymbolsCache.destroy(),this._abortInitialize(),this._rendererChangeAbortController=we(this._rendererChangeAbortController),this._abortElevationInfoChange(),this._frameTaskHandle.remove(),this._frameTaskHandle=Me,this._dataUpdateQueue.cancelAll(),this._updateQueue.cancelAll(),this._deconflictor=p(this._deconflictor),this._labeler=p(this._labeler),this._elevationAlignment=x(this._elevationAlignment),this._scaleVisibility=x(this._scaleVisibility),this._filterVisibility=x(this._filterVisibility),this._objectStates=x(this._objectStates),this.clear(),`drapeSourceType`in this.owner){let{owner:e}=this;this.stage.view.overlayManager.unregisterDrapeSource(e)}for(let e in this._featureStore=x(this._featureStore),this._updatingPendingLoadedGraphicsChange=p(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=x(this._graphicStateTracking),this.stage&&=(this.stageLayer=x(this.stageLayer),null),this._set(`owner`,null),this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[e].reject(new t(`graphic:layer-destroyed`,`Layer has been destroyed`));this._whenGraphics3DGraphicRequests=null,this._propertiesPool=x(this._propertiesPool),this._whenSymbolRemoved.prune(),this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=x(this._spatialIndex),this._symbolMaterials=null}clear(){this._objectStates?.allGraphicsDeleted(),this._graphicStateTracking!=null&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach(e=>e.destroy()),this._spatialIndex?.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(x),this._symbols.clear(),this._symbolMaterials&&=(this._symbolMaterials.length=0,null),this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange(`dataUpdating`),this.notifyChange(`readyToRun`),this.notifyChange(`updatingRemaining`),this._featureStore.events.emit(`changed`),this.owner.notifyContentGeometryUpdate?.()}_initializeStage(e,t){this.stage=e.stage,this.stageLayer=new On(this.stage,{visible:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t);let n=this.stageLayer.events;n.on(`transformationChanged`,e=>this.notifyGraphicGeometryChanged(e.graphicUid)),n.on(`shaderTransformationChanged`,e=>this.notifyGraphicGeometryChanged(e.graphicUid)),n.on(`visibilityChanged`,e=>this.notifyGraphicVisibilityChanged(e.graphicUid)),n.on(`geometryAdded`,e=>this.notifyGraphicGeometryChanged(e.object.graphicUid)),n.on(`geometryRemoved`,e=>this.notifyGraphicGeometryChanged(e.object.graphicUid)),n.on(`attributesChanged`,e=>En(e.attribute)&&this.notifyGraphicGeometryChanged(e.object.graphicUid))}notifyGraphicGeometryChanged(e){if(this.owner.notifyContentGeometryUpdate?.(),this._graphicStateTracking==null||e==null)return;let t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicGeometry(t)}notifyGraphicVisibilityChanged(e){if(this.owner.notifyContentGeometryUpdate?.(),this._graphicStateTracking==null||e==null)return;let t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicVisibility(t)}_updateLayerVisibility(){let e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this._numberOfGraphics>e*_i,n=!this.suspendedOrOutsideOfView&&!t;n!==this._visible&&(this._visible=n,this._updateStageLayerVisibility())}_updateStageLayerVisibility(){let e=this._visible&&(this.layer.opacity==null||this.layer.opacity>=.003913894324853229);this.stageLayer.visible!==e&&(this.stageLayer.visible=e,e?this.updateGraphicsVisibilities():this._hideAllGraphics(),this.owner.notifyContentGeometryUpdate?.())}getGraphics3DGraphicById(e){return e==null?void 0:this.graphics3DGraphics.get(e)}getGraphics3DGraphicByObjectId(e){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e,t=this.owner.layer?.objectIdField){return j(e,t)}get graphics3DGraphicsByObjectID(){let e=this.owner.layer?.objectIdField;if(!e)return;let t=new Map;return this.graphics3DGraphics.forEach(n=>{if(!n)return;let r=n.graphic,i=this._getGraphicObjectID(r,e);i!=null&&t.set(i,n)}),t}get labelsEnabled(){return!!this._labeler?.layerLabelsEnabled()}async updateLabelingInfo(e){let t=this._deconflictor?.labelingInfoChange(e),n=this._labeler?.labelingInfoChange(e);await Promise.allSettled([t,n])}updateVisibilityInfo(){this._deconflictor?.labelingInfoChange(),this._labeler?.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return`unknown`;let e=!1,t=!1;for(let[n,r]of this._symbols)if(r!=null)switch(r.getFastUpdateStatus()){case 3:return`unknown`;case 1:this._graphicsBySymbol.has(n)&&(t=!0);break;case 0:this._graphicsBySymbol.has(n)&&(e=!0);break;case 2:this._graphicsBySymbol.has(n)&&(t=e=!0)}return t?e?`mixed`:`fast`:e?`slow`:`mixed`}runTask(e){if(this._dataUpdateQueue.runTask(e),this._updateQueue.runTask(e),this._applyPendingUpdates(e),this._applyFocusAreasUpdates(e),this.notifyChange(`readyToRun`),this.readyToRun||this.notifyChange(`dataUpdating`),this.notifyChange(`updatingRemaining`),!e.hasProgressed)return qe}setObjectIdVisibility(e,t){t?this._objectIdInvisibleSet.delete(e):this._objectIdInvisibleSet.add(e);let n=this._findGraphics3DGraphicByObjectId(e);n!=null&&this._updateUserVisibility(n)}_findGraphics3DGraphicByObjectId(e){return be(this.graphics3DGraphics,t=>this._getGraphicObjectID(t.graphic)===e)}_updateUserVisibility(e){if(e==null)return!1;let t=e.graphic,n=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&this.stageLayer.visible&&(n==null||!this._objectIdInvisibleSet.has(n));return e.setVisibilityFlag(1,1,r)}_whenGraphics3DGraphic(e){let t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);let n=this._whenGraphics3DGraphicRequests[e.uid];if(n)return n.promise;let r=Ne();return this._whenGraphics3DGraphicRequests[e.uid]=r,r.promise}async _boundsForGraphics3DGraphic(e,t){let n=this._viewSpatialReference,r=this.owner.view.renderSpatialReference,i=this.owner.view.basemapTerrain.spatialReference,a=(e,t,i)=>w(e,r,t,e,n,t,i),o=(e,t,r)=>w(e,i,t,e,n,t,r),s=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:t!=null&&!!t.useViewElevation,minDemResolution:t==null?null:t.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,c=await e.getProjectedBoundingBox(a,o,s,t?.signal);if(!c)return null;let l=c.boundingBox;if(c.requiresDrapedElevation){let e=this.symbolCreationContext.elevationProvider;if(e){ne(l,mi);let t=e.getElevation(mi[0],mi[1],0,n,`ground`)??0;l[2]=Math.min(l[2],t),l[5]=Math.max(l[5],t)}}return{boundingBox:l,screenSpaceObjects:c.screenSpaceObjects}}async whenGraphicBounds(e,n){await Ye(()=>this.owner?.loadedGraphics);let r=this.owner.layer?.objectIdField,i=this.owner.loadedGraphics.find(t=>t===e||r!=null&&t.attributes!=null&&e.attributes&&t.attributes[r]===e.attributes[r]);if(!i)throw new t(`internal:graphic-not-part-of-view`,`Graphic is not part of this view`);let a=await this._whenGraphics3DGraphic(i);return this._boundsForGraphics3DGraphic(a,n)}computeAttachmentOrigin(e,t){let n=this.graphics3DGraphics.get(e.uid);if(!n)return null;let r=n.computeAttachmentOrigin();if(r.render.num===0&&r.draped.num===0)return null;_(U,0,0,0);let i=0;if(r.render.num>0){if(!Xt(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,W,t))return null;Ee(U,U,W),i++}if(r.draped.num>0){let[e,n]=r.draped.origin,a=this._viewElevationProvider.getElevation(e,n,`ground`)??0;if(_(W,e,n,a),!Xt(W,this._viewElevationProvider.spatialReference,W,t))return null;Ee(U,U,W),i++}return i>1&&g(U,U,1/i),new ee({x:U[0],y:U[1],z:U[2],spatialReference:t})}getSymbolLayerSize(e,n){let r=this._symbols.get(e.id);if(r==null)throw new t(`internal:symbol-not-part-of-view`,`Symbol is not part of this view`);let i=e.symbolLayers.indexOf(n);if(i===-1)throw new t(`internal:missing-symbol-layer`,`Symbol layer is not in symbol`);let a=r.getSymbolLayerSize(i);if(a==null)throw new t(`internal:missing-size`,`Symbol layer has no valid size`);return a}_graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}graphicUpdateHandler(e){let t=e.graphic.uid,n=this.graphics3DGraphics.get(t);if(n!=null||this._graphicsWithoutSymbol.get(t)!=null){switch(e.property){case`visible`:this._graphicUpdateVisibleHandler(n);break;case`geometry`:this._graphicUpdateGeometryHandler(n,e.graphic);break;case`symbol`:this._graphicUpdateSymbolHandler(n,e);break;case`attributes`:this.symbolCreationContext.featureExpressionInfoContext?.arcade&&this._graphicUpdateGeometryHandler(n,e.graphic);break;case`popupTemplate`:break;case`origin-transform`:this._graphicUpdateTransformHandler(n,e)}this.owner.notifyContentGeometryUpdate?.()}}_graphicUpdateGeometryHandler(e,t){this._graphicUpdateGeometryOrTransformHandler(e,t,()=>!(e==null||!e.graphics3DSymbol.updateGeometry(e)||!(this._labeler?.updateGraphicGeometry(e)??1))&&(this._labeler?.setDirty(),this._deconflictor?.setDirty(),!0));let n=t.geometry;n!=null&&this._expandComputedExtent(n)}_graphicUpdateTransformHandler(e,t){let n=t.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(e,t.graphic,()=>t.newValue!=null&&e!=null&&n!=null&&e.graphics3DSymbol.updateTransform(e,n.spatialReference,t.newValue,t.action))}_graphicUpdateGeometryOrTransformHandler(e,t,n){if(t.geometry!=null){if(e==null){let e=t.symbol?.id;if(e){let t=this._symbols.get(e);if(t!=null&&t.loadStatus===0)return}this._recreateGraphic(t);return}n()||this._recreateGraphic(e.graphic)}else this._recreateGraphic(t)}_graphicUpdateSymbolHandler(e,t){let n=t.graphic,r=e==null?t.oldValue==null?null:this._symbols.get(t.oldValue.id):e.graphics3DSymbol;if(r==null||t.newValue==null)return void this._recreateGraphic(n);let i=r.symbol,a=this._getConvertedSymbol(t.newValue);if(a!=null&&(a.type!==i.type||a.type===`web-style`)||i.type===`web-style`)return void this._recreateGraphic(n);let o=this._graphicsBySymbol.get(i.id);if(o&&o.size!==1)return void this._recreateGraphic(n);let s=Ae(i,a);if(s==null)return void this._updateSymbolMapping(i.id,a);let c={diff:s,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(c),!Ft(c.diff))return void this._recreateGraphic(n);let l=this._getRenderingInfo(n,!1);if(l==null)return void this._recreateGraphic(n);let u=r.extentPadding;for(let e of c.symbolStatePatches)e();if(u!==r.extentPadding&&this._recomputeExtentPadding(),e!=null)for(let t of c.graphics3DGraphicPatches)t(e,l);this._updateSymbolMapping(i.id,a)}_graphicUpdateVisibleHandler(e){this._updateUserVisibility(e)&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}recreateGraphics(e){this._suspendSymbolCleanup=!0,this.remove(e),this.add(e),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===1&&this._cleanupSymbols()}_recreateGraphic(e){this.recreateGraphics([e])}_beginGraphicUpdate(e){let t=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(e.uid,t),this._graphicsWaitingForSymbol.size===1&&this.notifyChange(`dataUpdating`),t}_endGraphicUpdate(e,t){e&&(t&&this._graphicStateTracking?.updateGraphicError(e,t),this._graphicsWaitingForSymbol.delete(e.uid),this._graphicsWaitingForSymbol.size===0&&(this._cleanupSymbols(),this.notifyChange(`dataUpdating`)))}_recomputeExtentPadding(){let e=0;this._symbols.forEach(t=>{t!=null&&(e=Math.max(e,t.extentPadding))}),this._set(`extentPadding`,e)}_expandComputedExtent(e){let t=hi,n=e.spatialReference;fn(e,t);let r=this._viewSpatialReference,a=pi.tmpVec;if(i(n,r)||bt(t[0],t[1],0,n,a,r)&&(t[0]=a[0],t[1]=a[1],bt(t[3],t[4],0,n,a,r),t[3]=a[0],t[4]=a[1]),!(isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])))return;let o=this.computedExtent,s=null,c=isFinite(t[2])&&isFinite(t[5]),l=c&&(o?.zmin==null||t[2]<o.zmin),u=c&&(o?.zmax==null||t[5]>o.zmax);o?(t[0]<o.xmin||t[1]<o.ymin||t[3]>o.xmax||t[4]>o.ymax||l||u)&&(s=this._propertiesPool.get(`computedExtent`),s.xmin=Math.min(t[0],o.xmin),s.ymin=Math.min(t[1],o.ymin),s.xmax=Math.max(t[3],o.xmax),s.ymax=Math.max(t[4],o.ymax),s.spatialReference=r):(s=this._propertiesPool.get(`computedExtent`),s.xmin=t[0],s.ymin=t[1],s.xmax=t[3],s.ymax=t[4],s.spatialReference=r),s&&(l&&(s.zmin=t[2]),u&&(s.zmax=t[5]),this._set(`computedExtent`,s))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&=(this._elevationInfoChangeAbortController.abort(),null)}async elevationInfoChange(){this._abortElevationInfoChange();let e=new AbortController;this._elevationInfoChangeAbortController=e;let t=Nn(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await An(t,this._viewSpatialReference,e.signal,u.getLogger(this)),T(e.signal),this._elevationInfoChangeAbortController=null,this._labeler?.elevationInfoChange(),this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`elevationInfo`,t)?t?.forEach(e=>{let t=e.graphic,n=e.labelLayers;for(let e of n)e.graphics3DSymbolLayer.graphics3DGraphicLayerElevationInfoChanged(t,e)}):this._recreateSymbol(n)}),this.updateStageLayerElevationProvider(),this._elevationAlignment?.elevationInfoChange()}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?this.layer.elevationInfo?.mode!==`relative-to-scene`&&this._numberOfGraphicsProvidingElevation!==0||(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=x(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&this.layer.elevationInfo.mode!==`relative-to-scene`)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new R({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register(2,this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){this.clear(),this._filterVisibility!=null&&this._filterVisibility.clear(),this._labeler?.reset(),this._deconflictor?.clear(),this._elevationAlignment?.clear(),this.stageLayer?.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&=(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),x(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(e=!1){if(!this._startCreateGraphics)return;let{loadedGraphics:t,view:n}=this.owner,r=n.basemapTerrain?.tilingScheme&&t?.length?t.toArray():null;!e&&r||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=In(this.layer.screenSizePerspectiveEnabled),this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set(`computedExtent`,null),r&&(e?this.add(r):this.recreateGraphics(r))}_recreateSymbol(e){let t=this._graphicsBySymbol.get(e),n=[];t&&(t.forEach((e,t)=>{let r=e.usedMemory;this._conditionalRemove(e,t),this._spatialIndex?.remove(e),n.push(e.graphic),e.destroy(),this._removeGraphics3DGraphic(t,r),this._updateLayerVisibility(),this._featureStore.events.emit(`changed`),this.owner.notifyContentGeometryUpdate?.()}),this._graphicsBySymbol.set(e,new Map));let r=this._symbols.get(e);x(r),this._symbols.delete(e),this._symbolMaterials=null,x(this._unusedSymbolsCache.pop(e)),this.add(n)}_recreateGraphicsForSymbol(e){let t=this._graphicsBySymbol.get(e);if(t){let e=[];t.forEach(t=>e.push(t.graphic)),this.recreateGraphics(e)}}_conditionalRemove(e,t){this._graphicsDrapedUids.delete(t),this._objectStates?.removeGraphic(e),this._labeler?.removeGraphic(e),this._deconflictor?.removeGraphic(e),this._graphicStateTracking!=null&&this._graphicStateTracking.removeGraphic(e)}add(e){e&&e.length!==0&&(this.owner.view.basemapTerrain?.tilingScheme?(this._updatePolicyForGraphics(e)===0?this._addDelayed(e):this._addImmediate(e),this.notifyChange(`dataUpdating`)):u.getLogger(this).error(`#add()`,`Cannot add graphics before terrain surface has been initialized`))}_updatePolicyForGraphics(e){if(this.effectiveUpdatePolicy===1&&(this.layer.geometryType===`mesh`||this.layer.geometryType==null)){for(let t of e)if(t.geometry!=null&&t.geometry.type===`mesh`&&!t.geometry.loaded)return 0}return this.effectiveUpdatePolicy}_addImmediate(e){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(let t of e)this._addGraphic(t,this._getRenderingInfo(t),1);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_addDelayed(e){for(let t of e){let e=t.uid,n=this._pendingUpdates.get(e);n?n.add?n.state!==0&&n.abortController?.abort():this._pendingAdds++:(n=new gi,this._pendingAdds++,this._pendingUpdates.set(e,n)),n.add=t}this.notifyChange(`readyToRun`),this.notifyChange(`updatingRemaining`),this.notifyChange(`dataUpdating`)}remove(e){this.effectiveUpdatePolicy===0?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange(`dataUpdating`)}_removeImmediate(e){for(let t of e)this._removeGraphic(t);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_removeDelayed(e){for(let t of e){let e=t.uid,n=this._pendingUpdates.get(e);if(n)n.add&&(n.remove?n.add=null:this._pendingUpdates.delete(e),n.state===1&&n.abortController?.abort(),this._pendingAdds--);else{let n=new gi;n.remove=t,this._pendingUpdates.set(e,n),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}this._pendingUpdates.size===0&&this._finishPendingUpdates(),this.notifyChange(`readyToRun`),this.notifyChange(`updatingRemaining`),this.notifyChange(`dataUpdating`)}_finishPendingUpdates(){this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&u.getLogger(this).warn(`pendingAdds/Removes in inconsistent state!`),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyFocusAreasUpdates(e){for(;this._focusAreasGraphicsQueue.length>0&&!e.done;){e.madeProgress();let t=this._focusAreasGraphicsQueue.pop(),n=ir(t.graphic.geometry);if(n==null)continue;let r=this.stage.view.focusAreasView?.containsGeometry(n)??!0;t.layers.forEach(e=>{e.stageObject&&e.stageObject.geometries.some(e=>e.material instanceof Wn&&e.material.parameters.isFocused!==r)&&this.recreateGraphics([t.graphic])})}this._focusAreasGraphicsQueue.length===0&&this.notifyChange(`readyToRun`)}_applyPendingUpdates(e){if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,this._pendingUpdates.size===0&&this._spatialIndex?.updating)return this._spatialIndex.update(),void e.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(let[t,n]of this._pendingUpdates){if(e.done){this._applyPendingRemovesFirst=!0;break}if(n.remove&&!n.add&&(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(n.remove),n.remove=null,this._pendingUpdates.delete(t),this._pendingRemoves===0))break}}for(let[t,n]of this._pendingUpdates){if(e.done)break;n.add&&n.state===0&&this._processPendingUpdateNew(n);let r=this.effectiveUpdatePolicy;if(!n.remove||n.add&&n.state!==2||(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(n.remove),n.remove=null,r=1),n.add)switch(n.state){case 2:this._addGraphic(n.add,n.renderingInfo,r),n.add=null,this._pendingAdds--,e.madeProgress();break;case 3:n.add=null,this._pendingAdds--}n.remove==null&&n.add==null&&this._pendingUpdates.delete(t)}this._pendingUpdates.size===0&&(this._finishPendingUpdates(),this.notifyChange(`readyToRun`),this.notifyChange(`dataUpdating`))}_processPendingUpdateNew(e){if(!e.add)return void(e.state=2);let t=e.add.geometry;t==null||t.type!==`mesh`||t.loaded?this._processPendingUpdateNewRenderingInfo(e):this._processPendingUpdateNewMesh(e,t)}async _processPendingUpdateNewMesh(e,t){e.state=1,e.abortController=new AbortController;let n=e.abortController.signal;try{await t.load({signal:n})}catch(t){return this._processPendingUpdateNewError(e,t)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e)}_processPendingUpdateNewError(e,t){e.abortController=null,dt(t)?e.state=0:e.state=3}async _processPendingUpdateNewRenderingInfo(e){if(this.layer.renderer==null||this.layer.renderer.type!==`dictionary`)return e.renderingInfo=this._getRenderingInfo(e.add),void(e.state=2);e.state=1,e.abortController=new AbortController;let t=null;try{t=await this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal})}catch(t){e.abortController=null,dt(t)?e.state=0:e.state=3;return}t?.symbol==null?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,u.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),e.renderingInfo=null):e.renderingInfo=t,e.state=2}_addGraphic(e,t,n){if(this._graphicsWithoutSymbol.set(e.uid,e),t?.symbol==null||!mn(e))return;let r=this.stage.renderView.olidRenderHelper;if(r&&this.setUidToIdOnAdd){let t=Mt(this.owner.view,this.owner.layerViewUid);r.setUidToObjectAndLayerId(e.objectId,e.uid,this.layer.id,this.owner.layerViewUid,Be(this.layer)&&!!this.layer.popupEnabled&&!t&&rn(this.layer,this.owner.view.popup?.defaultPopupTemplateEnabled))}let i=t.symbol,a=this.getOrCreateGraphics3DSymbol(i,t.renderer);if(a==null)return;this._expandComputedExtent(e.geometry);let o=this._beginGraphicUpdate(e),s=new Sr(e,t,this.layer),c=!1,l=e=>{e===a.symbol.id&&(c=!0)};this._whenSymbolRemoved.push(l);let u=()=>{if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(l),this._graphicsWaitingForSymbol.get(e.uid)!==o||c||a.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==a.symbol.id)--a.referenced,this._cleanupSymbols();else{let t=this._createGraphics3DGraphic(a,s);this._spatialIndex&&t!=null&&this._spatialIndex.add(t),--a.referenced,this._endGraphicUpdate(e)}this._featureStore.events.emit(`changed`),this.owner.notifyContentGeometryUpdate?.(),this._labeler?.setDirty()}},d=t=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(l),c||(dt(t)?this.add([e]):a.destroyed||this._endGraphicUpdate(e,t)))};++this._loadingSymbols,n===0?a.load(()=>this._dataUpdateQueue.push(u,null).catch(Qe),e=>this._dataUpdateQueue.push(()=>d(e),null).catch(Qe)):a.load(u,d)}_removeGraphic(e){let t=e.uid,n=this.graphics3DGraphics.get(t);if(n){n.graphics3DSymbol.onRemoveGraphic(n);let e=n.usedMemory,r=n.isElevationSource;this._conditionalRemove(n,t),this._spatialIndex?.remove(n);let i=n.graphics3DSymbol.symbol.id;this._graphicsBySymbol.get(i)?.delete(t),this._graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,e,r),n.destroy(),this._featureStore.events.emit(`changed`),this.owner.notifyContentGeometryUpdate?.()}else this._graphicsWithoutSymbol.delete(t),this._graphicsWaitingForSymbol.delete(t),this._graphicsWaitingForSymbol.size===0&&(this._cleanupSymbols(),this.notifyChange(`dataUpdating`))}_hasLabelingContext(e){if(e instanceof Te||e instanceof oe){let t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some(t=>t.symbol===e)}return!1}_hasValidSymbolCreationContext(e){return!(e instanceof Te&&!this._hasLabelingContext(e))||(u.getLogger(this).error(`LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported.`),!1)}_getRenderingInfo(e,t=!0){let n=e.geometry;if(n==null)return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,u.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!Nt(n.spatialReference,this._viewSpatialReference))return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,u.getLogger(this).warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&e.symbol!=null)return t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,u.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;let r=this.rendererHasGeometryOperations?ln(e,this.layer,null):e,i;if(this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||this.currentRenderer!=null))i=this.owner.getRenderingInfo(r,this.currentRenderer,this._arcadeOnDemand);else{let e=r.symbol||mt(r.geometry);i=new Xn(null,e)}return i?.symbol==null?(t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,u.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):i}_getRenderingInfoAsync(e,t){if(e.geometry==null)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,u.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&e.symbol!=null)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,u.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;let n=this.rendererHasGeometryOperations?ln(e,this.layer,null):e;return this.owner.getRenderingInfoAsync(n,this.currentRenderer,this._arcadeOnDemand,t)}_createGraphics3DSymbol(e,t){if(!this._hasValidSymbolCreationContext(e))return null;let n=this._getConvertedSymbol(e);if(!n)return null;let r;if(t!=null&&`backgroundFillSymbol`in t&&t.backgroundFillSymbol){let e=h(t.backgroundFillSymbol,{ignoreDrivers:!0});e.symbol!=null&&(r=e.symbol.symbolLayers)}let i=ti(n,this.symbolCreationContext,r);return i.load(()=>{let e=i.extentPadding;e>this.extentPadding&&this._set(`extentPadding`,e),this.notifyChange(`averageSymbolComplexity`)},()=>{}),i}getOrCreateGraphics3DSymbol(e,t){let n=this._symbols.get(e.id);return n===void 0&&(n=this._unusedSymbolsCache.pop(e.id)??(e instanceof te?new ni(e,e=>this._dataUpdateQueue.push(e,null),e=>this._createGraphics3DSymbol(e,t)):this._createGraphics3DSymbol(e,t)),this._symbols.set(e.id,n),this._symbolMaterials=null),n!=null&&++n.referenced,n}trackGraphicState(e){return this._graphicStateTracking??=new ii(this),this._graphicStateTracking.add(e)}_addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this._numberOfGraphics++,e.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(e,t,n=!1){this._usedMemory-=t,this.graphics3DGraphics.delete(e),this._numberOfGraphics--,n&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(e,t){let{graphic:n}=t;if(this._graphicsWithoutSymbol.delete(n.uid),!this._symbols.has(e.symbol.id))return this.add([n]),null;if(this.graphics3DGraphics.has(n.uid))return null;let r=e.createGraphics3DGraphic(t);if(r==null)return null;this._addGraphics3DGraphic(r);let i=e.symbol.id;if(this._graphicsBySymbol.has(i)||this._graphicsBySymbol.set(i,new Map),this._graphicsBySymbol.get(i).set(n.uid,r),r.isDraped&&this._graphicsDrapedUids.add(n.uid),r.centroid=null,n.geometry!=null&&n.geometry.type!==`point`&&(r.centroid=Un(n.geometry,this._viewSpatialReference)),this._updateUserVisibility(r),this._scaleVisibility!=null&&this._scaleVisibility.updateVisibility(r),this._filterVisibility!=null){let{defaultVisibility:e}=this._filterVisibility;r.setVisibilityFlag(1,4,e),e||this._filterVisibility.reapply()}this._deconflictor?.addGraphic(r),this._labeler?.addGraphic(r),this._objectStates?.addGraphic(r),r.initialize(this.stageLayer),this._graphicStateTracking!=null&&this._graphicStateTracking.addGraphic(r);let a=this._whenGraphics3DGraphicRequests[n.uid];return a&&(delete this._whenGraphics3DGraphicRequests[n.uid],a.resolve(r)),this._symbolMaterials=null,r}async rendererChange(e){if(this._rendererChangeAbortController=we(this._rendererChangeAbortController),e!==this.currentRenderer)if(this._validateRenderer(e),e??this._currentRendererChange(null,!1),fr(e))if(e?.arcadeRequired){let t=new AbortController;this._rendererChangeAbortController=t;let{arcadeUtils:n}=await this._ensureArcade();T(t);let r=n.hasGeometryOperations(e);r&&(await n.enableGeometryOperations(),T(t)),this.effectiveUpdatePolicy===0?await this._updateQueue.push(()=>this._currentRendererChange(e,r),t.signal):this._currentRendererChange(e,r),this._rendererChangeAbortController=null}else if(this.effectiveUpdatePolicy===0){let t=new AbortController;this._rendererChangeAbortController=t,await this._updateQueue.push(()=>this._currentRendererChange(e,!1),t.signal),this._rendererChangeAbortController=null}else this._currentRendererChange(e,!1);else this._currentRendererChange(e,!1)}async _ensureArcade(){return this._arcadeOnDemand??=await r(),this._arcadeOnDemand}_currentRendererChange(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=this._arcadeOnDemand;let n=this.symbolCreationContext.renderer;if(e===n)return;if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),e==null)return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();let r=Ae(n,e);this._updateUnchangedSymbolMappings(r,e,n),this.symbolCreationContext.renderer=e,r!=null&&(r.type===`complete`?this.recreateAllGraphicsAndSymbols():r.type===`partial`&&(this._applyRendererDiff(r,e,n)?this._labeler?.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange(`averageSymbolComplexity`))}_diffHasSymbolChange(e){for(let t in e.diff)switch(t){case`visualVariables`:case`defaultSymbol`:case`uniqueValueInfos`:break;case`uniqueValueGroups`:case`authoringInfo`:case`fieldDelimiter`:delete e.diff[t];break;default:return!0}return!1}_applySymbolSetDiff(e,t,n){e||=[],t||=[];let r=[];for(let i of t){let t=this._graphicsBySymbol.get(i.id);t&&t.forEach((a,o)=>{let s=a.graphic,c=this.layer instanceof ye?this.layer:null,l=this._arcadeOnDemand;if(i===n.defaultSymbol&&n.getSymbol(ln(s,c,null),{arcade:l})===n.defaultSymbol)return;let u=a.usedMemory;e.length||n.defaultSymbol?r.push(s):this._graphicsWithoutSymbol.set(o,s);let d=this.graphics3DGraphics.get(o);this._conditionalRemove(d,o),a.destroy(),t.delete(o),this._removeGraphics3DGraphic(o,u),this._updateLayerVisibility()}),this._whenSymbolRemoved.forAll(e=>e(i.id))}(e.length||r.length)&&(this._graphicsWithoutSymbol.forEach(e=>r.push(e)),this._graphicsWithoutSymbol.clear(),this.add(r)),this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_applyUniqueValueRendererDiff(e,t,n){let r=e.diff.defaultSymbol,i=e.diff.uniqueValueInfos;if(r||i){let a=i?.changed,o=i?.unchanged;if(a&&o&&a.some(e=>o.some(t=>t.oldValue.symbol?.id===e.oldValue.symbol?.id)))return!1;let s=i?i.added.map(e=>e.symbol).filter(gt):[],c=i?i.removed.map(e=>e.symbol).filter(gt):[];if(a)for(let e=0;e<a.length;e++)s.push(a[e].newValue.symbol),c.push(a[e].oldValue.symbol);return r?(n.defaultSymbol&&c.push(n.defaultSymbol),t.defaultSymbol&&s.push(t.defaultSymbol)):n.defaultSymbol&&s.length&&c.push(t.defaultSymbol),this._applySymbolSetDiff(s,c,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(e,t,n){if(t?.type!==`unique-value`||n?.type!==`unique-value`||e!=null&&e.type!==`partial`)return[];let r=e=>e==null?null:e.id,i=e&&e.diff,a=i?.defaultSymbol,o=i&&i.uniqueValueInfos,s;if(o)s=o.unchanged.map(e=>({oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)}));else{s=[];for(let e of n.uniqueValueInfos??[]){let n=r(e.symbol),i=t.uniqueValueInfos?.find(t=>t.value===e.value);i&&n!==r(i.symbol)&&s.push({oldId:n,newId:r(i.symbol)})}}return!a&&n.defaultSymbol&&s.push({oldId:r(n.defaultSymbol),newId:r(t.defaultSymbol)}),s}_updateSymbolMapping(e,t){let n=t!=null&&t?typeof t==`string`?t:t.id:null;if(e==null||e===n)return;let r=this._graphicsBySymbol.get(e);this._graphicsBySymbol.delete(e),r!==void 0&&this._graphicsBySymbol.set(n,r);let i=this._symbols.get(e);if(i!==void 0&&(this._symbols.delete(e),this._symbols.set(n,i),this._symbolMaterials=null,i!=null)){let e=typeof t==`string`?null:t;e==null?i.symbol.id=n:i.symbol=e}}_updateUnchangedSymbolMappings(e,t,n){let r=this._calculateUnchangedSymbolMapping(e,t,n);for(let{oldId:e,newId:t}of r)this._updateSymbolMapping(e,t)}_applyRendererDiff(e,t,n){if(this._diffHasSymbolChange(e))return!1;if(t instanceof ot&&n instanceof ot&&this._applyUniqueValueRendererDiff(e,t,n)&&Object.keys(e.diff).length===0)return!0;for(let n of this._graphicsBySymbol.keys()){let r=this._symbols.get(n);if(r!=null)switch(r.applyRendererDiff(e,t)){case 0:this._recreateSymbol(n);break;case 1:this._recreateGraphicsForSymbol(n)}}return!0}terrainTransparencyChange(){this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`terrainTransparency`,t)||this._recreateSymbol(n)}),this.labeler?.reset()}opacityChange(){this._updateStageLayerVisibility(),this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged(`opacity`,t))}_screenSizePerspectiveEnabledChange(){this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged(`screenSizePerspectiveEnabled`,t)),this._labeler?.screenSizePerspectiveEnabledChanged(),this._deconflictor?.screenSizePerspectiveEnabledChanged()}_slicePlaneEnabledChange(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.sliceable=e,this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged(`slicePlaneEnabled`,t)),this._deconflictor?.slicePlaneEnabledChange(),this._labeler?.slicePlaneEnabledChange())}_physicalBasedRenderingChange(e){this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`physicalBasedRenderingEnabled`,t)||this._recreateSymbol(n)})}_skipHighSymbolLoDsChange(e){this.symbolCreationContext.skipHighSymbolLods=e,this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`skipHighSymbolLods`,t)||this._recreateSymbol(n)})}_pixelRatioChange(){this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`pixelRatio`,t)||this._recreateSymbol(n)})}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=je(()=>{this._updatingPendingLoadedGraphicsChange=null})}setClippingExtent(e,t){let n=this.symbolCreationContext.clippingExtent,r=C();return di(e,r,t)?this.symbolCreationContext.clippingExtent=xt(a(),r):this.symbolCreationContext.clippingExtent=null,!lt(this.symbolCreationContext.clippingExtent,n)}modifyGraphics3DGraphicVisibilities(e){if(this.destroyed)return;let t=!1;this.graphics3DGraphics.forEach(n=>{e(n)&&(t=!0)}),t&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}forEachGraphics3DSymbol(e,t){for(let[t,n]of this._symbols){if(n==null)return;e(n,this._graphicsBySymbol.get(t)||vi,t)}if(!t?.excludeUnused)for(let t of this._unusedSymbolsCache)e(t,void 0,t.symbol.id)}updateGraphicsVisibilities(){this._filterVisibility!=null&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities(e=>{let t=this._updateUserVisibility(e),n=!!this._scaleVisibility?.updateVisibility(e);return t||n})}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(1,1,!1))}_validateRenderer(e){let t=()=>`'${this.layer.title?`${this.layer.title}, `:``}id:${this.layer.id}'`,n=pr(e,{geometryType:this.layer?.geometryType,logWarning:(e,n)=>u.getLogger(this).warn(e,`Symbology conversion for layer ${t()}: ${n}`)});if(n){let e=`Renderer for layer ${t} is not supported in a SceneView`;u.getLogger(this).warn(e,n.message)}}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let e=!1;this._symbols.forEach((t,n)=>{if(t==null||t.referenced>0)return;let r=this._graphicsBySymbol.get(n);r&&r.size!==0||(this._graphicsBySymbol.delete(n),this._symbols.delete(n),this._symbolMaterials=null,this._unusedSymbolsCache.put(n,t,-3),e=!0)}),e&&(this._recomputeExtentPadding(),this.notifyChange(`averageSymbolComplexity`))}get test(){}get performanceInfo(){return new ri(this.graphics3DGraphics.size,Array.from(this.graphics3DGraphics.values()).reduce((e,t)=>e+(t.isVisible()?1:0),0),this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}};S([s({readOnly:!0})],H.prototype,`computedExtent`,void 0),S([s()],H.prototype,`currentRenderer`,void 0),S([s()],H.prototype,`rendererHasGeometryOperations`,void 0),S([s()],H.prototype,`_frameTaskHandle`,void 0),S([s()],H.prototype,`_dataUpdateQueue`,void 0),S([s()],H.prototype,`_updateQueue`,void 0),S([s({readOnly:!0})],H.prototype,`_viewSpatialReference`,null),S([s()],H.prototype,`_rendererChangeAbortController`,void 0),S([s()],H.prototype,`_elevationInfoChangeAbortController`,void 0),S([s()],H.prototype,`_initializeAbortController`,void 0),S([s()],H.prototype,`_elevationAlignment`,void 0),S([s()],H.prototype,`_scaleVisibility`,void 0),S([s()],H.prototype,`_filterVisibility`,void 0),S([s()],H.prototype,`_initializePromise`,void 0),S([s()],H.prototype,`_spatialIndex`,void 0),S([s({readOnly:!0})],H.prototype,`extentPadding`,void 0),S([s()],H.prototype,`_updatingPendingLoadedGraphicsChange`,void 0),S([s()],H.prototype,`_featureStore`,void 0),S([s()],H.prototype,`_objectStates`,void 0),S([s()],H.prototype,`_loadingSymbols`,void 0),S([s({constructOnly:!0})],H.prototype,`compressionTracker`,void 0),S([s()],H.prototype,`preferredUpdatePolicy`,void 0),S([s()],H.prototype,`_forcedUpdatePolicy`,void 0),S([s({readOnly:!0})],H.prototype,`effectiveUpdatePolicy`,null),S([s({constructOnly:!0})],H.prototype,`elevationFeatureExpressionEnabled`,void 0),S([s({constructOnly:!0})],H.prototype,`owner`,void 0),S([s({constructOnly:!0})],H.prototype,`layer`,void 0),S([s({constructOnly:!0})],H.prototype,`graphicSymbolSupported`,void 0),S([s({constructOnly:!0})],H.prototype,`getRenderingInfoWithoutRenderer`,void 0),S([s({constructOnly:!0})],H.prototype,`componentFactories`,void 0),S([s({constructOnly:!0})],H.prototype,`setUidToIdOnAdd`,void 0),S([s()],H.prototype,`featureStore`,null),S([s()],H.prototype,`initializePromise`,null),S([s()],H.prototype,`scaleVisibility`,null),S([s()],H.prototype,`elevationAlignment`,null),S([s()],H.prototype,`objectStates`,null),S([s()],H.prototype,`filterVisibility`,null),S([s({readOnly:!0})],H.prototype,`updating`,null),S([s({readOnly:!0})],H.prototype,`dataUpdating`,null),S([s({readOnly:!0})],H.prototype,`readyToRun`,null),S([s({readOnly:!0})],H.prototype,`suspendedOrOutsideOfView`,null),S([s({readOnly:!0,dependsOn:[]})],H.prototype,`updatingRemaining`,null),S([s({readOnly:!0})],H.prototype,`displayFeatureLimit`,null),S([s({readOnly:!0,dependsOn:[]})],H.prototype,`averageSymbolComplexity`,null),S([s({constructOnly:!0})],H.prototype,`hasZ`,void 0),S([s({constructOnly:!0})],H.prototype,`hasM`,void 0),S([s()],H.prototype,`_objectIdField`,null),H=pi=S([v(`esri.views.3d.layers.graphics.Graphics3DCore`)],H);var gi=class{constructor(){this.add=null,this.renderingInfo=null,this.state=0,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=0,this.abortController=null,this.remove=null}},_i=10,U=O(),W=O(),vi=new Map,yi=.05,bi=class{constructor(){this._extents=new kt({allocator:e=>e||C()}),this._tmpExtent=C(),this._dirty=!1}destroy(){this._extents.prune()}get empty(){return this._extents.length===0}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this._contains(e)||(this._removeContained(e),He(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(e){return this._mergeTight(e),e.hasProgressed}_mergeTight(e=ve){let t=this._extents,n=new Set,r=0;for(;r!==t.length;){t.sort((e,t)=>e[0]-t[0]),r=t.length,n.clear();for(let r=0;r<t.length;++r){if(e.done)return;let i=t.at(r);if(i){for(let e=r+1;e<t.length;++e){let r=t.at(e);if(r==null||r[0]>=i[2])break;n.add(r)}n.forEach(r=>{if(i===r)return;if(r[2]<=i[0])return void n.delete(r);let a=yt(i),o=yt(r),s=this._tmpExtent;pt(i,r,s);let c=a+o;(yt(s)-c)/c<yi&&(He(i,s),n.delete(r),t.remove(r),e.madeProgress())}),n.add(i)}}}this._dirty=!1}_contains(e){return this._extents.some(t=>Pe(t,e))}_removeContained(e){this._extents.filterInPlace(t=>!Pe(e,t))}get test(){}},G=class extends o{constructor(e){super(e),this._dirtyExtents=new bi,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new Re}initialize(){let e=this.elevationProvider;this._task=this.graphicsCoreOwner.view.resourceController.scheduler.registerTask(xi(this.graphicsCore.layer.elevationInfo?.mode),this),this.addHandles([e.on(`elevation-change`,e=>this._elevationChanged(e)),E(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,E(()=>xi(this.graphicsCore.layer.elevationInfo?.mode),e=>this._task.priority=e)])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null,this._dirtyExtents.destroy()}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange(`updating`)}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange(`updating`))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange(`updating`)}get updating(){return this.readyToRun}get readyToRun(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(e){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run(()=>this._dirtyExtents.merge(e));this.readyToRun&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.notifyChange(`updating`)}_updateDirtyGraphics(e){let t=this.graphicsCoreOwner.view.renderCoordsHelper,n=this.graphicsCore.effectiveUpdatePolicy===0;for(let r of this._dirtyGraphicsSet.keys()){let i=this.graphicsCore.getGraphics3DGraphicById(r);if(this._dirtyGraphicsSet.delete(r),i!=null&&(i.alignWithElevation(this.elevationProvider,t,n),this.graphicsCore.deconflictor?.setDirty(),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this._dirtyExtents.empty&&!e.done;){let t=this._dirtyExtents.pop(),{spatialReference:n}=this.elevationProvider;this.events.emit(`invalidate-elevation`,{extent:t,spatialReference:n});let r=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,n,e=>{let t=this.graphicsCore.getGraphics3DGraphicById(e);t!=null&&t.needsElevationUpdates()&&this._dirtyGraphicsSet.add(e)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-r)+.9*this._averageExtentUpdateSize,e.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((e,t)=>this._dirtyGraphicsSet.add(t))}_elevationChanged(e){if(e.context===`scene`&&(!this.graphicsCore.layer.elevationInfo||this.graphicsCore.layer.elevationInfo.mode!==`relative-to-scene`))return;let t=e.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){let e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this._updateElevation=!0)}this.events.emit(`invalidate-elevation`,e)}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange(`updating`)}};function xi(e){return e==null?y.ELEVATION_ALIGNMENT:e===`relative-to-scene`?y.ELEVATION_ALIGNMENT_SCENE:y.ELEVATION_ALIGNMENT}S([s()],G.prototype,`graphicsCoreOwner`,void 0),S([s()],G.prototype,`graphicsCore`,void 0),S([s()],G.prototype,`queryGraphicUIDsInExtent`,void 0),S([s()],G.prototype,`elevationProvider`,void 0),S([s({readOnly:!0})],G.prototype,`updating`,null),S([s({readOnly:!0})],G.prototype,`updatingRemaining`,null),G=S([v(`esri.views.3d.layers.graphics.Graphics3DElevationAlignment`)],G);function Si(e,t,n,r){return Ei(e,t,n,wi(r,t,n,!0))}var Ci={dir:O(),len:0,clip:Oe()};function wi(e,t,n,r){let i=Ci;return e?(n&&r&&(i.len=Pt(t,n)),ae(i.dir,e)):r?(i.len=Pt(t,n),st(i.dir,n,t),g(i.dir,i.dir,1/i.len)):(st(i.dir,n,t),ft(i.dir,i.dir)),i}function Ti(e,t,n){let r=Ot(Vt(e),n.dir),i=-Ht(e,t);if(i<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return i>0;if((i<0||r<0)&&!(i<0&&r<0))return!0;let a=i/r;return r>0?a<n.clip[1]&&(n.clip[1]=a):a>n.clip[0]&&(n.clip[0]=a),n.clip[0]<=n.clip[1]}function Ei(e,t,n,r){r.clip[0]=0,r.clip[1]=n?r.len:Number.MAX_VALUE;for(let n=0;n<e.length;n++)if(!Ti(e[n],t,r))return!1;return!0}var Di=.5*Math.PI,Oi=Di/Math.PI*180,ki=class{constructor(e){this._extent=[,,,,],this._planes=[,,,,,,],this._maxSpan=0,this._center={origin:O(),direction:O()},this._renderCoordsHelper=e.renderCoordsHelper;for(let e=0;e<4;e++)this._extent[e]={origin:O(),direction:O(),cap:{next:null,direction:O()}},this._planes[e]=Gt();this._planes[4]=Gt(),this._planes[5]=Gt(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,n,r=!0){let i=this._extent;this._toRenderBoundingExtent(e,t,n),Ee(this._center.origin,i[0].origin,i[2].origin),g(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),r||g(this._center.direction,this._center.direction,-1);for(let e=0;e<4;e++){let t=i[e];this._renderCoordsHelper.worldUpAtPosition(t.origin,t.direction);let n=i[e===3?0:e+1];t.cap.next=n.origin,jt(t.cap.direction,t.origin,n.origin),Wt(t.direction,t.cap.direction,t.origin,this._planes[e]),r||g(t.direction,t.direction,-1)}Wt(i[0].cap.direction,i[1].cap.direction,i[0].origin,this._planes[4]),r?Ut(this._planes[4],this._planes[5]):(Bt(this._planes[5],this._planes[4]),Ut(this._planes[4],this._planes[4])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*Ze(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,n=!1){if(e==null)return!1;if(this._renderCoordsHelper.viewingMode===1){let n=this._maxSpanSpatialReference.isGeographic?Oi:Di*t;if(this._maxSpan>n)return!0;if(e.altitude!=null&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(this._maxSpan===0){let t=this._extent[0];return!(n||!e.intersectsRay(on(t.origin,t.direction)))}for(let t=0;t<this._extent.length;t++){let r=this._extent[t];if(!n&&e.intersectsRay(on(r.origin,r.direction))||e.intersectsLineSegment(cn(r.origin,r.cap.next,Ni),r.cap.direction))return!0}let r=n?this._planes:this._planesWithoutFar;for(let t=0;t<e.lines.length;t++){let n=e.lines[t];if(Si(r,n.origin,n.endpoint,n.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,n){Le(e,K),K[2]=n,qt(t,K,ji,this._renderCoordsHelper.spatialReference),De(Mi,ji),k(q);for(let{x0:r,x1:i,y0:a,y1:o}of Ai)for(let s=0;s<5;s++){let c=s/4;K[0]=Se(e[r],e[i],c),K[1]=Se(e[a],e[o],c),K[2]=n,Xt(K,t,K,this._renderCoordsHelper.spatialReference),nt(K,K,Mi),me(q,K)}_(this._extent[0].origin,q[0],q[1],q[2]),_(this._extent[1].origin,q[3],q[1],q[2]),_(this._extent[2].origin,q[3],q[4],q[2]),_(this._extent[3].origin,q[0],q[4],q[2]);for(let e=0;e<4;++e)nt(this._extent[e].origin,this._extent[e].origin,ji)}_toRenderBoundingExtentLocal(e,t,n){Hr(e,t,J,this._renderCoordsHelper.spatialReference),_(this._extent[0].origin,J[0],J[1],n),_(this._extent[1].origin,J[2],J[1],n),_(this._extent[2].origin,J[2],J[3],n),_(this._extent[3].origin,J[0],J[3],n)}_toRenderBoundingExtent(e,t,n){switch(this._renderCoordsHelper.viewingMode){case 1:this._toRenderBoundingExtentGlobal(e,t,n);break;case 2:this._toRenderBoundingExtentLocal(e,t,n);break;default:l(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if(Ht(e.planes[4],this._center.origin)<0&&Ot(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){let n=this._extent[t];if(Ht(e.planes[4],n.origin)<0&&Ot(n.direction,e.direction)<0)return!0}return!1}},Ai=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],K=O(),ji=le(),Mi=le(),q=a(),J=C(),Ni=sn(),Pi=1.2,Y=class extends o{constructor(e){super(e),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){let{graphicsCoreOwner:e}=this;this._extentIntersection=new ki({renderCoordsHelper:e.view.renderCoordsHelper});let{view:t}=e,{groundView:n}=t,{scheduler:r}=t.resourceController;this.addHandles([t.on(`resize`,()=>this._viewChange()),E(()=>t.state.camera,()=>this._viewChange(),Ge),r.registerTask(y.FRUSTUM_VISIBILITY,this),E(()=>n.visibleElevationRange,()=>this._elevationRangeChange())]),t.viewingMode===`local`?this._isVisibleBelowSurface=!0:this.addHandles([E(()=>[n.baseOpacity,n.wireframe,t.map?.ground?.navigationConstraint?.type],()=>this._updateIsVisibleBelowSurface(),Ke)])}destroy(){this._set(`graphicsCoreOwner`,null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set(`updating`,!0)}setExtent(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationRangeChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){let e=this.graphicsCoreOwner.view,t=e.basemapTerrain,n=e.viewingMode===`local`,r=e.map.ground?.navigationConstraint?.type===`none`;this._isVisibleBelowSurface=n||!t.opaque||r}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;let e=this.graphicsCoreOwner.view,t;if(this._isVisibleBelowSurfaceInternal)t=-.3*Ze(e.spatialReference).radius;else{let{minElevation:n,maxElevation:r}=e.basemapTerrain.visibleElevationRange;t=n-Math.max(1,(r-n)*(Pi-1))}this._extentIntersection.update(this._extent,e.spatialReference,t)}get readyToRun(){return this.updating}runTask(e){if(this._set(`updating`,!1),!this._extent)return this._set(`suspended`,!1),qe;this._updateExtentIntersection();let{frustum:t}=this.graphicsCoreOwner.view,n=Ze(this.graphicsCoreOwner.view.spatialReference).radius;this._set(`suspended`,!this._extentIntersection.isVisibleInFrustum(t,n)),e.madeProgress()}};S([s({readOnly:!0})],Y.prototype,`suspended`,void 0),S([s({constructOnly:!0})],Y.prototype,`graphicsCoreOwner`,void 0),S([s({readOnly:!0})],Y.prototype,`updating`,void 0),Y=S([v(`esri.views.3d.layers.graphics.Graphics3DFrustumVisibility`)],Y);var Fi=class{},Ii=class extends Fi{constructor(e,t){super(),this.objectStateId=e,this.object=t}remove(){this.object.removeStateID(this.objectStateId)}},Li=class extends Fi{constructor(e,t,n){super(),this.objectStateId=e,this.object=t,this.owner=n}remove(){this.owner.removeRenderGeometryObjectState(this.object,this.objectStateId)}},Ri=class extends Fi{constructor(e,t){super(),this.objectStateId=e,this._removeCallback=t,this.object=null}remove(){this._removeCallback(this.objectStateId)}},zi=class{constructor(){this._items=[]}addObject(e,t){this._items.push(new Ii(t,e))}addRenderGeometry(e,t,n){this._items.push(new Li(t,e,n))}addExternal(e,t){this._items.push(new Ri(t,e))}remove(e){this._remove(t=>t.objectStateId===e)}removeByObject(e){this._remove(t=>t.object===e)}removeAll(){this._items.forEach(e=>e.remove()),this._items=[]}_remove(e){let{_items:t}=this;for(let n=t.length-1;n>=0;--n){let r=t[n];e(r)&&(r.remove(),t.splice(n,1))}}},Bi=class extends zi{constructor(){super(...arguments),this.stateType=1}},Vi=class extends zi{constructor(e){super(),this.highlightName=e,this.stateType=0}},Hi=class{constructor(e){this.objectIdField=e,this.ids=new Set,this.paused=!1}hasGraphic(e){let t=this.objectIdField?e.graphic.attributes[this.objectIdField]:e.graphic.uid;return this.ids.has(t)}},Ui=class extends Hi{constructor(e){super(e),this.stateType=1,this.objectStateSet=new Bi}},Wi=class extends Hi{constructor(e,t){super(t),this.highlightName=e,this.stateType=0,this.objectStateSet=new Vi(e)}},Gi=class{constructor(e){this._graphicsCore=e,this._stateSets=[]}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(e=>e.objectStateSet.removeAll()),this._stateSets.length=0)}acquireOccludeeSet(e){let t=new Ui(e);this._stateSets.push(t);let n=D(()=>this.releaseSet(t));return{set:t,handle:n}}acquireHighlightSet(e,t){let n=new Wi(e,t);this._stateSets.push(n);let r=D(()=>this.releaseSet(n));return{set:n,handle:r}}releaseSet(e){e.objectStateSet.removeAll();let t=this._stateSets?this._stateSets.indexOf(e):-1;t!==-1&&this._stateSets.splice(t,1)}setUid(e,t){e.ids.add(t);let n=this._graphicsCore.graphics3DGraphics.get(t);n&&n.addObjectStateSet(e.objectStateSet)}setUids(e,t){t.forEach(t=>this.setUid(e,t))}setObjectIds(e,t){t.forEach(t=>e.ids.add(t)),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach(t=>{!t.paused&&t.hasGraphic(e)&&e.addObjectStateSet(t.objectStateSet)})}removeGraphic(e){this._stateSets.forEach(t=>{t.hasGraphic(e)&&e.removeObjectState(t.objectStateSet)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(e=>e.objectStateSet.removeAll())}_initializeSet(e){let t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach(t=>{t&&e.hasGraphic(t)&&t.addObjectStateSet(e.objectStateSet)}):e.ids.forEach(n=>{let r=t.get(n);r&&r.addObjectStateSet(e.objectStateSet)})}get test(){}},X=class extends o{constructor(e){super(e),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this._updatingHandles=new Et,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive();let e=this.graphicsCoreOwner.view.resourceController.scheduler;this.addHandles(e.registerTask(y.SCALE_VISIBILITY,this)),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.layerMinMaxScaleChangeHandler())}destroy(){this._updatingHandles.destroy(),this.removeHandles(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this._updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(e){let t=this.graphicsCoreOwner.view.spatialReference,n=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===n)this._extent=e??null;else{let r=C();Hr(e,t,r,n)?this._extent=r:this._extent=null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){let e=this.layer,t=e.effectiveScaleRange,n=this.layerScaleEnabled&&t!=null&&Ki(t.minScale,t.maxScale);e.labelingInfo&&!n&&(n=e.labelingInfo.some(e=>e&&Ki(e.minScale??0,e.maxScale??0)));let r=this._scaleRangeActive!==n;return this._scaleRangeActive=n,n&&!this.hasHandles(Z)&&this.basemapTerrain?(this.addHandles(this.basemapTerrain.on(`scale-change`,e=>this._scaleUpdateHandler(e)),Z),this.layerScaleEnabled&&this.addHandles(this.basemapTerrain.on(`tiles-visibility-changed`,()=>this._setDirty()),Z)):!n&&this.hasHandles(Z)&&this.removeHandles(Z),r}get readyToRun(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(e){let{groundView:t}=this.graphicsCoreOwner.view;if(this._extent&&t&&t.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return qe;{this._layerScaleRangeVisibilityQuery=!0;let{minScale:e,maxScale:t}=this.layer.effectiveScaleRange;this.graphicsCoreOwner.view.basemapTerrain.queryVisibleScaleRange(this._extent,e,t,e=>this._finishUpdate(e))}}else this._finishUpdate(!0);e.madeProgress()}_finishUpdate(e){this._layerScaleRangeVisibilityQuery=!1,this._set(`suspended`,!e),this._dirty=!1}_visibleAtLayerScale(e){let t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||tn(e,t.minScale||0,t.maxScale||0)}_visibleAtLabelScale(e,t){return tn(e,t.minScale||0,t.maxScale||0)}_graphicScale(e){let t;return e.centroid==null?e.graphic.geometry!=null&&e.graphic.geometry.type===`point`&&(t=e.graphic.geometry):t=e.centroid,t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}_graphicVisible(e){if(!this.layerScaleEnabled)return!0;let t=this._graphicScale(e);return this._visibleAtLayerScale(t)}updateVisibility(e){if(!this._scaleRangeActive)return!1;let t=this._graphicVisible(e);return e.setVisibilityFlag(1,2,t)}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive||!e.labelLayers.length)return!1;let t=this._graphicScale(e),n=this._updateLabelScaleVisibility(e,t);return n&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty()),n}_updateLabelScaleVisibility(e,t){if(!e.labelLayers.length)return!1;let n=e.labelLayers[0].labelClass;if(n?.minScale!=null&&n.maxScale!=null){let r=this._visibleAtLabelScale(t,n);if(e.setVisibilityFlag(16,2,r))return!0}return!1}_scaleUpdateHandler(e){if(this._setDirty(),!this.graphicsCore.visible)return;let t=e.extent,n=e.scale,r=this._visibleAtLayerScale(n),i=!1,a=this.graphicsCoreOwner.view.spatialReference,o=e.spatialReference;if(o==null)return void u.getLogger(this).error(`scaleUpdate: Internal error, no SpatialReference given for tiles`);let s=!o.equals(a);if(s&&!Hr(t,o,qi,a))return void u.getLogger(this).error(`scaleUpdate: Internal error, cannot project AABR from `+o+` to wkid `+a);let c=s?qi:t;this.queryGraphicUIDsInExtent(c,a,e=>{let a=this.graphicsCore.getGraphics3DGraphicById(e);if(a==null)return;let o=a.centroid;o!=null&&(t[0]>o.x||t[1]>o.y||t[2]<o.x||t[3]<o.y)||(a.setVisibilityFlag(1,2,r)&&(i=!0),this._updateLabelScaleVisibility(a,n)&&(i=!0))}),i&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(1,2,!0)):this._scaleRangeActive&&this.graphicsCore.updateGraphicsVisibilities(),this._setDirty()}};function Ki(e,t){return e>0||t>0}S([s()],X.prototype,`graphicsCoreOwner`,void 0),S([s()],X.prototype,`layer`,void 0),S([s()],X.prototype,`queryGraphicUIDsInExtent`,void 0),S([s()],X.prototype,`graphicsCore`,void 0),S([s()],X.prototype,`basemapTerrain`,void 0),S([s({constructOnly:!0})],X.prototype,`layerScaleEnabled`,void 0),S([s({readOnly:!0})],X.prototype,`suspended`,void 0),S([s({readOnly:!0})],X.prototype,`updating`,null),S([s()],X.prototype,`_dirty`,void 0),X=S([v(`esri.views.3d.layers.graphics.Graphics3DScaleVisibility`)],X);var Z=`terrain-events`,qi=C();function Ji(e){return rt.isCollection(e)?e.toArray():Array.isArray(e)?e:Yi(e)||vt(e)||Zi(e)?[e]:Xi}function Yi(e){return typeof e==`number`||typeof e==`string`}var Xi=[];D();function Zi(e){return e.declaredClass===`esri.views.3d.layers.i3s.PointCloudGraphic`}var Q=class extends o{constructor(e){super(e),this.drapeSourcePriorityOffset=0,this.type=`graphics-3d`,this.graphicsCore=null,this.drapeSourceType=1,this.scaleVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this._suspendResumeExtent=null,this._updatingHandles=new Et}initialize(){let{layer:e}=this,t=`effectiveScaleRange`in e?e:null,n=!nn()&&this.scaleVisibilityEnabled&&t!=null,r=new H({owner:this,layer:this.owner.layer,preferredUpdatePolicy:1,graphicSymbolSupported:!0,componentFactories:{deconflictor:e=>this.owner.view.deconflictor.addGraphicsOwner(e),elevationAlignment:(e,t)=>new G({graphicsCoreOwner:this,graphicsCore:e,queryGraphicUIDsInExtent:t,elevationProvider:this.view.elevationProvider}),scaleVisibility:n?(e,n)=>new X({graphicsCoreOwner:this,layer:t,queryGraphicUIDsInExtent:n,graphicsCore:e,basemapTerrain:this.owner.view.basemapTerrain}):null,objectStates:e=>new Gi(e)}});if(this._set(`graphicsCore`,r),this.frustumVisibilityEnabled&&this._set(`frustumVisibility`,new Y({graphicsCoreOwner:this})),`fullOpacity`in this.owner){let e=this.owner;this._updatingHandles.add(()=>e.fullOpacity,()=>this.graphicsCore.opacityChange())}if(`elevationInfo`in e){let t=e;this._updatingHandles.add(()=>t.elevationInfo,(e,t)=>{Ae(e,t)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})}this._set(`initializePromise`,this._initializeAsync()),this._updatingHandles.addPromise(this.initializePromise)}async _initializeAsync(){try{await this.graphicsCore.initializePromise}catch(e){if(dt(e))return;throw e}this.destroyed||(this.addHandles(E(()=>this.view.clippingArea,()=>this._updateClippingExtent(),Ge)),this._updateClippingExtent(),this._setupSuspendResumeExtent(),this.graphicsCore.startCreateGraphics())}destroy(){this._updatingHandles.destroy(),this._set(`frustumVisibility`,x(this.frustumVisibility)),this._set(`graphicsCore`,x(this.graphicsCore))}get layer(){return this.owner.layer}get layerViewUid(){return this.owner.uid}get view(){return this.owner.view}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get scaleVisibilitySuspended(){return!(this.scaleVisibility==null||!this.scaleVisibility.suspended)}get frustumVisibilitySuspended(){return this.frustumVisibility!=null&&this.frustumVisibility.suspended}get suspended(){return this.owner.suspended??!1}get updating(){return!!(this.graphicsCore?.updating||this.scaleVisibility!=null&&this.scaleVisibility.updating||this.frustumVisibility!=null&&this.frustumVisibility.updating||this._updatingHandles.updating)}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner.fullOpacity??1}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}notifyContentGeometryUpdate(){this.owner.notifyContentGeometryUpdate?.()}getRenderingInfo(e,t,n){let r=Kn(e,{renderer:t,arcade:n});if(r?.color){let e=r.color;e[0]/=255,e[1]/=255,e[2]/=255}return r}getRenderingInfoAsync(e,t,n,r){return Yn(e,{renderer:t,arcade:n,...r})}getHit(e,t){if(this.owner.loadedGraphics){let n=this.owner.loadedGraphics.find(t=>t.uid===e);if(n){let e=this.layer instanceof ye?this.layer:null,r=ln(n,e,t);return{type:`graphic`,graphic:r,layer:r.layer}}}return null}whenGraphicBounds(e,t){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(e,t):Promise.reject()}computeAttachmentOrigin(e,t){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(e,t):null}getSymbolLayerSize(e,t){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(e,t):null}maskOccludee(e){let t=this.graphicsCore?.objectStates;if(!t)return D();let{set:n,handle:r}=t.acquireOccludeeSet(null);return t.setUid(n,e.uid),r}highlight(e,t){let n=this.graphicsCore?.objectStates;if(!n)return Qi;let r=Ji(e);if(r.length===0)return Qi;if(r[0]instanceof ge){let e=r.map(e=>e.uid),{set:i,handle:a}=n.acquireHighlightSet(t,null);return n.setUids(i,e),a}if(typeof r[0]==`number`){let e=r,{set:i,handle:a}=n.acquireHighlightSet(t,null);return n.setObjectIds(i,e),a}return Qi}_setupSuspendResumeExtent(){let{scaleVisibility:e,frustumVisibility:t}=this;if(e==null&&t==null)return;let n=({computedExtent:n,extentPadding:r})=>{this._suspendResumeExtent=Gn(n,this._suspendResumeExtent,Jn,r),e?.setExtent(this._suspendResumeExtent),t?.setExtent(this._suspendResumeExtent)};this.addHandles(E(()=>({computedExtent:this.graphicsCore?.computedExtent,extentPadding:this.graphicsCore?.extentPadding}),e=>n(e),ut))}_updateClippingExtent(){let e=this.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()}};S([s()],Q.prototype,`drapeSourcePriorityOffset`,void 0),S([s()],Q.prototype,`type`,void 0),S([s({constructOnly:!0})],Q.prototype,`owner`,void 0),S([s()],Q.prototype,`layer`,null),S([s()],Q.prototype,`layerViewUid`,null),S([s()],Q.prototype,`view`,null),S([s({constructOnly:!0})],Q.prototype,`graphicsCore`,void 0),S([s()],Q.prototype,`scaleVisibility`,null),S([s({constructOnly:!0})],Q.prototype,`frustumVisibility`,void 0),S([s()],Q.prototype,`elevationAlignment`,null),S([s()],Q.prototype,`scaleVisibilitySuspended`,null),S([s({readOnly:!0})],Q.prototype,`frustumVisibilitySuspended`,null),S([s()],Q.prototype,`suspended`,null),S([s({readOnly:!0})],Q.prototype,`updating`,null),S([s()],Q.prototype,`loadedGraphics`,null),S([s()],Q.prototype,`fullOpacity`,null),S([s()],Q.prototype,`slicePlaneEnabled`,null),S([s()],Q.prototype,`drapeSourceType`,void 0),S([s()],Q.prototype,`updatePolicy`,null),S([s({constructOnly:!0})],Q.prototype,`scaleVisibilityEnabled`,void 0),S([s({constructOnly:!0})],Q.prototype,`frustumVisibilityEnabled`,void 0),S([s()],Q.prototype,`initializePromise`,void 0),Q=S([v(`esri.views.3d.layers.graphics.GraphicsProcessor`)],Q);var Qi=D();async function $i(e,t,n){if(e==null||t.candidates.length===0)return ea;let i=e.graphics3DGraphicsByObjectID??e.graphics3DGraphics,a=[],o=[],{renderer:s}=e,c=s!=null&&`arcadeRequired`in s&&s.arcadeRequired?r():null,l=async(t,{graphic:r,graphics3DSymbol:i})=>{let a=await c,o=await e.getRenderingInfoAsync(r,s,a,{signal:n});return o==null?[]:i.queryForSnapping(t,d,o,n)},{candidates:u,spatialReference:d}=t;for(let e=0;e<u.length;++e){let t=u[e],{objectId:n}=t,r=typeof n==`number`?i?.get(n):void 0;if(r==null)continue;let{graphics3DSymbol:s}=r;s.symbologySnappingSupported&&(a.push(l(t,r)),o.push(e))}if(a.length===0)return ea;let f=await Promise.all(a);T(n);let p=[],ee=[];for(let e=0;e<f.length;++e){let t=f[e],n=o[e];for(let e of t)p.push(e),ee.push(n)}return{candidates:p,sourceCandidateIndices:ee}}var ea={candidates:[],sourceCandidateIndices:[]},ta=class{constructor(e,t=0,n=0,r=0,i=0,a=null){this.usedMemory=e,this.displayedFeatures=t,this.totalFeatures=n,this.maximumFeatures=r,this.nodes=i,this.core=a}},$=class extends ur(un){constructor(){super(...arguments),this.type=`graphics-3d`,this.symbologySnappingSupported=!0,this._slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.ignoresMemoryFactor=!0}get highlightOptions(){return null}initialize(){this._set(`processor`,new Q({owner:this,scaleVisibilityEnabled:!0,frustumVisibilityEnabled:!0})),this.addResolvingPromise(this.processor.initializePromise),this.addHandles(this.layer.on(`graphic-update`,e=>this.processor.graphicsCore.graphicUpdateHandler(e))),this.layer.internal?this.notifyChange(`updating`):(this.view.viewingMode===`local`&&this.addResolvingPromise((async()=>this.fullExtentInLocalViewSpatialReference=await fe(this.layer.fullExtent,this.view.spatialReference).catch(()=>null))()),this.addHandles(St(()=>this.view?.groundView?.ready,()=>()=>this.notifyChange(`updating`),{once:!0})))}destroy(){this._updatingHandles.removeAll(),this._set(`processor`,x(this.processor))}get loadedGraphics(){return this.layer.graphics}get legendEnabled(){return this.canResume()&&!this.processor?.frustumVisibilitySuspended}get visibleAtCurrentScale(){return nn()?en(this.layer.effectiveScaleRange,this.view.scale):!this.processor?.scaleVisibilitySuspended}get slicePlaneEnabled(){let e=this.layer.internal;return this._slicePlaneEnabled&&!e}set slicePlaneEnabled(e){this._slicePlaneEnabled=e}getSuspendInfo(){let e=super.getSuspendInfo();return e.outsideOfView=this.processor?.frustumVisibilitySuspended??!1,e}getHit(e){return this.processor.getHit(e,null)}whenGraphicBounds(e,t){return this.processor.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.processor?.computeAttachmentOrigin(e,t)}getSymbolLayerSize(e,t){return this.processor.getSymbolLayerSize(e,t)}queryGraphics(){return Promise.resolve(this.loadedGraphics)}maskOccludee(e){return this.processor.maskOccludee(e)}highlight(e,t){return this.processor.highlight(e,dn(t))}notifyContentGeometryUpdate(){this.emit(`visible-geometry-changed`)}async elevationAlignPointsInFeatures(e,n){let{processor:r}=this;if(r?.graphics3DGraphics==null)throw new t(`graphicslayerview3d:missing-processor`,`A Graphics3D processor is needed to resolve graphics elevation.`);let{graphics3DGraphics:i}=r;return dr(this.view,this.layer,e=>typeof e==`number`?i.get(e):void 0,e,n)}async queryForSymbologySnapping(e,t){return $i(this.processor,e,t)}get updatePolicy(){return this.processor?.graphicsCore.effectiveUpdatePolicy||1}isUpdating(){return this.view&&this.layer&&!(!this.processor?.updating&&(this.layer.internal||this.view.groundView?.ready))}get performanceInfo(){return new ta(this.usedMemory,this.loadedGraphics.length,-1,-1)}get usedMemory(){return this.processor?.graphicsCore?.usedMemory??0}get unloadedMemory(){return this.processor?.graphicsCore?.unprocessedMemoryEstimate}get test(){return{graphics3DProcessor:this.processor,loadedGraphics:this.loadedGraphics}}};S([s()],$.prototype,`highlightOptions`,null),S([s()],$.prototype,`loadedGraphics`,null),S([s({readOnly:!0})],$.prototype,`legendEnabled`,null),S([s()],$.prototype,`layer`,void 0),S([s({readOnly:!0})],$.prototype,`processor`,void 0),S([s({readOnly:!0})],$.prototype,`visibleAtCurrentScale`,null),S([s()],$.prototype,`_slicePlaneEnabled`,void 0),S([s({type:Boolean})],$.prototype,`slicePlaneEnabled`,null),$=S([v(`esri.views.3d.layers.GraphicsLayerView3D`)],$);var na=$;export{na as default};