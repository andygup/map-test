const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FeatureServiceSnappingSource-DDxPktAX.js","assets/index-CzMixifc.js","assets/index-CDgdHpAj.css","assets/boundedPlane-BwWy0U6o.js","assets/ObjectStack-DiVLRoBj.js","assets/vectorStacks-BQiry9fn.js","assets/quatf64-eO7UAs9K.js","assets/lineSegment-WEn1ku7V.js","assets/plane--nqwMDYx.js","assets/ray-XqUMyuyU.js","assets/vec3-D7a6REBc.js","assets/sphere-DkSdrT5o.js","assets/elevationInfoUtils-BcUBf70F.js","assets/WorkerHandle-CebpJ7hn.js","assets/geodesicUtils-DoIAZh7n.js","assets/dehydratedPoint-CVzHYxaL.js","assets/constraints-CZ12pnWC.js","assets/LineSnappingHint-C4TfMb_L.js","assets/DrapedEdgeSnappingCandidate-yTm_e8W9.js","assets/EdgeSnappingCandidate-CRqUhTG1.js","assets/SnappingCandidate-CgOYxD9J.js","assets/VertexSnappingCandidate-C4r-KIir.js","assets/PointSnappingHint-BIIZt5I0.js","assets/queryEngineUtils-DJ2es_bo.js","assets/snappingUtils-BVQZFw4z.js","assets/layerViewUtils-Cbrog-dU.js","assets/FeatureCollectionSnappingSource-Bby32PD6.js","assets/symbologySnappingCandidates-go5LB3h-.js","assets/GraphicsSnappingSource-8fdxfLEE.js","assets/PooledRBush-OI-c3i-A.js","assets/memoryEstimations-C3WUBUZI.js","assets/WhereClause-2gh-KjwG.js","assets/WhereClauseCache-D_968G_6.js","assets/timeSupport-CjNpK2fD.js","assets/queryUtils-fxq7u50x.js","assets/featureConversionUtils-VvJ2pauf.js","assets/OptimizedFeatureSet-D4F9ObY_.js","assets/OptimizedGeometry-5fDazGe-.js","assets/normalizeUtilsSync-DZGX2pCO.js","assets/quantizationUtils-CzrQVcZ1.js","assets/QueryEngine-DJKNHkzn.js","assets/QueryEngineCapabilities-COyCnRVj.js","assets/SnappingCandidate-BMrZX9Ey.js","assets/FixedIntervalBinParameters-5fcY6iRA.js","assets/utils-Cm-RG8rq.js","assets/utils-BUI45WL8.js","assets/utils-nAxNAb0W.js","assets/generateRendererUtils-Boi4GqnB.js","assets/BoundsStore-DZ48kmJe.js","assets/FeatureStore-Fclv32GR.js","assets/optimizedFeatureQueryEngineAdapter-DhyuxDon.js","assets/cimSymbolUtils-Dwr_LmxD.js","assets/utils-BroCumRv.js","assets/SceneLayerSnappingSource-c5PDdPwk.js","assets/FloatArray-DhcAaYJ8.js","assets/BufferView-BPABY7if.js","assets/Util-YNFIi00s.js","assets/types-DsLx34Br.js","assets/VertexAttributeLocations-DOYYzMyn.js","assets/VertexElementDescriptor-C9CNG143.js","assets/Indices-DELx3He_.js","assets/Normals-C9bgSX6t.js","assets/deduplicate-C8bQBzHi.js","assets/workerHelper-Bt28zin9.js","assets/edgeProcessing-9mNprDxI.js","assets/TextureBackedBufferLayout-YNJ8l8Rr.js"])))=>i.map(i=>d[i]);
import{BS as e,Bx as t,Ch as n,DT as r,JE as i,Jp as a,Jx as o,Ki as s,Ml as c,Nb as l,OT as u,Pl as d,Rw as f,UT as p,Z_ as m,_w as h,c_ as g,eT as _,gD as v,hb as y,nv as b,pD as x,pg as S,rv as C,uE as w,xh as T}from"./index-CzMixifc.js";import"./quatf64-eO7UAs9K.js";import"./plane--nqwMDYx.js";import"./vectorStacks-BQiry9fn.js";import"./dehydratedPoint-CVzHYxaL.js";import{r as E}from"./layerViewUtils-Cbrog-dU.js";import{m as D}from"./elevationInfoUtils-BcUBf70F.js";import"./ObjectStack-DiVLRoBj.js";import"./ray-XqUMyuyU.js";import{n as O}from"./floorFilterUtils-CQ-SmVM_.js";import"./geodesicUtils-DoIAZh7n.js";import{_ as k,g as A,h as j}from"./LineSnappingHint-C4TfMb_L.js";import{c as M,l as N,n as P}from"./snappingUtils-BVQZFw4z.js";import"./vec3-D7a6REBc.js";import"./sphere-DkSdrT5o.js";import{u as F}from"./constraints-CZ12pnWC.js";import"./SnappingCandidate-CgOYxD9J.js";import{n as I,t as L}from"./EdgeSnappingCandidate-CRqUhTG1.js";import{t as R}from"./DrapedEdgeSnappingCandidate-yTm_e8W9.js";import"./RightAngleSnappingHint-DDG9ajUd.js";import{n as z,t as B}from"./viewUtils-BjnASAVJ.js";import"./viewUtils-D2qwRYoF.js";import{n as V}from"./mapCollectionUtils-BUGTAoOg.js";var H=class extends h{set attributeRulesEnabled(e){this._set(`attributeRulesEnabled`,e),e&&this.loadRules()}get layerView(){return this.view?.allLayerViews?.find(e=>e.layer===this.layer)}get valid(){let{_valid:e,snappingSource:t,layer:n}=this;return!(!t||!n)&&e}get subtypeFilter(){let{layer:e,snappingSource:t}=this;if(!T(e)||!e.subtypes?.length||!t)return{mode:`not-in-use`,filter:null};let n=t.layerSource.sublayerSources.filter(e=>e.enabled&&e.layer.visible&&E(this.view?.scale,e.layer.effectiveScaleRange.minScale,e.layer.effectiveScaleRange.maxScale)).map(e=>e.layer.subtypeCode);if(!n.length)return{mode:`none-visible`,filter:null};if(n.length===e.subtypes.length)return{mode:`all-visible`,filter:null};let r=e.fieldsIndex.get(e.subtypeField)?.name??e.subtypeField;return n.length===1?{mode:`in-use`,filter:`${r} = ${n.getItemAt(0)}`}:{mode:`in-use`,filter:`${r} IN (${n.join(`, `)})`}}get floorFilter(){let{view:e,layer:t}=this;return e&&t?O({view:e,layer:t}):null}constructor(e){super(e),this.layer=null,this.snappingSource=null,this.rulesTable=null,this._valid=null}initialize(){if(!this.snappingSource||!this.layer)return void(this._valid=!1);let{layer:e,snappingSource:t}=this;if(`refresh`in e){let n=e;this.addHandles(n.on(`refresh`,()=>t.refresh()))}this.loadRules(),this.addHandles([b(()=>t.updating,e=>t.layerSource.updating=e,C),b(()=>t.availability,e=>t.layerSource.availability=e,C)])}getFetchCandidatesParameters(e,t,r){if(!this.valid)return[];let{layer:i,layerView:o,floorFilter:c,rulesTable:l,subtypeFilter:u}=this,d={distance:r,mode:this.view?.type??`2d`,point:e,coordinateHelper:t.coordinateHelper,...U(),filter:o&&`filter`in o?o.filter:null};if(c&&(d.filter=W(d.filter,c)),u.mode!==`not-in-use`&&u.mode!==`all-visible`){if(u.mode===`none-visible`)return[];d.filter?d.filter.where=a(d.filter.where,u.mode):d.filter=new s({where:u.filter})}if(!this.attributeRulesEnabled)return[d];let f=t.feature,p=f?.sourceLayer?.type===`subtype-sublayer`?f.sourceLayer.parent:f?.sourceLayer;if(l&&f&&M(this.view?.map)&&(n(i)||T(i))&&(n(p)||T(p))&&this.view.map.utilityNetworks?.find(e=>e.isUtilityLayer(p))){if(l.loadStatus!==`loaded`)return[];let e=[],t=i.layerId,n=l.getFeatureSQL(p,f)?.[t];if(!n)return[];let r=n.anyVertex,a=n.endVertex;return a&&r&&a===r&&(a=``),a&&e.push({...d,returnEdge:!1,vertexMode:`ends`,filter:W(d.filter,a)}),r&&e.push({...d,returnEdge:x(`snapping-include-edges-when-applying-any-vertex-rule`)??!1,vertexMode:`all`,filter:W(d.filter,r)}),e}return[d]}async loadRules(){this._valid=null;let{layer:e,view:t,attributeRulesEnabled:r}=this;if(r&&e&&t&&M(t?.map)&&(n(e)||T(e)))try{await Promise.allSettled(t.map.utilityNetworks?.map(e=>e.load())??[]);let n=t.map.utilityNetworks?.find(t=>t.isUtilityLayer(e));n&&(this.rulesTable=await n.getRulesTable(),await this.rulesTable?.load())}catch{this._valid=!1,w.getLogger(`esri.views.interactive.snapping.FeatureSnappingSourceInfo`).error(`Failed to load rules table for snapping source`,e.title);return}this._valid=!0}remove(){this.destroy()}destroy(){this.snappingSource?.destroy()}};function U(){return{returnEdge:!0,vertexMode:`all`}}function W(e,t){return e==null?new s({where:t}):e.where?new s({where:a(e.where,t)}):new s({where:t})}v([r({constructOnly:!0})],H.prototype,`layer`,void 0),v([r({constructOnly:!0})],H.prototype,`snappingSource`,void 0),v([r({constructOnly:!0})],H.prototype,`view`,void 0),v([r({value:!1})],H.prototype,`attributeRulesEnabled`,null),v([r()],H.prototype,`layerView`,null),v([r()],H.prototype,`rulesTable`,void 0),v([r()],H.prototype,`valid`,null),v([r()],H.prototype,`subtypeFilter`,null),v([r()],H.prototype,`floorFilter`,null),v([r()],H.prototype,`_valid`,void 0),H=v([u(`esri.views.interactive.snapping.FeatureSnappingSourceInfo`)],H);var G=class extends h{get updating(){return this._snappingSources.some(e=>e?.valid==null||!0===e.valid&&!0===e.snappingSource?.updating)||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=1,this._updatingHandles=new S,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){let e=V(()=>this.options?._effectiveFeatureSources,(e,t)=>this._createSourceInfo(e,t));this._snappingSources=e,this.addHandles([p(e),b(()=>({rulesEnabled:!!this.options?.attributeRulesEnabled,sources:this._snappingSources.filter(i)}),({rulesEnabled:e,sources:t})=>{for(let n of t)n.attributeRulesEnabled=e},m)])}destroy(){this._set(`options`,null),this._updatingHandles.destroy()}async fetchCandidates(e,t,n,r){if(!(t&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];let i=[],a=this._computeScreenSizeDistanceParameters(e,n);for(let t of this._snappingSources){if(!t?.valid||!t.snappingSource?.layerSource?.enabled||t.layerView?.suspended)continue;let o=t.getFetchCandidatesParameters(e,n,a);for(let e of o)i.push(t.snappingSource.fetchCandidates(e,r).then(e=>e.filter(e=>!this._candidateIsExcluded(t.snappingSource,e,n.excludeFeature))))}let o=(await f(i)).flat();return this._addRightAngleCandidates(o,e,a,n),_(r),N(e,o),o}_addRightAngleCandidates(e,t,n,r){let i=r.vertexHandle==null?r.editGeometryOperations!=null&&r.editGeometryOperations.data.type===`polygon`?r.editGeometryOperations.data.parts[0]?.getFirstVertex()?.pos:null:r.vertexHandle.rightSegment?.rightVertex?.pos,a=r.vertexHandle==null?r.editGeometryOperations==null?null:r.editGeometryOperations.data.parts[0]?.getLastVertex()?.pos:r.vertexHandle.leftSegment?.leftVertex?.pos,{view:o}=this,s=j(i,o,r),c=j(a,o,r),l=e.length;for(let r=0;r<l;r++)this._addRightAngleCandidate(e[r],c,t,n,e),this._addRightAngleCandidate(e[r],s,t,n,e)}_addRightAngleCandidate(e,t,n,r,i){if(t==null||!K(e))return;let a=e.constraint.closestTo(t),o=(a[0]-n[0])/r.x,s=(a[1]-n[1])/r.y,{start:c,end:l}=e.constraint;if(o*o+s*s<=1){let n=y(k(a),k(c))>y(k(a),k(l))?c:l,r=new z({targetPoint:A(a),otherVertex:t,otherVertexType:0,previousVertex:n,constraint:new F(t,a),objectId:e.objectId,isDraped:e.isDraped,domain:1});i.push(r)}}_computeScreenSizeDistanceParameters(e,t){let n=this.options==null?0:this.options.distance*(t.pointer===`touch`?this.options.touchSensitivityMultiplier:1);return this.view==null?{x:n,y:n,z:n,distance:n}:this.view.type===`2d`?(n*=this.view.resolution,{x:n,y:n,z:n,distance:n}):this._computeScreenSizeDistanceParameters3D(e,n,this.view,t)}_computeScreenSizeDistanceParameters3D(e,n,r,i){let{spatialReference:a}=i;r.renderCoordsHelper.toRenderCoords(e,a,Y);let s=r.state.camera.computeScreenPixelSizeAt(Y),c=s*r.renderCoordsHelper.unitInMeters,l=c/t(a),u=c/o(a),d=n*l,f=n*u,p=B(e,a,D,r),m=p?J(p,e,l,0,0,r,i):0,h=p?J(p,e,0,l,0,r,i):0,g=p?J(p,e,0,0,u,r,i):0;return{x:m===0?0:d/m,y:h===0?0:d/h,z:g===0?0:f/g,distance:s*n}}_candidateIsExcluded(e,t,n){if(n==null)return!1;let r=this._getCandidateObjectId(t);if(r==null)return!1;let i=e.layerSource.layer;return i.type===`graphics`?n.uid===r:n.sourceLayer===i&&!(!n.attributes||!(`objectIdField`in i))&&n.attributes[i.objectIdField]===r}_getCandidateObjectId(e){return e instanceof I?e.objectId:null}async _createSourceInfo(e,t){let n=e.layer;n.loaded||(await n.load(),_(t));let{view:r}=this,i=await this._createFeatureSnappingSourceType(e);return _(t),new H(i==null?{}:{snappingSource:i,view:r,layer:n})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case`feature`:case`geojson`:case`csv`:case`oriented-imagery`:case`subtype-group`:case`wfs`:return this._createFeatureSnappingSourceFeatureLayer(e);case`graphics`:return this._createFeatureSnappingSourceGraphicsLayer(e);case`map-notes`:return this._createFeatureSnappingSourceMapNotesLayer(e);case`scene`:case`building-scene`:return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){let{view:t}=this;return t==null||t.type!==`3d`?null:new(await(this._getSourceModule(`scene`))).SceneLayerSnappingSource({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source?.type){case`feature-layer`:case`oriented-imagery`:return new(await(this._getSourceModule(`featureService`))).FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e});case`memory`:case`csv`:case`geojson`:case`wfs`:return e.layer.geometryType===`mesh`?null:new(await(this._getSourceModule(`featureCollection`))).FeatureCollectionSnappingSource({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new(await(this._getSourceModule(`graphics`))).GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new(await(this._getSourceModule(`notes`))).GraphicsSnappingSource({getGraphicsLayers:()=>e.layer.sublayers?.toArray()??[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){let t=this._sourceModules[e];if(t.loader==null){let t=this._loadSourceModule(e),n={module:null,loader:t};this._sourceModules[e]=n;let r=await t,i={module:r,loader:t};return this._sourceModules[e]=i,r}return t.module==null?t.loader:t.module}_loadSourceModule(t){let n=this._updatingHandles;switch(t){case`featureService`:return n.addPromise(e(()=>import(`./FeatureServiceSnappingSource-DDxPktAX.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25])));case`featureCollection`:return n.addPromise(e(()=>import(`./FeatureCollectionSnappingSource-Bby32PD6.js`),__vite__mapDeps([26,1,2,4,5,6,10,11,8,9,12,14,15,16,17,18,19,20,21,22,23,27,24])));case`graphics`:case`notes`:return n.addPromise(e(()=>import(`./GraphicsSnappingSource-8fdxfLEE.js`),__vite__mapDeps([28,1,2,4,5,6,10,11,8,9,29,12,30,31,32,14,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,15,51,52,16,17,18,19,20,21,22,23,27,24])));case`scene`:return n.addPromise(e(()=>import(`./SceneLayerSnappingSource-c5PDdPwk.js`),__vite__mapDeps([53,1,2,4,5,6,10,11,8,9,12,13,14,54,55,56,57,58,59,60,61,62,15,63,64,65,16,17,19,20,21,22])))}}get test(){}};function K(e){return(e instanceof L||e instanceof R)&&!q(e)}function q({constraint:{start:e,end:t}}){let n=d(e,t),r=y(k(e),k(t));return n<l()||r/n<Z}function J(e,t,n,r,i,a,{spatialReference:o}){let s=c(X,t);s[0]+=n,s[1]+=r,s[2]+=i;let l=B(s,o,D,a);return l?P(l,e):1/0}v([r({constructOnly:!0})],G.prototype,`spatialReference`,void 0),v([r({constructOnly:!0})],G.prototype,`view`,void 0),v([r()],G.prototype,`options`,void 0),v([r({readOnly:!0})],G.prototype,`updating`,null),v([r()],G.prototype,`_snappingSources`,void 0),G=v([u(`esri.views.interactive.snapping.FeatureSnappingEngine`)],G);var Y=g(),X=g(),Z=1e-4;export{G as FeatureSnappingEngine};