const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/mediaLayerUtils-BASB5zrb.js","assets/index-CzMixifc.js","assets/index-CDgdHpAj.css","assets/originUtils-CL6wvYk_.js","assets/utils-WUTqSxls.js","assets/saveUtils-BKglk9b-.js","assets/resourceUtils-MeC3zZFs.js","assets/resourceUtils-Gqgc6Vaf.js"])))=>i.map(i=>d[i]);
import{$S as e,$m as t,$o as n,A as r,AT as i,Ag as a,BS as o,BT as s,Bh as c,Cb as l,DT as u,Dh as d,Dy as f,EC as ee,Ey as p,Fb as te,Fg as ne,Fu as m,GC as re,Gb as ie,Ha as ae,Hh as oe,Hw as se,IC as h,Jm as ce,L as le,LC as ue,M as de,Nu as g,OT as _,QS as fe,RS as pe,SC as me,Sg as v,TC as he,Uy as ge,Vh as _e,WC as ve,Wh as ye,ZC as be,_S as xe,ax as y,cb as b,dw as Se,eC as Ce,eT as we,eg as x,gD as S,hC as Te,hw as Ee,iv as C,jT as w,kT as De,kv as Oe,lT as ke,lx as Ae,mb as je,nv as Me,px as T,rw as Ne,sv as Pe,uE as E,ua as Fe,vC as Ie,vg as Le,wC as Re,wx as D,zl as ze}from"./index-CzMixifc.js";import"./PooledRBush-OI-c3i-A.js";import{t as Be}from"./BoundsStore-DZ48kmJe.js";import{i as Ve,n as O,o as He,r as Ue,s as k,t as We}from"./MediaElementView-LFZlFHBk.js";import{t as A}from"./ControlPoint-ndPIO-tc.js";import"./normalizeUtilsSync-DZGX2pCO.js";import{t as Ge}from"./videoUtils-CDhtaJ_j.js";var j=class extends Ee{projectOrWarn(e,t){if(e==null)return e;let{geometry:n,pending:r}=v(e,t);return r?null:r||n?n:(E.getLogger(this).warn(`geometry could not be projected to the spatial reference`,{georeference:this,geometry:e,sourceSpatialReference:e.spatialReference,targetSpatialReference:t}),null)}};j=S([_(`esri.layers.support.GeoreferenceBase`)],j);var Ke=p(),M=g(),N=class extends re{};S([u({type:Number,json:{write:{isRequired:!0}}})],N.prototype,`x`,void 0),S([u({type:Number,json:{write:{isRequired:!0}}})],N.prototype,`y`,void 0),N=S([_(`esri.layers.support.ControlPointsGeoreference.ControlPointJSONType`)],N);var P=class extends ve(j){constructor(e){super(e),this.height=0,this.type=`control-points`,this.width=0}get controlPoints(){return this._get(`controlPoints`)??null}set controlPoints(e){this._set(`controlPoints`,e)}readControlPoints(e,t){let n=D.fromJSON(t.spatialReference),r=f(...t.coefficients,1);return e.map(e=>(l(M,e.x,e.y),k(M,M,r),{sourcePoint:e,mapPoint:new T({x:M[0],y:M[1],spatialReference:n})}))}writeControlPoints(e,t,n,r){if(this.transform==null){let e=new s(`web-document-write:invalid-georeference`,`Invalid 'controlPoints', 'width', 'height' configuration. Make sure the parent media element is loaded i.e. the ImageElement or VideoElement set as 'MediaLayer.source'.`,{layer:r?.layer,georeference:this});r?.messages?r.messages.push(e):E.getLogger(this).error(e.name,e.message);return}e!=null&&F(e[0])&&(t.controlPoints=e.map(e=>{let t=e.sourcePoint;return{x:t.x,y:t.y}}),t.spatialReference=e[0].mapPoint.spatialReference.toJSON(),t.coefficients=this.transform.slice(0,8))}get coords(){if(this.controlPoints==null)return null;let e=this._updateTransform(Ke);if(e==null||!F(this.controlPoints[0]))return null;let t=this.controlPoints[0].mapPoint.spatialReference;return et(e,this.width,this.height,t)}set coords(e){if(this.controlPoints==null||!F(this.controlPoints[0]))return;let t=this.controlPoints[0].mapPoint.spatialReference;if((e=this.projectOrWarn(e,t))==null)return;let{width:n,height:r}=this,{rings:[[i,a,o,s]]}=e,c=new A({sourcePoint:x(0,r),mapPoint:new T({x:i[0],y:i[1],spatialReference:t})}),u=new A({sourcePoint:x(0,0),mapPoint:new T({x:a[0],y:a[1],spatialReference:t})}),d=new A({sourcePoint:x(n,0),mapPoint:new T({x:o[0],y:o[1],spatialReference:t})}),f=new A({sourcePoint:x(n,r),mapPoint:new T({x:s[0],y:s[1],spatialReference:t})});F(c)&&F(u)&&F(d)&&F(f)&&(Ye(Ke,c,u,d,f),this.controlPoints=this.controlPoints.map(({sourcePoint:e})=>(l(M,e.x,e.y),k(M,M,Ke),{sourcePoint:e,mapPoint:new T({x:M[0],y:M[1],spatialReference:t})})))}get inverseTransform(){return this.transform==null?null:ge(p(),this.transform)}get transform(){return this._updateTransform()}toMap(e){if(e==null||this.transform==null||this.controlPoints==null||!F(this.controlPoints[0]))return null;l(M,e.x,e.y);let t=this.controlPoints[0].mapPoint.spatialReference;return k(M,M,this.transform),new T({x:M[0],y:M[1],spatialReference:t})}toSource(e){if(e==null||this.inverseTransform==null||this.controlPoints==null||!F(this.controlPoints[0]))return null;let t=this.controlPoints[0].mapPoint.spatialReference;return e=e.normalize(),(e=v(e,t).geometry)==null?null:(l(M,e.x,e.y),k(M,M,this.inverseTransform),x(M[0],M[1]))}toSourceNormalized(e){let t=this.toSource(e);return t!=null&&(t.x/=this.width,t.y/=this.height),t}_updateTransform(e){let{controlPoints:t,width:n,height:r}=this;if(!(t!=null&&n>0&&r>0))return null;let[i,a,o,s]=t;if(!F(i))return null;let c=i.mapPoint.spatialReference,l=this._projectControlPoint(a,c),u=this._projectControlPoint(o,c),d=this._projectControlPoint(s,c);if(!l.valid||!u.valid||!d.valid||!F(l.controlPoint))return null;e??=p();let f=null;return f=F(u.controlPoint)&&F(d.controlPoint)?Ye(e,i,l.controlPoint,u.controlPoint,d.controlPoint):F(u.controlPoint)?Je(e,i,l.controlPoint,u.controlPoint):qe(e,i,l.controlPoint),f.every(e=>e===0)?null:f}_projectControlPoint(e,t){if(!F(e))return{valid:!0,controlPoint:e};let{sourcePoint:n,mapPoint:r}=e,{geometry:i,pending:a}=v(r,t);return a?{valid:!1,controlPoint:null}:a||i?{valid:!0,controlPoint:new A({sourcePoint:n,mapPoint:i})}:(E.getLogger(this).warn(`map point could not be projected to the spatial reference`,{georeference:this,controlPoint:e,sourceSpatialReference:r.spatialReference,targetSpatialReference:t}),{valid:!1,controlPoint:null})}};function F(e){return e?.sourcePoint!=null&&e.mapPoint!=null}S([u({type:[A],json:{write:{allowNull:!1,isRequired:!0,target:{controlPoints:{type:[N],isRequired:!0},coefficients:{type:[Number],isRequired:!0},spatialReference:{type:D,isRequired:!0}}}}})],P.prototype,`controlPoints`,null),S([w(`controlPoints`)],P.prototype,`readControlPoints`,null),S([i(`controlPoints`)],P.prototype,`writeControlPoints`,null),S([u({clonable:!1})],P.prototype,`coords`,null),S([u({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],P.prototype,`height`,void 0),S([u({readOnly:!0})],P.prototype,`inverseTransform`,null),S([u({readOnly:!0})],P.prototype,`transform`,null),S([u({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],P.prototype,`width`,void 0),P=S([_(`esri.layers.support.ControlPointsGeoreference`)],P);var I=g(),L=g(),R=g(),z=g(),B=g(),V=g(),H=g(),U=g(),W=Math.PI/2;function G(e,t,n){l(e,n.sourcePoint.x,n.sourcePoint.y),l(t,n.mapPoint.x,n.mapPoint.y)}function qe(e,t,n){return G(I,B,t),G(L,V,n),b(R,L,I,W),b(z,I,L,W),b(H,V,B,-W),b(U,B,V,-W),$e(e,I,L,R,z,B,V,H,U)}function Je(e,t,n,r){return G(I,B,t),G(L,V,n),G(R,H,r),je(z,I,L,.5),b(z,R,z,Math.PI),je(U,B,V,.5),b(U,H,U,Math.PI),$e(e,I,L,R,z,B,V,H,U)}function Ye(e,t,n,r,i){return G(I,B,t),G(L,V,n),G(R,H,r),G(z,U,i),$e(e,I,L,R,z,B,V,H,U)}var Xe=Array(8).fill(0),Ze=Array(8).fill(0);function Qe(e,t,n,r,i){return e[0]=t[0],e[1]=t[1],e[2]=n[0],e[3]=n[1],e[4]=r[0],e[5]=r[1],e[6]=i[0],e[7]=i[1],e}function $e(e,t,n,r,i,a,o,s,c){return He(e,Qe(Xe,t,n,r,i),Qe(Ze,a,o,s,c))}function et(e,t,n,r){let i=m(0,n),a=m(0,0),o=m(t,0),s=m(t,n);return k(i,i,e),k(a,a,e),k(o,o,e),k(s,s,e),new Oe({rings:[[i,a,o,s,i]],spatialReference:r})}var K=g(),q=class extends j{constructor(e){super(e),this.bottomLeft=null,this.bottomRight=null,this.topLeft=null,this.topRight=null,this.type=`corners`}get coords(){let{topLeft:e,topRight:t,bottomLeft:n,bottomRight:r}=this;if(e==null||t==null||n==null||r==null)return null;let i=e.spatialReference;return t=this.projectOrWarn(t,i),n=this.projectOrWarn(n,i),r=this.projectOrWarn(r,i),t==null||n==null||r==null?null:new Oe({rings:[[[n.x,n.y],[e.x,e.y],[t.x,t.y],[r.x,r.y],[n.x,n.y]]],spatialReference:i})}set coords(e){let{topLeft:t}=this;if(t==null)return;let n=t.spatialReference;if((e=this.projectOrWarn(e,n))==null)return;let{rings:[[r,i,a,o]]}=e;this.bottomLeft=new T({x:r[0],y:r[1],spatialReference:n}),this.topLeft=new T({x:i[0],y:i[1],spatialReference:n}),this.topRight=new T({x:a[0],y:a[1],spatialReference:n}),this.bottomRight=new T({x:o[0],y:o[1],spatialReference:n})}toSourceNormalized(e){let{topLeft:t,topRight:n,bottomRight:r,bottomLeft:i}=this;if(e==null||t==null||n==null||r==null||i==null)return null;let a=t.spatialReference;e=e.normalize();let o=v(e,a).geometry;if(o==null)return null;l(K,o.x,o.y);let s=He(p(),[t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y],[0,0,0,1,1,0,1,1]);return k(K,K,s),x(K[0],K[1])}};S([u({clonable:!1})],q.prototype,`coords`,null),S([u({type:T})],q.prototype,`bottomLeft`,void 0),S([u({type:T})],q.prototype,`bottomRight`,void 0),S([u({type:T})],q.prototype,`topLeft`,void 0),S([u({type:T})],q.prototype,`topRight`,void 0),q=S([_(`esri.layers.support.CornersGeoreference`)],q);var tt=q,J=class extends j{constructor(e){super(e),this.extent=null,this.rotation=0,this.type=`extent-and-rotation`}get coords(){if(this.extent==null)return null;let{xmin:e,ymin:t,xmax:n,ymax:r,spatialReference:i}=this.extent,a;if(this.rotation){let{x:i,y:o}=this.extent.center,s=nt(i,o,this.rotation);a=[s(e,t),s(e,r),s(n,r),s(n,t)],a.push(a[0])}else a=[[e,t],[e,r],[n,r],[n,t],[e,t]];return new Oe({rings:[a],spatialReference:i})}set coords(e){if(e==null||this.extent==null)return;let t=this.extent.spatialReference;if(e=this.projectOrWarn(e,t),e?.extent==null)return;let{rings:[[n,r,i]],extent:{center:{x:a,y:o}}}=e,s=be(Math.PI/2-Math.atan2(r[1]-n[1],r[0]-n[0])),c=nt(a,o,-s),[l,u]=c(n[0],n[1]),[d,f]=c(i[0],i[1]);this.extent=new y({xmin:l,ymin:u,xmax:d,ymax:f,spatialReference:t}),this.rotation=s}toSourceNormalized(e){let{extent:t,rotation:n}=this;if(e==null||t==null)return null;let{xmin:r,ymin:i,xmax:a,ymax:o,center:s,spatialReference:c}=t;e=e.normalize();let l=v(e,c).geometry;if(l==null)return null;let u=l.x,d=l.y;return n&&([u,d]=nt(s.x,s.y,-n)(u,d)),x(Ne(u,r,a,0,1),Ne(d,o,i,0,1))}};function nt(e,t,n){let r=te(n),i=Math.cos(r),a=Math.sin(r);return(n,r)=>[i*(n-e)+a*(r-t)+e,i*(r-t)-a*(n-e)+t]}S([u({clonable:!1})],J.prototype,`coords`,null),S([u({type:y})],J.prototype,`extent`,void 0),S([u({type:Number})],J.prototype,`rotation`,void 0),J=S([_(`esri.layers.support.ExtentAndRotationGeoreference`)],J);var rt=J;function it(e){return e?.type===`media`}function at(e,t){let n=ke(t);return it(e)&&!!e.portalItem&&n!=null&&n>3}function ot(e,t,n){if(!e||e.type===`control-points`)return e;let{coords:r}=e;if(r?.rings[0]?.length!==5)return null;let[i,a,o,s]=r.rings[0],{spatialReference:c}=r;return new P({controlPoints:[new A({mapPoint:new T({x:i[0],y:i[1],spatialReference:c}),sourcePoint:x(0,n)}),new A({mapPoint:new T({x:a[0],y:a[1],spatialReference:c}),sourcePoint:x(0,0)}),new A({mapPoint:new T({x:o[0],y:o[1],spatialReference:c}),sourcePoint:x(t,0)}),new A({mapPoint:new T({x:s[0],y:s[1],spatialReference:c}),sourcePoint:x(t,n)})],width:t,height:n})}function st(e,t,n){return{enabled:!at(n?.layer,n?.origin),ignoreOrigin:!0}}var ct={json:{name:`url`,type:String,write:{overridePolicy:st}}},lt={readOnly:!0,json:{read:!1,write:{target:`mediaType`,overridePolicy:st}}},ut={types:{key:`type`,base:j,typeMap:{"control-points":P,corners:tt,"extent-and-rotation":rt}},json:{types:{key:`type`,base:j,typeMap:{"control-points":P}},write:{overridePolicy:()=>({enabled:!0,ignoreOrigin:!0})}}},Y=class extends ze(ae(_e)){constructor(e){super(e),this.georeference=null,this.opacity=1}readGeoreference(e){return P.fromJSON(e)}writeGeoreference(e,t,n,r){let i=r?.resources?.pendingOperations,a=()=>{let i=ot(this.georeference,this.contentWidth,this.contentHeight);if(i){if(e.type!==`control-points`&&E.getLogger(this).warn(`only georeference of type 'control-points' may be persisted. The georeference of type '${e.type}' has been automatically converted.`),i.controlPoints?.length!==4&&r?.messages)return void r.messages.push(new s(`property:unsupported`,`only 'control-points' georeference with 4 control points may be persisted.`));t[n]=i.write({},r)}};if(e.type!==`control-points`&&!this.loaded&&i)return t[n]={},void i.push(this.load().then(a));a()}get contentWidth(){return 0}get contentHeight(){return 0}toSource(e){let{georeference:t,contentWidth:n,contentHeight:r}=this;if(e==null||t==null||n===0||r===0)return null;let i=t.toSourceNormalized(e);return i==null?null:(i.x*=n,i.y*=r,i)}};S([u(ut)],Y.prototype,`georeference`,void 0),S([w(`georeference`)],Y.prototype,`readGeoreference`,null),S([i(`georeference`)],Y.prototype,`writeGeoreference`,null),S([u({json:{read:!1,write:!1}})],Y.prototype,`opacity`,void 0),Y=S([_(`esri.layers.support.MediaElementBase`)],Y);var dt,X=class extends Y{static{dt=Ve}constructor(e){super(e),this.animationOptions=null,this.content=null,this.image=null,this.type=`image`,this[dt]=!0,this.image=null}load(){let e=this.image;if(typeof e==`string`){let t=n(e).then(e=>{this._set(`content`,e)});this.addResolvingPromise(t)}else if(e instanceof HTMLImageElement){let t=e.decode().then(()=>{this._set(`content`,e)});this.addResolvingPromise(t)}else e?this._set(`content`,e):this.addResolvingPromise(Promise.reject(new s(`image-element:invalid-image-type`,`Invalid image type`,{image:e})));return Promise.resolve(this)}get contentWidth(){return this.content==null?0:this.content instanceof HTMLImageElement?this.content.naturalWidth:this.content.width}get contentHeight(){return this.content==null?0:this.content instanceof HTMLImageElement?this.content.naturalHeight:this.content.height}readImage(t,n,r){return e(n.url,r)}writeImage(e,t,n,r){if(e==null)return;let i=r?.portalItem,a=r?.resources;if(!i||!a)return void(typeof e==`string`&&(t[n]=fe(e,r)));let o=ft(e)?e:null;if(o){if(Ce(o)==null)return void(t[n]=o);let e=fe(o,{...r,verifyItemRelativeUrls:r?.verifyItemRelativeUrls?{writtenUrls:r.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},1);if(i&&e&&!Re(e))return a.toKeep.push({resource:i.resourceFromPath(e),compress:!1}),void(t[n]=e)}t[n]=`<pending>`,a.pendingOperations.push(pt(e).then(e=>{let r=ht(e,i);t[n]=r.itemRelativeUrl,a.toAdd.push({resource:r,content:{type:`blob`,blob:e},compress:!1,finish:e=>{this.image=e.url}})}))}};function ft(e){return typeof e==`string`&&!h(e)&&!he(e)}async function pt(e){return typeof e==`string`?h(e)?ue(e):(await pe(e,{responseType:`blob`})).data:new Promise(t=>mt(e).toBlob(t))}function mt(e){if(e instanceof HTMLCanvasElement)return e;let t=e instanceof HTMLImageElement?e.naturalWidth:e.width,n=e instanceof HTMLImageElement?e.naturalHeight:e.height,r=document.createElement(`canvas`),i=r.getContext(`2d`);return r.width=t,r.height=n,e instanceof HTMLImageElement?i.drawImage(e,0,0,e.width,e.height):e instanceof ImageData&&i.putImageData(e,0,0),r}function ht(e,n){let r=t(),i=`${me(`media`,r)}.${ce({type:`blob`,blob:e})}`;return n.resourceFromPath(i)}S([u()],X.prototype,`animationOptions`,void 0),S([u({readOnly:!0})],X.prototype,`content`,void 0),S([u({readOnly:!0})],X.prototype,`contentWidth`,null),S([u({readOnly:!0})],X.prototype,`contentHeight`,null),S([u(ct)],X.prototype,`image`,void 0),S([w(`image`,[`url`])],X.prototype,`readImage`,null),S([i(`image`)],X.prototype,`writeImage`,null),S([u(lt)],X.prototype,`type`,void 0),X=S([_(`esri.layers.support.ImageElement`)],X);var gt,_t=Symbol(`canplay`),Z=class extends Y{static{gt=Ue}constructor(e){super(e),this.autoplay=!0,this.content=null,this.type=`video`,this[gt]=!0}load(){let e=this.video;return typeof e==`string`?this.addResolvingPromise(this._preProcessVideoUrl(e).then(async e=>{let t=document.createElement(`video`);return t.src=Le.sanitizeUrl(ee(e)),t.crossOrigin=`anonymous`,t.autoplay=this.autoplay,t.muted=!0,t.loop=!0,t.playsInline=!0,this._loadVideo(t).then(()=>{this._set(`content`,t)})})):e instanceof HTMLVideoElement?this.addResolvingPromise(this._loadVideo(e).then(()=>{this._set(`content`,e)})):this.addResolvingPromise(Promise.reject(new s(`video-element:invalid-video-type`,`Invalid video type`,{video:e}))),Promise.resolve(this)}get contentWidth(){return this.content?.videoWidth??0}get contentHeight(){return this.content?.videoHeight??0}get currentTime(){return this.content?.currentTime}set currentTime(e){if(!this.content)return;let t=Se(e,0,this.content.duration);`fastSeek`in this.content?this.content.fastSeek(t):this.content.currentTime=t,this.content.play().then(()=>{this.content?.pause()}).catch(()=>{})}get duration(){return this.content?.duration}set video(e){this.loadStatus===`not-loaded`?this._set(`video`,e):E.getLogger(this).error(`#video`,`video cannot be changed after the element is loaded.`)}writeVideo(e,t,n,r){if(!e)return void(r?.messages&&r.messages.push(new s(`video-element:unsupported-video`,`video source is missing`)));let i=vt(e)?e:null;if(!i)return void(r?.messages&&r.messages.push(new s(`video-element:unsupported-video`,`video source must be an absolute url`)));!Re(i)&&r?.blockedRelativeUrls&&r.blockedRelativeUrls.push(i);let a=ee(i);Ce(a)?r?.messages&&r.messages.push(new s(`video-element:unsupported-video`,`video source cannot be an item resource`)):t[n]=a}async _preProcessVideoUrl(e){if(Te(e))return Ie(e);try{return await pe(e,{method:`head`}),e}catch{try{return Ie(e,!0)}catch{return e}}}async _loadVideo(e){e.crossOrigin!==`anonymous`&&(e.crossOrigin=`anonymous`,he(e.src)||(e.src=e.src));try{await Ge(e,e=>this.addHandles(e,_t)),this.autoplay&&await e.play().catch(e=>{throw console.error(e),e})}finally{this.removeHandles(_t)}}};function vt(e){return typeof e==`string`&&!h(e)&&!he(e)}S([u()],Z.prototype,`autoplay`,void 0),S([u({readOnly:!0})],Z.prototype,`content`,void 0),S([u({readOnly:!0})],Z.prototype,`contentWidth`,null),S([u({readOnly:!0})],Z.prototype,`contentHeight`,null),S([u({type:Number})],Z.prototype,`currentTime`,null),S([u({type:Number})],Z.prototype,`duration`,null),S([u(ct)],Z.prototype,`video`,null),S([i(`video`)],Z.prototype,`writeVideo`,null),S([u(lt)],Z.prototype,`type`,void 0),Z=S([_(`esri.layers.support.VideoElement`)],Z);var yt={key:`type`,defaultKeyValue:`image`,base:Y,typeMap:{image:X,video:Z}},bt=C.ofType(yt),Q=class extends c(oe(Pe)){constructor(e){super(e),this._index=new Be,this._elementViewsMap=new Map,this._elementsIndexes=new Map,this._elementsChangedHandler=e=>{for(let t of e.removed){let e=this._elementViewsMap.get(t);this._elementViewsMap.delete(t),this._index.delete(e),this.removeHandles(e),e.destroy(),this.notifyChange(`fullExtent`)}let{spatialReference:t}=this;for(let n of e.added){if(this._elementViewsMap.get(n))continue;let e=new We({spatialReference:t,element:n});this._elementViewsMap.set(n,e);let r=Me(()=>e.coords,()=>this._updateIndexForElement(e,!1));this._updateIndexForElement(e,!0),this.addHandles(r,e)}this._elementsIndexes.clear(),this.elements.forEach((e,t)=>this._elementsIndexes.set(e,t)),this.emit(`refresh`)},this.elements=new bt}async load(e){if(we(e),!this.spatialReference){let e=this.elements.find(e=>e.georeference?.coords!=null);this._set(`spatialReference`,e?e.georeference.coords.spatialReference:D.WGS84)}return this._elementsChangedHandler({added:this.elements.items,removed:[]}),this.addHandles(this.elements.on(`change`,this._elementsChangedHandler)),this}destroy(){this._index.clear(),this._elementViewsMap.clear(),this._elementsIndexes.clear()}get elements(){return this._get(`elements`)}set elements(e){this._set(`elements`,ye(e,this._get(`elements`),bt))}get fullExtent(){if(this.loadStatus===`not-loaded`)return null;let e=this._index.fullBounds;return e==null?null:new y({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:this.spatialReference})}set spatialReference(e){this.loadStatus===`not-loaded`?this._set(`spatialReference`,e):E.getLogger(this).error(`#spatialReference`,`spatialReference cannot be changed after the source is loaded.`)}async queryElements(e,t){await this.load(),await a(e.spatialReference,this.spatialReference,null,t);let n=xe(e.spatialReference,this.spatialReference)?e:ne(e,this.spatialReference);if(!n)return[];let r=n.normalize(),i=[];for(let e of r)this._index.forEachInBounds(ie(e),({normalizedCoords:t,element:n})=>{t!=null&&Ae(e,t)&&i.push(n)});return i.sort((e,t)=>this._elementsIndexes.get(e)-this._elementsIndexes.get(t)),i}hasElement(e){return this.elements.includes(e)}_updateIndexForElement(e,t){let n=e.normalizedBounds,r=this._index.has(e),i=n!=null;this._index.delete(e),i&&this._index.set(e,n),this.notifyChange(`fullExtent`),t||(r===i?this.emit(`change`,{element:e.element}):this.emit(`refresh`))}};S([u()],Q.prototype,`elements`,null),S([u({readOnly:!0})],Q.prototype,`fullExtent`,null),S([u()],Q.prototype,`spatialReference`,null),Q=S([_(`esri.layers.support.LocalMediaElementSource`)],Q);var $=class extends Fe(r(le(de(ae(d))))){constructor(e){super(e),this.effectiveSource=null,this.georeference=null,this.copyright=null,this.operationalLayerType=`MediaLayer`,this.spatialReference=null,this.type=`media`,this._debouncedSaveOperations=se(async(e,t,n)=>{let{save:r,saveAs:i}=await o(async()=>{let{save:e,saveAs:t}=await import(`./mediaLayerUtils-BASB5zrb.js`);return{save:e,saveAs:t}},__vite__mapDeps([0,1,2,3,4,5,6,7]));switch(e){case 0:return r(this,t);case 1:return i(this,n,t)}}),this.source=new Q}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}async _doLoad(e){await this.loadFromPortal({supportedTypes:[`Media Layer`]},e);let t=this.source;if(!t)throw new s(`media-layer:source-missing`,`Set 'MediaLayer.source' before loading the layer.`);let n=this._getSourceOverride(t,this.georeference);n&&(this.setAtOrigin(`source`,n,`web-map`),this.setAtOrigin(`source`,n,`web-scene`),t=n);let r=O(t)?new Q({elements:new C([t])}):t;this._set(`effectiveSource`,r),this.spatialReference&&(r.spatialReference=this.spatialReference),await r.load(e),this.spatialReference=r.spatialReference}destroy(){this.effectiveSource?.destroy(),this.effectiveSource!==this.source&&this.source?.destroy()}readGeoreference(e,t){return e&&`itemId`in t&&t.itemId?e:void 0}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}get loaded(){return super.loaded}get source(){return this._get(`source`)}set source(e){this.loadStatus!==`loaded`&&this.loadStatus!==`failed`?this._set(`source`,e):E.getLogger(this).error(`#source`,`source cannot be changed after the layer is loaded.`)}castSource(e){return e?Array.isArray(e)?new Q({elements:new C(e)}):e instanceof C?new Q({elements:e}):e:null}readSource(e,t,n){if(`itemId`in t&&t.itemId)return;let r=this._createSource(t);return r?.read(t,n),r}writeSource(e,t,n,r){if(e&&e instanceof Q){let t=e.elements.length;if(t!==1)return void(r?.messages&&r.messages.push(new s(`media-layer:unsupported-source`,`local media element source can only be persisted if it contains exactly one ImageElement, but it has ${t}.`)));e=e.elements.at(0)}O(e)?e.write(t,r):r?.messages&&(e?r.messages.push(new s(`media-layer:unsupported-source`,`only media elements of type 'ImageElement' or 'VideoElement' can be persisted`)):r.messages.push(new s(`media-layer:unsupported-source`,`the media layer is missing a source`)))}async save(e){return this._debouncedSaveOperations(0,e)}async saveAs(e,t){return this._debouncedSaveOperations(1,t,e)}_createSource(e){if(`mediaType`in e)switch(e.mediaType){case`image`:return new X;case`video`:return new Z}return null}_getSourceOverride(e,t){if(O(e)&&this.originIdOf(`source`)===3&&t&&(this.originIdOf(`georeference`)===5||this.originIdOf(`georeference`)===4)){let n=e.toJSON(),r=this._createSource(n);return r.read({...n},{origin:`portal-item`}),r.read({georeference:t},{origin:`web-map`}),r.read({georeference:t},{origin:`web-scene`}),r}return null}};S([u({readOnly:!0})],$.prototype,`effectiveSource`,void 0),S([u({readOnly:!0,json:{read:!1,write:!1,origins:{"web-document":{read:!0}}}})],$.prototype,`georeference`,void 0),S([w(`web-document`,`georeference`)],$.prototype,`readGeoreference`,null),S([u({type:String})],$.prototype,`copyright`,void 0),S([u({readOnly:!0})],$.prototype,`fullExtent`,null),S([u({type:[`MediaLayer`]})],$.prototype,`operationalLayerType`,void 0),S([u({type:[`show`,`hide`]})],$.prototype,`listMode`,void 0),S([u({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1,target:{url:{type:String},mediaType:{type:[`image`,`video`]},georeference:{type:P}},overridePolicy(e,t,n){return{enabled:!0,allowNull:!1,ignoreOrigin:at(this,n?.origin)&&O(e)&&!!e.georeference&&e.originIdOf(`georeference`)>3}}}}})],$.prototype,`source`,null),S([De(`source`)],$.prototype,`castSource`,null),S([w(`source`,[`url`])],$.prototype,`readSource`,null),S([i(`source`)],$.prototype,`writeSource`,null),S([u({type:D})],$.prototype,`spatialReference`,void 0),S([u({readOnly:!0})],$.prototype,`type`,void 0),$=S([_(`esri.layers.MediaLayer`)],$);var xt=$;export{xt as default};