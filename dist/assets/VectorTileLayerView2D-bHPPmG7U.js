import{$c as e,An as t,Br as n,DT as r,Jw as i,OT as a,Qw as o,RS as s,SE as c,Vl as l,Vr as u,Xl as d,Xw as f,Zb as p,Zc as m,_S as h,aE as g,ba as _,el as v,fT as y,gD as b,gs as x,ix as S,lC as C,px as ee,qw as w,tl as T,tx as E,uE as D,vT as O,vd as k,vs as A,xa as te,ya as ne,yg as j}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./OptimizedFeatureSet-CTIqq8fn.js";import"./featureConversionUtils-_DSSMFQ2.js";import"./earcut-BF1-mB58.js";import{n as re}from"./PooledRBush-kIuSXR8J.js";import"./layerViewUtils-RSw-QNoB.js";import{t as M}from"./pbf-wXxPPz7x.js";import"./colorUtils-DJOs5VE1.js";import{n as ie,r as N,t as ae}from"./constants-BwY8HRAs.js";import{o as oe}from"./GeometryUtils-Dmca5Xm4.js";import{n as se,t as P}from"./StyleRepository-g8V7AsXM.js";import"./VertexAttributeLocations-CfzeuYMz.js";import"./VertexElementDescriptor-ju-1bdWe.js";import{s as ce}from"./rasterizingUtils-CKtfcOpu.js";import{t as F}from"./Rect-BhUrWpQm.js";import"./BoundingBox-CLkiiRfJ.js";import"./config-BSvujflG.js";import{n as I,t as L}from"./SourceLayerData-DE0qEGp8.js";import{s as le}from"./WGLContainer-D_aBMsnu.js";import"./utils-DS5dbHj4.js";import"./ProgramTemplate-BXau1qoF.js";import"./VertexArrayObject-DEfjd5y-.js";import"./BufferObject-q8zuTMny.js";import"./VertexBuffer-xVpphTb4.js";import"./vec3f32-B2H3-fiA.js";import"./Container-BuEih3Ua.js";import{t as ue}from"./LayerView2D-BsKgTWnO.js";import{t as de}from"./LayerView-2jeNRFkG.js";import{t as fe}from"./RefreshableLayerView-CXmtIjA5.js";import{t as pe}from"./TileContainer-B6yQthEI.js";import{n as me,r as he,t as ge}from"./SymbolFader-Cfn7eEL5.js";var R=Symbol(`isVectorTileGraphicOrigin`);function z(e){return!!e&&R in e}var B=class{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new F(0,0,e,t))}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new F;let n=null,r=-1;for(let i=0;i<this._free.length;++i){let a=this._free[i];e<=a.width&&t<=a.height&&(n===null||a.y<=n.y&&a.x<=n.x)&&(n=a,r=i)}return n===null?new F:(this._free.splice(r,1),n.width<n.height?(n.width>e&&this._free.push(new F(n.x+e,n.y,n.width-e,t)),n.height>t&&this._free.push(new F(n.x,n.y+t,n.width,n.height-t))):(n.width>e&&this._free.push(new F(n.x+e,n.y,n.width-e,n.height)),n.height>t&&this._free.push(new F(n.x,n.y+t,e,n.height-t))),new F(n.x,n.y,e,t))}release(e){for(let t=0;t<this._free.length;++t){let n=this._free[t];if(n.y===e.y&&n.height===e.height&&n.x+n.width===e.x)n.width+=e.width;else if(n.x===e.x&&n.width===e.width&&n.y+n.height===e.y)n.height+=e.height;else if(e.y===n.y&&e.height===n.height&&e.x+e.width===n.x)n.x=e.x,n.width+=e.width;else{if(e.x!==n.x||e.width!==n.width||e.y+e.height!==n.y)continue;n.y=e.y,n.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}},V=class{constructor(e,t,n){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=t,this._glyphSource=n,this._binPack=new B(e-4,t-4),this._glyphData.push(new Uint8Array(e*t)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(e,t){let n=[],r=this._glyphSource,i=new Set;for(let e of t){let t=Math.floor(e*.00390625);i.add(t)}let a=[];return i.forEach(t=>{let n=e+t;if(this._rangePromises.has(n))a.push(this._rangePromises.get(n));else{let i=r.getRange(e,t).then(()=>{this._rangePromises.delete(n)},()=>{this._rangePromises.delete(n)});this._rangePromises.set(n,i),a.push(i)}}),Promise.all(a).then(()=>{let i=this._glyphIndex[e];i||(i={},this._glyphIndex[e]=i);for(let a of t){let t=i[a];if(t){n[a]={sdf:!0,rect:t.rect,metrics:t.metrics,page:t.page,code:a};continue}let o=r.getGlyph(e,a);if(!o?.metrics)continue;let s=o.metrics,c;if(s.width===0)c=new F(0,0,0,0);else{let e=s.width+6,t=s.height+6,n=e%4?4-e%4:4,r=t%4?4-t%4:4;n===1&&(n=5),r===1&&(r=5),c=this._binPack.allocate(e+n,t+r),c.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new B(this.width-4,this.height-4),c=this._binPack.allocate(e+n,t+r));let i=this._glyphData[this._currentPage],a=o.bitmap,l,u;if(a)for(let n=0;n<t;n++){l=e*n,u=this.width*(c.y+n+1)+c.x;for(let t=0;t<e;t++)i[u+t+1]=a.at(l+t)}}i[a]={rect:c,metrics:s,tileIDs:null,page:this._currentPage},n[a]={sdf:!0,rect:c,metrics:s,page:this._currentPage,code:a},this._dirties[this._currentPage]=!0}return n})}removeGlyphs(e){for(let t in this._glyphIndex){let n=this._glyphIndex[t];if(!n)continue;let r;for(let t in n)if(r=n[t],r.tileIDs.delete(e),r.tileIDs.size===0){let e=this._glyphData[r.page],i=r.rect,a,o;for(let t=0;t<i.height;t++)for(a=this.width*(i.y+t)+i.x,o=0;o<i.width;o++)e[a+o]=0;delete n[t],this._dirties[r.page]=!0}}}bind(e,t,n,r=0){if(!this._textures[n]){let t=new A(this.width,this.height);t.pixelFormat=6406,t.wrapMode=33071,this._textures[n]=new x(e,t,new Uint8Array(this.width*this.height))}let i=this._textures[n];i.setSamplingMode(t),this._dirties[n]&&i.setData(this._glyphData[n]),e.bindTexture(i,r),this._dirties[n]=!1}destroy(){this.dispose()}dispose(){this._glyphData.length=0,this._binPack=null;for(let e of this._textures)e&&e.dispose();this._textures.length=0}},H=class{constructor(e){if(this._metrics=[],!e)return void(this._allBitmaps=null);let t=new Map,n=0;for(;e.next();)switch(e.tag()){case 1:{let r=e.getMessage();for(;r.next();)switch(r.tag()){case 3:{let e=r.getMessage(),i,a,o,s,c,l,u;for(;e.next();)switch(e.tag()){case 1:i=e.getUInt32();break;case 2:a=e.getBytes();break;case 3:o=e.getUInt32();break;case 4:s=e.getUInt32();break;case 5:c=e.getSInt32();break;case 6:l=e.getSInt32();break;case 7:u=e.getUInt32();break;default:e.skip()}if(e.release(),i){let e=a?.length??0;this._metrics[i]={width:o,height:s,left:c,top:l,advance:u,startOffset:n,length:e},t.set(i,a),n+=e}break}default:r.skip()}r.release();break}default:e.skip()}let r=new Uint8Array(n),i=this._metrics;for(let[e,n]of t){let{startOffset:t,length:a}=i[e];if(n)for(let e=0;e<a;++e)r[t+e]=n[e]}this._allBitmaps=r}getMetrics(e){return this._metrics[e]}getBitmap(e){if(!this._allBitmaps)return;let t=this._metrics[e];if(t===void 0)return;let{startOffset:n,length:r}=t;return r===0?void 0:new ve(this._allBitmaps,n,r)}},_e=class{constructor(){this._ranges=[]}get ranges(){return this._ranges}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t}},U=class{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,t){let n=this._getFontStack(e);if(n.getRange(t))return Promise.resolve();let r=256*t,i=r+255;if(this._baseURL){let a=this._baseURL.replace(`{fontstack}`,e).replace(`{range}`,r+`-`+i);return s(a,{responseType:`array-buffer`}).then(e=>{n.addRange(t,new H(new M(new Uint8Array(e.data),new DataView(e.data))))}).catch(()=>{n.addRange(t,new H)})}return n.addRange(t,new H),Promise.resolve()}getGlyph(e,t){let n=this._getFontStack(e);if(!n)return;let r=Math.floor(t/256),i=n.getRange(r);return i?{metrics:i.getMetrics(t),bitmap:i.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||=this._glyphInfo[e]=new _e,t}},ve=class{constructor(e,t,n){this._array=e,this._start=t,this.length=n}at(e){return 0<=e&&e<this.length?this._array[this._start+e]:void 0}},ye=`dasharray-`,W=class e{constructor(e,t,n=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,t<=0&&console.error(`Sprites mosaic defaultWidth and defaultHeight must be greater than zero!`),this._pageWidth=e,this._pageHeight=t,n>0&&(this._maxItemSize=n),this._binPack=new B(e-4,t-4)}destroy(){this.dispose()}dispose(){this._binPack=null,this._mosaicsData.length=0,this._mosaicRects={};for(let e of this._textures)e&&e.dispose();this._textures.length=0}getWidth(e){return e>=this._size.length?-1:this._size[e][0]}getHeight(e){return e>=this._size.length?-1:this._size[e][1]}getPageSize(e){return e>=this._size.length?null:this._size[e]}setSpriteSource(e){if(this.dispose(),this.pixelRatio=e.devicePixelRatio,this._mosaicsData.length===0){this._binPack=new B(this._pageWidth-4,this._pageHeight-4);let e=Math.floor(this._pageWidth),t=Math.floor(this._pageHeight),n=new Uint32Array(e*t);this._mosaicsData[0]=n,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=e}getSpriteItem(e,t=!1){let n,r,i=this._mosaicRects[e];if(i)return i;if(!this._sprites||this._sprites.loadStatus!==`loaded`||(e&&e.startsWith(ye)?([n,r]=this._rasterizeDash(e),t=!0):n=this._sprites.getSpriteInfo(e),!n?.width||!n.height||n.width<0||n.height<0))return null;let a=n.width,o=n.height,[s,c,l]=this._allocateImage(a,o);return s.width<=0?null:(this._copy(s,n,c,l,t,r),i={type:`sprite`,rect:s,width:a,height:o,sdf:n.sdf,simplePattern:!1,rasterizationScale:n.pixelRatio??1,samplingMode:`Linear`,page:c},this._mosaicRects[e]=i,i)}getSpriteItems(e){let t={};for(let n of e)t[n.name]=this.getSpriteItem(n.name,n.repeat);return t}getMosaicItemPosition(e,t){let n=this.getSpriteItem(e,t),r=n?.rect;if(!r)return null;r.width=n.width,r.height=n.height;let i=n.width,a=n.height;return{tl:[r.x+2,r.y+2],br:[r.x+2+i,r.y+2+a],page:n.page}}bind(e,t,n=0,r=0){if(n>=this._size.length||n>=this._mosaicsData.length)return;if(!this._textures[n]){let t=new A(this._size[n][0],this._size[n][1]);t.wrapMode=33071,this._textures[n]=new x(e,t,new Uint8Array(this._mosaicsData[n].buffer))}let i=this._textures[n];i.setSamplingMode(t),this._dirties[n]&&i.setData(new Uint8Array(this._mosaicsData[n].buffer)),e.bindTexture(i,r),this._dirties[n]=!1}static _copyBits(e,t,n,r,i,a,o,s,c,l,u){let d=r*t+n,f=s*a+o;if(u){f-=a;for(let o=-1;o<=l;o++,d=((o+l)%l+r)*t+n,f+=a)for(let t=-1;t<=c;t++)i[f+t]=e[d+(t+c)%c]}else for(let n=0;n<l;n++){for(let t=0;t<c;t++)i[f+t]=e[d+t];d+=t,f+=a}}_copy(t,n,r,i,a,o){if(!this._sprites||this._sprites.loadStatus!==`loaded`||r>=this._mosaicsData.length)return;let s=new Uint32Array(o?o.buffer:this._sprites.image.buffer),c=this._mosaicsData[r],l=o?n.width:this._sprites.width;e._copyBits(s,l,n.x,n.y,c,i[0],t.x+2,t.y+2,n.width,n.height,a),this._dirties[r]=!0}_allocateImage(e,t){e+=2,t+=2;let n=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<n){let n=new F(0,0,e,t);return this._mosaicsData.push(new Uint32Array(e*t)),this._dirties.push(!0),this._size.push([e,t]),this._textures.push(void 0),[n,this._mosaicsData.length-1,[e,t]]}let r=e%4?4-e%4:4,i=t%4?4-t%4:4;r===1&&(r=5),i===1&&(i=5);let a=this._binPack.allocate(e+r,t+i);return a.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new B(this._pageWidth-4,this._pageHeight-4),this._allocateImage(e,t)):[a,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(e){let t=/\[(.*?)\]/,n=e.match(t);if(!n)return null;let r=n[1].split(`,`).map(Number),i=e.slice(e.lastIndexOf(`-`)+1),[a,o,s]=ce(r,i);return[{x:0,y:0,width:o,height:s,sdf:!0,pixelRatio:1},new Uint8Array(a.buffer)]}},be=class{constructor(e,t,n,r){this._layer=e,this._styleRepository=t,this.devicePixelRatio=n,this._sourceDataMaxLOD=r,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null}destroy(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic?.destroy(),this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=y(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener(`abort`,this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null}get spriteMosaic(){return this._spriteSourcePromise.then(()=>this._spriteMosaic)}get glyphMosaic(){return this._glyphMosaic}async start(e){this._requestSprite(e);let t=this._layer.currentStyleInfo.glyphsUrl,n=new U(t?C(t,{...this._layer.customParameters,token:this._layer.apiKey}):null);this._glyphMosaic=new V(1024,1024,n),this._broadcastPromise=ne(`WorkerTileHandler`,{client:this,schedule:e.schedule,signal:e.signal}).then(t=>{if(this._layer&&(this._connection?.close(),this._connection=t,this._layer&&!this._connection.closed)){let n=t.broadcast(`setStyle`,{style:this._layer.currentStyleInfo.style,sourceDataMaxLOD:this._sourceDataMaxLOD},e);Promise.all(n).catch(e=>o(e))}})}_requestSprite(e){this._spriteSourceAbortController?.abort();let t=new AbortController;this._spriteSourceAbortController=t;let n=e?.signal;this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener(`abort`,this._inputSignalEventListener),this._startOptionsInputSignal=null,n&&(this._inputSignalEventListener=xe(t),n.addEventListener(`abort`,this._inputSignalEventListener,{once:!0}));let{signal:r}=t,a={...e,signal:r};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,a),this._spriteSourcePromise.then(e=>{i(r),this._spriteMosaic=new W(1024,1024,250),this._spriteMosaic.setSpriteSource(e)})}async updateStyle(e){let t=[];for(let n of e)n.type===4?t.push({type:4,data:{spriteSource:null}}):t.push(n);return await this._broadcastPromise,this._broadcastPromise=Promise.all(this._connection.broadcast(`updateStyle`,t)),this._broadcastPromise}setSpriteSource(e){let t=new W(1024,1024,250);return t.setSpriteSource(e),this._spriteMosaic=t,this._spriteSourcePromise=Promise.resolve(e),this._spriteSourceAbortController=null,t}async setStyle(e,t,n){await this._broadcastPromise,this._styleRepository=e,this._sourceDataMaxLOD=n,this._requestSprite();let r=new U(this._layer.currentStyleInfo.glyphsUrl?C(this._layer.currentStyleInfo.glyphsUrl,{...this._layer.customParameters,token:this._layer.apiKey}):null);return this._glyphMosaic=new V(1024,1024,r),this._broadcastPromise=Promise.all(this._connection.broadcast(`setStyle`,{style:t,sourceDataMaxLOD:this._sourceDataMaxLOD})),this._broadcastPromise}async fetchTileData(e,t){let n=await this._getRefKeys(e,t);return this._getSourcesData(Object.keys(this._layer.sourceNameToSource),n,t)}async fetchTilePBFs(e){let t=Object.keys(this._layer.sourceNameToSource),n={},r=await this._getRefKeys(e,n),i=[],a=[];for(let e=0;e<r.length;e++)if(r[e].value==null||t[e]==null)a.push(null);else{let o=r[e].value,s=this._getTilePayload(o,t[e],n);s.then(e=>{i.push({...e,key:o})}),a.push(s)}return Promise.all(a).then(()=>i)}async parseTileData(e,t){let n=e&&e.data;if(!n)return null;let{sourceName2DataAndRefKey:r,transferList:i}=n;return Object.keys(r).length===0?null:this._broadcastPromise.then(()=>this._connection.invoke(`createTileAndParse`,{key:e.key.id,sourceName2DataAndRefKey:r,styleLayerUIDs:e.styleLayerUIDs},{...t,transferList:i}))}async getSprites(e){return await this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(e)}getGlyphs(e){return this._glyphMosaic.getGlyphItems(e.font,e.codePoints)}async _getTilePayload(e,t,n){let r=T.pool.acquire(e.id),i=this._layer.sourceNameToSource[t],{level:a,row:o,col:s}=r;T.pool.release(r);try{return{protobuff:await i.requestTile(a,o,s,n),sourceName:t}}catch(e){if(w(e))throw e;return{protobuff:null,sourceName:t}}}async _getRefKeys(e,t){let n=this._layer.sourceNameToSource,r=[];for(let i in n){let a=n[i].getRefKey(e,t);r.push(a)}return f(r)}_getSourcesData(e,t,n){let r=[];for(let i=0;i<t.length;i++)if(t[i].value==null||e[i]==null)r.push(null);else{let a=t[i].value,o=this._getTilePayload(a,e[i],n);r.push(o)}return f(r).then(e=>{let n={},r=[];for(let i=0;i<e.length;i++){let a=e[i].value;if(a&&a.protobuff&&a.protobuff.byteLength>0){let e=t[i].value.id;n[a.sourceName]={refKey:e,protobuff:a.protobuff},r.push(a.protobuff)}}return{sourceName2DataAndRefKey:n,transferList:r}})}};function xe(e){return()=>e.abort()}var Se=1e-6,Ce=(e,t)=>e+1/(1<<2*t),G=class{constructor(e,n){this._tiles=new Map,this._tileCache=new t(40,e=>e.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this._container=n}destroy(){for(let e of this._tiles.values())e.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(e){this._updateCacheSize(e);let t=this.tileInfoView,n=t.getTileCoverage(e.state,0,!0,`smallest`);if(!n)return!0;let{spans:r,lodInfo:i}=n,{level:a}=i,o=this._tiles,s=new Set,c=new Set;for(let{row:e,colFrom:t,colTo:n}of r)for(let r=t;r<=n;r++){let t=T.getId(a,e,i.normalizeCol(r),i.getWorldForColumn(r)),n=this._getOrAcquireTile(t);s.add(t),n.processed()?this._addToContainer(n):c.add(new T(t))}for(let[e,t]of o)t.isCoverage=s.has(e);for(let e of c)this._findPlaceholdersForMissingTiles(e,s);let l=!1;for(let[e,r]of o)r.neededForCoverage=s.has(e),r.neededForCoverage||r.isHoldingForFade&&t.intersects(n,r.key)&&s.add(e),r.isFading&&(l=!0);for(let e of this._tiles.keys())s.has(e)||this._releaseTile(e);return v.pool.release(n),!l}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}getIntersectingTiles(e,t,n,r,i){let a=[0,0],o=[0,0];r.toMap(a,e-n,t+n),r.toMap(o,e+n,t-n);let s=Math.min(a[0],o[0]),c=Math.min(a[1],o[1]),l=Math.max(a[0],o[0]),u=Math.max(a[1],o[1]),d=p(s,c,l,u),f=E(),m=[];for(let e of this._visibleTiles.values())this.tileInfoView.getTileBounds(f,e.key),S(d,f)&&m.push(e);if(i!=null&&i.length>0){let e=new Set(m.map(e=>e.id)),t=i.filter(t=>!e.has(t.tileKey.id)).map(e=>this._visibleTiles.get(e.tileKey.id)).filter(e=>e!==void 0);m.push(...t)}return m}_findPlaceholdersForMissingTiles(e,t){let n=[];for(let r of this._tiles.values())this._addPlaceholderChild(n,r,e,t);let r=n.reduce(Ce,0);Math.abs(1-r)<Se||this._addPlaceholderParent(e.id,t)}_addPlaceholderChild(e,t,n,r){t.key.level<=n.level||!t.hasData()||Te(n,t.key)&&(this._addToContainer(t),r.add(t.id),e.push(t.key.level-n.level))}_addPlaceholderParent(e,t){let n=this._tiles,r=e;for(;;){if(r=we(r),!r||t.has(r))return;let e=n.get(r);if(e?.hasData())return this._addToContainer(e),void t.add(e.id)}}_getOrAcquireTile(e){let t=this._tiles.get(e);return t||(t=this._tileCache.pop(e),t||=this.acquireTile(new T(e)),this._tiles.set(e,t),t)}_releaseTile(e){let t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}_addToContainer(e){let t,n=[],r=this._container;if(r.contains(e))return;let i=this._visibleTiles;for(let r of i.values())this._canConnectDirectly(e,r)&&n.push(r),t==null&&this._canConnectDirectly(r,e)&&(t=r);if(t!=null){for(let r of n)t.childrenTiles.delete(r),e.childrenTiles.add(r),r.parentTile=e;t.childrenTiles.add(e),e.parentTile=t}else for(let t of n)e.childrenTiles.add(t),t.parentTile=e;i.set(e.id,e),r.addChild(e)}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),e.parentTile!=null){e.parentTile.childrenTiles.delete(e);for(let t of e.childrenTiles)e.parentTile!=null&&e.parentTile.childrenTiles.add(t)}for(let t of e.childrenTiles)t.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear()}_canConnectDirectly(e,t){let n=e.key,{level:r,row:i,col:a,world:o}=t.key,s=this._visibleTiles;for(;r>0;){if(r--,i>>=1,a>>=1,n.level===r&&n.row===i&&n.col===a&&n.world===o)return!0;if(s.has(`${r}/${i}/${a}/${o}`))return!1}return!1}_updateCacheSize(e){let t=e.state.size;if(t[0]===this._viewSize[0]&&t[1]===this._viewSize[1])return;let n=Math.ceil(t[0]/512)+1,r=Math.ceil(t[1]/512)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*n*r}};function we(e){let[t,n,r,i]=e.split(`/`),a=parseInt(t,10);return a===0?null:`${a-1}/${parseInt(n,10)>>1}/${parseInt(r,10)>>1}/${parseInt(i,10)}`}function Te(e,t){let n=t.level-e.level;return e.row===t.row>>n&&e.col===t.col>>n&&e.world===t.world}var Ee=class extends le{_createTransforms(){return{displayViewScreenMat3:d(),tileMat3:d()}}},K=1e-6;function q(e,t){if(e){let n=e.getLayoutProperty(`visibility`);if(!n||n.getValue()!==1&&(e.minzoom===void 0||e.minzoom<t+K)&&(e.maxzoom===void 0||e.maxzoom>=t-K))return!0}return!1}var De=class extends pe{constructor(e){super(e),this._backgroundTiles=[],this._computeDisplayInfoView(e)}destroy(){super.destroy(),this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,this._symbolFader!=null&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[]}get fading(){return this._symbolFader?.fading??!1}get symbolFader(){return this._symbolFader}get symbolRepository(){return this._symbolFader?.symbolRepository}setStyleResources(e,t,n,r){this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=n,this.tileInfoView=r,this._computeDisplayInfoView(r),this._symbolFader??=new ge(`vector-tile`,this._styleRepository,(e,t)=>{e.allSymbolsFadingOut=!0,e.lastOpacityUpdate=t,he(e,t,!0),e.decluttered=!0,e.requestRender()},this.children,N),this._symbolFader.styleRepository=n}setSpriteMosaic(e){this._spriteMosaic?.dispose(),this._spriteMosaic=e}deleteStyleLayers(e){this._symbolFader!=null&&this._symbolFader.deleteStyleLayers(e)}createRenderParams(e){return{...super.createRenderParams(e),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(e){!this.visible||e.drawPhase!==1&&e.drawPhase!==64||this._spriteMosaic===void 0||super.doRender(e)}addChild(e){return super.addChild(e),this._symbolFader==null?e.decluttered=!0:this._symbolFader.addTile(e),this.requestRender(),e}removeChild(e){return this._symbolFader!=null&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){let{drawPhase:t}=e;t===64?super.renderChildren(e):this._doRender(e)}removeAllChildren(){for(let e=0;e<this.children.length;e++){let t=this.children[e];this._symbolFader!=null&&this._symbolFader.removeTile(t),t.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(e=>e.neededForCoverage&&e.hasData())}restartDeclutter(){this._symbolFader!=null&&this._symbolFader.restartDeclutter()}_doRender(e){let{context:t,state:n}=e,r=this._styleRepository;if(!r)return;let i=r.layers,a=this._displayInfo.scaleToZoom(n.scale);r.backgroundBucketIds.length>0&&(e.renderPass=`background`,this._renderBackgroundLayers(e,r.backgroundBucketIds,a)),super.renderChildren(e),e.drawPhase===1&&this._fade(a,n);let o=this.children.filter(e=>e.visible&&e.hasData());if(!o||o.length===0)return t.bindVAO(null),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);for(let e of o)e.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(7680,7680,7681),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(515),t.setClearDepth(1),t.clear(256),e.renderPass=`opaque`;for(let t=i.length-1;t>=0;t--)this._renderStyleLayer(i[t],e,o);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(1,771,1,771),e.renderPass=`translucent`;for(let t=0;t<i.length;t++)this._renderStyleLayer(i[t],e,o);t.bindVAO(null),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0);for(let e of o)e.debugInfo.display.triangleCount=e.triangleCount}_fade(e,t){this._symbolFader!=null&&(this._symbolFader.update(e,t)||this.requestRender())}_renderStyleLayer(e,t,n){let{displayLevel:r,painter:i,renderPass:a}=t;if(e===void 0)return;let o=e.getLayoutProperty(`visibility`);if(o&&o.getValue()===1)return;let s;switch(e.type){case 0:return;case 1:if(a!==`opaque`&&t.renderPass!==`translucent`)return;s=`vtlFill`;break;case 2:if(a!==`translucent`)return;s=`vtlLine`;break;case 4:if(a!==`translucent`)return;s=`vtlCircle`;break;case 3:if(a!==`translucent`)return;s=`vtlSymbol`}if(n=e.type===3?n.filter(e=>e.decluttered):n.filter(e=>e.neededForCoverage),s!==`vtlSymbol`&&(n.length===0||e.minzoom!==void 0&&e.minzoom>=r+K||e.maxzoom!==void 0&&e.maxzoom<r-K))return;let c=e.uid;t.styleLayerUID=c,t.styleLayer=e;for(let e of n)if(e.layerData.has(c)){i.renderObjects(t,n,s);break}}_renderBackgroundLayers(e,t,n){let{context:r,painter:i,state:a}=e,o=this._styleRepository,s=!1;for(let e of t)if(o.getLayerById(e).type===0&&q(o.getLayerById(e),n)){s=!0;break}if(!s)return;let c=this.tileInfoView,l=c.getTileCoverage(e.state,0,!0,`smallest`),{spans:u,lodInfo:d}=l,{level:f}=d,p=E(),m=[];if(this._renderPasses){let t=this._renderPasses[0];this._clippingInfos!=null&&(t.brushes[0].prepareState(e),t.brushes[0].drawMany(e,this._clippingInfos))}let h=this._backgroundTiles,g,_=0;for(let{row:e,colFrom:t,colTo:n}of u)for(let r=t;r<=n;r++){if(_<h.length)g=h[_],g.key.set(f,e,d.normalizeCol(r),d.getWorldForColumn(r)),c.getTileBounds(p,g.key,!1),g.x=p[0],g.y=p[3],g.resolution=c.getTileResolution(f);else{let t=new T(f,e,d.normalizeCol(r),d.getWorldForColumn(r)),n=c.getTileBounds(E(),t),i=c.getTileResolution(f);g=new Ee(t,i,n[0],n[3],512,512,N,N),h.push(g)}g.setTransform(a),m.push(g),_++}r.setStencilWriteMask(0),r.setColorMask(!0,!0,!0,!0),r.setStencilOp(7680,7680,7681),r.setStencilFunction(514,0,255),r.setStencilTestEnabled(!0);for(let r of t){let t=o.getLayerById(r);t.type===0&&q(t,n)&&(e.styleLayerUID=t.uid,e.styleLayer=t,i.renderObjects(e,m,`vtlBackground`))}v.pool.release(l)}_computeDisplayInfoView(e){let t=e.tileInfo.lods[0].scale,n=Math.max(25,e.tileInfo.lods.length),r=[];for(let e=0;e<=n;e++)r.push(t),t/=2;this._displayInfo=j.create({scales:r,size:512,spatialReference:e.spatialReference,numLODs:n})}},J,Y=class extends _{get[(J=R,te)](){return this.layer}constructor(e,t,n){super(),this[J]=!0,this.type=`vector-tile`,this.layer=e,this.layerId=t,this.layerIndex=n}get id(){return`${this.layer.id}:__${this.layerId}__:__${this.layerIndex}__`}},Oe=(e,t)=>{let n=e.vtlSymbol.sourceTile,r=t.vtlSymbol.sourceTile;return n.level===r.level?n.row===r.row?n.col===r.col?e.styleLayerUID-t.styleLayerUID:n.col-r.col:n.row-r.row:n.level-r.level},ke=class e{constructor(e,t,n,r,i){this.tileKey=e,this._tileLayerData=t,this._styleRepository=n,this._tileHandler=r,this._parentLayer=i,this._index=null,this._tileKeyToPBF=new Map}static create(t,n,r,i,a){return new e(t,n,r,i,a)}clear(){this._index?.clear(),this._tileKeyToPBF.clear()}async queryAttributes(e,t,n,r,i){if(this._tileLayerData.size===0||!this._styleRepository||!this._tileHandler)return[];this._index===null&&(this._index=new re(100,Ae),await this._indexLayers());let a=[];return this._queryIndex(a,e,t,n,this.tileKey.level,r),i&&i?.length>0&&await this._getSymbolsAttributes(a,i),a}async _indexLayers(){let e=this.tileKey,t=this._styleRepository.layers,n=await this._getTilePayload(e);for(let[r,i]of this._tileLayerData){let a=t[r],o=n.find(e=>e.sourceName===a.source);if(!o)continue;let{protobuff:s,key:c}=o;if(i.type!==3){let t=1<<e.level-c.level,n=e.row-c.row*t,r=e.col-c.col*t;this._indexLayer(a,s,e.level,t,n,r)}}}_indexLayer(e,t,n,r,i,a){let o=e.sourceLayer,s=e.getFeatureFilter(),c=n,l=n+1,u=oe(c),d=new M(new Uint8Array(t),new DataView(t));for(;d.next();)switch(d.tag()){case 3:{let t=d.getMessage(),f=new L(t);if(t.release(),f.name!==o)continue;let p=f.getData(),m=f.extent/r,h=m*a-u,g=m*i-u,_=h+m+2*u,v=g+m+2*u,y=m/512,b=N/m,x=m*a,S=m*i;for(;p.nextTag(2);){let t=p.getMessage(),r=new I(t,f);if(t.release(),s&&!s.filter(r,n))continue;let i=r.values||{},a=i._minzoom,o=i._maxzoom;if(a&&a>=10*l||o&&o<=10*c)continue;let u=e.getFeatureInflatedBounds(r,c,f.extent,y);u==null||u[0]>_||u[1]>v||u[2]<h||u[3]<g||(u[0]=(u[0]-x)*b,u[1]=(u[1]-S)*b,u[2]=(u[2]-x)*b,u[3]=(u[3]-S)*b,this._index.insert(new se(e,r,u,b,x,S)))}break}default:d.skip()}d.release()}async _getSymbolsAttributes(e,t){if(!t||t.length===0)return e;let n=[];if(t.sort(Oe),t.length>0){let e=0,{styleLayerUID:r}=t[0];for(let i=1;i<t.length;i++){let{styleLayerUID:a}=t[i];a!==r&&(n.push({from:e,to:i,styleLayerUID:r,sourceTileKey:t[i-1].vtlSymbol.sourceTile}),e=i,r=a)}let i=t.length-1;n.push({from:e,to:t.length,styleLayerUID:r,sourceTileKey:t[i].vtlSymbol.sourceTile})}let r=this._styleRepository.layers;for(let i of n){let n=await this._getTilePayload(i.sourceTileKey),a=r[i.styleLayerUID],o=!!a&&n.find(e=>e.sourceName===a.source);o&&this._addSymbolsAttributes(e,t.slice(i.from,i.to).map(e=>e.vtlSymbol.featureIndex),i.styleLayerUID,o)}return e}_addSymbolsAttributes(e,t,n,r){let i=this._styleRepository.layers,a=r.key,o=this.tileKey,s=1<<o.level-a.level,c=o.row-a.row*s,l=o.col-a.col*s;this._getSymbolAttributes(r.protobuff,t,n,s,c,l).forEach(t=>{let{attributes:r,tilePoint:a}=t;e.push({layerId:i[n].id,layerIndex:n,graphic:new k({attributes:r,origin:new Y(this._parentLayer,i[n].id,n)}),tilePoint:a})})}_getSymbolAttributes(e,t,n,r,i,a){let o=[],s=this._styleRepository.layers,c=0;t.sort((e,t)=>e-t);let l=new M(new Uint8Array(e),new DataView(e));for(;l.next();)switch(l.tag()){case 3:{let e=l.getMessage(),u=new L(e);if(e.release(),u.name!==s[n].sourceLayer)continue;let d=u.getData(),f=u.extent/r,p=N/f,m=f*a,h=f*i,g=0;for(;d.nextTag(2);){let e=d.getMessage();if(g++===t[c]){let t=new I(e,u),n=t.values,r=t.getGeometry(),i=r==null?null:[p*(r[0][0].x-m),p*(r[0][0].y-h)];o.push({attributes:n,tilePoint:i}),c++}if(e.release(),c===t.length)return o}break}default:l.skip()}return l.release(),o}_queryIndex(e,t,n,r,i,a){let o=8*r*(window.devicePixelRatio||1);return this._index?.search({minX:t-o,minY:n-o,maxX:t+o,maxY:n+o},o=>{let{layer:s,feature:c}=o;s.isIntersectingFeature(t,n,r,c,i,a,o)&&e.push({layerId:s.id,layerIndex:s.uid,tilePoint:null,graphic:new k({attributes:c.values,origin:new Y(this._parentLayer,o.layer.id,o.layer.uid)})})}),e}async _getTilePayload(e){return g(this._tileKeyToPBF,e.id,()=>this._tileHandler.fetchTilePBFs(e)).then(e=>e)}},Ae=e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]}),X=class extends e{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(e){let t=T.pool.acquire(e),n=t.level===0?null:T.getId(t.level-1,t.row>>1,t.col>>1,t.world);return T.pool.release(t),n}getTileCoverage(e,t,n=!0,r){let i=super.getTileCoverage(e,t,n,r);if(!i)return i;let a=1<<i.lodInfo.level;return i.spans=i.spans.filter(e=>e.row>=0&&e.row<a),i}scaleToLevel(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];{let t=this._fullCacheLodInfos;if(e>t[0].scale)return t[0].level;let n,r;for(let i=0;i<t.length-1;i++)if(r=t[i+1],e>r.scale)return n=t[i],n.level+(n.scale-e)/(n.scale-r.scale);return t[t.length-1].level}}_initializeFullCacheLODs(e){let t;if(e[0].level===0)t=e.map(e=>({level:e.level,resolution:e.resolution,scale:e.scale}));else{let e=this.tileInfo.size[0],n=this.tileInfo.spatialReference;t=j.create({size:e,spatialReference:n}).lods.map(e=>({level:e.level,resolution:e.resolution,scale:e.scale}))}for(let e=0;e<t.length;e++)this._levelByScale[t[e].scale]=t[e].level;this._fullCacheLodInfos=t}},Z=2,je=8,Q=512,$=class extends fe(ue(de)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._styeChanged=!1,this._spriteSourceChanged=!1}get fading(){return this._vectorTileContainer?.fading??!1}get hasVisibleFeatures(){let e=this._vectorTileContainer.children;for(let t of e)if(t.hasFeatures())return!0;return!1}get spriteSourceChanged(){return this._spriteSourceChanged}get styleChanged(){return this._styeChanged}async hitTest(e,t){let n=this._tileHandlerPromise,r=this._vectorTileContainer?.symbolFader;if(!n||!this._isTileHandlerReady||!r)return;await n;let i=null,a=this._vectorTileContainer?.symbolRepository;a&&(i=a.querySymbols(t,Z,r.decluttererOffset,{}));let o=this.view.state,s=this._tileManager.getIntersectingTiles(t.x,t.y,Z,o,i);if((!s||s.length===0)&&i?.length===0)return null;e=e.clone().normalize();let c=[],l=[];for(let t of s)c.push(this._queryTile(l,e,Z,this.view.state.rotation,t,i?.filter(e=>e.tileKey.id===t.id)));return await Promise.all(c),l}update(e){if(this._tileHandlerPromise&&this._isTileHandlerReady)return e.pixelRatio===this._tileHandler.devicePixelRatio?void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._pauseQueues(),this._fetchQueue.state=e.state,this._parseQueue.state=e.state,this._tileManager.update(e)||this.requestUpdate(),this._resumeQueues())):(this._tileHandler.devicePixelRatio=e.pixelRatio,void this._loadStyle())}attach(){let{style:e}=this.layer.currentStyleInfo;this._styleRepository=new P(e),this._tileInfoView=new X(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new De(this._tileInfoView),this._tileHandler=new be(this.layer,this._styleRepository,window.devicePixelRatio||1,this.layer.tileInfo.lods.length-1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this.layer.on(`paint-change`,e=>{if(this._styeChanged=!0,e.isDataDriven)this._styleChanges.push({type:0,data:e}),this.requestUpdate();else{let t=this._styleRepository,n=t.getLayerById(e.layer);if(!n)return;let r=n.type===3;t.setPaintProperties(e.layer,e.paint),r&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender()}}),this.layer.on(`layout-change`,e=>{let t=this._styleRepository,r=t.getLayerById(e.layer);if(!r)return;this._styeChanged=!0;let i=u(r.layout,e.layout);if(i!=null){if(n(i,`visibility`)&&Me(i)===1)return t.setLayoutProperties(e.layer,e.layout),r.type===3&&this._vectorTileContainer?.restartDeclutter(),void this._vectorTileContainer?.requestRender();this._styleChanges.push({type:1,data:e}),this.requestUpdate()}}),this.layer.on(`style-layer-visibility-change`,e=>{let t=this._styleRepository,n=t.getLayerById(e.layer);n&&(this._styeChanged=!0,t.setStyleLayerVisibility(e.layer,e.visibility),n.type===3&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender())}),this.layer.on(`style-layer-change`,e=>{this._styleChanges.push({type:2,data:e}),this._styeChanged=!0,this.requestUpdate()}),this.layer.on(`delete-style-layer`,e=>{this._styleChanges.push({type:3,data:e}),this._styeChanged=!0,this.requestUpdate()}),this.layer.on(`load-style`,()=>this._loadStyle()),this.layer.on(`spriteSource-change`,e=>{this._spriteSourceChanged=!0,this._styleChanges.push({type:4,data:e});let t=this._styleRepository.layers;for(let e of t)switch(e.type){case 3:e.getLayoutProperty(`icon-image`)&&this._styleChanges.push({type:1,data:{layer:e.id,layout:e.layout}});break;case 2:e.getPaintProperty(`line-pattern`)&&this._styleChanges.push({type:0,data:{layer:e.id,paint:e.paint,isDataDriven:e.isPainterDataDriven()}});break;case 1:e.getLayoutProperty(`fill-pattern`)&&this._styleChanges.push({type:0,data:{layer:e.id,paint:e.paint,isDataDriven:e.isPainterDataDriven()}})}this.requestUpdate()})])}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=O(this._vectorTileContainer),this._tileHandler=O(this._tileHandler)}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return h(this.layer.tileInfo?.spatialReference,e)}canResume(){let e=super.canResume(),{currentStyleInfo:t}=this.layer;if(e&&t?.layerDefinition){let n=this.view.scale,{minScale:r,maxScale:i}=t.layerDefinition;t?.layerDefinition&&(r&&r<n&&(e=!1),i&&i>n&&(e=!1))}return e}isUpdating(){return this.fading}acquireTile(e){let t=this._createVectorTile(e);return this._updatingHandles.addPromise(this._fetchQueue.push(t.key).then(e=>this._parseQueue.push({key:t.key,data:e})).then(e=>{t.once(`attach`,()=>this.requestUpdate()),t.setData(e),this.requestUpdate()}).catch(e=>{w(e)||D.getLogger(this).error(e)})),t}releaseTile(e){let t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}async doRefresh(){if(!this.attached)return;if(this.suspended)return this._tileManager.clear(),void this.requestUpdate();this._isTileHandlerReady=!1,this._pauseQueues(),this._clearQueues(),this._tileManager.clearCache(),this._resumeQueues();let e=this._vectorTileContainer.children,t=[];try{for(let n of e){let e=this._updatingHandles.addPromise(this._fetchQueue.push(n.key).then(e=>this._parseQueue.push({key:n.key,data:e})).then(e=>n.setData(e)).finally(()=>n.featureIndex=null));t.push(e)}await Promise.all(t)}catch(e){D.getLogger(this).error(`error refreshing vector-tiles layer-view`,e),this._resumeQueues(),this._isTileHandlerReady=!0}this._isTileHandlerReady=!0,this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new G({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;let e=new AbortController,t=this._tileHandler.start({signal:e.signal}).then(()=>{this._fetchQueue=new m({tileInfoView:this._tileInfoView,process:(e,t)=>this._getTileData(e,t),concurrency:15,scheduler:this.scheduler,priority:l.MAPVIEW_FETCH_QUEUE}),this._parseQueue=new m({tileInfoView:this._tileInfoView,process:(e,t)=>this._parseTileData(e,t),concurrency:8,scheduler:this.scheduler,priority:l.MAPVIEW_VECTOR_TILE_PARSING_QUEUE}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(e=>{this._vectorTileContainer.setStyleResources(e,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this.requestUpdate()}),this._tileHandlerAbortController=e,this._tileHandlerPromise=t}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;let e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=O(this._fetchQueue),this._parseQueue=O(this._parseQueue),this._tileManager=O(this._tileManager),this._vectorTileContainer.removeAllChildren()}async _getTileData(e,t){return this._tileHandler.fetchTileData(e,t)}async _parseTileData(e,t){return this._tileHandler.parseTileData(e,t)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._pauseQueues(),this._clearQueues(),this._tileManager.clearCache();let e=this._styleChanges;try{await this._tileHandler.updateStyle(e)}catch(e){D.getLogger(this).error(`error applying vector-tiles style update`,e.message),this._resumeQueues(),this._isTileHandlerReady=!0}let t=this._styleRepository,n=new Set;e.forEach(e=>{if(e.type!==3)return;let r=e.data,i=t.getLayerById(r.layer);i&&n.add(i.uid)});let r=new Set;e.forEach(e=>{let n;switch(e.type){case 0:t.setPaintProperties(e.data.layer,e.data.paint),n=e.data.layer;break;case 1:t.setLayoutProperties(e.data.layer,e.data.layout),n=e.data.layer;break;case 3:t.deleteStyleLayer(e.data.layer);return;case 2:t.setStyleLayer(e.data.layer,e.data.index),n=e.data.layer.id;break;case 4:this._vectorTileContainer.setSpriteMosaic(this._tileHandler.setSpriteSource(e.data.spriteSource))}if(n){let e=t.getLayerById(n);e&&r.add(e.uid)}});let i=this._vectorTileContainer.children;if(n.size>0){let e=Array.from(n);this._vectorTileContainer.deleteStyleLayers(e);for(let t of i)t.deleteLayerData(e)}if(this._resumeQueues(),r.size>0){let e=Array.from(r),t=[];for(let n of i){let r=this._updatingHandles.addPromise(this._fetchQueue.push(n.key).then(t=>this._parseQueue.push({key:n.key,data:t,styleLayerUIDs:e})).then(e=>n.setData(e)).finally(()=>n.featureIndex=null));t.push(r)}await Promise.all(t)}this._styleChanges=[],this._isTileHandlerReady=!0,this.requestUpdate()}async _loadStyle(){let{style:e}=this.layer.currentStyleInfo,t=c(e);this._isTileHandlerReady=!1,this._pauseQueues(),this._clearQueues(),this._styleRepository=new P(t),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;let{signal:n}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,t,this.layer.tileInfo.lods.length-1),await this._tileHandlerPromise}catch(e){if(!w(e))throw e}if(n.aborted)return this._resumeQueues(),this._isTileHandlerReady=!0,this._styeChanged=!1,this._spriteSourceChanged=!1,void this.requestUpdate();let r=await this._tileHandler.spriteMosaic,i=this._vectorTileContainer;this._tileInfoView=new X(this.layer.tileInfo,this.layer.fullExtent),i.setStyleResources(r,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this._tileManager=new G({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),this._resumeQueues(),this._isTileHandlerReady=!0,this.requestUpdate(),this._styeChanged=!1,this._spriteSourceChanged=!1}_createVectorTile(e){let t=this._tileInfoView.getTileBounds(E(),e),n=this._tileInfoView.getTileResolution(e.level);return new me(e,n,t[0],t[3],512,512,this._styleRepository)}async _queryTile(e,t,n,r,i,a){if(i.layerData.size===0)return;let o=this._ensureTileIndex(i),s=this._tileInfoView.getTileBounds(E(),i.key,!0),c=je*Q*((t.x-s[0])/(s[2]-s[0])),l=je*Q*(1-(t.y-s[1])/(s[3]-s[1])),u=await o.queryAttributes(c,l,n,r,a);for(let n of u)n.graphic.geometry=this._tileToMapPoint(n.tilePoint,i.transforms.tileUnitsToPixels),e.push({type:`graphic`,layer:this.layer,graphic:n.graphic,mapPoint:t.clone()});e.sort((e,t)=>(z(t.graphic.origin)?t.graphic.origin.layerIndex:0)-(z(e.graphic.origin)?e.graphic.origin.layerIndex:0))}_tileToMapPoint(e,t){if(!e)return null;let n=e[0]*t[0]+e[1]*t[3]+t[6],r=e[0]*t[1]+e[1]*t[4]+t[7],i=this.view.state,a=[0,0];return i.toMap(a,[n,r]),new ee({x:a[0],y:a[1],spatialReference:i.spatialReference})}_ensureTileIndex(e){let t=e.featureIndex;return t||(t=ke.create(e.key,e.layerData,this._styleRepository,this._tileHandler,this.layer),e.featureIndex=t),t}_pauseQueues(){this._fetchQueue.pause(),this._parseQueue.pause()}_resumeQueues(){this._fetchQueue.resume(),this._parseQueue.resume()}_clearQueues(){this._fetchQueue.clear(),this._parseQueue.clear()}};function Me(e){if(e==null)return 0;switch(e.type){case`partial`:return Object.keys(e.diff).length;case`complete`:return Math.max(Object.keys(e.oldValue).length,Object.keys(e.newValue).length);case`collection`:return Object.keys(e.added).length+Object.keys(e.changed).length+Object.keys(e.removed).length}}b([r()],$.prototype,`_isTileHandlerReady`,void 0),$=b([a(`esri.views.2d.layers.VectorTileLayerView2D`)],$);var Ne=$;export{Ne as default};