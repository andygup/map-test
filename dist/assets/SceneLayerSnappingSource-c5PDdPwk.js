import{DT as e,FE as t,JE as n,Kw as r,OE as i,OT as a,UT as o,_w as s,c_ as c,eT as l,fT as u,gD as d,pT as f,pg as p}from"./index-CzMixifc.js";import"./quatf64-eO7UAs9K.js";import"./Indices-DELx3He_.js";import"./plane--nqwMDYx.js";import"./vectorStacks-BQiry9fn.js";import"./deduplicate-C8bQBzHi.js";import"./BufferView-BPABY7if.js";import"./Util-YNFIi00s.js";import"./types-DsLx34Br.js";import"./dehydratedPoint-CVzHYxaL.js";import"./elevationInfoUtils-BcUBf70F.js";import{t as m}from"./WorkerHandle-CebpJ7hn.js";import"./ObjectStack-DiVLRoBj.js";import"./ray-XqUMyuyU.js";import"./VertexAttributeLocations-DOYYzMyn.js";import"./VertexElementDescriptor-C9CNG143.js";import"./geodesicUtils-DoIAZh7n.js";import{g as h,l as g}from"./LineSnappingHint-C4TfMb_L.js";import"./vec3-D7a6REBc.js";import"./sphere-DkSdrT5o.js";import"./constraints-CZ12pnWC.js";import"./SnappingCandidate-CgOYxD9J.js";import{t as _}from"./EdgeSnappingCandidate-CRqUhTG1.js";import"./PointSnappingHint-BIIZt5I0.js";import"./FloatArray-DhcAaYJ8.js";import"./TextureBackedBufferLayout-YNJ8l8Rr.js";import"./Normals-C9bgSX6t.js";import{t as v}from"./workerHelper-Bt28zin9.js";import{n as y}from"./edgeProcessing-9mNprDxI.js";import{t as b}from"./VertexSnappingCandidate-C4r-KIir.js";var x=class extends m{constructor(e){super(`EdgeProcessingWorker`,`extract`,{extract:e=>[e.dataBuffer],extractComponentsEdgeLocations:e=>[e.dataBuffer],extractEdgeLocations:e=>[e.dataBuffer]},e)}async process(e,t,n){return n?y(e):S(await this.invoke(new C(e),t))}async extractEdgeLocations(e,t){let n=await this.invokeMethod(`extractEdgeLocations`,new C(e),t);return v(n)}async extractComponentsEdgeLocations(e,t){let n=await this.invokeMethod(`extractComponentsEdgeLocations`,new C(e),t);return v(n)}};function S(e){return{regular:{instancesData:v(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:v(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}var C=class{constructor(e){this.dataBuffer=e.data.buffer,this.writerSettings=e.writerSettings,this.skipDeduplicate=e.skipDeduplicate,this.indices=t(e.indices)?e.indices.buffer:e.indices,this.indicesType=t(e.indices)?i(e.indices)?`Uint32Array`:`Uint16Array`:`Array`,this.indicesLength=e.indicesLength}},w=class extends s{constructor(e){super(e),this.availability=0,this._ids=new Set}destroy(){this._workerHandle.destroy(),this._workerHandle=null}initialize(){this._workerHandle=new T(this.schedule,{fetchAllEdgeLocations:(e,t)=>this._fetchAllEdgeLocations(e,t)})}async fetchCandidates(e,t){let n=e.coordinateHelper,{point:r}=e,i=c();if(!this.renderCoordsHelper.toRenderCoords(r,n.spatialReference,i))return[];let a=e.distance,o=typeof a==`number`?a:a.distance,s=await this._workerHandle.invoke({mbsJSON:{center:i,radius:o},returnEdge:e.returnEdge,returnVertex:e.vertexMode!==`none`},t);return s.candidates.sort((e,t)=>e.distance-t.distance),s.candidates.map(e=>this._convertCandidate(n,e))}async add(e,t){this._ids.add(e.id),await this._workerHandle.invokeMethod(`add`,e,t)}async remove(e,t){this._ids.delete(e.id),await this._workerHandle.invokeMethod(`remove`,e,t)}_convertCandidate(e,t){switch(t.type){case`edge`:return new _({objectId:t.objectId,targetPoint:h(this._convertRenderCoordinate(e,t.target)),edgeStart:this._convertRenderCoordinate(e,t.start),edgeEnd:this._convertRenderCoordinate(e,t.end),isDraped:!1});case`vertex`:return new b({objectId:t.objectId,targetPoint:h(this._convertRenderCoordinate(e,t.target)),isDraped:!1})}}_convertRenderCoordinate({spatialReference:e},t){let n=c();return this.renderCoordsHelper.fromRenderCoords(t,n,e),g(n)}async _fetchAllEdgeLocations(e,t){let n=[],r=[];for(let{id:i,uid:a}of e.components)this._ids.has(i)&&n.push((async()=>{let e=await this.fetchEdgeLocations(i,t.signal),n=e.locations.buffer;return r.push(n),{id:i,uid:a,objectIds:e.objectIds,locations:n,origin:e.origin,type:e.type}})());return{result:{components:(await Promise.all(n)).filter(({id:e})=>this._ids.has(e))},transferList:r}}};d([e({constructOnly:!0})],w.prototype,`renderCoordsHelper`,void 0),d([e({constructOnly:!0})],w.prototype,`fetchEdgeLocations`,void 0),d([e({constructOnly:!0})],w.prototype,`schedule`,void 0),d([e({readOnly:!0})],w.prototype,`availability`,void 0),w=d([a(`esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorkerHandle`)],w);var T=class extends m{constructor(e,t){super(`SceneLayerSnappingSourceWorker`,`fetchCandidates`,{},e,{strategy:`dedicated`,client:t})}},E=class extends s{get updating(){return this._updatingHandles.updating}constructor(e){super(e),this.availability=1,this._updatingHandles=new p,this._abortController=new AbortController}destroy(){this._tracker=f(this._tracker),this._abortController=u(this._abortController),this._updatingHandles.destroy()}initialize(){let{view:e}=this,t=e.resourceController;this._edgeWorker=new x(D(t)),this._workerHandle=new w({renderCoordsHelper:this.view.renderCoordsHelper,schedule:D(t),fetchEdgeLocations:async(e,t)=>{if(this._tracker==null)throw Error(`tracker-not-initialized`);return this._tracker.fetchEdgeLocations(e,this._edgeWorker,t)}}),this._updatingHandles.addPromise(this._setupLayerView()),this.addHandles([o(this._workerHandle),o(this._edgeWorker)])}async fetchCandidates(e,t){return this._workerHandle.fetchCandidates(e,t)}refresh(){}async _setupLayerView(){if(this.destroyed)return;let e=this._abortController?.signal,t=await this.getLayerView();t==null||r(e)||(this._tracker=t.trackSnappingSources({add:(t,n)=>{this._updatingHandles.addPromise(this._workerHandle.add({id:t,bounds:n.toJSON()},e))},remove:t=>{this._updatingHandles.addPromise(this._workerHandle.remove({id:t},e))}}))}};function D(e){return t=>e.immediate.schedule(t)}d([e({constructOnly:!0})],E.prototype,`getLayerView`,void 0),d([e({constructOnly:!0})],E.prototype,`view`,void 0),d([e({readOnly:!0})],E.prototype,`updating`,null),d([e({readOnly:!0})],E.prototype,`availability`,void 0),E=d([a(`esri.views.interactive.snapping.featureSources.I3SSnappingSource`)],E);var O=class extends s{get updating(){return this._i3sSources.some(e=>e.updating)}constructor(e){super(e),this.availability=1,this._i3sSources=[]}destroy(){this._i3sSources.forEach(e=>e.destroy()),this._i3sSources.length=0}initialize(){let{view:e}=this,t=this.layerSource.layer;this._i3sSources=t.type===`building-scene`?this._getBuildingSceneI3SSources(e,t):[this._getSceneLayerI3SSource(e,t)]}async fetchCandidates(e,t){let n=await Promise.all(this._i3sSources.map(n=>n.fetchCandidates(e,t)));return l(t),n.flat()}refresh(){this._i3sSources.forEach(e=>e.refresh())}_getBuildingSceneI3SSources(e,t){return t.allSublayers.toArray().map(n=>n.type===`building-component`?new E({getLayerView:async()=>(await e.whenLayerView(t)).whenSublayerView(n),view:e}):null).filter(n)}_getSceneLayerI3SSource(e,t){return new E({getLayerView:async()=>{let n=await e.whenLayerView(t);return n.type===`scene-layer-graphics-3d`?void 0:n},view:e})}};d([e({constructOnly:!0})],O.prototype,`layerSource`,void 0),d([e({constructOnly:!0})],O.prototype,`view`,void 0),d([e({readOnly:!0})],O.prototype,`updating`,null),d([e({readOnly:!0})],O.prototype,`availability`,void 0),O=d([a(`esri.views.interactive.snapping.featureSources.SceneLayerSnappingSource`)],O);export{O as SceneLayerSnappingSource};