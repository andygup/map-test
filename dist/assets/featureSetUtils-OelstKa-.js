import{Ar as e,Cx as t,Dh as n,Fh as r,Jp as i,Or as a,RS as o,Xm as s,Zm as c,aC as l,g as u,id as d,qE as f,rd as p,sD as m,ud as h,vy as g,w as _,zh as v}from"./index-CzMixifc.js";import{n as y}from"./arcadeEnvironment-BvmpPtDd.js";import{Q as b,s as x,t as ee}from"./Dictionary-CGt1qKCN.js";import{a as S,i as C,n as w,o as T,r as E}from"./shared-DVF4C5pR.js";import{t as D}from"./WhereClause-2gh-KjwG.js";import{t as O}from"./Attachment-CF32PXLj.js";import{C as k,S as A,_ as j,a as te,h as M,i as N,n as P,r as F,t as I,v as L,x as R}from"./FeatureSet-B1gniK-o.js";import{n as z}from"./queryRelatedRecords-tkpAEmVF.js";var B=class{constructor(){this.declaredRootClass=`esri.arcade.featureSetCollection`,this._layerById={},this._layerByName={}}add(e,t,n){this._layerById[t]=n,this._layerByName[e]=n}async featureSetByName(e,t=!0,n=[`*`]){return this._layerByName[e]===void 0?null:this._layerByName[e]}async featureSetById(e,t=!0,n=[`*`]){return this._layerById[e]===void 0?null:this._layerById[e]}castToText(e=!1){return`object, FeatureSetCollection`}},V=class extends N{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.actions.AttributeFilter`,this._maxProcessing=1e3,this._parent=e.parentfeatureset,e.whereclause instanceof D?(this._whereClause=e.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=e.whereclause,this._whereClause=null)}_initialiseFeatureSet(){this.fields=this._parent.fields.slice(),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.subtypeField=this._parent.subtypeField,this.subtypes=this._parent.subtypes}async _queryAll(){return(await this.query({abortSignal:y})).features}async query(e){let t=e.where;this._whereClauseFunction!==null||(t==null?t=this._whereClause:this._whereClause!==null&&(t=j(this._whereClause,t))),await this._ensureLoaded();let n=await this._parent.query({...e,where:t});return k(e.abortSignal),n.filterApplied&&this._whereClauseFunction==null?n:{...n,features:this._applyFilter(n.features,e.abortSignal)}}async*_applyFilter(e,t){for await(let n of e)if(k(t),this._whereClause!=null){let e=n.filter(e=>this._whereClause.testFeature(e));e.length>0&&(yield e)}else if(this._whereClauseFunction!=null){let e=[];for(let t of n)await this._whereClauseFunction(t)&&e.push(t);e.length>0&&(yield e)}else yield n}async queryStat(e){if(this._whereClauseFunction!==null)return e.where==null&&e.spatialFilter==null?this._manualStat(e.stat,e.field,e.limit??1e3,e.abortSignal):{calculated:!1};let t=this._whereClause;e.where!=null&&this._whereClause!==null&&(t=j(this._whereClause,e.where));let n=await this._parent.queryStat({...e,where:t});return n.calculated?n:e.where==null&&e.spatialFilter==null?this._manualStat(e.stat,e.field,e.limit??1e3,e.abortSignal):{calculated:!1}}async canQueryAggregate(e){if(this._whereClauseFunction!==null)return!1;let t=e.where;return t==null?t=this._whereClause:this._whereClause!==null&&(t=j(this._whereClause,t)),this._parent.canQueryAggregate({...e,where:t})}async queryAggregate(e){let t=e.where;return t==null?t=this._whereClause:this._whereClause!==null&&(t=j(this._whereClause,t)),this._parent.queryAggregate({...e,where:t})}getFieldsIndex(){return this._parent.getFieldsIndex()}};function H(e){if(e.length===0)throw new A(`NeverReach`);let t=[];for(let n=0;n<e.length;n++){let r=e[n],i=[`"${r.name.replaceAll(`"`,`""`)}" ${r.asc?`>`:`<`} @last_${n}`];for(let t=0;t<n;t++){let n=e[t];i.push(`"${n.name.replaceAll(`"`,`""`)}" = @last_${t}`)}t.push(i.join(` AND `))}let n=t.join(` OR `);return D.create(n)}function U(e,t){e.clause??=H(e.keyFields);for(let n=0;n<e.keyFields.length;n++){let r=e.keyFields[n].name;e.clause.parameters[`last_${n}`]=t.attributes[r]}}var W=class t extends F{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.sources.FeatureLayerDynamic`,this._removeGeometry=!1,this._overrideFields=null,this._requestStandardised=!1,this._useDefinitionExpression=!0,this._recentlyUsedQueries=null,this._featureSetQueryInterceptor=null,this._featureSetInfo=null,this._maxProcessing=1e3,this._layer=e.layer,e.spatialReference&&(this.spatialReference=e.spatialReference),e.outFields!==void 0&&(this._overrideFields=e.outFields),e.includeGeometry!==void 0&&(this._removeGeometry=!1===e.includeGeometry),e.lrucache&&(this._recentlyUsedQueries=e.lrucache),e.interceptor&&(this._featureSetQueryInterceptor=e.interceptor)}_maxQueryRate(){return w}get urlQueryPath(){return this._layer.parsedUrl.path||``}convertQueryToLruCacheKey(e){let t=this.urlQueryPath+`,`+C(e.toJSON());return c(t,s.String)}async loadImpl(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}_initialiseFeatureSet(){if(this.spatialReference??=this._layer.spatialReference,this.geometryType=this._layer.geometryType??``,this.fields=this._layer.fields.slice(),this.hasZ=!0===this._layer.capabilities?.data?.supportsZ,this.hasM=!0===this._layer.capabilities?.data?.supportsM,this._overrideFields!==null)if(this._overrideFields.length===1&&this._overrideFields[0]===`*`)this._overrideFields=null;else{let e=new Set(this._overrideFields.map(e=>e.toLowerCase()));this.fields=this.fields.filter(({type:t,name:n})=>t===`oid`||e.has(n.toLowerCase())),this._overrideFields=this.fields.map(({name:e})=>e)}if(this._layer.source&&this._layer.source.sourceJSON){let e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=1,e!=null&&e>=10.61&&(this._databaseType=0)):e!=null&&(e>=10.5&&(this._databaseType=1,this._requestStandardised=!0),e>=10.61&&(this._databaseType=0))}this.objectIdField=this._layer.objectIdField;for(let e of this.fields)e.type===`global-id`&&(this.globalIdField=e.name);this.subtypeField=this._layer.subtypeField??``,this.subtypes=this._layer.subtypes,this.typeIdField=(`typeIdField`in this._layer?this._layer.typeIdField:null)??``,this.types=`types`in this._layer?this._layer.types:null}async _runDatabaseProbe(e){await this._ensureLoaded();let t=new p;this.datesInUnknownTimezone&&(t.timeReferenceUnknownClient=!0),t.where=e.replace(`OBJECTID`,this._layer.objectIdField);try{return await this._layer.queryObjectIds(t),!0}catch{return!1}}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion||`SDE.DEFAULT`:``}nativeCapabilities(){return{title:this._layer.title??``,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}async _queryAll(){return(await this.query({abortSignal:y})).features}async query(e){return await this._ensureLoaded(),this.isTable()&&e.spatialFilter!=null?P:this._canUsePagination()?this._queryUsingPaging(e):this._queryUsingIdSetTraversal(e)}async _queryUsingPaging(e){let t=``,n=!1;e.orderBy!=null&&!0===this._layer.capabilities?.query?.supportsOrderBy&&(t=e.orderBy.constructClause(),n=!0);let r=await this.databaseType(),a=e.where==null?e.spatialFilter==null?`1=1`:``:M(e.where,r),o=this._maxQueryRate(),s=this._layer.capabilities?.query.maxRecordCount;s!=null&&s<o&&(o=s);let c=!0!==this._removeGeometry,l=this._overrideFields??this._fieldsIncludingObjectId([`*`]),u=this._createQuery();return u.where=i(u.where,a),e.spatialFilter!=null&&(u.spatialRelationship=this._makeRelationshipEnum(e.spatialFilter.relation),u.relationParameter=this._makeRelationshipParam(e.spatialFilter.relation),u.geometry=e.spatialFilter.geometry),u.orderByFields=t===``?null:t.split(`,`),u.outFields=l,u.returnGeometry=c,u.outSpatialReference=this.spatialReference,{ordered:n,filterApplied:!0,spatialFilterApplied:!0,features:this._queryPaginated(u,o,e.abortSignal)}}async*_queryPaginated(e,t,n){let r;e.num=t,e.start=0;do k(n),r=await this.executeQuery(e,`execute`),yield r.features,e.start+=t;while(!0===r.exceededTransferLimit)}async _queryUsingIdSetTraversal(e){let t=``,n=!1;e.orderBy!=null&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(t=e.orderBy.constructClause(),n=!0);let r=await this.databaseType(),a=e.where==null?e.spatialFilter==null?`1=1`:``:M(e.where,r),o=this._createQuery();o.where=i(o.where,a),e.spatialFilter!=null&&(o.spatialRelationship=this._makeRelationshipEnum(e.spatialFilter.relation),o.relationParameter=this._makeRelationshipParam(e.spatialFilter.relation),o.geometry=e.spatialFilter.geometry),o.orderByFields=t===``?null:t.split(`,`),o.outSpatialReference=this.spatialReference;let s=await this.executeQuery(o,`executeForIds`);if(k(e.abortSignal),s==null||s.length<=0)return P;let c=this._maxQueryRate(),l=this._layer.capabilities?.query.maxRecordCount;l!=null&&l<c&&(c=l);let u=this._createQuery();return o.outFields=this._overrideFields??this._fieldsIncludingObjectId([`*`]),o.returnGeometry=!0!==this._removeGeometry,o.outSpatialReference=this.spatialReference,{ordered:n,filterApplied:!0,spatialFilterApplied:!0,features:this._traverseIdSet(u,s,c,e.abortSignal)}}async*_traverseIdSet(e,t,n,r){for(let i=0;i<t.length;i+=n)e.objectIds=t.slice(i,i+n),k(r),yield(await this.executeQuery(e,`execute`)).features}async queryStat(e){await this._ensureLoaded();let t=this._layer.capabilities?.query,n=!!t?.supportsSqlExpression,r=!!t?.supportsStatistics,a=!!t?.supportsDistinct,o=te(e.stat);if(o===`count`)return a?this._queryCount(e):{calculated:!1};let s=e.field;if(s==null)return{calculated:!1};if(!1===r||!1===L(s)&&!1===n||!1===s.isStandardized)return e.spatialFilter!=null||e.where!=null?{calculated:!1}:this._manualStat(e.stat,s,e.limit??1e3,e.abortSignal);if(o===`distinct`)return!1===a?e.spatialFilter!=null||e.where!=null?{calculated:!1}:this._manualStat(o,s,e.limit??1e3,e.abortSignal):{calculated:!1};let c=await this.databaseType();if(this.isTable()&&e.spatialFilter!=null)return{calculated:!0,result:null};let l=this._createQuery();l.where=i(l.where,e.where==null?e.spatialFilter==null?`1=1`:``:M(e.where,c)),e.spatialFilter!=null&&(l.spatialRelationship=this._makeRelationshipEnum(e.spatialFilter.relation),l.relationParameter=this._makeRelationshipParam(e.spatialFilter.relation),l.geometry=e.spatialFilter.geometry);let u=new d;u.statisticType=o,u.onStatisticField=M(s,c),u.outStatisticFieldName=`ARCADE_STAT_RESULT`,l.returnGeometry=!1;let f=`ARCADE_STAT_RESULT`;l.outStatistics=[u];let p=await this.executeQuery(l,`execute`);if(!p.hasOwnProperty(`features`)||p.features.length===0)throw new A(`InvalidStatResponse`);let m=!1,h=p.fields??[];for(let e of h)if(e.name.toUpperCase()===`ARCADE_STAT_RESULT`){f=e.name,e.type===`esriFieldTypeDate`&&(m=!0);break}let g=p.features[0].attributes[f];return{calculated:!0,result:m&&g!=null?new Date(g):g}}async _queryCount(e){let t=await this.databaseType();if(this.isTable()&&e.spatialFilter!=null)return{calculated:!0,result:0};let n=this._createQuery();return n.where=i(n.where,e.where==null?e.spatialFilter==null?`1=1`:``:M(e.where,t)),e.spatialFilter!=null&&(n.spatialRelationship=this._makeRelationshipEnum(e.spatialFilter.relation),n.relationParameter=this._makeRelationshipParam(e.spatialFilter.relation),n.geometry=e.spatialFilter.geometry),n.returnGeometry=!1,{calculated:!0,result:await this.executeQuery(n,`executeForCount`)}}async canQueryAggregate(e){await this._ensureLoaded();let t=!1,n=this._layer.capabilities?.query,r=!0===n?.supportsSqlExpression;if(n!=null&&!0===n.supportsStatistics&&!0===n.supportsOrderBy&&(t=!0),t)for(let n of e.statistics)(!1===n.workingexpr?.isStandardized||!1===L(n.workingexpr)&&!1===r)&&(t=!1);return t}async queryAggregate(e){if(await this._ensureLoaded(),this.isTable()&&e.spatialFilter!=null)return P;let t=await this.databaseType(),n=e.groupBy,r=e.orderBy,a=null;if(!this._layer.capabilities.query.supportsPaginationOnAggregatedQueries){let e=this.getFieldsIndex();a={keyFields:n.map((t,n)=>({name:e.normalizeFieldName(t)??t,asc:r==null||r._directions[n]===1}))}}let o=``,s=!1;r!=null&&!0===this._layer.capabilities?.query?.supportsOrderBy&&(a==null||m(n,0,n.length,r._fields,0,Math.min(r._fields.length,n.length),(e,t)=>e.toLowerCase()===t.toLowerCase()))&&(o=r.constructClause(),s=!0),o===``&&(o=n.join(`,`));let c=e.statistics.map(e=>new d({onStatisticField:e.workingexpr===null?``:M(e.workingexpr,t),outStatisticFieldName:e.field,statisticType:e.toStatisticsName()})),l=this._maxQueryRate(),u=this._layer.capabilities?.query.maxRecordCount;u!=null&&u<l&&(l=u);let f=e.where==null?e.spatialFilter==null?`1=1`:``:M(e.where,t),p=this._createQuery();return p.where=i(p.where,f),e.spatialFilter!=null&&(p.spatialRelationship=this._makeRelationshipEnum(e.spatialFilter.relation),p.relationParameter=this._makeRelationshipParam(e.spatialFilter.relation),p.geometry=e.spatialFilter.geometry),p.orderByFields=o===``?null:o.split(`,`),p.outFields=[`*`],p.outStatistics=c,p.groupByFieldsForStatistics=n,p.returnGeometry=!1,a==null?{filterApplied:!0,spatialFilterApplied:!0,ordered:s,features:this._queryPaginated(p,l,e.abortSignal)}:{filterApplied:!0,spatialFilterApplied:!0,ordered:s,features:this._queryKeysetPaginated(p,a,e.abortSignal)}}async*_queryKeysetPaginated(e,t,n){let r=e.where;for(;;){if(t.clause!=null){if(!this._layer.capabilities.query.supportsOrderBy)throw new A(`NotImplemented`);e.where=i(r,M(t.clause,await this.databaseType()))}let a=await this.executeQuery(e,`execute`);if(k(n),!a.hasOwnProperty(`features`))throw new A(`InvalidStatResponse`);if(yield a.features,a.features.length===0||!0!==a.exceededTransferLimit)break;U(t,a.features.at(-1))}}_createQuery(){let e=this._layer.createQuery();return e.returnZ=this.hasZ,e.returnM=this.hasM,this.datesInUnknownTimezone&&(e.timeReferenceUnknownClient=!0),this._requestStandardised&&(e.sqlFormat=`standard`),this._useDefinitionExpression?this._layer.type===`subtype-group`&&(e.where=this._layer.definitionExpression):e.where=null,e}executeQuery(e,t){let n=t===`execute`?async e=>{let t=await this._layer.source.queryFeaturesJSON(e);return I(t.features,t.spatialReference??this.spatialReference.toJSON()),t}:t===`executeForCount`?this._layer.queryFeatureCount.bind(this._layer):this._layer.queryObjectIds.bind(this._layer),r=null;if(this._recentlyUsedQueries){let t=this.convertQueryToLruCacheKey(e);r=this._recentlyUsedQueries.getFromCache(t),r===null&&(r=n(e),this._recentlyUsedQueries.addToCache(t,r),r=r.catch(e=>{throw this._recentlyUsedQueries?.removeFromCache(t),e}))}return this._featureSetQueryInterceptor&&this._featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),r===null&&(r=n(e)),r}_fieldsIncludingObjectId(e){if(e===null)return[this.objectIdField];let t=e.slice();if(t.includes(`*`))return t;let n=!1;for(let e of t)if(e.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return n||t.push(this.objectIdField),t}isTable(){return this._layer.isTable||this._layer.geometryType===null||this._layer.type===`table`||this._layer.geometryType===``||this._layer.geometryType===`esriGeometryNull`}_makeRelationshipEnum(e){if(e.includes(`esriSpatialRelRelation`))return`relation`;switch(e){case`esriSpatialRelRelation`:return`relation`;case`esriSpatialRelIntersects`:return`intersects`;case`esriSpatialRelContains`:return`contains`;case`esriSpatialRelOverlaps`:return`overlaps`;case`esriSpatialRelWithin`:return`within`;case`esriSpatialRelTouches`:return`touches`;case`esriSpatialRelCrosses`:return`crosses`;case`esriSpatialRelEnvelopeIntersects`:return`envelope-intersects`}return e}_makeRelationshipParam(e){return e.includes(`esriSpatialRelRelation`)?e.split(`:`)[1]:``}static create(e,n,r,i,a){let o=new u({url:e,outFields:n===null?[`*`]:n});return new t({layer:o,spatialReference:r,lrucache:i,interceptor:a})}relationshipMetadata(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON?.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return E(this._layer.parsedUrl.path)}async queryAttachments(t,n,r,i,a){function o(e){let t=e.capabilities;return t?.data.supportsAttachment&&t?.operations.supportsQueryAttachments}let s=this._layer;if(!o(s))return[];let c=new e({objectIds:[t],returnMetadata:a});(n&&n>0||r&&r>0)&&(c.size=[n&&n>0?n:0,r&&r>0?r:n+1]),i&&i.length>0&&(c.attachmentTypes=i),this._featureSetQueryInterceptor&&this._featureSetQueryInterceptor.preLayerQueryCallback({layer:s,query:c,method:`attachments`});let l=await s.queryAttachments(c);return l?.[t]?l[t].map(e=>{let n=`${this._layer.parsedUrl.path}/${t}/attachments/${e.id}`,r=null;return a&&e.exifInfo&&(r=ee.convertJsonToArcade(e.exifInfo,`system`,!0)),new O(e.id,e.name,e.contentType,e.size,n,r,e.keywords??null)}):[]}async queryRelatedFeatures(e){let t=z(e);t.f=`json`,this._requestStandardised&&(t.sqlFormat=`standard`),this._featureSetQueryInterceptor&&this._featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:t,method:`relatedrecords`,url:this._layer.parsedUrl.path+`/queryRelatedRecords`});let n=await o(this._layer.parsedUrl.path+`/queryRelatedRecords`,{responseType:`json`,query:t});if(n.data){let e={},t=n.data;if(t?.relatedRecordGroups){let n=t.spatialReference,r=!0===t.exceededTransferLimit;for(let i of t.relatedRecordGroups)I(i.relatedRecords,n),e[i.objectId]={features:i.relatedRecords,exceededTransferLimit:r}}return e}throw new A(`InvalidRequest`)}async getFeatureByObjectId(e,t){let n=this._createQuery();n.outFields=t,n.returnGeometry=!1,n.outSpatialReference=this.spatialReference,n.where=i(n.where,this.objectIdField+`=`+e.toString()),this._featureSetQueryInterceptor&&this._featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:n,method:`execute`});let r=await this._layer.source.queryFeaturesJSON(n);return r.features.length===1?(I(r.features,r.spatialReference??this.spatialReference.toJSON()),r.features[0]):null}async getIdentityUser(){await this.load();let e=l?.findCredential(this._layer.url);return e?e.userId:null}async getOwningSystemUrl(){await this.load();let e=l?.findServerInfo(this._layer.url);if(e)return e.owningSystemUrl??``;let t=this._layer.url,n=t.toLowerCase().indexOf(`/rest/services`);if(t=n>-1?t.slice(0,n):t,t){t+=`/rest/info`;try{let e=await o(t,{query:{f:`json`}}),n=``;return e.data?.owningSystemUrl&&(n=e.data.owningSystemUrl),n}catch{return``}}return``}getDataSourceFeatureSet(){let e=new t({layer:this._layer,spatialReference:this.spatialReference??void 0,outFields:this._overrideFields??void 0,includeGeometry:!this._removeGeometry,lrucache:this._recentlyUsedQueries??void 0,interceptor:this._featureSetQueryInterceptor??void 0});return e._useDefinitionExpression=!1,e}get preferredTimeZone(){return this._layer.preferredTimeZone??null}get dateFieldsTimeZone(){return this._layer.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._layer.datesInUnknownTimezone??!1}get editFieldsInfo(){return this._layer.editFieldsInfo??null}get timeInfo(){return this._layer.timeInfo??null}async getFeatureSetInfo(){if(this._featureSetInfo)return this._featureSetInfo;let e=null,t=`serviceItemId`in this._layer?this._layer.serviceItemId:null,n=this._layer.parsedUrl?.path??null;if(n){let r=await o(n,{responseType:`json`,query:{f:`json`}});e=r?.data?.name??null,t=r?.data?.serviceItemId??null}let r=this._layer.title&&(this._layer.parent??null)!==null;return this._featureSetInfo={layerId:this._layer.layerId,layerName:e===``?null:e,itemId:t===``?null:t,serviceLayerUrl:n===``?null:n,webMapLayerId:r?this._layer.id??null:null,webMapLayerTitle:r?this._layer.title??null:null,className:null,objectClassId:null},this._featureSetInfo}},G=class e extends F{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.sources.FeatureLayerMemory`,this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,this._maxProcessing=1e3,this._layer=e.layer,e.spatialReference&&(this.spatialReference=e.spatialReference),!0===e.isTable&&(this._forceIsTable=!0),e.outFields!==void 0&&(this._overrideFields=e.outFields),e.includeGeometry!==void 0&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return w}async loadImpl(){return!0===this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}get gdbVersion(){return``}_initialiseFeatureSet(){if(this.spatialReference??=this._layer.spatialReference,this.geometryType=this._layer.geometryType??``,this.fields=this._layer.fields.slice(),this._overrideFields!==null)if(this._overrideFields.length===1&&this._overrideFields[0]===`*`)this._overrideFields=null;else{let e=new Set(this._overrideFields.map(e=>e.toLowerCase()));this.fields=this.fields.filter(({type:t,name:n})=>t===`oid`||this._layer.objectIdField===n||e.has(n.toLowerCase())),this._overrideFields=this.fields.map(({name:e})=>e)}this.objectIdField=this._layer.objectIdField;for(let e of this.fields)e.type===`global-id`&&(this.globalIdField=e.name);this._databaseType=0,this.hasZ=!0===this._layer.capabilities?.data?.supportsZ,this.hasM=!0===this._layer.capabilities?.data?.supportsM,this.subtypeField=(`subtypeField`in this._layer?this._layer.subtypeField:null)??``,this.subtypes=`subtypes`in this._layer?this._layer.subtypes:null,this.typeIdField=(`typeIdField`in this._layer?this._layer.typeIdField:null)??``,this.types=`types`in this._layer?this._layer.types:null}isTable(){return this._forceIsTable||`isTable`in this._layer&&this._layer.isTable||this._layer.type===`table`||!this._layer.geometryType}async _queryAll(){return(await this.query({abortSignal:y})).features}_queryLayerFeaturesJSON(e){return`queryFeaturesJSON`in this._layer?this._layer.queryFeaturesJSON(e):this._layer.source.queryFeaturesJSON(e)}async query(e){await this._ensureLoaded();let t=``,n=!1;if(e.orderBy!=null&&(t=e.orderBy.constructClause(),n=!0),this.isTable()&&e.spatialFilter!=null)return P;let r=this._createQuery();return r.where=i(r.where,e.where==null?e.spatialFilter==null?`1=1`:``:M(e.where,0)),e.spatialFilter!=null&&(r.spatialRelationship=this._makeRelationshipEnum(e.spatialFilter.relation),r.relationParameter=this._makeRelationshipParam(e.spatialFilter.relation),r.geometry=e.spatialFilter.geometry),r.outSpatialReference=this.spatialReference,r.orderByFields=t===``?null:t.split(`,`),{filterApplied:!0,spatialFilterApplied:!0,ordered:n,features:async function*(){let t=await this._queryLayerFeaturesJSON(r);k(e.abortSignal);for(let e of f(t.features,this._maxQueryRate()))I(e,t.spatialReference??this.spatialReference.toJSON()),yield e}.apply(this)}}async queryStat(e){return{calculated:!1}}async canQueryAggregate(e){return!1}async queryAggregate(e){throw new A(`NeverReach`)}_createQuery(){let e=this._layer.createQuery();return e.returnZ=this.hasZ,e.returnM=this.hasM,e.outFields=this._overrideFields??[`*`],e.returnGeometry=!this._removeGeometry,e}_makeRelationshipEnum(e){if(e.includes(`esriSpatialRelRelation`))return`relation`;switch(e){case`esriSpatialRelRelation`:return`relation`;case`esriSpatialRelIntersects`:return`intersects`;case`esriSpatialRelContains`:return`contains`;case`esriSpatialRelOverlaps`:return`overlaps`;case`esriSpatialRelWithin`:return`within`;case`esriSpatialRelTouches`:return`touches`;case`esriSpatialRelCrosses`:return`crosses`;case`esriSpatialRelEnvelopeIntersects`:return`envelope-intersects`}return e}_makeRelationshipParam(e){return e.includes(`esriSpatialRelRelation`)?e.split(`:`)[1]:``}relationshipMetadata(){return[]}nativeCapabilities(){return{title:this._layer.title??``,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(n,r){let i=n.layerDefinition.objectIdField,a=n.layerDefinition.typeIdField??``,o=[];if(n.layerDefinition.types)for(let e of n.layerDefinition.types)o.push(_.fromJSON(e));let s=n.layerDefinition.geometryType;s===void 0&&(s=n.featureSet.geometryType||``);let c=n.featureSet.features;if(!i){let e=!1;for(let t of n.layerDefinition.fields)if(t.type===`oid`||t.type===`esriFieldTypeOID`){i=t.name,e=!0;break}if(!1===e){let e=`FID`,t=!0,r=0;for(;t;){let i=!0;for(let t of n.layerDefinition.fields)if(t.name===e){i=!1;break}!0===i?t=!1:(r++,e=`FID`+r.toString())}n.layerDefinition.fields.push({type:`esriFieldTypeOID`,name:e,alias:e});let a=[];for(let t=0;t<c.length;t++)a.push({geometry:n.featureSet.features[t].geometry,attributes:{...n.featureSet.features[t].attributes,[e]:t}});c=a,i=e}}let l=[];for(let e of n.layerDefinition.fields)e instanceof h?l.push(e):l.push(h.fromJSON(e));let d=s;switch(d||=``,d){case`esriGeometryPoint`:d=`point`;break;case`esriGeometryPolyline`:d=`polyline`;break;case`esriGeometryPolygon`:d=`polygon`;break;case`esriGeometryEnvelope`:d=`extent`;break;case`esriGeometryMultipoint`:d=`multipoint`;break;case``:case`esriGeometryNull`:d=`esriGeometryNull`}if(d!==`esriGeometryNull`){let e=r.toJSON();for(let n of c)n.geometry&&n.geometry instanceof t==0&&(n.geometry.type=d,n.geometry.spatialReference===void 0&&(n.geometry.spatialReference=e))}else for(let e of c)e.geometry&&=null;let f={outFields:[`*`],source:c,fields:l,hasZ:!0===n.layerDefinition.hasZ||!0===n.featureSet.hasZ,hasM:!0===n.layerDefinition.hasM||!0===n.featureSet.hasM,types:o,typeIdField:a,objectIdField:i,spatialReference:r},p=d===`esriGeometryNull`||d===null;p||(f.geometryType=d);let m=new u(f);return n.layerDefinition.subtypeField&&n.layerDefinition.subtypes&&m.read({subtypes:n.layerDefinition.subtypes,subtypeField:n.layerDefinition.subtypeField}),new e({layer:m,spatialReference:r,isTable:p})}async queryAttachments(){return[]}async getFeatureByObjectId(e){let t=this._createQuery();t.where=this.objectIdField+`=`+e.toString();let n=await this._queryLayerFeaturesJSON(t);return n.features.length===1?(I(n.features,n.spatialReference??this.spatialReference.toJSON()),n.features[0]):null}serviceUrl(){return``}async getOwningSystemUrl(){return``}async getIdentityUser(){return``}get preferredTimeZone(){return`preferredTimeZone`in this._layer?this._layer.preferredTimeZone:null}get dateFieldsTimeZone(){return`dateFieldsTimeZone`in this._layer?this._layer.dateFieldsTimeZone:null}get datesInUnknownTimezone(){return`datesInUnknownTimezone`in this._layer&&this._layer.datesInUnknownTimezone}get editFieldsInfo(){return`editFieldsInfo`in this._layer?this._layer.editFieldsInfo:null}get timeInfo(){return this._layer.timeInfo}async getFeatureSetInfo(){let e=this._layer.title&&this._layer.parent;return{layerId:null,layerName:null,itemId:null,serviceLayerUrl:null,webMapLayerId:e?this._layer.id??null:null,webMapLayerTitle:e?this._layer.title??null:null,className:null,objectClassId:null}}},K=class extends F{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.sources.FeatureLayerOGC`,this._outFields=null,this._returnGeometry=!0,this._layer=e.layer,e.spatialReference&&(this.spatialReference=e.spatialReference),e.outFields!=null&&(this._outFields=e.outFields),e.includeGeometry!=null&&(this._returnGeometry=e.includeGeometry)}_maxQueryRate(){return this._layer.effectiveMaxRecordCount}async loadImpl(){return this._layer.loaded?(this._initialiseFeatureSet(),this):(await this._layer.load(),this._initialiseFeatureSet(),this)}_initialiseFeatureSet(){if(this.spatialReference??=this._layer.spatialReference,this.geometryType=this._layer.geometryType??``,this.fields=this._layer.fields.slice(),this._outFields!=null)if(this._outFields.length===1&&this._outFields[0]===`*`)this._outFields=null;else{let e=new Set(this._outFields.map(e=>e.toLowerCase()));this.fields=this.fields.filter(({name:t})=>t===this._layer.objectIdField||e.has(t.toLowerCase())),this._outFields=this.fields.map(({name:e})=>e)}this.objectIdField=this._layer.objectIdField,this.hasZ=!!this._layer.hasZ,this.hasM=!1,this.typeIdField=this._layer.typeIdField??``,this.types=this._layer.types??null;let e=this._layer.source.getSource().layerDefinition.featureCount;e!=null&&e>=0&&(this._totalCount=e)}isTable(){return this._layer.isTable}async _queryAll(){await this._ensureLoaded();let e=this._layer.createQuery();return e.outSpatialReference=this.spatialReference,this._queryPaginated(e,this._layer.effectiveMaxRecordCount,y)}async query(e){await this._ensureLoaded();let t=this._layer.createQuery();if(t.outSpatialReference=this.spatialReference,e.spatialFilter!=null&&!g(e.spatialFilter.geometry))switch(e.spatialFilter.relation){case`esriSpatialRelIntersects`:case`esriSpatialRelContains`:case`esriSpatialRelOverlaps`:case`esriSpatialRelWithin`:case`esriSpatialRelTouches`:case`esriSpatialRelCrosses`:t.geometry=e.spatialFilter.geometry.extent}return this._hasCachedFeatures||t.geometry==null?{filterApplied:e.where==null,spatialFilterApplied:e.spatialFilter==null,ordered:!1,features:await this.queryAll(e.abortSignal)}:{filterApplied:e.where==null,spatialFilterApplied:e.spatialFilter==null||e.spatialFilter.geometry.type===`extent`&&e.spatialFilter.relation===`esriSpatialRelIntersects`,ordered:!1,features:this._queryPaginated(t,this._layer.effectiveMaxRecordCount,e.abortSignal)}}async*_queryPaginated(e,t,n){let r;e.num=t,e.start=0;do{k(n),r=await this._layer.source.queryFeaturesJSON(e);let t=r.spatialReference??this.spatialReference.toJSON();yield r.features.map(e=>{let n={};for(let t of this.fields)n[t.name]=e.attributes[t.name];let r=null;return this._returnGeometry&&!this.isTable()&&e.geometry!=null&&(e.geometry.spatialReference=t,r=e.geometry),{geometry:r,attributes:n}}),e.start+=r.features.length}while(!0===r.exceededTransferLimit)}async queryStat(e){return{calculated:!1}}async canQueryAggregate(e){return!1}async queryAggregate(e){throw new A(`NeverReach`)}nativeCapabilities(){return{title:this._layer.title??``,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}async queryAttachments(){return[]}serviceUrl(){return``}relationshipMetadata(){return[]}get gdbVersion(){return``}getFeatureByObjectId(){throw new A(`NeverReach`)}async getOwningSystemUrl(){return``}async getIdentityUser(){return``}get preferredTimeZone(){return null}get dateFieldsTimeZone(){return null}get datesInUnknownTimezone(){return!1}get editFieldsInfo(){return null}get timeInfo(){return this._layer.timeInfo}async getFeatureSetInfo(){let e=this._layer.title&&this._layer.parent;return{layerId:null,layerName:null,itemId:null,serviceLayerUrl:null,webMapLayerId:e?this._layer.id??null:null,webMapLayerTitle:e?this._layer.title??null:null,className:null,objectClassId:null}}},q=class extends F{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.sources.FeatureLayerRelated`,this._removeGeometry=!1,this._overrideFields=null,this._maxProcessing=1e3,this._layer=e.layer,e.spatialReference&&(this.spatialReference=e.spatialReference),this._findObjectId=e.objectId,this.relationship=e.relationship,this._relatedLayer=e.relatedLayer,e.outFields!==void 0&&(this._overrideFields=e.outFields),e.includeGeometry!==void 0&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return w}async loadImpl(){return await Promise.all([this._layer.load(),this._relatedLayer.load()]),this._initialiseFeatureSet(),this}nativeCapabilities(){return this._relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(this.spatialReference??=this._layer.spatialReference,this.geometryType=this._relatedLayer.geometryType,this.fields=this._relatedLayer.fields.slice(),this.hasZ=this._relatedLayer.hasZ,this.hasM=this._relatedLayer.hasM,this._overrideFields!==null)if(this._overrideFields.length===1&&this._overrideFields[0]===`*`)this._overrideFields=null;else{let e=new Set(this._overrideFields.map(e=>e.toLowerCase()));this.fields=this.fields.filter(({type:t,name:n})=>t===`oid`||e.has(n.toLowerCase())),this._overrideFields=this.fields.map(({name:e})=>e)}let e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType),this.objectIdField=this._relatedLayer.objectIdField,this.globalIdField=this._relatedLayer.globalIdField,this.hasM=this._relatedLayer.supportsM,this.hasZ=this._relatedLayer.supportsZ,this.typeIdField=this._relatedLayer.typeIdField,this.types=this._relatedLayer.types,this.subtypeField=this._relatedLayer.subtypeField,this.subtypes=this._relatedLayer.subtypes}async databaseType(){return this._databaseType=await this._relatedLayer.databaseType(),this._databaseType}isTable(){return this._relatedLayer.isTable()}async _queryAll(){return(await this.query({abortSignal:y})).features}async query(e){if(await this._ensureLoaded(),await this.databaseType(),this.isTable()&&e.spatialFilter!=null)return P;let t=this._layer.nativeCapabilities();if(!1===t.canQueryRelated)return P;if(t.capabilities?.queryRelated.supportsPagination)return this._queryUsingPaging(t.source,e);let n=``,r=!1;e.orderBy!=null&&!0===t.capabilities?.queryRelated.supportsOrderBy&&(n=e.orderBy.constructClause(),r=!0);let i=new a;return i.objectIds=[this._findObjectId],i.outFields=this._overrideFields===null?this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map(e=>e.name):[`*`]):this._overrideFields,i.relationshipId=this.relationship.id,i.where=`1=1`,i.returnGeometry=!0!==this._removeGeometry,i.outSpatialReference=this.spatialReference,i.orderByFields=n===``?null:n.split(`,`),{filterApplied:e.where==null,spatialFilterApplied:e.spatialFilter==null,ordered:r,features:async function*(){let n=await t.source.queryRelatedFeatures(i);k(e.abortSignal),yield n[this._findObjectId]?n[this._findObjectId].features:[]}.apply(this)}}async _queryUsingPaging(e,t){let n=``,r=!1,i=this._layer.nativeCapabilities();t.orderBy!=null&&!0===i.capabilities?.queryRelated.supportsOrderBy&&(n=t.orderBy.constructClause(),r=!0),await this.databaseType();let o=this._maxQueryRate(),s=i.capabilities?.query.maxRecordCount;s!=null&&s<o&&(o=s);let c=new a;return c.relationshipId=this.relationship.id,c.objectIds=[this._findObjectId],c.outFields=this._overrideFields===null?this._fieldsIncludingObjectId(this._relatedLayer.fields?this._relatedLayer.fields.map(e=>e.name):[`*`]):this._overrideFields,c.where=`1=1`,c.orderByFields=n===``?null:n.split(`,`),c.returnGeometry=!0!==this._removeGeometry,c.outSpatialReference=this.spatialReference,{filterApplied:t.where==null,spatialFilterApplied:t.spatialFilter==null,ordered:r,features:this._queryPaginated(e,c,o,t.abortSignal)}}async*_queryPaginated(e,t,n,r){let i;t.num=n,t.start=0;do k(r),i=(await e.queryRelatedFeatures(t))[this._findObjectId]??{exceededTransferLimit:!1,features:[]},yield i.features,t.start+=n;while(!0===i.exceededTransferLimit)}async queryStat(e){return{calculated:!1}}async canQueryAggregate(e){return!1}async queryAggregate(e){throw new A(`NeverReach`)}_fieldsIncludingObjectId(e){if(e===null)return[this.objectIdField];let t=e.slice();if(t.includes(`*`))return t;let n=!1;for(let e of t)if(e.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return n||t.push(this.objectIdField),t}get gdbVersion(){return this._relatedLayer.gdbVersion}relationshipMetadata(){return this._relatedLayer.relationshipMetadata()}serviceUrl(){return this._relatedLayer.serviceUrl()}queryAttachments(e,t,n,r,i){return this._relatedLayer.queryAttachments(e,t,n,r,i)}getFeatureByObjectId(e,t){return this._relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this._relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this._relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this._relatedLayer}get preferredTimeZone(){return this._relatedLayer.preferredTimeZone??null}get dateFieldsTimeZone(){return this._relatedLayer.dateFieldsTimeZone??null}get datesInUnknownTimezone(){return this._relatedLayer.datesInUnknownTimezone}get editFieldsInfo(){return this._relatedLayer.editFieldsInfo??null}get timeInfo(){return this._relatedLayer.timeInfo??null}getFeatureSetInfo(){return this._relatedLayer.getFeatureSetInfo()}};function J(){R.applicationCache===null&&(R.applicationCache=new R)}async function Y(e,t,n){if(R.applicationCache){let n=R.applicationCache.getLayerInfo(e);if(n){let r=await n;return new u({url:e,outFields:t,sourceJSON:r})}let r=new u({url:e,outFields:t}),i=(async()=>(await r.load(),r.sourceJSON))();if(R.applicationCache){R.applicationCache.setLayerInfo(e,i);try{return await i,r}catch(t){throw R.applicationCache.clearLayerInfo(e),t}}return await i,r}if(n!=null){let r=n.getCachedLayerMetadata(e);if(r){let n=await r;return new u({url:e,outFields:t,sourceJSON:n})}let i=new u({url:e,outFields:t}),a=(async()=>(await i.load(),i.sourceJSON))();n.setCachedLayerMetadata(e,a);try{return await a,i}catch(t){throw n.removeCachedLayerMetadata(e,a),t}}return new u({url:e,outFields:t})}async function X(e,t,n,r,i,a=null){return Z(await Y(e,[`*`],i),t,n,r,i,a)}function Z(e,t=null,n=null,r=!0,i=null,a=null){switch(e.type){case`catalog-footprint`:return Z(e.parent,t,n,r,i,a);case`subtype-sublayer`:{let o=Z(e.parent,t,n,r,i,a);return new V({parentfeatureset:o,whereclause:D.create(e.parent.subtypeField+`=`+e.subtypeCode.toString(),{fieldsIndex:e.parent.fieldsIndex,timeZone:o.dateFieldsTimeZoneDefaultUTC})})}case`csv`:case`geojson`:case`knowledge-graph-sublayer`:case`wfs`:return new G({layer:e,spatialReference:t,outFields:n,includeGeometry:r,lrucache:i,interceptor:a});case`catalog`:case`feature`:case`oriented-imagery`:case`subtype-group`:{let o={layer:e,spatialReference:t,outFields:n,includeGeometry:r,lrucache:i,interceptor:a};return!e.url&&e.source?new G(o):new W(o)}case`ogc-feature`:return new K({layer:e,spatialReference:t,outFields:n,includeGeometry:r});default:throw Error(`Unsupported layer type: ${e.type}`)}}async function ne(e){if(R.applicationCache!==null){let t=R.applicationCache.getLayerInfo(e);if(t!==null)return t}let t=(async()=>{let t=await o(e,{responseType:`json`,query:{f:`json`}});return t.data?t.data:null})();if(R.applicationCache!==null){R.applicationCache.setLayerInfo(e,t);try{return await t}catch(t){throw R.applicationCache.clearLayerInfo(e),t}}return t}async function re(e,t){let n=`QUERYDATAELEMTS:`+t.toString()+`:`+e;if(R.applicationCache!==null){let e=R.applicationCache.getLayerInfo(n);if(e!==null)return e}let r=(async()=>{let n=await o(e+`/queryDataElements`,{method:`post`,responseType:`json`,query:{layers:JSON.stringify([t.toString()]),f:`json`}});if(n.data){let e=n.data;if(e.layerDataElements?.[0])return e.layerDataElements[0]}throw new A(`DataElementsNotFound`)})();if(R.applicationCache!==null){R.applicationCache.setLayerInfo(n,r);try{return await r}catch(e){throw R.applicationCache.clearLayerInfo(n),e}}return r}async function Q(e,t){if(R.applicationCache!==null){let t=R.applicationCache.getLayerInfo(e);if(t!==null)return t}if(t!=null){let n=t.getCachedServiceMetadata(e);if(n!=null)return n}let n=(async()=>{let t=await o(e,{responseType:`json`,query:{f:`json`},authMode:`no-prompt`});if(t.data){let e=t.data;return e.layers||=[],e.tables||=[],e}return{layers:[],tables:[]}})();if(R.applicationCache!==null){R.applicationCache.setLayerInfo(e,n);try{return await n}catch(t){throw R.applicationCache.clearLayerInfo(e),t}}if(t!=null){t.setCachedServiceMetadata(e,n);try{return await n}catch(r){throw t.removeCachedServiceMetadata(e,n),r}}return n}async function ie(e,t,n){let r={metadata:null,networkId:-1,unVersion:3,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map,queryelem:null,layerNameLkp:{},lkp:null},i=await Q(e,null);if(r.metadata=i,i.controllerDatasetLayers?.utilityNetworkLayerId!==void 0&&i.controllerDatasetLayers.utilityNetworkLayerId!==null){if(i.layers)for(let e of i.layers)r.layerNameLkp[e.id]=e.name;if(i.tables)for(let e of i.tables)r.layerNameLkp[e.id]=e.name;let a=i.controllerDatasetLayers.utilityNetworkLayerId;r.networkId=a;let o=await re(e,a);if(o){r.queryelem=o,r.queryelem?.dataElement&&r.queryelem.dataElement.schemaGeneration!==void 0&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);for(let e of r.queryelem.dataElement.domainNetworks){for(let t of e.edgeSources??[]){let e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]??null};r.layerIdLookup.set(e.layerId,e),r.sourceIdLookup.set(e.sourceId,e),e.className&&(r.lkp[e.className]=e)}for(let t of e.junctionSources??[]){let e={layerId:t.layerId,sourceId:t.sourceId,className:r.layerNameLkp[t.layerId]??null};r.layerIdLookup.set(e.layerId,e),r.sourceIdLookup.set(e.sourceId,e),e.className&&(r.lkp[e.className]=e)}}if(r.queryelem.dataElement.terminalConfigurations)for(let e of r.queryelem.dataElement.terminalConfigurations)for(let t of e.terminals)r.terminals.push({terminalId:t.terminalId,terminalName:t.terminalName});let i=await ne(e+`/`+a);if(i.systemLayers?.associationsTableId!==void 0&&i.systemLayers.associationsTableId!==null){let a=null;if(n&&r.unVersion<8){let n=[];r.unVersion>=4&&(n.push(`STATUS`),n.push(`PERCENTALONG`)),a=await X(e+`/`+i.systemLayers.associationsTableId,t,[`OBJECTID`,`FROMNETWORKSOURCEID`,`TONETWORKSOURCEID`,`FROMGLOBALID`,`TOGLOBALID`,`TOTERMINALID`,`FROMTERMINALID`,`ASSOCIATIONTYPE`,`ISCONTENTVISIBLE`,`GLOBALID`,...n],!1,null,null),await a.load(),r.unVersion>=4&&(a=new V({parentfeatureset:a,whereclause:D.create(`STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62, 63)`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})}),await a.load())}return{lkp:r.lkp,associations:a,unVersion:r.unVersion,terminals:r.terminals,layerIdLookup:r.layerIdLookup,sourceIdLookup:r.sourceIdLookup}}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map}}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map}}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[],layerIdLookup:new Map,sourceIdLookup:new Map}}async function ae(e,t,n,r=null,i=null,a=!0,o=null,s=null){let c=e.serviceUrl();if(!c)return null;c=c.endsWith(`/`)?c+t.relatedTableId.toString():c+`/`+t.relatedTableId.toString();let l=await X(c,r,i,a,o,s);return new q({layer:e,relatedLayer:l,relationship:t,objectId:n,spatialReference:r,outFields:i,includeGeometry:a,lrucache:o,interceptor:s})}var oe=class extends B{constructor(e,t=null,n=null,r=null){super(),this._map=e,this._overrideSpatialReference=t,this._lrucache=n,this._interceptor=r,this._instantLayers=[]}_makeAndAddFeatureSet(e,t=!0,n=null){let r=Z(e,this._overrideSpatialReference,n===null?[`*`]:n,t,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}async featureSetByName(e,t=!0,n=null){if(v(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetByName(e,t,n);n===null&&(n=[`*`]),n=(n=n.slice()).sort();let r=JSON.stringify(n);for(let n=0;n<this._instantLayers.length;n++){let i=this._instantLayers[n];if(i.opitem.title===e&&i.includeGeometry===t&&i.outFields===r)return this._instantLayers[n].featureset}let i=this._map.allLayers.find(t=>T(t)&&t.title===e);if(i!=null)return this._makeAndAddFeatureSet(i,t,n);if(this._map.allTables){let r=this._map.allTables.find(t=>T(t)&&t.title===e);if(r!=null)return this._makeAndAddFeatureSet(r,t,n)}return null}async featureSetById(e,t=!0,n=[`*`]){if(v(this._map)&&!this._map.loaded)return await this._map.load(),this.featureSetById(e,t,n);n===null&&(n=[`*`]),n=(n=n.slice()).sort();let r=JSON.stringify(n);for(let n=0;n<this._instantLayers.length;n++){let i=this._instantLayers[n];if(i.opitem.id===e&&i.includeGeometry===t&&i.outFields===r)return this._instantLayers[n].featureset}let i=this._map.allLayers.find(t=>T(t)&&t.id===e);if(i)return this._makeAndAddFeatureSet(i,t,n);if(this._map.allTables){let r=this._map.allTables.find(t=>T(t)&&t.id===e);if(r!=null)return this._makeAndAddFeatureSet(r,t,n)}return null}},se=class e extends B{constructor(e,t=null,n=null,r=null){super(),this._url=e,this._overrideSpatialReference=t,this._lrucache=n,this._interceptor=r,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(e,t=!0,n=null){let r=Z(e,this._overrideSpatialReference,n===null?[`*`]:n,t,this._lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}async _loadMetaData(){let e=await Q(this._url,this._lrucache);return this.metadata=e,e}load(){return this._loadMetaData()}clone(){return new e(this._url,this._overrideSpatialReference,this._lrucache,this._interceptor)}async featureSetByName(e,t=!0,n=null){n===null&&(n=[`*`]),n=(n=n.slice()).sort();let r=JSON.stringify(n);for(let n=0;n<this._instantLayers.length;n++){let i=this._instantLayers[n];if(i.opitem.title===e&&i.includeGeometry===t&&i.outFields===r)return this._instantLayers[n].featureset}let i=await this._loadMetaData(),a=null;for(let t of i.layers??[])t.name===e&&(a=t);if(!a)for(let t of i.tables??[])t.name===e&&(a=t);if(a){let e=await Y(this._url+`/`+a.id,[`*`],this._lrucache);return this._makeAndAddFeatureSet(e,t,n)}return null}async featureSetById(e,t=!0,n=[`*`]){n===null&&(n=[`*`]),n=(n=n.slice()).sort();let r=JSON.stringify(n);e=e==null?``:e.toString();for(let n=0;n<this._instantLayers.length;n++){let i=this._instantLayers[n];if(i.opitem.id===e&&i.includeGeometry===t&&i.outFields===r)return this._instantLayers[n].featureset}let i=await this._loadMetaData(),a=null;for(let t of i.layers??[])t.id!==null&&t.id!==void 0&&t.id.toString()===e&&(a=t);if(!a)for(let t of i.tables??[])t.id!==null&&t.id!==void 0&&t.id.toString()===e&&(a=t);if(a){let e=await Y(this._url+`/`+a.id,[`*`],this._lrucache);return this._makeAndAddFeatureSet(e,t,n)}return null}};function ce(e,t,n=null,r=null){return new oe(e,t,n,r)}function le(e,t,n=null,r=null){return new se(e,t,n,r)}function ue(e,t,r,i,a){if(e===null)return null;if(x(e)){switch(t){case`datasource`:return e.getDataSourceFeatureSet();case`parent`:return e;case`root`:return e.getRootFeatureSet()}return null}if(e instanceof n&&S(e)){let n=e;switch(t){case`datasource`:return Z(n,a,`outFields`in n?n.outFields:null,!0,r,i).getDataSourceFeatureSet();case`parent`:case`root`:return Z(n,a,`outFields`in n?n.outFields:null,!0,r,i)}return null}if(b(e)){switch(t){case`datasource`:return Z(e.parent,a,e.parent.outFields,!0,r,i).getDataSourceFeatureSet();case`parent`:case`root`:return Z(e,a,e.parent.outFields,!0,r,i)}return null}return null}async function de(e,t,n,i,a,o,s,c=null){if(R.applicationCache){let r=R.applicationCache.getLayerInfo(e+`:`+o.url);if(r)return $(await r,t,n,i,a,s,c)}if(s!=null){let r=s.getCachedPortalItem(o.url,e);if(r!=null)return await $(await r,t,n,i,a,s,c)}let l=new r({id:e,portal:o}).load();R.applicationCache?R.applicationCache.setLayerInfo(e+`:`+o.url,l):s?.setCachedPortalItem(o.url,e,l);try{return await $(await l,t,n,i,a,s,c)}catch(t){throw R.applicationCache&&R.applicationCache.clearLayerInfo(e+`:`+o.url),s?.removeCachedPortalItem(o.url,e,l),t}}async function $(e,t,r,i,a,o,s){let c;if(e.type===`Feature Service`||e.type===`Map Service`)c=await Y(E(e.url??``)+`/`+t,[`*`],o);else{if(t)throw Error(`layerId=${t} provided for ${e.type} item`);if(o!=null){let t=o.getCachedPortalItemLayer(e.portal.url,e.id);if(t!=null)c=await t;else{let t=n.fromPortalItem(e);o.setCachedPortalItemLayer(e.portal.url,e.id,t);try{c=await t}catch(n){throw o.removeCachedPortalItemLayer(e.portal.url,e.id,t),n}}}else c=await n.fromPortalItem(e)}return Z(c,r,i,a,o,s)}export{le as a,X as c,V as d,J as i,de as l,ue as n,ie as o,ce as r,ae as s,Z as t,G as u};