import{$T as e,AS as t,Bp as n,CE as r,DS as i,En as a,Gp as o,JC as s,Jg as c,LS as l,Lx as u,Sg as d,ZS as f,Z_ as p,cm as m,jx as h,kC as g,oT as _,zp as v}from"./index-BN8X5Ryz.js";import{t as y}from"./number-bRvGjlJj.js";import"./memoryEstimations-D_IbKyOk.js";import{t as b}from"./OptimizedGeometry-BQJ7w5VU.js";import{n as x}from"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import"./WhereClause-CATd9kVz.js";import"./closestPointOnCurve-CwZL45U3.js";import"./WhereClauseCache-BO4WYMj9.js";import"./PooledRBush-BH7_Gu1G.js";import"./QueryEngineCapabilities-CxeEdoTy.js";import{r as S,t as C}from"./clientSideDefaults-Iizf0eUh.js";import"./generateRendererUtils-DGV_dTnd.js";import"./utils-DCGMUq-q.js";import"./BoundsStore-DE7p6f_c.js";import"./timeSupport-vK4lVcYW.js";import"./optimizedFeatureQueryEngineAdapter-DQyaY_b1.js";import{t as w}from"./FeatureStore-DxVA8hqB.js";import{t as T}from"./QueryEngine-CD8WljsT.js";import{c as E}from"./queryUtils-DGU5ISbw.js";import"./utils-Bftaersa.js";import"./utils-BizEctJo.js";import"./SnappingCandidate-4DPnOY6Y.js";import"./FixedIntervalBinParameters-CMgMaWGN.js";import{n as D,t as O}from"./date-DluEMNTt.js";import{t as k}from"./locationUtils-DIRJcjU5.js";var A=/^\s*"([\S\s]*)"\s*$/,j=/""/g,M=`
`,N=[`,`,` `,`;`,`|`,`	`];function*P(e,t,n){let r=0;for(;r<=e.length;){let i=e.indexOf(t,r),a=e.slice(r,i>-1?i:void 0);r+=a.length+t.length,n&&!a.trim()||(yield a)}}function F(e){let t=e.includes(`\r
`)?`\r
`:M;return P(e,t,!0)}function I(e,t){return P(e,t,!1)}function L(e,t,n){e=e.trim(),t=t?.trim();let r=[],i=Array.from(new Set([n?.delimiter,...N])).filter(e=>e!=null);for(let n of i){let i=B(e,n).length,a=B(t,n).length??i;i>1&&r.push({weight:Math.min(i,a),delimiter:n})}let a=r.sort(({weight:e},{weight:t})=>t-e).map(({delimiter:e})=>e);for(let t of a){let r=z(e,t).names,i=k(r,n?.longitudeField,n?.latitudeField);if(i.longitudeFieldName&&i.latitudeFieldName)return{delimiter:t,locationInfo:i}}return{delimiter:a[0],locationInfo:null}}function*R(e,t,n,r=()=>Object.create(null)){let i=F(e);i.next();let a=``,o=``,s=0,c=r(),l=0;e:for(let e of i){let i=I(e,n);for(let e of i)if(a+=o+e,o=``,s+=V(e),s%2==0){if(s>0){let e=A.exec(a);if(!e){c=r(),l=0,a=``,s=0;continue e}c[t[l]]=e[1].replaceAll(j,`"`),l++}else c[t[l]]=a,l++;a=``,s=0}else o=n;s===0?(yield c,c=r(),l=0):o=M}}function z(e,t){let n=B(e,t).filter(e=>e!=null),r=n.map(e=>v(e));for(let e=r.length-1;e>=0;e--)r[e]||(r.splice(e,1),n.splice(e,1));return{names:r,aliases:n}}function B(e,t){if(!e?.length)return[];let n=[],r=``,i=``,a=0,o=I(e,t);for(let e of o)if(r+=i+e,i=``,a+=V(e),a%2==0){if(a>0){let e=A.exec(r);e&&n.push(e[1].replaceAll(j,`"`))}else n.push(r);r=``,a=0}else i=t;return n}function V(e){let t=0,n=0;for(n=e.indexOf(`"`,n);n>=0;)t++,n=e.indexOf(`"`,n+1);return t}function H(e,t,n,r,i){let a=[],s=R(e,n,t),c=[];for(let e of s){if(c.length===10)break;c.push(e)}for(let e=0;e<n.length;e++){let t=n[e],s=r[e];if(t===i.longitudeFieldName||t===i.latitudeFieldName)a.push({name:t,type:`esriFieldTypeDouble`,alias:s});else{let e;switch(U(c.map(e=>e[t]))){case`integer`:e=`esriFieldTypeInteger`;break;case`double`:e=`esriFieldTypeDouble`;break;case`date`:e=`esriFieldTypeDate`;break;default:e=`esriFieldTypeString`}a.push({name:t,type:e,alias:s,length:o(e)})}}return a}function U(e){if(!e.length)return`string`;let t=/[^+\-.,0-9]/;return e.map(e=>{if(e!==``){if(!t.test(e)){let t=W(e);if(!isNaN(t))return/[.,]/.test(e)||!Number.isInteger(t)||t>214783647||t<-214783648?`double`:`integer`;if(e.includes(`E`)&&(t=Number(e),!Number.isNaN(t)||e.includes(`,`)&&(e=e.replace(`,`,`.`),t=Number(e),!Number.isNaN(t))))return`double`}return O(e)?`date`:`string`}}).reduce((e,t)=>e===void 0?t:t===void 0?e:e===t?t:e===`string`||t===`string`?`string`:e===`double`||t===`double`?`double`:void 0)}var W=function(){let e=y(),t=RegExp(`^`+e.regexp+`$`),n=RegExp(`[`+e.group+`\\s\\xa0]`,`g`),r=e.factor;return i=>{let a=t.exec(i);if(e.factor=r,!a)return NaN;let o=a[1];if(!a[1]){if(!a[2])return NaN;o=a[2],e.factor*=-1}return o=o.replace(n,``).replace(e.decimal,`.`),+o*e.factor}}();function G(e){return JSON.parse(JSON.stringify(e))}var K=S(`esriGeometryPoint`),q=[`csv`],J=[0,0],Y=class{constructor(e,t){this.x=e,this.y=t}},X=class{constructor(){this._queryEngine=null,this._snapshotFeatures=async e=>{let t=await this._fetch(e);return this._createFeatures(t)}}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(e,t={}){this._loadOptions=e;let[n]=await Promise.all([this._fetch(t.signal),this._checkProjection(e?.parsingOptions?.spatialReference)]),r=Z(n,e);this._locationInfo=r.locationInfo,this._delimiter=r.delimiter,this._queryEngine=this._createQueryEngine(r);let i=this._createFeatures(n);this._queryEngine.featureStore.addMany(i);let{fullExtent:a,timeExtent:o}=await this._queryEngine.fetchRecomputedExtents();if(r.layerDefinition.extent=a,o){let{start:e,end:t}=o;r.layerDefinition.timeInfo.timeExtent=[e,t]}return r}async applyEdits(){throw new e(`csv-layer:editing-not-supported`,`applyEdits() is not supported on CSVLayer`)}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),(await this._queryEngine.executeQueryForIds(e,t.signal)).filter(m)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),await this._queryEngine.executeQueryForSnapping(e,t.signal)}async queryAttributeBins(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeAttributeBinsQuery(e,t.signal)}async refresh(t){this._loadOptions.customParameters=t,this._snapshotTask?.abort(),this._snapshotTask=d(this._snapshotFeatures),this._snapshotTask.promise.then(e=>{this._queryEngine.featureStore.clear(),e&&this._queryEngine.featureStore.addMany(e)},t=>{this._queryEngine.featureStore.clear(),_(t)||r.getLogger(`esri.layers.CSVLayer`).error(new e(`csv-layer:refresh`,`An error occurred during refresh`,{error:t}))}),await this._waitSnapshotComplete();let{fullExtent:n,timeExtent:i}=await this._queryEngine.fetchRecomputedExtents();return{extent:n,timeExtent:i}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _fetch(t){let{url:n,customParameters:r}=this._loadOptions;if(!n)throw new e(`csv-layer:invalid-source`,`url not defined`);let i=g(n);return(await f(i.path,{query:{...i.query,...r},responseType:`text`,signal:t})).data}_createQueryEngine(e){let{objectIdField:t,fields:n,extent:r,timeInfo:i}=e.layerDefinition,o=new w({geometryType:`esriGeometryPoint`,hasM:!1,hasZ:!1}),s={type:`object-id`,fieldName:t};return new T({fieldsIndex:a.fromLayerJSON({fields:n,dateFieldsTimeReference:{timeZoneIANA:`UTC`}}),geometryType:`esriGeometryPoint`,hasM:!1,hasZ:!1,timeInfo:i,featureIdInfo:s,spatialReference:r.spatialReference||{wkid:4326},featureStore:o})}_createFeatures(e){let{latitudeFieldName:r,longitudeFieldName:i}=this._locationInfo,{objectIdField:a,fieldsIndex:o,spatialReference:s}=this._queryEngine,d=[],f=[],p=o.fields.filter(e=>e.name!==a).map(e=>e.name),m=0,g={};for(let e of o.fields)if(e.type!==`esriFieldTypeOID`&&e.type!==`esriFieldTypeGlobalID`){let t=n(e);t!==void 0&&(g[e.name]=t)}let _=R(e,p,this._delimiter,C(g,a));for(let e of _){let t=this._parseCoordinateValue(e[r]),n=this._parseCoordinateValue(e[i]);if(n!=null&&t!=null&&!isNaN(t)&&!isNaN(n)){for(let a in e[r]=t,e[i]=n,e)if(a!==r&&a!==i)if(o.isDateField(a))e[a]=D(e[a]);else if(o.isNumericField(a)){let t=W(e[a]);isNaN(t)?e[a]=null:e[a]=t}else e[a]!=null&&(e[a]=G(e[a]));e[a]=m,m++,d.push(new Y(n,t)),f.push(e)}}if(!t({wkid:4326},s))if(l(s))for(let e of d)[e.x,e.y]=h(e.x,e.y,J);else d=c(d,u.WGS84,s);let v=[];for(let e=0;e<d.length;e++){let{x:t,y:n}=d[e],r=f[e];r[a]=e+1,v.push(new x(new b([],[t,n]),r,null,r[a]))}return v}_parseCoordinateValue(e){if(e==null||e===``)return null;let t=W(e);return(isNaN(t)||Math.abs(t)>181)&&(t=parseFloat(e)),t}async _checkProjection(t){try{await E(i,t)}catch{throw new e(`csv-layer:projection-not-supported`,`Projection not supported`)}}};function Z(t,n){let r=n.parsingOptions||{},i={delimiter:r.delimiter,layerDefinition:null,locationInfo:{latitudeFieldName:r.latitudeField,longitudeFieldName:r.longitudeField}},o=i.layerDefinition={name:s(n.url,q)||`csv`,dateFieldsTimeReference:{timeZoneIANA:`UTC`},drawingInfo:K,geometryType:`esriGeometryPoint`,objectIdField:null,fields:[],timeInfo:r.timeInfo,extent:{xmin:1/0,ymin:1/0,xmax:-1/0,ymax:-1/0,spatialReference:r.spatialReference||{wkid:4326}}},c=F(t),l=c.next().value?.trim(),u=c.next().value?.trim();if(!l)throw new e(`csv-layer:empty-csv`,`CSV is empty`,{csv:t});let{delimiter:d,locationInfo:f}=L(l,u,r);if(!d)throw new e(`csv-layer:invalid-delimiter`,`Unable to detect the delimiter from CSV`,{firstLine:l,secondLine:u,parsingOptions:r});if(!f)throw new e(`csv-layer:location-fields-not-found`,`Unable to identify latitude and longitude fields from the CSV file`,{firstLine:l,secondLine:u,parsingOptions:r});i.locationInfo=f,i.delimiter=d;let{names:p,aliases:m}=z(l,d),h=H(t,i.delimiter,p,m,i.locationInfo);if(r.fields?.length){let e=new a(r.fields);for(let t of h){let n=e.get(t.name);n&&Object.assign(t,n)}}if(!h.some(e=>e.type===`esriFieldTypeOID`&&(o.objectIdField=e.name,!0))){let e={name:`__OBJECTID`,alias:`__OBJECTID`,type:`esriFieldTypeOID`,editable:!1,nullable:!1};o.objectIdField=e.name,h.unshift(e)}o.fields=h;let g=new a(o.fields);if(i.locationInfo&&(i.locationInfo.latitudeFieldName=g.get(i.locationInfo.latitudeFieldName).name,i.locationInfo.longitudeFieldName=g.get(i.locationInfo.longitudeFieldName).name),o.timeInfo){let e=o.timeInfo;if(e.startTimeField){let t=g.get(e.startTimeField);t?(e.startTimeField=t.name,t.type=`esriFieldTypeDate`):e.startTimeField=null}if(e.endTimeField){let t=g.get(e.endTimeField);t?(e.endTimeField=t.name,t.type=`esriFieldTypeDate`):e.endTimeField=null}if(e.trackIdField){let t=g.get(e.trackIdField);e.trackIdField=t?t.name:null}e.startTimeField||e.endTimeField||(o.timeInfo=null)}return i}export{X as default};