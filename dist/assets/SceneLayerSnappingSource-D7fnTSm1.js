import{DT as e,FE as t,JE as n,Kw as r,OE as i,OT as a,UT as o,_w as s,c_ as c,eT as l,fT as u,gD as d,pT as f,pg as p}from"./index-CZ4oMP1N.js";import"./quatf64-BJJPhW0N.js";import"./Indices-BME9aaDP.js";import"./plane-Bg1a5O73.js";import"./vectorStacks-FfDNcZoS.js";import"./deduplicate-DAw_n_cX.js";import"./BufferView-D7rgY_ku.js";import"./Util-BF0TzZHY.js";import"./types-D4cna6kF.js";import"./dehydratedPoint-rdg1UAtQ.js";import"./memoize-BNsZjv91.js";import"./elevationInfoUtils-9csVBlEH.js";import{t as m}from"./WorkerHandle-BLUb_Jly.js";import"./ObjectStack-CBI5g-Qc.js";import"./ray-CWXoVP-g.js";import"./VertexAttributeLocations-CfzeuYMz.js";import"./VertexElementDescriptor-ju-1bdWe.js";import"./geodesicUtils-CbiJFASl.js";import{g as h,l as g}from"./LineSnappingHint-BOeMI0cS.js";import"./vec3-zq4-AU_O.js";import"./sphere-9YfqUkuX.js";import"./constraints-Bf0IRs4G.js";import"./SnappingCandidate-B4WtOFZq.js";import{t as _}from"./EdgeSnappingCandidate-BfgKjc_Z.js";import"./PointSnappingHint-DvioR9Jz.js";import"./FloatArray-DqATud34.js";import"./TextureBackedBufferLayout-CRYrdH8z.js";import"./Normals-C9pyKGRR.js";import{t as v}from"./workerHelper-AF0fpvcj.js";import{n as y}from"./edgeProcessing-BPDjfOXP.js";import{t as b}from"./VertexSnappingCandidate-CFon9yk0.js";var x=class extends m{constructor(e){super(`EdgeProcessingWorker`,`extract`,{extract:e=>[e.dataBuffer],extractComponentsEdgeLocations:e=>[e.dataBuffer],extractEdgeLocations:e=>[e.dataBuffer]},e)}async process(e,t,n){return n?y(e):S(await this.invoke(new C(e),t))}async extractEdgeLocations(e,t){let n=await this.invokeMethod(`extractEdgeLocations`,new C(e),t);return v(n)}async extractComponentsEdgeLocations(e,t){let n=await this.invokeMethod(`extractComponentsEdgeLocations`,new C(e),t);return v(n)}};function S(e){return{regular:{instancesData:v(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:v(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}var C=class{constructor(e){this.dataBuffer=e.data.buffer,this.writerSettings=e.writerSettings,this.skipDeduplicate=e.skipDeduplicate,this.indices=t(e.indices)?e.indices.buffer:e.indices,this.indicesType=t(e.indices)?i(e.indices)?`Uint32Array`:`Uint16Array`:`Array`,this.indicesLength=e.indicesLength}},w=class extends s{constructor(e){super(e),this.availability=0,this._ids=new Set}destroy(){this._workerHandle.destroy(),this._workerHandle=null}initialize(){this._workerHandle=new T(this.schedule,{fetchAllEdgeLocations:(e,t)=>this._fetchAllEdgeLocations(e,t)})}async fetchCandidates(e,t){let n=e.coordinateHelper,{point:r}=e,i=c();if(!this.renderCoordsHelper.toRenderCoords(r,n.spatialReference,i))return[];let a=e.distance,o=typeof a==`number`?a:a.distance,s=await this._workerHandle.invoke({mbsJSON:{center:i,radius:o},returnEdge:e.returnEdge,returnVertex:e.vertexMode!==`none`},t);return s.candidates.sort((e,t)=>e.distance-t.distance),s.candidates.map(e=>this._convertCandidate(n,e))}async add(e,t){this._ids.add(e.id),await this._workerHandle.invokeMethod(`add`,e,t)}async remove(e,t){this._ids.delete(e.id),await this._workerHandle.invokeMethod(`remove`,e,t)}_convertCandidate(e,t){switch(t.type){case`edge`:return new _({objectId:t.objectId,targetPoint:h(this._convertRenderCoordinate(e,t.target)),edgeStart:this._convertRenderCoordinate(e,t.start),edgeEnd:this._convertRenderCoordinate(e,t.end),isDraped:!1});case`vertex`:return new b({objectId:t.objectId,targetPoint:h(this._convertRenderCoordinate(e,t.target)),isDraped:!1})}}_convertRenderCoordinate({spatialReference:e},t){let n=c();return this.renderCoordsHelper.fromRenderCoords(t,n,e),g(n)}async _fetchAllEdgeLocations(e,t){let n=[],r=[];for(let{id:i,uid:a}of e.components)this._ids.has(i)&&n.push((async()=>{let e=await this.fetchEdgeLocations(i,t.signal),n=e.locations.buffer;return r.push(n),{id:i,uid:a,objectIds:e.objectIds,locations:n,origin:e.origin,type:e.type}})());return{result:{components:(await Promise.all(n)).filter(({id:e})=>this._ids.has(e))},transferList:r}}};d([e({constructOnly:!0})],w.prototype,`renderCoordsHelper`,void 0),d([e({constructOnly:!0})],w.prototype,`fetchEdgeLocations`,void 0),d([e({constructOnly:!0})],w.prototype,`schedule`,void 0),d([e({readOnly:!0})],w.prototype,`availability`,void 0),w=d([a(`esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorkerHandle`)],w);var T=class extends m{constructor(e,t){super(`SceneLayerSnappingSourceWorker`,`fetchCandidates`,{},e,{strategy:`dedicated`,client:t})}},E=class extends s{get updating(){return this._updatingHandles.updating}constructor(e){super(e),this.availability=1,this._updatingHandles=new p,this._abortController=new AbortController}destroy(){this._tracker=f(this._tracker),this._abortController=u(this._abortController),this._updatingHandles.destroy()}initialize(){let{view:e}=this,t=e.resourceController;this._edgeWorker=new x(D(t)),this._workerHandle=new w({renderCoordsHelper:this.view.renderCoordsHelper,schedule:D(t),fetchEdgeLocations:async(e,t)=>{if(this._tracker==null)throw Error(`tracker-not-initialized`);return this._tracker.fetchEdgeLocations(e,this._edgeWorker,t)}}),this._updatingHandles.addPromise(this._setupLayerView()),this.addHandles([o(this._workerHandle),o(this._edgeWorker)])}async fetchCandidates(e,t){return this._workerHandle.fetchCandidates(e,t)}refresh(){}async _setupLayerView(){if(this.destroyed)return;let e=this._abortController?.signal,t=await this.getLayerView();t==null||r(e)||(this._tracker=t.trackSnappingSources({add:(t,n)=>{this._updatingHandles.addPromise(this._workerHandle.add({id:t,bounds:n.toJSON()},e))},remove:t=>{this._updatingHandles.addPromise(this._workerHandle.remove({id:t},e))}}))}};function D(e){return t=>e.immediate.schedule(t)}d([e({constructOnly:!0})],E.prototype,`getLayerView`,void 0),d([e({constructOnly:!0})],E.prototype,`view`,void 0),d([e({readOnly:!0})],E.prototype,`updating`,null),d([e({readOnly:!0})],E.prototype,`availability`,void 0),E=d([a(`esri.views.interactive.snapping.featureSources.I3SSnappingSource`)],E);var O=class extends s{get updating(){return this._i3sSources.some(e=>e.updating)}constructor(e){super(e),this.availability=1,this._i3sSources=[]}destroy(){this._i3sSources.forEach(e=>e.destroy()),this._i3sSources.length=0}initialize(){let{view:e}=this,t=this.layerSource.layer;this._i3sSources=t.type===`building-scene`?this._getBuildingSceneI3SSources(e,t):[this._getSceneLayerI3SSource(e,t)]}async fetchCandidates(e,t){let n=await Promise.all(this._i3sSources.map(n=>n.fetchCandidates(e,t)));return l(t),n.flat()}refresh(){this._i3sSources.forEach(e=>e.refresh())}_getBuildingSceneI3SSources(e,t){return t.allSublayers.toArray().map(n=>n.type===`building-component`?new E({getLayerView:async()=>(await e.whenLayerView(t)).whenSublayerView(n),view:e}):null).filter(n)}_getSceneLayerI3SSource(e,t){return new E({getLayerView:async()=>{let n=await e.whenLayerView(t);return n.type===`scene-layer-graphics-3d`?void 0:n},view:e})}};d([e({constructOnly:!0})],O.prototype,`layerSource`,void 0),d([e({constructOnly:!0})],O.prototype,`view`,void 0),d([e({readOnly:!0})],O.prototype,`updating`,null),d([e({readOnly:!0})],O.prototype,`availability`,void 0),O=d([a(`esri.views.interactive.snapping.featureSources.SceneLayerSnappingSource`)],O);export{O as SceneLayerSnappingSource};