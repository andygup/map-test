const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/RibbonLine.glsl-ztSlGD6X.js","assets/RibbonLine.glsl-CfmEn9-p.js","assets/index-BN8X5Ryz.js","assets/index-CWJhHB6-.css","assets/MarkerSizing.glsl-nslzooYm.js","assets/FloatsPassUniform-DKsLDw29.js","assets/NoParameters-BDE7RvXT.js","assets/Uniform-C_fuiTP5.js","assets/VisualVariables.glsl-1DqsizMu.js","assets/AlphaCutoff-WIqqBGOV.js","assets/HighlightReadBitmap.glsl-BBr-esSE.js","assets/glsl-BMw-Ib6r.js","assets/Texture2DBindUniform-Btzx3XRx.js","assets/Float3PassUniform-SaBA6LBM.js","assets/Float4PassUniform-C4TO8dd0.js","assets/ScreenSizePerspective.glsl-BuhoSJZ3.js","assets/View.glsl-CPcmVaet.js","assets/Float3BindUniform-BDFedz_d.js","assets/Float3DrawUniform-ua6q6ZtZ.js","assets/FloatBindUniform-CXY5KrrB.js","assets/Matrix4BindUniform-D7U89BGU.js","assets/FloatPassUniform-CSAt82xV.js","assets/Slice.glsl-DU3Ivhcc.js","assets/ObjectAndLayerIdColor.glsl-BHzrt-xI.js","assets/PiUtils.glsl-IDKkXUQy.js","assets/TerrainDepthTest.glsl-D7e23Ppb.js","assets/ReadDepth.glsl-CX2bpX_x.js","assets/Float2BindUniform-D7Jg9GMR.js","assets/Float4BindUniform-DpoBnM9l.js","assets/Texture2DPassUniform-DFWoDpEL.js","assets/OutputColorHighlightOLID.glsl-CoP020fC.js","assets/Emissions.glsl-C_Yvv-sZ.js","assets/Texture2DDrawUniform-jqrXjxoW.js","assets/ShaderBuilder-BLOqjpgt.js","assets/videoUtils-CRYmuPNe.js","assets/ManagedTexture-DgNSfAYU.js","assets/image-CmtRVQsT.js","assets/Util-BQgFCZvD.js","assets/sdfPrimitives-BR6xMvJc.js"])))=>i.map(i=>d[i]);
import{$ as e,$S as t,$p as n,Bi as r,CD as i,CE as a,Hl as o,Jf as s,Jm as c,Ls as l,MT as u,Mw as d,Nl as f,Q as p,Rb as m,Rl as h,Rm as g,Ul as _,VT as v,Vi as y,Vl as b,Xf as x,Yw as S,Z as ee,_g as C,_l as w,_v as T,cD as E,gl as D,hl as O,jT as k,kD as A,kl as j,km as te,mt as ne,n_ as M,pT as re,wD as ie,ww as N,x_ as P,xl as F,y_ as I,zl as ae}from"./index-BN8X5Ryz.js";import{D as oe,b as se,g as L,x as ce,y as le}from"./plane-Da5EsY0J.js";import{t as ue}from"./computeTranslationToOriginAndRotation-0WDVmpJG.js";import{G as de}from"./BufferView-BW77W5ev.js";import{a as fe,i as pe}from"./Util-BQgFCZvD.js";import{i as me}from"./orientedBoundingBox-Bd4igSGQ.js";import{_ as he,g as ge,h as _e,i as ve,l as ye,p as be}from"./Emissions.glsl-C_Yvv-sZ.js";import{r as xe}from"./sphere-d9-4vNcj.js";import{d as Se,n as Ce,o as we,s as Te}from"./lineSegment-BudcKS0C.js";import{i as Ee}from"./hydratedFeatures-Cf3ay5ZM.js";import{a as De,n as Oe,u as ke}from"./renderState-BaFdYDAL.js";import{B as Ae,E as je,F as Me,H as Ne,L as Pe,O as Fe,P as R,R as Ie,S as Le,U as Re,V as ze,c as Be,d as Ve,f as He,k as Ue,l as We,m as Ge,p as Ke,s as qe,u as Je}from"./DefaultBufferWriter-BGKzMKkp.js";import{c as Ye}from"./MaterialUtil-CcE5uVnF.js";import{t as Xe}from"./Octree-czER3kAP.js";import{a as Ze,i as Qe,s as $e}from"./SceneLighting-LJvcoD7s.js";import{a as et,s as tt}from"./FloatArray-Dt98pDp2.js";import{d as nt,i as rt}from"./FloatsPassUniform-DKsLDw29.js";import{t as it}from"./AlphaCutoff-WIqqBGOV.js";import{r as at,t as ot}from"./RibbonLine.glsl-CfmEn9-p.js";import{u as st}from"./graphicUtils-Ct1OT6JD.js";function ct(e){return e===`position`}function lt(e,t){return e??=[],e.push(t),e}function ut(e,t){if(e==null)return null;let n=e.filter(e=>e!==t);return n.length===0?null:n}function dt(e,t,n,r,i){ft[0]=e.get(t,0),ft[1]=e.get(t,1),ft[2]=e.get(t,2),Ye(ft,z,3),n.set(i,0,z[0]),r.set(i,0,z[1]),n.set(i,1,z[2]),r.set(i,1,z[3]),n.set(i,2,z[4]),r.set(i,2,z[5])}var ft=I(),z=new Float32Array(6),pt=class{constructor(e={}){this.id=d(),this._highlightIds=new Set,this._shaderTransformation=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerViewUid=e.layerViewUid,e.isElevationSource&&(this.lastValidElevationBB=new mt),this._geometries=e.geometries?Array.from(e.geometries):[]}dispose(){this._geometries.length=0}get layer(){return this._layer}set layer(e){fe(this._layer==null||e==null,`Object3D can only be added to a single Layer`),this._layer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e);for(let t of this._highlightIds)e.addHighlight(t);this._emit(`geometryAdded`,{object:this,geometry:e}),this._highlightIds.size&&this._emit(`highlightChanged`,this),this._invalidateBoundingVolume()}removeGeometry(e){let t=this._geometries.splice(e,1)[0];if(t){for(let e of this._highlightIds)t.removeHighlight(e);this._emit(`geometryRemoved`,{object:this,geometry:t}),this._highlightIds.size&&this._emit(`highlightChanged`,this),this._invalidateBoundingVolume()}}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(e,t,n=!1){this._emit(`attributesChanged`,{object:this,geometry:e,attribute:t,sync:n}),ct(t)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(let e of this._geometries)e.visible=this._visible;this._emit(`visibilityChanged`,this)}}maskOccludee(){let e=new Re;for(let t of this._geometries)t.occludees=lt(t.occludees,e);return this._emit(`occlusionChanged`,this),e}removeOcclude(e){for(let t of this._geometries)t.occludees=ut(t.occludees,e);this._emit(`occlusionChanged`,this)}highlight(e){let t=new Ne(e);for(let e of this._geometries)e.addHighlight(t);return this._emit(`highlightChanged`,this),this._highlightIds.add(t),t}removeHighlight(e){this._highlightIds.delete(e);for(let t of this._geometries)t.removeHighlight(e);this._emit(`highlightChanged`,this)}removeStateID(e){e.channel===0?this.removeHighlight(e):this.removeOcclude(e)}getCombinedStaticTransformation(e,t){return g(t,this.transformation,e.transformation)}getCombinedShaderTransformation(e,t=s()){return g(t,this.effectiveTransformation,e.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=new ht,this._validateBoundingVolume(this._bvWorldSpace,0)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=new ht,this._validateBoundingVolume(this._bvObjectSpace,1)),this._bvObjectSpace}_validateBoundingVolume(e,t){let n=t===1;for(let t of this._geometries){let r=t.boundingInfo;r&&gt(r,e,n?t.transformation:this.getCombinedShaderTransformation(t))}w(e.bounds.center,e.min,e.max,.5);for(let t of this._geometries){let r=t.boundingInfo;if(r==null)continue;let i=n?t.transformation:this.getCombinedShaderTransformation(t),a=oe(i);O(vt,r.center,i);let o=ae(vt,e.bounds.center),s=r.radius*a;e.bounds.radius=Math.max(e.bounds.radius,o+s)}}_invalidateBoundingVolume(){let e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this.layer&&e&&this.layer.notifyObjectBBChanged(this,e)}_emit(e,t){this.layer?.events.emit(e,t)}get geometries(){return this._geometries}get transformation(){return this._transformation??x}set transformation(e){this._transformation=c(this._transformation??s(),e),this._invalidateBoundingVolume(),this._emit(`transformationChanged`,this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(e){this._shaderTransformation=e?c(this._shaderTransformation??s(),e):null,this._invalidateBoundingVolume(),this._emit(`shaderTransformationChanged`,this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}get test(){}},mt=class{constructor(){this._data=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE]}get min(){return P(this._data[0],this._data[1],this._data[2])}get max(){return P(this._data[3],this._data[4],this._data[5])}minWith(e){let{_data:t}=this;t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2])}maxWith(e){let{_data:t}=this;t[3]=Math.max(t[3],e[0]),t[4]=Math.max(t[4],e[1]),t[5]=Math.max(t[5],e[2])}assignMinMax(e,t){for(let n=0;n<3;++n)this._data[0+n]=e[n],this._data[3+n]=t[n]}isEmpty(){return this._data[3]<this._data[0]&&this._data[4]<this._data[1]&&this._data[5]<this._data[2]}},ht=class extends mt{constructor(){super(...arguments),this.bounds=new xe}};function gt(e,t,n){let r=e.bbMin,i=e.bbMax;if(te(n)){let e=h(_t,n[12],n[13],n[14]);_(B,r,e),_(V,i,e),t.minWith(B),t.maxWith(V);return}if(O(B,r,n),D(r,i))return t.minWith(B),void t.maxWith(B);O(V,i,n),t.minWith(B),t.minWith(V),t.maxWith(B),t.maxWith(V);for(let e=0;e<3;++e)o(B,r),o(V,i),B[e]=i[e],V[e]=r[e],O(B,B,n),O(V,V,n),t.minWith(B),t.minWith(V),t.maxWith(B),t.maxWith(V)}var _t=I(),B=I(),V=I(),vt=I(),yt=[`layerObjectAdded`,`layerObjectRemoved`,`layerObjectsAdded`,`layerObjectsRemoved`,`transformationChanged`,`shaderTransformationChanged`,`visibilityChanged`,`occlusionChanged`,`highlightChanged`,`geometryAdded`,`geometryRemoved`,`attributesChanged`],bt=class{constructor(e,t,n=``){this.stage=e,this.apiLayerViewUid=n,this.id=d(),this.events=new T,this.visible=!0,this.sliceable=!1,this._objectsAdded=[],this._handles=new u,this._objects=new Map,this._pickable=!0,this.visible=t?.visible??!0,this._pickable=t?.pickable??!0,this.updatePolicy=t?.updatePolicy??0,e.addLayer(this);for(let t of yt)this._handles.add(this.events.on(t,n=>e.handleEvent(t,n)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.removeLayer(this),this.invalidateSpatialQueryAccelerator())}get objects(){return this._objects}getObject(e){return ie(this._objects.get(e))}set pickable(e){this._pickable=e}get pickable(){return this._pickable&&this.visible}add(e){this._objects.set(e.id,e),e.layer=this,this.events.emit(`layerObjectAdded`,e),this._octree!=null&&this._objectsAdded.push(e)}remove(e){this._objects.delete(e.id)&&(this.events.emit(`layerObjectRemoved`,e),e.layer=null,this._octree!=null&&(E(this._objectsAdded,e)||this._octree.remove([e])))}addMany(e){for(let t of e)this._objects.set(t.id,t),t.layer=this;this.events.emit(`layerObjectsAdded`,e),this._octree!=null&&this._objectsAdded.push(...e)}removeMany(e){let t=[];for(let n of e)this._objects.delete(n.id)&&t.push(n);if(t.length!==0&&(this.events.emit(`layerObjectsRemoved`,t),t.forEach(e=>e.layer=null),this._octree!=null)){for(let e=0;e<t.length;)E(this._objectsAdded,t[e])?(t[e]=t[t.length-1],--t.length):++e;this._octree.remove(t)}}commit(){this.stage.commitLayer(this)}sync(){this.updatePolicy!==1&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){this._octree==null||this._objectsAdded.includes(e)||this._octree.update(e,t)}getSpatialQueryAccelerator(){return this._octree==null&&this._objects.size>50?(this._octree=new Xe(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.values())):this._octree!=null&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded),this._objectsAdded.length=0),this._octree}invalidateSpatialQueryAccelerator(){this._octree=k(this._octree),this._objectsAdded.length=0}get test(){}},xt=class{constructor(e,t){this.vec3=e,this.id=t}};function St(e,t,n,r){return new xt(P(e,t,n),r)}var Ct={stableRendering:!1},wt={rootOrigin:null},Tt=class extends Ze{constructor(e,n){super(e,n,tt(Dt(n))),this.shader=new $e(at,()=>t(()=>import(`./RibbonLine.glsl-ztSlGD6X.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]))),this.primitiveType=n.wireframe?l.LINES:l.TRIANGLE_STRIP}_makePipelineState(e,t){let{oitPass:n,output:r,hasEmission:i,hasOccludees:a,hasPolygonOffset:o}=e,s=n===0,c=n===2;return Oe({blending:ye(r)?Ie(n):null,depthTest:Me(n),depthWrite:Ae(e),drawBuffers:Qe(r,ze(n,i)),colorWrite:De,stencilWrite:a?Je:null,stencilTest:a?t?Ke:Be:null,polygonOffset:s||c?o?Et:null:Pe})}initializePipeline(e){if(e.occluder){let t=e.hasPolygonOffset?Et:null,{output:n,hasOccludees:r}=e;this._occluderPipelineTransparent=Oe({blending:ke,polygonOffset:t,depthTest:He,depthWrite:null,colorWrite:De,stencilWrite:null,stencilTest:r?We:null,drawBuffers:Qe(n)}),this._occluderPipelineOpaque=Oe({blending:ke,polygonOffset:t,depthTest:r?He:qe,depthWrite:null,colorWrite:De,stencilWrite:r?Ve:null,stencilTest:r?Ge:null,drawBuffers:Qe(n)}),this._occluderPipelineMaskWrite=Oe({blending:null,polygonOffset:t,depthTest:qe,depthWrite:null,colorWrite:null,stencilWrite:r?Je:null,stencilTest:r?Ke:null,drawBuffers:Qe(n)})}return this._occludeePipeline=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){if(t)return this._occludeePipeline;switch(e.occluder){case 12:return this._occluderPipelineTransparent??super.getPipeline(e);case 11:return this._occluderPipelineOpaque??super.getPipeline(e);default:i(e.occluder);case void 0:case null:return this._occluderPipelineMaskWrite??super.getPipeline(e)}}};Tt=A([v(`esri.views.3d.webgl-engine.shaders.RibbonLineTechnique`)],Tt);var Et={factor:0,units:-4};function Dt(e){let t=et().vec3f(`position`).vec4f16(`previousDelta`).vec4f16(`nextDelta`).f32(`u0`).vec2f16(`lineParameters`);return e.hasVVColor?t.f32(`colorFeatureAttribute`):t.vec4u8(`color`,{glNormalized:!0}),e.hasVVSize?t.f32(`sizeFeatureAttribute`):t.f32(`size`),e.hasVVOpacity&&t.f32(`opacityFeatureAttribute`),nt()&&t.vec4u8(`olidColor`),e.hasAnimation&&t.vec4f16(`timeStamps`),t}var H=class extends Fe{constructor(e){super(),this.spherical=e,this.capType=0,this.emissionSource=0,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.occluder=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.wireframe=!1,this.discardInvisibleFragments=!1,this.animation=2,this.hasScreenSizePerspective=!1,this.textureCoordinateType=0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasSliceTranslatedView=!0,this.overlayEnabled=!1,this.snowCover=!1}get hasAnimation(){return this.animation!==0}};A([R({count:3})],H.prototype,`capType`,void 0),A([R({count:8})],H.prototype,`emissionSource`,void 0),A([R()],H.prototype,`hasPolygonOffset`,void 0),A([R()],H.prototype,`writeDepth`,void 0),A([R()],H.prototype,`draped`,void 0),A([R()],H.prototype,`stippleEnabled`,void 0),A([R()],H.prototype,`stippleOffColorEnabled`,void 0),A([R()],H.prototype,`stipplePreferContinuous`,void 0),A([R()],H.prototype,`roundJoins`,void 0),A([R()],H.prototype,`applyMarkerOffset`,void 0),A([R()],H.prototype,`hasVVSize`,void 0),A([R()],H.prototype,`hasVVColor`,void 0),A([R()],H.prototype,`hasVVOpacity`,void 0),A([R()],H.prototype,`falloffEnabled`,void 0),A([R()],H.prototype,`innerColorEnabled`,void 0),A([R()],H.prototype,`hasOccludees`,void 0),A([R()],H.prototype,`occluder`,void 0),A([R()],H.prototype,`terrainDepthTest`,void 0),A([R()],H.prototype,`cullAboveTerrain`,void 0),A([R()],H.prototype,`wireframe`,void 0),A([R()],H.prototype,`discardInvisibleFragments`,void 0),A([R({count:4})],H.prototype,`animation`,void 0),A([R()],H.prototype,`hasScreenSizePerspective`,void 0);var Ot=class extends je{constructor(e,t){super(e,At),this.produces=new Map([[2,e=>_e(e)||ye(e)&&this.parameters.renderOccluded===8],[3,e=>he(e)],[11,e=>be(e)&&this.parameters.renderOccluded===8],[12,e=>be(e)&&this.parameters.renderOccluded===8],[4,e=>ye(e)&&this.parameters.writeDepth&&this.parameters.renderOccluded!==8],[9,e=>ye(e)&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==8],[19,e=>ge(e)]]),this._configuration=new H(t)}getConfiguration(e,t){super.getConfiguration(e,t,this._configuration),this._configuration.oitPass=t.oitPass,this._configuration.draped=t.slot===19;let n=this.parameters.stipplePattern!=null&&e!==8;return this._configuration.stippleEnabled=n,this._configuration.stippleOffColorEnabled=n&&this.parameters.stippleOffColor!=null,this._configuration.stipplePreferContinuous=n&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.roundJoins=this.parameters.join===`round`,this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=this.parameters.markerParameters!=null&&Pt(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&this.parameters.innerColor!=null,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.hasOccludees=t.hasOccludees,this._configuration.occluder=this.parameters.renderOccluded===8,this._configuration.terrainDepthTest=t.terrainDepthTest&&ye(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.wireframe=this.parameters.wireframe,this._configuration.animation=this.parameters.animation,this._configuration.emissionSource=this.hasEmissions?1:0,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration}get visible(){return this.parameters.color[3]>=.003913894324853229||this.parameters.stipplePattern!=null&&(this.parameters.stippleOffColor?.[3]??0)>.003913894324853229}setParameters(e,t){e.animation=this.parameters.animation,super.setParameters(e,t)}intersectDraped({attributes:e,screenToWorldRatio:t},n,r,i,a){if(!n.options.selectionMode)return;let o=e.get(`size`),s=this.parameters.width;if(this.parameters.vvSize){let t=e.get(`sizeFeatureAttribute`).data[0];Number.isNaN(t)?s*=this.parameters.vvSize.fallback[0]:s*=N(this.parameters.vvSize.offset[0]+t*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else o&&(s*=o.data[0]);let c=r[0],l=r[1],u=(s/2+4)*t,d=Number.MAX_VALUE,f=0,p=e.get(`position`).data,m=Nt(this.parameters,e)?p.length-2:p.length-5;for(let e=0;e<m;e+=3){let t=p[e],n=p[e+1],r=(e+3)%p.length,i=c-t,a=l-n,o=p[r]-t,s=p[r+1]-n,u=N((o*i+s*a)/(o*o+s*s),0,1),m=o*u-i,h=s*u-a,g=m*m+h*h;g<d&&(d=g,f=e/3)}d<u*u&&i(a.distance,a.normal,f)}intersect(e,t,n,r,i,s){let{options:c,camera:l,rayBegin:u,rayEnd:d}=n;if(!c.selectionMode||!e.visible||!l)return;if(!pe(t))return void a.getLogger(`esri.views.3d.webgl-engine.materials.RibbonLineMaterial`).error(`intersection assumes a translation-only matrix`);let p=e.attributes,g=p.get(`position`).data,v=this.parameters.width;if(this.parameters.vvSize){let e=p.get(`sizeFeatureAttribute`).data[0];Number.isNaN(e)||(v*=N(this.parameters.vvSize.offset[0]+e*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0]))}else p.has(`size`)&&(v*=p.get(`size`).data[0]);let y=Ft;m(y,n.point);let x=v*l.pixelRatio/2+4*l.pixelRatio;h(Ht[0],y[0]-x,y[1]+x,0),h(Ht[1],y[0]+x,y[1]+x,0),h(Ht[2],y[0]+x,y[1]-x,0),h(Ht[3],y[0]-x,y[1]-x,0);for(let e=0;e<4;e++)if(!l.unprojectFromRenderScreen(Ht[e],Z[e]))return;ce(l.eye,Z[0],Z[1],Ut),ce(l.eye,Z[1],Z[2],Wt),ce(l.eye,Z[2],Z[3],Gt),ce(l.eye,Z[3],Z[0],Kt);let S=Number.MAX_VALUE,ee=0,C=Nt(this.parameters,p)?g.length-2:g.length-5;for(let e=0;e<C;e+=3){U[0]=g[e]+t[12],U[1]=g[e+1]+t[13],U[2]=g[e+2]+t[14];let n=(e+3)%g.length;if(W[0]=g[n]+t[12],W[1]=g[n+1]+t[13],W[2]=g[n+2]+t[14],L(Ut,U)<0&&L(Ut,W)<0||L(Wt,U)<0&&L(Wt,W)<0||L(Gt,U)<0&&L(Gt,W)<0||L(Kt,U)<0&&L(Kt,W)<0)continue;let r=l.projectToRenderScreen(U,It),i=l.projectToRenderScreen(W,Lt);if(r==null||i==null)continue;if(r[2]<0&&i[2]>0){j(G,U,W);let e=l.frustum,t=-L(e[4],U)/F(G,se(e[4]));if(f(G,G,t),_(U,U,G),!l.projectToRenderScreen(U,r))continue}else if(r[2]>0&&i[2]<0){j(G,W,U);let e=l.frustum,t=-L(e[4],W)/F(G,se(e[4]));if(f(G,G,t),_(W,W,G),!l.projectToRenderScreen(W,i))continue}else if(r[2]<0&&i[2]<0)continue;r[2]=0,i[2]=0;let a=Te(we(r,i,Bt),y);a<S&&(S=a,o(Rt,U),o(zt,W),ee=e/3)}if(S<x*x){let e=Number.MAX_VALUE;if(Ce(we(Rt,zt,Bt),we(u,d,Vt),K)){j(K,K,u);let t=b(K);f(K,K,1/t),e=t/ae(u,d)}s(e,K,ee)}}get hasEmissions(){return this.parameters.emissiveStrength>0}createBufferWriter(){return new jt(Dt(this.parameters),this.parameters)}createGLMaterial(e){return new kt(e)}validateParameters(e){e.join!==`miter`&&(e.miterLimit=0),e.markerParameters!=null&&(e.markerScale=e.markerParameters.width/e.width)}update(e){return!!this.parameters.hasAnimation&&(this.setParameters({timeElapsed:S(e.time)},!1),e.dt!==0)}},kt=class extends ve{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures?.release(this._stipplePattern),this._stipplePattern=null}beginSlot(e){let t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(t,this._stipplePattern)}),this._stipplePattern=t),this.getTechnique(Tt,e)}},At=class extends rt{constructor(){super(...arguments),this.width=0,this.color=e,this.join=`miter`,this.cap=0,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.wireframe=!1,this.timeElapsed=0,this.animation=0,this.animationSpeed=1,this.trailLength=1,this.startTime=0,this.endTime=1/0,this.fadeInTime=0,this.fadeOutTime=1/0,this.emissiveStrength=0}get transparent(){return this.color[3]<1||this.hasAnimation||this.stipplePattern!=null&&(this.stippleOffColor?.[3]??0)<1}get hasAnimation(){return this.animation!==0}},jt=class{constructor(e,t){this.layout=e,this._parameters=t;let n=t.stipplePattern?1:0;switch(this._parameters.join){case`miter`:case`bevel`:this.numJoinSubdivisions=n;break;case`round`:this.numJoinSubdivisions=1+n}}_isClosed(e){return Nt(this._parameters,e)}allocate(e){return this.layout.createBuffer(e)}elementCount(e){let t=e.get(`position`).indices.length/2+1,n=this._isClosed(e),r=n?2:4;return r+=((n?t:t-1)-(n?0:1))*(2*this.numJoinSubdivisions+4),r+=2,this._parameters.wireframe&&(r=2+4*(r-2)),r}write(e,t,n,r,i,a){let s=this.layout,c=n.get(`position`),l=c.indices,u=c.data.length/3,d=n.get(`distanceToStart`)?.data;l&&l.length!==2*(u-1)&&console.warn(`RibbonLineMaterial does not support indices`);let f=s.fields.has(`sizeFeatureAttribute`),p=1,m=null;if(f){let e=n.get(`sizeFeatureAttribute`);e.data.length===1?p=e.data[0]:m=e.data}else p=n.get(`size`)?.data[0]??1;let g=[1,1,1,1],_=0,v=null,y=s.fields.has(`colorFeatureAttribute`);if(y){let e=n.get(`colorFeatureAttribute`);e.data.length===1?_=e.data[0]:v=e.data}else g=n.get(`color`)?.data??g;let b=n.get(`timeStamps`)?.data,x=b&&s.fields.has(`timeStamps`),S=s.fields.has(`opacityFeatureAttribute`),ee=0,C=null;if(S){let e=n.get(`opacityFeatureAttribute`);e.data.length===1?ee=e.data[0]:C=e.data}let w=new Float32Array(i.buffer),T=de(i.buffer),E=new Uint8Array(i.buffer),D=s.stride/4,k=a*D,A=k,j=0,te=d?(e,t,n)=>j=d[n]:(e,t,n)=>j+=ae(e,t),M=w.BYTES_PER_ELEMENT/T.BYTES_PER_ELEMENT,re=4/M,ie=nt(),N=(e,t,n,i,a,o,s,c)=>{w[k++]=t[0],w[k++]=t[1],w[k++]=t[2],Le(e,t,T,k*M),k+=re,Le(n,t,T,k*M),k+=re,w[k++]=c;let l=k*M;if(T[l++]=a,T[l++]=o,k=Math.ceil(l/M),y)w[k]=v?.[s]??_;else{let e=Math.min(4*s,g.length-4),t=4*k;E[t]=255*g[e],E[t+1]=255*g[e+1],E[t+2]=255*g[e+2],E[t+3]=255*g[e+3]}if(k++,w[k++]=m?.[s]??p,S&&(w[k++]=C?.[s]??ee),ie){let e=4*k;r?(E[e++]=r[0],E[e++]=r[1],E[e++]=r[2],E[e++]=r[3]):(E[e++]=0,E[e++]=0,E[e++]=0,E[e++]=0),k=Math.ceil(.25*e)}x&&(l=k*M,T[l++]=i[0],T[l++]=i[1],T[l++]=i[2],T[l++]=i[3],k=Math.ceil(l/M))};k+=D,h(J,c.data[0],c.data[1],c.data[2]),x&&ne(X,b[0],b[1],b[2],b[3]),e&&O(J,J,e);let P=this._isClosed(n);if(P){let t=c.data.length-3;h(q,c.data[t],c.data[t+1],c.data[t+2]),e&&O(q,q,e)}else h(Y,c.data[3],c.data[4],c.data[5]),e&&O(Y,Y,e),N(J,J,Y,X,1,-4,0,0),N(J,J,Y,X,1,4,0,0),o(q,J),o(J,Y),x&&ne(X,b[4],b[5],b[6],b[7]);let F=P?0:1,I=P?u:u-1;for(let t=F;t<I;t++){let n=(t+1)%u*3;h(Y,c.data[n],c.data[n+1],c.data[n+2]),e&&O(Y,Y,e),te(q,J,t),N(q,J,Y,X,0,-1,t,j),N(q,J,Y,X,0,1,t,j);let r=this.numJoinSubdivisions;for(let e=0;e<r;++e){let n=(e+1)/(r+1);N(q,J,Y,X,n,-1,t,j),N(q,J,Y,X,n,1,t,j)}if(N(q,J,Y,X,1,-2,t,j),N(q,J,Y,X,1,2,t,j),o(q,J),o(J,Y),x){let e=(t+1)%u*4;ne(X,b[e],b[e+1],b[e+2],b[e+3])}}return P?(h(Y,c.data[3],c.data[4],c.data[5]),e&&O(Y,Y,e),j=te(q,J,I),N(q,J,Y,X,0,-1,F,j),N(q,J,Y,X,0,1,F,j)):(j=te(q,J,I),N(q,J,J,X,0,-5,I,j),N(q,J,J,X,0,5,I,j)),Mt(w,A+D,w,A,D),k=Mt(w,k-D,w,k,D),this._parameters.wireframe&&this._addWireframeVertices(i,A,k,D),null}_addWireframeVertices(e,t,n,r){let i=new Float32Array(e.buffer,n*Float32Array.BYTES_PER_ELEMENT),a=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,n-t),o=0,s=e=>o=Mt(a,e,i,o,r);for(let e=0;e<a.length-1;e+=2*r)s(e),s(e+2*r),s(e+1*r),s(e+2*r),s(e+1*r),s(e+3*r)}};function Mt(e,t,n,r,i){for(let a=0;a<i;a++)n[r++]=e[t++];return r}function Nt(e,t){return e.isClosed?t.get(`position`).indices.length>2:!1}function Pt(e){return e.anchor===1&&e.hideOnShortSegments&&e.placement===`begin-end`&&e.worldSpace}var U=I(),W=I(),G=I(),K=I(),Ft=I(),It=C(),Lt=C(),Rt=I(),zt=I(),Bt=Se(),Vt=Se(),q=I(),J=I(),Y=I(),X=ee(),Ht=[C(),C(),C(),C()],Z=[I(),I(),I(),I()],Ut=le(),Wt=le(),Gt=le(),Kt=le(),qt=class{constructor(e){this._originSR=e,this._rootOriginId=`root/`+d(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(e){let t=this._origins.get(this._rootOriginId);if(t==null){let t=wt.rootOrigin;if(t!=null)return this._origins.set(this._rootOriginId,St(t[0],t[1],t[2],this._rootOriginId)),this.getOrigin(e);let n=St(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,n),n}let n=this._gridSize,r=Math.round(e[0]/n),i=Math.round(e[1]/n),a=Math.round(e[2]/n),o=`${r}/${i}/${a}`,s=this._origins.get(o),c=.5*n;if(j(Q,e,t.vec3),Q[0]=Math.abs(Q[0]),Q[1]=Math.abs(Q[1]),Q[2]=Math.abs(Q[2]),Q[0]<c&&Q[1]<c&&Q[2]<c){if(s){let t=Math.max(...Q);if(j(Q,e,s.vec3),Q[0]=Math.abs(Q[0]),Q[1]=Math.abs(Q[1]),Q[2]=Math.abs(Q[2]),Math.max(...Q)<t)return s}return t}return s||(s=St(r*n,i*n,a*n,o),this._origins.set(o,s)),s}_drawOriginBox(e,t=p(1,1,0,1)){let n=window.view,r=n.stage,i=t.toString();if(!this._objects.has(i)){this._material=new Ot({width:2,color:t},!1);let e=new bt(r,{pickable:!1}),n=new pt({castShadow:!1});e.add(n),this._objects.set(i,n)}let a=this._objects.get(i),o=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],s=o.length,c=Array(3*s),l=[],u=.5*this._gridSize;for(let t=0;t<s;t++)c[3*t]=e[0]+(1&o[t]?u:-u),c[3*t+1]=e[1]+(2&o[t]?u:-u),c[3*t+2]=e[2]+(4&o[t]?u:-u),t>0&&l.push(t-1,t);M(c,this._originSR,0,c,n.renderSpatialReference,0,s);let d=new Ue(this._material,[[`position`,new me(c,l,3,!0)]],null,2);a.addGeometry(d)}get test(){}},Q=I(),Jt=class{constructor(e,t=null,n=0){this.array=e,this.spatialReference=t,this.offset=n}};function Yt(e){return`array`in e}function Xt(e,t,n=`ground`){if(st(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,n);if(Yt(t)){let r=t.offset;return e.getElevation(t.array[r++],t.array[r++],t.array[r]||0,t.spatialReference??e.spatialReference,n)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,n)}function Zt(e,t,n,r,i,a,o,s,c,l,u){let d=fn[u.mode],f,p,m=0;if(M(e,t,n,r,c.spatialReference,i,s))return d?.requiresAlignment(u)?(m=d.applyElevationAlignmentBuffer(r,i,a,o,s,c,l,u),f=a,p=o):(f=r,p=i),M(f,c.spatialReference,p,a,l.spatialReference,o,s)?m:void 0}function Qt(e,t,n,r,i){let a=(st(e)?e.z:Yt(e)?e.array[e.offset+2]:e[2])||0;switch(n.mode){case`on-the-ground`:{let n=Xt(t,e,`ground`)??0;i.verticalDistanceToGround=0,i.sampledElevation=n,i.z=n;return}case`relative-to-ground`:{let o=Xt(t,e,`ground`)??0,s=n.geometryZWithOffset(a,r);i.verticalDistanceToGround=s,i.sampledElevation=o,i.z=s+o;return}case`relative-to-scene`:{let o=Xt(t,e,`scene`)??0,s=n.geometryZWithOffset(a,r);i.verticalDistanceToGround=s,i.sampledElevation=o,i.z=s+o;return}case`absolute-height`:{let o=n.geometryZWithOffset(a,r),s=Xt(t,e,`ground`)??0;i.verticalDistanceToGround=o-s,i.sampledElevation=s,i.z=o;return}default:i.z=0;return}}function $t(e,t,n,r){return Qt(e,t,n,r,$),$.z}function en(e,t,n){return t===`on-the-ground`&&n===`on-the-ground`?e.staysOnTheGround:t===n||t!==`on-the-ground`&&n!==`on-the-ground`?t==null||n==null?e.definedChanged:1:e.onTheGroundChanged}function tn(e){return e===`relative-to-ground`||e===`relative-to-scene`}function nn(e){return e!==`absolute-height`}function rn(e,t,n,r,i){Qt(t,n,i,r,$),an(e,$.verticalDistanceToGround);let a=$.sampledElevation,o=c(pn,e.transformation);return mn[0]=t.x,mn[1]=t.y,mn[2]=$.z,ue(t.spatialReference,mn,o,r.spatialReference)?e.transformation=o:console.warn(`Could not locate symbol object properly, it might be misplaced`),a}function an(e,t){for(let n=0;n<e.geometries.length;++n){let r=e.geometries[n].getMutableAttribute(`centerOffsetAndDistance`);r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[n],`centerOffsetAndDistance`))}}function on(e,t,n,r,i,a){let o=0,s=a.spatialReference;t*=3,r*=3;for(let c=0;c<i;++c){let i=e[t],c=e[t+1],l=e[t+2],u=a.getElevation(i,c,l,s,`ground`)??0;o+=u,n[r]=i,n[r+1]=c,n[r+2]=u,t+=3,r+=3}return o/i}function sn(e,t,n,r,i,a,o,s){let c=0,l=s.calculateOffsetRenderUnits(o),u=s.featureExpressionInfoContext,d=a.spatialReference;t*=3,r*=3;for(let o=0;o<i;++o){let i=e[t],o=e[t+1],s=e[t+2],f=a.getElevation(i,o,s,d,`ground`)??0;c+=f,n[r]=i,n[r+1]=o,n[r+2]=u==null?s+f+l:f+l,t+=3,r+=3}return c/i}function cn(e,t,n,r,i,a,o,s){let c=0,l=s.calculateOffsetRenderUnits(o),u=s.featureExpressionInfoContext,d=a.spatialReference;t*=3,r*=3;for(let o=0;o<i;++o){let i=e[t],o=e[t+1],s=e[t+2],f=a.getElevation(i,o,s,d,`scene`)??0;c+=f,n[r]=i,n[r+1]=o,n[r+2]=u==null?s+f+l:f+l,t+=3,r+=3}return c/i}function ln(e){let t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return t!==0||n!=null}function un(e,t,n,r,i,a,o,s){let c=s.calculateOffsetRenderUnits(o),l=s.featureExpressionInfoContext;t*=3,r*=3;for(let a=0;a<i;++a){let i=e[t],a=e[t+1],o=e[t+2];n[r]=i,n[r+1]=a,n[r+2]=l==null?o+c:c,t+=3,r+=3}return 0}var dn=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}},fn={"absolute-height":{applyElevationAlignmentBuffer:un,requiresAlignment:ln},"on-the-ground":{applyElevationAlignmentBuffer:on,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:sn,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:cn,requiresAlignment:()=>!0}},pn=s(),$=new dn,mn=I(),hn=()=>a.getLogger(`esri.views.3d.layers.graphics.featureExpressionInfoUtils`);function gn(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}async function _n(e,t,r,i){let a=e?.expression;if(typeof a!=`string`)return null;let o=wn(a);if(o!=null)return{cachedResult:o};let s=await n();re(r);let c=s.arcadeUtils,l=c.createSyntaxTree(a);return c.dependsOnView(l)?(i?.error(`Expressions containing '$view' are not supported on ElevationInfo`),{cachedResult:0}):{arcade:{func:c.createFunction(l),context:c.createExecContext(null,{sr:t}),modules:s}}}function vn(e,t,n){return e.arcadeUtils.createFeature(t.attributes,t.geometry,n)}function yn(e,t){if(e!=null&&!Cn(e)){if(!t||!e.arcade)return void hn().errorOncePerTick(`Arcade support required but not provided`);let n=t;n._geometry&&=Ee(n._geometry),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function bn(e){if(e!=null){if(Cn(e))return e.cachedResult;let t=e.arcade,n=t?.modules.arcadeUtils.executeFunction(t.func,t.context);return typeof n!=`number`&&(e.cachedResult=0,n=0),n}return 0}function xn(e,t=!1){let n=e?.featureExpressionInfo,r=n?.expression;return t||r===`0`||(n=null),n??null}var Sn={cachedResult:0};function Cn(e){return e.cachedResult!=null}function wn(e){return e===`0`?0:null}var Tn=class e{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit=`meters`,this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.mode=null,this.centerInElevationSR=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=y(e)}get requiresSampledElevationInfo(){return this.mode!==`absolute-height`}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit=`meters`}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){let n=this.calculateOffsetRenderUnits(t);return this.featureExpressionInfoContext==null?e+n:n}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset,n=this.featureExpressionInfoContext;return n!=null&&(t+=bn(n)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=r(e.unit)?e.unit:`meters`,this.offsetElevationInfoUnits=e.offset??0}setFeatureExpressionInfoContext(e){this._featureExpressionInfoContext=e}updateFeatureExpressionInfoContextForGraphic(e,t,n){e.arcade?(this._featureExpressionInfoContext=gn(e),this.updateFeatureExpressionFeature(t,n)):this._featureExpressionInfoContext=e}updateFeatureExpressionFeature(e,t){let n=this.featureExpressionInfoContext;n?.arcade&&(n.cachedResult=void 0,yn(this._featureExpressionInfoContext,e.geometry?vn(n.arcade.modules,e,t):null))}static fromElevationInfo(t){let n=new e;return t!=null&&n.setFromElevationInfo(t),n}};export{ct as C,dt as S,Ot as _,Qt as a,bt as b,rn as c,an as d,$t as f,qt as g,Jt as h,Sn as i,Zt as l,Xt as m,_n as n,tn as o,dn as p,xn as r,en as s,Tn as t,nn as u,Ct as v,pt as x,St as y};