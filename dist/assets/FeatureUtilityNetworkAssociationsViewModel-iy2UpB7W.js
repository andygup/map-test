import{Ci as e,DT as t,Hw as n,Kp as r,Nh as i,OT as a,Sh as o,_w as s,aE as c,ev as l,gD as u,gd as d,gw as f,ha as p,iv as m,nv as h,rT as g,rd as _,s as v,vd as y,xh as b}from"./index-CZ4oMP1N.js";import{i as x}from"./featureUtils-CYV1Iiyw.js";var S=class extends s{constructor(e){super(e),this.title=!0,this.description=!0}};u([t({type:Boolean,nonNullable:!0})],S.prototype,`title`,void 0),u([t({type:Boolean,nonNullable:!0})],S.prototype,`description`,void 0),S=u([a(`esri.widgets.Feature.FeatureUtilityNetworkAssociations.VisibleElements`)],S);var C={fromGlobalId:`fromglobalid`,fromNetworkSourceId:`fromnetworksourceid`,fromTerminalId:`fromterminalid`,toGlobalId:`toglobalid`,toNetworkSourceId:`tonetworksourceid`,toTerminalId:`toterminalid`,associationType:`associationtype`,globalId:`globalid`,status:`status`,isContentVisible:`iscontentvisible`,percentAlong:`percentalong`,assetGroup:`assetgroup`,assetType:`assettype`};function w(e){let{attributes:t,sourceLayer:n}=e;if(!t||!n)return``;let r=`displayField`in n?n.displayField:null,i=r==null?null:t[r],a=i==null?null:i.toString(),o=e.getObjectId()?.toString();return a||o||``}var T=100,E=class extends f(i(s)){constructor(e){super(e),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.networkSourceIdsInUse=new Set,this.source=`popup`,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.featureCount=0,this.associationTypes=null,this.showAllEnabled=!1,this.title=null,this.attachmentsFeatureCount=0,this.structureFeatureCount=0,this.contentFeatureCount=0,this.containerFeatureCount=0,this.connectivityFeatureCount=0,this._queryOpenAssociationType=async()=>{this.activeAssociationType&&await this._queryDebounced(this.activeAssociationType)},this._cancelQuery=()=>{let{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{let{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._queryController=async e=>{this._cancelQuery();let t=new AbortController;this._queryAbortController=t,await g(this._query(e)),this._queryAbortController===t&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();let e=new AbortController;this._queryFeatureCountAbortController=e,await g(this._queryFeatureCount()),this._queryFeatureCountAbortController===e&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryDebounced=n(this._queryController,T),this._queryFeatureCountDebounced=n(this._queryFeatureCountController,T)}initialize(){this.addHandles([h(()=>[this.graphic,this.layer,this.map,this.associationTypes,this.objectId,this.globalId,this.canQuery],()=>{this.refresh()},l),h(()=>this.activeAssociationType,e=>{this._queryDebounced(e)},l)])}destroy(){this._cancelQuery(),this._cancelQueryFeatureCount(),this._destroyAssociatedFeatureViewModels()}get supportsCacheHint(){return!!this.layer?.capabilities?.query?.supportsCacheHint}get canLoad(){return!!this.map&&!!this.associationTypes&&typeof this.globalId==`string`}get canQuery(){let e=this.layer?.capabilities?.query;return!!this.associationTypes&&typeof this.globalId==`string`&&!!e?.supportsPagination}set displayCount(e){this._set(`displayCount`,Math.max(e??3,0))}get displayCount(){return this._get(`displayCount`)}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get globalId(){return(this.globalIdField&&this.graphic?.attributes?.[this.globalIdField])??null}get globalIdField(){let{layer:e}=this;return e?.globalIdField}get activeAssociationType(){return this._get(`activeAssociationType`)}set activeAssociationType(e){e&&!this.associationTypes.includes(e)||this._set(`activeAssociationType`,e)}get state(){let{_queryAbortController:e,_queryFeatureCountAbortController:t,_queryPageAbortController:n,canQuery:r,_loaded:i,canLoad:a,source:o}=this;return t||a&&!i?`loading`:e||n?`querying`:!r||o===`popup`&&this.featureCount===0?`disabled`:`ready`}get utilityNetwork(){let{layer:e,map:t}=this;if(!e?.loaded||!t)return null;let n=o(e)?e.parent:e;return x(t,n)}get attachmentsAssociations(){return this._get(`attachmentsAssociations`)||new m}get structureAssociations(){return this._get(`structureAssociations`)||new m}get contentAssociations(){return this._get(`contentAssociations`)||new m}get containerAssociations(){return this._get(`containerAssociations`)||new m}get connectivityAssociations(){return this._get(`connectivityAssociations`)||new m}get associationFeatures(){return this._get(`associationFeatures`)||new d}get associationViewModels(){return this._get(`associationViewModels`)||new Map}async refresh(){await this._queryFeatureCountDebounced(),await this._queryOpenAssociationType()}getFeatureCountForAssociationType(e){switch(e){case`attachment`:return this.attachmentsFeatureCount;case`structure`:return this.structureFeatureCount;case`content`:return this.contentFeatureCount;case`container`:return this.containerFeatureCount;case`connectivity`:return this.connectivityFeatureCount}}_destroyAssociatedFeatureViewModels(){this.associationViewModels.forEach(e=>e.destroyAll())}async _loadUtiltyNetworks(){let e=this.map;if(!e)return;await Promise.allSettled(e.utilityNetworks?.map(async e=>{await e.load()})??[]);let t=this.utilityNetwork;if(t){let n=e=>{if(`layerId`in e&&t.isUtilityLayer(e)){let n=e.layerId==null?null:t.getSourceIdByLayerId(e.layerId);n!=null&&this.networkSourceIdsInUse.add(n)}};this._set(`networkSourceIdsInUse`,new Set),e.allLayers.forEach(n),e.allTables.forEach(n)}}async _findLayersBySourceId(e){let{utilityNetwork:t,map:n}=this,r=e=>{let n=e;return e.url&&n.layerId===i?e.url.replace(/\/\d+$/,``)===t?.featureServiceUrl:!1};await t?.load();let i=t.getLayerIdBySourceId(e),a=n.allLayers.filter(r),o=n.allTables.filter(r),s=a.concat(o).toArray();return await Promise.allSettled(s.map(e=>e.load())),s}_clearAssociations(){this.attachmentsAssociations.removeAll(),this.structureAssociations.removeAll(),this.contentAssociations.removeAll(),this.containerAssociations.removeAll(),this.connectivityAssociations.removeAll()}_clearFeatures(){this.associationFeatures.forEach(e=>e.removeAll()),this.associationFeatures.clear()}_getAssociationsByType(e){switch(e){case`attachment`:return this.attachmentsAssociations;case`structure`:return this.structureAssociations;case`connectivity`:return this.connectivityAssociations;case`container`:return this.containerAssociations;case`content`:return this.contentAssociations}}async _queryLayer(t,n,r,i,a){let o=this._getFeatureQueryWhereClause(t,n,r,i),s=new _({where:o,outFields:[`*`],cacheHint:this.supportsCacheHint}),c=p.fromJSON(await e(t,s,a));return c.features.forEach(e=>{e.layer=e.sourceLayer=b(t)?t.findSublayerForFeature(e):t}),c.features}async _createAssociationFeatureObjects(e,t,n,r,i,a){if(e.length===0)return[];let o=new Map;for(let[e,n]of t){let t=await this._findLayersBySourceId(e);for(let e of t)(await this._queryLayer(e,n,r,i,a)).forEach(t=>{if(this.source===`popup`?t.sourceLayer&&t.getEffectivePopupTemplate():t.sourceLayer){let n=o.get(t.attributes[e.globalIdField])??[];n.push(t),o.set(t.attributes[e.globalIdField],n)}})}let s=[];return await Promise.all(e.toArray().map(async e=>{let{fromNetworkElement:t,toNetworkElement:r}=e,i=t.globalId===n?r:t,a=o.get(i.globalId)??[];await Promise.all(a.map(async t=>{let n=this.utilityNetwork?.getTerminalById(i?.terminalId)?.name,r=t.sourceLayer&&`getFeatureTitle`in t.sourceLayer&&await t.sourceLayer.getFeatureTitle(t)||w(t);s.push({title:r,feature:t,association:e,terminalName:n})}))})),s}_parseFeatureObjects(e,t){let n=new Map;e.forEach(e=>{let t=e?.feature,r=t.sourceLayer;c(n,r,()=>new m).add(e)});for(let[e,r]of n)this._sortFeatureObjectsByTitle(r),t.set(e,r)}_sortFeatureObjectsByTitle(e){e.sort(this._compareByFeatureTitle)}_compareByFeatureTitle(e,t){return e.title.localeCompare(t.title,void 0,{numeric:!0})}async _queryAssociations(e){let{layer:t,globalId:n,associationTypes:r,utilityNetwork:i,canQuery:a}=this;if(await Promise.allSettled([t?.load(),i?.load()]),this._clearAssociations(),!(a&&t&&r&&i&&n))return;let s=o(t)?t.parent:t,c=new v({globalId:n,networkSourceId:i.getSourceIdByLayerId(s.layerId)}),l=new Set;r.forEach(e=>{switch(e.type){case`attachment`:case`structure`:l.add(`attachment`);break;case`container`:case`content`:l.add(`containment`);break;case`connectivity`:l.add(`connectivity`),l.add(`junction-junction-connectivity`),l.add(`junction-edge-from-connectivity`),l.add(`junction-edge-midspan-connectivity`),l.add(`junction-edge-to-connectivity`)}});let u=await i?.queryAssociations({elements:[c],types:Array.from(l)},{signal:e?.signal}),d=new Map,f=new Map;r.forEach(e=>{f.set(e.type,e),d.set(e.type,[])}),u.forEach(e=>{let{toNetworkElement:t,fromNetworkElement:r}=e;switch(e.associationType){case`connectivity`:case`junction-junction-connectivity`:case`junction-edge-from-connectivity`:case`junction-edge-midspan-connectivity`:case`junction-edge-to-connectivity`:if(r?.globalId===n){if(this._shouldDiscardNetworkElement(t,`connectivity`,f))break;d.get(`connectivity`)?.push(t.globalId)}else{if(this._shouldDiscardNetworkElement(r,`connectivity`,f))break;d.get(`connectivity`)?.push(r.globalId)}this.connectivityAssociations.add(e);break;case`containment`:if(r?.globalId===n){if(this._shouldDiscardNetworkElement(t,`content`,f))break;d.get(`content`)?.push(t.globalId),this.contentAssociations.add(e)}else{if(this._shouldDiscardNetworkElement(r,`container`,f))break;d.get(`container`)?.push(r.globalId),this.containerAssociations.add(e)}break;case`attachment`:if(r?.globalId===n){if(this._shouldDiscardNetworkElement(t,`attachment`,f))break;d.get(`attachment`)?.push(t.globalId),this.attachmentsAssociations.add(e)}else{if(this._shouldDiscardNetworkElement(r,`structure`,f))break;d.get(`structure`)?.push(r.globalId),this.structureAssociations.add(e)}}});let p=r.map(async t=>{let{associatedNetworkSourceId:n,associatedAssetGroup:r,associatedAssetType:i}=t,a=d.get(t.type),o=r==null?a.length:await this._countAssociatedFeatures(n,a,r,i,e);switch(t.type){case`attachment`:this._set(`attachmentsFeatureCount`,o);break;case`structure`:this._set(`structureFeatureCount`,o);break;case`content`:this._set(`contentFeatureCount`,o);break;case`container`:this._set(`containerFeatureCount`,o);break;case`connectivity`:this._set(`connectivityFeatureCount`,o)}});await Promise.allSettled(p)}async _countAssociatedFeatureCount(e,t,n,r,i){let a=this._getFeatureQueryWhereClause(e,t,n,r);return e.queryFeatureCount({where:a,outFields:[`*`],returnGeometry:!1},{signal:i?.signal})}async _countAssociatedFeatures(e,t,n,r,i){if(t.length===0)return 0;let a=(await this._findLayersBySourceId(e)).map(async e=>this._countAssociatedFeatureCount(e,t,n,r,i));return(await Promise.all(a)).reduce((e,t)=>e+t,0)}async _queryAssociatedFeatures(e,t){let{layer:n,globalId:r,associationTypes:i,utilityNetwork:a,canQuery:o,associationFeatures:s}=this;if(await Promise.allSettled([n?.load(),a?.load()]),!(o&&n&&i&&a))return;let c=this._getAssociationsByType(e.type),{associatedAssetGroup:l,associatedAssetType:u}=e,d=new Map;c.forEach(e=>{let{fromNetworkElement:t,toNetworkElement:n}=e,{networkSourceId:i,elementGlobalId:a}=t.globalId===r?{networkSourceId:n.networkSourceId,elementGlobalId:n.globalId}:{networkSourceId:t.networkSourceId,elementGlobalId:t.globalId},o=d.get(i)||[];o.push(a),d.set(i,o)});let f=await this._createAssociationFeatureObjects(c,d,r,l,u,t);this._parseFeatureObjects(f,s)}async _queryFeatureCount(){await this._loadUtiltyNetworks();let{_queryFeatureCountAbortController:e,canQuery:t}=this;t?(await this._queryAssociations(e),this._set(`featureCount`,this.attachmentsFeatureCount+this.structureFeatureCount+this.contentFeatureCount+this.containerFeatureCount+this.connectivityFeatureCount)):this._set(`featureCount`,0)}async _query(e){if(!e)return;await this._loadUtiltyNetworks();let{_queryAbortController:t}=this;this._destroyAssociatedFeatureViewModels(),this._clearFeatures(),this.featureCount!==0&&(this.destroyed||await this._queryAssociatedFeatures(e,{signal:t?.signal}))}_shouldDiscardNetworkElement(e,t,n){if(!e)return!1;let{networkSourceIdsInUse:r}=this,{networkSourceId:i}=e,a=n.get(t)?.associatedNetworkSourceId,o=r.has(i);return a!=null&&a!==i||!o}_getFeatureQueryWhereClause(e,t,n,i){let a=e.globalIdField,o=e.fieldsIndex.get(C.assetGroup),s=e.fieldsIndex.get(C.assetType),c=n!=null,l=i!=null;return[a?r(a,t):null,c?`(${o?.name} = ${n})`:null,c&&l?`(${s?.name} = ${i})`:null].filter(Boolean).join(` AND `)}};u([t()],E.prototype,`_loaded`,void 0),u([t()],E.prototype,`_queryAbortController`,void 0),u([t()],E.prototype,`_queryPageAbortController`,void 0),u([t()],E.prototype,`_queryFeatureCountAbortController`,void 0),u([t({readOnly:!0})],E.prototype,`supportsCacheHint`,null),u([t({readOnly:!0})],E.prototype,`canLoad`,null),u([t({readOnly:!0})],E.prototype,`canQuery`,null),u([t()],E.prototype,`networkSourceIdsInUse`,void 0),u([t({constructOnly:!0})],E.prototype,`source`,void 0),u([t()],E.prototype,`description`,void 0),u([t({value:3})],E.prototype,`displayCount`,null),u([t({type:y})],E.prototype,`graphic`,void 0),u([t()],E.prototype,`layer`,void 0),u([t()],E.prototype,`map`,void 0),u([t({readOnly:!0})],E.prototype,`objectId`,null),u([t({readOnly:!0})],E.prototype,`objectIdField`,null),u([t({readOnly:!0})],E.prototype,`globalId`,null),u([t({readOnly:!0})],E.prototype,`globalIdField`,null),u([t()],E.prototype,`featureCount`,void 0),u([t()],E.prototype,`associationTypes`,void 0),u([t()],E.prototype,`activeAssociationType`,null),u([t()],E.prototype,`showAllEnabled`,void 0),u([t()],E.prototype,`state`,null),u([t()],E.prototype,`title`,void 0),u([t({readOnly:!0})],E.prototype,`utilityNetwork`,null),u([t({readOnly:!0})],E.prototype,`attachmentsFeatureCount`,void 0),u([t({readOnly:!0})],E.prototype,`structureFeatureCount`,void 0),u([t({readOnly:!0})],E.prototype,`attachmentsAssociations`,null),u([t({readOnly:!0})],E.prototype,`structureAssociations`,null),u([t({readOnly:!0})],E.prototype,`contentFeatureCount`,void 0),u([t({readOnly:!0})],E.prototype,`containerFeatureCount`,void 0),u([t({readOnly:!0})],E.prototype,`contentAssociations`,null),u([t({readOnly:!0})],E.prototype,`containerAssociations`,null),u([t({readOnly:!0})],E.prototype,`connectivityFeatureCount`,void 0),u([t({readOnly:!0})],E.prototype,`connectivityAssociations`,null),u([t({readOnly:!0})],E.prototype,`associationFeatures`,null),u([t({readOnly:!0})],E.prototype,`associationViewModels`,null),E=u([a(`esri.widgets.support.UtilityNetworkAssociations.FeatureUtilityNetworkAssociationsViewModel`)],E);export{S as n,E as t};