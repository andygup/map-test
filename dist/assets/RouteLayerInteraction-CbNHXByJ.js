import{DT as e,Dd as t,Gh as n,Hw as r,JE as i,OT as a,Qw as o,_w as s,ev as c,gD as l,jd as u,nv as d,pg as f,vd as p}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import{n as m}from"./measures-CvGGokgB.js";import"./Point2D-7VmvyXN4.js";import"./Envelope2D-Cwxt0azx.js";import"./SpatialReference-HLIf1Z5k.js";import"./Transformation2D-CPSmiNnd.js";import"./SimpleGeometryCursor-5wFw2ZZo.js";import"./OperatorDefinitions-CscAnk1m.js";import"./OperatorProximity-D5FJ67Oq.js";import"./jsonConverter-CbeIyOFG.js";import"./apiConverter-BH2GqpH4.js";import"./geodeticCurveType-DoJa853C.js";import"./geodeticAreaOperator-CbAaN6Nl.js";import"./geodeticLengthOperator-CWQiiddx.js";import"./Distance2DCalculator-CXhBP-8I-CqzpU8vR.js";import{n as h}from"./distanceOperator-CYf0gmY_.js";import{t as g}from"./proximityOperator-DR4Uj50N.js";import"./quatf64-BJJPhW0N.js";import"./earcut-BF1-mB58.js";import"./plane-Bg1a5O73.js";import"./vectorStacks-FfDNcZoS.js";import"./projectPointToVector-HYpbaZqA.js";import"./spatialReferenceEllipsoidUtils-B0E4spY0.js";import"./projectionZScaling-DAQiVc32.js";import{i as _,r as v}from"./projectOperator-CfopyaTY.js";import"./dehydratedPoint-rdg1UAtQ.js";import"./projectVectorToVector-DX3Yd1qf.js";import"./memoize-BNsZjv91.js";import"./elevationInfoUtils-9csVBlEH.js";import{s as y}from"./colorUtils-DJOs5VE1.js";import{t as b}from"./GraphicsLayer-Bx8Nz7ax.js";import"./networkEnums-QOpSLZcw.js";import"./ObjectStack-CBI5g-Qc.js";import"./ray-CWXoVP-g.js";import{i as x,n as S,r as C,t as w}from"./Stop-D2HmBER2.js";import"./quantity-CPor8qMe.js";import"./geodesicUtils-CbiJFASl.js";import{t as T}from"./SketchViewModel-NAjbn0Ca.js";import"./isSupportedObject-Ccal0viz.js";import"./layerUtils-VowzydxH.js";import"./SketchOptions-Dp8M5XoK.js";import"./LineSnappingHint-BOeMI0cS.js";import"./ParallelSnappingHint-C_mSlwpq.js";import"./snappingUtils-Od8uWW_a.js";import"./vec3-zq4-AU_O.js";import"./sphere-9YfqUkuX.js";import"./constraints-Bf0IRs4G.js";import"./SnappingCandidate-B4WtOFZq.js";import"./EdgeSnappingCandidate-BfgKjc_Z.js";import"./DrapedEdgeSnappingCandidate-BWx5lQgf.js";import"./IntersectionSnappingHint-CdcMZxUs.js";import"./IntersectionSnappingCandidate-b5Urq9uN.js";import"./LineSnappingCandidate-BsncFUer.js";import"./RightAngleTriangleSnappingCandidate-CRITbc5W.js";import"./RightAngleSnappingHint-BXbBqf-p.js";import"./viewUtils-D9SUkhqu.js";import"./viewUtils-BwKx9qtR.js";import"./euclideanLengthMeasurementUtils-C9WB-wbk.js";import"./lineSegment-BJ2rgalW.js";import"./triangle-_uWz9WdI.js";import"./hitTestSelectUtils-DQf3EOGe.js";var E=Symbol(),D=20,O=class extends s{constructor(e){super(e),this._graphicsLayer=new b({listMode:`hide`,internal:!0}),this._updatingHandles=new f,this._debouncedHandleClick=r(async e=>{let t=this._graphicsLayer.graphics.at(0);if(t?.geometry?.type!==`point`)return;e.stopPropagation();let n=new w({geometry:t.geometry.clone(),locationType:`waypoint`,symbol:this.waypointSymbol.clone()}),r=await this._getWaypointIndex(n);this.interaction.layer.stops.add(n,r),this.interaction.layer.stops.forEach(e=>e.sequence=null),this.interaction.addNetworkFeature(n)}),this._debouncedHandlePointerMove=r(async e=>{if(!this.interaction.enabled||this.interaction.sketchActive||this.interaction.layer.stops.length<2||!this.interaction.layer.routeInfo?.geometry)return void this._clearWaypointManipulator();let{spatialReference:t}=this.view;await _();let n=v(this.interaction.layer.routeInfo?.geometry,t);if(!n)return void this._clearWaypointManipulator();let r=this.view.resolution*window.devicePixelRatio*D,{coordinate:a,distance:o,isEmpty:s}=g(n,this.view.toMap(e));if(s||o>r||this.interaction.layer.stops.map(({geometry:e})=>e).filter(i).map(e=>v(e,t)).filter(i).some(e=>h(e,a)<r))return void this._clearWaypointManipulator();this.addHandles(this.view.acquireCursor(`pointer`,`high`),E);let c=this._graphicsLayer.graphics.at(0);if(c)return void(c.geometry=a);let{waypointSymbol:l}=this,u=new p({geometry:a,symbol:l});this._graphicsLayer.graphics.destroyAll(),this._graphicsLayer.add(u)})}initialize(){this.view.map?.add(this._graphicsLayer),this._updatingHandles.add(()=>({enabled:this.interaction.enabled,graphic:this._graphicsLayer.graphics.at(0),symbol:this.waypointSymbol}),({enabled:e,graphic:t,symbol:n})=>{e?t&&(t.symbol=n):this._clearWaypointManipulator()},c),this.addHandles([this.view.on(`click`,e=>this._debouncedHandleClick(e).catch(o),n.TOOL),this.view.on(`pointer-move`,e=>this._debouncedHandlePointerMove(e).catch(o),n.TOOL)])}destroy(){this._graphicsLayer.removeFromParent(),this._graphicsLayer.graphics.destroyAll(),this._graphicsLayer.destroy(),this._updatingHandles.destroy()}get updating(){return!this._graphicsLayer.loaded||this._updatingHandles.updating}get waypointSymbol(){let e=this.interaction.layer.defaultSymbols.stops?.waypoint;if(e)return e;let{accentColor:n}=this.view.effectiveTheme;return new t({color:n,outline:new u({color:y(n),width:1.5}),size:10})}_clearWaypointManipulator(){this._graphicsLayer.graphics.destroyAll(),this.removeHandles(E)}async _getWaypointIndex(e){let{routeInfo:t,stops:n}=this.interaction.layer;if(n.length===2||!t?.geometry||!e.geometry)return 1;let{spatialReference:r}=this.view;await _();let i=v(t.geometry,r),a=v(e.geometry,r);if(!i||!a)return 1;let o=m(i,a)?.distanceAlong;if(!o)return 1;for(let e=1;e<n.length;e++){let t=n.at(e)?.geometry;if(!t)continue;let a=v(t,r);if(!a)continue;let s=m(i,a)?.distanceAlong;if(s!=null&&s>o)return e}return n.length-1}};l([e()],O.prototype,`interaction`,void 0),l([e()],O.prototype,`updating`,null),l([e()],O.prototype,`waypointSymbol`,null),l([e()],O.prototype,`view`,void 0),O=l([a(`esri.views.2d.layers.support.RouteLayerWaypointVisualization`)],O);function k(e,t){e.networkFeature=t}function A(e){let t=M(e.graphic);return{...e,networkFeature:t}}function j(e){let t=e.graphics.map(e=>M(e));return{...e,networkFeatures:t}}function M(e){return e.networkFeature}function N(e){return e?.type===`point`||e?.type===`polyline`||e?.type===`polygon`}var P=class extends s{constructor(e){super(e),this._createMode=null,this._graphicsLayer=new b({internal:!0,listMode:`hide`}),this._sketchViewModel=new T({layer:this._graphicsLayer}),this._updatingHandles=new f,this.enabled=!0,this._handleSketchViewModelEvents=async e=>{switch(e.type){case`update`:switch(e.state){case`active`:case`complete`:for(let t of e.graphics)M(t).geometry=N(t.geometry)?t.geometry.clone():null}break;case`undo`:case`redo`:break;case`delete`:for(let t of e.graphics){let e=M(t);this._removeNetworkFeature(e)}break;case`create`:if(e.graphic&&e.state===`complete`&&this._createMode){let t=e.graphic.geometry?.clone(),n=e.graphic.symbol?.clone();if(!t)break;switch(this._createMode){case`stop`:{if(t.type!==`point`)break;let{stops:n}=this.layer;if(n.length>0&&n.every(({geometry:e})=>!e)){n.at(0).geometry=t;break}if(n.length>1&&n.filter((e,t)=>t!==0).every(({geometry:e})=>!e)){n.at(1).geometry=t;break}let r=new w({geometry:t});n.add(r),k(e.graphic,r);break}case`point-barrier`:{if(t.type!==`point`)break;let r=new x({geometry:t,symbol:n});this.layer.pointBarriers.add(r),k(e.graphic,r);break}case`polyline-barrier`:{if(t.type!==`polyline`)break;let r=new S({geometry:t,symbol:n});this.layer.polylineBarriers.add(r),k(e.graphic,r);break}case`polygon-barrier`:{if(t.type!==`polygon`)break;let r=new C({geometry:t,symbol:n});this.layer.polygonBarriers.add(r),k(e.graphic,r);break}}}}(await this.view.whenLayerView(this.layer)).emit(e.type,e.type===`create`?A(e):j(e))}}initialize(){this._sketchViewModel.view=this.view,this.addHandles([d(()=>this.enabled,e=>{e?this._activate():this._deactivate()},c),d(()=>{let{stops:e,pointBarriers:t,polylineBarriers:n,polygonBarriers:r}=this.layer;return{stops:e,pointBarriers:t,polylineBarriers:n,polygonBarriers:r}},()=>{this.enabled&&this._loadClonedGraphics()}),this._sketchViewModel.on([`create`,`delete`,`redo`,`undo`,`update`],this._handleSketchViewModelEvents)]),this._routeLayerWaypointVisualization=new O({view:this.view,interaction:this})}destroy(){this._graphicsLayer.removeFromParent(),this._graphicsLayer.graphics.destroyAll(),this._graphicsLayer.destroy(),this._routeLayerWaypointVisualization?.destroy(),this._sketchViewModel.destroy(),this._updatingHandles.destroy()}get selectedNetworkFeatures(){return this._sketchViewModel.updateGraphics.map(e=>M(e))}get sketchActive(){return!!this._sketchViewModel.activeTool}get updating(){return(this._routeLayerWaypointVisualization?.updating??!0)||this._sketchViewModel.updating||this._updatingHandles.updating}addNetworkFeature(e){let t=e.toGraphic();this._graphicsLayer.add(t),k(t,e),this._sketchViewModel.update(t)}async create(e){if(this.enabled){switch(this._createMode=e,e){case`stop`:this.layer.defaultSymbols.stops?.unlocated&&(this._sketchViewModel.pointSymbol=this.layer.defaultSymbols.stops.unlocated.clone());break;case`point-barrier`:this.layer.defaultSymbols.pointBarriers&&(this._sketchViewModel.pointSymbol=this.layer.defaultSymbols.pointBarriers.clone());break;case`polyline-barrier`:this.layer.defaultSymbols.polylineBarriers&&(this._sketchViewModel.polylineSymbol=this.layer.defaultSymbols.polylineBarriers.clone());break;case`polygon-barrier`:this.layer.defaultSymbols.polygonBarriers&&(this._sketchViewModel.polygonSymbol=this.layer.defaultSymbols.polygonBarriers.clone())}switch(e){case`stop`:case`point-barrier`:return this._sketchViewModel.create(`point`);case`polyline-barrier`:return this._sketchViewModel.create(`polyline`);case`polygon-barrier`:return this._sketchViewModel.create(`polygon`)}}}delete(){for(let e of this.selectedNetworkFeatures)this.remove(e)}remove(e){let t=this._graphicsLayer.graphics.find(t=>M(t)===e);t&&(this._graphicsLayer.remove(t),this._removeNetworkFeature(e))}_activate(){this._loadClonedGraphics(),this.view.map.add(this._graphicsLayer)}_deactivate(){this._sketchViewModel.cancel(),this._graphicsLayer.removeFromParent(),this._graphicsLayer.graphics.destroyAll()}_loadClonedGraphics(){let e=[this.layer.stops,this.layer.pointBarriers,this.layer.polylineBarriers,this.layer.polygonBarriers].flatMap(e=>e.toArray().map(e=>{let t=e.toGraphic();return t.networkFeature=e,t}));this._graphicsLayer.graphics.destroyAll(),this._graphicsLayer.addMany(e)}_removeNetworkFeature(e){switch(e.type){case`stop`:this.layer.stops.remove(e);break;case`point-barrier`:this.layer.pointBarriers.remove(e);break;case`polyline-barrier`:this.layer.polylineBarriers.remove(e);break;case`polygon-barrier`:this.layer.polygonBarriers.remove(e)}}};l([e()],P.prototype,`_routeLayerWaypointVisualization`,void 0),l([e()],P.prototype,`enabled`,void 0),l([e({constructOnly:!0})],P.prototype,`layer`,void 0),l([e({readOnly:!0})],P.prototype,`selectedNetworkFeatures`,null),l([e()],P.prototype,`sketchActive`,null),l([e()],P.prototype,`updating`,null),l([e({constructOnly:!0})],P.prototype,`view`,void 0),P=l([a(`esri.views.2d.layers.support.RouteLayerInteraction`)],P);export{P as RouteLayerInteraction};