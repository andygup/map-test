import{$T as e,A as t,Ai as n,BT as r,C as i,CE as a,Di as o,FC as s,FE as c,GT as l,L as u,M as ee,Rh as te,UT as d,Ua as f,VT as p,WT as m,ZS as h,_ as g,_E as _,ba as v,bd as y,ca as b,cp as ne,fp as x,ip as re,iw as ie,jE as ae,ji as oe,kD as S,kw as C,ma as w,pa as T,sT as E,xa as D}from"./index-BN8X5Ryz.js";import{n as O,t as k}from"./SceneService-CV9CcpT-.js";import"./originUtils-CJnuu7mB.js";import"./resourceUtils-Bt8ctqoA.js";import"./resourceUtils-t_8WR2aj.js";import"./saveUtils-CEfw3trS.js";import"./memoize-Dl61_jt0.js";import{o as A,p as j,y as M}from"./elevationInfoUtils-uoMH3ofe.js";import{i as N,n as P,r as F,t as I}from"./PointCloudUniqueValueRenderer-bZQhGMcP.js";var L=Symbol(`isPointCloudGraphicOrigin`),R,se=class extends v{get[(R=L,re)](){return this.layer}get[D](){return this.layer}constructor(e){super(),this[R]=!0,this.type=`point-cloud`,this.layer=e}get id(){return this.layer.id}},z=class extends ie{constructor(e){super(e),this.field=null,this.type=null}clone(){return console.warn(`.clone() is not implemented for `+this.declaredClass),null}};S([r({type:String,json:{write:{enabled:!0,isRequired:!0}}})],z.prototype,`field`,void 0),S([r({readOnly:!0,nonNullable:!0,json:{read:!1,write:{isRequired:!0}}})],z.prototype,`type`,void 0),z=S([p(`esri.layers.pointCloudFilters.PointCloudFilter`)],z);var B=z,V,H=V=class extends B{constructor(e){super(e),this.requiredClearBits=null,this.requiredSetBits=null,this.type=`bitfield`}clone(){return new V({field:this.field,requiredClearBits:c(this.requiredClearBits),requiredSetBits:c(this.requiredSetBits)})}};S([r({type:[_],json:{write:{enabled:!0,overridePolicy(){return{enabled:!0,isRequired:!this.requiredSetBits}}}}})],H.prototype,`requiredClearBits`,void 0),S([r({type:[_],json:{write:{enabled:!0,overridePolicy(){return{enabled:!0,isRequired:!this.requiredClearBits}}}}})],H.prototype,`requiredSetBits`,void 0),S([l({pointCloudBitfieldFilter:`bitfield`})],H.prototype,`type`,void 0),H=V=S([p(`esri.layers.pointCloudFilters.PointCloudBitfieldFilter`)],H);var U=H,W,G=W=class extends B{constructor(e){super(e),this.includedReturns=[],this.type=`return`}clone(){return new W({field:this.field,includedReturns:c(this.includedReturns)})}};S([r({type:[[`firstOfMany`,`last`,`lastOfMany`,`single`]],json:{write:{enabled:!0,isRequired:!0}}})],G.prototype,`includedReturns`,void 0),S([l({pointCloudReturnFilter:`return`})],G.prototype,`type`,void 0),G=W=S([p(`esri.layers.pointCloudFilters.PointCloudReturnFilter`)],G);var K=G,q,J=q=class extends B{constructor(e){super(e),this.mode=`exclude`,this.type=`value`,this.values=[]}clone(){return new q({field:this.field,mode:this.mode,values:c(this.values)})}};S([r({type:[`exclude`,`include`],json:{write:{enabled:!0,isRequired:!0}}})],J.prototype,`mode`,void 0),S([l({pointCloudValueFilter:`value`})],J.prototype,`type`,void 0),S([r({type:[Number],json:{write:{enabled:!0,isRequired:!0}}})],J.prototype,`values`,void 0),J=q=S([p(`esri.layers.pointCloudFilters.PointCloudValueFilter`)],J);var ce={key:`type`,base:B,typeMap:{value:J,bitfield:U,return:K}},Y,X=Y=class extends N{constructor(e){super(e),this.type=`point-cloud-rgb`,this.field=null}clone(){return new Y({...this.cloneProperties(),field:c(this.field)})}};S([l({pointCloudRGBRenderer:`point-cloud-rgb`})],X.prototype,`type`,void 0),S([r({type:String,json:{write:{isRequired:!0}}})],X.prototype,`field`,void 0),X=Y=S([p(`esri.renderers.PointCloudRGBRenderer`)],X);var le=X,Z={key:`type`,base:N,typeMap:{"point-cloud-class-breaks":F,"point-cloud-rgb":le,"point-cloud-stretch":P,"point-cloud-unique-value":I},errorContext:`renderer`},Q=i(),$=class extends O(T(u(ee(t(f(b(w(C(te))))))))){constructor(...e){super(...e),this.operationalLayerType=`PointCloudLayer`,this.popupEnabled=!0,this.popupTemplate=null,this.opacity=1,this.filters=[],this.fields=null,this.fieldsIndex=null,this.outFields=null,this.path=null,this.legendEnabled=!0,this.renderer=null,this.type=`point-cloud`,this.graphicOrigin=new se(this),this.rootPagePromise=null}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}get defaultPopupTemplate(){return this.attributeStorageInfo?this.createPopupTemplate():null}getFieldDomain(e){let t=this.fieldsIndex.get(e);return t?.domain?t.domain:null}readServiceFields(e,t,n){return Array.isArray(e)?e.map(e=>{let t=new y;return e.type===`FieldTypeInteger`&&((e=c(e)).type=`esriFieldTypeInteger`),t.read(e,n),t}):Array.isArray(t.attributeStorageInfo)?t.attributeStorageInfo.map(e=>new y({name:e.name,type:e.name===`ELEVATION`?`double`:`integer`})):null}set elevationInfo(e){e!=null&&e.mode!==`absolute-height`||this._set(`elevationInfo`,e),this._validateElevationInfo(e)}writeRenderer(e,t,n,r){ae(`layerDefinition.drawingInfo.renderer`,e.write({},r),t)}load(e){return this.addResolvingPromise(this._load(e)),Promise.resolve(this)}async _load(e){await this.loadFromPortal({supportedTypes:[`Scene Service`]},e).catch(E),await this._fetchService(e?.signal),await this._fetchRootPageAndUpdateExtent(e?.signal)}async _fetchRootPageAndUpdateExtent(e){this.rootPagePromise=this._fetchRootPage(e);let{fullExtent:t}=this;if(t!=null&&!t.hasZ){let e=await this.rootPagePromise;k(t,e?.nodes?.[0]?.obb)}}async _fetchRootPage(t){let n=`${this.parsedUrl?.path??``}/nodepages/0`;try{return(await h(n,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:t})).data}catch(t){throw new e(`pointcloudlayer:root-page-missing`,`Root page missing.`,{error:t,url:n})}}createPopupTemplate(e){let t=g(this,e);return t&&(this._formatPopupTemplateReturnsField(t),this._formatPopupTemplateRGBField(t)),t}_formatPopupTemplateReturnsField(e){let t=this.fieldsIndex.get(`RETURNS`);if(!t)return;let n=e.fieldInfos?.find(e=>e.fieldName===t.name);if(!n)return;let r=new x({name:`pcl-returns-decoded`,title:t.alias||t.name,expression:`\n        var returnValue = $feature.${t.name};\n        return (returnValue % 16) + " / " + Floor(returnValue / 16);\n      `});e.expressionInfos=[...e.expressionInfos||[],r],n.fieldName=`expression/pcl-returns-decoded`}_formatPopupTemplateRGBField(e){let t=this.fieldsIndex.get(`RGB`);if(!t)return;let n=e.fieldInfos?.find(e=>e.fieldName===t.name);if(!n)return;let r=new x({name:`pcl-rgb-decoded`,title:t.alias||t.name,expression:`\n        var rgb = $feature.${t.name};\n        var red = Floor(rgb / 65536, 0);\n        var green = Floor((rgb - (red * 65536)) / 256,0);\n        var blue = rgb - (red * 65536) - (green * 256);\n\n        return "rgb(" + red + "," + green + "," + blue + ")";\n      `});e.expressionInfos=[...e.expressionInfos||[],r],n.fieldName=`expression/pcl-rgb-decoded`}async queryCachedStatistics(t,n){if(await this.load(n),!this.attributeStorageInfo)throw new e(`scenelayer:no-cached-statistics`,`Cached statistics are not available for this layer`);let r=this.fieldsIndex.get(t);if(!r)throw new e(`pointcloudlayer:field-unexisting`,`Field '${t}' does not exist on the layer`);for(let e of this.attributeStorageInfo)if(e.name===r.name){let t=s(this.parsedUrl?.path??``,`./statistics/${e.key}`);return h(t,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:n?n.signal:null}).then(e=>e.data)}throw new e(`pointcloudlayer:no-cached-statistics`,`Cached statistics for this attribute are not available`)}async saveAs(e,t){return this._debouncedSaveOperations(1,{...t,getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:`point-cloud`},e)}async save(){return this._debouncedSaveOperations(0,{getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:`point-cloud`})}validateLayer(t){if(t.layerType&&t.layerType!==`PointCloud`)throw new e(`pointcloudlayer:layer-type-not-supported`,`PointCloudLayer does not support this layer type`,{layerType:t.layerType});if(isNaN(this.version.major)||isNaN(this.version.minor))throw new e(`layer:service-version-not-supported`,`Service version is not supported.`,{serviceVersion:this.version.versionString,supportedVersions:`1.x-2.x`});if(this.version.major>2)throw new e(`layer:service-version-too-new`,`Service version is too new.`,{serviceVersion:this.version.versionString,supportedVersions:`1.x-2.x`})}hasCachedStatistics(e){return this.attributeStorageInfo!=null&&this.attributeStorageInfo.some(t=>t.name===e)}_getTypeKeywords(){return[`PointCloud`]}_validateElevationInfo(e){j(a.getLogger(this),M(`Point cloud layers`,`absolute-height`,e)),j(a.getLogger(this),A(`Point cloud layers`,e))}};S([r({type:[`PointCloudLayer`]})],$.prototype,`operationalLayerType`,void 0),S([r(n)],$.prototype,`popupEnabled`,void 0),S([r({type:ne,json:{name:`popupInfo`,write:!0}})],$.prototype,`popupTemplate`,void 0),S([r({readOnly:!0,json:{read:!1}})],$.prototype,`defaultPopupTemplate`,null),S([r({readOnly:!0,json:{write:!1,read:!1,origins:{"web-document":{write:!1,read:!1}}}})],$.prototype,`opacity`,void 0),S([r({type:[`show`,`hide`]})],$.prototype,`listMode`,void 0),S([r({types:[ce],json:{origins:{service:{read:{source:`filters`}}},name:`layerDefinition.filters`,write:!0}})],$.prototype,`filters`,void 0),S([r({type:[y]})],$.prototype,`fields`,void 0),S([r(Q.fieldsIndex)],$.prototype,`fieldsIndex`,void 0),S([m(`service`,`fields`,[`fields`,`attributeStorageInfo`])],$.prototype,`readServiceFields`,null),S([r(Q.outFields)],$.prototype,`outFields`,void 0),S([r({readOnly:!0})],$.prototype,`attributeStorageInfo`,void 0),S([r(oe)],$.prototype,`elevationInfo`,null),S([r({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],$.prototype,`path`,void 0),S([r(o)],$.prototype,`legendEnabled`,void 0),S([r({types:Z,json:{origins:{service:{read:{source:`drawingInfo.renderer`}}},name:`layerDefinition.drawingInfo.renderer`,write:{target:{"layerDefinition.drawingInfo.renderer":{types:Z},"layerDefinition.drawingInfo.transparency":{type:Number}}}}})],$.prototype,`renderer`,void 0),S([d(`renderer`)],$.prototype,`writeRenderer`,null),S([r({json:{read:!1},readOnly:!0})],$.prototype,`type`,void 0),S([r({readOnly:!0})],$.prototype,`graphicOrigin`,void 0),$=S([p(`esri.layers.PointCloudLayer`)],$);var ue=$;export{ue as default};