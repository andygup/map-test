const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MediaLayerInteraction-h3UV3DZI.js","assets/index-BN8X5Ryz.js","assets/index-CWJhHB6-.css"])))=>i.map(i=>d[i]);
import{$S as e,$T as t,Aw as n,BT as r,CE as i,Fb as a,MT as o,Ry as s,Sx as c,Tx as l,Uu as u,VT as d,Zl as f,_s as p,dv as m,hv as h,kD as g,kT as _,lv as v,mv as y,mx as b,oT as x,ol as S,pv as C,sl as w,uv as T,vE as E,vT as D,vx as O,ys as k}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import"./streamLayerUtils-82UmlW-3.js";import"./QueueProcessor-D6ozkjY6.js";import"./earcut-CEMcWA4Z.js";import"./glsl-BMw-Ib6r.js";import"./layerViewUtils-CJcMVuwG.js";import"./pbf-CO6WFbVS.js";import"./colorUtils-CzajW9E7.js";import"./timeSupport-vK4lVcYW.js";import"./queryUtils-DGU5ISbw.js";import{a as A,o as j,t as M}from"./MediaElementView-bd5xETBn.js";import"./normalizeUtilsSync-TXjrdJAe.js";import"./constants-aR35pbTG.js";import"./GeometryUtils-B-8QW9FG.js";import"./VertexAttributeLocations-BScEla0R.js";import"./VertexElementDescriptor-Cl_nC_ty.js";import"./labelPoint-1O-zXr9b.js";import"./callExpressionWithCursor-CKz4lb1p.js";import"./FeatureMetadata-rc_NIaUe.js";import"./CIMSymbolHelper-B2DBxDPE.js";import"./rasterizingUtils-BsmZb-O9.js";import"./Rect-LbcnjDUG.js";import"./BoundingBox-Dtf81F-g.js";import"./BidiEngine-DvXbVJau.js";import"./callExpressionWithFeature-UlbvTUQ4.js";import"./OverrideHelper-BahbnLvz.js";import"./FeatureCommandQueue-2UJWGVaq.js";import"./config-Dk3C6lVr.js";import"./TurboLine-B-4S6x00.js";import"./dehydratedFeatureComparison-BCFMkftR.js";import"./WGLContainer-jm6ZclzQ.js";import"./utils-B0heZPZY.js";import"./ProgramTemplate-B9k_04Md.js";import"./VertexArrayObject-ChtD6bwg.js";import"./BufferObject-B3_aJU6V.js";import"./VertexBuffer-Ra4pb4dR.js";import"./vec3f32-DDMWoxUL.js";import{r as N}from"./Container-uEjPEzbR.js";import"./GraphShaderModule-AgkKIWM0.js";import"./FramebufferObject-BoYk_2uK.js";import"./ShaderBuilder-BLOqjpgt.js";import{t as P}from"./LayerView2D-Bgb1zyoa.js";import{t as F}from"./LayerView-DQaVI2FN.js";import"./UpdateTracking2D-BMTZzgpI.js";import"./constants-BOI_CTg-.js";import"./utils-DmZFjYOb.js";import"./CircularArray-Bnt6GPkP.js";import"./ComputedAttributeStorage-BgTqXVQM.js";import"./GraphicsView2D-CUXbaTHc.js";import"./dehydratedFeatures-D5ZOMtMh.js";import"./utils-URbtRPi5.js";import"./renderState-BaFdYDAL.js";import"./DisjointTimerQuery-BX0tLCqC.js";import"./GridShader-CezK1bYo.js";import"./PieChartMeshWriter-DaT7xrZR.js";import"./SymbolFader-FxP6csuG.js";import{n as I,t as L}from"./utils-CA1cbqEa.js";import{t as R}from"./OverlayContainer-YNTpBXDF.js";var z=[1,1],B=s(),V={none:`None`,loop:`Loop`,oscillate:`Oscillate`};function H(e){return e?{type:`CIMAnimatedSymbolProperties`,...e,playAnimation:e.playing,repeatType:e.repeatType?V[e.repeatType]:void 0}:{type:`CIMAnimatedSymbolProperties`}}var U=class extends N{constructor(e){super(),this.elementView=e,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=u(),this._handles=new o,this._vertices=new Float32Array(8),this._indices=new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]),this._handles.add([C(()=>this.elementView.element.opacity,e=>this.opacity=e,m),C(()=>[this.elementView.coords],()=>{this.requestRender()},m),C(()=>[`animationOptions`in this.elementView.element&&this.elementView.element.animationOptions],()=>{this.texture=_(this.texture),this.requestRender()},m),T(()=>this.elementView.element.loaded,()=>{let e=this.elementView.element;this.ready(),A(e)&&e.content!=null&&(this._handles.add([D(e.content,`play`,()=>this.requestRender()),D(e.content,`loadeddata`,()=>this.requestRender()),D(e.content,`loaded`,()=>this.requestRender())]),`requestVideoFrameCallback`in e.content?e.content.requestVideoFrameCallback(()=>this.requestRender()):this._handles.add([D(e.content,`seeked`,()=>this.requestRender())]),this.requestRender())},m)]),e.element.load().catch(n=>{i.getLogger(`esri.views.2d.layers.MediaLayerView2D`).error(new t(`element-load-error`,`Element cannot be displayed`,{element:e,error:n}))})}getMesh(e){throw Error(`Method not implemented.`)}destroy(){super.destroy(),this._handles.destroy(),this.texture=_(this.texture)}get textureSize(){return z}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){let{context:t}=e,n=this.elementView.element.content;if(n!=null){let r=n instanceof HTMLImageElement,i=n instanceof HTMLVideoElement,a=r?n.naturalWidth:i?n.videoWidth:n.width,o=r?n.naturalHeight:i?n.videoHeight:n.height;if(this._updatePerspectiveTransform(a,o),this.texture)if(i)if(n.readyState>=n.HAVE_CURRENT_DATA)e.animationsEnabled&&this._updateTextureAndRequestRender(n);else{let e=()=>{this._updateTextureAndRequestRender(n),n.removeEventListener(`canplay`,e),n.removeEventListener(`seeked`,e)};n.addEventListener(`canplay`,e),n.addEventListener(`seeked`,e)}else `getFrame`in n&&e.animationsEnabled&&this.requestRender();else{let e=new k(a,o);e.wrapMode=33071,e.preMultiplyAlpha=!0,`getFrame`in n?`animationOptions`in this.elementView.element&&(this._player=L(n,H(this.elementView.element.animationOptions),null,n=>{this.texture?this.texture.setData(n):this.texture=new p(t,e,n)})):this.texture=new p(t,e,n),this.texture.generateMipmap(),i&&this._requestVideoFrame(n)}}super.beforeRender(e)}_updateTextureAndRequestRender(e){this.texture.setData(e),this.texture.generateMipmap(),this._requestVideoFrame(e)}_requestVideoFrame(e){`requestVideoFrameCallback`in e?e.requestVideoFrameCallback(()=>this.requestRender()):e.paused||this.requestRender()}_createTransforms(){return null}draw(e,t){this.isReady&&this.texture!=null?(I(e,this._player),t.render(e,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:z,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._indices})):this.requestRender()}updateDrawCoords(e,t,n,r){let{coords:i,bounds:a}=this.elementView;if(i==null||a==null)return;let[o,s,c,l]=i.rings[0],u=this._vertices,{x:d,y:f}=e;u.set([s[0]-d,s[1]-f,o[0]-d,o[1]-f,c[0]-d,c[1]-f,l[0]-d,l[1]-f]);let p=t;if(r){let[e,,t]=a,{worldWidth:n,xBounds:i}=r,[o,s]=i;e<o&&t>o?p=n:t>s&&e<s&&(p=-n)}this.wrapAroundShift=p,this.isWrapAround=p!==0}_updatePerspectiveTransform(e,t){let n=this._vertices;j(B,[0,0,e,0,0,t,e,t],[n[0],n[1],n[4],n[5],n[2],n[3],n[6],n[7]]),a(this.perspectiveTransform,B[6]/B[8]*e,B[7]/B[8]*t)}},W=class extends n{constructor(e){super(e),this.editSourcePoints=!1}};g([r()],W.prototype,`editSourcePoints`,void 0),W=g([d(`esri.views.3d.layers.support.MediaLayerInteractionReshapeOptions`)],W);var G=class extends n{constructor(e){super(e),this.tool=`transform`,this.reshapeOptions=new W}};g([r()],G.prototype,`tool`,void 0),g([r({type:W})],G.prototype,`reshapeOptions`,void 0),G=g([d(`esri.views.3d.layers.support.MediaLayerInteractionOptions`)],G);var K=e=>{let t=e,n=class extends t{constructor(...e){super(...e),this.layer=null,this.interactive=!1,this.interactionOptions=new G,this.selectedElement=null}highlight(e,t){throw Error(`missing implementation`)}};return g([r()],n.prototype,`layer`,void 0),g([r()],n.prototype,`interactive`,void 0),g([r({type:G})],n.prototype,`interactionOptions`,void 0),g([r()],n.prototype,`selectedElement`,void 0),n=g([d(`esri.views.layers.MediaLayerViewMixin`)],n),n},q=class extends P(K(F)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this._interaction=null,this.layer=null,this.elements=new h}initialize(){this.addHandles([C(()=>[this.interactive,this.suspended],async()=>{if(this.interactive&&!this._interaction){let{MediaLayerInteraction:t}=await e(async()=>{let{MediaLayerInteraction:e}=await import(`./MediaLayerInteraction-h3UV3DZI.js`);return{MediaLayerInteraction:e}},__vite__mapDeps([0,1,2]));this._interaction=new t({view:this.view,layer:this.layer}),this.selectedElement!==this._interaction.selectedElement&&(this._interaction.selectedElement=this.selectedElement),this.interactionOptions!==this._interaction.options&&(this._interaction.options=this.interactionOptions)}this._interaction&&(this._interaction.enabled=!this.suspended&&this.interactive)},y),C(()=>this.interactionOptions,e=>{this._interaction&&(this._interaction.options=e)},y),C(()=>this.selectedElement,e=>{this._interaction&&(this._interaction.selectedElement=e)},y)])}attach(){this.addAttachHandles([v(()=>this.layer.effectiveSource,`refresh`,()=>{this._tileStrategy.refresh(e=>this._updateTile(e)),this.requestUpdate()}),v(()=>this.layer.effectiveSource,`change`,({element:e})=>this._elementUpdateHandler(e))]),this._overlayContainer=new R,this.container.addChild(this._overlayContainer),this._fetchQueue=new w({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t),scheduler:this.scheduler,priority:f.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new S({cachePolicy:`purge`,resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(e){return!0}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(e){this._tileStrategy.update(e),this._debugGraphicsView?.update(e)}async hitTest(e,t){let n=[],r=e.normalize(),i=[r.x,r.y];for(let{elementView:{normalizedCoords:t,element:r}}of this._elementReferences.values())t!=null&&l(t.rings,i)&&n.push({type:`media`,element:r,layer:this.layer,mapPoint:e,sourcePoint:r.toSource(e)});return n.reverse()}canResume(){return this.layer.source!=null&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh(e=>this._updateTile(e))}_acquireTile(e){let t=new Z(e.clone());return this._updateTile(t),t}_updateTile(e){this._updatingHandles.addPromise(this._fetchQueue.push(e.key).then(t=>{let[n,r]=e.setElements(t);this._referenceElements(e,n),this._dereferenceElements(e,r),this.requestUpdate()},e=>{x(e)||i.getLogger(this).error(e)}))}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._dereferenceElements(e,e.elements),this.requestUpdate()}async _queryElements(e,t){let n=this.layer.effectiveSource;if(n==null)return[];this.view.featuresTilingScheme.getTileBounds(J,e,!0);let r=new O({xmin:J[0],ymin:J[1],xmax:J[2],ymax:J[3],spatialReference:this.view.spatialReference});return n.queryElements(r,t)}_referenceElements(e,t){if(this.layer.source!=null)for(let n of t)this._referenceElement(e,n)}_referenceElement(e,n){E(this._elementReferences,n.uid,()=>{let e=new M({element:n,spatialReference:this.view.spatialReference}),r=new U(e);return this._overlayContainer.addChild(r),this.elements.add(n),this._updatingHandles.addPromise(n.load().catch(e=>{i.getLogger(`esri.views.2d.layers.MediaLayerView2D`).error(new t(`element-load-error`,`Element cannot be displayed`,{element:n,error:e}))})),{debugGraphic:null,elementView:e,overlay:r,tiles:new Set}}).tiles.add(e)}_dereferenceElements(e,t){for(let n of t)this._dereferenceElement(e,n)}_dereferenceElement(e,t){let n=this._elementReferences.get(t.uid);n.tiles.delete(e),n.tiles.size||(this._overlayContainer.removeChild(n.overlay),n.overlay.destroy(),n.elementView.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),this._debugGraphicsView?.graphics.remove(n.debugGraphic))}_elementUpdateHandler(e){let t=this._elementReferences.get(e.uid);if(t){let n=t.elementView.normalizedCoords;if(n==null)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.elementView.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),void this._debugGraphicsView?.graphics.remove(t.debugGraphic);let r=[],i=[];for(let e of this._tileStrategy.tiles){let a=X(this.view.featuresTilingScheme,e,n);t.tiles.has(e)?a||i.push(e):a&&r.push(e)}for(let t of r)this._referenceElement(t,e);for(let t of i)this._dereferenceElement(t,e);t=this._elementReferences.get(e.uid),t?.debugGraphic&&(t.debugGraphic.geometry=t.elementView.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:`geometry`}));return}let n=new M({element:e,spatialReference:this.view.spatialReference}).normalizedCoords;if(n!=null)for(let t of this._tileStrategy.tiles)X(this.view.featuresTilingScheme,t,n)&&this._referenceElement(t,e)}};g([r()],q.prototype,`layer`,void 0),g([r({readOnly:!0})],q.prototype,`elements`,void 0),q=g([d(`esri.views.2d.layers.MediaLayerView2D`)],q);var J=b(),Y={xmin:0,ymin:0,xmax:0,ymax:0};function X(e,t,n){return e.getTileBounds(J,t.key,!0),Y.xmin=J[0],Y.ymin=J[1],Y.xmax=J[2],Y.ymax=J[3],c(Y,n)}var Z=class{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}setElements(e){let t=[],n=new Set(this.elements);this.elements=e;for(let r of e)n.has(r)?n.delete(r):t.push(r);return this.isReady=!0,[t,Array.from(n)]}destroy(){}},Q=q;export{Q as default};