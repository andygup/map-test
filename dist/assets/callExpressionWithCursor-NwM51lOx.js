import{En as e,Of as t,V_ as n,gn as r,pD as i,pn as a,uE as o,vn as s,vv as c,z_ as l}from"./index-CzMixifc.js";import{i as u,r as d}from"./memoryEstimations-C3WUBUZI.js";import{t as f}from"./OptimizedGeometry-5fDazGe-.js";import{i as p,n as m,r as h}from"./OptimizedFeatureSet-D4F9ObY_.js";import{_ as g,d as _,h as v,p as y,r as b,s as x,v as S}from"./featureConversionUtils-VvJ2pauf.js";import{a as C,o as w}from"./quantizationUtils-CzrQVcZ1.js";import{n as T,t as E}from"./labelPoint-D95l1mBc.js";var D=class e{static fromBuffer(t,n){return new e(t,n)}static create(t,n=4294967295){let r=new Uint32Array(Math.ceil(t/32));return new e(r,n)}constructor(e,t){this._mask=0,this._buf=e,this._mask=t}_getIndex(e){return Math.floor(e/32)}get usedMemory(){return d(this._buf)}has(e){let t=this._mask&e;return!!(this._buf[this._getIndex(t)]&1<<t%32)}hasRange(e,t){let n=e,r=t;for(;n%32&&n!==r;){if(this.has(n))return!0;n++}for(;r%32&&n!==r;){if(this.has(n))return!0;r--}if(n===r)return!1;for(let e=n/32;e!==r/32;e++)if(this._buf[e])return!0;return!1}set(e){let t=this._mask&e,n=this._getIndex(t),r=1<<t%32;this._buf[n]|=r}setRange(e,t){let n=e,r=t;for(;n%32&&n!==r;)this.set(n++);for(;r%32&&n!==r;)this.set(r--);if(n!==r)for(let e=n/32;e!==r/32;e++)this._buf[e]=4294967295}unset(e){let t=this._mask&e,n=this._getIndex(t),r=1<<t%32;this._buf[n]&=4294967295^r}resize(e){let t=this._buf,n=new Uint32Array(Math.ceil(e/32));n.set(t),this._buf=n}or(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=e._buf[t];return this}and(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=e._buf[t];return this}xor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=e._buf[t];return this}ior(e){for(let t=0;t<this._buf.length;t++)this._buf[t]|=~e._buf[t];return this}iand(e){for(let t=0;t<this._buf.length;t++)this._buf[t]&=~e._buf[t];return this}ixor(e){for(let t=0;t<this._buf.length;t++)this._buf[t]^=~e._buf[t];return this}any(){for(let e=0;e<this._buf.length;e++)if(this._buf[e])return!0;return!1}copy(e){for(let t=0;t<this._buf.length;t++)this._buf[t]=e._buf[t];return this}clone(){return new e(this._buf.slice(),this._mask)}clear(){for(let e=0;e<this._buf.length;e++)this._buf[e]=0;return this}forEachSet(e){for(let t=0;t<this._buf.length;t++){let n=this._buf[t],r=32*t;if(n)for(;n;)1&n&&e(r),n>>>=1,r++}}countSet(){let e=0;return this.forEachSet(t=>{e++}),e}},O=class{constructor(e){this._valid=D.create(e),this._data=Array(e)}get usedMemory(){let e=this._valid.usedMemory;if(this._data.length>0){let t=typeof this._data[0]==`string`?64:16;e+=this._data.length*t}return e}has(e){return this._valid.has(e)}set(e,t){this._valid.set(e),this._data[e]=t}get(e){return this._data[e]}},k=i(`featurelayer-simplify-thresholds`)??[.5,.5,.5,.5],A=k[0],j=k[1],M=k[2],N=k[3],P=i(`featurelayer-simplify-payload-size-factors`)??[1,2,4],F=P[0],I=P[1],L=P[2],R=i(`featurelayer-simplify-mobile-factor`)??2,z=i(`esri-mobile`),B=4294967295;function V(e,t,n){if(!(e.length>t))for(;e.length<=t;)e.push(n)}var H=class{constructor(e){this.metadata=e,this.type=`FeatureSetReader`,this._overrides=null,this._joined=[],this._objectIdToIndex=null,this._boundsBuffer=[],this._caches=new Map,this.arcadeDeclaredClass=`esri.arcade.Feature`,this._contextTimeZone=null}destroy(){}[Symbol.dispose](){this.destroy()}getAreaSimplificationThreshold(e,t){let n=1,r=z?R:1;t>4e6?n=L*r:t>1e6?n=I*r:t>5e5?n=F*r:t>1e5&&(n=r);let i=0;return e>4e3?i=N*n:e>2e3?i=M*n:e>100?i=j:e>15&&(i=A),i}getBounds(e){V(this._boundsBuffer,4*this.getIndex()+4,0);let n=this.getBoundsXMin();if(n===B||!isFinite(n))return!1;if(this.getBoundsXMin()===0){let n=this.readGeometryWorldSpace();if(n?.isPoint&&n.coords[0]===0&&n.coords[1]===0)return t(e,0,0,0,0),!0;if(!n)return this.setBoundsXMin(B),!1;let r=1/0,i=1/0,a=-1/0,o=-1/0;return n.forEachVertex((e,t)=>{r=Math.min(r,e),i=Math.min(i,t),a=Math.max(a,e),o=Math.max(o,t)}),this.setBoundsXMin(r),this.setBoundsYMin(i),this.setBoundsXMax(a),this.setBoundsYMax(o),t(e,r,i,a,o),!0}let r=this.getBoundsXMin(),i=this.getBoundsYMin(),a=this.getBoundsXMax(),o=this.getBoundsYMax();return t(e,r,i,a,o),!0}getBoundsXMin(){return this._boundsBuffer[4*this.getIndex()]}setBoundsXMin(e){this._boundsBuffer[4*this.getIndex()]=e}getBoundsYMin(){return this._boundsBuffer[4*this.getIndex()+1]}setBoundsYMin(e){this._boundsBuffer[4*this.getIndex()+1]=e}getBoundsXMax(){return this._boundsBuffer[4*this.getIndex()+2]}setBoundsXMax(e){this._boundsBuffer[4*this.getIndex()+2]=e}getBoundsYMax(){return this._boundsBuffer[4*this.getIndex()+3]}setBoundsYMax(e){this._boundsBuffer[4*this.getIndex()+3]=e}readAttributeAsTimestamp(e){let t=this.readAttribute(e);return typeof t==`string`?new Date(t).getTime():typeof t==`number`||t==null?t:null}readAttribute(e,t=!1){let n=this._readAttribute(e,t);if(n!==void 0)return n;for(let n of this._joined){n.setIndex(this.getIndex());let r=n._readAttribute(e,t);if(r!==void 0)return r}}readAttributes(){let e=this._readAttributes();for(let t of this._joined){t.setIndex(this.getIndex());let n=t._readAttributes();for(let t of Object.keys(n))e[t]=n[t]}return e}joinAttributes(e){this._joined.push(e)}registerOverrides(e){this._overrides=e}withoutOverrides(){let e=this.copy();return e._overrides=null,e}readOptimizedFeatureWorldSpace(){let e=this.readGeometryWorldSpace(),t=this.readAttributes(),n=this.readCentroidWorldSpace();return new m(e,t,n,this.getObjectId(),this.getDisplayId())}readLegacyFeatureForDisplay(){let e=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null}}readLegacyFeatureWorldSpace(){let e=this.readCentroidWorldSpace();return{attributes:this.readAttributes(),geometry:this._readLegacyGeometryWorldSpace(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null}}readLegacyGeometryForDisplay(){let e=this.readGeometryForDisplay();return x(e,this.geometryType,!1,!1)}readXForDisplay(){return this._readX()}readYForDisplay(){return this._readY()}readXWorldSpace(){let e=this._readX(),t=this.getInTransform();return t==null?e:e*t.scale[0]+t.translate[0]}readYWorldSpace(){let e=this._readY(),t=this.getInTransform();return t==null?e:t.translate[1]-e*t.scale[1]}readGeometryForDisplay(){let e=this._readGeometryDeltaDecoded(!0);if(!e){let e=this._createDeltaQuantizedGeometryFromServerCentroid();return e?e.deltaDecode():null}return e}readGeometryForDisplayTransformed(e){let t=this.readGeometryForDisplay();if(t&&this.metadata.geometryType===`esriGeometryPolyline`&&(t=S(t,this.metadata.geometryType,e.scale[0])),t&&=g(t,e,this.metadata.geometryType),!t){let t=this.readCentroidForDisplay();if(!t)return null;let n=w(e,t.coords[0]),r=C(e,t.coords[1]);return this._createDeltaQuantizedExtrudedGeometry(n,r).deltaDecode()}return t}readGeometryWorldSpace(){let e=this._readGeometry();if(e||=this._createDeltaQuantizedGeometryFromServerCentroid(),!e)return null;let t=e.clone(),n=this.getInTransform();return n!=null&&v(t,n),t}readCentroidForDisplay(){let e=this.readGeometryForDisplay();return e?this._computeDisplayCentroid(e):this._readServerCentroid()}readCentroidWorldSpace(){let e=this.readGeometryForDisplay(),t=e?this._computeDisplayCentroid(e):this._readServerCentroid();if(!t)return null;let n=t.clone(),r=this.getInTransform();return r!=null&&v(n,r),n}setCache(e){let t=this._caches.get(e);t??(t=new O(this.getSize()),this._caches.set(e,t)),this._activeCache=t}setCachedValue(e){this._activeCache.set(this.getIndex(),e)}hasCachedValue(){return this._activeCache.has(this.getIndex())}getCachedValue(){return this._activeCache.get(this.getIndex())}get underlyingMemory(){let e=0;e+=d(this._boundsBuffer);for(let t of this._caches.values())e+=t.usedMemory;return e}_readGeometryDeltaDecoded(e){let t=this._readGeometry(e);return this.geometryType!==`esriGeometryPoint`&&t&&this.getInTransform()?t.deltaDecode():t}get contextTimeZone(){return this._contextTimeZone}set contextTimeZone(e){this._contextTimeZone=e}readArcadeFeature(){return this}hasField(e){return this.fields.has(e)||this._joined.some(t=>t.hasField(e))}geometry(){let e=this.readGeometryWorldSpace(),t=x(e,this.geometryType,this.hasZ,this.hasM),n=c(t);if(n){if(!this.metadata.outSpatialReference)throw Error(`InternalError: Expected spatial reference to be defined`);n.spatialReference=this.metadata.outSpatialReference}return n}autocastArcadeDate(e,t){return t&&t instanceof Date?this.isUnknownDateTimeField(e)?s.unknownDateJSToArcadeDate(t):s.dateJSAndZoneToArcadeDate(t,this.contextTimeZone??`system`):t}isUnknownDateTimeField(e){return this.metadata.fieldsIndex.getTimeZone(e)===n}field(e){let t=this.fields.get(e);if(t)switch(t.type){case`date-only`:case`esriFieldTypeDateOnly`:return r.fromReader(this.readAttribute(e,!1));case`time-only`:case`esriFieldTypeTimeOnly`:return a.fromReader(this.readAttribute(e,!1));case`esriFieldTypeTimestampOffset`:case`timestamp-offset`:return s.fromReaderAsTimeStampOffset(this.readAttribute(e,!1));case`date`:case`esriFieldTypeDate`:return this.autocastArcadeDate(e,this.readAttribute(e,!0));default:return this.readAttribute(e,!1)}for(let n of this._joined)if(n.setIndex(this.getIndex()),t=n.fields.get(e),t)switch(t.type){case`date-only`:case`esriFieldTypeDateOnly`:return r.fromReader(n._readAttribute(e,!1));case`time-only`:case`esriFieldTypeTimeOnly`:return a.fromReader(n._readAttribute(e,!1));case`esriFieldTypeTimestampOffset`:case`timestamp-offset`:return s.fromReaderAsTimeStampOffset(n._readAttribute(e,!1));case`date`:case`esriFieldTypeDate`:return this.autocastArcadeDate(e,n._readAttribute(e,!0));default:return this.readAttribute(e,!1)}throw Error(`Field ${e} does not exist`)}setField(e,t){throw Error(`Unable to update feature attribute values, feature is readonly`)}keys(){return this.fields.fields.map(e=>e.name)}isEmpty(){return this.fields.fields.length<=0&&this.geometry()==null}castToText(e=!1){if(!e)return JSON.stringify(this.readLegacyFeatureForDisplay());let t=this.readLegacyFeatureForDisplay();if(!t)return JSON.stringify(null);let n={geometry:t.geometry,attributes:{...t.attributes}};for(let e in n.attributes){let t=n.attributes[e];t instanceof Date&&(n.attributes[e]=t.getTime())}return JSON.stringify(n)}gdbVersion(){return null}fullSchema(){return this.metadata.arcadeSchema}castAsJson(e=null){return{attributes:this._readAttributes(),geometry:!0===e?.keepGeometryType?this.geometry():this.geometry()?.toJSON()??null}}castAsJsonAsync(e=null,t=null){return Promise.resolve(this.castAsJson(t))}_getExists(){if(this._overrides){let e=this.getObjectId();return!this._overrides.hasOverride(e)}return!0}_computeDisplayCentroid(e){if(this.getInTransform()==null)return p(e);let t=T.fromOptimized(e,this.geometryType);t.yFactor*=-1;let n=E(t);return n?(n[1]*=-1,new f([],n)):null}copyInto(e){e._joined=this._joined,e._overrides=this._overrides,e._objectIdToIndex=this._objectIdToIndex,e._boundsBuffer=this._boundsBuffer,e._activeCache=this._activeCache,e._caches=this._caches,e._contextTimeZone=this._contextTimeZone}_readLegacyGeometryWorldSpace(){let e=this.readGeometryWorldSpace();return x(e,this.geometryType,!1,!1)}_createDeltaQuantizedGeometryFromServerCentroid(){let e=this._readServerCentroid();if(!e)return null;let[t,n]=e.coords;return this._createDeltaQuantizedExtrudedGeometry(t,n)}_createDeltaQuantizedExtrudedGeometry(e,t){return this.geometryType===`esriGeometryPolyline`?this._createDeltaQuantizedExtrudedLine(e,t):this._createDeltaQuantizedExtrudedQuad(e,t)}_createDeltaQuantizedExtrudedQuad(e,t){return new f([5],[e-1,t,1,-1,1,1,-1,1,-1,-1])}_createDeltaQuantizedExtrudedLine(e,t){return new f([2],[e-1,t+1,1,-1])}},U=class t extends H{static fromFeatures(e,n){let{geometryType:r}=n,i=b([],e,r,!1,!1,n.featureIdInfo);for(let t=0;t<i.length;t++)i[t].displayId=e[t].displayId;return t.fromOptimizedFeatures(i,n)}static fromFeatureSet(e,n){let r=_(e,n.featureIdInfo);return t.fromOptimizedFeatureSet(r,n)}static fromOptimizedFeatureSet(n,r){let i=t.fromOptimizedFeatures(n.features,r);return i._exceededTransferLimit=n.exceededTransferLimit,i._transform=n.transform,i._fieldsIndex=new e(n.fields),i}static fromOptimizedFeatures(e,n,r){let i=new t(e,n);return i._fieldsIndex=n.fieldsIndex,i._transform=r,i}static empty(e){return new t([],e)}constructor(e,t){super(t),this._exceededTransferLimit=!1,this._featureIndex=-1,this._fieldsIndex=null,this._geometryType=t.geometryType,this._features=e}get fields(){return this._fieldsIndex}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}get _current(){return this._features[this._featureIndex]}get usedMemory(){return this._current.usedMemory}getSize(){return this._features.length}getCursor(){return this.copy()}getInTransform(){return this._transform}getAttributeHash(){let e=``;for(let t in this._current.attributes)e+=this._current.attributes[t];return e}getIndex(){return this._featureIndex}setIndex(e){this._featureIndex=e}getObjectId(){return this._current?.objectId}getDisplayId(){return this._current.displayId}setDisplayId(e){this._current.displayId=e}copy(){let e=new t(this._features,this.metadata);return this.copyInto(e),e}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readGeometryArea(){return h(this._current)?y(this._current.geometry,2):0}_readX(){return h(this._current)?this._current.geometry.coords[0]:0}_readY(){return h(this._current)?this._current.geometry.coords[1]:0}_readGeometry(){return h(this._current)?this._current.geometry??null:null}_readServerCentroid(){return this._current.centroid}_readAttribute(e,t){if(!this._fieldsIndex){let t=this._current.attributes[e];if(t!==void 0)return t;let n=e.toLowerCase();for(let e in this._current.attributes)if(e.toLowerCase()===n)return this._current.attributes[e];return}let n=this._fieldsIndex.get(e);if(!n)return;let r=this._current.attributes[n.name];return r==null?r:t&&this.fields.isDateField(e)?new Date(r):r}_readAttributes(){return this._current.attributes}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._transform=this._transform,e._fieldsIndex=this._fieldsIndex}},W=class e{static{this.Shared=new e}getObjectId(e){return e.getObjectId()}getAttributes(e){return e.readAttributes()}getAttribute(e,t){return e.readAttribute(t)}getAttributeAsTimestamp(e,t){return e.readAttributeAsTimestamp(t)}cloneWithGeometry(e,t){let n=e.readAttributes(),r=new m(t,n,null,e.getObjectId(),e.getDisplayId()),i=U.fromOptimizedFeatures([r],e.metadata);return i.setIndex(0),i}getGeometry(e){return e.readGeometryWorldSpace()}getCentroid(e,t){return e.readCentroidForDisplay()}};function G(e,t,n){if(e==null)return null;let r=t.readArcadeFeature();t.contextTimeZone=n.$view?.timeZone;try{return e.evaluate(r,n)}catch(e){return o.getLogger(`esri.views.2d.support.arcadeOnDemand`).warn(`Feature arcade evaluation failed:`,e),null}}function K(e){return e==null||e===1/0||e===-1/0||typeof e==`number`&&isNaN(e)}function q(e,t,n,r){if(e==null)return r??null;let i=t.readArcadeFeature();t.contextTimeZone=n.$view?.timeZone;let a=e.evaluate(i,n);return K(a)?r??null:a}export{U as a,D as c,W as i,K as n,H as o,q as r,O as s,G as t};