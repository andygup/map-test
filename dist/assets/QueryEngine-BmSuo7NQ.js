const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/geometryEngineJSON-CtIlC0SL.js","assets/_commonjsHelpers-BCEO1LKV.js","assets/geometryEngineBase-BrM_fHSa.js"])))=>i.map(i=>d[i]);
import{$v as e,BS as t,BT as n,B_ as r,Bl as i,Bx as a,Cv as o,Dg as s,Ef as c,En as l,HC as u,I_ as d,Mv as f,Op as p,Pv as m,Qv as h,SE as g,Sv as _,Up as v,Vp as y,ZE as b,Zb as x,Zw as S,_S as C,af as ee,bf as te,cD as ne,dD as w,dd as T,du as re,eT as ie,ey as ae,gp as oe,hp as E,lf as se,pT as ce,tx as le,vT as ue,vv as de,yS as D,zp as O}from"./index-CZ4oMP1N.js";import{a as fe}from"./featureConversionUtils-_DSSMFQ2.js";import{t as pe}from"./WhereClauseCache-Hc_hnaJ1.js";import{n as me}from"./QueryEngineCapabilities-BJYIHckU.js";import{a as k,c as he,d as A,f as ge,g as j,h as M,i as _e,m as ve,n as ye,o as be,r as xe,s as Se,t as Ce,u as we,v as Te}from"./utils-DD8h9sO0.js";import{a as N,c as P,i as F,n as Ee,o as I,r as L,s as R,t as De}from"./timeSupport-DTr00ezP.js";import{a as Oe,c as z,i as B,l as V,o as ke,r as H,s as Ae,t as U}from"./queryUtils-DcyDFw5_.js";import{c as je}from"./quantizationUtils-CGy9nkLl.js";import{s as Me}from"./utils-DfE5TL5h.js";import{n as Ne,t as Pe}from"./SnappingCandidate-CSwuQTV6.js";import{a as Fe,i as Ie,n as Le,r as Re,t as ze}from"./FixedIntervalBinParameters-Dvwocz3j.js";var Be=new pe(50,500),W=`unsupported-query`,Ve=` as `,He=new Set([`esriFieldTypeOID`,`esriFieldTypeSmallInteger`,`esriFieldTypeBigInteger`,`esriFieldTypeInteger`,`esriFieldTypeSingle`,`esriFieldTypeDouble`,`esriFieldTypeLong`]),Ue=new Set([`esriFieldTypeDate`,`esriFieldTypeDateOnly`,`esriFieldTypeTimeOnly`,`esriFieldTypeTimestampOffset`]),We=new Set([`esriFieldTypeString`,`esriFieldTypeGUID`,`esriFieldTypeGlobalID`,...He,...Ue]);function G(e,t,r={}){let i=K(t,e);if(!i){let r=Be.getError(t,e);throw new n(W,`invalid SQL expression`,{expression:t,error:r})}let a=r.expressionName||`expression`;if(r.validateStandardized&&!i.isStandardized)throw new n(W,`${a} is not standard`,{expression:t});if(r.validateAggregate&&!i.isAggregate)throw new n(W,`${a} does not contain a valid aggregate function`,{expression:t});return i.fieldNames}function Ge(e,t,n,r){if(!n)return!0;let i=`where clause`;return q(e,t,G(e,n,{validateStandardized:!0,expressionName:i}),{expressionName:i,query:r}),!0}function Ke(e,t,r,i,a){if(!r)return!0;let o=`having clause`,s=G(e,r,{validateAggregate:!0,expressionName:o});if(q(e,t,s,{expressionName:o,query:a}),!K(r,e)?.getExpressions().every(t=>{let{aggregateType:n,field:r}=t,a=e.get(r)?.name;return i.some(t=>{let{onStatisticField:r,statisticType:i}=t;return e.get(r)?.name===a&&i.toLowerCase().trim()===n})}))throw new n(W,`expressions in having clause should also exist in outStatistics`,{having:r});return!0}function K(e,t){return e?Be.get(e,t):null}function qe(e){return/\((.*?)\)/.test(e)?e:e.split(Ve)[0]}function Je(e){return e.split(Ve)[1]}function q(e,t,r,i={}){let a=new Map;if(Ye(a,e,t,i.allowedFieldTypes??We,r),a.size){let e=i.expressionName??`expression`;throw new n(W,`${e} contains invalid or missing fields`,{errors:Array.from(a.values()),query:i.query})}}function Ye(e,t,n,r,i){let a=i.includes(`*`)?[...n,...i.filter(e=>e!==`*`)]:i;for(let i of a)if(t.get(i))Xe(e,t,n,r,i);else try{let a=G(t,qe(i),{validateStandardized:!0});for(let i of a)Xe(e,t,n,r,i)}catch(t){e.set(i,{type:`expression-error`,expression:i,error:t})}}function Xe(e,t,n,r,i){let a=t.get(i);a?n.has(a.name)?r!==`all`&&!1===r?.has(a.type)&&e.set(i,{type:`invalid-type`,fieldName:a.name,fieldType:T.fromJSON(a.type),allowedFieldTypes:Array.from(r,e=>T.fromJSON(e))}):e.set(i,{type:`missing-field`,fieldName:a.name}):e.set(i,{type:`invalid-field`,fieldName:i})}var Ze=5,Qe=class{constructor(){this._storage=new Map,this._purgeInterval=Ze,this._sweep=()=>{if(this._timer=void 0,!this._storage)return;let e=1e3*this._purgeInterval,t=performance.now()-e;for(let[n,r]of this._storage){if(!(r.time<t))return void(this._storage.size>0&&(this._timer=setTimeout(this._sweep,e)));this._storage.delete(n)}}}destroy(){this._storage?.clear(),this._storage=null,clearTimeout(this._timer)}put(e,t){this._storage?.set(e,new et(t)),this._scheduleSweep()}get(e){let t=this._storage?.get(e);if(t)return this._storage?.delete(e),t.time=performance.now(),this._storage?.set(e,t),t.items}clear(){this._storage?.clear()}_scheduleSweep(){this._storage&&(this._timer??=setTimeout(this._sweep,1e3*this._purgeInterval))}get test(){}},$e=0,et=class{constructor(e){this.items=e,this.time=performance.now(),this.id=$e++}},J=class{constructor(e,t,n){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=e.returnDistinctValues??!1,this.fieldsIndex=n,this.featureAdapter=t;let r=e.outFields;if(r&&!r.includes(`*`)){this.outFields=r;let e=0;for(let t of r){let r=qe(t),i=this.fieldsIndex.get(r),a=i?null:K(r,n),o=i?i.name:Je(t)||`FIELD_EXP_`+ e++;this._fieldDataCache.set(t,{alias:o,clause:a})}}}countDistinctValues(e){return this.returnDistinctValues?(e.forEach(e=>this.getAttributes(e)),this._returnDistinctMap.size):e.length}getAttributes(e){let t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}getFieldValue(e,t,n){if(n)return this.featureAdapter.getAttribute(e,n.name);let r=t,i=null;return this._fieldDataCache.has(r)?i=this._fieldDataCache.get(r)?.clause:n||(i=K(t,this.fieldsIndex),this._fieldDataCache.set(r,{alias:r,clause:i})),i?.calculateValue(e,this.featureAdapter)}getDataValues(e,t,n=!0){let r=t.normalizationType,i=t.normalizationTotal,a=this.fieldsIndex.get(t.field),o=p(a)||O(a),s=y(a);return e.map(e=>{let a=t.field&&this.getFieldValue(e,t.field,this.fieldsIndex.get(t.field));if(t.field2?(a=`${M(a)}${t.fieldDelimiter}${M(this.getFieldValue(e,t.field2,this.fieldsIndex.get(t.field2)))}`,t.field3&&(a=`${a}${t.fieldDelimiter}${M(this.getFieldValue(e,t.field3,this.fieldsIndex.get(t.field3)))}`)):typeof a==`string`&&n&&(o?a=a?new Date(a).getTime():null:s&&(a=a?Me(a):null)),r&&Number.isFinite(a)){let n=r===`field`&&t.normalizationField?this.getFieldValue(e,t.normalizationField,this.fieldsIndex.get(t.normalizationField)):null;a=ye(a,r,n,i)}return a})}async getExpressionValues(e,t,n,r,i){let{arcadeUtils:a}=await v(),o=a.hasGeometryOperations(t);o&&await a.enableGeometryOperations();let s=a.createFunction(t),c=a.getViewInfo(n),l={fields:this.fieldsIndex.fields};return e.map(e=>{let t={attributes:this.featureAdapter.getAttributes(e),layer:l,geometry:o?{...I(r.geometryType,this.featureAdapter.getGeometry(e)),spatialReference:n?.spatialReference}:null},u=a.createExecContext(t,c,i);return a.executeFunction(s,u)})}validateItem(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:K(t,this.fieldsIndex)}),this._fieldDataCache.get(t)?.clause?.testFeature(e,this.featureAdapter)??!1}validateItems(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:K(t,this.fieldsIndex)}),this._fieldDataCache.get(t)?.clause?.testSet(e,this.featureAdapter)??!1}_processAttributesForOutFields(e){let t=this.outFields;if(!t?.length)return this.featureAdapter.getAttributes(e);let n={};for(let r of t){let{alias:t,clause:i}=this._fieldDataCache.get(r);n[t]=i?i.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,t)}return n}_processAttributesForDistinctValues(e){if(e==null||!this.returnDistinctValues)return e;let t=this.outFields,n=[];if(t)for(let r of t){let{alias:t}=this._fieldDataCache.get(r);n.push(e[t])}else for(let t in e)n.push(e[t]);let r=`${(t||[`*`]).join(`,`)}=${n.join(`,`)}`,i=this._returnDistinctMap.get(r)||0;return this._returnDistinctMap.set(r,++i),i>1?null:e}},Y=`bin`,X=class{constructor(e,t,n){this.items=e,this.query=t,this.geometryType=n.geometryType,this.hasM=n.hasM,this.hasZ=n.hasZ,this.fieldsIndex=n.fieldsIndex,this.objectIdField=n.objectIdField,this.spatialReference=n.spatialReference,this.featureAdapter=n.featureAdapter}get size(){return this.items.length}createQueryResponseForCount(){let e=new J(this.query,this.featureAdapter,this.fieldsIndex);if(!this.query.outStatistics)return e.countDistinctValues(this.items);let{groupByFieldsForStatistics:t,having:n,outStatistics:r}=this.query;if(!t?.length)return 1;let i=new Map,a=new Map,o=new Set;for(let s of r){let{statisticType:r}=s,c=r===`exceedslimit`?void 0:s.onStatisticField;if(!a.has(c)){let n=[];for(let r of t){let t=this._getAttributeValues(e,r,this.items,i);n.push(t)}a.set(c,this._calculateUniqueValues(n,this.items,e.returnDistinctValues))}let l=a.get(c);for(let t in l){let{data:r,items:i}=l[t],a=r.join(`,`);n&&!e.validateItems(i,n)||o.add(a)}}return o.size}async createQueryResponse(){let e;if(e=this.query.outStatistics?this.query.outStatistics.some(e=>e.statisticType===`exceedslimit`)?this._createExceedsLimitQueryResponse():await this._createStatisticsQueryResponse(this.query,this.items):this._createFeatureQueryResponse(this.query),this.query.returnQueryGeometry){let t=this.query.geometry;D(this.query.outSR)&&!C(t.spatialReference,this.query.outSR)?e.queryGeometry=P({spatialReference:this.query.outSR,...V(t,t.spatialReference,this.query.outSR)}):e.queryGeometry=P({spatialReference:this.query.outSR,...t})}return e}createSnappingResponse(e,t,n){let r=this.featureAdapter,i=nt(this.hasZ,this.hasM),{point:a,mode:o}=e,s=typeof e.distance==`number`?e.distance:e.distance.x,c=typeof e.distance==`number`?e.distance:e.distance.y,l={candidates:[]},u=this.geometryType===`esriGeometryPolygon`,d=this.geometryType===`esriGeometryPolyline`||this.geometryType===`esriGeometryPoint`,f=this._getPointCreator(o,t,this.spatialReference,n),p=new rt(null,0),m=new rt(null,0),h={x:0,y:0,z:0};for(let t of this.items){let n=r.getGeometry(t);if(n==null)continue;let{coords:o}=n,g=n.isPoint?it:n.lengths;if(p.coords=o,m.coords=o,e.returnEdge){let e=0;for(let n=0;n<g.length;n++){let o=g[n],d=e;for(let n=0;n<o;n++,e+=i){if(!u&&n===o-1)continue;let g=p;g.coordsIndex=e;let _=m;_.coordsIndex=n===o-1?d:e+i;let v=h;if(!tt(h,a,g,_))continue;let y=(a.x-v.x)/s,b=(a.y-v.y)/c,x=y*y+b*b;x<=1&&l.candidates.push(new Pe(r.getObjectId(t),f(v),Math.sqrt(x),f(g),f(_)))}}}if(e.vertexMode===`all`){let e=0;for(let n=0;n<g.length;n++){let o=g[n],d=e,h=m;h.coordsIndex=d;for(let n=0;n<o;n++,e+=i){let i=p;if(i.coordsIndex=e,u&&n===o-1&&i.x===h.x&&i.y===h.y)continue;let d=(a.x-i.x)/s,m=(a.y-i.y)/c,g=d*d+m*m;g<=1&&l.candidates.push(new Ne(r.getObjectId(t),f(i),Math.sqrt(g)))}}}else if(d&&e.vertexMode===`ends`){let e=0,n=[];for(let t=0;t<g.length;t++){n.push(e);let r=g[t];e+=r*i,!u&&r>1&&n.push(e-i)}for(let e of n){let n=p;n.coordsIndex=e;let i=(a.x-n.x)/s,o=(a.y-n.y)/c,u=i*i+o*o;u<=1&&l.candidates.push(new Ne(r.getObjectId(t),f(n),Math.sqrt(u)))}}}return l.candidates.sort((e,t)=>e.distance-t.distance),l}_getPointCreator(e,t,n,r){let i=r==null||C(n,r)?e=>e:e=>V(e,n,r),{hasZ:a}=this;return e===`3d`?a&&t?({x:e,y:t,z:n})=>i({x:e,y:t,z:n}):({x:e,y:t})=>i({x:e,y:t,z:0}):({x:e,y:t})=>i({x:e,y:t})}async createSummaryStatisticsResponse(e){let{field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,minValue:o,maxValue:s,scale:c,timeZone:l,outStatisticTypes:u}=e,d=this.fieldsIndex.get(t),f=oe(d)||p(d)||O(d),m=await this._getDataValues({field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,scale:c,timeZone:l},this.items),h=we({normalizationType:i,normalizationField:r,minValue:o,maxValue:s}),g={value:.5,fieldType:d?.type},_=E(d)?A({values:m,supportsNullCount:h,percentileParams:g,outStatisticTypes:u}):j({values:m,minValue:o,maxValue:s,useSampleStdDev:!i,supportsNullCount:h,percentileParams:g,outStatisticTypes:u});return xe(_,u,f)}async createUniqueValuesResponse(e){let{field:t,valueExpression:n,domains:r,returnAllCodedValues:i,scale:a,timeZone:o}=e,s=await this._getDataValues({field:t,field2:e.field2,field3:e.field3,fieldDelimiter:e.fieldDelimiter,valueExpression:n,scale:a,timeZone:o},this.items,!1),c=ve(s);return Ce(c,r,i,e.fieldDelimiter)}async createClassBreaksResponse(e){let{field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:s,minValue:c,maxValue:l,numClasses:u,scale:d,timeZone:f}=e,p=await this._getDataValues({field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,scale:d,timeZone:f},this.items),m=_e(p,{field:t,normalizationField:r,normalizationType:i,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:s,minValue:c,maxValue:l,numClasses:u});return Se(m,o)}async createHistogramResponse(e){let{field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:s,minValue:c,maxValue:l,numBins:u,scale:d,timeZone:f}=e,p=await this._getDataValues({field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,scale:d,timeZone:f},this.items);return he(p,{field:t,normalizationField:r,normalizationType:i,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:s,minValue:c,maxValue:l,numBins:u})}_sortFeatures(e,t,n){if(e.length>1&&t?.length)for(let r of t.slice().reverse()){let t=r.split(` `),i=t[0],a=this.fieldsIndex.get(i),o=!!t[1]&&t[1].toLowerCase()===`desc`,s=ge(a?.type,o,`case-sensitive`);e.sort((e,t)=>{let r=n(e,i,a),o=n(t,i,a);return s(r,o)})}}_createFeatureQueryResponse(e){let{items:t,geometryType:n,hasM:r,hasZ:i,objectIdField:a,spatialReference:o}=this,{outFields:s,outSR:c,quantizationParameters:l,resultRecordCount:u,resultOffset:d,returnZ:f,returnM:p}=e,m=u!=null&&t.length>(d||0)+u,h=s&&(s.includes(`*`)?[...this.fieldsIndex.fields]:s.map(e=>this.fieldsIndex.get(e)));return{exceededTransferLimit:m,features:this._createFeatures(e,t),fields:h,geometryType:n,hasM:r&&p,hasZ:i&&f,objectIdFieldName:a,spatialReference:P(c||o),transform:l&&je(l)||null}}_createFeatures(e,t){let n=new J(e,this.featureAdapter,this.fieldsIndex),{hasM:r,hasZ:i}=this,{orderByFields:a,quantizationParameters:o,returnGeometry:s,returnCentroid:c,maxAllowableOffset:l,resultOffset:u,resultRecordCount:d,returnZ:f=!1,returnM:p=!1}=e,m=i&&f,h=r&&p,g=[],_=0,v=[...t];if(this._sortFeatures(v,a,(e,t,r)=>n.getFieldValue(e,t,r)),this.geometryType&&(s||c)){let e=je(o)??void 0,t=this.geometryType===`esriGeometryPolygon`||this.geometryType===`esriGeometryPolyline`;if(s&&!c)for(let r of v){let i=this.featureAdapter.getGeometry(r),a=this._addFeatureJSONMetadata(r,{attributes:n.getAttributes(r),geometry:I(this.geometryType,i,l,e,m,h)});t&&i&&!a.geometry&&(a.centroid=R(this,this.featureAdapter.getCentroid(r,this),e)),g[_++]=a}else if(!s&&c)for(let t of v)g[_++]=this._addFeatureJSONMetadata(t,{attributes:n.getAttributes(t),centroid:R(this,this.featureAdapter.getCentroid(t,this),e)});else for(let t of v)g[_++]=this._addFeatureJSONMetadata(t,{attributes:n.getAttributes(t),centroid:R(this,this.featureAdapter.getCentroid(t,this),e),geometry:I(this.geometryType,this.featureAdapter.getGeometry(t),l,e,m,h)})}else for(let e of v){let t=n.getAttributes(e);t&&(g[_++]=this._addFeatureJSONMetadata(e,{attributes:t}))}let y=u||0;if(d!=null){let e=y+d;g=g.slice(y,Math.min(g.length,e))}return g}_addFeatureJSONMetadata(e,t){let n=this.featureAdapter.getMetadata?.(e);return n!==void 0&&(t.metadata=n),t}_createExceedsLimitQueryResponse(){let e=!1,t=1/0,n=1/0,r=1/0;for(let e of this.query.outStatistics??[])if(e.statisticType===`exceedslimit`){t=e.maxPointCount==null?1/0:e.maxPointCount,n=e.maxRecordCount==null?1/0:e.maxRecordCount,r=e.maxVertexCount==null?1/0:e.maxVertexCount;break}if(this.geometryType===`esriGeometryPoint`)e=this.items.length>t;else if(this.items.length>n)e=!0;else{let t=nt(this.hasZ,this.hasM),n=this.featureAdapter;e=this.items.reduce((e,t)=>{let r=n.getGeometry(t);return e+(r!=null&&r.coords.length||0)},0)/t>r}return{fields:[{name:`exceedslimit`,type:`esriFieldTypeInteger`,alias:`exceedslimit`,sqlType:`sqlTypeInteger`,domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(e)}}]}}async _createStatisticsQueryResponse(e,t,n={attributes:{}}){let r=[],i=new Map,a=new Map,o=new Map,s=new Map,c=new J(e,this.featureAdapter,this.fieldsIndex),l=e.outStatistics,{groupByFieldsForStatistics:u,having:d,orderByFields:f,resultRecordCount:p}=e,m=u?.length,h=!!m,g=h?u[0]:null,_=h&&!this.fieldsIndex.get(g);for(let e of l??[]){let{outStatisticFieldName:l,statisticType:f}=e,p=e,v=f===`exceedslimit`?void 0:e.onStatisticField,y=f===`percentile_disc`||f===`percentile_cont`,b=f===`EnvelopeAggregate`||f===`CentroidAggregate`||f===`ConvexHullAggregate`,x=h&&m===1&&(v===g||_)&&f===`count`;if(h){if(!o.has(v)){let e=[];for(let n of u){let r=this._getAttributeValues(c,n,t,i);e.push(r)}o.set(v,this._calculateUniqueValues(e,t,!b&&c.returnDistinctValues))}let e=o.get(v);if(!e)continue;let n=Object.keys(e);for(let r of n){let{count:n,data:a,items:o,itemPositions:f}=e[r],m=a.join(`,`);if(!d||c.validateItems(o,d)){let e=s.get(m)||{attributes:{}};if(b){e.aggregateGeometries||={};let{aggregateGeometries:t,outStatisticFieldName:n}=await this._getAggregateGeometry(p,o);e.aggregateGeometries[n]=t}else{let r=null;if(x)r=n;else{let e=this._getAttributeValues(c,v,t,i),n=f.map(t=>e[t]);r=y&&`statisticParameters`in p?this._getPercentileValue(p,n):this._getStatisticValue(p,n,null,c.returnDistinctValues)}e.attributes[l]=r}let r=0;u.forEach((t,n)=>e.attributes[this.fieldsIndex.get(t)?t:`EXPR_`+ ++r]=a[n]),s.set(m,e)}}}else if(b){n.aggregateGeometries||={};let{aggregateGeometries:e,outStatisticFieldName:r}=await this._getAggregateGeometry(p,t);n.aggregateGeometries[r]=e}else{let e=this._getAttributeValues(c,v,t,i);n.attributes[l]=y&&`statisticParameters`in p?this._getPercentileValue(p,e):this._getStatisticValue(p,e,a,c.returnDistinctValues)}let S=f!==`min`&&f!==`max`||!E(this.fieldsIndex.get(v))&&!this._isAnyDateField(v)?null:this.fieldsIndex.get(v)?.type;r.push({name:l,alias:l,type:S||`esriFieldTypeDouble`})}let v=h?Array.from(s.values()):[n];return this._sortFeatures(v,f,(e,t)=>e.attributes[t]),p&&(v.length=Math.min(p,v.length)),{fields:r,features:v}}_isAnyDateField(e){let t=this.fieldsIndex.get(e);return oe(t)||p(t)||O(t)||y(t)}async _getAggregateGeometry(n,r){let{convexHull:i,union:a}=await t(async()=>{let{convexHull:e,union:t}=await import(`./geometryEngineJSON-CtIlC0SL.js`);return{convexHull:e,union:t}},__vite__mapDeps([0,1,2])),{statisticType:o,outStatisticFieldName:s}=n,{featureAdapter:c,spatialReference:l,geometryType:u}=this,d=r.map(e=>I(u,c.getGeometry(e))),p=i(l,d,!0)[0],g={aggregateGeometries:null,outStatisticFieldName:null};if(o===`EnvelopeAggregate`)g.aggregateGeometries={...p?h(p):e(a(l,d)),spatialReference:l},g.outStatisticFieldName=s||`extent`;else if(o===`CentroidAggregate`){let t=p?f(p):m(e(a(l,d)));g.aggregateGeometries={x:t[0],y:t[1],spatialReference:l},g.outStatisticFieldName=s||`centroid`}else o===`ConvexHullAggregate`&&(g.aggregateGeometries=p,g.outStatisticFieldName=s||`convexHull`);return g}_getStatisticValue(e,t,n,r){let{onStatisticField:i,statisticType:a}=e,o=null;return o=n?.has(i)?n.get(i):E(this.fieldsIndex.get(i))||this._isAnyDateField(i)?A({values:t,returnDistinct:r}):j({values:r?[...new Set(t)]:t,minValue:null,maxValue:null,useSampleStdDev:!0}),n&&n.set(i,o),o[a===`var`?`variance`:a]}_getPercentileValue(e,t){let{onStatisticField:n,statisticParameters:r,statisticType:i}=e,{value:a,orderBy:o}=r,s=this.fieldsIndex.get(n);return Te(t,{value:a,orderBy:o,fieldType:s?.type,isDiscrete:i===`percentile_disc`})}_getAttributeValues(e,t,n,r){if(r.has(t))return r.get(t);let i=this.fieldsIndex.get(t),a=n.map(n=>e.getFieldValue(n,t,i));return r.set(t,a),a}_calculateUniqueValues(e,t,n){let r={},i=t.length;for(let a=0;a<i;a++){let i=t[a],o=[];for(let t of e)o.push(t[a]);let s=o.join(`,`);r[s]==null?r[s]={count:1,data:o,items:[i],itemPositions:[a]}:(n||r[s].count++,r[s].items.push(i),r[s].itemPositions.push(a))}return r}async _getDataValues(e,t,n=!0){let r=new J(this.query,this.featureAdapter,this.fieldsIndex),{valueExpression:i,scale:a,timeZone:o}=e;return i?r.getExpressionValues(t,i,{viewingMode:`map`,scale:a,spatialReference:this.query.outSR||this.spatialReference},{geometryType:this.geometryType,hasZ:this.hasZ,hasM:this.hasM},o):r.getDataValues(t,g(e),n)}_calculateHistogramBins(e,t,n){if(t.min==null&&t.max==null)return[];let r=t.intervals,i=t.min??0,a=t.max??0,o=r.map(([e,t])=>({minValue:e,maxValue:t,count:0,items:[]}));for(let t=0;t<e.length;t++){let s=e[t],c=n[t];if(s!=null&&s>=i&&s<=a){let e=be(r,s);e>-1&&(o[e].count++,o[e].items.push(c))}}return o}async createQueryBinsResponse(e){let t=e.bin?.splitBy;if(!t)return this._createBinsResponse(e);let{value:n,outAlias:r,valueType:i}=t,a=[],o=[{name:r??n,alias:r??n,type:i??`esriFieldTypeString`},{name:Y,alias:Y,type:`esriFieldTypeInteger`}],s=new J(e,this.featureAdapter,this.fieldsIndex),c=new Map,l=[...this.items];this._sortFeatures(l,[n],(e,t,n)=>s.getFieldValue(e,t,n));let u=this._getAttributeValues(s,n,l,c),d=this._calculateUniqueValues([u],l,s.returnDistinctValues);for(let t in d){let{items:i}=d[t],s=await this._createBinsResponse(e,i);if(a.push(...s.features.map(e=>({...e,attributes:{...e.attributes,[r??n]:t}}))),s.fields)for(let e of s.fields)o.some(t=>t.name===e.name)||o.push(e)}return{fields:o,features:a}}async _createBinsResponse(e,t){let n=e.bin;switch(t??=this.items,n.type){case`autoIntervalBin`:return this._createAutoIntervalBinsResponse(Fe.fromJSON(n),e,t);case`dateBin`:return this._createDateBinsResponse(Re.fromJSON(n),e,t);case`fixedBoundariesBin`:return this._createFixedBoundariesBinsResponse(Le.fromJSON(n),e,t);case`fixedIntervalBin`:return this._createFixedIntervalBinsResponse(ze.fromJSON(n),e,t)}}async _createAutoIntervalBinsResponse(e,t,n){let{field:r,normalizationField:i,numBins:a,normalizationType:o,normalizationTotal:s,start:c,end:l}=e,u=await this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},n),d=k(u,{field:r,normalizationField:i,normalizationType:o,normalizationTotal:s,numBins:a,minValue:H(c,!1),maxValue:H(l,!1)}),f=this._calculateHistogramBins(u,d,n);return this._createFeaturesFromHistogramBins(f,t)}async _createDateBinsResponse(e,t,n){let{field:r,interval:i,start:a,end:o,snapToData:s,returnFullIntervalBin:c}=e,l=i.unit,u=await this._getDataValues({field:e.field,timeZone:t.outTimeReference?.ianaTimeZone},n),f=y(this.fieldsIndex.get(r)),p=Ie.toJSON(l),m=u.filter(Boolean).sort((e,t)=>e-t),h=a==null?m[0]:H(a,f),g=o==null?m[m.length-1]:H(o,f),_=[];if(h!=null&&g!=null){let e={zone:t.outTimeReference?.ianaTimeZone??`UTC`},n=d.fromMillis(h,e),r=d.fromMillis(g,e);if(s===`last`){let e=r;for(;e>n;){let t=e.minus({[p]:i.value});if(t<n){_.unshift([c?t.toMillis():n.toMillis(),e.toMillis()]);break}_.unshift([t.toMillis(),e.toMillis()]),e=t}}else{let e=s===`first`?n:n.startOf(p);for(;e<=r;){let t=e.plus({[p]:i.value});if(t>r){_.push([e.toMillis(),c?t.toMillis():r.toMillis()]);break}_.push([e.toMillis(),t.toMillis()]),e=t}}}let v=this._calculateHistogramBins(u,{intervals:_,min:h,max:g},n);return this._createFeaturesFromHistogramBins(v,t)}async _createFixedBoundariesBinsResponse(e,t,n){let{field:r}=e,i=await this._getDataValues({field:r,timeZone:t.outTimeReference?.ianaTimeZone},n),a=y(this.fieldsIndex.get(r)),o=e.boundaries.map(e=>H(e,a)).sort((e,t)=>e-t),s=[];for(let e=0;e<o.length-1;e++)s.push([o[e],o[e+1]]);let c={intervals:s,min:o.at(0),max:o.at(-1)},l=this._calculateHistogramBins(i,c,n);return this._createFeaturesFromHistogramBins(l,t)}async _createFixedIntervalBinsResponse(e,t,n){let{field:r,interval:i,start:a,end:o}=e,s=await this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},n),c=y(this.fieldsIndex.get(r)),l=k(s,{field:r,classificationMethod:`defined-interval`,definedInterval:i,minValue:H(a,c),maxValue:H(o,c)},!0),u=this._calculateHistogramBins(s,l,n);return this._createFeaturesFromHistogramBins(u,t)}async _createFeaturesFromHistogramBins(e,t){let{upperBoundaryAlias:n,lowerBoundaryAlias:r}=t,i=r||`lowerBoundary`,a=n||`upperBoundary`,o=[],s=[{name:i,alias:i,type:`esriFieldTypeDouble`},{name:a,alias:a,type:`esriFieldTypeDouble`}],c=t.bin?.stackBy?.value,l=t.bin?.stackBy?.outAlias;c&&s.push({name:Y,alias:Y,type:`esriFieldTypeInteger`},{name:l??c,alias:l??c,type:`esriFieldTypeString`});let u=0,f=t.bin.type===`dateBin`,p=t.outTimeReference?.ianaTimeZone;for(let n of e){let{minValue:e,maxValue:r,items:m}=n,h={attributes:{}},g;if(h.attributes[i]=f&&p&&e!=null?d.fromMillis(e,{zone:p}).toISO():e,h.attributes[a]=f&&p&&r!=null?d.fromMillis(r,{zone:p}).toISO():r,c?(g=await this._createStatisticsQueryResponse({...t,groupByFieldsForStatistics:[c],orderByFields:[c]},m),h.attributes[Y]=++u,t.bin.jsonStyle===`flat`?o.push(...g.features.map(({attributes:{EXPR_1:e,...t},...n})=>({...n,attributes:l??e?{...t,[l??e]:e,...h.attributes}:{...t,...h.attributes}}))):(h.stackedAttributes=g.features.map(({attributes:{EXPR_1:e,...t}})=>l??e?{...t,[l??e]:e}:t),o.push(h))):(t.bin?.splitBy&&(h.attributes[Y]=++u),g=await this._createStatisticsQueryResponse(t,m,h),o.push(h)),g.fields)for(let e of g.fields)s.some(t=>t.name===e.name)||s.push(e)}return t.binOrder===`desc`&&o.reverse(),{fields:s,features:o}}};function tt(e,t,n,r){let i=r.x-n.x,a=r.y-n.y,o=t.x-n.x,s=t.y-n.y,c=i*i+a*a;if(c===0)return!1;let l=o*i+s*a,u=Math.min(1,Math.max(0,l/c));return e.x=n.x+i*u,e.y=n.y+a*u,!0}function nt(e,t){return e?t?4:3:t?3:2}var rt=class{constructor(e,t){this.coords=e,this.coordsIndex=t}get x(){return this.coords[this.coordsIndex]}get y(){return this.coords[this.coordsIndex+1]}get z(){return this.coords[this.coordsIndex+2]}},it=[1],Z=`unsupported-query`;async function at(e,t){let r=e.bin;if(!r.onField&&!r.onExpression?.value||r.type===`autoIntervalBin`&&r.parameters.numberOfBins==null||r.type===`dateBin`&&(r.parameters.number==null||r.parameters.unit==null)||r.type===`fixedBoundariesBin`&&r.parameters.boundaries==null||r.type===`fixedIntervalBin`&&r.parameters.interval==null)throw new n(Z,`Unsupported query options`,{query:e});return Q(e,t)}async function Q(e,{fieldsIndex:t,geometryType:r,spatialReference:i,availableFields:a}){if(e.geometryPrecision!=null||e.multipatchOption&&e.multipatchOption!==`xyFootprint`||e.pixelSize||e.relationParam||e.text)throw new n(Z,`Unsupported query options`,{query:e});return ot(t,a,e),ct(t,a,e),Promise.all([L(e,r,i),z(i,e.outSR)]).then(()=>e)}function ot(e,t,r){let{returnDistinctValues:i,outStatistics:a}=r,o=a?a.map(e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase()).filter(Boolean):[];if(`orderByFields`in r&&r.orderByFields&&r.orderByFields.length>0){let n=` asc`,i=` desc`,a=r.orderByFields.map(e=>{let t=e.toLowerCase();return t.includes(n)?t.split(n)[0]:t.includes(i)?t.split(i)[0]:e}).filter(e=>!o.includes(e));q(e,t,a,{expressionName:`orderByFields`,query:r})}if(`outFields`in r){if(r.outFields?.length)q(e,t,r.outFields,{expressionName:`outFields`,query:r,allowedFieldTypes:`all`});else if(i)throw new n(Z,`outFields should be specified for returnDistinctValues`,{query:r})}Ge(e,t,r.where,r)}var st=new Set([...He,...Ue]);function ct(e,t,r){let{outStatistics:i,groupByFieldsForStatistics:a,having:o}=r,s=a?.length,c=i?.length;if(o){if(!s||!c)throw new n(Z,`outStatistics and groupByFieldsForStatistics should be specified with having`,{query:r});Ke(e,t,o,i,r)}if(c){if(!dt(i))return;let o=i.map(e=>e.onStatisticField).filter(Boolean);q(e,t,o,{expressionName:`onStatisticFields`,query:r}),s&&q(e,t,a,{expressionName:`groupByFieldsForStatistics`,query:r});for(let a of i){let{onStatisticField:i,statisticType:o}=a;if((o===`percentile_disc`||o===`percentile_cont`)&&`statisticParameters`in a){let{statisticParameters:e}=a;if(!e)throw new n(Z,`statisticParameters should be set for percentile type`,{definition:a,query:r})}else e.get(i)&&o!==`count`&&o!==`min`&&o!==`max`&&q(e,t,[i],{expressionName:`outStatistics with '${o}' statistic type`,allowedFieldTypes:st,query:r})}}}async function lt(e,t,{fieldsIndex:r,geometryType:i,spatialReference:a,availableFields:o}){if(e.geometryPrecision!=null||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new n(Z,`Unsupported query options`,{query:e});return ot(r,o,e),Promise.all([ut(r,o,t,e),L(e,i,a),z(a,e.outSR)]).then(()=>e)}async function ut(e,t,r,i){let a=[];if(r.valueExpression){let{arcadeUtils:e}=await v();a=e.extractFieldNames(r.valueExpression)}if(r.field&&a.push(r.field),r.field2&&a.push(r.field2),r.field3&&a.push(r.field3),r.normalizationField&&a.push(r.normalizationField),!a.length&&!r.valueExpression)throw new n(Z,`field or valueExpression is required`,{params:r});q(e,t,a,{expressionName:`statistics`,query:i})}function dt(e){return e!=null&&e.every(e=>e.statisticType!==`exceedslimit`)}var ft=`unsupported-query`,pt=class{constructor(e){this._changeHandle=null,this.capabilities={query:me},this.geometryType=e.geometryType,this.hasM=!!e.hasM,this.hasZ=!!e.hasZ,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._cache=e.cache??new Qe,this.timeInfo=e.timeInfo,this.featureIdInfo=e.featureIdInfo,e.featureIdInfo.type===`object-id`&&(this.objectIdField=e.featureIdInfo.fieldName),this._changeHandle=this.featureStore.events.on(`changed`,()=>this._clearCache()),this.fieldsIndex=u(e.fieldsIndex)?e.fieldsIndex:l.fromJSON(e.fieldsIndex),!e.availableFields||e.availableFields.length===1&&e.availableFields[0]===`*`?this.availableFields=new Set(this.fieldsIndex.fields.map(e=>e.name)):this.availableFields=new Set(e.availableFields.map(e=>this.fieldsIndex.get(e)?.name).filter(e=>e!=null)),e.scheduler&&e.priority?this._frameTask=e.scheduler.registerTask(e.priority):this._frameTask=i}destroy(){this._changeHandle=ce(this._changeHandle),this._frameTask=ce(this._frameTask),this._clearCache(),ue(this._cache)}get featureAdapter(){return this.featureStore.featureAdapter}async executeQuery(e,t){let n=S(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryFeatureSet(e),n)}async executeQueryForCount(e={},t){let n=S(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForCount(e),n)}async executeQueryForExtent(e,t){let n=S(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForExtent(e),n)}async executeQueryForIds(e,t){return Array.from(await this.executeQueryForIdSet(e,t))}async executeQueryForIdSet(e,t){let n=S(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForIdSet(e),n)}async executeQueryForLatestObservations(e,t){let r=S(t);if(!this.timeInfo?.trackIdField)throw new n(ft,`Missing timeInfo or timeInfo.trackIdField`,{query:e,timeInfo:this.timeInfo});return await this._frameTask.scheduleGenerator(()=>this._executeQueryForLatestObservations(e),r)}async executeQueryForOpaqueFeatures(e,t){let n=S(t);return(await this._frameTask.scheduleGenerator(()=>this._executeQuery(e,{}),n)).items}async executeAttributeBinsQuery(e,t){let n=S(t);return e=g(e),await this._frameTask.scheduleGenerator(()=>this._executeAttributeBinsQuery(e),n)}async executeQueryForSummaryStatistics(e={},t,n){let r=S(n);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForSummaryStatistics(e,t),r)}async executeQueryForUniqueValues(e={},t,n){let r=S(n);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForUniqueValues(e,t),r)}async executeQueryForClassBreaks(e={},t,n){let r=S(n);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForClassBreaks(e,t),r)}async executeQueryForHistogram(e={},t,n){let r=S(n);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForHistogram(e,t),r)}async executeQueryForSnapping(e,t){let n=S(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForSnapping(e,n),n)}async fetchRecomputedExtents(e){let t=S(e);this._timeExtentPromise||=Ee(this.timeInfo,this.featureStore);let[n,r]=await Promise.all([this._getFullExtent(),this._timeExtentPromise]);return ie(t),{fullExtent:n,timeExtent:r}}_clearCache(){this._cache.clear(),this._allFeaturesPromise=null,this._timeExtentPromise=null,this._fullExtentPromise=null}async*_executeQueryFeatureSet(e){try{let t=yield*this._executeQuery(e,{});return yield,await t.createQueryResponse()}catch(t){if(t!==U)throw t;return await new X([],e,this).createQueryResponse()}}async*_executeQueryForCount(e){try{let t=yield*this._executeQuery(e,{returnGeometry:!1,returnCentroid:!1,outSR:null});return yield,t.createQueryResponseForCount()}catch(e){if(e!==U)throw e;return 0}}async*_executeQueryForExtent(e){let t=e.outSR;try{let n=yield*this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null});yield;let r=n.size;if(!r)return{count:0,extent:null};let i=await this._getBounds(n.items,n.spatialReference,t??this.spatialReference);return yield,{count:r,extent:i}}catch(e){if(e===U)return{count:0,extent:null};throw e}}async*_executeQueryForIdSet(e){try{let t=yield*this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null});yield;let n=t.items,r=new Set;for(let e of n)r.add(t.featureAdapter.getObjectId(e));return r}catch(e){if(e===U)return new Set;throw e}}async*_executeQueryForLatestObservations(e){try{let t=yield*this._executeQuery(e,{});return yield,this._filterLatest(t),yield,await t.createQueryResponse()}catch(t){if(t!==U)throw t;return await new X([],e,this).createQueryResponse()}}async*_executeAttributeBinsQuery(e){let t;try{e=await ke(e,this.definitionExpression,this.spatialReference),yield,e=await at(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),yield;let n=yield*this._executeSceneFilterQuery(e);yield,t=yield*this._executeGeometryQuery(e,n),yield,this._executeAggregateIdsQuery(t),yield,this._executeObjectIdsQuery(t),yield,this._executeTimeQuery(t),yield,this._executeAttributesQuery(t),yield}catch(n){if(n!==U)throw n;t=new X([],e,this)}return await t.createQueryBinsResponse(e)}async*_executeQueryForSummaryStatistics(e={},t){let{field:n,normalizationField:r,valueExpression:i}=t,a=yield*this._executeQueryForStatistics(e,{field:n,normalizationField:r,valueExpression:i});return yield,await a.createSummaryStatisticsResponse(t)}async*_executeQueryForUniqueValues(e={},t){let{field:n,field2:r,field3:i,valueExpression:a}=t,o=yield*this._executeQueryForStatistics(e,{field:n,field2:r,field3:i,valueExpression:a});return yield,await o.createUniqueValuesResponse(t)}async*_executeQueryForClassBreaks(e,t){let{field:n,normalizationField:r,valueExpression:i}=t,a=yield*this._executeQueryForStatistics(e,{field:n,normalizationField:r,valueExpression:i});return yield,await a.createClassBreaksResponse(t)}async*_executeQueryForHistogram(e,t){let{field:n,normalizationField:r,valueExpression:i}=t,a=yield*this._executeQueryForStatistics(e,{field:n,normalizationField:r,valueExpression:i});return yield,await a.createHistogramResponse(t)}async*_executeQueryForSnapping(e,t){let{point:n,distance:r,returnEdge:i,vertexMode:a}=e;if(!i&&a===`none`)return{candidates:[]};let o=g(e.query);o=await Oe(o,this.definitionExpression,this.spatialReference),yield,o=await Q(o,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),yield;let s=!C(n.spatialReference,this.spatialReference);s&&(await z(n.spatialReference,this.spatialReference),yield);let c=typeof r==`number`?r:r.x,l=typeof r==`number`?r:r.y,u={xmin:n.x-c,xmax:n.x+c,ymin:n.y-l,ymax:n.y+l,spatialReference:n.spatialReference},d=s?V(u,this.spatialReference):u;if(!d)return{candidates:[]};let f=(await re(de(n),null,{signal:t}))[0];yield;let p=(await re(de(d),null,{signal:t}))[0];if(yield,f==null||p==null)return{candidates:[]};let m=await this._searchFeatures($(p.toJSON()));yield;let h=new X(m,o,this);this._executeObjectIdsQuery(h),yield,this._executeTimeQuery(h),yield,this._executeAttributesQuery(h),yield,yield*this._executeGeometryQueryForSnapping(h),yield;let _=f.toJSON(),v=s?V(_,this.spatialReference):_,y=s?Math.max(d.xmax-d.xmin,d.ymax-d.ymin)/2:r;return h.createSnappingResponse({...e,point:v,distance:y},o.returnZ,n.spatialReference)}async _getBounds(e,t,n){let r=c(te(),se);return await this.featureStore.forEachBounds(e,e=>ee(r,e)),mt(r,t,n,this.spatialReference,this.hasZ)}_getFullExtent(){return this._fullExtentPromise||=`getFullExtent`in this.featureStore&&this.featureStore.getFullExtent?Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)):this._getAllFeatures().then(e=>this._getBounds(e,this.spatialReference,this.spatialReference)),this._fullExtentPromise}async _getAllFeaturesQueryEngineResult(e){return new X(await this._getAllFeatures(),e,this)}async _getAllFeatures(){if(this._allFeaturesPromise==null){let e=[];this._allFeaturesPromise=(async()=>await this.featureStore.forEach(t=>e.push(t)))().then(()=>w(e))}let e=this._allFeaturesPromise,t=await e;return e===this._allFeaturesPromise?t.slice():this._getAllFeatures()}async*_executeQuery(e,t){e=g(e),e=await B(e,this.definitionExpression,this.spatialReference),yield,e=await Q(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),yield,e={...e,...t};let n=yield*this._executeSceneFilterQuery(e);yield;let r=yield*this._executeGeometryQuery(e,n);return yield,this._executeAggregateIdsQuery(r),yield,this._executeObjectIdsQuery(r),yield,this._executeTimeQuery(r),yield,this._executeAttributesQuery(r),r}async*_executeSceneFilterQuery(e){if(e.sceneFilter==null)return null;let{outSR:t,returnGeometry:n,returnCentroid:r}=e,i=this.featureStore.featureSpatialReference,a=e.sceneFilter.geometry,o=i==null||C(i,a.spatialReference)?a:V(a,i);if(!o)return null;let s=n||r,c=D(t)&&!C(this.spatialReference,t)&&s?async e=>this._project(e,t):e=>e;yield;let l=this.featureAdapter,u=await this._searchFeatures($(o));if(yield,e.sceneFilter.spatialRelationship===`disjoint`){if(!u.length)return null;let t=new Set;for(let e of u)t.add(l.getObjectId(e));let n=await this._getAllFeatures();yield;let r=await F(`esriSpatialRelDisjoint`,o,this.geometryType);yield;let i=e=>!t.has(l.getObjectId(e))||r(l.getGeometry(e)),a=yield*this._runSpatialFilter(n,i);yield;let s=new X(a,e,this);return await c(s)}if(!u.length)return new X([],e,this);if(this._canExecuteSinglePass(o,e))return await c(new X(u,e,this));let d=await F(`esriSpatialRelContains`,o,this.geometryType);yield;let f=yield*this._runSpatialFilter(u,e=>d(l.getGeometry(e)));return yield,await c(new X(f,e,this))}async*_executeGeometryQuery(e,t){if(t!=null&&t.items.length===0)return t;let{geometry:n,outSR:r,returnGeometry:i,returnCentroid:a}=e,o=t?null:this._getCacheKey(e),s=o?this._cache.get(o):null;if(s)return new X(s,e,this);let c=D(r)&&!C(this.spatialReference,r),l=i||a,u=async e=>(c&&l&&await this._project(e,r),o&&this._cache.put(o,e.items),e),d=this.featureStore.featureSpatialReference,f=!n||d==null||C(d,n.spatialReference)?n:V(n,d);if(!f)return await u(t??await this._getAllFeaturesQueryEngineResult(e));yield;let p=this.featureAdapter,m=await this._searchFeatures($(n));yield;let h=e.spatialRel??`esriSpatialRelIntersects`;if(h===`esriSpatialRelDisjoint`){if(!m.length)return await u(t??await this._getAllFeaturesQueryEngineResult(e));let n=new Set;for(let e of m)n.add(p.getObjectId(e));let r;t==null?(yield,r=await this._getAllFeatures(),yield):r=t.items;let i=await F(h,f,this.geometryType);yield;let a=e=>!n.has(p.getObjectId(e))||i(p.getGeometry(e)),o=yield*this._runSpatialFilter(r,a);yield;let s=new X(o,e,this);return await u(s)}if(t!=null){let e=new ne;m=m.filter(n=>b(t.items,n,t.items.length,e)>=0)}if(!m.length){let t=new X([],e,this);return o&&this._cache.put(o,t.items),t}if(this._canExecuteSinglePass(f,e))return await u(new X(m,e,this));let g=await F(h,f,this.geometryType);yield;let _=yield*this._runSpatialFilter(m,e=>g(p.getGeometry(e)));return yield,await u(new X(_,e,this))}_executeAggregateIdsQuery(e){if(e.items.length===0||!e.query.aggregateIds?.length||this.aggregateAdapter==null)return;let t=new Set;for(let n of e.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(n).forEach(e=>t.add(e));let n=this.featureAdapter.getObjectId;e.items=e.items.filter(e=>t.has(n(e)))}_executeObjectIdsQuery(e){if(e.items.length===0||!e.query.objectIds?.length)return;let t=new Set(e.query.objectIds),n=this.featureAdapter.getObjectId;e.items=e.items.filter(e=>t.has(n(e)))}_executeTimeQuery(e){if(e.items.length===0)return;let t=De(this.timeInfo,e.query.timeExtent,this.featureAdapter);t!=null&&(e.items=e.items.filter(t))}_executeAttributesQuery(e){if(e.items.length===0)return;let t=K(e.query.where,this.fieldsIndex);if(t){if(!t.isStandardized)throw TypeError(`Where clause is not standardized`);e.items=e.items.filter(e=>t.testFeature(e,this.featureAdapter))}}async*_executeGeometryQueryForSnapping(e){let{query:t}=e,{spatialRel:n}=t;if(!e?.items?.length||!t.geometry||!n)return;let r=await F(n,t.geometry,this.geometryType);yield;let i=this.featureAdapter;e.items=yield*this._runSpatialFilter(e.items,e=>r(i.getGeometry(e)))}*_runSpatialFilter(e,t){if(!t)return e;if(this._frameTask==null)return e.filter(e=>t(e));let n=yield,r=[];for(let i of e)t(i)&&r.push(i),n.madeProgress(),n.done&&(n=yield);return r}_filterLatest(e){let{trackIdField:t,startTimeField:n,endTimeField:r}=this.timeInfo,i=r||n,a=new Map,o=this.featureAdapter.getAttribute;for(let n of e.items){let e=o(n,t),r=o(n,i),s=a.get(e);(!s||r>o(s,i))&&a.set(e,n)}e.items=Array.from(a.values())}_getCacheKey(e){let{geometry:t,spatialRel:n,returnGeometry:r,returnCentroid:i,outSR:a,resultType:o,cacheHint:s}=e;if(o!==`tile`&&!s)return null;let c=r||i;return D(a)&&!C(this.spatialReference,a)&&c?JSON.stringify([t,n,a]):JSON.stringify([t,n])}_canExecuteSinglePass(e,t){let{spatialRel:n}=t;return N(e)&&(n===`esriSpatialRelEnvelopeIntersects`||this.geometryType===`esriGeometryPoint`&&(n===`esriSpatialRelIntersects`||n===`esriSpatialRelContains`))}async _project(e,t){if(!t||C(this.spatialReference,t))return e;let n=this.featureAdapter,r=s()?await this._getFullExtent():void 0,i=await Ae(e.items.map(e=>I(this.geometryType,n.getGeometry(e))),this.spatialReference,t,{areaOfInterestExtent:r});return e.items=w(i.map((t,r)=>n.cloneWithGeometry(e.items[r],fe(t,this.hasZ,this.hasM)))),e}async _searchFeatures(e){let t=new Set;await Promise.all(e.map(e=>this.featureStore.forEachInBounds(e,e=>t.add(e))));let n=Array.from(t.values());return t.clear(),n}async*_executeQueryForStatistics(e,t){e=g(e);try{e=await B(e,this.definitionExpression,this.spatialReference),yield,e=await lt(e,t,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),yield;let n=yield*this._executeSceneFilterQuery(e);yield;let r=yield*this._executeGeometryQuery(e,n);return yield,this._executeAggregateIdsQuery(r),yield,this._executeObjectIdsQuery(r),yield,this._executeTimeQuery(r),yield,this._executeAttributesQuery(r),yield,r}catch(t){if(t!==U)throw t;return new X([],e,this)}}get test(){}};function $(e){if(N(e)){if(_(e))return[x(Math.min(e.xmin,e.xmax),Math.min(e.ymin,e.ymax),Math.max(e.xmin,e.xmax),Math.max(e.ymin,e.ymax))];if(o(e))return e.rings.map(e=>x(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1])))}return[ae(le(),e)]}function mt(e,t,n,r,i){let o={xmin:e[0],ymin:e[1],xmax:e[3],ymax:e[4],spatialReference:P(r)};i&&isFinite(e[2])&&isFinite(e[5])&&(o.zmin=e[2],o.zmax=e[5],o.hasZ=!0);let s=V(o,t,n);if(s.spatialReference=P(n),s.xmax-s.xmin===0){let e=a(s.spatialReference);s.xmin-=e,s.xmax+=e}if(s.ymax-s.ymin===0){let e=a(s.spatialReference);s.ymin-=e,s.ymax+=e}if(i&&s.zmin!=null&&s.zmax!=null&&s.zmax-s.zmin===0){let e=a(s.spatialReference);s.zmin-=e,s.zmax+=e}return s}export{mt as n,X as r,pt as t};