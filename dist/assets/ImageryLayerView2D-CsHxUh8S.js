import{BT as e,DT as t,En as n,Hw as r,JE as i,Ju as a,OT as o,RS as s,WT as c,Z_ as l,_d as u,_w as d,ax as f,eT as p,fS as m,gD as h,iv as g,nv as _,pD as v,px as y,qw as b,rd as x,rv as S,uE as C,vd as w}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./OptimizedFeatureSet-CTIqq8fn.js";import"./featureConversionUtils-_DSSMFQ2.js";import"./streamLayerUtils-82UmlW-3.js";import{n as T}from"./QueueProcessor-BtMHt_WC.js";import"./earcut-BF1-mB58.js";import"./layerViewUtils-RSw-QNoB.js";import{t as ee}from"./popupUtils-Bb88Y0DD.js";import"./tagSymbols-CazaFvX8.js";import"./PixelBlock-HBARrhko.js";import{s as te,y as E}from"./vectorFieldUtils-DMJyxx0j.js";import"./colorUtils-DJOs5VE1.js";import{r as D}from"./rasterFieldUtils-CTwnxR3_.js";import"./dataUtils-BTiGb5TR.js";import{i as O,r as k,u as A}from"./rasterProjectionHelper-w_U-UD-j.js";import{t as j}from"./clipUtils-DaPwa6ud.js";import"./timeSupport-DTr00ezP.js";import"./queryUtils-DcyDFw5_.js";import"./quantizationUtils-CGy9nkLl.js";import"./normalizeUtilsSync-3fP05dGa.js";import"./GeometryUtils-Dmca5Xm4.js";import"./VertexAttributeLocations-CfzeuYMz.js";import"./VertexElementDescriptor-ju-1bdWe.js";import"./labelPoint-vGsL2GFc.js";import"./callExpressionWithCursor-BmfrFX6I.js";import"./FeatureMetadata-i54qdN5K.js";import"./CIMSymbolHelper-l5sn5wJj.js";import"./rasterizingUtils-CKtfcOpu.js";import"./Rect-BhUrWpQm.js";import"./BoundingBox-CLkiiRfJ.js";import"./BidiEngine-BrFXRv7y.js";import"./callExpressionWithFeature-D55aOczd.js";import"./OverrideHelper-BhCM0ayL.js";import"./FeatureCommandQueue-CjFmAvd1.js";import"./config-BSvujflG.js";import"./dehydratedFeatureComparison-Uk3aLNrk.js";import{t as M}from"./WGLContainer-D_aBMsnu.js";import"./utils-DS5dbHj4.js";import"./ProgramTemplate-BXau1qoF.js";import"./VertexArrayObject-DEfjd5y-.js";import"./BufferObject-q8zuTMny.js";import"./VertexBuffer-xVpphTb4.js";import"./vec3f32-B2H3-fiA.js";import{t as N}from"./Container-BuEih3Ua.js";import"./GraphShaderModule-D5RCsL2_.js";import"./FramebufferObject-BhBPSr-C.js";import"./ShaderBuilder-D3cV1oap.js";import"./bitmapUtils-SuGDUZFe.js";import{i as P}from"./Bitmap-CiNUpq9T.js";import{t as F}from"./BitmapContainer-ChYmxUus.js";import{t as I}from"./LayerView2D-BsKgTWnO.js";import{t as L}from"./ExportStrategy-BtFJEMJc.js";import{t as R}from"./LayerView-2jeNRFkG.js";import{t as z}from"./RefreshableLayerView-CXmtIjA5.js";import{t as B}from"./timeSupport-CpSaGF8C.js";import"./UpdateTracking2D-BiwypiBP.js";import"./TechniqueInstance-B37K-FPt.js";import"./TileContainer-B6yQthEI.js";import"./constants-BuH6TGxi.js";import"./utils-Czjlo_U1.js";import{t as V}from"./highlightOptionsUtils-C8mtOR7S.js";import"./AGraphicContainer-BjvRrdle.js";import"./ComputedAttributeStorage-B3XSA2BQ.js";import{t as H}from"./GraphicsView2D-CPqKya-9.js";import"./dehydratedFeatures-8DNmK2px.js";import"./loadUtils-CFFeTrby.js";import{n as U,r as W,t as G}from"./RasterVFDisplayObject-BV3YuQew.js";import{t as K}from"./HighlightGraphicContainer-Cgga58jR.js";import{n as q,t as J}from"./highlightUtils-Drb4dN_6.js";var Y=class extends d{constructor(){super(...arguments),this.attached=!1,this.container=new N,this.updateRequested=!1,this.pixelHighlights=[],this.type=`imagery`,this._bitmapView=new F}destroy(){this.attached&&=(this.detach(),!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(e){this.strategy.update(e).catch(e=>{b(e)||C.getLogger(this).error(e)})}hitTest(e){return new w({attributes:{},geometry:e.clone(),layer:this.layer})}attach(){this.container.addChild(this._bitmapView);let e=this.layer.version>=10,t=this.layer.version>=10.1?this.layer.imageMaxHeight:2048,n=this.layer.version>=10.1?this.layer.imageMaxWidth:2048;this.strategy=new L({container:this._bitmapView,imageNormalizationSupported:e,imageMaxHeight:t,imageMaxWidth:n,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()})}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren(),this.updateRequested=!1}redraw(){this.strategy.updateExports(async e=>{let{source:t}=e;if(!t||t instanceof ImageBitmap)return;let n=t.originalPixelBlock??t.pixelBlock,{pixelHighlights:r}=this,i=r.length>0,a=await this.layer.applyRenderer({extent:t.extent,pixelBlock:n,isRawData:i}),o=a.pixelBlock;i&&n&&o&&await this.layer.highlightPixels({pixelBlock:n,renderedPixelBlock:o,highlightOptions:r}),t.filter=e=>this.layer.pixelFilter?this.layer.applyFilter(e):{...a,extent:t.extent}}).catch(e=>{b(e)||C.getLogger(this).error(e)})}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;let e=this.strategy.bitmaps;if(e.length===1&&e[0].source)return{extent:e[0].source.extent,pixelBlock:e[0].source.originalPixelBlock};if(e.length>1){let t=this.view.extent,n=e.map(e=>e.source).filter(e=>e.extent&&e.extent.intersects(t)).map(e=>({extent:e.extent,pixelBlock:e.originalPixelBlock})),r=E(n,t);return r==null?null:{extent:r.extent,pixelBlock:r.pixelBlock}}return null}async _fetchImage(e,t,n,r){(r||={}).timeExtent=this.timeExtent;let i=this.pixelHighlights.length>0;r.requestAsImageElement=!i,r.returnImageBitmap=!i,r.requestRawData=i;let a=await this.layer.internalFetchImage(e,t,n,r);if(a.imageBitmap)return a.imageBitmap;let o=await this.layer.applyRenderer({...a.pixelData,isRawData:i},{signal:r.signal}),s=a.pixelData.pixelBlock,c=o.pixelBlock;i&&s&&c&&await this.layer.highlightPixels({pixelBlock:s,renderedPixelBlock:c,highlightOptions:this.pixelHighlights});let l=new P(c,o.extent?.clone(),s);return l.filter=e=>this.layer.applyFilter(e),l}};h([t()],Y.prototype,`attached`,void 0),h([t()],Y.prototype,`container`,void 0),h([t()],Y.prototype,`layer`,void 0),h([t()],Y.prototype,`strategy`,void 0),h([t()],Y.prototype,`timeExtent`,void 0),h([t()],Y.prototype,`view`,void 0),h([t()],Y.prototype,`updateRequested`,void 0),h([t()],Y.prototype,`updating`,null),h([t()],Y.prototype,`pixelHighlights`,void 0),h([t()],Y.prototype,`type`,void 0),Y=h([o(`esri.views.2d.layers.imagery.ImageryView2D`)],Y);var X=class extends M{constructor(){super(...arguments),this.symbolTypes=[`triangle`]}prepareRenderPasses(e){let t=e.registerRenderPass({name:`imagery (vf)`,brushes:[U],target:()=>this.children,drawPhase:1});return[...super.prepareRenderPasses(e),t]}doRender(e){this.visible&&e.drawPhase===1&&this.symbolTypes.forEach(t=>{e.renderPass=t,super.doRender(e)})}},Z=class extends d{constructor(e){super(e),this._loading=null,this.update=r((e,t)=>this._update(e,t).catch(e=>{b(e)||C.getLogger(this).error(e)}))}get updating(){return!!this._loading}redraw(e){if(!this.container.children.length)return;let t=this.container.children[0];t.symbolizerParameters=e,t.invalidateVAO(),this.container.symbolTypes=e.style===`wind_speed`?[`scalar`,`triangle`]:e.style===`simple_scalar`?[`scalar`]:[`triangle`],this.container.requestRender()}async _update(e,t,n){if(!e.stationary)return;let{extent:r,spatialReference:i}=e.state,a=new f({xmin:r.xmin,ymin:r.ymin,xmax:r.xmax,ymax:r.ymax,spatialReference:i}),[o,s]=e.state.size;this._loading=this.fetchPixels(a,o,s,n);let c=await this._loading;this._addToDisplay(c,t,e.state),this._loading=null}_addToDisplay(e,t,n){if(e.pixelBlock==null)return this.container.children.forEach(e=>e.destroy()),void this.container.removeAllChildren();let{extent:r,pixelBlock:i}=e,a=new G(i);a.offset=[0,0],a.symbolizerParameters=t,a.rawPixelData=e,a.invalidateVAO(),a.x=r.xmin,a.y=r.ymax,a.pixelRatio=n.pixelRatio,a.rotation=n.rotation,a.resolution=n.resolution,a.width=i.width*t.symbolTileSize,a.height=i.height*t.symbolTileSize,this.container.children.forEach(e=>e.destroy()),this.container.removeAllChildren(),this.container.symbolTypes=t.style===`wind_speed`?[`scalar`,`triangle`]:t.style===`simple_scalar`?[`scalar`]:[`triangle`],this.container.addChild(a)}};h([t()],Z.prototype,`fetchPixels`,void 0),h([t()],Z.prototype,`container`,void 0),h([t()],Z.prototype,`_loading`,void 0),h([t()],Z.prototype,`updating`,null),Z=h([o(`esri.views.2d.layers.imagery.ImageryVFStrategy`)],Z);var Q=class extends d{constructor(){super(...arguments),this.attached=!1,this.container=new X,this.type=`imageryVF`,this._dataParameters={exportParametersVersion:0,bbox:``,symbolTileSize:0,time:``},this._fetchpixels=async(e,t,n,r)=>{let i=await this._projectFullExtentPromise,{layer:a}=this,{symbolTileSize:o}=a.renderer,{extent:s,width:c,height:l}=te(e,t,n,o,i);if(i!=null&&!i.intersects(e))return{extent:s,pixelBlock:null};let u={bbox:`${s.xmin}, ${s.ymin}, ${s.xmax}, ${s.ymax}`,exportParametersVersion:a.exportImageServiceParameters.version,symbolTileSize:o,time:JSON.stringify(this.timeExtent||``)};if(this._canReuseVectorFieldData(u)){let e=this.getPixelData();if(e!=null&&`${e.extent.xmin}, ${e.extent.ymin}, ${e.extent.xmax}, ${e.extent.ymax}`===u.bbox)return e}let{pixelBlock:d}=await a.fetchPixels(s,c,l,{timeExtent:this.timeExtent,interpolation:a.interpolation,signal:r});if(this._dataParameters=u,d==null)return{extent:s,pixelBlock:null};let{dataType:f}=a.rasterInfo;return{extent:s,pixelBlock:f===`vector-uv`&&d?await a.convertVectorFieldData(d,`vector-uv`,{signal:r}):d}}}get updating(){return!this.attached||this._strategy.updating}attach(){this._projectFullExtentPromise=this._getProjectedFullExtent(this.view.spatialReference),this._strategy=new Z({container:this.container,fetchPixels:this._fetchpixels}),this.addHandles(_(()=>this.layer.renderer,e=>this._updateSymbolizerParams(e),S),`attach`)}detach(){this._strategy.destroy(),this.container.children.forEach(e=>e.destroy()),this.container.removeAllChildren(),this.removeHandles(`attach`),this._strategy=this.container=this._projectFullExtentPromise=null}getPixelData(){let e=this.container.children[0]?.rawPixelData;if(this.updating||!e)return null;let{extent:t,pixelBlock:n}=e;return{extent:t,pixelBlock:n}}hitTest(e){return new w({attributes:{},geometry:e.clone(),layer:this.layer})}update(e){this._strategy.update(e,this._symbolizerParams).catch(e=>{b(e)||C.getLogger(this).error(e)})}redraw(){let{renderer:e}=this.layer;e&&(this._updateSymbolizerParams(e),this._strategy.redraw(this._symbolizerParams))}_canReuseVectorFieldData(e){let t=this._dataParameters.exportParametersVersion===e.exportParametersVersion,n=this._dataParameters.time===e.time,r=this._dataParameters.symbolTileSize===e.symbolTileSize,i=this._dataParameters.bbox===e.bbox;return t&&n&&r&&i}async _getProjectedFullExtent(e){try{return k(this.layer.fullExtent,e)}catch{try{let t=(await s(this.layer.url,{query:{option:`footprints`,outSR:m(e),f:`json`}})).data.featureCollection.layers[0].layerDefinition.extent;return t?f.fromJSON(t):null}catch{return null}}}_updateSymbolizerParams(e){e?.type===`vector-field`&&(this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null}))}};h([t()],Q.prototype,`attached`,void 0),h([t()],Q.prototype,`container`,void 0),h([t()],Q.prototype,`layer`,void 0),h([t()],Q.prototype,`timeExtent`,void 0),h([t()],Q.prototype,`type`,void 0),h([t()],Q.prototype,`view`,void 0),h([t()],Q.prototype,`updating`,null),Q=h([o(`esri.views.2d.layers.imagery.VectorFieldView2D`)],Q);var ne=r=>{let i=r,a=class extends i{constructor(...e){super(...e),this.view=null}get timeExtent(){return B(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}async fetchPopupFeaturesAtLocation(t,r){let{layer:i}=this;if(!t)throw new e(`imagerylayerview:fetchPopupFeatures`,`Nothing to fetch without area`,{layer:i});let{popupEnabled:a}=i,o=ee(i,r);if(!a||o==null)return[];let s=await o.getRequiredFields(null,{index:new n(i.rasterFields),partitions:new Map([[`$pixel`,i.rasterFields.filter(e=>e.name.startsWith(D)).map(e=>e.name)],[`$imageCollectionItem`,i.fields.map(e=>e.name)]])});p(r);let c=new x;c.timeExtent=this.timeExtent,c.geometry=t,c.outFields=s,c.outSpatialReference=t.spatialReference;let{resolution:l,spatialReference:u}=this.view,d=this.view.type===`2d`?new y(l,l,u):new y(.5*l,.5*l,u),{returnTopmostRaster:f,showNoDataRecords:m}=o.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},h={returnDomainValues:!0,returnTopmostRaster:f,pixelSize:d,showNoDataRecords:m,signal:r?.signal};return i.queryVisibleRasters(c,h)}async getSourceScale(){return await A(),await this.layer.load(),O(this.layer.serviceRasterInfo,this.view.spatialReference)}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return h([t()],a.prototype,`layer`,void 0),h([t()],a.prototype,`suspended`,void 0),h([t({readOnly:!0})],a.prototype,`timeExtent`,null),h([t()],a.prototype,`view`,void 0),a=h([o(`esri.views.layers.ImageryLayerViewMixin`)],a),a},$=class extends ne(z(I(R))){constructor(){super(...arguments),this._exportImageVersion=-1,this._highlightGraphics=new u,this._highlightView=void 0,this._pixelHighlights=[],this.layer=null,this.subview=null}get pixelData(){let{subview:e}=this;return this.updating||!e?null:`getPixelData`in e?e.getPixelData():null}update(e){this.subview?.update(e)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.view&&(this._highlightView=new H({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new K(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container)),this.addAttachHandles([_(()=>this.layer.exportImageServiceParameters.version,e=>{e&&this._exportImageVersion!==e&&(this._exportImageVersion=e,this.requestUpdate())},l),_(()=>this.timeExtent,e=>{let{subview:t}=this;t&&(t.timeExtent=e,`redraw`in t?this.requestUpdate():t.redrawOrRefetch())},l),this.layer.on(`redraw`,()=>{let{subview:e}=this;e&&(`redraw`in e?e.redraw():e.redrawOrRefetch())}),_(()=>this.layer.renderer,()=>this._setSubView()),_(()=>this.view.highlights.items.map(({name:e,color:t})=>({name:e,color:t})),()=>this._updateHighlightOptions(this.subview))])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.container.removeAllChildren(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null,this._highlightView?.destroy(),this._exportImageVersion=-1}viewChange(){}moveEnd(){this.requestUpdate()}highlight(e,t){if(J(e))return q(e)?c():this._highlightPixels(e,t);if(typeof e==`number`||typeof e==`string`)return this._highlightByImageIds([e],t);let n=Array.isArray(e)||g.isCollection(e)?e.at(0):e;if(typeof n==`number`||typeof n==`string`)return this._highlightByImageIds(e,t);if(!(n instanceof w))return c();let r=[];if(Array.isArray(e)||g.isCollection(e)?r=e.map(e=>e.clone()):e instanceof w&&(r=[e.clone()]),!r?.filter(i)?.length)return c();let a=V(t);return this._addHighlightGraphics(r,a),c(()=>!this.destroyed&&this._removeHighlightGraphics(r,a))}_highlightByImageIds(e,t){let n=V(t),r=new AbortController,{signal:i}=r,a=this.layer.sourceJSON.maxRecordCount??1e3,o=Math.ceil(e.length/a),s=[],l=[],u=new T({concurrency:4,process:e=>this.layer.queryFeatures({objectIds:e.ids,returnGeometry:!0,outSpatialReference:this.view.spatialReference},{signal:i}).then(e=>l.push(...e.features)).catch(()=>{})});for(let t=0;t<o;t++)s.push(u.push({ids:e.slice(t*a,(t+1)*a)}));return Promise.allSettled(s).then(()=>{l.length&&!i.aborted&&(this._addHighlightGraphics(l,n),i.addEventListener(`abort`,()=>{this._removeHighlightGraphics(l,n)}))}),c(()=>r.abort())}_highlightPixels(e,t){let n={target:e,options:t};return this._pixelHighlights.push(n),this._updateHighlightOptions(this.subview),c(()=>{let e=this._pixelHighlights.indexOf(n);e>-1&&(this._pixelHighlights.splice(e,1),this._updateHighlightOptions(this.subview))})}_addHighlightGraphics(e,t){this._highlightGraphics.addMany(e),this._addHighlights(e.map(e=>e.uid),t)}_removeHighlightGraphics(e,t){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map(e=>e.uid),t)}async doRefresh(){this.requestUpdate()}isUpdating(){let e=!this.subview||this.subview.updating||!!this._highlightView?.updating;return v(`esri-2d-log-updating`)&&console.log(`Updating ImageryLayerView2D (${this.layer.id}): ${e}\n-> subview ${!this.subview||this.subview.updating}\n-> higlightView ${this._highlightView?.updating}\n`),e}_processHighlight(){let e=this._getHighlights();this._highlightView?.setHighlight(e)}_setSubView(){if(!this.view)return;let e=this.layer.renderer?.type,t=`imagery`;if(e===`vector-field`?t=`imageryVF`:e===`flow`&&(t=`flow`),this.subview){let{type:e}=this.subview;if(e===t)return this._attachSubview(this.subview),void(e===`flow`?this.subview.redrawOrRefetch():e===`imagery`&&this.layer.format===`lerc`?this.subview.redraw():this.requestUpdate());this._detachSubview(this.subview),this.subview?.destroy()}t===`imagery`?(this.subview=new Y({layer:this.layer,view:this.view,timeExtent:this.timeExtent}),this._updateHighlightOptions(this.subview)):this.subview=t===`imageryVF`?new Q({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new W({layer:this.layer,layerView:this}),this._attachSubview(this.subview),this.requestUpdate()}_attachSubview(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0))}_detachSubview(e){e?.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)}_updateHighlightOptions(e){let t=this.view.highlights;this._pixelHighlights.sort((e,n)=>t.findIndex(({name:e})=>e===V(n.options))-t.findIndex(({name:t})=>t===V(e.options)));let n=this._pixelHighlights.map(({target:e,options:n})=>re(e,t,n)).filter(i);e?.type===`imagery`&&(e.pixelHighlights=n,e.attached&&(this.layer.format===`lerc`?e.redraw():this.requestUpdate()))}};function re(e,t,n){let r=V(n),i=(t.find(e=>e.name===r)?.color??a).toArray(),{pixelRanges:o}=e;if(Array.isArray(o))return{ranges:o,bandId:e.bandId??0,color:i};let s=o.type===`extent`?o:o.extent;if(!s)return;let c=[s.xmin,s.xmax],l=[s.ymin,s.ymax],{xBandId:u,yBandId:d}=e,f=1024,p=1024;return{xBandId:u,yBandId:d,xBandRange:c,yBandRange:l,color:i,width:f,height:p,xyMask:o.type===`polygon`?j({srcExtent:s,geometry:o,size:[f,p]}):void 0}}h([t()],$.prototype,`pixelData`,null),h([t()],$.prototype,`subview`,void 0),$=h([o(`esri.views.2d.layers.ImageryLayerView2D`)],$);var ie=$;export{ie as default};