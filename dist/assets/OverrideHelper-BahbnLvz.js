import{En as e,FE as t,Rt as n,St as r,Ut as i,Vt as a,bt as o,dn as s,ph as c,sn as l,zt as u}from"./index-BN8X5Ryz.js";import{d}from"./colorUtils-CzajW9E7.js";import{t as f}from"./callExpressionWithFeature-UlbvTUQ4.js";var p=e=>{if(!e)return[0,0,0,0];let{r:t,g:n,b:r,a:i}=e;return[t,n,r,255*i]},m=class m{static findApplicableOverrides(e,t,n){if(e&&t){if(e.primitiveName){let r=!1;for(let t of n)if(t.primitiveName===e.primitiveName){r=!0;break}if(!r)for(let r of t)r.primitiveName===e.primitiveName&&n.push(r)}switch(e.type){case`CIMPointSymbol`:case`CIMLineSymbol`:case`CIMPolygonSymbol`:if(e.effects)for(let r of e.effects)m.findApplicableOverrides(r,t,n);if(e.symbolLayers)for(let r of e.symbolLayers)m.findApplicableOverrides(r,t,n);break;case`CIMTextSymbol`:break;case`CIMSolidStroke`:case`CIMPictureStroke`:case`CIMGradientStroke`:case`CIMSolidFill`:case`CIMPictureFill`:case`CIMHatchFill`:case`CIMGradientFill`:case`CIMVectorMarker`:case`CIMCharacterMarker`:case`CIMPictureMarker`:if(e.effects)for(let r of e.effects)m.findApplicableOverrides(r,t,n);if(e.markerPlacement&&m.findApplicableOverrides(e.markerPlacement,t,n),e.type===`CIMVectorMarker`){if(e.markerGraphics)for(let r of e.markerGraphics)m.findApplicableOverrides(r,t,n),m.findApplicableOverrides(r.symbol,t,n)}else e.type===`CIMCharacterMarker`?m.findApplicableOverrides(e.symbol,t,n):e.type===`CIMHatchFill`?m.findApplicableOverrides(e.lineSymbol,t,n):e.type===`CIMPictureMarker`&&m.findApplicableOverrides(e.animatedSymbolProperties,t,n)}}}static findEffectOverrides(e,t){if(!e)return null;if(e.type===`CIMGeometricEffectDashes`&&o(e),!t||!e.primitiveName)return{type:`cim-effect-param`,effect:e,overrides:[]};let r=u(e),i=e.primitiveName,a=[];for(let e of t)e.primitiveName===i&&a.push(u(e));return{type:`cim-effect-param`,effect:r,overrides:n(a)}}static async resolveSymbolOverrides(n,r,i,a,o,s,c){if(!n?.symbol)return null;let{symbol:u,primitiveOverrides:d}=n,f=!!d;if(!f&&!a)return u;u=t(u),d=t(d);let p=!0;if(r||(r={attributes:{}},p=!1),f){if(p||(d=d.filter(e=>!e.valueExpressionInfo?.expression.includes(`$feature`))),c||(d=d.filter(e=>!e.valueExpressionInfo?.expression.includes(`$view`))),d.length>0){let t=l(r.attributes),n={spatialReference:i,fields:t,geometryType:o};await m.createRenderExpressions(d,n),m.evaluateOverrides(d,r,o??`esriGeometryPoint`,s,c,new e(t))}m.applyOverrides(u,d)}return a&&m.applyDictionaryTextOverrides(u,r,a,null),u}static{this._expressionToRenderExpression=new Map}static async createRenderExpressions(e,t){let n=[];for(let r of e){let e=r.valueExpressionInfo;if(!e||m._expressionToRenderExpression.has(e.expression))continue;let i=s(e.expression,t.spatialReference);n.push(i),i.then(t=>m._expressionToRenderExpression.set(e.expression,t))}n.length>0&&await Promise.all(n)}static evaluateOverrides(e,t,n,r,i,a){let o={$view:{scale:i?.scale}};for(let i of e){i.value&&typeof i.value==`object`&&d(i.value)&&(i.propertyName===`Color`||i.propertyName===`StrokeColor`)&&(i.value=p(i.value));let e=i.valueExpressionInfo;if(!e)continue;let s=m._expressionToRenderExpression.get(e.expression);s&&(i.value=f(s,t,o,n,a,r))}}static applyDictionaryTextOverrides(e,t,n,r,o=`Normal`){if(e?.type)switch(e.type){case`CIMPointSymbol`:case`CIMLineSymbol`:case`CIMPolygonSymbol`:case`CIMTextSymbol`:{let i=e.symbolLayers;if(!i)return;for(let a of i)a&&a.type===`CIMVectorMarker`&&m.applyDictionaryTextOverrides(a,t,n,r,e.type===`CIMTextSymbol`?e.textCase:o)}break;case`CIMVectorMarker`:{let i=e.markerGraphics;if(!i)return;for(let e of i)e&&m.applyDictionaryTextOverrides(e,t,n,r)}break;case`CIMMarkerGraphic`:{let s=e.textString;if(s&&s.includes(`[`)){let c=a(s,n);e.textString=i(t,c,r,o)}}}}static applyOverrides(e,t,n,i){if(e.primitiveName){for(let a of t)if(a.primitiveName===e.primitiveName){let t=r(a.propertyName);if(i&&i.push({cim:e,nocapPropertyName:t,value:e[t]}),n){let t=!1;for(let r of n)r.primitiveName===e.primitiveName&&(t=!0);t||n.push(a)}a.value!=null&&(e[t]=a.value)}}switch(e.type){case`CIMPointSymbol`:case`CIMLineSymbol`:case`CIMPolygonSymbol`:if(e.effects)for(let r of e.effects)m.applyOverrides(r,t,n,i);if(e.symbolLayers)for(let r of e.symbolLayers)m.applyOverrides(r,t,n,i);break;case`CIMTextSymbol`:break;case`CIMSolidStroke`:case`CIMSolidFill`:case`CIMVectorMarker`:if(e.effects)for(let r of e.effects)m.applyOverrides(r,t,n,i);if(e.type===`CIMVectorMarker`&&e.markerGraphics)for(let r of e.markerGraphics)m.applyOverrides(r,t,n,i),m.applyOverrides(r.symbol,t,n,i)}}static restoreOverrides(e){for(let t of e)t.cim[t.nocapPropertyName]=t.value}static buildOverrideKey(e){let t=``;for(let n of e)n.value!==void 0&&(t+=`${n.primitiveName}${n.propertyName}${JSON.stringify(n.value)}`);return t}static toValue(e,t){if(e===`DashTemplate`)return t.split(` `).map(e=>Number(e));if(e===`Color`){let e=new c(t).toRgba();return e[3]*=255,e}return t}};export{m as t};