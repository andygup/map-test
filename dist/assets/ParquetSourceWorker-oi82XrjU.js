import{Af as e,BT as t,Ef as n,En as r,_D as i,af as a,bf as o,dD as s,ef as c,iv as l,lf as u,mD as d,pD as f,uE as p,ud as m,wx as h,yp as g}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./OptimizedFeatureSet-CTIqq8fn.js";import"./featureConversionUtils-_DSSMFQ2.js";import"./WhereClause-CO9FHcAq.js";import{n as _}from"./QueueProcessor-BtMHt_WC.js";import"./bundle-BeTxitUr.js";import"./WhereClauseCache-Hc_hnaJ1.js";import"./QueryEngineCapabilities-BJYIHckU.js";import{r as v}from"./clientSideDefaults-hJqezokg.js";import"./generateRendererUtils-3fX8Itfa.js";import"./utils-DD8h9sO0.js";import"./timeSupport-DTr00ezP.js";import{n as y,r as b,t as x}from"./QueryEngine-BmSuo7NQ.js";import"./queryUtils-DcyDFw5_.js";import"./quantizationUtils-CGy9nkLl.js";import"./utils-DhzlDVJ-.js";import"./utils-DfE5TL5h.js";import"./SnappingCandidate-CSwuQTV6.js";import"./FixedIntervalBinParameters-Dvwocz3j.js";import"./locationUtils-DHi0m037.js";import{a as S,i as C,n as w,o as T,r as E}from"./parquetUtils-yufJTvRq.js";import{r as D,t as O}from"./parquet-Z-9I3S-h.js";import"./labelPoint-vGsL2GFc.js";import{i as k}from"./callExpressionWithCursor-BmfrFX6I.js";import{i as A,n as j,t as M}from"./FeatureSetReaderParquet-xKzYk91g.js";import{t as N}from"./FeatureMetadata-i54qdN5K.js";function P(e){switch(e.type){case`wkb`:return S.fromJSON(e);case`location`:return T.fromJSON(e)}}var F=new k,I=4,L=8e3,R=`__OBJECTID`,z=class{constructor(){this._fileInfos=new Map,this._queue=new _({concurrency:I,process:(e,t)=>this._executeQuery(e,t)})}async load(a){let s=a.spatialReference?h.fromJSON(a.spatialReference):void 0;if(s&&!s.isWGS84&&!s.isWebMercator)throw new t(`parquet:unsupported-projection`,`Only WGS84 and Web Mercator are supported`);let c=await w({urls:new l(a.urls),fields:a.fields?.map(e=>m.fromJSON(e)),geometryEncoding:a.geometryEncoding?P(a.geometryEncoding):null,geometryType:a.geometryType?E(a.geometryType):null,spatialReference:s},{customParameters:a.customParameters}),f;if(c.geometryType&&c.geometryEncoding){if(!c.spatialReference)throw new t(`parquet:unsupported`,`SpatialReference must be defined`);if(!c.spatialReference.isGeographic&&!c.spatialReference.isWebMercator)throw new t(`parquet:unsupported-projection`,`Only WGS84 and Web Mercator are supported`);c.spatialReference.isGeographic&&!c.spatialReference.isWGS84&&(p.getLogger(`parquet:unsupported-projection`).warn(`Found a geographic projection that is not WGS84. Handling as WGS84.`,{spatialReference:c.spatialReference}),c.spatialReference=h.WGS84),f={geometryType:C(c.geometryType),spatialReference:c.spatialReference.toJSON(),geometryEncoding:c.geometryEncoding.toJSON(),displayOptimization:c.displayOptimization}}this.setCustomParameters(a.customParameters),this._geometryInfo=f;let g=a.urls;for(let e of g){let t=await O(e,{geometryInfo:f,outSpatialReference:null,getCustomParameters:()=>this._customParameters});this._fileInfos.set(e,{index:this._fileInfos.size,file:t})}this._capabilities=G(await this.getFileStatistics());let _=this._fileInfos.values().next().value?.file;if(!_)return{layerDefinition:{},capabilities:G(null)};let{fields:y}=c;if(y==null)throw new t(`parquet-layer:missing-metadata`,`Unable to create parquet source: cannot infer fields`,y);y.push(new m({name:R,type:`oid`,alias:R}));let b={fields:y.map(e=>({...e.toJSON(),column:_.columnForFieldName(e.name)})),timeZoneByFieldName:null};this._fieldsIndex=r.fromJSON(b);let x=C(c.geometryType??`point`);if(this._metadata=N.createFeature({fieldsIndex:b,geometryType:x,featureIdInfo:{type:`object-id`,fieldName:`rowId`},subtypes:null,subtypeField:null,types:null,typeIdField:null,globalIdField:null,spatialReference:c.spatialReference,outSpatialReference:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null}),this._queryEngineParams={fieldsIndex:this._metadata.fieldsIndex,geometryType:f?.geometryType??`esriGeometryPoint`,featureIdInfo:{type:`object-id`,fieldName:`rowId`},hasM:!1,hasZ:!1,spatialReference:f?.spatialReference??{wkid:4326},aggregateAdapter:null,timeInfo:null,definitionExpression:null},c.spatialReference&&(this._fullExtent=W(this._fileInfos.values(),c.spatialReference.toJSON())),this._fullExtent==null&&c.geometryEncoding?.type===`location`){let{yField:t,xField:r}=c.geometryEncoding,a=this._fieldsIndex.get(r)?.column,s=this._fieldsIndex.get(t)?.column,l=n(o(),u);for(let t of this._fileInfos.values())for(let n of t.file.rowGroups()){let t={stack:[],error:void 0,hasError:!1};try{let r=d(t,n.columnDescriptorForAttribute(a),!1),i=d(t,n.columnDescriptorForAttribute(s),!1),o=[r.minValue(),i.minValue(),r.maxValue(),i.maxValue()];e(l,o),n.free()}catch(e){t.error=e,t.hasError=!0}finally{i(t)}}this._fullExtent={xmin:l[0],ymin:l[1],xmax:l[3],ymax:l[4],spatialReference:c.spatialReference?.toJSON()}}return{capabilities:this._capabilities,layerDefinition:{fields:c.fields?.map(e=>e.toJSON()),drawingInfo:v(x),extent:this._fullExtent??void 0,geometryType:x,geometryEncoding:c.geometryEncoding?.toJSON(),displayOptimization:c.displayOptimization}}}destroy(){for(let e of this._fileInfos.values())e.file.free();this._fileInfos.clear(),this._queue.destroy()}setCustomParameters(e){this._customParameters=e}getFileStatistics(){if(!this._fileInfos.size)return null;let e=Array.from(this._fileInfos.values()).reduce((e,t)=>e+t.file.byteLength(),0);return{featureCount:this._getFeatureCount(),byteLength:e}}async updateFiles(e){let t=new Set(e);for(let[e,n]of this._fileInfos.entries())t.has(e)?t.delete(e):(n.file.free(),this._fileInfos.delete(e));for(let e of t){let t=await O(e,{geometryInfo:this._geometryInfo,outSpatialReference:null,getCustomParameters:()=>this._customParameters});this._fileInfos.set(e,{index:this._fileInfos.size,file:t})}}async queryFeatures(e,t){return this._validateQuery(e),K(e)||(e.resultRecordCount=e.resultRecordCount?Math.min(e.resultRecordCount,8e3):8e3,e.resultOffset=e.resultOffset??0),(e.outStatistics||e.returnDistinctValues)&&delete e.returnGeometry,(await this._enqueueQuery(e,t)).createQueryResponse()}async queryFeatureCount(e,t){return this._validateQuery(e),B(e)?(delete e.outFields,delete e.returnGeometry,(await this._enqueueQuery(e,t)).createQueryResponseForCount()):this._getFeatureCount()}async queryObjectIds(e,t){return this._validateQuery(e),B(e)?(e.resultRecordCount=e.resultRecordCount?Math.min(e.resultRecordCount,8e3):8e3,e.resultOffset=e.resultOffset??0,delete e.returnGeometry,delete e.outFields,(await this._enqueueQuery(e,t)).items.map(e=>e.getObjectId())):Array.from({length:this._getFeatureCount()},(e,t)=>t)}async queryExtent(e,t){if(this._validateQuery(e),this._fullExtent&&!B(e))return{count:this._getFeatureCount(),extent:this._fullExtent};let r=s(this._metadata.spatialReference);e.returnGeometry=!0,delete e.outFields;let i=n(o(),u),c=o(),l=await this._enqueueQuery(e,t),d=0;for(let e of l.items)e.getBounds(c)&&(a(i,c),d+=1);return{count:d,extent:y(i,r,e.outSR?s(e.outSR):r,r,!1)}}_getFeatureCount(){return Array.from(this._fileInfos.values()).reduce((e,t)=>e+t.file.numRows(),0)}_validateQuery(e){if(!this._capabilities.query.supportsStatistics&&e.outStatistics)throw new t(`parquet:unsupported`,`Statistics queries are not supported`,{query:e});if(!this._capabilities.query.supportsOrderBy&&e.orderByFields?.length)throw new t(`parquet:unsupported`,`Queries using orderBy are not supported`,{query:e});if(!this._capabilities.query.supportsDistinct&&e.returnDistinctValues)throw new t(`parquet:unsupported`,`Queries using returnDistinctValues are not supported`,{query:e})}async*_fetchChunks(e,t){for(let n of this._fileInfos.values()){let r=n.file.numRows(),i=Math.ceil(r/L);for(let r=0;r<i;r++){let i=r*L,a=await n.file.readChunk(i,L,e.fields,e.returnGeometry,t);for(let e of a){let t=new M(this._metadata,this._fieldsIndex,e,0,n.index);yield H([new A(t,null,0,!1)],this._queryEngineParams)}}}}_enqueueQuery(e,t){return this._queue.push(e,t)}async _executeQuery(e,t){let n=await this._getReadParams(e);if(e.objectIds?.length)for(let r of this._fileInfos.values()){let i=[],a=H((await r.file.readChunksByRowId(new Uint32Array(e.objectIds),n.fields,n.returnGeometry,t)).map((e,t)=>new M(this._metadata,this._fieldsIndex,e,t,r.index)).map((e,t)=>new A(e,null,t,!1)),this._queryEngineParams),o=await a.executeQueryForOpaqueFeatures(e,t);for(let e of o)i.push(e);return new b(i,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:`rowId`,hasM:!1,hasZ:!1,featureAdapter:F})}let r=e.resultRecordCount??this._getFeatureCount(),i=e.resultOffset??0;delete e.resultRecordCount,delete e.resultOffset;let a=[];for await(let o of this._fetchChunks(n,t)){let n=await o.executeQueryForOpaqueFeatures(e,t);if(n.length>i){let t=n.slice(i,Math.min(i+r,n.length));for(let e of t)a.push(e);if(i=0,r-=t.length,r===0)return new b(a,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:`rowId`,hasM:!1,hasZ:!1,featureAdapter:F})}else i-=n.length}return new b(a,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:`rowId`,hasM:!1,hasZ:!1,featureAdapter:F})}async _getReadParams(e){let t=new Set;if(e.where&&await g(t,this._fieldsIndex,e.where),e.outStatistics)for(let n of e.outStatistics)n.onStatisticField!=null&&t.add(n.onStatisticField);if(e.outFields)for(let n of e.outFields)t.add(n);return{fields:this._getAttributeIds(Array.from(t)),returnGeometry:!!e.returnGeometry||!!e.geometry}}_getAttributeIds(e){if(e==null)return new Uint32Array;if(e.includes(`*`))return new Uint32Array(this._fieldsIndex.fields.map(e=>e.column).filter(e=>e!=null));let n=[];for(let r of e){let e=this._fieldsIndex.get(r);if(e==null)throw new t(`unknown-field`,`Field ${r} does not exist`);e.column==null||n.push(e.column)}return new Uint32Array(n)}};function B(e){return Object.keys(e).some(e=>V(e))}function V(e){switch(e){case`resultOffset`:case`resultRecordCount`:case`aggregateIds`:case`distance`:case`gdbVersion`:case`geometry`:case`having`:case`timeExtent`:case`where`:case`objectIds`:case`historicMoment`:return!0;default:return!1}}function H(e,t){let n=new j;for(let t of e)n.insert(t);return new x({...t,featureStore:n})}function U(e){switch(e.length){case 4:return c(o(),e);case 6:return e;default:throw new t(`parquet:protocol-violation`,`Invalid Geoparquet file. BoundingBox size must be 4 or 6.`,{bbox:e})}}function W(e,t){let r=n(o(),u);for(let t of e){let e=D(t.file);if(!e)return null;let n=e.columns[e.primary_column];if(!n.bbox)return null;let i=U(n.bbox);a(r,i)}return{xmin:r[0],ymin:r[1],xmax:r[3],ymax:r[4],spatialReference:t}}function G(e){let t=e?.featureCount,n=!1;return t!=null&&t<f(`parquetlayer-full-query-feature-count`)&&(n=!0),{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,isBranchVersioned:!1,supportedCurveTypes:[],supportsAttachment:!1,supportsM:!1,supportsTrueCurve:!1,supportsZ:!1},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryBins:!1,supportsQueryPivot:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},query:{maxRecordCount:8e3,maxRecordCountFactor:void 0,maxUniqueIDCount:void 0,standardMaxRecordCount:void 0,supportsCacheHint:!1,supportsCentroid:!0,supportsCentroidOnDegeneratedQuantizedGeometry:!1,supportsCurrentUser:!1,supportsDegeneratedQuantizedGeometry:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:n,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:n,supportsPagination:!0,supportsPaginationOnAggregatedQueries:!1,supportsPercentileStatistics:!1,supportsQuantization:!0,supportsQuantizationEditMode:!1,supportsQueryByAnonymous:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsReturnMesh:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsStatistics:n,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsCompactGeometry:!1,supportsSqlExpression:!1,supportsTrueCurve:!1,tileMaxRecordCount:void 0},queryAttributeBins:{supportsDate:!1,supportsFixedInterval:!1,supportsAutoInterval:!1,supportsFixedBoundaries:!1,supportsStackBy:!1,supportsSplitBy:!1,supportsSnapToData:!1,supportsReturnFullIntervalBin:!1,supportsFirstDayOfWeek:!1,supportsNormalization:!1},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsTrueCurveUpdate:!1,supportsTrueCurveUpdateByTrueCurveClientsOnly:!0,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUploadWithItemId:!1,supportsUpdateWithoutM:!1,supportsAsyncApplyEdits:!1,zDefault:void 0}}}function K(e){return!!(e.objectIds?.length||e.outStatistics||e.orderByFields?.length||e.returnDistinctValues)}export{z as default};