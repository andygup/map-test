import{Aw as e,BT as t,Bb as n,Cy as r,D_ as i,Db as a,Eb as o,Ey as s,Fb as c,I_ as l,Iy as u,Nb as d,Ny as f,Oy as p,Py as m,Qv as h,Sg as g,Tw as _,Uu as v,VT as y,_y as ee,ab as b,dS as x,fb as S,kD as C,ky as w,lg as T,lv as E,ph as D,pv as O,rE as k,sS as A,yy as j,zb as M,zv as N}from"./index-BN8X5Ryz.js";import{c as P,m as F}from"./elevationInfoUtils-uoMH3ofe.js";import{r as te,s as I}from"./colorUtils-CzajW9E7.js";import{t as L}from"./getDefaultUnitForView-DyZIV1hK.js";import{a as R}from"./quantityFormatUtils-DorrZj0i.js";import{t as z}from"./vec3-B94Y7ih2.js";function B(e,t,n){if(w(t))return[e[0]+n*(t[0]-e[0]),e[1]+n*(t[1]-e[1])];if(f(t))return S(e,t,n);if(m(t)){let r=u(e,t);return b(r,n)}if(s(t)){let i=r(e,t);return b(i,n)}let i=j(e,t);return ee(i,n)}var V=e=>({vnodeSelector:``,properties:void 0,children:void 0,text:e.toString(),domNode:null}),H=(e,t,n)=>{for(let r=0,i=t.length;r<i;r++){let i=t[r];Array.isArray(i)?H(e,i,n):i!=null&&!1!==i&&(typeof i==`string`&&(i=V(i)),n.push(i))}};function U(e,t,n){if(Array.isArray(t))n=t,t=void 0;else if(t&&(typeof t==`string`||t.hasOwnProperty(`vnodeSelector`))||n&&(typeof n==`string`||n.hasOwnProperty(`vnodeSelector`)))throw Error(`h called with invalid arguments`);let r,i;return n&&n.length===1&&typeof n[0]==`string`?r=n[0]:n&&(i=[],H(e,n,i),i.length===0&&(i=void 0)),{vnodeSelector:e,properties:t,children:i,text:r===``?void 0:r,domNode:null}}var W={bottom:`esri-text-overlay-item-anchor-bottom`,"bottom-right":`esri-text-overlay-item-anchor-bottom-right`,"bottom-left":`esri-text-overlay-item-anchor-bottom-left`,top:`esri-text-overlay-item-anchor-top`,"top-right":`esri-text-overlay-item-anchor-top-right`,"top-left":`esri-text-overlay-item-anchor-top-left`,center:`esri-text-overlay-item-anchor-center`,right:`esri-text-overlay-item-anchor-right`,left:`esri-text-overlay-item-anchor-left`},G=class extends e{get position(){return[this.x,this.y]}set position(e){this._set(`x`,e[0]),this._set(`y`,e[1])}get _textShadowColor(){let{textColor:e,backgroundColor:t}=this,n=t.clone();return n.a*=e.a,n}get _textShadow(){let e=this._textShadowColor.toCss(!0);return`0 0 ${this._textShadowSize}px ${e}`}get padding(){return .5*this.fontSize}get borderRadius(){return this.padding}set borderRadius(e){this._overrideIfSome(`borderRadius`,e)}constructor(e){super(e),this.x=0,this.y=0,this.text=`-`,this.fontSize=14,this.anchor=`center`,this.visible=!0,this.isDecoration=!0,this.backgroundColor=new D([0,0,0,.6]),this.textColor=new D([255,255,255]),this._textShadowSize=1}render(){return U(`div`,{classes:this._cssClasses(),styles:{left:Math.floor(this.x)+`px`,top:Math.floor(this.y)+`px`,visibility:this.visible?`visible`:`hidden`,fontSize:this.fontSize+`px`,lineHeight:this.fontSize+`px`,backgroundColor:this.backgroundColor.toCss(!0),color:this.textColor.toCss(!0),padding:this.padding+`px`,borderRadius:this.borderRadius+`px`,textShadow:this._textShadow}},[this.text])}renderCanvas(e){if(!this.visible)return;let t=e.font.replace(/^(.*?)px/,``);e.font=`${this.fontSize}px ${t}`;let{padding:n,borderRadius:r}=this,i=e.measureText(this.text).width,a=this.text===``?0:this.fontSize,o=K[this.anchor];e.textAlign=`center`,e.textBaseline=`middle`;let s=i+2*n,c=a+2*n,l=this.x+o.x*s,u=this.y+o.y*c;this._roundedRect(e,l,u,s,c,r),e.fillStyle=this.backgroundColor.toCss(!0),e.fill();let d=this.x+(o.x+.5)*s,f=this.y+(o.y+.5)*c;this._renderTextShadow(e,this.text,d,f),e.fillStyle=this.textColor.toCss(!0),e.fillText(this.text,d,f)}_renderTextShadow(e,t,n,r){e.lineJoin=`miter`,e.fillStyle=`rgba(${this._textShadowColor.r}, ${this._textShadowColor.g}, ${this._textShadowColor.b}, ${1/q.length})`;let i=this._textShadowSize;for(let[a,o]of q)e.fillText(t,n+i*a,r+i*o)}_roundedRect(e,t,n,r,i,a){a=Math.min(a,i/2,r/2),e.beginPath(),e.moveTo(t,n+a),e.arcTo(t,n,t+a,n,a),e.lineTo(t+r-a,n),e.arcTo(t+r,n,t+r,n+a,a),e.lineTo(t+r,n+i-a),e.arcTo(t+r,n+i,t+r-a,n+i,a),e.lineTo(t+a,n+i),e.arcTo(t,n+i,t,n+i-a,a),e.closePath()}_cssClasses(){let e={"esri-text-overlay-item":!0},t;for(t in W)e[W[t]]=this.anchor===t;return e}};C([t()],G.prototype,`x`,void 0),C([t()],G.prototype,`y`,void 0),C([t()],G.prototype,`position`,null),C([t()],G.prototype,`text`,void 0),C([t()],G.prototype,`fontSize`,void 0),C([t()],G.prototype,`anchor`,void 0),C([t()],G.prototype,`visible`,void 0),C([t()],G.prototype,`isDecoration`,void 0),C([t()],G.prototype,`backgroundColor`,void 0),C([t()],G.prototype,`textColor`,void 0),C([t()],G.prototype,`_textShadowSize`,void 0),C([t()],G.prototype,`_textShadowColor`,null),C([t()],G.prototype,`_textShadow`,null),C([t()],G.prototype,`padding`,null),C([t()],G.prototype,`borderRadius`,null),G=C([y(`esri.views.overlay.TextOverlayItem`)],G);var K={bottom:{x:-.5,y:-1,textAlign:`center`,textBaseline:`bottom`},"bottom-left":{x:0,y:-1,textAlign:`left`,textBaseline:`bottom`},"bottom-right":{x:-1,y:-1,textAlign:`right`,textBaseline:`bottom`},center:{x:-.5,y:-.5,textAlign:`center`,textBaseline:`middle`},left:{x:0,y:-.5,textAlign:`left`,textBaseline:`middle`},right:{x:-1,y:-.5,textAlign:`right`,textBaseline:`middle`},top:{x:-.5,y:0,textAlign:`center`,textBaseline:`top`},"top-left":{x:0,y:0,textAlign:`left`,textBaseline:`top`},"top-right":{x:-1,y:0,textAlign:`right`,textBaseline:`top`}},q=[];for(let e=0;e<360;e+=360/16)q.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);var J=3025,Y={default:15,far:25},X=class extends e{constructor(e){super(e),this.context=null,this.stagedVertex=null,this.visible=!0,this.edgeDistance=`default`,this._messageUnitsTask=null,this._labelInfos=[],this._nextLabelIndex=0}initialize(){this.addHandles([O(()=>[this.context!=null&&this.getCameraOrExtent(this.context),this.visible,this._edgeDistancePixels,this.stagedVertex,this._messagesUnits],()=>this._update()),E(()=>this.context?.editGeometryOperations,[`vertex-add`,`vertex-remove`],()=>this._update()),E(()=>this.context?.editGeometryOperations,`vertex-update`,e=>this._update(e.vertices)),O(()=>this._colors,e=>this._updateStyle(e)),i(()=>this._refreshMessages()),k(()=>this._messageUnitsTask?.abort())]),this._refreshMessages()}destroy(){for(this._nextLabelIndex=0;this._labelInfos.length;)this._destroyLabel(this._labelInfos.pop())}get updating(){return this._messagesUnits==null}get test(){}get _messagesUnits(){return this._messageUnitsTask?.value}get _edgeDistancePixels(){return Y[this.edgeDistance]}get _colors(){let e=this.context?.view.effectiveTheme.textColor??D.fromArray([255,255,255]);return{textColor:e,backgroundColor:te(I(e,160),.6)}}_update(e){if(this.destroyed)return;this._nextLabelIndex=0;let{context:t,stagedVertex:n}=this;if(!t)return this._destroyUnusedLabels();let r=t.editGeometryOperations.data,{parts:i,geometry:a,coordinateHelper:o}=r;if(!a)return this._destroyUnusedLabels();let s=i.length;for(let i=0;i<s;++i){let c=this.getRing(a,r,n,o,i),l=c.map(e=>z(e)?e:o.arrayToXYZ(p(e)));if(c.length<2||!Z(c,t.view,t.elevationInfo,o.spatialReference))continue;let u=s===1&&!h(l),d=re,f=ie;this.toScreenPointArray(t,l[0],d);for(let n=1;n<c.length;++n){let r=l[n-1],a=l[n],o=c[n];this.toScreenPointArray(t,a,f);let s=n===l.length-1,p=!(!e?.length||e.some(({index:e,part:t})=>t.index===i&&(e===n-1||e===n||s&&e===0)));this._addLabel(t,r,d,a,z(o)?null:o,f,u,p),[d,f]=[f,d]}}this._destroyUnusedLabels()}_updateStyle({textColor:e,backgroundColor:t}){let n=this._nextLabelIndex,r=this._labelInfos;for(let i=0;i<n;++i){let{label:n}=r[i];n.textColor=e,n.backgroundColor=t}}_addLabel(e,t,r,i,s,l,u,f=!1){let{label:p,wasReused:m}=this._getOrCreateLabel(e);if(!this.visible||a(r,l)<J)return void(p.visible=!1);let{spatialReference:h,coordinateHelper:g}=e.editGeometryOperations.data;if(!f||!m){let n=!s||w(s)?e.automaticLengthMeasurementUtils.autoDistance2D(t,i,h):e.automaticLengthMeasurementUtils.autoLength2D(new N({spatialReference:h,curvePaths:[[[t[0],t[1]],s]]})),r=this._messagesUnits,a=L(e.view);p.text=r!=null&&n!=null?R(r,n,a):``}p.visible=!0;let _=l[0]-r[0],v=l[1]-r[1];if(u?c(Q,-v,_):c(Q,v,-_),n(Q,Q),d(Q,Q,this._edgeDistancePixels),s&&!w(s)){let n=g.arrayToXYZ(B(t,s,.5)),r=this.toScreenPointArray(e,n);M($,r,Q)}else o($,r,l,.5),M($,$,Q);p.position=[$[0],$[1]],Math.abs(Q[0])>Math.abs(Q[1])?p.anchor=Q[0]>0?`left`:`right`:p.anchor=-Q[1]<0?`top`:`bottom`}_getOrCreateLabel(e){let t=this._labelInfos.length>this._nextLabelIndex,{textColor:n,backgroundColor:r}=this._colors;if(t){let e=this._labelInfos[this._nextLabelIndex++],{label:t}=e;return t.textColor=n,t.backgroundColor=r,e.wasReused=!0,e}let i=new G({anchor:`center`,fontSize:8,textColor:n,backgroundColor:r});e.view.overlay?.items.add(i);let a={label:i,wasReused:!1};return this._labelInfos.push(a),this._nextLabelIndex=this._labelInfos.length,a}_destroyUnusedLabels(){for(;this._labelInfos.length>this._nextLabelIndex;)this._destroyLabel(this._labelInfos.pop())}_destroyLabel({label:e}){this.context?.view.overlay?.items.remove(e),e.destroy()}_refreshMessages(){this._messageUnitsTask?.abort(),this._messageUnitsTask=g(()=>l(`esri/core/t9n/Units`))}};function Z(e,t,n,r){if(t.type===`2d`)return!0;let i=x(r)??1,a=A(r),o=e=>P(t,e,r,n,F)??0;for(let t=1;t<e.length;++t){let n=e[t-1],r=e[t];if(!z(n)||!z(r))return!1;let s=(r[0]-n[0])*i,c=(r[1]-n[1])*i,l=(o(r)-o(n))*a;if(Math.abs(l)/Math.sqrt(s*s+c*c)>ne)return!1}return!0}C([t()],X.prototype,`context`,void 0),C([t()],X.prototype,`stagedVertex`,void 0),C([t()],X.prototype,`visible`,void 0),C([t()],X.prototype,`edgeDistance`,void 0),C([t()],X.prototype,`updating`,null),C([t()],X.prototype,`_messageUnitsTask`,void 0),C([t()],X.prototype,`_messagesUnits`,null),C([t()],X.prototype,`_edgeDistancePixels`,null),C([t()],X.prototype,`_colors`,null),X=C([y(`esri.views.interactive.SegmentLabels`)],X);var ne=_(5),Q=v(),$=v(),re=T(),ie=T();export{X as t};