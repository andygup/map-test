import{b1 as At,bx as A,d0 as P,X as a,Y as h,a3 as Ht,am as $t,gm as lt,p$ as Vt,q0 as Ft,iv as U,bD as k,q1 as St,bE as I,dX as Lt,fN as jt,kr as ct,pd as Bt,ov as Y,dF as K,df as G,q2 as dt,q3 as pt,q4 as Q,q5 as V,ix as ft,h$ as qt,q6 as zt,q7 as Nt,bU as Z,pE as Wt,bo as F,q8 as Ut,q9 as mt,fF as gt,nh as _t,qa as wt,qb as kt,qc as Yt,i0 as Xt,kn as L,kk as J,ob as j,kA as Kt,dG as vt,c1 as yt,c2 as Mt,nl as Qt,ak as Zt,qd as Jt,qe as te}from"./index-C-FXvluM.js";import{t as ee}from"./NestedMap-GuqgquCN.js";import{t as ie}from"./glUtil-DIb2YQRb.js";import{n as E}from"./NormalAttribute.glsl-BzcwcK9j.js";import{O as re}from"./basicInterfaces-CZwQPxTp.js";import{Q as se,G as xt}from"./Geometry-BTp0yhOg.js";import{s as tt}from"./Util-B1cu74ll.js";import{H as ne,N as oe,L as ae}from"./Octree-CXz4dNsB.js";import{o as he}from"./VertexArrayObject-DcaNvwOy.js";const ue={required:[]};E.Depth;let Pt=class extends At{precompile(e){const i=this.acquireTechniques(e);return ce(i),i!=null}consumes(){return ue}get usedMemory(){return 0}get isDecoration(){return!1}get running(){return!1}modify(e){}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmissions(){return!1}forEachGeometry(e){}queryRenderOccludedState(e){return!1}};class le extends Pt{}let $e=class extends Pt{};function ce(t){Array.isArray(t)?t.forEach(e=>e==null?void 0:e.release()):t==null||t.release()}let de=class{constructor(e,i){this._material=e,this._repository=i,this._map=new Map}dispose(){this._map.forEach((e,i)=>{e!=null&&this._repository.release(this._material,i)})}load(e,i,r){const s=this._material.produces.get(i);if(!(s!=null&&s(r)))return null;this._map.has(r)||this._map.set(r,this._repository.acquire(this._material,i,r));const n=this._map.get(r);if(n!=null){if(n.ensureResources(e)===re.LOADED)return n;this._repository.requestRender()}return null}},pe=class extends se{constructor(e=A()){super(),this.origin=e}get slicePlaneLocalOrigin(){return this.origin}};var Dt,H;(function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"})(Dt||(Dt={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}(H||(H={}));let ut=class{constructor(e=0,i=0){this.from=e,this.to=i}get numElements(){return this.to-this.from}};function Ot(t){const e=new Map;t.forAll(r=>e.set(r.from,r));let i=!0;for(;i;){i=!1;for(let r=0;r<t.length;++r){const s=t.data[r],n=e.get(s.to);if(!n)return;s.to=n.to,e.delete(n.from),t.removeUnordered(n),i=!0}}}class Tt extends ut{constructor(e,i,r){super(i,r),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.isVisible&&this.geometry.hasHighlights}foreachHighlightGroup(e){this.isVisible&&this.geometry.foreachHighlightGroup(e)}get hasOccludees(){return this.geometry.occludees!=null}}let fe=class{constructor(){this.first=0,this.count=0}},me=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new P({allocator:e=>e||new ut,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightGroups=new Set,this.drawCommandsDefault=B(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=B(),this.drawCommandsShadowHighlightRest=B()}get numElements(){return this._numElements}get instances(){return this._instances}get hasHighlights(){return this.highlightGroups.size>0}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightGroups.clear()}updateIfDrawCommandsDirty(e){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const i of this.instances.values())this.updateDrawState(i);this.updateDrawCommands(e)}}addInstance(e,i){this.deleteInstance(e),this._instances.set(e,i),this._numElements+=i.numElements}deleteInstance(e){const i=this._instances.get(e);i&&(this._numElements-=i.numElements,this._instances.delete(e))}updateInstance(e,i,r){const s=this._instances.get(e);s&&(this._numElements-=s.numElements,s.from=i,s.to=r,this._numElements+=s.numElements)}updateDrawState(e){e.isVisible?(e.foreachHighlightGroup(i=>this.highlightGroups.add(i)),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlights.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;if(!this.needsMultipleCommands()){const s=this.drawCommandsDefault.pushNew(),n=this.holes.front();return this.vao!=null&&this.holes.length===1&&n.to===Math.floor(this.vao.byteSize/e)?(s.first=0,void(s.count=n.from)):(s.first=1/0,s.count=0,this._instances.forEach(u=>{s.first=Math.min(s.first,u.from),s.count=Math.max(s.count,u.to)}),void(s.count-=s.first))}const i=Array.from(this._instances.values()).sort((s,n)=>s.from===n.from?s.to-n.to:s.from-n.from),{drawCommandsHighlights:r}=this;for(const s of i)s.isVisible&&(et(s.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,s),s.hasHighlights?s.foreachHighlightGroup(n=>{let u=r.get(n);u||(u=B(),r.set(n,u)),et(u,s)}):et(this.drawCommandsShadowHighlightRest,s))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function ge(t){return t.vao!=null}function B(){return new P({allocator:t=>t||new fe,deallocator:t=>t})}function et(t,e){const i=t.back();if(i==null){const r=t.pushNew();return r.first=e.from,void(r.count=e.numElements)}if(_e(i,e)){const r=e.from-i.first+e.numElements;i.count=r}else{const r=t.pushNew();r.first=e.from,r.count=e.numElements}}function _e(t,e){return t.first+t.count>=e.from}let we=class{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(i=>i.instances.has(e))}},it=class extends le{get _hasAnyHighlight(){return this._highlightGroups.size>0}constructor(t){super(t),this._dataByOrigin=new Map,this._drawParameters=new pe,this._highlightGroups=new Set,this.drapedPriority=0,this._produces=new Map,this._hasOccludees=!1}destroy(){this._glMaterials=$t(this._glMaterials),this._dataByOrigin.forEach(t=>t.dispose()),this._dataByOrigin.clear(),this._vaoCache=null}initialize(){this.material.produces.forEach((t,e)=>{this._produces.set(e,i=>!(this._dataByOrigin.size===0||!(i!==E.Highlight&&i!==E.ShadowHighlight||this._hasAnyHighlight))&&t(i))})}initializeRenderContext(t,e){this._glMaterials=new de(this.material,e??t.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=t.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,ie(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get produces(){return this._produces}get hasOccludees(){return this._hasOccludees}get hasEmissions(){return this.material.hasEmissions}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(t){return this.material.queryRenderOccludedState(t)}get numGeometries(){let t=0;return this._dataByOrigin.forEach(e=>t+=e.buffers.reduce((i,r)=>i+r.instances.size,0)),t}get usedMemory(){let t=0;return this._dataByOrigin.forEach(e=>t+=e.buffers.reduce((i,r)=>i+r.vao.usedMemory,0)),t}forEachGeometry(t){this._dataByOrigin.forEach(e=>e.buffers.forEach(i=>i.instances.forEach(({geometry:r})=>t(r))))}modify(t){this._updateGeometries(t.updates),this._addAndRemoveGeometries(t.adds,t.removes),this._updateDrawCommands()}_updateGeometries(t){const e=this._bufferWriter;if(e==null)return;const i=e.vertexBufferLayout.stride/4;for(const r of t){const s=r.renderGeometry,n=this._dataByOrigin.get(s.localOrigin.id),u=n==null?void 0:n.findBuffer(s.id);if(u==null)return;const c=u.instances.get(s.id);if(r.updateType&(H.GEOMETRY|H.TRANSFORMATION)){const d=N(e.elementCount(c.geometry.geometry.attributes)*i),f=e.vertexBufferLayout.createView(d.buffer);this._writeGeometry(s,f,0),u.vao.vertexBuffers.get("geometry").setSubData(d,c.from*i,0,c.numElements*i)}r.updateType&(H.HIGHLIGHT|H.OCCLUDEE|H.VISIBILITY)&&(u.drawCommandsDirty=!0)}}_computeDeltas(t,e){const i=new ee;for(const r of t){const s=r.localOrigin;if(s==null)continue;let n=i.get(s.id,null);n==null&&(n=new bt(s.vec3),i.set(s.id,null,n)),n.changes.push(r)}for(const r of e){const s=r.localOrigin;if(s==null)continue;const n=this._dataByOrigin.get(s.id),u=n==null?void 0:n.findBuffer(r.id);if(u==null)continue;let c=i.get(s.id,u);c==null&&(c=new bt(s.vec3),i.set(s.id,u,c)),c.changes.push(r)}return i}_addAndRemoveGeometries(t,e){if(this._bufferWriter==null||this._vaoCache==null)return;const{_bufferWriter:i,_dataByOrigin:r}=this,s=i.vertexBufferLayout.stride/4,n=this._computeDeltas(t,e);n.forEach((u,c)=>{const d=u.get(null),f=(d==null?void 0:d.changes)??[];n.delete(c,null);let _=r.get(c);if(u.forEach((g,m)=>{if(n.delete(c,m),m==null)return void tt(!1,"No VAO for removed geometries");if(m.instances.size===g.changes.length)return this._vaoCache.deleteVao(m.vao),lt(_.buffers,m),void(_.buffers.length===0&&f.length===0&&r.delete(c));const w=m.numElements,y=m.vao.byteSize/4,v=f.reduce((T,b)=>T+i.elementCount(b.geometry.attributes),0),M=g.changes.reduce((T,b)=>T+i.elementCount(b.geometry.attributes),0),x=Math.min((w+v-M)*s,z),O=x>y;x>X&&x<y/2?(g.changes.forEach(({id:T})=>m.deleteInstance(T)),m.instances.forEach(({geometry:T})=>f.push(T)),this._vaoCache.deleteVao(m.vao),lt(_.buffers,m)):O?this._applyAndRebuild(m,f,g):this._applyRemoves(m,g)}),f.length>0)for(_==null&&(_=new we(d.origin),r.set(c,_)),_.buffers.forEach(g=>this._applyAdds(g,f));f.length>0;)_.buffers.push(this._applyAndRebuild(new me,f,null))})}_updateDrawCommands(){this._highlightGroups.clear(),this._hasOccludees=!1,this._dataByOrigin.forEach(t=>{t.buffers.forEach(e=>{e.updateIfDrawCommandsDirty(this._bufferWriter.vertexBufferLayout.stride),e.hasHighlights&&Vt(this._highlightGroups,e.highlightGroups),this._hasOccludees=this._hasOccludees||e.hasOccludees})})}_applyAndRebuild(t,e,i){if(i)for(const w of i.changes)t.deleteInstance(w.id);const r=this._bufferWriter,s=r.vertexBufferLayout.stride,n=s/4,u=Math.floor(z/n);let c=t.numElements;for(;e.length>0;){const w=e.pop(),y=r.elementCount(w.geometry.attributes);if(c+y>u&&c>0){e.push(w);break}c+=y;const v=new Tt(w,0,0);tt(t.instances.get(w.id)==null),t.addInstance(w.id,v)}const d=c*n,f=N(d),_=r.vertexBufferLayout.createView(f.buffer);let g=0;t.resetInstanceSummary(),t.instances.forEach((w,y)=>{this._writeGeometry(w.geometry,_,g);const v=g;g+=r.elementCount(w.geometry.geometry.attributes),t.updateInstance(y,v,g),t.updateDrawState(w)}),this._vaoCache.deleteVao(t.vao),t.vao=this._vaoCache.newVao(Rt(d)),t.vao.vertexBuffers.get("geometry").setSubData(f,0,0,g*n),t.holes.clear();const m=t.holes.pushNew();return m.from=g,m.to=Math.floor(t.vao.byteSize/s),t.updateDrawCommands(s),t}_applyRemoves(t,e){if(e.changes.length===0||this._bufferWriter==null)return;for(const u of e.changes){const c=u.id,d=t.instances.get(c);if(!d)continue;t.deleteInstance(c);const f=R.back();if(f){if(f.to===d.from){f.to=d.to;continue}if(f.from===d.to){f.from=d.from;continue}}const _=R.pushNew();_.from=d.from,_.to=d.to}Ot(R);const i=this._bufferWriter.vertexBufferLayout.stride/4,r=R.reduce((u,c)=>Math.max(u,c.numElements),0)*i,s=N(r);s.fill(0,0,r);const n=t.vao.vertexBuffers.get("geometry");R.forAll(u=>n.setSubData(s,u.from*i,0,u.numElements*i)),t.holes.pushArray(R.data,R.length),R.forAll((u,c)=>R.data[c]=null),R.clear(),t.drawCommandsDirty=!0}_applyAdds(t,e){if(e.length===0||this._bufferWriter==null)return;if(!ge(t))return void this._applyAndRebuild(t,e,null);const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4,s=t.numElements,n=e.reduce((M,x)=>M+i.elementCount(x.geometry.attributes),0),u=Math.min((s+n)*r,z),c=4*u;if(t.vao.byteSize<Rt(z-X)&&c>t.vao.byteSize)return void this._applyAndRebuild(t,e,null);Ot(t.holes);const d=new Array;for(const M of e){const x=i.elementCount(M.geometry.attributes),O=ve(t.holes,x);d.push(O)}const f=t.vao.vertexBuffers.get("geometry");let _=0,g=0,m=0;const w=N(u),y=i.vertexBufferLayout.createView(w.buffer);e.forEach((M,x)=>{const O=d[x];if(O==null)return;if(m!==O){const C=m-g;C>0&&f.setSubData(w,g*r,0,C*r),g=O,_=0}const T=i.elementCount(M.geometry.attributes);this._writeGeometry(M,y,_),_+=T,m=O+T;const b=new Tt(M,O,O+T);tt(t.instances.get(M.id)==null),t.addInstance(M.id,b),t.drawCommandsDirty=!0});const v=m-g;v>0&&f.setSubData(w,g*r,0,v*r),Ft(e,(M,x)=>d[x]==null)}_writeGeometry(t,e,i){this._bufferWriter!=null&&(U(S,t.transformation),S[12]-=t.localOrigin.vec3[0],S[13]-=t.localOrigin.vec3[1],S[14]-=t.localOrigin.vec3[2],k(q,S),St(q,q),this._bufferWriter.write(S,q,t.geometry.attributes,t.geometry.objectAndLayerIdColor,e,i))}updateAnimation(t){return this.material.update(t)}acquireTechniques(t){var m;if(!this.material.shouldRender(t))return null;const{output:e,bind:i}=t,r=this.material.produces.get(i.slot);if(!(r!=null&&r(e)))return null;const{highlightGroupName:s,slot:n}=i,u=e===E.ShadowHighlight,c=e===E.Highlight,d=c||u,f=w=>d&&(this._highlightGroups.size===0||c&&!!s&&!w.has(s));if(f(this._highlightGroups))return null;const _=e===E.ShadowExcludeHighlight,g=!(d||_);for(const{buffers:w}of this._dataByOrigin.values())for(const y of w){if(f(y.highlightGroups))continue;const v=u?y.drawCommandsHighlights.size>0:d?s?y.drawCommandsHighlights.get(s):y.drawCommandsHighlights.size>0:((m=(_&&y.needsMultipleCommands()?y.drawCommandsShadowHighlightRest:y.drawCommandsDefault)||null)==null?void 0:m.length)??!1,M=g&&y.drawCommandsOccludees||null;if(v||M!=null&&M.length){const x=this._glMaterials.load(t.rctx,n,e),O=x==null?void 0:x.beginSlot(i);if(O)return O}}return null}render(t,e){const{output:i,bind:r}=t,{slot:s,highlightGroupName:n}=r,u=i===E.Highlight;if(u&&!n)return;const c=i===E.ShadowHighlight,d=u||c,f=i===E.ShadowExcludeHighlight,_=!(d||f),g=s===xt.OCCLUDER_MATERIAL||s===xt.TRANSPARENT_OCCLUDER_MATERIAL?s:null,{rctx:m}=t;m.runAppleAmdDriverHelper();const w=m.bindTechnique(e,r,this.material.parameters);for(const y of this._dataByOrigin.values())for(const v of y.buffers){if(u&&(!v.hasHighlights||!v.drawCommandsHighlights.has(n))||c&&!v.hasHighlights)continue;const M=()=>{const C=[];for(const $ of v.drawCommandsHighlights.values())C.push($);return C},x=d&&!c?v.drawCommandsHighlights.get(n)??null:null,O=c?M():d?x?[x]:Et:(f&&v.needsMultipleCommands()?[v.drawCommandsShadowHighlightRest]:[v.drawCommandsDefault])||Et,T=O.some(C=>C.length>0),b=_&&v.drawCommandsOccludees||null;if(T||b!=null&&b.length){if(this._drawParameters.origin=y.origin,w.bindDraw(r,this.material.parameters,this._drawParameters),e.ensureAttributeLocations(v.vao),m.bindVAO(v.vao),T)for(const C of O)m.setPipelineState(e.getPipeline(!1,g)),C.forAll($=>m.drawArrays(e.primitiveType,$.first,$.count));b!=null&&b.length&&(m.setPipelineState(e.getPipeline(!0,g)),b.forAll(C=>m.drawArrays(e.primitiveType,C.first,C.count)))}}}get test(){}};a([h({constructOnly:!0})],it.prototype,"material",void 0),it=a([Ht("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],it);class bt{constructor(e){this.origin=e,this.changes=new Array}}function ve(t,e){const i=t.find(s=>s.numElements>=e);if(i==null)return null;const r=i.from;return i.from+=e,i.from>=i.to&&t.removeUnordered(i),r}const S=I(),q=I(),R=new P({allocator:t=>t||new ut,deallocator:null}),X=65536,rt=4*X,Ct=1024,Gt=16777216,z=Gt/4;let st=new Float32Array(X);function N(t){return st.length<t&&(st=new Float32Array(t)),st}function Rt(t){const e=4*t;return e<=Ct?Ct:e<rt?Lt(e):Math.max(Math.min(Math.ceil(1.5*e/rt)*rt,Gt),e)}const Et=[];function ye(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/e)}function Me(t,e,i){return 2*Math.atan(Math.sqrt(e*e+i*i)*Math.tan(.5*t)/i)}function xe(t,e,i){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}function De(t,e,i){return 2*Math.atan(i*Math.tan(.5*t)/Math.sqrt(e*e+i*i))}class Ne{constructor(){this.adds=new P,this.removes=new P,this.updates=new P({allocator:e=>e||new Oe,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}}let Oe=class{},Te=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}};var It,p;function ke(t){const e=new Map,i=r=>{let s=e.get(r);return s||(s=new Te,e.set(r,s)),s};return t.removes.forAll(r=>{nt(r)&&i(r.material).removes.push(r)}),t.adds.forAll(r=>{nt(r)&&i(r.material).adds.push(r)}),t.updates.forAll(r=>{nt(r.renderGeometry)&&i(r.renderGeometry.material).updates.push(r)}),e}function nt(t){return t.geometry.indexCount>=1}(function(t){t[t.Default=0]="Default",t[t.Screenshot=1]="Screenshot",t[t.ObjectAndLayerID=2]="ObjectAndLayerID"})(It||(It={})),function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"}(p||(p={}));var ht;let o=ht=class extends At{constructor(t){super(t),this._ray=jt(),this._viewport=ct(0,0,1,1),this._padding=ct(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Bt(1,1e3),this._viewDirty=!0,this._viewMatrix=I(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=I(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=I(),this._frustumDirty=!0,this._frustum=ne(),this._fullViewport=Y(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=A(),this._up=A(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get rows(){return this._rows}set rows(t){this._rows=Math.max(1,t)}get columns(){return this._columns}set columns(t){this._columns=Math.max(1,t)}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return K(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){U(this._viewMatrix,t),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),G(A(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),G(A(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),G(A(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const t=dt(Y(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&pt(t,e)?e:t}get screenPadding(){if(this.pixelRatio===1)return this._padding;const t=dt(Y(),this._padding,1/this.pixelRatio),e=this._get("screenPadding");return e&&pt(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[p.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[p.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[p.RIGHT]+this._padding[p.LEFT]}set fullWidth(t){this.width=t-(this._padding[p.RIGHT]+this._padding[p.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[p.TOP]+this._padding[p.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[p.TOP]+this._padding[p.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[p.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[p.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){Q(this._padding,t)||(this._viewport[0]+=t[p.LEFT]-this._padding[p.LEFT],this._viewport[1]+=t[p.BOTTOM]-this._padding[p.BOTTOM],this._viewport[2]-=t[p.RIGHT]+t[p.LEFT]-(this._padding[p.RIGHT]+this._padding[p.LEFT]),this._viewport[3]-=t[p.TOP]+t[p.BOTTOM]-(this._padding[p.TOP]+this._padding[p.BOTTOM]),V(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(ft(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return k(I(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||I()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return xe(this._fov,this.width,this.height)}set fovX(t){this._fov=ye(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return De(this._fov,this.width,this.height)}set fovY(t){this._fov=Me(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return qt(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(k(this._viewInverseTransposeMatrix,this.viewMatrix),St(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){const t=this.width,e=this.height,i=this.near*Math.tan(this.fovY/2)*2,r=i*this._aspect,s=i/this.rows,n=r/this.columns,u=-r/2+this.column*n,c=u+n,d=-i/2+this.row*s,f=d+s,_=zt(I(),u*(1+2*this._padding[p.LEFT]/t),c*(1+2*this._padding[p.RIGHT]/t),d*(1+2*this._padding[p.BOTTOM]/e),f*(1+2*this._padding[p.TOP]/e),this.near,this.far),g=this._get("projectionMatrix");return g&&Nt(g,_)?g:_}copyFrom(t){Z(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,V(this._viewport,t.viewport),this.notifyChange("_viewport"),V(this._padding,t.padding),this.notifyChange("_padding"),Wt(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.row=t.row,this.column=t.column,this.rows=t.rows,this.columns=t.columns,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(U(this._viewMatrix,t.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(oe(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(U(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),V(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up,this.fov=t.fov}clone(){return new ht().copyFrom(this)}equals(t){return F(this.eye,t.eye)&&F(this.center,t.center)&&F(this.up,t.up)&&Q(this._viewport,t.viewport)&&Q(this._padding,t.padding)&&Ut(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation&&this.row===t.row&&this.column===t.column&&this.rows===t.rows&&this.columns===t.columns}almostEquals(t){const e=Math.max(1,1/this.pixelRatio,1/t.pixelRatio);if(Math.abs(t.fov-this._fov)>=.001||mt(t.screenPadding,this.screenPadding)>=e||mt(this.screenViewport,t.screenViewport)>=e||this.row!==t.row||this.column!==t.column||this.rows!==t.rows||this.columns!==t.columns)return!1;gt(D,t.eye,t.center),gt(ot,this.eye,this.center);const i=_t(D,ot),r=wt(D),s=wt(ot),n=5e-4;return i*i>=(1-1e-10)*r*s&&kt(t.eye,this.eye)<Math.max(r,s)*n*n}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(Yt(this.viewForward,K(D,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=Xt()){return t[0]=(this.padding[p.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[p.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,i=.5){return t[0]=this.padding[p.LEFT]+this.width*e,t[1]=this.padding[p.BOTTOM]+this.height*i,t[2]=.5,t}setGLViewport(t){const e=this.viewport,i=this.padding;t.setViewport(e[0]-i[3],e[1]-i[2],e[2]+i[1]+i[3],e[3]+i[0]+i[2])}applyProjection(t,e){t!==l&&Z(l,t),l[3]=1,L(l,l,this.projectionMatrix);const i=Math.abs(l[3]);J(l,l,1/i);const r=this.fullViewport;e[0]=j(0,r[0]+r[2],.5+.5*l[0]),e[1]=j(0,r[1]+r[3],.5+.5*l[1]),e[2]=.5*(l[2]+1),e[3]=i}unapplyProjection(t,e){const i=this.fullViewport;l[0]=(t[0]/(i[0]+i[2])*2-1)*t[3],l[1]=(t[1]/(i[1]+i[3])*2-1)*t[3],l[2]=(2*t[2]-1)*t[3],l[3]=t[3],this.inverseProjectionMatrix!=null&&(L(l,l,this.inverseProjectionMatrix),e[0]=l[0],e[1]=l[1],e[2]=l[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,at),this.renderToScreen(at,e),e}projectToRenderScreen(t,e){if(l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=1,L(l,l,this.viewProjectionMatrix),l[3]===0)return null;const i=l;J(i,i,1/Math.abs(l[3]));const r=this.fullViewport,s=j(0,r[0]+r[2],.5+.5*i[0]),n=j(0,r[1]+r[3],.5+.5*i[1]);return"x"in e?(e.x=s,e.y=n):(e[0]=s,e[1]=n,e.length>2&&(e[2]=.5*(i[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,at),e)}unprojectFromRenderScreen(t,e){if(ft(W,this.projectionMatrix,this.viewMatrix),!k(W,W))return null;const i=this.fullViewport;return l[0]=2*(t[0]-i[0])/i[2]-1,l[1]=2*(t[1]-i[1])/i[3]-1,l[2]=2*t[2]-1,l[3]=1,L(l,l,W),l[3]===0?null:(e[0]=l[0]/l[3],e[1]=l[1]/l[3],e[2]=l[2]/l[3],e)}constrainWindowSize(t,e,i,r){const s=t*this.pixelRatio,n=e*this.pixelRatio,u=Math.max(s-i/2,0),c=Math.max(this.fullHeight-n-r/2,0),d=-Math.min(s-i/2,0),f=-Math.min(this.fullHeight-n-r/2,0),_=i-d- -Math.min(this.fullWidth-s-i/2,0),g=r-f- -Math.min(n-r/2,0);return[Math.round(u),Math.round(c),Math.round(_),Math.round(g)]}computeUp(t){t===Kt.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){const i=t[0]*this.pixelRatio,r=this.fullHeight-t[1]*this.pixelRatio;return e[0]=i,e[1]=r,e}renderToScreen(t,e){const i=t[0]/this.pixelRatio,r=(this.fullHeight-t[1])/this.pixelRatio;e[0]=i,e[1]=r}_computeUpGlobal(){K(D,this.center,this.eye);const t=vt(this.center);t<1?(G(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(_t(D,this.center))>.9999*vt(D)*t||(yt(this._up,D,this.center),yt(this._up,this._up,D),Mt(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){Qt(D,this.eye,this.center),Math.abs(D[2])<=.9999&&(J(D,D,D[2]),G(this._up,-D[0],-D[1],1-D[2]),Mt(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(t,e,i=""){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?F(t,e)||(Z(e,t),this._markViewDirty(),i.length&&this.notifyChange(i)):Zt.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(ae(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(Jt(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};a([h()],o.prototype,"_viewport",void 0),a([h()],o.prototype,"_padding",void 0),a([h()],o.prototype,"_fov",void 0),a([h()],o.prototype,"_nearFar",void 0),a([h()],o.prototype,"_viewDirty",void 0),a([h()],o.prototype,"_viewMatrix",void 0),a([h()],o.prototype,"_pixelRatio",void 0),a([h()],o.prototype,"pixelRatio",null),a([h()],o.prototype,"row",void 0),a([h()],o.prototype,"column",void 0),a([h()],o.prototype,"_rows",void 0),a([h()],o.prototype,"rows",null),a([h()],o.prototype,"_columns",void 0),a([h()],o.prototype,"columns",null),a([h()],o.prototype,"eye",null),a([h()],o.prototype,"center",null),a([h()],o.prototype,"_center",void 0),a([h()],o.prototype,"up",null),a([h()],o.prototype,"_up",void 0),a([h()],o.prototype,"viewMatrix",null),a([h({readOnly:!0})],o.prototype,"viewForward",null),a([h({readOnly:!0})],o.prototype,"viewUp",null),a([h({readOnly:!0})],o.prototype,"viewRight",null),a([h({readOnly:!0})],o.prototype,"nearFar",null),a([h()],o.prototype,"near",null),a([h()],o.prototype,"far",null),a([h()],o.prototype,"viewport",null),a([h({readOnly:!0})],o.prototype,"screenViewport",null),a([h({readOnly:!0})],o.prototype,"screenPadding",null),a([h()],o.prototype,"x",null),a([h()],o.prototype,"y",null),a([h()],o.prototype,"width",null),a([h()],o.prototype,"height",null),a([h()],o.prototype,"fullWidth",null),a([h()],o.prototype,"fullHeight",null),a([h({readOnly:!0})],o.prototype,"_aspect",null),a([h()],o.prototype,"padding",null),a([h({readOnly:!0})],o.prototype,"projectionMatrix",null),a([h({readOnly:!0})],o.prototype,"inverseProjectionMatrix",null),a([h()],o.prototype,"fov",null),a([h()],o.prototype,"fovX",null),a([h()],o.prototype,"fovY",null),a([h()],o.prototype,"viewInverseTransposeMatrix",null),a([h({readOnly:!0})],o.prototype,"_projectionMatrixInternal",null),a([h()],o.prototype,"relativeElevation",void 0),o=ht=a([Ht("esri.views.3d.webgl.RenderCamera")],o);const Ye=o,l=Y(),W=I(),D=A(),ot=A(),at=te();class Xe extends he{}export{Dt as E,H as I,Rt as V,pe as a,ce as c,Ye as i,ke as n,$e as o,Xe as r,Ne as s,de as t,le as u,it as x};
