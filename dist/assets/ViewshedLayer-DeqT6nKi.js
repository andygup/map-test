import{$T as e,AT as t,DT as n,Dh as r,Ha as i,Ig as a,L as o,OT as s,Uh as c,WC as l,Wh as u,ax as d,dw as f,fw as p,gD as m,hT as h,hw as g,iv as _,kT as v,nv as y,px as b,qC as x,rv as S,tD as C}from"./index-CZ4oMP1N.js";import"./quatf64-BJJPhW0N.js";import"./vectorStacks-FfDNcZoS.js";import{t as w}from"./Analysis-RKRvCFqV.js";import"./ObjectStack-CBI5g-Qc.js";import"./ray-CWXoVP-g.js";import"./HUDIntersectorResult-CPKd33dL.js";import"./Intersector-CuU_DZjQ.js";import{n as T,t as E}from"./featureReferenceUtils-B-s-NNs5.js";var D=class extends l(g){constructor(e){super(e),this.observer=null,this.farDistance=1e3,this.heading=0,this.tilt=90,this.horizontalFieldOfView=45,this.verticalFieldOfView=45,this.feature=null}get valid(){return this.observer!=null&&this.farDistance>0}equals(e){return h(this.observer,e.observer)&&this.farDistance===e.farDistance&&this.heading===e.heading&&this.tilt===e.tilt&&this.horizontalFieldOfView===e.horizontalFieldOfView&&this.verticalFieldOfView===e.verticalFieldOfView&&E(this.feature,e.feature)}};m([n({type:b,json:{write:{isRequired:!0}}})],D.prototype,`observer`,void 0),m([n({type:Number,nonNullable:!0,range:{min:0},json:{write:{isRequired:!0}}})],D.prototype,`farDistance`,void 0),m([n({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),v(t=>x.normalize(e(t),void 0,!0))],D.prototype,`heading`,void 0),m([n({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],D.prototype,`tilt`,void 0),m([n({type:Number,nonNullable:!0,range:{min:0,max:360},json:{write:{isRequired:!0}}})],D.prototype,`horizontalFieldOfView`,void 0),m([n({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],D.prototype,`verticalFieldOfView`,void 0),m([n(T)],D.prototype,`feature`,void 0),m([n({readOnly:!0,json:{read:!1}})],D.prototype,`valid`,null),D=m([s(`esri.analysis.Viewshed`)],D);var O=_.ofType(D),k=class extends w{constructor(e){super(e),this.type=`viewshed`,this._extent=null}initialize(){this.addHandles(y(()=>this._computeExtent(),e=>{e.pending??(this._extent=e.extent)},S))}get viewsheds(){return this._get(`viewsheds`)||new O}set viewsheds(e){this._set(`viewsheds`,u(e,this.viewsheds,O))}get spatialReference(){for(let e of this.viewsheds)if(e.observer!=null)return e.observer.spatialReference;return null}get extent(){return this._extent}get valid(){return this.viewsheds.every(e=>e.valid)}async waitComputeExtent(){let e=this._computeExtent();e.pending!=null&&await e.pending}_computeExtent(){let{spatialReference:e}=this;if(e==null)return{pending:null,extent:null};let t=this.viewsheds.filter(e=>e.observer!=null),n=t.map(e=>e.observer).toArray(),r=a(n,e);return r.pending==null?{pending:null,extent:r.geometries.map((e,n)=>{let r=t.at(n);return e!=null&&r!=null?this._computeViewshedExtent(this.viewsheds.at(n),e):null}).filter(e=>e!=null).reduce((e,t)=>A(e,t),null)}:{pending:r.pending,extent:null}}_computeViewshedExtent(e,t){let{farDistance:n,heading:r,tilt:i,horizontalFieldOfView:a,verticalFieldOfView:o}=e,{spatialReference:s}=t,c=a/2,l=o/2,u=n/s.metersPerUnit,m=[x.normalize(r-c),r,x.normalize(r+c)],h=d.fromPoint(t),g=e=>{let t=m.map(t=>x.normalize(t-e));if(t[0]>t[2]||a===360)return u;let n=t.map(e=>Math.abs(e>180?360-e:e)).reduce((e,t)=>e>t?t:e);return n>90?0:u*Math.cos(p(n))};h.xmax+=g(90),h.xmin-=g(-90),h.ymax+=g(0),h.ymin-=g(180);let _=t.z;if(_!=null){let e=_,t=_,r=i-90,a=f(r+l,-90,90),o=f(r-l,-90,90),d=s?.isGeographic?n:u;e+=d*M(a),t+=d*M(o);let p=j(l)*d,m=M(r)*p*(1-j(c));i<90&&(e-=m),i>90&&(t-=m),h.zmax=Math.max(e,_),h.zmin=Math.min(t,_)}return h}equals(e){return this===e||super.equals(e)&&C(this.viewsheds.toArray(),e.viewsheds.toArray(),(e,t)=>e.equals(t))}clear(){this.viewsheds.removeAll()}};function A(e,t){return e==null?t:t==null?e:e.union(t)}function j(e){return Math.cos(p(e))}function M(e){return Math.sin(p(e))}m([n({type:[`viewshed`]})],k.prototype,`type`,void 0),m([n({cast:c,type:O,nonNullable:!0})],k.prototype,`viewsheds`,null),m([n({readOnly:!0})],k.prototype,`spatialReference`,null),m([n()],k.prototype,`_extent`,void 0),m([n()],k.prototype,`extent`,null),m([n({readOnly:!0})],k.prototype,`valid`,null),k=m([s(`esri.analysis.ViewshedAnalysis`)],k);var N=class extends o(i(r)){constructor(e){super(e),this.type=`viewshed`,this.operationalLayerType=`ViewshedLayer`,this.source=new k,this.opacity=1}initialize(){this.addHandles(y(()=>this.source,(e,t)=>{t!=null&&t.parent===this&&(t.parent=null),e!=null&&(e.parent=this)},S))}async load(){return this.addResolvingPromise(this.source.waitComputeExtent()),this}get spatialReference(){return this.source.spatialReference}get fullExtent(){return this.source.extent}releaseAnalysis(e){this.source===e&&(this.source=new k)}get analysis(){return this.source}set analysis(e){this.source=e}get viewsheds(){return this.source.viewsheds}set viewsheds(e){this.source.viewsheds=e}writeViewsheds(e,t,n,r){t.viewsheds=e.filter(e=>e.valid).toJSON(r)}};m([n({json:{read:!1},readOnly:!0})],N.prototype,`type`,void 0),m([n({type:[`ViewshedLayer`]})],N.prototype,`operationalLayerType`,void 0),m([n({type:k,nonNullable:!0})],N.prototype,`source`,void 0),m([n({readOnly:!0})],N.prototype,`spatialReference`,null),m([n({readOnly:!0})],N.prototype,`fullExtent`,null),m([n({readOnly:!0,json:{read:!1,write:!1,origins:{service:{read:!1,write:!1},"portal-item":{read:!1,write:!1},"web-document":{read:!1,write:!1}}}})],N.prototype,`opacity`,void 0),m([n({type:[`show`,`hide`]})],N.prototype,`listMode`,void 0),m([n({type:_.ofType(D),json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{ignoreOrigin:!0}}}}})],N.prototype,`viewsheds`,null),m([t(`web-scene`,`viewsheds`)],N.prototype,`writeViewsheds`,null),N=m([s(`esri.layers.ViewshedLayer`)],N);var P=N;export{P as default};