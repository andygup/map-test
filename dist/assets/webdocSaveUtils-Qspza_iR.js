const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/geometryServiceUtils-BkGCWfFG.js","assets/index-CzMixifc.js","assets/index-CDgdHpAj.css"])))=>i.map(i=>d[i]);
import{Aa as e,BS as t,BT as n,Ba as r,Fa as i,Fh as a,HS as o,Ih as s,La as c,Na as l,Ra as u,Ua as d,Va as f,_S as ee,_x as te,bC as p,cm as ne,dm as m,gC as h,gh as g,hh as _,ja as v,tv as y,um as re,wx as ie}from"./index-CzMixifc.js";import{t as b}from"./originUtils-CL6wvYk_.js";import"./resourceUtils-MeC3zZFs.js";import{n as x}from"./resourceUtils-Gqgc6Vaf.js";import{n as S,r as C,t as w}from"./saveUtils-BKglk9b-.js";var T=[`NatGeo_World_Map`,`Ocean_Basemap`,`USA_Topo_Maps`,`World_Imagery`,`World_Street_Map`,`World_Terrain_Base`,`World_Topo_Map`,`World_Hillshade`,`Canvas/World_Light_Gray_Base`,`Canvas/World_Light_Gray_Reference`,`Canvas/World_Dark_Gray_Base`,`Canvas/World_Dark_Gray_Reference`,`Ocean/World_Ocean_Base`,`Ocean/World_Ocean_Reference`,`Reference/World_Boundaries_and_Places`,`Reference/World_Reference_Overlay`,`Reference/World_Transportation`].map(e=>e.toLowerCase());async function E(e,t,n){n??={},k(e,t),await y(()=>!t.updatingFromView),await t.load(),await M(t),await S(t),await j(e,t);let r=t.portalItem,{json:i,jsonContext:a}=await D(t,r,e.origin);return C(a,{errorName:`${e.name}:save`},n),await N(t,r),await Ce(e,t,r,i,a),await Promise.all([t.updateItemThumbnail(),x(t.resourceReferences,a)]),r}async function D(e,t,n){let r=l(t,n,!0),i=e.write({},r);return await Promise.all(r.resources.pendingOperations),{json:i,jsonContext:r}}async function O(e,t,n,r){r??={};let i=ae(e,n);await y(()=>!t.updatingFromView),await t.load(),await M(t),await S(t),await j(e,t);let{json:a,jsonContext:o}=await D(t,i,e.origin);C(o,{errorName:`${e.name}:save`},r),await q(t,i);let s=t.getThumbnailState();return await we(e,t,i,a,o,r)&&(t.resourceReferences.portalItem=i),t.restoreThumbnailFromState(s),await Promise.all([t.updateItemThumbnail(),x(t.resourceReferences,o)]),i}function k(e,t){if(!t.portalItem)throw new n(`${e.name}:portal-item-not-set`,`Portal item to save to has not been set on the WebMap`);A(e,t.portalItem)}function A(e,t){if(t.type!==e.itemType)throw new n(`${e.name}:portal-item-wrong-type`,`Portal item needs to have type "${e.itemType}"`)}async function j(e,t){if(e.name===`linkchart`)return;if(!t.basemap?.baseLayers.length)throw new n(`${e.name}:save`,`Map does not have a valid basemap with a base layer.`);let r=null;if(await y(()=>{let e=re(t.initialViewProperties,t.basemap);return r=e.spatialReference,!e.updating}),!ee(r,t.initialViewProperties.spatialReference))throw new n(`${e.name}:save`,`The spatial reference of the basemap is not compatible with the one from the map.`,{expected:t.initialViewProperties.spatialReference,actual:r})}function ae(e,t){let n=a.from(t);return n.id&&=(n=n.clone(),null),n.type||=e.itemType,n.portal||=s.getDefault(),A(e,n),n}function M(e){let t=[];return e.basemap&&t.push(e.basemap.load()),e.ground&&t.push(e.ground.load()),Promise.allSettled(t).then(()=>{})}async function N(e,t){t.extent=await ge(e.portalItem,e.initialViewProperties.viewpoint.targetGeometry),await se(e,t)}var oe=i.JSAPI,P=`CollectorDisabled`,F=`Collector`,I=`Data Editing`,L=`OfflineDisabled`,R=`Offline`,z=`Workforce Project`,B=`Workforce Worker`,V=`Workforce Dispatcher`,H=`Offline Map Areas`,U=`FieldMapsDisabled`,W=i.DEVELOPER_BASEMAP,G=`UtilityNetwork`,K=`IPS`;async function q(e,t){c(t,P),c(t,U),c(t,i.METADATA),c(t,L),c(t,H),c(t,V),c(t,z),c(t,B),await N(e,t)}async function se(e,t){u(t,oe),await ce(e),le(e,t),ue(e,t),de(e,t),fe(e,t),pe(e,t),me(e,t),he(e,t),t.typeKeywords&&=t.typeKeywords.filter((e,t,n)=>n.indexOf(e)===t)}function ce(e){let t=J(e).map(e=>e.load()).toArray();return Promise.allSettled(t).then(()=>{})}function J(e){return e.allLayers.concat(e.allTables)}function Y(e){return J(e).some(e=>e.loaded&&g(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&(e.type!==`subtype-group`||e.sublayers.some(e=>e.editingEnabled)))}function X(e){return J(e).filter(e=>e.type!==`group`).every(t=>t.loaded&&ye(e,t))}function le(e,t){r(t,P)||r(t,z)||r(t,B)||r(t,V)||!Y(e)?c(t,F):u(t,F)}function ue(e,t){Y(e)?u(t,I):c(t,I)}function de(e,t){!r(t,L)&&X(e)?u(t,R):c(t,R)}function fe(e,t){m(e.basemap)?u(t,W):c(t,W)}function pe(e,t){e.utilityNetworks?.length?u(t,G):c(t,G)}function me(e,t){e.ipsInfo?u(t,K):c(t,K)}function he(e,t){f(t,i.CHARTS,w(e))}async function ge(e,t){let n=t.clone().normalize(),r;if(n.length>1)for(let e of n)r?e.width>r.width&&(r=e):r=e;else r=n[0];return _e(e,r)}async function _e(n,r){let i=r.spatialReference;if(i.isWGS84)return r.clone();if(i.isWebMercator)return te(r);let{getGeometryServiceURL:a}=await t(async()=>{let{getGeometryServiceURL:e}=await import(`./geometryServiceUtils-BkGCWfFG.js`);return{getGeometryServiceURL:e}},__vite__mapDeps([0,1,2])),o=await a(n),s=new v({geometries:[r],outSpatialReference:ie.WGS84});return(await e(o,s))[0]}function ve(e){return _(e)||e.type===`map-notes`||e.type===`route`}function ye(e,t){return g(t)&&t.capabilities.operations.supportsSync||ve(t)&&!t.portalItem||be(t)&&!xe(t)&&t.spatialReference.equals(e.initialViewProperties.spatialReference)}function be(e){return(e.type===`tile`||e.type===`vector-tile`)&&(e.capabilities.operations.supportsExportTiles||Se(e)||ne(e))}function xe(e){return e.type===`vector-tile`&&Object.keys(e.sourceNameToSource).length>1}function Se(e){return e.type===`tile`&&o(e.url)&&T.some(t=>e.url?.toLowerCase().includes(`/`+t+`/`))}async function Ce(e,t,n,r,i){await n.update({data:r}),$(e,t,n,r,i)}async function we(e,t,r,i,a,o){let s=t.portalItem,c={item:s,authenticated:!(!s?.id||!s.portal.user)},l=r.portal;await l.signIn();let{copyAllowed:u,itemReloaded:d}=await Z(c,l);if(c.authenticated||=d,!u)throw new n(`${e.name}:save-as-copy-not-allowed`,`Owner of this map does not allow others to save a copy`);let f=await Q(r,c,i,o);return t.portalItem=r,$(e,t,r,i,a),f}async function Z(e,t){let{item:n,authenticated:r}=e;return n?.id&&n.typeKeywords?.includes(`useOnly`)?n.portal.portalHostname===t.portalHostname?(r||await n.reload(),{copyAllowed:n.itemControl===`admin`||n.itemControl===`update`,itemReloaded:!0}):{copyAllowed:!1,itemReloaded:!1}:{copyAllowed:!0,itemReloaded:!1}}async function Q(e,t,n,r){let i=e.portal,{item:a}=t,{folder:o,copyAllResources:s}=r,c=!1;if(s&&a?.id&&p(a.portal.url,i.url)&&parseInt(a.portal.currentVersion,10)>=2023){let{total:e}=await a.fetchResources();c=!!e}if(c){let t=await a.copy({copyResources:`all`,folder:o});e.id=t.id,e.portal=t.portal;let r=e.toJSON();await e.load(),e.read(r),await e.update({data:n})}else await i.user.addItem({item:e,folder:o,data:n});return c}function $(e,t,n,r,i){d.prototype.read.call(t,{version:r.version,authoringApp:r.authoringApp,authoringAppVersion:r.authoringAppVersion},{origin:e.origin,ignoreDefaults:!0,url:n.itemUrl?h(n.itemUrl):void 0}),b(i),t.resourceInfo=r}export{D as createJSON,Q as initializeNewItem,Z as isCopyAllowed,E as save,O as saveAs};