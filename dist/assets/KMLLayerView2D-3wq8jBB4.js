import{As as e,BT as t,Dd as n,Ex as r,Fg as i,IC as a,Kg as o,Lx as s,TT as c,Tu as l,VT as u,ZS as d,_s as f,gC as p,hv as m,iw as h,jT as g,kD as _,pv as v,qa as y,vx as b,xC as x,ys as S}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import"./streamLayerUtils-82UmlW-3.js";import"./QueueProcessor-D6ozkjY6.js";import"./SimpleGeometryCursor-BILtMaQf.js";import"./earcut-CEMcWA4Z.js";import"./projectionZScaling-C8xhU_hX.js";import{r as C}from"./projectOperator-DWqbOm71.js";import"./glsl-BMw-Ib6r.js";import"./layerViewUtils-CJcMVuwG.js";import"./colorUtils-CzajW9E7.js";import{n as w,p as T,u as E}from"./rasterProjectionHelper-BpX32CQ6.js";import{a as D,i as O,r as k}from"./kmlUtils-BeQJtYx4.js";import"./timeSupport-vK4lVcYW.js";import"./queryUtils-DGU5ISbw.js";import"./normalizeUtilsSync-TXjrdJAe.js";import"./GeometryUtils-B-8QW9FG.js";import"./VertexAttributeLocations-BScEla0R.js";import"./VertexElementDescriptor-Cl_nC_ty.js";import"./labelPoint-1O-zXr9b.js";import"./callExpressionWithCursor-CKz4lb1p.js";import"./FeatureMetadata-rc_NIaUe.js";import"./CIMSymbolHelper-B2DBxDPE.js";import"./rasterizingUtils-BsmZb-O9.js";import"./Rect-LbcnjDUG.js";import"./BoundingBox-Dtf81F-g.js";import"./BidiEngine-DvXbVJau.js";import"./callExpressionWithFeature-UlbvTUQ4.js";import"./OverrideHelper-BahbnLvz.js";import"./FeatureCommandQueue-2UJWGVaq.js";import"./config-Dk3C6lVr.js";import"./dehydratedFeatureComparison-BCFMkftR.js";import"./WGLContainer-jm6ZclzQ.js";import"./utils-B0heZPZY.js";import"./ProgramTemplate-B9k_04Md.js";import"./VertexArrayObject-ChtD6bwg.js";import"./BufferObject-B3_aJU6V.js";import"./VertexBuffer-Ra4pb4dR.js";import"./vec3f32-DDMWoxUL.js";import"./Container-uEjPEzbR.js";import"./GraphShaderModule-AgkKIWM0.js";import{t as A}from"./FramebufferObject-BoYk_2uK.js";import"./ShaderBuilder-BLOqjpgt.js";import"./bitmapUtils-53gkfkJ0.js";import{n as j,r as M,t as N}from"./Bitmap-BoQaGe8r.js";import{t as P}from"./BitmapContainer-C6h9gf6w.js";import{t as F}from"./LayerView2D-Bgb1zyoa.js";import{t as I}from"./LayerView-DQaVI2FN.js";import"./UpdateTracking2D-BMTZzgpI.js";import"./TechniqueInstance-fDAaVtEH.js";import"./TileContainer-BL1bFhTv.js";import"./constants-BOI_CTg-.js";import"./utils-DmZFjYOb.js";import"./AGraphicContainer-DHUNjrd-.js";import{t as L}from"./GraphicContainer-fLr16fKu.js";import"./ComputedAttributeStorage-BgTqXVQM.js";import{t as R}from"./GraphicsView2D-CUXbaTHc.js";import"./dehydratedFeatures-D5ZOMtMh.js";import{t as z}from"./rasterUtils-D7xV8vD0.js";import{n as B,r as V,t as H}from"./RenderingContext-Bmj2gpCz.js";import"./ProgramCache-Blg6we4g.js";import"./renderState-BaFdYDAL.js";import"./DisjointTimerQuery-BX0tLCqC.js";var U=class extends h{constructor(){super(...arguments),this.id=0,this.rotation=0,this.href=``,this.extent=new b}};_([t({nonNullable:!0,json:{write:!0}})],U.prototype,`id`,void 0),_([t({nonNullable:!0,json:{write:!0}})],U.prototype,`rotation`,void 0),_([t({nonNullable:!0,json:{write:!0}})],U.prototype,`href`,void 0),_([t({type:b,nonNullable:!0,json:{write:!0}})],U.prototype,`extent`,void 0),U=_([u(`esri.layers.support.KMLMapImage`)],U);var W=class t{static{this._instanceRefCount=0}constructor(e){if(this._ownsRctx=!1,e)this._ownsRctx=!1,this._rctx=e;else{if(t._instance)return t._instanceRefCount++,t._instance;t._instanceRefCount=1,t._instance=this,this._ownsRctx=!0;let e=document.createElement(`canvas`).getContext(`webgl2`);e.getExtension(`OES_texture_float`),this._rctx=new H(e,new y)}this._quad=new V(this._rctx,[0,0,1,0,0,1,1,1]);let n=B(`raster/reproject`,`raster/reproject`,{applyProjection:!0,bilinear:!1,bicubic:!1});this._program=this._rctx.programCache.acquire(n.vertexShader,n.fragmentShader,this._quad.locations),this._rctx.useProgram(this._program),this._program.setUniform1f(`u_opacity`,1),this._program.setUniform1i(`u_image`,0),this._program.setUniform1i(`u_flipY`,0),this._program.setUniform1i(`u_transformGrid`,1)}reprojectTexture(t,n,i=!1){let a=C(t.extent,n),o=new r({x:(t.extent.xmax-t.extent.xmin)/t.texture.descriptor.width,y:(t.extent.ymax-t.extent.ymin)/t.texture.descriptor.height,spatialReference:t.extent.spatialReference}),{x:s,y:c}=w(o,n,t.extent),l=(s+c)/2,u=Math.round((a.xmax-a.xmin)/l),d=Math.round((a.ymax-a.ymin)/l);l=(a.width/u+a.height/d)/2;let f=new r({x:l,y:l,spatialReference:a.spatialReference}),p=T({projectedExtent:a,srcBufferExtent:t.extent,pixelSize:f,hasWrapAround:!0,spacing:[16,16]}),m=z(this._rctx,p),h=new S(u,d);h.wrapMode=33071;let g=new A(this._rctx,h);this._rctx.bindFramebuffer(g),this._rctx.setViewport(0,0,u,d),this._rctx.useProgram(this._program),this._rctx.bindTexture(t.texture,0),this._rctx.bindTexture(m,1),this._quad.bind();let{width:_=0,height:v=0}=t.texture.descriptor;if(this._program.setUniform2f(`u_srcImageSize`,_,v),this._program.setUniform2fv(`u_transformSpacing`,p.spacing),this._program.setUniform2fv(`u_transformGridSize`,p.size),this._program.setUniform2f(`u_targetImageSize`,u,d),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),m.dispose(),i){let{width:t,height:n}=g,r=new ImageData(t??0,n??0);g.readPixels(0,0,t??0,n??0,6408,e.UNSIGNED_BYTE,r.data);let i=g.detachColorTexture();return g.dispose(),{texture:i,extent:a,imageData:r}}let y=g.detachColorTexture();return g.dispose(),{texture:y,extent:a}}reprojectBitmapData(e,t){let n=M(e.bitmapData)?N(e.bitmapData):e.bitmapData,r=new S(e.bitmapData.width,e.bitmapData.height);r.wrapMode=33071;let i=new f(this._rctx,r,n),a=this.reprojectTexture({texture:i,extent:e.extent},t,!0);a.texture.dispose();let o=document.createElement(`canvas`),s=a.imageData;return o.width=s.width,o.height=s.height,o.getContext(`2d`).putImageData(s,0,0),{bitmapData:o,extent:a.extent}}async loadAndReprojectBitmapData(e,t,n){let[r]=await Promise.all([d(e,{responseType:`image`}).then(e=>e.data),E()]),i=document.createElement(`canvas`);i.width=r.width,i.height=r.height;let a=i.getContext(`2d`);a.drawImage(r,0,0);let o=a.getImageData(0,0,i.width,i.height);if(t.spatialReference.equals(n))return{bitmapData:o,extent:t};let s=this.reprojectBitmapData({bitmapData:o,extent:t},n);return{bitmapData:s.bitmapData,extent:s.extent}}destroy(){this._ownsRctx?(t._instanceRefCount--,t._instanceRefCount===0&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),t._instance=null)):(this._quad.dispose(),this._program.dispose())}},G=class{constructor(){this.allSublayers=new Map,this.allPoints=[],this.allPolylines=[],this.allPolygons=[],this.allMapImages=[]}},K=class extends F(I){constructor(){super(...arguments),this._bitmapIndex=new Map,this._mapImageContainer=new P,this._kmlVisualData=new G,this._fetchController=null,this.allVisiblePoints=new n,this.allVisiblePolylines=new n,this.allVisiblePolygons=new n,this.allVisibleMapImages=new m}async hitTest(e,t){let n=this.layer;return[this._pointsView?.hitTest(e),this._polylinesView?.hitTest(e),this._polygonsView?.hitTest(e)].flat().filter(Boolean).map(t=>(t.layer=n,t.sourceLayer=n,{type:`graphic`,graphic:t,layer:n,mapPoint:e}))}update(e){this._polygonsView&&this._polygonsView.processUpdate(e),this._polylinesView&&this._polylinesView.processUpdate(e),this._pointsView&&this._pointsView.processUpdate(e)}attach(){this._fetchController=new AbortController,this.container.addChild(this._mapImageContainer),this._polygonsView=new R({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new L(this.view.featuresTilingScheme)}),this.container.addChild(this._polygonsView.container),this._polylinesView=new R({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new L(this.view.featuresTilingScheme)}),this.container.addChild(this._polylinesView.container),this._pointsView=new R({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new L(this.view.featuresTilingScheme)}),this.container.addChild(this._pointsView.container),this.addAttachHandles([this.allVisibleMapImages.on(`change`,e=>{e.added.forEach(e=>this._addMapImage(e)),e.removed.forEach(e=>this._removeMapImage(e))}),v(()=>this.layer.visibleSublayers,e=>{for(let e of this._kmlVisualData.allSublayers.values())e.visibility=0;for(let t of e){let e=this._kmlVisualData.allSublayers.get(t.id);e&&(e.visibility=1)}this._refreshCollections()})]),this._updatingHandles.addPromise(this._fetchService(this._fetchController.signal)),this._imageReprojector=new W}detach(){this._fetchController=c(this._fetchController),this._mapImageContainer.removeAllChildren(),this.container.removeAllChildren(),this._bitmapIndex.clear(),this._polygonsView=g(this._polygonsView),this._polylinesView=g(this._polylinesView),this._pointsView=g(this._pointsView),this._imageReprojector=g(this._imageReprojector)}viewChange(){this._polygonsView.viewChange(),this._polylinesView.viewChange(),this._pointsView.viewChange()}moveEnd(){}isUpdating(){return this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating}_addMapImage(e){(this.view.spatialReference?.isWGS84||this.view.spatialReference?.isWebMercator)&&this._imageReprojector.loadAndReprojectBitmapData(e.href,e.extent,this.view.spatialReference).then(t=>{let n=new j(t.bitmapData);n.x=t.extent.xmin,n.y=t.extent.ymax,n.resolution=t.extent.width/t.bitmapData.width,n.rotation=e.rotation,this._mapImageContainer.addChild(n),this._bitmapIndex.set(e,n)})}async _getViewDependentUrl(e,t){let{viewFormat:n,viewBoundScale:r,httpQuery:c}=e;if(n!=null){if(t==null)throw Error(`Loading this network link requires a view state.`);let u;if(await i(),r!=null&&r!==1){let e=new b(t.extent);e.expand(r),u=e}else u=t.extent;u=o(u,s.WGS84);let d=o(u,s.WebMercator),f=u.xmin,p=u.xmax,m=u.ymin,h=u.ymax,g=t.size[0]*t.pixelRatio,_=t.size[1]*t.pixelRatio,v=Math.max(d.width,d.height),y={"[bboxWest]":f.toString(),"[bboxEast]":p.toString(),"[bboxSouth]":m.toString(),"[bboxNorth]":h.toString(),"[lookatLon]":u.center.x.toString(),"[lookatLat]":u.center.y.toString(),"[lookatRange]":v.toString(),"[lookatTilt]":`0`,"[lookatHeading]":t.rotation.toString(),"[lookatTerrainLon]":u.center.x.toString(),"[lookatTerrainLat]":u.center.y.toString(),"[lookatTerrainAlt]":`0`,"[cameraLon]":u.center.x.toString(),"[cameraLat]":u.center.y.toString(),"[cameraAlt]":v.toString(),"[horizFov]":`60`,"[vertFov]":`60`,"[horizPixels]":g.toString(),"[vertPixels]":_.toString(),"[terrainEnabled]":`0`,"[clientVersion]":`5.0`,"[kmlVersion]":`2.2`,"[clientName]":`ArcGIS API for JavaScript`,"[language]":`en-US`},S=e=>{for(let t in e){let n;for(n in y)e[t]=e[t].replace(n,y[n])}},C=a(n);S(C);let w={};c!=null&&(w=a(c),S(w));let T=l(e.href);return T.query={...T.query,...C,...w},`${T.path}?${x(C)}`}return e.href}async _fetchService(e){let t=new G;await this._loadVisualData(this.layer.url,t,e),this._kmlVisualData=t,this._refreshCollections()}_refreshCollections(){this.allVisiblePoints.removeAll(),this.allVisiblePolylines.removeAll(),this.allVisiblePolygons.removeAll(),this.allVisibleMapImages.removeAll();let e=(e,t)=>{e.addMany(t.filter(e=>this._isSublayerVisible(e.sublayerId)).map(({item:e})=>e))};e(this.allVisiblePoints,this._kmlVisualData.allPoints),e(this.allVisiblePolylines,this._kmlVisualData.allPolylines),e(this.allVisiblePolygons,this._kmlVisualData.allPolygons),this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter(e=>this._isSublayerVisible(e.sublayerId)).map(({item:e})=>e))}_isSublayerVisible(e){let t=this._kmlVisualData.allSublayers.get(e);return!!t?.visibility&&(t.parentFolderId===-1||this._isSublayerVisible(t.parentFolderId))}_loadVisualData(e,t,n){return this._fetchParsedKML(e,n).then(async e=>{for(let r of e.sublayers){t.allSublayers.set(r.id,r);let e=await k(r,`points`,this.layer,r.id),i=await k(r,`polylines`,this.layer,r.id),a=await k(r,`polygons`,this.layer,r.id),o=r.mapImages?.map(e=>U.fromJSON(e))??[];if(t.allPoints.push(...e.map(e=>({item:e,sublayerId:r.id}))),t.allPolylines.push(...i.map(e=>({item:e,sublayerId:r.id}))),t.allPolygons.push(...a.map(e=>({item:e,sublayerId:r.id}))),t.allMapImages.push(...o.map(e=>({item:e,sublayerId:r.id}))),r.networkLink){let e=await this._getViewDependentUrl(r.networkLink,this.view.state);await this._loadVisualData(e,t,n)}}})}_fetchParsedKML(e,t){return D(e,this.layer.spatialReference,this.layer.refreshInterval,t).then(e=>O(e.data))}_removeMapImage(e){let t=this._bitmapIndex.get(e);t&&(this._mapImageContainer.removeChild(t),this._bitmapIndex.delete(e))}};_([t()],K.prototype,`_pointsView`,void 0),_([t()],K.prototype,`_polylinesView`,void 0),_([t()],K.prototype,`_polygonsView`,void 0),K=_([u(`esri.views.2d.layers.KMLLayerView2D`)],K);var q=K;export{q as default};