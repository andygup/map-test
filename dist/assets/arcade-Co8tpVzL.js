import{$T as e,$p as t,CE as n,FE as r,Od as i,RT as a,g as o,gn as s,ha as c,pn as l,qh as u,vn as d}from"./index-BN8X5Ryz.js";import{t as f}from"./arcadeEnvironment-DUP-IKH2.js";import{t as p}from"./ImmutableArray-C3KNQCVd.js";var m=null;function h(e,t,n,r={}){let i=t.elementType,a=`value`,o=i.type===`array`?[{name:a,type:i.type,elementType:i.elementType}]:i.type===`dictionary`?[{name:a,type:i.type,properties:i.properties}]:[{name:a,type:i.type}];return new p(e.map(e=>{let t={};return b(t,o,{[a]:e},n,r),t[a]}))}function g(e,t,n={}){let r=e instanceof c?new o({source:e.features,geometryType:e.geometryType,fields:e.fields,spatialReference:e.spatialReference}):e;return t.constructFeatureSet(r,n.spatialReference,null,!0,n.lruCache,n.interceptor)}function _(e,t,n={}){let{spatialReference:r,interceptor:i,lruCache:a}=n;return typeof e==`string`?t.createFeatureSetCollectionFromService(e,r,a,i):t.createFeatureSetCollectionFromMap(e,r,a,i)}function v(e,t,n,r={}){let i=Object.create(null);return b(i,t.properties,e,n,r),new m.Dictionary(i)}function y(e){if(e==null)return null;if(typeof e==`string`||typeof e==`number`||typeof e==`boolean`)return e;if(Array.isArray(e))return new p(e.map(e=>y(e)));if(typeof e==`object`){let t=Object.create(null);for(let n of Object.entries(e))t[n[0]]=y(n[1]);return new m.Dictionary(t)}throw Error(`Unsupported json value: ${e}`)}function b(e,t,n,r,i={}){let a={};for(let e of Object.keys(n))a[e.toLowerCase()]=n[e];for(let n of t){let t=n.name.toLowerCase();if(i.variablesPreProcessed)e[t]=a[t];else switch(n.type){case`array`:{let o=a[t];e[t]=o==null?null:h(o,n,r,i);break}case`feature`:{let n=a[t];e[t]=n==null?null:m.Feature.createFromGraphic(n,i?.timeZone);break}case`featureSet`:{let n=a[t];e[t]=n==null?null:r?g(n,r,i):null;break}case`featureSetCollection`:{let n=a[t];e[t]=n==null?null:r?_(n,r,i):null;break}case`dictionary`:{let o=a[t];e[t]=o==null?null:v(o,n,r,i);break}case`date`:{let n=a[t];e[t]=n?n instanceof d?n:i?.timeZone?d.dateJSAndZoneToArcadeDate(n,i?.timeZone):d.dateJSToArcadeDate(n):null;break}case`dateOnly`:{let n=a[t];e[t]=n?n instanceof s?n:s.fromReader(n):null;break}case`time`:{let n=a[t];e[t]=n?n instanceof l?n:l.fromReader(n):null;break}case`knowledgeGraph`:case`geometry`:case`boolean`:case`text`:case`number`:e[t]=a[t];break;case`voxel`:{let n=a[t];e[t]=n==null?null:new m.Voxel(n,i?.timeZone);break}case`pixel`:{let n=a[t];e[t]=n==null?null:m.Pixel.fromImageryGraphic(n,i?.timeZone);break}case`json`:e[t]=y(a[t])}}}function x(e,t){for(let n of e)t.push(n),n.type===`dictionary`&&x(n.properties,t);return t}function S(e,t,n,r,i){let{spatialReference:a,interceptor:o,lruCache:s,console:c,abortSignal:l,timeZone:d,services:f={portal:u.getDefault()},track:p}=n,m={vars:{},spatialReference:a,interceptor:o,timeZone:d,lrucache:s,useAsync:i,services:f,console:c,abortSignal:l,track:p};return t&&b(m.vars,e.variables,t,r,n),m}function C(e,t){switch(t.getArcadeType(e)){case`number`:case`text`:case`boolean`:case`point`:case`polygon`:case`polyline`:case`multipoint`:case`extent`:return e;case`date`:return e.toJSDate();case`time`:case`dateOnly`:return e.toString();case`feature`:{let t=(e.type,e),n=`geometry`in t?t.geometry():null,r=`readAttributes`in t?t.readAttributes():t.attributes;return new i({geometry:n,attributes:r})}case`dictionary`:{let n=e,r=n.attributes,i={};for(let e of Object.keys(r))i[e]=C(n.field(e),t);return i}case`array`:return(`toArray`in e?e.toArray():e).map(e=>C(e,t))}return e}var w={variables:[{name:`$feature`,type:`feature`},{name:`$layer`,type:`featureSet`},{name:`$datastore`,type:`featureSetCollection`},{name:`$map`,type:`featureSetCollection`},{name:`$userInput`,type:`geometry`},{name:`$graph`,type:`knowledgeGraph`},{name:`$view`,type:`dictionary`,properties:[{name:`scale`,type:`number`},{name:`timeProperties`,type:`dictionary`,properties:[{name:`currentStart`,type:`date`},{name:`currentEnd`,type:`date`},{name:`startIncluded`,type:`boolean`},{name:`endIncluded`,type:`boolean`}]}]}]},T={variables:[{name:`$feature`,type:`feature`},{name:`$aggregatedFeatures`,type:`featureSet`},{name:`$view`,type:`dictionary`,properties:[{name:`scale`,type:`number`},{name:`timeProperties`,type:`dictionary`,properties:[{name:`currentStart`,type:`date`},{name:`currentEnd`,type:`date`},{name:`startIncluded`,type:`boolean`},{name:`endIncluded`,type:`boolean`}]}]}]},E={variables:[{name:`$voxel`,type:`voxel`}]},D={variables:[{name:`$pixel`,type:`pixel`},{name:`$imageCollectionItem`,type:`feature`},{name:`$userInput`,type:`geometry`},{name:`$view`,type:`dictionary`,properties:[{name:`scale`,type:`number`},{name:`timeProperties`,type:`dictionary`,properties:[{name:`currentStart`,type:`date`},{name:`currentEnd`,type:`date`},{name:`startIncluded`,type:`boolean`},{name:`endIncluded`,type:`boolean`}]}]}]},O=new Map([[`aggregate-field`,{variables:[{name:`$feature`,type:`feature`}]}],[`form-constraint`,{variables:[{name:`$feature`,type:`feature`}]}],[`feature-z`,{variables:[{name:`$feature`,type:`feature`}]}],[`field-calculation`,{variables:[{name:`$feature`,type:`feature`},{name:`$datastore`,type:`featureSetCollection`}]}],[`form-calculation`,{variables:[{name:`$feature`,type:`feature`},{name:`$originalFeature`,type:`feature`},{name:`$layer`,type:`featureSet`},{name:`$featureSet`,type:`featureSet`},{name:`$datastore`,type:`featureSetCollection`},{name:`$map`,type:`featureSetCollection`},{name:`$editContext`,type:`dictionary`,properties:[{name:`editType`,type:`text`}]}]}],[`labeling`,{variables:[{name:`$feature`,type:`feature`},{name:`$view`,type:`dictionary`,properties:[{name:`scale`,type:`number`},{name:`timeProperties`,type:`dictionary`,properties:[{name:`currentStart`,type:`date`},{name:`currentEnd`,type:`date`},{name:`startIncluded`,type:`boolean`},{name:`endIncluded`,type:`boolean`}]}]}]}],[`popup`,w],[`popup-element`,w],[`popup-feature-reduction`,T],[`popup-element-feature-reduction`,T],[`visualization`,{variables:[{name:`$feature`,type:`feature`},{name:`$view`,type:`dictionary`,properties:[{name:`scale`,type:`number`},{name:`timeProperties`,type:`dictionary`,properties:[{name:`currentStart`,type:`date`},{name:`currentEnd`,type:`date`},{name:`startIncluded`,type:`boolean`},{name:`endIncluded`,type:`boolean`}]}]}]}],[`popup-voxel`,E],[`popup-element-voxel`,E],[`popup-imagery`,D],[`popup-element-imagery`,D]]);function k(t){t===`feature-reduction-popup`?(a(n.getLogger(`esri.arcade`),`profile name: "feature-reduction-popup"`,{replacement:`"popup-feature-reduction"`,version:`4.32`,warnOnce:!0}),t=`popup-feature-reduction`):t===`feature-reduction-popup-element`&&(a(n.getLogger(`esri.arcade`),`profile name: "feature-reduction-popup-element"`,{replacement:`"popup-element-feature-reduction"`,version:`4.32`,warnOnce:!0}),t=`popup-element-feature-reduction`);let i=O.get(t);if(!i){let n=Array.from(O.keys()).map(e=>`'${e}'`).join(`, `);throw new e(`createArcadeProfile:invalid-profile-name`,`Invalid profile name '${t}'. You must specify one of the following values: ${n}`)}return r(i)}async function A(n,r,i={}){m||=await t();let{arcade:a,arcadeUtils:o,batchExec:{createBatchExecutor:s},aiServices:{BatchTranslationServiceFactory:c,PortalTranslationService:l}}=m,{loadScriptDependencies:d,referencesMember:p,scriptIsAsync:h}=a,g=x(r.variables,[]).filter(e=>e.type===`featureSet`||e.type===`featureSetCollection`).map(e=>f(e.name)),_=a.parseScript(n,g);if(!_)throw new e(`arcade:invalid-script`,`Unable to create SyntaxTree`);let v=o.extractFieldNames(_),y=a.scriptTouchesGeometry(_),b=r.variables.map(e=>f(e.name)).filter(e=>p(_,e)),w=h(_,g);await d(_,w,g);let T=a.compileScript(_,{vars:Object.fromEntries(b.map(e=>[e,!0])),useAsync:w}),{lruCache:E,services:D}=i,O=a.featureSetUtils();return{execute:(t,n={})=>{if(w)throw new e(`arcade:invalid-execution-mode`,`Cannot execute the script in synchronous mode`);let i={...D,...n.services},a={lruCache:E,...n,services:i},s=T(S(r,t,a,O,w));return n.rawOutput?s:C(s,o)},executeAsync:async(e,t={})=>{let n={...D,...t.services},i={lruCache:E,...t,services:n},a=await T(S(r,e,i,O,w));return t.rawOutput?a:C(a,o)},executeAsyncBatch:async(e,t,n={})=>{let i=[],a=s(e,async(e,a)=>{let s=t(e);try{let e={...d,translation:f.create(a)},t={lruCache:E,...n,services:e},c=await T(S(r,s,t,O,w)),l=n.rawOutput?c:C(c,o);i.push({id:a.id,result:{status:`fulfilled`,value:l}})}catch(e){throw i.push({id:a.id,result:{status:`rejected`,reason:e}}),e}},n.maxConcurrency??64,n.abortSignal),d={...D,...n.services},f=new c(a,d.translation??new l(d.portal??u.getDefault(),n.console));return await a.run(),i.sort(({id:e},{id:t})=>e-t).map(({result:e})=>e)},isAsync:w,variablesUsed:b,fieldsUsed:v,geometryUsed:y,syntaxTree:_}}export{A as createArcadeExecutor,k as createArcadeProfile};