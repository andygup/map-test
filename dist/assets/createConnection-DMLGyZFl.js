const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FeatureLayer-YCRMlWvA.js","assets/index-CzMixifc.js","assets/index-CDgdHpAj.css"])))=>i.map(i=>d[i]);
import{BS as e,BT as t,DT as n,FT as r,Gw as i,Lw as a,OT as o,RS as s,_a as c,gD as l,lC as u,rd as d,sv as f,uE as p,vv as m,wx as h}from"./index-CzMixifc.js";import{o as g}from"./query-BeU-rNp1.js";var _=class extends f{destroy(){this.emit(`destroy`)}get connectionError(){return this.errorString?new t(`stream-connection`,this.errorString):null}onFeature(e){this.emit(`data-received`,e)}onMessage(e){this.emit(`message-received`,e)}};l([n({readOnly:!0})],_.prototype,`connectionError`,null),_=l([o(`esri.layers.support.StreamConnection`)],_);var v=class extends _{constructor(e){super({}),this._outstandingMessages=[],this.errorString=null;let{geometryType:t,spatialReference:n,sourceSpatialReference:r}=e;this._config=e,this._featureZScaler=c(t,r,n),this._open()}normalizeCtorArgs(){return{}}async _open(){await this._tryCreateWebSocket(),this.destroyed||await this._handshake()}destroy(){super.destroy(),this._websocket!=null&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(this._websocket==null)return`disconnected`;switch(this._websocket.readyState){case 0:case 1:return`connected`;case 2:case 3:return`disconnected`}}sendMessageToSocket(e){this._websocket==null?this._outstandingMessages.push(e):this._websocket.send(JSON.stringify(e))}sendMessageToClient(e){this._onMessage(e)}updateCustomParameters(e){this._config.customParameters=e,this._websocket!=null&&this._websocket.close()}async _tryCreateWebSocket(e=this._config.source.path,n=1e3,r=0){try{if(this.destroyed)return;let t=u(e,this._config.customParameters??{});this._websocket=await this._createWebSocket(t),this.notifyChange(`connectionStatus`)}catch(a){let o=n/1e3;return this._config.maxReconnectionAttempts&&r>=this._config.maxReconnectionAttempts?(p.getLogger(this).error(new t(`websocket-connection`,`Exceeded maxReconnectionAttempts attempts. No further attempts will be made`)),void this.destroy()):(p.getLogger(this).error(new t(`websocket-connection`,`Failed to connect. Attempting to reconnect in ${o}s`,a)),await i(n),this._tryCreateWebSocket(e,Math.min(1.5*n,1e3*this._config.maxReconnectionInterval),r+1))}}_setWebSocketJSONParseHandler(e){e.onmessage=e=>{try{let t=JSON.parse(e.data);this._onMessage(t)}catch(e){p.getLogger(this).error(new t(`websocket-connection`,`Failed to parse message, invalid JSON`,{error:e}));return}}}_createWebSocket(e){return new Promise((t,n)=>{let r=new WebSocket(e);r.onopen=()=>{if(r.onopen=null,this.destroyed)return r.onclose=null,void r.close();r.onclose=e=>this._onClose(e),r.onerror=e=>this._onError(e),this._setWebSocketJSONParseHandler(r),t(r)},r.onclose=e=>{r.onopen=r.onclose=null,n(e)}})}async _handshake(e=1e4){let n=this._websocket;if(n==null)return;let r=a(),i=n.onmessage,{filter:o,outFields:s,spatialReference:c}=this._config;return r.timeout(e),n.onmessage=e=>{let a=null;try{a=JSON.parse(e.data)}catch{}a&&typeof a==`object`||(p.getLogger(this).error(new t(`websocket-connection`,`Protocol violation. Handshake failed - malformed message`,e.data)),r.reject(),this.destroy()),a.spatialReference?.wkid!==c?.wkid&&(p.getLogger(this).error(new t(`websocket-connection`,`Protocol violation. Handshake failed - expected wkid of ${c.wkid}`,e.data)),r.reject(),this.destroy()),a.format!==`json`&&(p.getLogger(this).error(new t(`websocket-connection`,`Protocol violation. Handshake failed - format is not set`,e.data)),r.reject(),this.destroy()),o&&a.filter!==o&&p.getLogger(this).error(new t(`websocket-connection`,`Tried to set filter, but server doesn't support it`)),s&&a.outFields!==s&&p.getLogger(this).error(new t(`websocket-connection`,`Tried to set outFields, but server doesn't support it`)),n.onmessage=i;for(let e of this._outstandingMessages)n.send(JSON.stringify(e));this._outstandingMessages=[],r.resolve()},n.send(JSON.stringify({filter:o,outFields:s,format:`json`,spatialReference:{wkid:c.wkid}})),r.promise}_onMessage(e){if(this.onMessage(e),`type`in e)switch(e.type){case`features`:case`featureResult`:for(let t of e.features)this._featureZScaler!=null&&this._featureZScaler(t.geometry),this.onFeature(t)}}_onError(e){let t=`Encountered an error over WebSocket connection`;this._set(`errorString`,t),p.getLogger(this).error(`websocket-connection`,t)}_onClose(e){this._websocket=null,this.notifyChange(`connectionStatus`),e.code!==1e3&&p.getLogger(this).error(`websocket-connection`,`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};l([n()],v.prototype,`connectionStatus`,null),l([n()],v.prototype,`errorString`,void 0),v=l([o(`esri.layers.graphics.sources.connections.WebSocketConnection`)],v);var y=1e4,b={maxQueryDepth:5,maxRecordCountFactor:3},x=class extends v{constructor(e){super({...b,...e}),this._buddyServicesQuery=null,this._relatedFeatures=null}async _open(){let e=await this._fetchServiceDefinition(this._config.source);e.timeInfo.trackIdField||p.getLogger(this).warn(`GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.`);let t=this._fetchWebSocketUrl(e.streamUrls,this._config.spatialReference);this._buddyServicesQuery||=this._queryBuddyServices(),await this._buddyServicesQuery,await this._tryCreateWebSocket(t);let{filter:n,outFields:r}=this._config;this.destroyed||this._setFilter(n,r)}_onMessage(e){if(`attributes`in e){let n;try{n=this._enrich(e),this._featureZScaler!=null&&this._featureZScaler(n.geometry)}catch(e){p.getLogger(this).error(new t(`geoevent-connection`,`Failed to parse message`,e));return}this.onFeature(n)}else this.onMessage(e)}async _fetchServiceDefinition(e){let t={f:`json`,...this._config.customParameters},n=s(e.path,{query:t,responseType:`json`}),r=(await n).data;return this._serviceDefinition=r,r}_fetchWebSocketUrl(e,t){let n=e[0],{urls:r,token:i}=n,a=this._inferWebSocketBaseUrl(r);return u(`${a}/subscribe`,{outSR:``+t.wkid,token:i})}_inferWebSocketBaseUrl(e){if(e.length===1)return e[0];for(let t of e)if(t.includes(`wss`))return t;return p.getLogger(this).error(new t(`geoevent-connection`,`Unable to infer WebSocket url`,e)),null}async _setFilter(e,n){let r=this._websocket;if(r==null||e==null&&n==null)return;let i=JSON.stringify({filter:this._serializeFilter(e,n)}),o=!1,s=a();return r.onmessage=e=>{let n=JSON.parse(e.data);n.filter&&(n.error&&(p.getLogger(this).error(new t(`geoevent-connection`,`Failed to set service filter`,n.error)),this._set(`errorString`,`Could not set service filter - ${n.error}`),s.reject(n.error)),this._setWebSocketJSONParseHandler(r),o=!0,s.resolve())},r.send(i),setTimeout(()=>{o||(this.destroyed||this._websocket!==r||p.getLogger(this).error(new t(`geoevent-connection`,`Server timed out when setting filter`)),s.reject())},y),s.promise}_serializeFilter(e,n){let r={};if(e==null&&n==null)return r;if(e?.geometry)try{let n=m(e.geometry);if(n.type!==`extent`)throw new t(`geoevent-connection`,`Expected extent but found type ${n.type}`);r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(e){p.getLogger(this).error(new t(`geoevent-connection`,`Encountered an error when setting connection geometryDefinition`,e))}return e?.where&&e.where!==`1 = 1`&&e.where!==`1=1`&&(r.where=e.where),n!=null&&(r.outFields=n.join(`,`)),r}_enrich(e){if(!this._relatedFeatures)return e;let n=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[n],i=this._relatedFeatures.get(r);if(!i)return p.getLogger(this).warn(`geoevent-connection`,`Feature join failed. Is the join field configured correctly?`,e),e;let{attributes:a,geometry:o}=i;for(let t in a)e.attributes[t]=a[t];return o&&(e.geometry=o),e.geometry||e.centroid||p.getLogger(this).error(new t(`geoevent-connection`,`Found malformed feature - no geometry found`,e)),e}async _queryBuddyServices(){try{let{relatedFeatures:e,keepLatestArchive:t}=this._serviceDefinition,n=this._queryRelatedFeatures(e),r=this._queryArchive(t);await n;let i=await r;if(!i)return;for(let e of i.features)this.onFeature(this._enrich(e))}catch(e){p.getLogger(this).error(new t(`geoevent-connection`,`Encountered an error when querying buddy services`,{error:e}))}}async _queryRelatedFeatures(e){if(!e)return;let t=await this._queryBuddy(e.featuresUrl);this._addRelatedFeatures(t)}async _queryArchive(e){if(e)return this._queryBuddy(e.featuresUrl)}async _queryBuddy(t){let n=new(await(e(async()=>{let{default:e}=await import(`./FeatureLayer-YCRMlWvA.js`);return{default:e}},__vite__mapDeps([0,1,2])))).default({url:t}),{capabilities:r}=await n.load(),i=r.query.supportsMaxRecordCountFactor,a=r.query.supportsPagination,o=r.query.supportsCentroid,s=this._config.maxRecordCountFactor,c=n.capabilities.query.maxRecordCount,l=i?c*s:c,u=new d;if(u.outFields=this._config.outFields??[`*`],u.where=this._config.filter?.where??`1=1`,u.returnGeometry=!0,u.returnExceededLimitFeatures=!0,u.outSpatialReference=h.fromJSON(this._config.spatialReference),o&&(u.returnCentroid=!0),i&&(u.maxRecordCountFactor=s),a)return u.num=l,n.destroy(),this._queryPages(t,u);let f=await g(t,u,this._config.sourceSpatialReference);return n.destroy(),f}async _queryPages(e,t,n=[],r=0){t.start=t.num==null?null:r*t.num;let i=await g(e,t,this._config.sourceSpatialReference);return i.exceededTransferLimit&&r<(this._config.maxQueryDepth??0)?(i.features.forEach(e=>n.push(e)),this._queryPages(e,t,n,r+1)):(n.forEach(e=>i.features.push(e)),i)}_addRelatedFeatures(e){let t=new Map,n=e.features,r=this._serviceDefinition.relatedFeatures.joinField;for(let e of n){let n=e.attributes[r];t.set(n,e)}this._relatedFeatures=t}};x=l([o(`esri.layers.graphics.sources.connections.GeoEventConnection`)],x);var S=class extends _{constructor(e){super({}),this.connectionStatus=`connected`,this.errorString=null;let{geometryType:t,spatialReference:n,sourceSpatialReference:r}=e;this._featureZScaler=c(t,r,n)}normalizeCtorArgs(){return{}}updateCustomParameters(e){}sendMessageToSocket(e){}sendMessageToClient(e){if(`type`in e)switch(e.type){case`features`:case`featureResult`:for(let t of e.features)this._featureZScaler!=null&&this._featureZScaler(t.geometry),this.onFeature(t)}this.onMessage(e)}};l([n()],S.prototype,`connectionStatus`,void 0),l([n()],S.prototype,`errorString`,void 0),S=l([r(`esri.layers.support.ClientSideConnection`)],S);function C(e,t){if(e==null&&t==null)return null;let n={};return t!=null&&(n.geometry=t),e!=null&&(n.where=e),n}function w(e,t,n,r,i,a,o,s,c){let l={source:e,sourceSpatialReference:t,spatialReference:n,geometryType:r,filter:C(i,a),maxReconnectionAttempts:o,maxReconnectionInterval:s,customParameters:c};return e?e.path.startsWith(`wss://`)||e.path.startsWith(`ws://`)?new v(l):new x(l):new S(l)}export{w as t};