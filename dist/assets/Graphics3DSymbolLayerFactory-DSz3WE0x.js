const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/OverrideHelper-CUPOvcEu.js","assets/colorUtils-CzajW9E7.js","assets/index-BN8X5Ryz.js","assets/index-CWJhHB6-.css","assets/OverrideHelper-BahbnLvz.js","assets/callExpressionWithFeature-UlbvTUQ4.js","assets/CIMSymbolRasterizer-BV4JT6Ns.js","assets/BidiEngine-DvXbVJau.js","assets/CIMSymbolHelper-B2DBxDPE.js","assets/rasterizingUtils-BsmZb-O9.js","assets/labelPoint-1O-zXr9b.js","assets/OptimizedGeometry-BQJ7w5VU.js","assets/memoryEstimations-D_IbKyOk.js","assets/GeometryUtils-B-8QW9FG.js","assets/Rect-LbcnjDUG.js","assets/BoundingBox-Dtf81F-g.js","assets/CIMResourceManager-DrX74G0L.js","assets/callExpressionWithFeature-CuRHGAgN.js","assets/LineMarker.glsl-a5PO1dFw.js","assets/LineMarker.glsl-DnVbe9A2.js","assets/MarkerSizing.glsl-nslzooYm.js","assets/FloatsPassUniform-DKsLDw29.js","assets/NoParameters-BDE7RvXT.js","assets/Uniform-C_fuiTP5.js","assets/VisualVariables.glsl-1DqsizMu.js","assets/AlphaCutoff-WIqqBGOV.js","assets/HighlightReadBitmap.glsl-BBr-esSE.js","assets/glsl-BMw-Ib6r.js","assets/Texture2DBindUniform-Btzx3XRx.js","assets/Float3PassUniform-SaBA6LBM.js","assets/Float4PassUniform-C4TO8dd0.js","assets/ScreenSizePerspective.glsl-BuhoSJZ3.js","assets/View.glsl-CPcmVaet.js","assets/Float3BindUniform-BDFedz_d.js","assets/Float3DrawUniform-ua6q6ZtZ.js","assets/FloatBindUniform-CXY5KrrB.js","assets/Matrix4BindUniform-D7U89BGU.js","assets/FloatPassUniform-CSAt82xV.js","assets/Slice.glsl-DU3Ivhcc.js","assets/TerrainDepthTest.glsl-D7e23Ppb.js","assets/ReadDepth.glsl-CX2bpX_x.js","assets/Float2BindUniform-D7Jg9GMR.js","assets/Float4BindUniform-DpoBnM9l.js","assets/Texture2DPassUniform-DFWoDpEL.js","assets/OutputColorHighlightOLID.glsl-CoP020fC.js","assets/Emissions.glsl-C_Yvv-sZ.js","assets/Texture2DDrawUniform-jqrXjxoW.js","assets/ShaderBuilder-BLOqjpgt.js","assets/videoUtils-CRYmuPNe.js","assets/ManagedTexture-DgNSfAYU.js","assets/image-CmtRVQsT.js","assets/Util-BQgFCZvD.js","assets/sdfPrimitives-BR6xMvJc.js","assets/NativeLine.glsl-B3TW3wR-.js","assets/NativeLine.glsl-D7AF8cgC.js","assets/Transform.glsl-2U1BxklA.js","assets/VertexColor.glsl-_MhPfHih.js","assets/Path.glsl-dxrULuNJ.js","assets/Path.glsl-Cftlm3XW.js","assets/ReadShadowMap.glsl-DMCvezCI.js","assets/PiUtils.glsl-IDKkXUQy.js","assets/ObjectAndLayerIdColor.glsl-BHzrt-xI.js","assets/SnowCover.glsl-DvDl-UAS.js","assets/SSAO.glsl-xhx5R_Qb.js","assets/ScreenSpacePass.glsl-QJ_LkLYn.js","assets/CameraSpace.glsl-BqHBV5nH.js","assets/Float2PassUniform-DUyrQoTC.js","assets/SSAOBlur.glsl-C8iS6qjP.js","assets/Float2DrawUniform-3WoZLC1o.js","assets/SceneLighting-LJvcoD7s.js","assets/sphere-d9-4vNcj.js","assets/vectorStacks-Cuo89CNO.js","assets/quatf64-D37SEdPg.js","assets/vec3-B94Y7ih2.js","assets/plane-Da5EsY0J.js","assets/ray-LkJ58wpZ.js","assets/ObjectStack-l5kM7JZu.js","assets/projectPointToVector-BkRdoTqD.js","assets/projectVectorToVector-DGzn2p7I.js","assets/dehydratedPoint-CWZQBefp.js","assets/frustum-LgSQ4wIS.js","assets/lineSegment-BudcKS0C.js","assets/orientedBoundingBox-Bd4igSGQ.js","assets/quat-C8PgLo31.js","assets/computeTranslationToOriginAndRotation-0WDVmpJG.js","assets/spatialReferenceEllipsoidUtils-qw9wv8RL.js","assets/HUDIntersectorResult-C5AENPbM.js","assets/VertexAttributeLocations-BScEla0R.js","assets/VertexElementDescriptor-Cl_nC_ty.js","assets/renderState-BaFdYDAL.js","assets/BooleanBindUniform-Dgbi5WXL.js","assets/NormalUtils.glsl-CQqskpJG.js","assets/Normals.glsl-Dm_iDce_.js","assets/Pattern.glsl-DbkAOHtV.js","assets/Pattern.glsl-D9hftdA3.js","assets/WaterSurface.glsl-fa-SFsxo.js","assets/WaterSurface.glsl-U1ahhBf-.js","assets/weather-D4qJROgB.js"])))=>i.map(i=>d[i]);
import{$ as e,$S as t,$T as n,$x as r,AS as i,AT as a,Af as o,Am as s,Aw as c,BT as l,Bb as u,Bf as d,Bl as f,Bm as p,Bv as m,CE as h,Cb as g,Cl as _,DE as v,ET as y,En as b,FE as x,Fb as S,Ff as C,Gb as ee,Gd as te,Gf as w,Gu as T,Hf as ne,Hl as E,Hu as re,If as ie,Ir as ae,J as D,Jf as O,Jm as oe,Jy as se,Kd as ce,Kf as le,Kl as ue,Ku as de,Lb as fe,Lf as pe,Ls as me,Mf as he,Mw as ge,Nb as _e,Nf as ve,Nl as k,Nr as ye,Ol as be,Pf as xe,Q as Se,Ql as Ce,Qt as we,Qw as Te,Rb as Ee,Rl as A,Rm as De,Ry as Oe,Sg as ke,TT as Ae,Tf as je,Tw as Me,Uf as Ne,Ul as j,Um as Pe,Uu as M,VT as Fe,Vl as Ie,Vm as Le,Vu as Re,Wm as ze,Wu as Be,X as Ve,Xf as He,Xm as Ue,Y as We,Ym as Ge,Yw as Ke,Z as qe,Zf as Je,Zl as Ye,Zm as Xe,Zy as Ze,__ as Qe,_f as $e,_g as et,_s as tt,_v as nt,_w as rt,aT as it,bf as at,bl as ot,cf as st,cg as ct,dn as lt,ep as ut,et as dt,eu as ft,ex as pt,gS as mt,gf as ht,h_ as gt,hf as _t,hg as N,hh as vt,hl as P,hw as yt,if as bt,jT as xt,jb as St,jl as Ct,kD as F,kT as wt,kb as Tt,kl as I,m_ as Et,mt as Dt,mx as Ot,n_ as kt,nt as At,o_ as jt,of as Mt,ot as Nt,ox as Pt,pT as Ft,pf as It,ph as Lt,pl as L,qC as Rt,qb as zt,qu as Bt,rd as Vt,rf as Ht,sD as Ut,sS as Wt,sT as Gt,sf as Kt,tf as qt,ut as Jt,vE as Yt,vl as Xt,vx as Zt,w_ as Qt,wf as $t,ww as en,x_ as tn,xl as R,xs as nn,yE as rn,y_ as z,yg as an,ys as on,zS as sn,zb as cn,zf as ln,zg as un,zl as dn}from"./index-BN8X5Ryz.js";import{r as fn}from"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./quatf64-D37SEdPg.js";import"./quat-C8PgLo31.js";import"./axisAngleDegrees-DzAS4tF-.js";import"./meshCloneUtils-BXMzy817.js";import{r as pn,t as mn}from"./MeshMaterialMetallicRoughness-Bdr2gXmV.js";import"./meshProperties-CbjLwdbT.js";import{t as hn}from"./MeshComponent-BFk18JiH.js";import"./MeshLocalVertexSpace-vomIk0sx.js";import{a as gn,i as _n}from"./meshVertexSpaceUtils-s2jLb8qI.js";import{t as vn}from"./earcut-CEMcWA4Z.js";import{a as yn,i as bn,n as xn,r as Sn,t as Cn}from"./Indices-tJiSUK6w.js";import{D as wn,a as Tn,b as En,g as Dn,m as On,w as kn,x as An,y as jn}from"./plane-Da5EsY0J.js";import"./vectorStacks-Cuo89CNO.js";import{n as Mn,r as Nn}from"./triangulationUtils-DNxIB1ux.js";import"./deduplicate-D-tDe87s.js";import{n as Pn}from"./projectPointToVector-BkRdoTqD.js";import{t as Fn}from"./computeTranslationToOriginAndRotation-0WDVmpJG.js";import{G as In,j as Ln,u as Rn}from"./BufferView-BW77W5ev.js";import{a as zn,i as Bn}from"./Util-BQgFCZvD.js";import{s as Vn}from"./vec3-B5yu4INg.js";import"./vec4-BLZ_ZPtE.js";import{a as Hn,i as Un,l as Wn,m as Gn,o as Kn,p as qn}from"./vertexSpaceConversion-Dz87RqR7.js";import"./spatialReferenceEllipsoidUtils-qw9wv8RL.js";import{i as Jn}from"./resourceUtils-BhD6CfOV.js";import"./types-BEunqM4i.js";import"./indexUtils-BSuZn8vT.js";import{t as Yn}from"./projectMeshVertexPositions-DdUIdZ5I.js";import"./dehydratedPoint-CWZQBefp.js";import{t as Xn}from"./projectVectorToVector-DGzn2p7I.js";import{n as Zn,r as Qn,t as $n}from"./symbolColorUtils-KqO0oQTm.js";import{i as B,r as er}from"./orientedBoundingBox-Bd4igSGQ.js";import{_ as tr,d as nr,h as rr,i as ir,l as V,m as ar,p as or,u as sr}from"./Emissions.glsl-C_Yvv-sZ.js";import"./glsl-BMw-Ib6r.js";import"./Uniform-C_fuiTP5.js";import"./Float3DrawUniform-ua6q6ZtZ.js";import"./Float3PassUniform-SaBA6LBM.js";import"./FloatPassUniform-CSAt82xV.js";import"./Texture2DDrawUniform-jqrXjxoW.js";import"./Texture2DPassUniform-DFWoDpEL.js";import"./NoParameters-BDE7RvXT.js";import{n as cr}from"./cimSymbolUtils-CLt57XQ8.js";import{o as lr}from"./utils-BGjabRH0.js";import{n as ur,t as dr}from"./SnappingCandidate-4DPnOY6Y.js";import"./ObjectStack-l5kM7JZu.js";import{r as fr}from"./ray-LkJ58wpZ.js";import"./HUDIntersectorResult-C5AENPbM.js";import"./Intersector-DL9RPLNy.js";import"./videoUtils-CRYmuPNe.js";import"./GeometryUtils-B-8QW9FG.js";import{n as pr}from"./VertexAttributeLocations-BScEla0R.js";import"./VertexElementDescriptor-Cl_nC_ty.js";import"./labelPoint-1O-zXr9b.js";import{E as mr,O as hr,t as gr}from"./CIMSymbolHelper-B2DBxDPE.js";import"./rasterizingUtils-BsmZb-O9.js";import"./Rect-LbcnjDUG.js";import"./BoundingBox-Dtf81F-g.js";import"./BidiEngine-DvXbVJau.js";import"./devEnvironmentUtils-Yxtjm7qW.js";import{r as _r,t as vr}from"./webStyleSymbolUtils-DnfhffQg.js";import"./vec3-B94Y7ih2.js";import{r as yr}from"./sphere-d9-4vNcj.js";import{d as br,n as xr,o as Sr,s as Cr}from"./lineSegment-BudcKS0C.js";import"./triangle-46ad8nAb.js";import"./hydratedFeatures-Cf3ay5ZM.js";import"./VertexArrayObject-ChtD6bwg.js";import"./BufferObject-B3_aJU6V.js";import{t as wr}from"./VertexBuffer-Ra4pb4dR.js";import"./vec3f32-DDMWoxUL.js";import"./ShaderBuilder-BLOqjpgt.js";import{a as Tr,i as Er,l as Dr,n as Or,r as kr,u as Ar}from"./renderState-BaFdYDAL.js";import"./image-CmtRVQsT.js";import"./frustum-LgSQ4wIS.js";import{B as jr,D as Mr,E as Nr,F as Pr,H as Fr,L as Ir,O as Lr,P as H,R as Rr,S as zr,V as Br,_ as Vr,c as Hr,d as Ur,f as Wr,i as Gr,k as Kr,l as qr,m as Jr,n as Yr,p as Xr,r as Zr,s as Qr,t as $r,u as ei,x as ti,z as ni}from"./DefaultBufferWriter-BGKzMKkp.js";import{S as ri,_ as ii,a as ai,f as oi,h as si,l as ci,o as li,p as ui,s as di,u as fi,v as pi,x as mi}from"./ElevationContext-BzXFRbX1.js";import{a as hi,n as gi}from"./MaterialUtil-CcE5uVnF.js";import{t as _i}from"./Octree-czER3kAP.js";import{a as vi,i as yi,p as bi,s as xi,u as Si}from"./SceneLighting-LJvcoD7s.js";import"./ScreenSpacePass.glsl-QJ_LkLYn.js";import"./Float2BindUniform-D7Jg9GMR.js";import"./ReadDepth.glsl-CX2bpX_x.js";import{a as Ci,n as wi,r as Ti,s as Ei}from"./FloatArray-Dt98pDp2.js";import"./Float4BindUniform-DpoBnM9l.js";import"./CameraSpace.glsl-BqHBV5nH.js";import"./Texture2DBindUniform-Btzx3XRx.js";import"./Float2PassUniform-DUyrQoTC.js";import"./Float3BindUniform-BDFedz_d.js";import"./Float4PassUniform-C4TO8dd0.js";import"./FloatBindUniform-CXY5KrrB.js";import"./Matrix4BindUniform-D7U89BGU.js";import"./Matrix4PassUniform-CDJEQqiQ.js";import{_ as Di,a as Oi,c as ki,d as Ai,g as ji,h as Mi,l as Ni,m as Pi,n as Fi,o as Ii,p as Li,r as Ri,s as zi,t as Bi,u as Vi,v as Hi,y as Ui}from"./DefaultLayouts-D2eBAPD-.js";import{a as Wi,c as Gi,d as Ki,f as qi,i as Ji,l as Yi,o as Xi,s as Zi,u as Qi}from"./FloatsPassUniform-DKsLDw29.js";import"./TextureOnly.glsl-DvvGRcsb.js";import"./HighlightCellGridScreenSpacePass.glsl-BYepSulG.js";import"./IntegerPassUniform-CdQB44QJ.js";import"./HighlightDownsample.glsl-CHTjOIMl.js";import"./HighlightReadBitmap.glsl-BBr-esSE.js";import"./Float2DrawUniform-3WoZLC1o.js";import"./HighlightApply.glsl-C2uw2Uqi.js";import"./HighlightBlur.glsl-Bcasx3G3.js";import"./HighlightToSingle.glsl-DnQ7SOsv.js";import"./NestedMap-BpsBVffk.js";import"./Slice.glsl-DU3Ivhcc.js";import"./ObjectAndLayerIdColor.glsl-BHzrt-xI.js";import"./VisualVariables.glsl-1DqsizMu.js";import{t as $i}from"./AlphaCutoff-WIqqBGOV.js";import"./ScreenSizePerspective.glsl-BuhoSJZ3.js";import"./View.glsl-CPcmVaet.js";import"./MarkerSizing.glsl-nslzooYm.js";import"./RibbonLine.glsl-CfmEn9-p.js";import{r as ea,t as ta}from"./ManagedTexture-DgNSfAYU.js";import{a as na,i as ra,n as ia,o as aa,t as oa}from"./sdfPrimitives-BR6xMvJc.js";import"./PiUtils.glsl-IDKkXUQy.js";import"./TerrainDepthTest.glsl-D7e23Ppb.js";import"./OutputColorHighlightOLID.glsl-CoP020fC.js";import"./weather-D4qJROgB.js";import"./OverlayCompositing.glsl-qGsngx-I.js";import{O as sa,_ as ca,a as la,c as ua,h as da,i as fa,k as pa,l as ma,n as ha,o as ga,r as _a,s as va}from"./graphicUtils-Ct1OT6JD.js";import{t as ya}from"./VerticalOffset.glsl-VrGhTlbS.js";import"./HUDVisibility.glsl-DO8Yaq72.js";import"./BooleanBindUniform-Dgbi5WXL.js";import"./HUDMaterial.glsl-CIbE2wvS.js";import"./Transform.glsl-2U1BxklA.js";import"./VertexColor.glsl-_MhPfHih.js";import"./ColorMaterial.glsl-Bt7WM1mm.js";import"./TextureBackedBufferLayout-C3PSJOOo.js";import{C as ba,E as xa,O as Sa,S as Ca,T as wa,_ as Ta,a as Ea,d as Da,f as Oa,g as ka,h as Aa,i as ja,j as Ma,k as Na,l as Pa,m as Fa,n as Ia,o as La,p as Ra,r as za,s as Ba,t as Va,u as Ha,w as Ua}from"./pointUtils-BP9nRZeK.js";import{a as Wa,i as Ga,n as Ka,o as qa,r as Ja,t as Ya}from"./primitiveObjectSymbolUtils-fz701Tc0.js";import"./MixExternalColor.glsl-D0GjeJQe.js";import{a as Xa,i as Za,n as Qa,o as $a,s as eo}from"./DefaultMaterial-BVbzHMdq.js";import{d as to,l as no,u as ro}from"./SnowCover.glsl-DvDl-UAS.js";import"./DefaultMaterial.glsl-pmrJSA2T.js";import"./ReadShadowMap.glsl-DMCvezCI.js";import"./SSAOBlur.glsl-C8iS6qjP.js";import"./SSAO.glsl-xhx5R_Qb.js";import"./Normals.glsl-Dm_iDce_.js";import"./RealisticTree.glsl-DAC1hFJj.js";import{i as io,n as ao,r as oo,t as so}from"./Normals-B0YlgMdD.js";import{a as co,c as lo,i as uo,l as fo,n as po,o as mo,r as ho,s as go,t as _o}from"./placementUtils-BiPNPByu.js";import{n as vo}from"./LineMarker.glsl-DnVbe9A2.js";import{n as yo,r as bo}from"./objectResourceUtils-BGpN_4t9.js";import{n as xo}from"./NativeLine.glsl-D7AF8cgC.js";import{n as So,r as Co}from"./Path.glsl-Cftlm3XW.js";import"./NormalUtils.glsl-CQqskpJG.js";import{t as wo}from"./Pattern.glsl-D9hftdA3.js";import{t as To}from"./WaterSurface.glsl-U1ahhBf-.js";function Eo(e,t,n){let r=(t.length>0?t[0]:e.length/3)-1,i=Nn(e,r,n);if(i!==2){e=e.slice();for(let t=0;t<e.length;t+=3)e[t+i]=e[t+2]}return vn(e,t,3)}function Do(e){let t=[[`position`,new B(e.attributeData.position,e.indices,3,!0)]],n=xn(e.indices.length);return e.attributeData.colorFeature==null?e.attributeData.color&&t.push([`color`,new B(e.attributeData.color,n,4,!0)]):t.push([`colorFeatureAttribute`,new B([e.attributeData.colorFeature],n,1,!0)]),e.attributeData.uvMapSpace&&t.push([`uvMapSpace`,new B(e.attributeData.uvMapSpace,e.indices,4,!0)]),e.attributeData.boundingRect&&t.push([`boundingRect`,new B(e.attributeData.boundingRect,e.indices,9,!0)]),new Kr(e.material,t,e.mapPositions,0,e.attributeData.olidColor)}function Oo(e,t=null){let n=[[`position`,new B(e.attributeData.position,e.indices,3,!0)],[`uv0`,new B(e.attributeData.uv0,e.indices,2,!0)]];return new Kr(e.material,n,e.mapPositions,0,t)}function ko(e){switch(e.type){case`extent`:if(e instanceof Zt)return m.fromExtent(e);break;case`polygon`:return e}return null}var Ao=class{constructor(e,t,n){this.renderData=e,this.layerViewUid=t,this.graphicUid=n,this.outGeometries=[]}};function jo(e,t,n,r){let i=Mn(e.rings,!!e.hasZ&&r.mode!==`on-the-ground`,1,e.spatialReference),a=Ne(i.position.length),o=ci(i.position,e.spatialReference,0,a,0,i.position,0,i.position.length/3,t,n,r),s=o!=null;return new Bo(i.position,a,Po(i.polygons,i.position,a),No(i.outlines,i.position,a),s,o)}function Mo(e,t){let n=Mn(e.rings,!1,1),r=kt(n.position,e.spatialReference,0,n.position,t,0);for(let e=2;e<n.position.length;e+=3)n.position[e]=-2;let i=Po(n.polygons,n.position),a=No(n.outlines,n.position);return new zo(n.position,i,a,r)}function No(e,t,n=null){return e.filter(({count:e})=>e>1).map(({index:e,count:r})=>{let i=3*e,a=3*r;return n==null?new Fo(e,r,w(t,i,a)):new Io(e,r,w(t,i,a),w(n,i,a))})}function Po(e,t,n=null){let r=[];for(let{index:i,count:a,holeIndices:o,pathLengths:s}of e){if(a<=1)continue;let e=3*i,c=3*a,l=o.map(e=>e-i),u=n==null?new Ro(i,a,w(t,3*i,3*a),l,s):new Lo(i,a,w(t,3*i,3*a),w(n,e,c),l,s);r.push(u)}return r}var Fo=class{constructor(e,t,n){this.index=e,this.count=t,this.position=n}},Io=class extends Fo{constructor(e,t,n,r){super(e,t,n),this.mapPositions=r}},Lo=class extends Io{constructor(e,t,n,r,i,a){super(e,t,n,r),this.holeIndices=i,this.pathLengths=a}},Ro=class extends Fo{constructor(e,t,n,r,i){super(e,t,n),this.holeIndices=r,this.pathLengths=i}},zo=class{constructor(e,t,n,r){this.position=e,this.polygons=t,this.outlines=n,this.projectionSuccess=r}},Bo=class{constructor(e,t,n,r,i,a){this.position=e,this.mapPositions=t,this.polygons=n,this.outlines=r,this.projectionSuccess=i,this.sampledElevation=a}},Vo=[`polygon`,`extent`],Ho=class extends Ba{constructor(e,t,n,r){super(e,t,n,r,os(t)),this.ensureDrapedStatus(!1)}async doLoad(){let e=this.symbolLayer,t=e?.material,n=this.symbolLayer.material?.color?.a,r=this.needsDrivenTransparentPass||n!=null&&n!==1,i=t?.emissive,a=!this._hasDrivenColorOrOpacity&&(n==null||n===0),o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:Et,diffuse:Et,opacity:a?0:1,layerOpacity:this._getLayerOpacity(),drivenOpacity:r,hasSymbolColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:e.castShadows,emissiveStrengthFromSymbol:i?.strength??0,emissiveSource:1,offsetTransparentBackfaces:!0,normalType:1},s=new Qa(o,this._context),c=new Qa({...o,cullFace:2},this._context);this._materials[0]=s,this._materials[1]=c,this._updateTransparentDepedentMaterialParameters()}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,Vo,this.symbolLayer.type))return null;let n=this._getDrivenUInt8ColorWithNaNSupport(e.renderingInfo,this._materialColor,!1);$n(n,n);let r=this.createElevationContextForGraphic(t);return this._createAs3DShape(t,e.renderingInfo,n,r,t.uid)}layerOpacityChanged(e,t){let n=this._getLayerOpacity();this._materials[0]?.setParameters({layerOpacity:n}),this._materials[1]?.setParameters({layerOpacity:n}),this._updateTransparentDepedentMaterialParameters(),e?.forEach(e=>t(e)?.layerOpacityChanged(n,this._context.isAsync))}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,fi)}slicePlaneEnabledChanged(e,t){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e?.forEach(e=>{t(e)?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){let e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[0]?.setParameters(e),this._materials[1]?.setParameters(e),!0}_getExtrusionSize(e){let t;return t=e.size&&this._drivenProperties.size?Ma(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?0:1}async queryForSnapping(e,t,n,r){let i=this._getExtrusionSize(n)*this._context.renderCoordsHelper.unitInMeters/Wt(t),{objectId:a,target:o}=e,s=x(o);switch(s.z=(s.z??0)+i,e.type){case`edge`:{let{start:t,end:n}=e,r=x(t),o=x(n);return r.z=(r.z??0)+i,o.z=(o.z??0)+i,[new dr(a,s,1/0,r,o)]}case`vertex`:return[new ur(a,s,1/0),new dr(a,o,1/0,o,s)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,t,n,r,i){let a=ko(e.geometry);if(a==null)return null;if(a.rings.length===0||!a.rings.some(e=>e.length>0))return this._logGeometryValidationWarnings(a.rings,`rings`,`ExtrudeSymbol3DLayer`),null;let s=jo(a,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(s,a.rings,`rings`,`ExtrudeSymbol3DLayer`);let c=ua(a);if(c==null)return null;let l=[],u=[],d=o(),f=O(),p=z(),m=this._context.renderCoordsHelper.viewingMode===1;m||this._context.renderCoordsHelper.worldUpAtPosition(null,p),Fn(a.spatialReference,[c.x,c.y,0],f,this._context.renderCoordsHelper.spatialReference);let h=O();Pe(h,f);let g=Oe();se(g,h);let{polygons:_,mapPositions:v,position:y}=s,b=new Map,x=this._materials[0];for(let e of _){let r=e.count;if(this._context.clippingExtent&&(ve(e.mapPositions,d),!at(d,this._context.clippingExtent)))continue;let a=vn(e.mapPositions,e.holeIndices,3);if(a.length===0)continue;let o=a.length,s=6*r,c=bn(s+o),g=bn(o),_=Ne(3*s),S=Ne(3*s),C=Ne(3*s),ee=Ne(s);Wo(y,v,a,e,_,C,S,ee,c,g,this._getExtrusionSize(t),p,m),Vn(_,_,h);let te=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid}),w=new ms(_,C,so(S),ee),T=Uo(x,c,c.length-g.length,w,n,te),ne=r,E=r,re=2*e.count,ie=new hs(ne,E,re,o/3);rs(T,ie,f),b.set(T,ie),l.push(T,Uo(this._materials[1],g,0,w,n,te)),u.push(w.heights)}if(l.length===0)return null;let S=new mi({geometries:l,layerViewUid:this._context.layerViewUid,graphicUid:i,isElevationSource:!0});S.transformation=f;let C=Zn(this.symbolLayer,{opacity:this._getLayerOpacity()}),ee=C?new Da(this._materials[0],C,this._context.slicePlaneEnabled):null,te=new Ha(this,S,null,(e,t,n,r,i)=>ns(e,t,n,r,i,u,b),r,ee);return te.alignedSampledElevation=s.sampledElevation,te.needsElevationUpdates=fi(r.mode),te}get _materialColor(){return this.symbolLayer.material?.color}_updateTransparentDepedentMaterialParameters(){let e=this._materials[0];e&&e.setParameters({cullFace:e.transparent?0:2})}};function Uo(e,t,n,r,i,a){let o=xn(t.length),s=[[`position`,new B(r.positions,t,3,!0)],[`normalCompressed`,new B(r.normals,t,2,!0)],[`symbolColor`,new B(i,o,4,!0)]];return new Kr(e,s,r.elevation,0,a,n)}function Wo(e,t,n,r,i,a,o,s,c,l,u,d,f){let p=n.length/3,m=2*r.count;Go(e,t,r.index,r.count,n,0,p,i,a,o,s,c,l,m,u,d,f);let h=0,g=2*r.count;m=0;let _=r.pathLengths[0];Jo(i,a,s,o,h,_,r.count,g,c,m,u),g+=4*_,m+=2*_,h+=_;for(let e=1;e<r.pathLengths.length;++e){let t=r.pathLengths[e];Jo(i,a,s,o,h,t,r.count,g,c,m,u),g+=4*t,m+=2*t,h+=t}}function Go(e,t,n,r,i,a,o,s,c,l,u,d,f,p,m,h,g){E(W,h),c??=[],l??=[],u??=[];let _=m>0?1:-1,v=3*n,y=0,b=3*y,x=r,S=3*x;for(let n=0;n<r;++n){let n=e[v],r=e[v+1],i=e[v+2];g&&(W[0]=n,W[1]=r,W[2]=i,L(W,W)),s[b+0]=n,s[b+1]=r,s[b+2]=i;let a=t[v+0],o=t[v+1],d=t[v+2];c[b+0]=a,c[b+1]=o,c[b+2]=d,l[b+0]=-_*W[0],l[b+1]=-_*W[1],l[b+2]=-_*W[2],u[y]=0,s[S+0]=n+m*W[0],s[S+1]=r+m*W[1],s[S+2]=i+m*W[2],c[S+0]=a,c[S+1]=o,c[S+2]=d,u[x]=m,b+=3,S+=3,v+=3,y+=1,x+=1}v=3*a,b=0,S=3*p;let C=m<0?ls:cs,ee=m<0?cs:ls;for(let e=0;e<o;++e)f[b]=i[v+C[0]],f[b+1]=i[v+C[1]],f[b+2]=i[v+C[2]],d[S]=i[v+ee[0]]+r,d[S+1]=i[v+ee[1]]+r,d[S+2]=i[v+ee[2]]+r,b+=3,S+=3,v+=3}function Ko(e,t,n,r,i,a,o){r[a]=r[o],o*=3,e[a*=3]=e[o],e[a+1]=e[o+1],e[a+2]=e[o+2],t[a]=t[o],t[a+1]=t[o+1],t[a+2]=t[o+2],n[a]=i[0],n[a+1]=i[1],n[a+2]=i[2]}var qo=z();function Jo(e,t,n,r,i,a,o,s,c,l,u){t??=[],n??=[],r??=[];let d=i,f=i+1,p=i+o,m=i+o+1,h=s,g=s+1,_=s+2*a,v=s+2*a+1;u<0&&(d=i+o+1,m=i);let y=3*l;for(let s=0;s<a;++s)s===a-1&&(f=i,u>0?m=i+o:d=i+o),es(e,d,f,p,qo),Ko(e,t,r,n,qo,h,d),Ko(e,t,r,n,qo,g,f),Ko(e,t,r,n,qo,_,p),Ko(e,t,r,n,qo,v,m),c[y]=h,c[y+1]=_,c[y+2]=v,c[y+3]=h,c[y+4]=v,c[y+5]=g,y+=6,d++,f++,p++,m++,h+=2,g+=2,_+=2,v+=2}var Yo=z(),Xo=z(),Zo=z(),Qo=z(),$o=z();function es(e,t,n,r,i){t*=3,n*=3,r*=3,A(Yo,e[t++],e[t++],e[t++]),A(Xo,e[n++],e[n++],e[n++]),A(Zo,e[r++],e[r++],e[r++]),I(Qo,Xo,Yo),I($o,Zo,Yo),be(i,$o,Qo),L(i,i)}var ts=z();function ns(e,t,n,r,i,a,o){let s=e.stageObject,c=s.geometries,l=c.length,u=t.mode!==`absolute-height`,d=0,f=s.transformation,m=p(O(),f);for(let e=0;e<l;e+=2){let t=c[e];if(!ka(t))continue;let l=t.getMutableAttribute(`position`).data,p=a[e/2],h=new si(t.mapPositions),g=l.length/3,_=!1,v=0;{let e=0;for(let t=0;t<g;t++){ts[0]=l[e],ts[1]=l[e+1],ts[2]=l[e+2],r(h,ss),u&&(v+=ss.sampledElevation),qi.TESTS_DISABLE_OPTIMIZATIONS?(A(U,h.array[h.offset],h.array[h.offset+1],ss.z+p[e/3]),n!=null&&i.toRenderCoords(U,n,U),P(U,U,m)):(A(U,l[e],l[e+1],l[e+2]),P(U,U,f),i.setAltitude(U,ss.z+p[e/3]),P(U,U,m)),l[e]=U[0],l[e+1]=U[1],l[e+2]=U[2];let t=us/i.unitInMeters;(Math.abs(ts[0]-l[e])>=t||Math.abs(ts[1]-l[e+1])>=t||Math.abs(ts[2]-l[e+2])>=t)&&(_=!0),h.offset+=3,e+=3}}if(_){let n=o.get(t);n&&rs(t,n,f),s.geometryVertexAttributeUpdated(c[e],`normalCompressed`),t.invalidateBoundingInfo(),s.geometryVertexAttributeUpdated(c[e],`position`),c[e+1].invalidateBoundingInfo(),s.geometryVertexAttributeUpdated(c[e+1],`position`)}d+=v/g}return d/l}function rs(e,t,n){let r=e.getMutableAttribute(`position`),i=e.getMutableAttribute(`normalCompressed`).data,a=r.data,o=e.attributes.get(`position`).indices,{topVertexStart:s,topVertexCount:c,topFaceStart:l,topFaceCount:u}=t,d=l+u,f=s+c,p=ds,m=fs,h=ps,g=W,v=U;A(v,0,0,0);let y=(e,t)=>{let r=3*e;A(t,a[r+0],a[r+1],a[r+2]),P(t,t,n)};for(let e=l;e<d;++e){let t=3*e;y(o[t+0],p[0]),y(o[t+1],p[1]),y(o[t+2],p[2]),_(m,p[1],p[0]),_(h,p[2],p[0]),be(g,m,h),j(v,v,g)}L(v,v);for(let e=s;e<f;++e){let t=v[0],n=v[1],r=v[2];ao(i,e,t,n,r)}}function os(e){return(e.material?.color?.a??0)===1}var U=z(),W=z(),ss=new ui,cs=[0,2,1],ls=[0,1,2],us=.01,ds=[z(),z(),z()],fs=z(),ps=z(),ms=class{constructor(e,t,n,r){this.positions=e,this.elevation=t,this.normals=n,this.heights=r}},hs=class{constructor(e,t,n,r){this.topVertexStart=e,this.topVertexCount=t,this.topFaceStart=n,this.topFaceCount=r}},gs=.42,_s=.32;function vs(e,t){if(e)switch(t){case`bright`:{let t=(e[0]+e[1]+e[2])/3;return[t*_s+(1-_s),t*_s+(1-_s),t*_s+(1-_s),e[3]*_s]}case`dark`:return[e[0]*gs,e[1]*gs,e[2]*gs,e[3]*gs]}}var ys=class{constructor(e,t,n,r){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=n,this._drapeSourceRenderer=r,this.type=`draped`,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e.stage}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}setVisibility(e){if(this.stage!=null&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,0);if(e||this._addedToStage){for(let e of this.renderGeometries)e.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,1)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,2),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=z()){return A(e,0,0,0)}getBoundingBoxObjectSpace(e=o()){return ln(e)}addObjectState(e){e.stateType===0&&(this.renderGeometries.forEach(t=>{let n=t.geometry.allocateIdAndHighlight(e.highlightName);e.addRenderGeometry(t,n,this)}),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,8))}removeObjectState(e){this.renderGeometries.forEach(t=>e.removeByObject(t))}updateHighlights(e){}removeRenderGeometryObjectState(e,t){t.channel===0&&(e.geometry.removeHighlight(t),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries([e],8))}computeAttachmentOrigin(e){for(let t of this.renderGeometries)t.geometry.computeAttachmentOrigin(Ss)&&(e.draped.origin[0]+=Ss[0],e.draped.origin[1]+=Ss[1],e.draped.num++)}async getProjectedBoundingBox(e,t,n,r,i){ln(i);for(let t=0;t<this.renderGeometries.length;t++){let r=this.renderGeometries[t];this._getRenderGeometryProjectedBoundingRect(r,e,bs,n),d(i,bs)}if(t){let e;C(i,Ss);let n=fa(i,t.service.spatialReference,t);try{e=await t.service.queryElevation(Ss[0],Ss[1],r,n,`ground`)}catch{}e!=null&&(i[2]=Math.min(i[2],e),i[5]=Math.max(i[5],e))}return i}_getRenderGeometryProjectedBoundingRect(e,t,n,r){if(this.boundingBox)ie(xs,this.boundingBox);else{let{center:t,radius:n}=e.boundingSphere;xs[0]=t[0]-n,xs[1]=t[1]-n,xs[2]=t[2]-n,xs[3]=t[0]+n,xs[4]=t[1]+n,xs[5]=t[2]+n}return t(xs,0,2),this.calculateRelativeScreenBounds&&r.push({location:C(xs),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),st(xs,n)}},bs=Ot(),xs=o(),Ss=z(),Cs=tn(0,0,1),ws=16,Ts=1.5,Es=[128*ra,128*ra],Ds=class r extends Ba{static{this.PRIMITIVE_SIZE=Es}getCachedSize(){return{size:this._getIconSize()}}static{this.elevationModeChangeTypes={definedChanged:1,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,n,r){super(e,t,n,r,Ps(t)),this._cimData=null,this._overrideHelperClass=null,this._arcadeInfo=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._textureHandle=null,this._patchTask=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}async doLoad(e){this._validateOrThrow();let t=this._prepareMaterialParameters(),n=this._getPrimitive();if(n!=null)this._prepareResourcesPrimitive(t,n);else{let n=lr(this.symbolLayer),r=As(n);r==null?await this._prepareResourcesHref(t,n,e):await this._prepareResourcesCIM(t,JSON.parse(r),e)}}_validateOrThrow(){if(this._drivenProperties.size)return;let e=ga(this._getIconSize());if(e)throw new n(`graphics3diconsymbollayer:invalid-size`,e)}_getIconSize(){let e=this.symbolLayer,t=Math.round(e.size==null?ws:N(e.size));return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e,t){let n=this._overrideHelperClass,r=this._cimData;if(n&&r&&r.symbol||this.logger.error(`Can't create texture, CIM data is undefined`),r.primitiveOverrides){r=x(r);let i=r.primitiveOverrides;n.evaluateOverrides(i,e,this._arcadeInfo.geometryType,null,null,t.layer.fieldsIndex),n.applyOverrides(r.symbol,i)}let i=v(JSON.stringify(r)),a=this._cimSymbolTextures.get(i);if(a)return a;let o=this._context.sharedResources.cimSymbolRasterizer,s=this._context.renderer&&this._context.renderer.type===`dictionary`?this._context.renderer.fieldMap:null;s&&n.applyDictionaryTextOverrides(r.symbol,e,s,null);let c=this._cimScaleFactorOrFunction==null?1:we(this._cimScaleFactorOrFunction,e);c!==1&&r.symbol&&cr(r.symbol,c,!0);let l=gr.getEnvelope(r,null,o.resourceManager);if(l?.width&&l.height){let e=l.x+l.width/2,t=l.y+l.height/2,n=o.rasterize({type:`cim`,data:r},l.width,l.height,e,t,1,`esriGeometryPoint`,0,null,this._context.graphicsCoreOwner.view.state.rasterPixelRatio),i=new Ht({x:-l.x/l.width-.5,y:(l.height+l.y)/l.height-.5});this._cimMaterialParametersInfo.anchorPosition=js(`relative`,i),a=new ta(n,{width:n?.width??1,height:n?.height??1,reloadable:!0})}else a=new ta(new ImageData(1,1),{width:1,height:1,reloadable:!0});return this._cimSymbolTextures.set(i,a),this._context.stage.addTexture(a),a}_prepareMaterialParameters(){let e={anchorPosition:js(this.symbolLayer.anchor,this.symbolLayer.anchorPosition),rotation:this.symbolLayer.angle},t=this.symbol;Os(t)&&(e.verticalOffset=new ya(t.verticalOffset)),this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this.view.screenSizePerspective.parameters),(e.rotation!==0||this._drivenProperties.rotation)&&(e.hasRotation=!0);let n=this.symbolLayer.occludedVisibility?.mode??`hidden`,r=this.view.basemapTerrain;return e.useVisibilityPixel=!r.opaque&&!r.invisible&&n===`hidden`,e.occludedVisibilityMode=this.symbolLayer.occludedVisibility?.mode??`hidden`,e.occludedFragmentFade=!1,e.horizonCullingEnabled=this._context.spherical,e.hasSlicePlane=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){let n=this._getOutlineSize();if(ks(t)&&n===0)throw Error(`Nothing to render`);if(this._outlineSize=n,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,this._context.sharedResources.textures!=null){let n=this._context.sharedResources.textures.fromData(`${t}-icon`,()=>ia(t));this._textureHandle=n,e.textureId=n.managedTexture.id}e.textureIsSignedDistanceField=!0,e.sampleSignedDistanceFieldTexelCenter=na(t),e.distanceFieldBoundingBox=aa;let r=this._getIconSize();this._size=[r,r],this._symbolTextureRatio=1/ra,this._createMaterial(e)}async _prepareResourcesHref(e,t,r){this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;let i=this._getIconSize(),a=i*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(this._context.sharedResources.textures!=null){let o=await an(this._context.sharedResources.textures.fromUrl(t,a,{signal:r}));if(!1===o.ok)throw Gt(o.error),new n(`graphics3diconsymbollayer:request-failed`,`Failed to load (Request for icon resource failed: ${t})`);this._textureHandle=o.value;let s=o.value.managedTexture;this._size=Ms(s,i),e.textureId=s.id}this._createMaterial(e)}async _prepareResourcesCIM(e,n,r){let{OverrideHelper:i}=await t(async()=>{let{OverrideHelper:e}=await import(`./OverrideHelper-CUPOvcEu.js`);return{OverrideHelper:e}},__vite__mapDeps([0,1,2,3,4,5]));if(this._overrideHelperClass=i,this._cimData=n,!this._context.sharedResources.cimSymbolRasterizer){let e=(await t(async()=>{let{CIMSymbolRasterizer:e}=await import(`./CIMSymbolRasterizer-BV4JT6Ns.js`);return{CIMSymbolRasterizer:e}},__vite__mapDeps([6,2,3,7,8,9,10,11,12,13,14,15,1,16,4,5]))).CIMSymbolRasterizer;Ft(r),this._context.sharedResources.cimSymbolRasterizer??=new e(this._context.renderCoordsHelper.spatialReference)}let a=this._context.sharedResources.cimSymbolRasterizer,o=[],s=n,c=s?.symbol;gr.fetchResources(c,a.resourceManager,o,r),gr.fetchFonts(c,a.resourceManager,o);let l=this._context.layer.fields?this._context.layer.fields.map(e=>e.toJSON()):[];if(this._arcadeInfo={spatialReference:this._context.renderCoordsHelper.spatialReference,fields:l,geometryType:`esriGeometryPoint`},s?.primitiveOverrides&&o.push(i.createRenderExpressions(s.primitiveOverrides,this._arcadeInfo)),o.length>0&&(await Promise.all(o),Ft(r)),this._context.renderer&&this._context.renderer.type===`dictionary`&&this._context.renderer.scaleExpression){let e=this._context.renderer;if(e.scaleExpression){let n=e.scaleExpression,r=await lt(n,this._context.layer.spatialReference),{default:i}=await t(async()=>{let{default:e}=await import(`./callExpressionWithFeature-CuRHGAgN.js`);return{default:e}},__vite__mapDeps([17,5,2,3])),a=new b(l);this._cimScaleFactorOrFunction=(e,t,n)=>{let o=i(r,e,{$view:n},`esriGeometryPoint`,a,t);return o===null?1:o}}}Ft(r),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return Ns(this.symbolLayer)}_getOutlineSize(){let e=0,t=this.symbolLayer;return t.outline?.size==null?(e=ks(this._getPrimitive())?Ts:0,Math.max(e,0)):Math.max(N(t.outline.size),0)}_getOutlineColor(){let e=this._getLayerOpacity(),t=this.symbolLayer,n=t?.outline?.color;if(n!=null){let t=n.toUnitRGB(),r=n.a*e;return[t[0],t[1],t[2],r]}return[0,0,0,0]}_getFillColor(){if(ks(this._getPrimitive()))return Sa;let e=this._getPrimitive()==null,t=this._materialColor;return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}get _materialColor(){return this.symbolLayer.material?.color}get _fastVisualVariableFallbackColor(){let t=this._materialColor;return t==null?this._getPrimitive()==null?e:D:t.toUnitRGBA()}_getFallbackSize(){let e=this._getIconSize(),{symbolLayer:{size:t}}=this;return(t==null?ws:Math.round(N(t)))/e}_createMaterial(e){let t=this._context.spherical;if(this._cimData){this._fastUpdates=null;let n=e.textureId?this._cimSymbolMaterials.get(e.textureId):null;return n||(n=new ma(e,t),this._cimSymbolMaterials.set(e.textureId??0,n)),n}this._fastUpdates=Xi(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates&&(e={...e,...this._fastUpdates.materialParameters}),this._materials[0]=new ma(e,t),e.isFocused=!1;let n=this.view.map?.focusAreas.style;return e.color=vs(e.color,n),e.outlineColor=vs(e.outlineColor,n),this._materials[1]=new ma(e,t),this._materials[0]}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,useVisibilityPixel:!1,hasSlicePlane:!1,shaderPolygonOffset:0,draped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._patchTask=Ae(this._patchTask),this._materials.length=0,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(e=>this._context.stage.removeTexture(e)),this._cimSymbolTextures.clear(),this._textureHandle=a(this._textureHandle)}_getScaleFactor({size:e},t){if(!this._drivenProperties.size)return 1;if(e==null)return this._getFallbackSize();let[n,r,i]=e;return n===`symbol-value`?1:typeof n==`number`&&isFinite(n)?N(n)/t:typeof i==`number`&&isFinite(i)?N(i)/t:1}_getDrivenRotation(e){return this._drivenProperties.rotation?e.heading??0:0}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let n=Va(t.geometry);if(n==null)return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;let r,i=[0,0],a=this.view.focusAreasView?.containsGeometry(n)??!0;if(this._cimData){if(!this._cimData.symbol)return null;let n=this._generateTextureCIM(t,e),o={textureId:n.id,isFocused:a,...this._cimMaterialParametersInfo};r=this._createMaterial(o);let s=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;i=[n.parameters.width/s,n.parameters.height/s]}else i=this._size,r=a?this._materials[0]:this._materials[1];if(n==null)return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;let o=e.renderingInfo,s=this._getDrivenUInt8Color(o,this._materialColor,this._getPrimitive()==null),c=this._getDrivenRotation(o),l=1;if(!this._fastUpdates?.visualVariables.size){let e=i[0]>i[1]?i[0]:i[1];l=this._getScaleFactor(o,e)}l*=this._symbolTextureRatio;let u=T(i[0]*l,i[1]*l),d=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus(d.mode===`on-the-ground`)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,n,r,s,c,u):this._createAs3DShape(t,n,r,s,c,u,d,t.uid)}terrainTransparencyChanged(){return this.draped}layerOpacityChanged(){let e=this._getFillColor(),t=this._getOutlineColor();this._forEachMaterial(n=>{n.setParameters({color:e}),n.setParameters({outlineColor:t})})}layerScreenSizePerspectiveChanged(){let e=this._context.screenSizePerspectiveEnabled&&!this.draped?this.view.screenSizePerspective.parameters:null;this._forEachMaterial(t=>{t.setParameters({screenSizePerspective:e})})}updateGeometry(e,t){let n=e.geometry;if(this.draped||!n||!this._validateGeometry(n))return!1;let{elevationContext:r,stageObject:i}=t;if(r.mode!==this.getGeometryElevationMode(n))return!1;let a=Va(n);if(!a)return!1;r.updateFeatureExpressionFeature(e,this._context.layer);let o=Ea(i,this._context,a,r);if(o==null)return!1;let s=za(this._context,a);return i.geometries[0].localOrigin===s&&(t.alignedSampledElevation=o,Ia(t,a,this._context.elevationProvider),!0)}layerElevationInfoChanged(e,t,n){let i=this._elevationContext.mode,a=di(r.elevationModeChangeTypes,n,i);if(a!==1)return a;let o=li(i)||i===`absolute-height`;return this.updateGraphics3DGraphicElevationInfo(e,t,()=>o)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return this._getPrimitive()!=null}applyRendererDiff(e,t){for(let n in e.diff){if(n!==`visualVariables`||!Zi(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return 0;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return 2}get needsUpdateFocus(){return!0}prepareSymbolLayerPatch(e){if(this._patchTask?.abort(),e.diff.type!==`partial`)return;let t=e.diff.diff;this._preparePatchResource(e,t),this._preparePatchRotation(e,t)}_preparePatchResource(e,t){if(!t.resource||t.resource.type!==`partial`)return;let r=t.resource.diff;if(r?.href?.type!==`complete`)return;let i=r.href.newValue,{textures:o}=this._context.sharedResources;if(i==null||o==null||As(i)!=null)return;let s=this._getIconSize(),c=s*this._context.graphicsCoreOwner.view.state.pixelRatio;e.symbolLayerStatePatches.push(()=>{this._patchTask=Ae(this._patchTask),this._patchTask=ke(e=>this._context.schedule(async(e,t)=>{let r=await an(o.fromUrl(i,c,{signal:t}));Ft(t);let l=!r.ok;if(l&&Gt(r.error),this._textureHandle=a(this._textureHandle),this._patchTask=null,l){this._forEachMaterial(e=>{e.visible=!1,e.setParameters({textureId:null})});let e=`Failed to load (Request for icon resource failed: ${i})`;this.logger.error(new n(`graphics3diconsymbollayer:request-failed`,e));return}this._textureHandle=r.value;let u=r.value.managedTexture;this._size=Ms(u,s),this._forEachMaterial(e=>{e.setParameters({textureId:u.id}),e.visible=!0})},e))}),delete r.href}_preparePatchRotation(e,t){if(!t.angle||t.angle.type!==`complete`)return;let n=t.angle.newValue??0,r=n!==0||this._drivenProperties.rotation;e.symbolLayerStatePatches.push(()=>{this._forEachMaterial(e=>e.setParameters({rotation:n,hasRotation:r}))}),delete t.angle}_defaultElevationInfoNoZ(){return Fs}_createAs3DShape(e,t,n,r,i,a,o,s){let c=this.getFastUpdateAttrValues(e),l=this._context.layerViewUid,u=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerViewUid:l}),d=da(n,{normal:Cs,color:r,rotation:i,size:a,centerOffsetAndDistance:Is,featureAttribute:c,olidColor:u}),f=ja(this._context,t,d,o,s);if(f==null)return null;let p=new Ha(this,f.object,null,Aa,o);return p.hiddenIfDeconflicted=!0,p.alignedSampledElevation=f.sampledElevation,p.needsElevationUpdates=li(o.mode)||o.mode===`absolute-height`,p.getScreenSize=this._createScreenSizeGetter(a,c),p.calculateRelativeScreenBounds=e=>n.calculateRelativeScreenBounds(p.getScreenSize(),1,e),Ia(p,t,this._context.elevationProvider),p}_createAsOverlay(e,t,n,r,i,a){n.renderPriority=this._renderPriority;let o=z();Pn(t,o,this._context.overlaySR),o[2]=-2;let s=this._context.clippingExtent;if(s!=null&&!$t(s,o))return null;let c=this.getFastUpdateAttrValues(e),l=e.uid,u=this._context.layerViewUid,d=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:l,layerViewUid:u}),f=da(n,{normal:Cs,position:o,color:r,rotation:i,size:a,featureAttribute:c,olidColor:d}),p=new ji(f,{layerViewUid:u,graphicUid:l}),m=new ys(this,[p],null,this._context.drapeSourceRenderer);return m.getScreenSize=this._createScreenSizeGetter(a,c),m.calculateRelativeScreenBounds=e=>n.calculateRelativeScreenBounds(m.getScreenSize(),1,e),m}_createScreenSizeGetter(e,t){let n=this._outlineSize+2;if(this._fastUpdates&&t){let r=e[0]/this._symbolTextureRatio,i=e[1]/this._symbolTextureRatio;return(e=M())=>{let[a,o]=Qi(Ls,this._fastUpdates.materialParameters,t);return e[0]=a*r+n,e[1]=o*i+n,e}}let r=e[0]/this._symbolTextureRatio+n,i=e[1]/this._symbolTextureRatio+n;return(e=M())=>(e[0]=r,e[1]=i,e)}_fastVisualVariableConvertOptions(){let e=Math.max(this._size[0],this._size[1]),t=tn(e,e,e),n=ct(1),r=e*n,i=tn(r,r,r),a=this._getFallbackSize();return new Wi({supports:{size:!0,color:!0,rotation:!0,opacity:!1},modelSize:t,symbolSize:i,unitInMeters:n,fallbackColor:this._fastVisualVariableFallbackColor,fallbackSize:tn(a,a,a)})}_forEachMaterial(e){this._materials.forEach(e),this._cimSymbolMaterials.forEach(e)}test(){return{...super.test(),material:this._materials[0]}}};function Os(e){return e&&e.type===`point-3d`&&e.hasVisibleVerticalOffset()}function ks(e){return e!=null&&(e===`cross`||e===`x`)}function As(e){let t=Rt(e);return t?.mediaType===`application/json`?t.data:void 0}function js(e,t){return e===`relative`?T((t.x||0)+.5,.5-(t.y||0)):e in _o?_o[e]:_o.center}function Ms({parameters:e},t){let n=(e.width??1)/(e.height??1);return n>1?[t,Math.round(t/n)]:[Math.round(t*n),t]}function Ns(e){return e.resource?.href?null:e.resource?.primitive??`circle`}function Ps(e){return(e.material?.color?.a??0)===1&&Ns(e)!=null}var Fs={mode:`relative-to-ground`,offset:0},Is=Se(0,0,0,1),Ls=z();function Rs(e){switch(e){case`butt`:return 0;case`square`:return 1;case`round`:return 2;default:return null}}function zs(e){return e===`diamond`?`kite`:e}var Bs=class extends vi{constructor(e,n){super(e,n,Ei(Vs(n))),this.shader=new xi(vo,()=>t(()=>import(`./LineMarker.glsl-a5PO1dFw.js`),__vite__mapDeps([18,19,20,2,3,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52])))}_makePipelineState(e,t){let{output:n,hasEmission:r,oitPass:i,space:a,hasOccludees:o}=e;return Or({blending:V(n)?Rr(i):null,depthTest:a===0?null:Pr(i),depthWrite:jr(e),drawBuffers:yi(n,Br(i,r)),colorWrite:Tr,stencilWrite:o?ei:null,stencilTest:o?t?Xr:Hr:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(e){return e.occluder?(this._occluderPipelineTransparent=Or({blending:Ar,depthTest:Wr,depthWrite:null,colorWrite:Tr,stencilWrite:null,stencilTest:qr}),this._occluderPipelineOpaque=Or({blending:Ar,depthTest:Wr,depthWrite:null,colorWrite:Tr,stencilWrite:Ur,stencilTest:Jr}),this._occluderPipelineMaskWrite=Or({blending:null,depthTest:Qr,depthWrite:null,colorWrite:null,stencilWrite:ei,stencilTest:Xr})):this._occluderPipelineTransparent=this._occluderPipelineOpaque=this._occluderPipelineMaskWrite=null,this._occludeePipelineState=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){return t?this._occludeePipelineState:e.occluder===12?this._occluderPipelineTransparent??super.getPipeline(e):e.occluder===11?this._occluderPipelineOpaque??super.getPipeline(e):this._occluderPipelineMaskWrite??super.getPipeline(e)}};function Vs(e){let t=Ci().vec3f(`position`).vec4f16(`previousDelta`).vec2f16(`uv0`);return e.hasVVColor?t.f32(`colorFeatureAttribute`):t.vec4u8(`color`,{glNormalized:!0}),e.hasVVOpacity&&t.f32(`opacityFeatureAttribute`),e.hasVVSize?t.f32(`sizeFeatureAttribute`):t.f16(`size`),e.worldSpace&&t.vec3f16(`normal`),t.freeze()}Bs=F([Fe(`esri.views.3d.webgl-engine.shaders.LineMarkerTechnique`)],Bs);var G=class extends Lr{constructor(e){super(),this.spherical=e,this.space=1,this.anchor=0,this.occluder=!1,this.writeDepth=!1,this.hideOnShortSegments=!1,this.hasCap=!1,this.hasTip=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasScreenSizePerspective=!1,this.textureCoordinateType=0,this.emissionSource=0,this.discardInvisibleFragments=!0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasSliceTranslatedView=!0,this.olidColorInstanced=!1,this.overlayEnabled=!1,this.snowCover=!1}get draped(){return this.space===0}get worldSpace(){return this.space===2}};F([H({count:3})],G.prototype,`space`,void 0),F([H({count:2})],G.prototype,`anchor`,void 0),F([H()],G.prototype,`occluder`,void 0),F([H()],G.prototype,`writeDepth`,void 0),F([H()],G.prototype,`hideOnShortSegments`,void 0),F([H()],G.prototype,`hasCap`,void 0),F([H()],G.prototype,`hasTip`,void 0),F([H()],G.prototype,`hasVVSize`,void 0),F([H()],G.prototype,`hasVVColor`,void 0),F([H()],G.prototype,`hasVVOpacity`,void 0),F([H()],G.prototype,`hasOccludees`,void 0),F([H()],G.prototype,`terrainDepthTest`,void 0),F([H()],G.prototype,`cullAboveTerrain`,void 0),F([H()],G.prototype,`hasScreenSizePerspective`,void 0);var Hs=class extends Nr{constructor(e,t){super(e,Ws),this.produces=new Map([[2,e=>e===8||V(e)&&this.parameters.renderOccluded===8],[3,e=>tr(e)],[11,e=>or(e)&&this.parameters.renderOccluded===8],[12,e=>or(e)&&this.parameters.renderOccluded===8],[4,e=>V(e)&&this.parameters.writeDepth],[9,e=>V(e)&&!this.parameters.writeDepth],[19,e=>V(e)||e===8]]),this.intersectDraped=void 0,this._configuration=new G(t)}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.space=t.slot===19?0:this.parameters.worldSpace?2:1,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==0,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=t.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.occluder=this.parameters.renderOccluded===8,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest&&V(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration}get visible(){return this.parameters.color[3]>=$i}intersect(){}createBufferWriter(){return new Gs(Vs(this.parameters),this.parameters)}createGLMaterial(e){return new Us(e)}},Us=class extends ir{dispose(){super.dispose(),this._markerTextures?.release(this._markerPrimitive),this._markerPrimitive=null}beginSlot(e){let t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextures.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this.getTechnique(Bs,e)}},Ws=class extends Ji{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive=`arrow`,this.placement=`end`,this.cap=0,this.anchor=0,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.stipplePattern=null,this.markerTexture=null}},Gs=class{constructor(e,t){this.layout=e,this._parameters=t}elementCount(){return this._parameters.placement===`begin-end`?12:6}write(e,t,n,r,i,a){let o=n.get(`position`).data,s=o.length/3,c=[1,0,0],l=n.get(`normal`);this._parameters.worldSpace&&l!=null&&(c=l.data);let u=1,d=0;this._parameters.vvSize?d=n.get(`sizeFeatureAttribute`).data[0]:n.has(`size`)&&(u=n.get(`size`).data[0]);let f=[1,1,1,1],p=0;this._parameters.vvColor?p=n.get(`colorFeatureAttribute`).data[0]:n.has(`color`)&&(f=n.get(`color`).data);let m=0;this._parameters.vvOpacity&&(m=n.get(`opacityFeatureAttribute`).data[0]);let h=new Float32Array(i.buffer),g=In(i.buffer),_=new Uint8Array(i.buffer),v=a*(this.layout.stride/4),y=h.BYTES_PER_ELEMENT/g.BYTES_PER_ELEMENT,b=4/y,x=(e,t,n,r)=>{h[v++]=e[0],h[v++]=e[1],h[v++]=e[2],zr(t,e,g,v*y),v+=b;let i=v*y;if(g[i++]=n[0],g[i++]=n[1],v=Math.ceil(i/y),this._parameters.vvColor)h[v++]=p;else{let e=Math.min(4*r,f.length-4),t=4*v++;_[t]=255*f[e],_[t+1]=255*f[e+1],_[t+2]=255*f[e+2],_[t+3]=255*f[e+3]}this._parameters.vvOpacity&&(h[v++]=m),i=v*y,this._parameters.vvSize?(h[v++]=d,i+=2):g[i++]=u,this._parameters.worldSpace&&(g[i++]=c[0],g[i++]=c[1],g[i++]=c[2]),v=Math.ceil(i/y)},S=(t,n)=>{let r=A(Ks,o[3*t],o[3*t+1],o[3*t+2]),i=qs,a=t+n;do A(i,o[3*a],o[3*a+1],o[3*a+2]),a+=n;while(Xt(r,i)&&a>=0&&a<s);e&&(P(r,r,e),P(i,i,e)),x(r,i,[-1,-1],t),x(r,i,[1,-1],t),x(r,i,[1,1],t),x(r,i,[-1,-1],t),x(r,i,[1,1],t),x(r,i,[-1,1],t)},C=this._parameters.placement;return C!==`begin`&&C!==`begin-end`||S(0,1),C!==`end`&&C!==`begin-end`||S(s-1,-1),null}},Ks=z(),qs=z(),Js=[`polyline`,`polygon`,`extent`],Ys=class e extends Ba{static{this.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,n,r){super(e,t,n,r,Qs(t))}async doLoad(){if(this._fastUpdates=Xi(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastMarkerUpdates=Xi(this._context.renderer,this._fastVisualVariableConvertOptions(!0)),!this._drivenProperties.size&&(this.symbolLayer.size==null?ct(1):this.symbolLayer.size)<0)throw new n(`graphics3dlinesymbollayer:invalid-size`,`Symbol sizes may not be negative values`)}_getMaterialParameters(e,t){let n=this._screenSizePerspective,r={...this._getMaterialColorParameters(t),width:this._computeMaterialWidth(this.symbolLayer?.size),hasPolygonOffset:!0,join:this.symbolLayer.join||`miter`,cap:Rs(this.symbolLayer.cap||`butt`),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:Li(this.symbolLayer.pattern),emissiveStrength:this._emissiveStrength??0,screenSizePerspective:n};return t===4&&this._fastMarkerUpdates?.visualVariables?{...r,...this._fastMarkerUpdates.materialParameters}:this._fastUpdates?.visualVariables?{...r,...this._fastUpdates.materialParameters}:r}_getMaterialColorParameters(e){let t=e===4,n=this._getCombinedOpacityAndColor(t&&this._markerColor||this._materialColor);return this._patternHidesLine&&!t&&(n[3]=0),{color:n}}get _materialColor(){return this.symbolLayer.material?.color}get _emissiveStrength(){return this.symbolLayer.material?.emissive?.strength}get _markerColor(){return this.symbolLayer.marker?.color}get _lineMaterial(){return this._materials[0]??(this._materials[0]=new ii(this._getMaterialParameters(!1,0),this.view.state.isGlobal)),this._materials[0]}get _ringMaterial(){return this._materials[1]??(this._materials[1]=new ii(this._getMaterialParameters(!0,1),this.view.state.isGlobal)),this._materials[1]}get _wireframeLineMaterial(){return this._materials[2]??(this._materials[2]=new ii({...this._getMaterialParameters(!1,2),wireframe:!0},this.view.state.isGlobal)),this._materials[2]}get _wireframeRingMaterial(){return this._materials[3]??(this._materials[3]=new ii({...this._getMaterialParameters(!0,3),wireframe:!0},this.view.state.isGlobal)),this._materials[3]}get _markerMaterial(){return this._materials[4]==null&&this.symbolLayer.marker!=null&&(this._materials[4]=new Hs({...this._getMaterialParameters(!1,4),placement:this.symbolLayer.marker.placement,markerPrimitive:zs(this.symbolLayer.marker.style)},this.view.state.isGlobal)),this._materials[4]}_getDrivenSize(e){if(this._drivenProperties.size){let t=e.size;return t==null?this._getFallbackSize():N(Na(t))}return 1}_getDrivenColor({color:e,opacity:t}){let n=Ve();return this._drivenProperties.color&&(Nt(n,e??this._getFallbackOpacityAndColor(D)),t==null)||this._drivenProperties.opacity&&(e||this._materialColor)&&(n[3]=t??this._getFallbackOpacity()),n}_getDrivenMarkerColor({color:e,opacity:t}){let n=Ve();return this._drivenProperties.color&&(Nt(n,e??this._getFallbackMarkerOpacityAndColor(D)),t==null)||this._drivenProperties.opacity&&(e||this._markerColor||this._materialColor)&&(n[3]=t??this._getFallbackMarkerOpacity()),n}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,Js,this.symbolLayer.type))return null;let n=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus(n.mode===`on-the-ground`),this.draped?this._createAsOverlay(e):this._createAs3DShape(e,n,t.uid)}applyRendererDiff(e,t){for(let n in e.diff){if(n!==`visualVariables`)return 0;{let e=this._fastUpdates;if(!Zi(e,t,this._fastVisualVariableConvertOptions()))return 0;for(let t of this._materials)t instanceof ii&&t.setParameters(e.materialParameters);let n=this._fastMarkerUpdates;if(!Zi(n,t,this._fastVisualVariableConvertOptions(!0)))return 0;for(let e of this._materials)e instanceof Hs&&e.setParameters(n.materialParameters)}}return 2}prepareSymbolLayerPatch(e){if(e.diff.type!==`partial`)return;let t=e.diff.diff,n={};t.size?.type===`complete`&&(n.width=this._computeMaterialWidth(t.size.newValue),delete t.size),t.cap?.type===`complete`&&(n.cap=Rs(t.cap.newValue??`butt`),delete t.cap);let r=this._prepareMarkerPatch(e,t);this._prepareMaterialPatch(e,t,r),e.symbolLayerStatePatches.push(()=>{for(let e of this._materials)e?.setParameters(n)})}layerOpacityChanged(){for(let e=0;e<5;e++)this._materials[e]?.setParameters(this._getMaterialColorParameters(e))}get _screenSizePerspective(){return!this.draped&&this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null}layerScreenSizePerspectiveChanged(){let e=this._screenSizePerspective;for(let t of this._materials)t?.setParameters({screenSizePerspective:e})}layerElevationInfoChanged(t,n,r){let i=this._elevationContext.mode,a=di(e.elevationModeChangeTypes,r,i);if(a!==1)return a;let o=li(i);return this.updateGraphics3DGraphicElevationInfo(t,n,()=>o)}slicePlaneEnabledChanged(){let e={hasSlicePlane:this._context.slicePlaneEnabled};for(let t of this._materials)t?.setParameters(e);return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,n){let r=Xs(e.graphic.geometry),i=r.type===`polygon`?r.rings:r.paths,a=[],s=o(),c=Ai(r,this._context.elevationProvider,this._context.renderCoordsHelper,t),l=r.type===`polygon`?`rings`:`paths`;this._logGeometryCreationWarnings(c,i,l,`LineSymbol3DLayer`);for(let t=0;t<c.lines.length;t++){let i=c.lines[t],o=i.position,l=i.mapPositions;if(this._context.clippingExtent!=null&&(ve(l,s),!at(s,this._context.clippingExtent)))continue;let u=this._createGeometry(r.type===`polygon`?this._ringMaterial:this._lineMaterial,e,o,l,r.type,1,n);if(a.push(u),qi.LINE_WIREFRAMES&&a.push(u.instantiate({material:r.type===`polygon`?this._wireframeRingMaterial:this._wireframeLineMaterial})),this._markerMaterial!=null){let t=u.instantiate({material:this._markerMaterial});t.attributes.has(`color`)&&t.setAttributeData(`color`,this._getDrivenMarkerColor(e.renderingInfo)),a.push(t)}}if(a.length===0)return null;let u=this._context.layerViewUid,d=new mi({geometries:a,castShadow:!1,layerViewUid:u,graphicUid:n}),f=new Ha(this,d,null,Oa,t);return f.alignedSampledElevation=c.sampledElevation,f.needsElevationUpdates=li(t.mode),f}_createGeometry(e,t,n,r,i,a,o){let s=a===0?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,c=i===`polygon`,l=this._fastUpdates?.visualVariables.color,u=this._fastUpdates?.visualVariables.size,d=this._fastUpdates?.visualVariables.opacity,f=this._context.layerViewUid,p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:o,layerViewUid:f}),m={position:n,size:u?null:this._getDrivenSize(t.renderingInfo),color:l?null:this._getDrivenColor(t.renderingInfo),sizeFeature:u?Yi(u.field,t.graphic):null,colorFeature:l?Yi(l.field,t.graphic):null,opacityFeature:d?Yi(d.field,t.graphic):null};return sa(e,{overlayInfo:s,removeDuplicateStartEnd:c,mapPositions:r,attributeData:m},p)}_createAsOverlay(e){let t=e.graphic,n=Xs(t.geometry),r=n.type===`polygon`?n.rings:n.paths,i=n.type===`polygon`?this._ringMaterial:this._lineMaterial;i.renderPriority=this._renderPriority;let a=qi.LINE_WIREFRAMES?n.type===`polygon`?this._wireframeRingMaterial:this._wireframeLineMaterial:null,s=this._markerMaterial;a!=null&&(a.renderPriority=this._renderPriority-.001),s!=null&&(s.renderPriority=this._renderPriority-.002);let c=[],l=o(),u=ln(),d=Vi(n,this._context.overlaySR),f=n.type===`polygon`?`rings`:`paths`;this._logGeometryCreationWarnings(d,r,f,`LineSymbol3DLayer`);for(let r of d.lines){if(ve(r.position,l),!at(l,this._context.clippingExtent))continue;_t(u,l);let o=this._createGeometry(i,e,r.position,void 0,n.type,0,t.uid),d=e=>{let n=this._context.layerViewUid,r=new ji(e,{layerViewUid:n,graphicUid:t.uid});c.push(r)};if(s!=null){let t=o.instantiate({material:s});t.attributes.has(`color`)&&t.setAttributeData(`color`,this._getDrivenMarkerColor(e.renderingInfo)),d(t);let n=this.symbolLayer.marker.placement;n!==`begin`&&n!==`begin-end`||ht(l,r.position,0,1),n!==`end`&&n!==`begin-end`||ht(l,r.position,r.position.length-3,1)}d(o),qi.LINE_WIREFRAMES&&d(o.instantiate({material:a}))}return new ys(this,c,u,this._context.drapeSourceRenderer)}get _patternHidesLine(){let e=this.symbolLayer.pattern;return e!=null&&e.type===`style`&&e.style===`none`}_computeMaterialWidth(e){return e??=ct(1),this._drivenProperties.size?this._fastUpdates?.visualVariables.size?N(1):1:N(e)}_prepareMaterialPatch(e,t,n){let r=t.material;if(r==null)return void(n.changed&&n.useMaterialColor&&Zs(this._getCombinedOpacityAndColor(this._materialColor),this._materials[4],e));if(r.type===`collection`)return;let i=r.type===`complete`?r.newValue?.color:r.diff.color?.type===`complete`?r.diff.color.newValue:null,a=this._getCombinedOpacityAndColor(i);n.useMaterialColor&&Zs(dt(a),this._materials[4],e),this._patternHidesLine&&(a[3]=0),Zs(a,this._materials[0],e),delete t.material}_prepareMarkerPatch(e,t){let n=t.marker,r=this._markerMaterial;if(n==null||n.type!==`partial`||n.diff==null||n.diff.placement!=null||n.diff.style!=null&&n.diff.style.type!==`complete`||n.diff.color!=null&&n.diff.color.type!==`complete`||r==null)return{changed:!1,useMaterialColor:this._markerColor==null};let i=n.diff.color,a=i!=null,o=a?i.newValue:null,s=o==null&&this._markerColor==null;o&&Zs(this._getCombinedOpacityAndColor(o),r,e);let c=n.diff.style?.newValue;return c&&e.symbolLayerStatePatches.push(()=>r.setParameters({markerPrimitive:zs(c)})),delete t.marker,{changed:a,useMaterialColor:s}}_fastVisualVariableConvertOptions(e=!1){let t=this._getFallbackSize();return new Wi({supports:{size:!0,color:!0,rotation:!1,opacity:!0},fallbackColor:e?this._getFallbackMarkerOpacityAndColor(La):this._getFallbackOpacityAndColor(La),fallbackSize:tn(t,t,t)})}_getFallbackOpacityAndColor(e){return this._materialColor?.toUnitRGBA()??e}_getFallbackOpacity(){return this._materialColor?.a??0}_getFallbackMarkerOpacityAndColor(e){return this.symbolLayer?.marker?.color?.toUnitRGBA()??this._getFallbackOpacityAndColor(e)}_getFallbackMarkerOpacity(){return this.symbolLayer?.marker?.color?.a??this._getFallbackOpacity()}_getFallbackSize(){let e=this.symbolLayer?.size;return e==null?1:N(e)}};function Xs(e){switch(e.type){case`extent`:if(e instanceof Zt)return m.fromExtent(e);break;case`polygon`:case`polyline`:return e}return null}function Zs(e,t,n){t!=null&&n.symbolLayerStatePatches.push(()=>t.setParameters({color:e}))}function Qs(e){let t=e.material?.color,n=e.marker?.color??t;return(t?.a??0)===1&&(n?.a??0)===1}var $s={disableDelayMs:2e3},ec=class extends Ha{constructor(){super(...arguments),this.fastTransformUpdatesAllowed=!1,this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1,this._autoDisableFastUpdatesTimeoutId=0}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}destroy(){super.destroy(),this._cancelAutoDisableFastUpdates()}enableFastTransformUpdates(e,t){if(!this.fastTransformUpdatesAllowed||this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!0;let{stageObject:n}=this,r=n.geometries.slice();n.removeAllGeometries();let i=s(tc,n.transformation),a=t.getOrigin(i);for(let t of r){let r=e(t.material),i=t.instantiate({material:r});i.localOrigin=a,n.addGeometry(i)}this._originalGeometries=r}autoDisableFastTransformUpdates(e){this._cancelAutoDisableFastUpdates(),this._autoDisableFastUpdatesTimeoutId=setTimeout(()=>{this._autoDisableFastUpdatesTimeoutId=0,e()},$s.disableDelayMs)}updateAutoDisableFastTransformUpdates(e){this._autoDisableFastUpdatesTimeoutId&&this.autoDisableFastTransformUpdates(e)}_cancelAutoDisableFastUpdates(){clearTimeout(this._autoDisableFastUpdatesTimeoutId),this._autoDisableFastUpdatesTimeoutId=0}disableFastTransformUpdates(e){if(!this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!1;let{stageObject:t}=this,n=t.geometries.map(t=>e(t.material));t.removeAllGeometries();for(let e=0;e<this._originalGeometries.length;e++){let r=this._originalGeometries[e],i=n[e];i.setParameters({modelTransformation:null}),i===r.material?t.addGeometry(r):t.addGeometry(r.instantiate({material:i}))}this._originalGeometries.length=0}updateFastLocalOrigin(e,t,n){if(!this._fastTransformUpdatesEnabled)return;let{stageObject:r}=this;if(r.geometries.length===0)return;let i=r.geometries[0].localOrigin,a=s(tc,e),o=n.getOrigin(a);if(o===i)return;let c=t?.localMatrix??He;r.shaderTransformation=null,r.transformation=e,r.geometries.forEach(e=>{e.transformation=c,e.localOrigin=o})}updateTransform(e,t,n){let{stageObject:r}=this,i=t?.localMatrix??He;if(!this._fastTransformUpdatesEnabled)return r.shaderTransformation=null,r.transformation=e,r.geometries.forEach(e=>e.transformation=i),void this._updateEdgeTransform(n);let a=r.transformation,o=r.geometries[0].transformation,s=e,c=i,l=De(nc,a,o),u=De(rc,s,c);r.shaderTransformation=De(ac,u,Pe(ac,o)),this._setFastMaterialTransformation({matA:l,matB:u}),this._updateEdgeTransform(n)}alignWithElevation(e,t,n){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(e,t,n);let r=(n,r)=>ai(n,e,this.elevationContext,t,r),{stageObject:i}=this;if(!i.geometries[0].material.parameters.modelTransformation)return;let a=i.transformation,o=i.geometries[0].transformation,s=De(nc,a,o),c=i.effectiveTransformation,l=oe(ic,c);this.alignedSampledElevation=Aa(this,this.elevationContext,e.spatialReference,r,t,l),i.shaderTransformation=l;let u=i.geometries[0].transformation,d=De(rc,l,u);this._setFastMaterialTransformation({matA:s,matB:d}),this._updateEdgeTransform(n)}_setFastMaterialTransformation({matA:e,matB:t}){let{stageObject:n}=this;if(n.geometries.length===0)return;let r=n.geometries[0].localOrigin,i=Xe(cc,k(tc,r.vec3,-1)),a=De(oc,i,e),o=De(sc,i,t),s=Pe(oc,a),c=De(sc,o,s);for(let e of n.geometries)e.material.setParameters({modelTransformation:c})}_updateEdgeTransform(e){let{stageObject:t,_stageLayer:n}=this;n.stage.renderer.withEdgeView(n=>{n.fastUpdateObject3DEdgesTransform(t)||this.resetEdgeObject(e)})}},tc=z(),nc=O(),rc=O(),ic=O(),ac=O(),oc=O(),sc=O(),cc=O(),lc=class{constructor(){this._fastTransformOriginalMaterials=new Map,this._fastTransformClonedMaterials=new Map,this._graphicReferenceCount=0}enable(e,t,n){e.enableFastTransformUpdates(e=>{if(this._graphicReferenceCount<=1){if(this._fastTransformOriginalMaterials.has(e))return e;let n=t.byMaterial(e);return this._fastTransformOriginalMaterials.set(e,n),t.delete(e),e}let r=new Qa(e.parameters,n);return this._fastTransformClonedMaterials.set(r,e),r},n.localOriginFactory)}disable(e,t){let n=new Set,r=new Set;e.disableFastTransformUpdates(e=>{if(!this._fastTransformClonedMaterials.has(e)){let i=e,a=this._fastTransformOriginalMaterials.get(i);return t.has(a.uid)?(n.add(i),t.byUid(a.uid).material):(r.add(i),a.material)}let i=e,a=this._fastTransformClonedMaterials.get(i);return this._fastTransformClonedMaterials.delete(i),a});for(let e of n)this._fastTransformOriginalMaterials.delete(e);for(let e of r){let n=this._fastTransformOriginalMaterials.get(e);this._fastTransformOriginalMaterials.delete(e),t.set(n.uid,n)}}onAddGraphic(){this._graphicReferenceCount++}onRemoveGraphic(e,t){this._graphicReferenceCount--,this.disable(e,t)}forEachMaterialInfo(e){this._fastTransformOriginalMaterials.forEach(e)}forEachClonedMaterial(e){this._fastTransformClonedMaterials.forEach(e)}destroy(){this._fastTransformClonedMaterials.clear(),this._fastTransformOriginalMaterials.clear()}},uc=class{constructor(){this._byUid=new Map,this._byMaterial=new Map}get materials(){return Array.from(this._byUid.values(),e=>e.material)}byUid(e){return this._byUid.get(e)}byMaterial(e){return this._byMaterial.get(e)}set(e,t){this._byUid.set(e,t),this._byMaterial.set(t.material,t)}delete(e){let t=this._byMaterial.get(e)?.uid;t&&(this._byUid.delete(t),this._byMaterial.delete(e))}has(e){return this._byUid.has(e)}forEachMaterialInfo(e){this._byUid.forEach(e)}clear(){this._byUid.clear(),this._byMaterial.clear()}},dc=class extends vi{constructor(e,n){super(e,n,n.hasVertexColors?Ni:zi),this.shader=new xi(xo,()=>t(()=>import(`./NativeLine.glsl-B3TW3wR-.js`),__vite__mapDeps([53,54,55,2,3,41,23,35,27,22,38,34,56,32,33,36,30,44,45,29,37,46,43,25,26,28,47]))),this.primitiveType=me.LINES}initializePipeline(e){let{hasOccludees:t,output:n,hasEmission:r,transparent:i,oitPass:a}=e,o=(e,n=null,i=null)=>Or({blending:n,depthTest:Qr,depthWrite:i,colorWrite:Tr,stencilWrite:t?ei:null,stencilTest:t?e?Xr:Hr:null,drawBuffers:Br(a,r)});return V(n)?(this._occludeePipeline=o(!0,i?Ar:null,Er),o(!1,i?Ar:null,Er)):o(!1)}getPipeline(e,t){return t?this._occludeePipeline:super.getPipeline(e)}};dc=F([Fe(`esri.views.3d.webgl-engine.shaders.NativeLineTechnique`)],dc);var fc=class extends Lr{constructor(){super(...arguments),this.hasVertexColors=!1,this.transparent=!1,this.hasOccludees=!1,this.writeDepth=!0,this.draped=!1,this.snowCover=!1,this.emissionSource=0,this.textureCoordinateType=0}get discardInvisibleFragments(){return this.transparent&&this.writeDepth}};F([H()],fc.prototype,`hasVertexColors`,void 0),F([H()],fc.prototype,`transparent`,void 0),F([H()],fc.prototype,`hasOccludees`,void 0),F([H()],fc.prototype,`writeDepth`,void 0);var pc=class extends Nr{constructor(e){super(e,hc),this._configuration=new fc,this.produces=new Map([[2,e=>sr(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.hasOccludees=t.hasOccludees,this._configuration}get visible(){return this.parameters.color[3]>=$i}intersect(e,t,n,r,i,a){let{options:o,camera:s,rayBegin:c,rayEnd:l}=n;if(!o.selectionMode||!e.visible||!s)return;if(!Bn(t))return void h.getLogger(`esri.views.3d.webgl-engine.materials.NativeLineMaterial`).error(`intersection assumes a translation-only matrix`);let u=e.attributes.get(`position`).data,d=wc;Ee(d,n.point),A(Tc[0],d[0]-2,d[1]+2,0),A(Tc[1],d[0]+2,d[1]+2,0),A(Tc[2],d[0]+2,d[1]-2,0),A(Tc[3],d[0]-2,d[1]-2,0);for(let e=0;e<4;e++)if(!s.unprojectFromRenderScreen(Tc[e],Ec[e]))return;An(s.eye,Ec[0],Ec[1],Dc),An(s.eye,Ec[1],Ec[2],Oc),An(s.eye,Ec[2],Ec[3],kc),An(s.eye,Ec[3],Ec[0],Ac);let f=Number.MAX_VALUE,p=0;for(let e=0;e<u.length-5;e+=3){if(K[0]=u[e]+t[12],K[1]=u[e+1]+t[13],K[2]=u[e+2]+t[14],q[0]=u[e+3]+t[12],q[1]=u[e+4]+t[13],q[2]=u[e+5]+t[14],Dn(Dc,K)<0&&Dn(Dc,q)<0||Dn(Oc,K)<0&&Dn(Oc,q)<0||Dn(kc,K)<0&&Dn(kc,q)<0||Dn(Ac,K)<0&&Dn(Ac,q)<0)continue;let n=s.projectToRenderScreen(K,vc),r=s.projectToRenderScreen(q,yc);if(n==null||r==null)continue;if(n[2]<0&&r[2]>0){I(gc,K,q);let e=s.frustum,t=-Dn(e[4],K)/R(gc,En(e[4]));if(k(gc,gc,t),j(K,K,gc),!s.projectToRenderScreen(K,n))continue}else if(n[2]>0&&r[2]<0){I(gc,q,K);let e=s.frustum,t=-Dn(e[4],q)/R(gc,En(e[4]));if(k(gc,gc,t),j(q,q,gc),!s.projectToRenderScreen(q,r))continue}else if(n[2]<0&&r[2]<0)continue;n[2]=0,r[2]=0;let i=Cr(Sr(n,r,Sc),d);i<f&&(f=i,E(bc,K),E(xc,q),p=e/3)}if(f<4){let e=Number.MAX_VALUE;if(xr(Sr(bc,xc,Sc),Sr(c,l,Cc),_c)){I(_c,_c,c);let t=Ie(_c);k(_c,_c,1/t),e=t/dn(c,l)}a(e,_c,p)}}intersectDraped(e,t,n,r,i){if(!t.options.selectionMode)return;let a=e.attributes.get(`position`).data,o=e.attributes.get(`size`),s=o?o.data[0]:0,c=n[0],l=n[1],u=((s+1)/2+4)*e.screenToWorldRatio,d=Number.MAX_VALUE,f=0;for(let e=0;e<a.length-5;e+=3){let t=a[e],n=a[e+1],r=c-t,i=l-n,o=a[e+3]-t,s=a[e+4]-n,u=en((o*r+s*i)/(o*o+s*s),0,1),p=o*u-r,m=s*u-i,h=p*p+m*m;h<d&&(d=h,f=e/3)}d<u*u&&r(i.distance,i.normal,f)}createGLMaterial(e){return new mc(e)}createBufferWriter(){let e=this.parameters.hasVertexColors?Ii:Ri;return new $r(e)}},mc=class extends ir{beginSlot(e){return this.getTechnique(dc,e)}},hc=class extends Mr{constructor(){super(...arguments),this.color=e,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1}},K=z(),q=z(),gc=z(),_c=z(),vc=et(),yc=et(),bc=z(),xc=z(),Sc=br(),Cc=br(),wc=z(),Tc=[et(),et(),et(),et()],Ec=[z(),z(),z(),z()],Dc=jn(),Oc=jn(),kc=jn(),Ac=jn(),jc=[`mesh`],Mc=class extends Ba{constructor(e,t,n,r){super(e,t,n,r,Xc(t)),this._materialInfoCache=new uc,this._fastUpdateProcessor=new lc,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){qi.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new pc({color:[1,0,1,1]}),this._debugTangentNormalMaterial=new pc({color:[1,.5,0,1]}),this._debugFaceNormalMaterial=new pc({color:[0,1,1,1]})),this.updateComplexity()}destroy(){super.destroy(),this._textures.forEach(e=>e.unload()),this._context.stage.removeTextures(Array.from(this._textures.values())),this._materialInfoCache.clear(),this._textures.clear(),this._fastUpdateProcessor.destroy()}get materials(){return this._materialInfoCache.materials}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,jc,`fill on mesh-3d`))return null;let n=this.createElevationContextForGraphic(t),r=e.renderingInfo;return this._createAs3DShape(t,r,n,t.uid)}onRemoveGraphic(e){this._fastUpdateProcessor.onRemoveGraphic(e,this._materialInfoCache)}layerOpacityChanged(e,t){let n=this._getLayerOpacity();this._updateMaterialParameters(e=>{e.material.setParameters({layerOpacity:n});let t=e.material.parameters;this._setMaterialTextureAlphaMode(t,e)}),e?.forEach(e=>t(e)?.layerOpacityChanged(n,this._context.isAsync))}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,fi)}slicePlaneEnabledChanged(e,t){return this._updateMaterialParameters(({material:e})=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),e?.forEach(e=>t(e)?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)),!0}physicalBasedRenderingChanged(){let e=this._usePBR();return this._updateMaterialParameters(({material:t})=>t.setParameters({usePBR:e})),!0}updateTransform(e,t,n,r){if(!e.fastTransformUpdatesAllowed)return!1;let i=e.fastTransformUpdatesEnabled;switch(r){case 0:if(i)return!0;break;case 1:if(!i)return!0;break;default:if(!i)return!!this.updateTransform(e,t,n,0)&&(e.autoDisableFastTransformUpdates(()=>this.updateTransform(e,t,n,1)),!0)}let a=this._context.renderCoordsHelper.spatialReference,o=nl,{origin:s,transform:c}=n;if(!Fn(t,A(J,s.x,s.y,s.z??0),o,a))return!1;switch(r){case 0:this._fastUpdateProcessor.enable(e,this._materialInfoCache,this._context);break;case 1:this._fastUpdateProcessor.disable(e,this._materialInfoCache);break;case 2:e.updateFastLocalOrigin(o,c,this._context.localOriginFactory)}let{elevationContext:l}=e;l.centerInElevationSR=this._getCenterInElevationSR(o);let{elevationProvider:u,renderCoordsHelper:d}=this._context;return e.alignedSampledElevation=Aa(e,l,u.spatialReference,(e,t)=>ai(e,u,l,d,t),d,o),e.updateTransform(o,c,this._context.isAsync),e.updateAutoDisableFastTransformUpdates(()=>this.updateTransform(e,t,n,1)),!0}computeComplexity(){if(!this._textures||this._textures.size===0)return super.computeComplexity();let e=0;for(let t of this._textures.values())e+=t.usedMemory;let t={...Ta(this.symbol,this.symbolLayer),resourceBytes:e},n=Qn(this.symbolLayer)?2:0;return new ba({drawCallsPerFeature:n,memory:t})}_requiresSymbolVertexColors(){return this._hasDrivenColorOrOpacity}_materialPropertiesDefault(e,t){let n=this._requiresSymbolVertexColors(),r=!!e.vertexAttributes.color,i=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:n,hasVertexColors:r,hasVertexTangents:i,uid:`vc:${r},vt:${i},vct${t},svc:${n}`}}_materialProperties(e,t,n){let r=this._materialPropertiesDefault(e,n);if(!t.material)return r;let{color:i,colorTexture:a,colorTextureTransform:o,normalTexture:s,normalTextureTransform:c,doubleSided:l,alphaCutoff:u,alphaMode:d}=t.material,f=qc(i),p=qc(a),m=Jc(o),h=qc(s),g=Jc(c);if(r.color=i,r.colorTexture=a,r.normalTexture=s,r.uid=`${r.uid},cmuid:${f},ctmuid:${p},cttuid:${m},ntmuid:${h},nttuid:${g},ds:${l},ac:${u},am:${d}`,t.material instanceof mn){let{metallic:e,roughness:n,metallicRoughnessTexture:i,metallicRoughnessTextureTransform:a,emissiveColor:s,emissiveStrength:l,emissiveTexture:u,emissiveTextureTransform:d,occlusionTexture:f,occlusionTextureTransform:p}=t.material,m=qc(i),h=Jc(a),g=qc(s),_=qc(u),v=Jc(d),y=qc(f),b=Jc(p);r.uid=[r.uid,`mrm:${e}`,`mrr:${n}`,`mrt:${m}`,`mrtt:${h}`,`emuid:${g}`,`ems:${l}`,`etmuid:${_}`,`ett:${v}`,`otmuid:${y}`,`ott:${b}`].join(`,`),r.metallic=e,r.roughness=n,r.metallicRoughnessTexture=i,r.emissiveColor=s,r.emissiveStrength=l,r.emissiveTexture=u,r.occlusionTexture=f,r.colorTextureTransform=Vc(o),r.normalTextureTransform=Vc(c),r.emissiveTextureTransform=Vc(d),r.occlusionTextureTransform=Vc(p),r.metallicRoughnessTextureTransform=Vc(a)}return r}_getInternalTexture(e,t=!1,n=1){let r=Kc(e);if(!r)return null;let i=`${e.contentHash}/${n}`,o=this._textures.get(i);if(o){let e=this._context.stage.renderView.textures,t=null,n=e.acquire(o.id);return n==null||Te(n)||(o.events.on(`unloaded`,()=>t=a(t)),t=n),o}let s=null,c=this._context.stage.renderView.renderingContext.parameters.maxMaxAnisotropy,l={wrap:Hc(e.wrap),noUnpackFlip:!0,maxAnisotropy:c,mipmap:c>1};return Jn(r)?(s=r.data,l.preMultiplyAlpha=!1,l.encoding=r.encoding):(s=r,l.preMultiplyAlpha=n!==1,l.compressionOptions=t?{compressionTracker:this._context.compressionTracker,compressionCallback:()=>this.updateComplexity()}:void 0),o=new ta(s,l),this._textures.set(i,o),o.events.on(`loaded`,()=>this.updateComplexity()),o.load(this._context.stage.renderView.renderingContext),this._context.stage.addTexture(o),o.events.on(`unloaded`,()=>{this._textures.delete(i)}),o}_setInternalMaterialTextureParameters(e,t){if(e.colorTexture!=null){let n=t.textureAlphaMode!==1,r=this._getInternalTexture(e.colorTexture,n,t.textureAlphaMode);r?(t.textureId=r.id,t.textureAlphaPremultiplied=!!r.parameters.preMultiplyAlpha):t.textureId=void 0}if(e.normalTexture&&(t.normalTextureId=this._getInternalTexture(e.normalTexture)?.id),e.emissiveColor){let n=e.emissiveColor?.toUnitRGB();t.emissiveBaseColor=tn(vt(n[0]),vt(n[1]),vt(n[2]))}e.emissiveStrength&&(t.emissiveStrengthKHR=e.emissiveStrength),e.emissiveTexture&&(t.emissiveTextureId=this._getInternalTexture(e.emissiveTexture)?.id),e.occlusionTexture&&(t.occlusionTextureId=this._getInternalTexture(e.occlusionTexture,!0)?.id),e.metallicRoughnessTexture&&(t.metallicRoughnessTextureId=this._getInternalTexture(e.metallicRoughnessTexture,!0)?.id)}_setInternalMaterialParameters(e,t,n){e.color!=null&&Gc(e.color,t,n),this._setInternalMaterialTextureParameters(e,t),t.colorTextureTransformMatrix=bo(e.colorTextureTransform),t.normalTextureTransformMatrix=bo(e.normalTextureTransform);let r=e.normalTextureTransform?.scale==null?Re:e.normalTextureTransform?.scale;t.scale=[r[0],r[1]],t.occlusionTextureTransformMatrix=bo(e.occlusionTextureTransform),t.emissiveTextureTransformMatrix=bo(e.emissiveTextureTransform),t.metallicRoughnessTextureTransformMatrix=bo(e.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(t,n=this._materialColor){let r=this._drivenProperties.color,i=this._drivenProperties.opacity;if(r)t.externalColor=e;else{let e=n??null;if(e){let n=e.toUnitRGBA();i&&(n[3]=1),t.externalColor=n}else t.externalColor=La}t.colorMixMode=this.symbolLayer.material?.colorMixMode??`multiply`,t.castShadows=!!this.symbolLayer.castShadows,t.emissiveStrengthFromSymbol=this.symbolLayer?.material?.emissive?.strength??1,t.emissiveSource=ut(this.symbolLayer?.material?.emissive?.source??`emissive`)}_getOrCreateMaterial(e,t){let n=t.material?.color,r=t.material?.colorTexture,i=t.material?.alphaMode,a=i===`blend`,o=i!==`opaque`&&(Wc(e)||n!=null&&n.a<1||r?.transparent||a),s=this._materialProperties(e,t,o),c=this._materialInfoCache.byUid(s.uid);if(c)return this._setInternalMaterialTextureParameters(s,c.material.parameters),c.material;let l={uid:s.uid,material:null,isComponentTransparent:o,alphaMode:t.material?t.material.alphaMode:`opaque`},u=no({normalTexture:s.normalTexture,metallicRoughnessTexture:s.metallicRoughnessTexture,metallicFactor:s.metallic,roughnessFactor:s.roughness,emissiveTexture:s.emissiveTexture,emissiveFactor:s.emissiveColor?.toUnitRGB(),occlusionTexture:s.occlusionTexture}),d={usePBR:this._usePBR(),isSchematic:u,hasVertexColors:s.hasVertexColors,hasSymbolColors:s.hasSymbolVertexColors,hasVertexTangents:s.hasVertexTangents,ambient:gt,diffuse:Et,opacity:1,doubleSided:!0,doubleSidedType:`winding-order`,cullFace:0,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,drivenOpacity:this.needsDrivenTransparentPass||l.isComponentTransparent};d.mrrFactors=u?to:[s.metallic,s.roughness,ro[2]],t.material&&(d.doubleSided=t.material.doubleSided,d.cullFace=t.material.doubleSided?0:2,d.textureAlphaCutoff=t.material.alphaCutoff),this._setExternalMaterialParameters(d),this._setMaterialTextureAlphaMode(d,l),this._setInternalMaterialParameters(s,d,l);let f=new Qa(d,this._context);return l.material=f,this._materialInfoCache.set(s.uid,l),f}prepareSymbolLayerPatch(e){if(e.diff.type!==`partial`)return;let t=e.diff.diff;this._preparePatchColor(e,t)}_preparePatchColor(e,t){if(!t.material||t.material.type!==`partial`)return;let n=t.material.diff;if(!n.color||n.color.type!==`complete`||n.color.newValue==null||n.color.oldValue==null)return;let r=n.color.newValue;delete n.color,e.symbolLayerStatePatches.push(()=>{this._updateMaterialParameters(e=>{let t=e.material.parameters;this._setExternalMaterialParameters(t,r),this._setMaterialTextureAlphaMode(t,e),e.material.setParameters({externalColor:t.externalColor})})})}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTextureAlphaMode(e,t){t.alphaMode===`auto`?e.textureAlphaMode=this.needsDrivenTransparentPass||t.isComponentTransparent||(e.layerOpacity??1)<1||(e.opacity??1)<1||(e.externalColor?.[3]??1)<1?3:1:e.textureAlphaMode=t.alphaMode===`opaque`?1:t.alphaMode===`mask`?2:0}_createFaceDebugNormals(e,t){let n=t.length,r=e.spatialReference.isGeographic?20015077/180:1,i=.1*Math.max(e.extent.width*r,e.extent.height*r,e.extent.zmax-e.extent.zmin),a=[],o=[],s=t[0].transformation,c=se(Oe(),s);for(let e=0;e<n;e++){let n=t[e].attributes.get(`position`);if(!n)continue;let r=n.data,l=n.indices;for(let e=0;e<l.length;e+=3)Bc(r,l,e,el),zc(r,l,e,J,Y,$c),j(J,J,Y),j(J,J,$c),k(J,J,1/3),P(J,J,s),a.push(...J),ot(el,el,c),L(el,el),f(J,J,el,i),a.push(...J),o.push(o.length),o.push(o.length)}return a.length?new Kr(this._debugFaceNormalMaterial,[[`position`,new B(a,o,3,!0)]],null,2):null}_createPerVertexDebugVectors(e,t,n,r,i){let a=t.length,o=e.spatialReference.isGeographic?20015077/180:1,s=.1*i*Math.max(e.extent.width*o,e.extent.height*o,e.extent.zmax-e.extent.zmin),c=[],l=[],u=t[0].transformation,d=se(Oe(),u);n===`tangent`&&Ze(d,u);for(let e=0;e<a;e++){let r=t[e],i=r.attributes.get(`position`),a=r.attributes.get(n);if(!i||!a)continue;let o=i.data,p=i.indices,m=a.data,h=a.indices;for(let e=0;e<p.length;e++){let t=3*p[e],n=h[e]*a.stride;A(J,o[t+0],o[t+1],o[t+2]),P(J,J,u),c.push(...J),A(Y,m[n+0],m[n+1],m[n+2]),ot(Y,Y,d),L(Y,Y),f(J,J,Y,s),c.push(...J),l.push(l.length),l.push(l.length)}}return c.length?new Kr(r,[[`position`,new B(c,l,3,!0)]],null,2):null}_createAs3DShape(e,t,n,r){let i=e.geometry;if(i.type!==`mesh`)return null;let a=this._createGeometryInfo(i,t,r);if(a==null)return null;let{geometries:o,objectTransformation:s}=a;if(qi.DRAW_MESH_GEOMETRY_NORMALS){let e=this._createPerVertexDebugVectors(i,o,`normal`,this._debugVertexNormalMaterial,1),t=this._createPerVertexDebugVectors(i,o,`tangent`,this._debugTangentNormalMaterial,.5),n=this._createFaceDebugNormals(i,o);e&&o.push(e),t&&o.push(t),n&&o.push(n)}let c=this._context.layerViewUid,l=new mi({geometries:o,layerViewUid:c,graphicUid:r,isElevationSource:!0});l.transformation=s;let u=Zn(this.symbolLayer,{opacity:this._getLayerOpacity()}),d=u?new Da(o[0].material,u,this._context.slicePlaneEnabled):null,f=new ec(this,l,null,Aa,n,d);this._fastUpdateProcessor.onAddGraphic(),f.needsElevationUpdates=fi(n.mode),f.useObjectOriginAsAttachmentOrigin=!0,f.fastTransformUpdatesAllowed=this._fastTransformUpdatesAllowed(i),n.centerInElevationSR=this._getCenterInElevationSR(l.transformation);let{elevationProvider:p,renderCoordsHelper:m}=this._context;return f.alignedSampledElevation=Aa(f,n,p.spatialReference,(e,t)=>ai(e,p,n,m,t),m),f}_fastTransformUpdatesAllowed(e){let{vertexSpace:t,spatialReference:n}=e;if(!gn(t))return!1;let{type:r}=t,{view:a}=this._context.graphicsCoreOwner,{viewingMode:o}=a.state,s=a.spatialReference;return o===1&&r===`local`||o===2&&i(s,n)&&r===`georeferenced`&&!n.isGeographic}_getElevationSR(){return this._context.elevationProvider.spatialReference??null}_getCenterInElevationSR(e){let t=z(),n=A(al,e[12],e[13],e[14]);return Xn(n,this._context.renderCoordsHelper.spatialReference,t,this._getElevationSR()),t}_passthroughReprojectionInfo(e){return e.reprojection===0&&!!e.objectTransformation}_createPositionBuffer(e,t){let n=e.vertexAttributes.position,r,i=n;if(t.reprojection===0)return{position:i,georeferencedPositionBuffer:r};let a=t.reprojection===1?t.transformBeforeProject:null;a&&(i=Vn(new Float64Array(i.length),i,a));let{normal:o,tangent:s}=e.vertexAttributes;this._passthroughReprojectionInfo(t)||!o&&!s||(r=i);let c=i===n||i===r?new Float64Array(i.length):i;return kt(i,e.spatialReference,0,c,this._context.renderCoordsHelper.spatialReference,0),{position:c,georeferencedPositionBuffer:r}}_createNormalBuffer(e,t,n,r){let i=e.vertexAttributes.normal;if(i==null)return null;let a=i,o=r.reprojection===1?r.transformBeforeProject:null;o&&(a=qn(a,new Float32Array(a.length),o));let s=this._context.graphicsCoreOwner.view.viewingMode;if(r.reprojection===0)return a;if(s===`local`){if(!sn(this._context.renderCoordsHelper.spatialReference))return a;if(n==null)return null;if(e.spatialReference.isGeographic){let e=a===i?new Float32Array(a.length):a;return Wn(a,0,n,e)}if(e.spatialReference.isWebMercator){let e=a===i?new Float32Array(a.length):a;return Un(a,0,n,e)}return a}if(n==null)return null;let c=a===i?new Float32Array(a.length):a,l=this._context.renderCoordsHelper.spatialReference;return Gn(a,n,e.spatialReference,t,l,c)}_createTangentBuffer(e,t,n,r){let i=e.vertexAttributes.tangent;if(i==null)return null;let a=i,o=r.reprojection===1?r.transformBeforeProject:null;o&&(a=Hn(a,new Float32Array(a.length),o));let s=this._context.graphicsCoreOwner.view.viewingMode;if(r.reprojection===0)return a;if(s===`local`){if(!sn(this._context.renderCoordsHelper.spatialReference))return a;if(n==null)return null;if(e.spatialReference.isGeographic){let e=a===i?new Float32Array(a.length):a;return Wn(a,1,n,e)}if(e.spatialReference.isWebMercator){let e=a===i?new Float32Array(a.length):a;return Un(a,1,n,e)}return a}if(n==null)return null;let c=a===i?new Float32Array(a.length):a,l=this._context.renderCoordsHelper.spatialReference;return Kn(a,n,e.spatialReference,t,l,c)}_createSymbolColorBuffer(e){return this._requiresSymbolVertexColors()?new Uint8Array(this._getDrivenUInt8ColorWithNaNSupport(e,this._materialColor,!0)):null}_createBuffers(e,t){let n=e.vertexAttributes&&e.vertexAttributes.position;if(!n)return this.logger.warn(`Mesh geometry must contain position vertex attributes`),null;let r=e.vertexAttributes.normal,i=e.vertexAttributes.uv,a=e.vertexAttributes.tangent;if(r&&r.length!==n.length)return this.logger.warn(`Mesh normal vertex buffer must contain the same number of elements as the position buffer`),null;if(a&&a.length/4!=n.length/3)return this.logger.warn(`Mesh tangent vertex buffer must contain the same number of elements as the position buffer`),null;if(i&&i.length/2!=n.length/3)return this.logger.warn(`Mesh uv vertex buffer must contain the same number of elements as the position buffer`),null;let o=this._computeReprojectionInfo(e),{position:s,georeferencedPositionBuffer:c}=this._createPositionBuffer(e,o),l=Yc(e),u=this._createSymbolColorBuffer(t),d=this._createNormalBuffer(e,s,c,o),f=this._createTangentBuffer(e,s,c,o),p=i,{transformation:m,position:h,normal:g,tangent:_}=this._passthroughReprojectionInfo(o)?{transformation:o.objectTransformation,position:s,normal:d,tangent:f}:this._transformOriginLocal(e,s,d,f);return{positionBuffer:h,normalBuffer:g,tangentBuffer:_,uvBuffer:p,colorBuffer:l,symbolColorBuffer:u,objectTransformation:m,geometryTransformation:o.reprojection===0&&o.geometryTransformation?o.geometryTransformation:O()}}_computeReprojectionInfo(e){let{vertexSpace:t}=e,n=t.type===`georeferenced`?i(this._context.renderCoordsHelper.spatialReference,e.spatialReference)?0:1:0;if(_n(t))return{reprojection:n};let r=t.origin,a=O(),o=e.transform?.localMatrix??He;if(n===0)return Fn(e.spatialReference,r,a,this._context.renderCoordsHelper.spatialReference),{reprojection:n,objectTransformation:a,geometryTransformation:Je(o)};let s=Xe(O(),r);return De(s,s,o),{reprojection:n,transformBeforeProject:s}}_transformOriginLocal(e,t,n,r){let i=this._context.renderCoordsHelper.spatialReference,a=e.origin;Qc[0]=a.x,Qc[1]=a.y,Qc[2]=a.z??0;let o=O();Fn(e.spatialReference,Qc,o,i),Pe(tl,o);let{position:s,normal:c,tangent:l}=e.vertexAttributes,u=t===s?new Float64Array(t.length):t;Vn(u,t,tl);let d=n?n===c?new Float32Array(n.length):n:null,f=r?r===l?new Float32Array(r.length):r:null;return n&&d&&qn(n,d,tl),r&&f&&Hn(r,f,tl),{transformation:o,position:u,normal:d,tangent:f}}_validateFaces(e,t){let n=e.vertexAttributes.position.length/3,r=t.faces;if(r){let e=-1;for(let t=0;t<r.length;t++){let n=r[t];n>e&&(e=n)}if(n<=e)return this.logger.warn(`Vertex index ${e} is out of bounds of the mesh position buffer`),!1}else if(n%3!=0)return this.logger.warn(`Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)`),!1;return!0}_isOutsideClippingArea(e){if(!this._context.clippingExtent||!e.vertexAttributes?.position)return!1;let t=this._context.elevationProvider.spatialReference,n=Yn(e,t??e.spatialReference);return!!n&&(ve(n,rl),!at(rl,this._context.clippingExtent))}_createGeometryInfo(e,t,n){if(!un(e.spatialReference,this._context.renderCoordsHelper.spatialReference))return this.logger.warn(`Geometry spatial reference is not compatible with the view`),null;if(!this._validateVertexSpace(e)||this._isOutsideClippingArea(e))return null;let r=this._createBuffers(e,t);if(r==null)return null;let{positionBuffer:i,uvBuffer:a,colorBuffer:o,symbolColorBuffer:c,normalBuffer:l,tangentBuffer:u,objectTransformation:d,geometryTransformation:f}=r,p=e.components??il,m=[],h=!1,g=s(J,d),_=this._context.localOriginFactory.getOrigin(g);for(let t of p){if(!this._validateFaces(e,t))return null;let r=Pc(e,t);if(r.length===0)continue;let s=Fc(i,l,t,r);s.didFlipNormals&&(h=!0);let d=[[`position`,new B(i,r,3,!0)],[`normal`,new B(s.normals,s.indices,3,!0)]];o&&d.push([`color`,new B(o,r,4,!0)]),c&&d.push([`symbolColor`,new B(c,xn(r.length),4,!0)]),a&&d.push([`uv0`,new B(a,r,2,!0)]),u&&d.push([`tangent`,new B(u,r,4,!0)]);let p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:n,layerViewUid:this._context.layerViewUid}),g=this._getOrCreateMaterial(e,t),v=new Kr(g,d,null,0,p);v.transformation=f,v.localOrigin=_,m.push(v)}return h&&this.logger.warn(`Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals.`),{geometries:m,objectTransformation:d}}_updateMaterialParameters(e){this._materialInfoCache.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachClonedMaterial((e,t)=>{t.setParameters(e.parameters)})}_validateVertexSpace(e){let{_context:{graphicsCoreOwner:{view:{state:{viewingMode:t}}}}}=this,{vertexSpace:n}=e;return t!==2||n.type!==`local`||(this.logger.warn(`Displaying a mesh with a local vertex space in a view in local viewing mode is not supported.`),!1)}test(){return{...super.test(),materials:this._materialInfoCache.materials}}get _materialColor(){return this.symbolLayer.material?.color}},Nc=class{constructor(e,t,n){this.normals=e,this.indices=t,this.didFlipNormals=n}};function Pc(e,t){return t.faces??yn(e.vertexAttributes.position.length/3)}function Fc(e,t,n,r){switch(n.shading||`flat`){default:case`source`:return Lc(e,t,n,r);case`flat`:return Ic(e,r);case`smooth`:return Rc(e,r)}}function Ic(e,t){let n=Ti(t.length),r=Array(3*t.length);for(let i=0;i<t.length;i+=3){let a=Bc(e,t,i,el);for(let e=0;e<3;e++)n[i+e]=a[e],r[i+e]=i/3}return new Nc(n,r,!1)}function Lc(e,t,n,r){if(t==null)return Ic(e,r);let i=!1;if(!n.trustSourceNormals)for(let n=0;n<r.length;n+=3){Bc(e,r,n,el);for(let e=0;e<3;e++){let a=3*r[n+e];J[0]=t[a],J[1]=t[a+1],J[2]=t[a+2],R(el,J)<0&&(t[a]=-t[a],t[a+1]=-t[a+1],t[a+2]=-t[a+2],i=!0)}}return new Nc(t,r,i)}function Rc(e,t){let n={};for(let r=0;r<t.length;r+=3){let i=Bc(e,t,r,el);for(let e=0;e<3;e++){let a=t[r+e],o=n[a];o||(o={normal:z(),count:0},n[a]=o),j(o.normal,o.normal,i),o.count++}}let r=Ti(3*t.length),i=Array(3*t.length);for(let e=0;e<t.length;e++){let a=n[t[e]];a.count!==1&&(L(a.normal,a.normal),a.count=1);for(let t=0;t<3;t++)r[3*e+t]=a.normal[t];i[e]=e}return new Nc(r,i,!1)}function zc(e,t,n,r,i,a){let o=3*t[n],s=3*t[n+1],c=3*t[n+2];r[0]=e[o],r[1]=e[o+1],r[2]=e[o+2],i[0]=e[s],i[1]=e[s+1],i[2]=e[s+2],a[0]=e[c],a[1]=e[c+1],a[2]=e[c+2]}function Bc(e,t,n,r){return zc(e,t,n,J,Y,$c),I(Y,Y,J),I($c,$c,J),be(J,Y,$c),L(r,J),r}function Vc(e){if(!e)return null;let{scale:t,offset:n,rotation:r}=e;return{scale:t,offset:n,rotation:Me(r)}}function Hc(e=`repeat`){if(typeof e==`string`){let t=Uc(e);return{s:t,t}}return{s:Uc(e.horizontal),t:Uc(e.vertical)}}function Uc(e){switch(e){case`clamp`:return 33071;case`mirror`:return 33648;default:return 10497}}function Wc(e){let t=e.vertexAttributes.color;if(t==null)return!1;for(let e=3;e<t.length;e+=4)if(t[e]!==255)return!0;return!1}function Gc(e,t,n){t.diffuse=e.toUnitRGB(),t.opacity=n.alphaMode===`opaque`?1:e.a}function Kc(e){return e.data??e.url}function qc(e){return e==null?`-`:e instanceof Lt?e.toHex():e.contentHash}function Jc(e){let{offset:t,scale:n,rotation:r}=e??Zc;return`${t[0]},${t[1]},${r},${n[0]},${n[1]}`}function Yc(e){return e.vertexAttributes.color}function Xc(e){return(e.material?.color?.a??0)===1}var Zc=new pn,Qc=z(),J=z(),Y=z(),$c=z(),el=z(),tl=O(),nl=O(),rl=o(),il=[new hn],al=z(),ol=class{constructor(e,t,n,r,i){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=n,this.elevationContext=r,this._highlightOrderMap=i,this.type=`lod-instance`,this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1,this._highlightName=null}initialize(){}setVisibility(e){let{instanceData:t}=this;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){this.instanceIndex!=null&&(this.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}alignWithElevation(e,t){if(this.elevationAligner){let n=(n,r)=>ai(n,e,this.elevationContext,t,r),r=this.elevationAligner(this,this.elevationContext,e.spatialReference,n,t);r!=null&&(this.alignedSampledElevation=r)}}getCenterObjectSpace(e=z()){return this.instanceData.getCombinedLocalTransform(this.instanceIndex,ul),P(e,this._lodRenderer.baseBoundingSphere.center,ul)}getBoundingBoxObjectSpace(e=o()){this.instanceData.getCombinedLocalTransform(this.instanceIndex,ul);let t=this._lodRenderer.baseBoundingBox;ln(e);for(let n=0;n<8;++n)A(X,1&n?t[3]:t[0],2&n?t[4]:t[1],4&n?t[5]:t[2]),P(X,X,ul),he(e,X);return e}computeAttachmentOrigin(e){this.instanceData.getGlobalTransform(this.instanceIndex,ul),e.render.origin[0]+=ul[12],e.render.origin[1]+=ul[13],e.render.origin[2]+=ul[14],e.render.num++}async getProjectedBoundingBox(e,t,n,r,i){let a=this.getBoundingBoxObjectSpace(i),o=ll,s=It(a)?1:o.length;this.instanceData.getGlobalTransform(this.instanceIndex,ul);for(let e=0;e<s;e++){let t=o[e];X[0]=a[t[0]],X[1]=a[t[1]],X[2]=a[t[2]],P(X,X,ul),sl[3*e]=X[0],sl[3*e+1]=X[1],sl[3*e+2]=X[2]}if(!e(sl,0,s))return null;ln(a);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let e=0;e<3*s;e+=3){for(let t=0;t<3;t++)a[t]=Math.min(a[t],sl[e+t]),a[t+3]=Math.max(a[t+3],sl[e+t]);c&&n.push({location:sl.slice(e,e+3),screenSpaceBoundingRect:c})}if(t&&(C(a,cl),this.elevationContext.mode!==`absolute-height`)){let e,n=fa(a,t.service.spatialReference,t);try{e=await t.service.queryElevation(cl[0],cl[1],r,n,`ground`)}catch{}e!=null&&$e(a,0,0,-this.alignedSampledElevation+e)}return a}addObjectState(e){e.stateType===0&&this.addObjectHighlightState(e)}addObjectHighlightState(e){let t=new Fr(e.highlightName);this._addHighlightId(t),e.addExternal(e=>{this._removeHighlightId(e)},t)}removeObjectState(e){this._highlights.forEach(t=>e.remove(t))}updateHighlights(e){this._highlightOrderMap=e,this._updateHighlightOptions()}_calculateHighlightOptions(){let e=-1,t=null;return this._highlights.forEach(({highlightName:n})=>{let r=this._highlightOrderMap.get(n);r!==void 0&&r>e&&(e=r,t=n)}),t}_addHighlightId(e){this._highlights.add(e),this._updateHighlightOptions()}_removeHighlightId(e){this._highlights.delete(e),this._updateHighlightOptions()}_updateHighlightOptions(){let e=this._calculateHighlightOptions();e!==this._highlightName&&(this._highlightName=e,this.instanceData.setHighlight(this.instanceIndex,e))}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}get instanceData(){return this._lodRenderer.instanceData}},sl=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],X=z(),cl=z(),ll=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],ul=O();function dl(e,t){let n=e.stageResources.geometries.map(t=>new Wa(new qa(t),e.stageResources.textures)),r=e.lodThreshold==null||e.lodThreshold===0&&t>0?pl(n):e.lodThreshold;return new Ja(n,r,e.pivotOffset)}function fl(e){return new Ga(e.map((e,t)=>dl(e,t)))}function pl(e){let t=e.reduce((e,t)=>e+t.numTriangles,0);return Math.sqrt(t*ml/Math.PI)}var ml=20;async function hl(e){if(e==null||e.styleName==null&&e.styleUrl==null)return null;let t=e.name;if(t==null)throw new n(`symbolstyleutils:style-symbol-reference-name-missing`,`Missing name in style symbol reference`);let r={portal:e.portal},i=await ye(e,r).catch(()=>null);if(i===null)return null;let a=vr(t,i.data);if(a&&!a.formatInfos?.some(e=>e.type===`gltf_basisu`))return null;let o=await _r(i,t,r,ae,{acceptedFormats:[`web-gltf-basisu`,`web-gltf`,`web`]}).catch(()=>null);if(o===null||o.type!==`point-3d`)return null;let s=o.symbolLayers.items[0];return s.type===`object`?s.resource:null}var gl=class extends _i{constructor(e,t){super(e=>new yr(this._instanceData.view.boundingSphere.getVec(e,_l)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=t,this._tmpSphere=new yr,this._tmpMat4=O()}addInstance(e){let t=this._instanceData.view.boundingSphere,n=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);P(this._tmpSphere.center,this._boundingSphere.center,n),this._tmpSphere.radius=this._boundingSphere.radius*wn(n),t.setVec(e,this._tmpSphere.toVec4()),this.add([e])}removeInstance(e){this.remove([e])}},_l=qe(),vl=class{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,n){let r=n.computeScreenPixelSizeAt(e),i=this._worldSpaceRadius*t/r,a=0;for(let e=1;e<this._minScreenSpaceRadii.length;++e)i>=this._minScreenSpaceRadii[e]&&(a=e);return a}},yl=class{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach((e,t)=>{e!=null&&this._repository.release(this._material,t)})}load(e,t,n){if(!this._material.produces.get(t)?.(n))return null;this._map.has(n)||this._map.set(n,this._repository.acquire(this._material,t,n));let r=this._map.get(n);if(r){if(r.ensureResources(e)===2)return r;this._repository.requestRender()}return null}},bl=class{constructor(e,t){this.geometry=t;let n=e.renderContext.rctx,r=t.renderGeometry,{material:i,layout:a,buffer:o}=r;this._materials=e.materials,i.setParameters({instancedDoublePrecision:!0}),this.glMaterials=new yl(i,this._materials),this.vbo=new wr(n,Ei(a),o),this.vao=new Ui(n,this.vbo)}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get material(){return this.geometry.renderGeometry.material}get layout(){return this.geometry.renderGeometry.layout}get boundingInfo(){return this.geometry.boundingInfo}get numTriangles(){return this.numVertices/3}get numVertices(){return this.geometry.renderGeometry.numVertices}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,t,n,r,i,a,o,s){return this.geometry.intersect(e,t,n,r,i,a,o,s)}},xl=class e{static async create(t,n,r){let i=await Promise.allSettled(n.components.map(e=>t.controller.schedule(()=>new bl(t,e.geometry),r))),a=i.map(e=>e.status===`fulfilled`?e.value:null).filter(Ut);if(it(r)||a.length!==i.length){a.forEach(e=>e.destroy()),Ft(r);for(let e of i)if(e.status===`rejected`)throw e.reason}return new e(n.minScreenSpaceRadius,a)}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,t,n,r,i,a,o){this.components.forEach(s=>s.intersect(e,t,n,r,i,a,this.boundingSphere,o))}get boundingBox(){if(this._boundingBox==null){let e=ln();this.components.forEach(t=>{t.boundingInfo!=null&&(he(e,t.boundingInfo.bbMin),he(e,t.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){let e=this.boundingBox,t=z();C(e,t),this._boundingSphere={center:t,radius:.5*je(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,t)=>e+t.numTriangles,0)}},Sl=e=>{let t=e.baseBoundingSphere.radius,n=e.levels.map(e=>e.minScreenSpaceRadius);return new vl(t,n)},Cl=class extends Hi{constructor(e,t){super(e),this.type=3,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceDatas=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new bi,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[2,e=>this._produces(e)],[4,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new eo({shaderTransformation:e.shaderTransformation},e.symbol.materialParameters),this.addHandles(t.registerTask(Ye.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=$a(this.symbol.materialParameters),this._glInstanceBufferLayout=Ei(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on(`instances-changed`,()=>this._requestUpdateCycle()),this._instanceData.events.on(`instance-transform-changed`,({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)}),this._instanceData.events.on(`instance-visibility-changed`,({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)}),this._instanceData.events.on(`instance-highlight-changed`,()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDatas.values()]}get _allRenderInstanceDataExceptHighlightShadow(){let e=[this._defaultRenderInstanceData];for(let t of this._highlightRenderInstanceDatas)t[0]!==`default`&&e.push(t[1]);return e}hasHighlight(e){return this._highlightRenderInstanceDatas.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmitters(){return this._levels.some(e=>e.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((e,t)=>t.reduce((e,t)=>e+t.usedMemory,e),this._levels.reduce((e,t)=>e+t.components.reduce((e,t)=>e+t.usedMemory,0),0))}get renderStats(){let e=this._instanceData.size,t=[];return this._levels.forEach((e,n)=>{let r=this._allRenderInstanceData[0][n].size+this._allRenderInstanceData[1][n].size,i=e.triangleCount;t.push({renderedInstances:r,renderedTriangles:r*i,trianglesPerInstance:i})}),{totalInstances:e,renderedInstances:t.reduce((e,t)=>e+t.renderedInstances,0),renderedTriangles:t.reduce((e,t)=>e+t.renderedTriangles,0),levels:t}}_createRenderInstanceDataArray(){let{rctx:e}=this._context.renderContext;return this.symbol.levels.map(t=>new Xa(e,this._instanceBufferLayout))}async initializeRenderContext(e,t){this._context=e,this._defaultRenderInstanceData=this._createRenderInstanceDataArray();let n=await Promise.allSettled(this.symbol.levels.map(n=>xl.create(e,n,t))),r=n.map(e=>e.status===`fulfilled`?e.value:null).filter(Ut);if(it(t)||r.length!==n.length){r.forEach(e=>e.destroy()),Ft(t);for(let e of n)if(e.status===`rejected`)throw e.reason}this._levels=r,this._levelSelector=Sl(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceDatas.forEach(e=>e.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(e=>e.components.some(e=>e.material.produces.get(4)?.(0)))}hasHighlights(){return rn(this._highlightRenderInstanceDatas,e=>e.some(e=>e.size>0))}_produces(e){return(e!==8||this.hasHighlights())&&(e!==4||this.hasHighlight(`default`))}prepareRender(e){if(!qi.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){let t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&=(this.runTask(Ce),!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;let t=this._getInstanceDatas(e);if(!t)return null;let n=[],r=this.levels;return t.forEach(t=>r.forEach(({components:r},i)=>r.forEach(r=>n.push(this._beginComponent(e,t[i],r))))),n}render(e,t){let n=this._getInstanceDatas(e);if(!n||t==null)return;let r=0,i=this.levels;n.forEach(n=>i.forEach(({components:i},a)=>i.forEach(i=>this._renderComponent(e,t[r++],n[a],i,a)))),e.rctx.unbindBuffer(34962),e.rctx.bindVAO(null)}_getInstanceDatas(e){let{output:t,bind:n}=e,r=t===8,i=t===4,a=t!==5;if(!r&&!i)return a?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;let{_highlightRenderInstanceDatas:o}=this;if(a){if(r){let e=n.highlight?.name;if(!e)return null;let t=o.get(e);return t?[t]:null}let e=o.get(Vt);return i?e?[e]:null:Array.from(o.values())}return null}intersect(e,t,n,r){if(!this.baseMaterial.visible||this._octree==null)return;let i=z();I(i,r,n);let a=i=>{this._instanceData.getCombinedModelTransform(i,Ol),e.transform.set(Ol),P(kl,n,e.transform.inverse),P(Al,r,e.transform.inverse);let a=this._instanceData.getState(i),o=this._instanceData.getLodLevel(i),s=this._levels.length;4&a&&(zn(!!(18&a),`invalid instance state`),zn(o>=0&&o<s,`invaid lod level`),this._levels[o].intersect(e,t,kl,Al,i,this.metadata,s))};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(a):this._octree.forEachAlongRay(n,i,a)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){let e=this._instanceData,t=e.view?.state;if(!t)return null;this._octreeCached=new gl(e,this.baseBoundingSphere);for(let n=0;n<e.capacity;++n)18&t.get(n)&&this._octreeCached.addInstance(n)}return this._octreeCached}_invalidateOctree(){this._octreeCached=xt(this._octreeCached)}queryDepthRange(e){if(this._octree==null)return new Si;let t=e.viewForward,n=this._octree.findClosest(t,1,e.frustum),r=this._octree.findClosest(t,-1,e.frustum);if(n==null||r==null)return new Si;let i=e.eye,a=this._instanceData.view;a.boundingSphere.getVec(n,Dl),I(Dl,Dl,i);let o=R(Dl,t)-Dl[3];a.boundingSphere.getVec(r,Dl),I(Dl,Dl,i);let s=R(Dl,t)+Dl[3];return new Si(o,s)}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.startUpdateCycle()))}get readyToRun(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){let{_enableLevelSelection:t,_camera:r,_levelSelector:i}=this;this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.beginUpdate()));let a=this._instanceData,o=a.view,s=a.size,c=a.capacity,l=this._instanceIndex,u=Math.ceil(c/500),{_highlightRenderInstanceDatas:d}=this;for(let f=0;f<s&&!e.done;++f){l===this._cycleStartIndex&&this._startUpdateCycle();let f=o.state.get(l),p=0;if(!(1&f)){l=l+1===c?0:l+1,s++;continue}let m=o.lodLevel.get(l);if(2&f&&this._defaultRenderInstanceData[m].freeTail(),16&f){let e=a.geHighlightOptionsPrev(l);if(e){let t=d.get(e);if(!t)throw new n(`internal:lod-renderer`,`Internal error in lodRenderer`);t[m].freeTail(),t.every(e=>e.isEmpty)&&(t.forEach(e=>e.destroy()),d.delete(e))}}if(32&f)a.freeInstance(l);else if(4&f){let e=0;if(t&&(o.modelOrigin.getVec(l,El),e=i.selectLevel(El,a.getCombinedMedianScaleFactor(l),r)),p=-83&f,e>=0)if(8&f){let t=a.getHighlightName(l);if(t){let r=()=>{let e=this._createRenderInstanceDataArray();return e.forEach(e=>e.beginUpdate()),e},i=Yt(d,t,r);if(e>=i.length)throw new n(`internal:lod-renderer`,`LodRenderer internal error - missing lodLevel ${e}`);wl(i[e],o,l)}p|=16}else wl(this._defaultRenderInstanceData[e],o,l),p|=2;o.state.set(l,p),o.lodLevel.set(l,e)}else p=-83&f,o.state.set(l,p);let h=!!(18&f),g=!!(18&p);this._octreeCached!=null&&(!h&&g?this._octreeCached.addInstance(l):h&&!g?this._octreeCached.removeInstance(l):h&&g&&64&f&&(this._octreeCached.removeInstance(l),this._octreeCached.addInstance(l))),l=l+1===c?0:l+1,l%u===0&&e.madeProgress(),h!==g&&this.metadata.notifyGraphicVisibilityChanged(l),g&&64&f&&this.metadata.notifyGraphicGeometryChanged(l)}this._instanceIndex=l,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.endUpdate())),this._context.requestRender()}_beginComponent(e,t,n){return t.size===0?null:n.glMaterials.load(e.rctx,e.bind.slot,e.output)?.beginSlot(e.bind)}_renderComponent(e,t,n,r,i){if(!t)return;let{bind:a,rctx:o}=e;o.runAppleAmdDriverHelper();let s=o.bindTechnique(t,a,r.material.parameters,Ml),c=this._glInstanceBufferLayout;s.assertCompatibleVertexAttributeLocations(r.vao,pr(c)),o.bindVAO(r.vao),qi.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===0&&(s.setUniform4fv(`externalColor`,jl[Math.min(i,jl.length-1)]),s.setUniform1i(`symbolColorMixMode`,gi.replace));let l=n.capacity,u=n.headIndex,d=n.tailIndex,f=n.firstIndex,p=(e,i)=>{nn(o,s.locations,n.buffer,e),o.drawArraysInstanced(t.primitiveType,0,r.numVertices,i-e)};r.material.transparent&&f!=null?u>d?(zn(f>=d&&f<=u,`invalid firstIndex`),p(f,u),p(d,f)):u<d&&(f<=u?(zn(f>=0&&f<=u,`invalid firstIndex`),p(f,u),p(d,l),p(0,f)):(zn(f>=d&&f<=l,`invalid firstIndex`),p(f,l),p(0,u),p(d,f))):u>d?p(d,u):u<d&&(p(0,u),p(d,l))}};function wl(e,t,n){let r=e.allocateHead();Tl(t,n,e.view,r)}function Tl(e,t,n,r){ri(e.modelOrigin,t,n.modelOriginHi,n.modelOriginLo,r),n.model.copyFrom(r,e.model,t),n.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&n.color&&n.color.copyFrom(r,e.color,t),e.olidColor&&n.olidColor&&n.olidColor.copyFrom(r,e.olidColor,t),e.featureAttribute&&n.featureAttribute&&n.featureAttribute.copyFrom(r,e.featureAttribute,t)}F([l({constructOnly:!0})],Cl.prototype,`symbol`,void 0),F([l({constructOnly:!0})],Cl.prototype,`metadata`,void 0),F([l({constructOnly:!0})],Cl.prototype,`shaderTransformation`,void 0),F([l()],Cl.prototype,`_instanceData`,void 0),F([l()],Cl.prototype,`_cycleStartIndex`,void 0),F([l({readOnly:!0})],Cl.prototype,`_enableLevelSelection`,null),F([l()],Cl.prototype,`_updateCyclesWithStaticCamera`,void 0),F([l({readOnly:!0})],Cl.prototype,`readyToRun`,null),Cl=F([Fe(`esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer`)],Cl);var El=z(),Dl=qe(),Ol=O(),kl=z(),Al=z(),jl=[We(1,0,1,1),We(0,0,1,1),We(0,1,0,1),We(1,1,0,1),We(1,0,0,1)],Ml=new Za,Nl=class{constructor(e,t,n,r,i,a,o,s,c,l,u=null){this.lodResources=e,this.lodRenderer=t,this.stageResources=n,this.resourceSize=r,this.isEsriSymbolResource=i,this.isWosr=a,this.resourceBoundingBox=o,this.symbolSize=s,this.extentPadding=c,this.physicalBasedRenderingEnabled=l,this.pivotOffset=u}},Pl=class extends Ba{getCachedSize(){let[e,t,n]=this._resources==null?[1,1,1]:this._resources.symbolSize;return{width:e,depth:t,height:n}}constructor(e,t,n,r){super(e,t,n,r,Ll(t)),this._resources=null,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=[],this.skipHighSymbolLodsChanged=!1,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=n.physicalBasedRenderingEnabled}async doLoad(e){if(!this._drivenProperties.size){let e=ga(this.symbolLayer);if(e)throw Error(e)}if(this._isPrimitive){let t=this.symbolLayer.resource,n=t&&Ya(t?.primitive)?t.primitive:qt;this._resources=await this._createResourcesForPrimitive(n,e)}else{let t=await hl(this.symbol.styleOrigin),n=t?.href??this.symbolLayer.resource?.href;this._resources=await this._createResourcesForUrl(n,e)}this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.updateComplexity()}get extentPadding(){return this._resources==null?0:this._resources.extentPadding}get _isPrimitive(){return this._primitive!=null}get lodRenderer(){return this._resources?.lodRenderer}get materials(){return this._resources?.stageResources.materials??[]}async _createResourcesForPrimitive(e,t){let n=this.symbolLayer,r=o(Mt(e)),i=Qt(ne(r)),a=Qt(Kt(i,n)),s=Ie(a),c=n?.material,l={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:to,ambient:Et,diffuse:Et,opacity:1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:n.castShadows,emissiveStrengthFromSymbol:c?.emissive?.strength??0,emissiveSource:1,offsetTransparentBackfaces:!1,drivenOpacity:this.needsDrivenTransparentPass},u=!!l.usePBR,d=this.symbol;d.type===`point-3d`&&d.verticalOffset&&(l.verticalOffset=new ya(d.verticalOffset),l.castShadows=!1),this._context.screenSizePerspectiveEnabled&&(l.screenSizePerspective=this.view.screenSizePerspective.parameters),this._hasDrivenColorOrOpacity?l.externalColor=La:l.externalColor=this._materialColor?.toUnitRGBA()??D,this._fastUpdates=Xi(this._context.renderer,this._fastVisualVariableConvertOptions(r,a,i,null)),l.instanced=!0,this._fastUpdates?(Object.assign(l,this._fastUpdates.materialParameters),l.instancedFeatureAttribute=!0):this._hasDrivenColorOrOpacity&&(l.instancedColor=!0);let f=new Qa(l,this._context);f.setParameters({cullFace:Rl(f.transparent)});let p=Ka(e,f);if(!p)throw Error(`Unknown object symbol primitive: ${e}`);let m=await this._createStageResources(p,u,t),h=await this._createLodRenderer(p,t);return new Nl(p,h,m,i,!1,!1,r,a,s,u)}async _createResourcesForUrl(e,t){let n={instanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},r={spherical:this._context.spherical,materialParameters:n,cache:this._context.sharedResources.objectResourceCache,compressionOptions:{compressionTracker:this._context.compressionTracker,compressionCallback:()=>this.updateComplexity()}};this._fastUpdates=Xi(this._context.renderer,this._fastVisualVariableConvertOptions(null,null,null,null)),this._fastUpdates?(Object.assign(r.materialParameters,this._fastUpdates.materialParameters),r.materialParameters.instancedFeatureAttribute=!0):this._hasDrivenColorOrOpacity&&(r.materialParameters.instancedColor=!0);let i=this.symbol;if(i.type===`point-3d`&&i.verticalOffset){let{screenLength:e,minWorldLength:t,maxWorldLength:n}=i.verticalOffset;r.materialParameters.verticalOffset={screenLength:N(e),minWorldLength:t||0,maxWorldLength:n??1/0},r.materialParameters.castShadows=!1}let a=this._context.physicalBasedRenderingEnabled;r.signal=t,r.usePBR=a,r.useEmissive=this.view.stage.renderView.renderingContext.driverTest.floatBufferBlend.result,r.skipHighLods=this._context.skipHighSymbolLods;let o=this.symbolLayer.material;r.materialParameters.emissiveStrengthFromSymbol=o?.emissive?.strength??1,r.materialParameters.emissiveSource=ut(o?.emissive?.source??`emissive`);let s=await yo(e,r),c=s.isEsriSymbolResource,l=s.isWosr,u=fl(s.lods),d=this._context,f=this._getExternalColorParameters(o),p=this.needsDrivenTransparentPass,m=u.getMaterials();m.forEach(e=>{e.setParameters({...f,drivenOpacity:p}),d.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:this.view.screenSizePerspective.parameters})});let h=s.referenceBoundingBox,g=Qt(ne(h)),_=Qt(u.levels[0].pivotOffset),v=Qt(Kt(g,this.symbolLayer)),y=Ie(v),b=this._fastUpdates;Zi(b,this._context.renderer,this._fastVisualVariableConvertOptions(h,v,g,_))&&m.forEach(e=>e.setParameters(b.materialParameters));let x=await this._createStageResources(u,a,t),S=await this._createLodRenderer(u,t);return new Nl(u,S,x,g,c,l,h,v,y,a,_)}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createStageResources(e,t,n){let r=this._context.stage,i=e.getMaterials();t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();let a=e.getTextures();r.addTextures(a),this._addDisposeResource(()=>{a.forEach(e=>e.unload()),r.removeTextures(a)}),await Promise.all(a.map(e=>this._context.stage.schedule(()=>e.load(r.renderView.renderingContext),n))),Ft(n);let o=e.getEngineGeometries();return{materials:i,textures:a,geometries:o}}async _createLodRenderer(e,t){let n=this._context.stage,r={layerViewUid:this._context.layerViewUid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},i=this._fastUpdates,a=new Cl({symbol:e,metadata:r,shaderTransformation:i?{applyTransform:(e,t,n)=>{e.getFeatureAttribute(t,Hl),oe(n,Gi(i.materialParameters,Hl,n))},scaleFactor:(e,t,n)=>{t.getFeatureAttribute(n,Hl),Qi(e,i.materialParameters,Hl)}}:null},this._context.scheduler);return a.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource(()=>{n.removeRenderPlugin(a),a.destroy()}),await n.addRenderPlugin(a,t),a}_getExternalColorParameters(e){let t={};if(t.externalColor=La,!this._drivenProperties.color&&e?.color!=null){let n=e.color.toUnitRGBA();this._drivenProperties.opacity&&(n[3]=NaN),t.externalColor=n}return t}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(e=>e()),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let n=Va(t.geometry);if(n==null)return this.logger.warn(`unsupported geometry type for object symbol: ${t.geometry.type}`),null;let r=this.createElevationContextForGraphic(t),i=e.renderingInfo;return this._createAs3DShape(t,n,i,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(this._resources==null)return;let e=this._getLayerOpacity(),t=this._resources.stageResources.materials;for(let n=0;n<t.length;n++){let r=t[n];r.setParameters({layerOpacity:e}),this._isPrimitive&&r.setParameters({cullFace:Rl(r.transparent)})}}layerScreenSizePerspectiveChanged(){if(this._resources==null)return;let e=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null;for(let t of this._resources.stageResources.materials)t.setParameters({screenSizePerspective:e})}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,fi)}slicePlaneEnabledChanged(){if(this._resources==null)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(let e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(this._resources==null)return!0;let{stageResources:e,isWosr:t}=this._resources;for(let n of e.materials)this._isPrimitive?n.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||n.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this._hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this._hasLoadedPBRTextures=!0,!1)}applyRendererDiff(e,t){if(this._resources==null)return 0;let{stageResources:{materials:n},lodRenderer:r,resourceBoundingBox:i,symbolSize:a,resourceSize:o,pivotOffset:s}=this._resources;for(let c in e.diff){if(c!==`visualVariables`||!Zi(this._fastUpdates,t,this._fastVisualVariableConvertOptions(i,a,o,s)))return 0;for(let e of n)e.setParameters(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged()}return 2}computeComplexity(){if(this._resources==null)return super.computeComplexity();let e=this._resources.lodResources,t=Ca(e.levels),n=e.computeUsedMemory(),r={...Ta(this.symbol,this.symbolLayer),resourceBytes:n};return new ba({verticesPerFeature:t,memory:r})}_hasLodRenderer(){return this._resources!=null}_createAs3DShape(e,t,n,r,i){if(!this._hasLodRenderer()||this._resources==null)return null;let a=this.getFastUpdateAttrValues(e),o=this._context.clippingExtent;if(Pn(t,zl,this._context.elevationProvider.spatialReference),o!=null&&!$t(o,zl))return null;let s=Il(r),c=this._computeGlobalTransform(t,r,Vl,Ul),l=this._computeLocalTransform(this._resources,this.symbolLayer,n,Bl),u=this._resources.lodRenderer.instanceData,d=u.addInstance();this._instanceIndexToGraphicUid.set(d,i),u.setLocalTransform(d,l,!1),u.setGlobalTransform(d,c),a&&u.setFeatureAttribute(d,a),this._fastUpdates==null&&this._hasDrivenColorOrOpacity&&u.setColor(d,this._getDrivenUInt8ColorWithNaNSupport(n,this._materialColor,!this._isPrimitive));let f=this._context.stage.renderView.olidRenderHelper;if(f){let e=f.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid});u.setObjectAndLayerIdColor(d,e)}let p=new ol(this,d,Fa,r,this._context.stage.view.state.highlightOrderMap);return s&&(p.alignedSampledElevation=Ul.sampledElevation),p.needsElevationUpdates=fi(r.mode),Ia(p,t,this._context.elevationProvider),p}_computeGlobalTransform(e,t,n,r){return ai(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r),zl[0]=e.x,zl[1]=e.y,zl[2]=r.z,Fn(e.spatialReference,zl,n,this._context.renderCoordsHelper.spatialReference),n}_computeLocalTransform(e,t,n,r){return Ge(r),this._applyObjectRotation(n,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,n,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,n){if(this._fastUpdates?.requiresShaderTransformation)return;let r=this._drivenProperties.size&&t.size?t.size:e.symbolSize,i=la(r,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);i[0]===1&&i[1]===1&&i[2]===1||Le(n,n,i)}prepareSymbolLayerPatch(e){if(e.diff.type!==`partial`)return;let t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(this._resources==null)return!0;let n=e.geometry;if(!n)return!1;let r=Va(n);if(r==null)return!1;let i=this.getGeometryElevationMode(n),{elevationContext:a}=t;return a.mode===i&&(a.updateFeatureExpressionFeature(e,this._context.layer),this._computeGlobalTransform(r,a,Vl,Ul),Il(a)&&(t.alignedSampledElevation=Ul.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(t.instanceIndex,Vl,!0),Ia(t,r,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition)||this._resources==null)return;let n=(e,t,n)=>(e!=null&&e.type===`complete`?e.newValue:t)??n,r=n(t.heading,this.symbolLayer.heading,0),i=n(t.tilt,this.symbolLayer.tilt,0),a=n(t.roll,this.symbolLayer.roll,0),o=n(t.width,this.symbolLayer.width,void 0),s=n(t.height,this.symbolLayer.height,void 0),c=n(t.depth,this.symbolLayer.depth,void 0),l=n(t.anchor,this.symbolLayer.anchor,void 0),u=n(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;let d={heading:r,tilt:i,roll:a,anchor:l,anchorPosition:u},f=this._resources;this.loadStatus===1&&e.symbolLayerStatePatches.push(()=>{f.symbolSize=Qt(Kt(f.resourceSize,{width:o,height:s,depth:c,isPrimitive:this._isPrimitive}))}),e.graphics3DGraphicPatches.push(({instanceIndex:e},t)=>{let n=this._computeLocalTransform(f,d,t,Bl);f.lodRenderer.instanceData.setLocalTransform(e,n,!0)})}_preparePatchColor(t,n){if(!n.material||n.material.type!==`partial`)return;let r=n.material.diff;if(!r.color||r.color.type!==`complete`||r.color.newValue==null||r.color.oldValue==null)return;let i=r.color.newValue,a=i==null?e:i.toUnitRGBA();delete r.color;let o=this._resources;if(o==null)return;let s=this._isPrimitive;t.graphics3DGraphicPatches.push(({instanceIndex:e})=>{if(this._hasDrivenColorOrOpacity)o.lodRenderer.instanceData.setColor(e,a);else{let e={externalColor:a};for(let t of o.stageResources.materials)t.setParameters(e),s&&t.setParameters({cullFace:Rl(t.transparent)})}})}_applyObjectRotation(e,t,n){if(!this._fastUpdates?.requiresShaderTransformation||!t)return _a(e.heading,e.tilt,e.roll,n)}_applyAnchor(e,t,n){if(this._fastUpdates?.requiresShaderTransformation)return;let r=Fl(e.resourceBoundingBox,e.pivotOffset,t);r&&ze(n,n,r)}_fastVisualVariableConvertOptions(e,t,n,r){let i=e==null?Et:Qt(ne(e)),a=e==null?gt:Fl(e,r,this.symbolLayer),o=this._context.renderCoordsHelper.unitInMeters,s=la(t??void 0,t,n,o),c=tn(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new Wi({supports:{size:!0,color:!0,rotation:!0,opacity:!1},modelSize:i,symbolSize:t??Et,unitInMeters:o,anchor:a,scale:s,rotation:c,fallbackColor:this._getFallbackOpacityAndColor(),fallbackSize:s})}get _primitive(){let{resource:e}=this.symbolLayer;return e?.href==null?e?.primitive??`sphere`:null}_getFallbackOpacityAndColor(){return this._materialColor?.toUnitRGBA()??(this._isPrimitive?D:La)}get _materialColor(){return this.symbolLayer.material?.color}};function Fl(e,t,n){let r=z();switch(n.anchor){case`center`:E(r,C(e)),ue(r,r);break;case`top`:{let t=C(e);A(r,-t[0],-t[1],-e[5]);break}case`bottom`:{let t=C(e);A(r,-t[0],-t[1],-e[2]);break}case`relative`:{let t=C(e),i=ne(e),a=n.anchorPosition,o=a?tn(a.x,a.y,a.z):gt;Ct(r,i,o),j(r,r,t),ue(r,r);break}default:t==null?E(r,gt):ue(r,t)}return r}function Il(e){return e.mode!==`absolute-height`}function Ll(e){return(e.material?.color?.a??0)===1&&e.resource?.href==null}function Rl(e){return e?0:2}var zl=z(),Bl=O(),Vl=O(),Hl=qe(),Ul=new ui,Wl=class{constructor(e,t,n,r,i){this.vertices=e,this.positionsES=t,this.offset=r,this.positions=i;let a=e.length,o=Math.floor(a/2),s=this.offset+3*o,c=n[s],l=n[s+1],u=n[s+2];this.origin=tn(c,l,u);let d=this.offset+3*a;for(let e=this.offset;e<d;e+=3)i[e]=n[e]-c,i[e+1]=n[e+1]-l,i[e+2]=n[e+2]-u;this.updatePathVertexInformation()}updatePathVertexInformation(){let e=this.vertices.length,t=this.vertices[0],n=this.offset,r=this.positions;t.vRight[0]=r[n+3]-r[n],t.vRight[1]=r[n+4]-r[n+1],t.vRight[2]=r[n+5]-r[n+2],n+=3;let i=Ie(t.vRight);t.vMinSiblingLength=i,L(t.vRight,t.vRight);let a=t;for(let t=1;t<e;++t){let o=this.vertices[t];if(o.vLeft=a.vRight,t<e-1){o.vRight[0]=r[n+3]-r[n],o.vRight[1]=r[n+4]-r[n+1],o.vRight[2]=r[n+5]-r[n+2];let e=Ie(o.vRight);o.vMinSiblingLength=Math.min(i,e),i=e,L(o.vRight,o.vRight)}else E(o.vRight,o.vLeft),o.vMinSiblingLength=i;a=o,n+=3}}},Gl=class{constructor(e,t,n,r,i,a={}){this.path=e,this.profile=t,this.extruder=n,this.startCap=r,this.endCap=i,this.options=a,this._extrusionVertexCount=0;let o=this.path.vertices.length-2;this.numExtrusionProfiles=n.numProfilesPerJoin()*o+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.startCap.vertexBufferStart=this.numVerticesTotal;let s=this.startCap.numVertices;this.numVerticesTotal+=s,this.endCap.vertexBufferStart=this.numVerticesTotal;let c=this.endCap.numVertices;this.numVerticesTotal+=c,this.pathVertexData=Cn(1*this.numVerticesTotal),this.profileRightAxes=io(2*this.numVerticesTotal),this.profileUpAxes=io(2*this.numVerticesTotal),this.profileVertexAndNormals=pa(4*this.numVerticesTotal),this.profileAuxData=pa(3*this.numVerticesTotal),this.positions=wi(e.positions,e.offset,3*e.vertices.length),this._rebuildGeometry(),this._buildTopology()}emitVertex(e,t,n,r,i){let a=4*this._extrusionVertexCount;if(this.profileVertexAndNormals[a]=n[0],this.profileVertexAndNormals[a+1]=n[1],this.profileVertexAndNormals[a+2]=r[0],this.profileVertexAndNormals[a+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,a=3*this._extrusionVertexCount,i){let t=this.path.vertices[e],n=t.maxStretchDistance;this.profileAuxData[a]=t.rotationRight[0]*n,this.profileAuxData[a+1]=t.rotationRight[1]*n}else this.profileAuxData[a]=this.profileAuxData[a+1]=0;this.profileAuxData[a+2]=0,ao(this.profileRightAxes,this._extrusionVertexCount,t.right[0],t.right[1],t.right[2]),ao(this.profileUpAxes,this._extrusionVertexCount,t.up[0],t.up[1],t.up[2]),++this._extrusionVertexCount}emitCapVertex(e,t,n,r,i,a){let o=4*this._extrusionVertexCount;this.profileVertexAndNormals[o]=n[0],this.profileVertexAndNormals[o+1]=n[1],this.profileVertexAndNormals[o+2]=r[0],this.profileVertexAndNormals[o+3]=r[1],o=3*this._extrusionVertexCount,this.profileAuxData[o]=i,this.profileAuxData[o+1]=a,this.profileAuxData[o+2]=1,ao(this.profileRightAxes,this._extrusionVertexCount,t.right[0],t.right[1],t.right[2]),ao(this.profileUpAxes,this._extrusionVertexCount,t.up[0],t.up[1],t.up[2]),this.pathVertexData[this._extrusionVertexCount]=e,++this._extrusionVertexCount}_rebuildGeometry(){this._extrusionVertexCount=0;let{positions:e,offset:t,vertices:n}=this.path;this.positions=wi(e,t,3*n.length);let r=0,i=(e,t,n,i,a)=>this.emitCapVertex(r,e,t,n,i,a),a=(e,t,n,i)=>this.emitVertex(r,e,t,n,i);for(this.startCap.rebuildConnectingProfileGeometry(n[r],this.profile,i),r=1;r<n.length-1;++r)this.extruder.extrude(n[r],this.profile,a);this.endCap.rebuildConnectingProfileGeometry(n[r],this.profile,i),r=0,this.startCap.rebuildCapGeometry(n[r],i),r=n.length-1,this.endCap.rebuildCapGeometry(n[r],i)}_buildTopology(){let e=this.profile.vertices.length,t=this.profile.numSegments,n=this.numExtrusionProfiles-1,r=3*(2*(t*n));this.startCap.indexBufferStart=r,this.startCap.firstProfileVertexIndex=0,r+=this.startCap.numIndices,this.endCap.indexBufferStart=r,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1);let i=[],a=[],o=(e,t,n)=>{i.push(e),i.push(t),i.push(n),a.push(this.pathVertexData[e]),a.push(this.pathVertexData[t]),a.push(this.pathVertexData[n])};for(let r=0;r<t;++r){let t=this.profile.indices[2*r],i=this.profile.indices[2*r+1];for(let r=0;r<n;++r){let n=r*e+t,a=(r+1)*e+i,s=r*e+i;o(n,(r+1)*e+t,a),o(n,a,s)}}this.startCap.buildTopology(this.path.vertices[0],o),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],o),this.vertexIndices=Sn(i),this.pathVertexIndices=Sn(a)}onPathChanged(){this._rebuildGeometry()}},Kl=class{rebuildConnectingProfileGeometry(e,t,n){for(let r=0;r<t.vertices.length;++r)n(e.frame,t.vertices[r],t.normals[r],0,0)}},ql=class extends Kl{constructor(){super(),this.numVertices=0,this.numIndices=0}rebuildCapGeometry(){}buildTopology(){}},Jl=class extends Kl{constructor(e,t=0,n=!1){super(),this.profile=e,this.profilePlaneOffset=t,this.flip=n}get numVertices(){return this.profile.vertices.length}get numIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,n){let r=this.profilePlaneOffset;for(let i=0;i<t.vertices.length;++i)n(e.frame,t.vertices[i],t.normals[i],r,0)}rebuildCapGeometry(e,t){let n=this.profile,r=this.flip?1:-1,i=this.profilePlaneOffset,a=Zl;S(a,0,0);for(let o=0;o<n.vertices.length;++o)t(e.frame,n.vertices[o],a,i,r)}buildTopology(e,t){let n=this.profile,r=this.vertexBufferStart+n.indices[0];for(let e=1;e<n.numSegments;++e){let i=n.indices[2*e],a=n.indices[2*e+1],o=this.vertexBufferStart+i,s=this.vertexBufferStart+a;this.flip?t(s,o,r):t(r,o,s)}}},Yl=class extends Kl{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}get numVertices(){let e=this.profile.vertices.length*(this.numSegments-1)+this.profile.poles.length;return this.breakNormals&&(e+=this.profile.vertices.length),e}get numIndices(){let e=0,t=this.profile;e+=2*t.numSegments*(this.numSegments-1);for(let n=0;n<t.numSegments;++n){let r=t.indices[2*n],i=t.indices[2*n+1];t.poleIndices[r]===t.poleIndices[i]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){let n=this.profile,r=e.frame,i=.5*this.sign,a=Xl,o=Zl;S(o,0,0);for(let e of n.poles)e.normal?t(r,e.position,e.normal,i,0):t(r,e.position,o,i,this.sign);if(this.breakNormals)for(let e=0;e<n.vertices.length;++e)t(r,n.vertices[e],n.normals[e],0,0);for(let e=0;e<this.numSegments-1;++e){let s=(1-(e+1)/this.numSegments)*Math.PI*.5,c=Math.sin(s),l=Math.cos(s);for(let e=0;e<n.vertices.length;++e){let s=n.poles[n.poleIndices[e]];Tt(a,n.vertices[e],s.position),_e(a,a,c),s.normal?(cn(a,a,s.position),t(r,a,s.normal,i*l,0)):(u(o,a),_e(o,o,c),cn(a,a,s.position),t(r,a,o,i*l,this.sign*l))}}}buildTopology(e,t){let n=this.profile,r=this.breakNormals?this.vertexBufferStart+n.poles.length:this.firstProfileVertexIndex,i=this.breakNormals?this.vertexBufferStart+n.poles.length+n.vertices.length:this.vertexBufferStart+n.poles.length;for(let e=0;e<n.numSegments;++e){let a=n.indices[2*e],o=n.indices[2*e+1],s=this.vertexBufferStart+n.poleIndices[a],c=this.vertexBufferStart+n.poleIndices[o],l=r+a,u=r+o;for(let e=0;e<this.numSegments-1;++e){let r=i+e*n.vertices.length+a,s=i+e*n.vertices.length+o;this.flip?(t(r,u,l),t(u,r,s)):(t(l,u,r),t(s,r,u)),l=r,u=s}this.flip?(t(s,u,l),s!==c&&t(s,c,u)):(t(l,u,s),s!==c&&t(u,c,s))}}},Xl=M(),Zl=M(),Ql=class{numProfilesPerJoin(){return 1}extrude(e,t,n){for(let r=0;r<t.vertices.length;++r)n(e.frame,t.vertices[r],t.normals[r],!1)}},$l=class{constructor(e,t){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,n){let r=iu,{rotationAngle:i,rotationRight:a,frame:o}=e;if(Math.abs(i)>=this.cutoffAngle){let s=e.rotationFrameUp;for(let c=0;c<this.numBendSubdivisions+1;++c){Ue(ru,.5*-i+c*i/this.numBendSubdivisions,s),tu(r,o,ru);for(let s=0;s<t.vertices.length;++s)St(t.vertices[s],a)*i>=0?n(r,t.vertices[s],t.normals[s],!1):n(o,e.applyMiterStretch(nu,t.vertices[s]),t.normals[s],!0)}}else for(let r=0;r<this.numBendSubdivisions+1;++r)for(let r=0;r<t.vertices.length;++r){let s=St(t.vertices[r],a)*i>=0;n(o,e.applyMiterStretch(nu,t.vertices[r]),t.normals[r],!s)}}},eu=class{constructor(){this.up=z(),this.right=z()}};function tu(e,t,n){P(e.up,t.up,n),P(e.right,t.right,n)}var nu=M(),ru=O(),iu=new eu,au=class extends Kr{constructor(e,t,n,r,i,a){super(e,t,null,0,a),this.path=n,this.geometrySR=r,this.stencilWidth=i}};function ou(e){return`path`in e}var su=class{constructor(e){this.builder=e}onPathChanged(e){this.builder.onPathChanged()}},cu=class extends su{constructor(e){super(e),this.color=Se(255,255,255,255),this._size=M(),this.positions=Ti(3*this.builder.numVerticesTotal),this.normals=new Int16Array(2*this.builder.numVerticesTotal)}bakeVertexColors(e){Nt(this.color,e)}bake(e){Ee(this._size,e);let{numVerticesTotal:t,pathVertexData:n,positions:r,profileRightAxes:i,profileUpAxes:a,profileVertexAndNormals:o,profileAuxData:s}=this.builder;for(let c=0;c<t;++c){let t=n[c];t*=3;let l=pu,d=0,f=0,p=oo(mu,i,c),m=oo(hu,a,c),h=4*c,g=S(uu,o[h]*e[0],o[h+1]*e[1]),_=3*c;if(s[_+2]===1)be(l,m,p),d=s[_]*e[0],f=s[_+1];else{let e=du,t=fu;S(e,s[_],s[_+1]);let n=fe(e);u(e,e);let r=St(g,e);if(Math.abs(r)>n){S(t,-e[1],e[0]);let i=St(g,t);_e(e,e,n*Math.sign(r)),_e(t,t,i),cn(g,e,t)}A(l,0,0,0)}let v=p[0]*g[0]+m[0]*g[1],y=p[1]*g[0]+m[1]*g[1],b=p[2]*g[0]+m[2]*g[1];this.positions[_]=r[t]+v+l[0]*d,this.positions[_+1]=r[t+1]+y+l[1]*d,this.positions[_+2]=r[t+2]+b+l[2]*d;let x=o[h+2],C=o[h+3];ao(this.normals,c,p[0]*x+m[0]*C+l[0]*f,p[1]*x+m[1]*C+l[1]*f,p[2]*x+m[2]*C+l[2]*f)}}createGeometryData(){let e=this.builder.vertexIndices;return[[`position`,new B(this.positions,e,3,!0)],[`normalCompressed`,new B(this.normals,e,2,!0)],[`color`,new B(this.color,xn(e.length),4,!0)]]}onPathChanged(e){super.onPathChanged(e),this.bake(this.size)}intersect(e,t,n,r){let i=this.builder.vertexIndices,a=new er(this.positions,3),o=i.length/3;Yr(e,t,0,o,i,a,void 0,n,(e,t,n)=>r(e,n,t))}get size(){return this._size}},lu=class extends su{constructor(e,t,n,r){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=n,this.opacityAttributeValue=r,this.baked=new cu(e),this._vvSize=Ti(this.builder.path.vertices.length).fill(t),this._vvColor=pa(this.builder.path.vertices.length).fill(n),this._vvOpacity=pa(this.builder.path.vertices.length).fill(r)}createGeometryData(){let e=this.builder,{pathVertexIndices:t,vertexIndices:n}=e;return[[`position`,new B(e.positions,t,3,!0)],[`profileVertexAndNormal`,new B(e.profileVertexAndNormals,n,4,!0)],[`profileAuxData`,new B(e.profileAuxData,n,3,!0)],[`profileRight`,new B(e.profileRightAxes,n,2,!0)],[`profileUp`,new B(e.profileUpAxes,n,2,!0)],[`sizeFeatureAttribute`,new B(this._vvSize,t,1,!0)],[`colorFeatureAttribute`,new B(this._vvColor,t,1,!0)],[`opacityFeatureAttribute`,new B(this._vvOpacity,t,1,!0)]]}onPathChanged(e){super.onPathChanged(e);let t=e.getMutableAttribute(`position`);t&&(t.data=this.builder.positions)}},uu=M(),du=M(),fu=M(),pu=z(),mu=z(),hu=z();function gu(e,t){let n=null,r=e.vertices.length,i=.99619469809,a=z(),o=z(),s=z(),c=z(),l=z(),u=z(),d=jn(),f=e.vertices[0];E(o,t),A(a,0,1,0),ca(f.vRight,o,a,a,s,o,i),E(f.frame.up,o),E(f.frame.right,s);let p=e.positions,m=e.offset;n=f;for(let t=1;t<r;++t){f=e.vertices[t],j(l,f.vLeft,f.vRight);let r=Ie(l);r>0?(r=1/Math.sqrt(r),l[0]*=r,l[1]*=r,l[2]*=r):(l[0]=f.vRight[0],l[1]=f.vRight[1],l[2]=f.vRight[2]),u[0]=p[m]+n.frame.up[0],u[1]=p[m+1]+n.frame.up[1],u[2]=p[m+2]+n.frame.up[2],m+=3;let h=A(_u,p[m],p[m+1],p[m+2]);On(h,l,d),Tn(d,fr(u,f.vLeft),c)?(c[0]-=p[m],c[1]-=p[m+1],c[2]-=p[m+2],L(o,c),be(s,l,o),L(s,s)):ca(l,n.frame.up,n.frame.right,a,s,o,i),E(f.frame.up,o),E(f.frame.right,s),n=f}}var _u=z(),vu=class{constructor(){this.vertices=[],this.normals=[],this.indices=[],this.poles=[],this.poleIndices=[]}addVertex(e,t){return this.vertices.push(Bt(e)),this.normals.push(Bt(t)),this.vertices.length-1}addPole(e,t=null){return this.poles.push({position:Bt(e),normal:t?Bt(t):null}),this.poles.length-1}addSegment(e,t=null){this.indices.push(e.v0),this.indices.push(e.v1),t&&(this.poleIndices.push(t.v0),this.poleIndices.push(t.v1))}get numSegments(){return this.indices.length/2}translate(e,t){for(let n of this.vertices)n[0]+=e,n[1]+=t;for(let n of this.poles)n.position[0]+=e,n.position[1]+=t}get usedMemory(){return this.vertices.length*fn(this.vertices[0])*2+fn(this.indices)}},yu={top:[0,-.5],bottom:[0,.5]};function bu(e){let t=.5,n=new vu,r={v0:0,v1:0};n.addPole(T(0,0));for(let e=0;e<10;++e){let r=2*e*Math.PI/10,i=Math.cos(r),a=Math.sin(r),o=T(i*t,a*t),s=T(i,a);n.addVertex(o,s)}for(let e=0;e<9;++e){let t={v0:e,v1:e+1};n.addSegment(t,r)}if(n.addSegment({v0:9,v1:0},r),e!==`center`){let t=yu[e];n.translate(t[0],t[1])}return n}var xu={center:bu(`center`),top:bu(`top`),bottom:bu(`bottom`)},Su={center:Cu(`center`),top:Cu(`top`),bottom:Cu(`bottom`)};function Cu(e){let t=new vu,n=T(.5*-1,.5*-1),r=T(.5*1,.5*-1),i=T(.5*1,.5*1),a=T(.5*-1,.5*1),o=T(0,-1),s=T(1,0),c=T(0,1),l=T(-1,0);if(t.addPole(T(0,.5*1),c),t.addPole(T(0,.5*1)),t.addPole(T(0,.5*-1)),t.addPole(T(0,.5*-1),o),t.addVertex(n,o),t.addVertex(r,o),t.addSegment({v0:0,v1:1},{v0:3,v1:3}),t.addVertex(r,s),t.addVertex(i,s),t.addSegment({v0:2,v1:3},{v0:2,v1:1}),t.addVertex(i,c),t.addVertex(a,c),t.addSegment({v0:4,v1:5},{v0:0,v1:0}),t.addVertex(a,l),t.addVertex(n,l),t.addSegment({v0:6,v1:7},{v0:1,v1:2}),e!==`center`){let n=yu[e];t.translate(n[0],n[1])}return t}function wu(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function Tu(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e}function Eu(e,t,n,r,i){return e[0]=t,e[1]=n,e[2]=r,e[3]=i,e}function Du(e,t){if(e===t){let n=t[1];e[1]=t[2],e[2]=n}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e}function Ou(e,t){let n=t[0],r=t[1],i=t[2],a=t[3],o=n*a-i*r;return o?(o=1/o,e[0]=a*o,e[1]=-r*o,e[2]=-i*o,e[3]=n*o,e):null}function ku(e,t){let n=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=n,e}function Au(e){return e[0]*e[3]-e[2]*e[1]}function ju(e,t,n){let r=t[0],i=t[1],a=t[2],o=t[3],s=n[0],c=n[1],l=n[2],u=n[3];return e[0]=r*s+a*c,e[1]=i*s+o*c,e[2]=r*l+a*u,e[3]=i*l+o*u,e}function Mu(e,t,n){let r=t[0],i=t[1],a=t[2],o=t[3],s=Math.sin(n),c=Math.cos(n);return e[0]=r*c+a*s,e[1]=i*c+o*s,e[2]=r*-s+a*c,e[3]=i*-s+o*c,e}function Nu(e,t,n){let r=t[0],i=t[1],a=t[2],o=t[3],s=n[0],c=n[1];return e[0]=r*s,e[1]=i*s,e[2]=a*c,e[3]=o*c,e}function Pu(e,t){let n=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=n,e[2]=-n,e[3]=r,e}function Fu(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e}function Iu(e){return`mat2(`+e[0]+`, `+e[1]+`, `+e[2]+`, `+e[3]+`)`}function Lu(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)}function Ru(e,t,n,r){return e[2]=r[2]/r[0],n[0]=r[0],n[1]=r[1],n[3]=r[3]-e[2]*n[1],[e,t,n]}function zu(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e[3]=t[3]+n[3],e}function Bu(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e[3]=t[3]-n[3],e}function Vu(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function Hu(e,t){let n=e[0],r=e[1],i=e[2],a=e[3],o=t[0],s=t[1],c=t[2],l=t[3],u=ee();return Math.abs(n-o)<=u*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-s)<=u*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-c)<=u*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(a-l)<=u*Math.max(1,Math.abs(a),Math.abs(l))}function Uu(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e}function Wu(e,t,n,r){return e[0]=t[0]+n[0]*r,e[1]=t[1]+n[1]*r,e[2]=t[2]+n[2]*r,e[3]=t[3]+n[3]*r,e}var Gu=ju,Ku=Bu;Object.freeze(Object.defineProperty({__proto__:null,LDU:Ru,add:zu,adjoint:ku,copy:wu,determinant:Au,equals:Hu,exactEquals:Vu,frob:Lu,fromRotation:Pu,fromScaling:Fu,identity:Tu,invert:Ou,mul:Gu,multiply:ju,multiplyScalar:Uu,multiplyScalarAndAdd:Wu,rotate:Mu,scale:Nu,set:Eu,str:Iu,sub:Ku,subtract:Bu,transpose:Du},Symbol.toStringTag,{value:`Module`}));function qu(){return[1,0,0,1]}function Ju(e){return[e[0],e[1],e[2],e[3]]}function Yu(e,t,n,r){return[e,t,n,r]}Object.freeze(Object.defineProperty({__proto__:null,clone:Ju,create:qu,fromValues:Yu},Symbol.toStringTag,{value:`Module`}));var Xu=class{constructor(){this.vLeft=z(),this.vRight=z(),this.vMinSiblingLength=0,this.frame=new eu}setFrameFromUpVector(e){E(this.frame.up,e),j(ld,this.vLeft,this.vRight),L(ld,ld),k(cd,this.frame.up,R(ld,this.frame.up)),I(ud,ld,cd),L(ud,ud),be(this.frame.right,ud,this.frame.up)}get foldingAngle(){return Math.PI-this.rotationAngle}},Zu=class extends Xu{get rotationFrameUp(){return this.frame.up}get rotationRight(){return de}get rotationAngle(){return k(od,this.frame.up,R(this.frame.up,this.vLeft)),I(od,this.vLeft,od),ue(od,od),L(od,od),k(sd,this.frame.up,R(this.frame.up,this.vRight)),I(sd,this.vRight,sd),L(sd,sd),be(ad,this.rotationFrameUp,this.vLeft),Math.sign(R(ad,this.vRight))*(Math.PI-yt(R(od,sd)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength/Math.cos(.5*this.foldingAngle))}applyMiterStretch(e,t){let n=this.rotationAngle;if(Math.abs(n)<=0)return t;let r=rt(Math.cos(.5*n));return S(e,(r-1+1)*t[0],t[1])}},Qu=class extends Xu{get rotationFrameUp(){let e=Math.sign(R(this.frame.right,this.vRight));return be(td,this.vRight,this.vLeft),k(td,td,e),L(td,td)}get rotationRight(){let e=this.rotationFrameUp,t=R(e,this.frame.up),n=R(e,this.frame.right);return k(rd,this.frame.up,-n),k(id,this.frame.right,t),j(rd,rd,id),L(rd,rd),$u(nd,this.frame,rd),nd}get rotationAngle(){let e=Math.sign(R(this.frame.right,this.vRight));return ue(ad,this.vLeft),-e*(Math.PI-yt(R(ad,this.vRight)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength*rt(Math.cos(.5*this.foldingAngle)))}applyMiterStretch(e,t){let n=this.rotationAngle;if(Math.abs(n)===0)return t;let r=rt(Math.cos(.5*n)),i=this.rotationRight,a=Eu(dd,1+(r-1)*i[0]*i[0],(r-1)*i[0]*i[1],(r-1)*i[0]*i[1],1+(r-1)*i[1]*i[1]);return g(e,t,a)}};function $u(e,t,n){S(e,R(n,t.right),R(n,t.up))}function ed(e){switch(e){case 0:return new Zu;case 1:return new Qu}}var td=z(),nd=M(),rd=z(),id=z(),ad=z(),od=z(),sd=z(),cd=z(),ld=z(),ud=z(),dd=qu(),fd=class extends Co{constructor(){super(...arguments),this.ambient=Qe(.2,.2,.2),this.diffuse=Qe(.8,.8,.8),this.opacity=1,this.origin=z(),this.modelTransformation=null,this.mrrFactors=ro,this.emissiveStrengthFromSymbol=0,this.emissiveSource=1,this.emissiveBaseColor=gt}get emissiveStrength(){return this.emissiveStrengthFromSymbol}},pd=class extends vi{constructor(e,n){super(e,n,Ei(md(n))),this.shader=new xi(So,()=>t(()=>import(`./Path.glsl-dxrULuNJ.js`),__vite__mapDeps([57,58,2,3,21,22,23,55,41,35,27,59,45,34,29,37,46,43,25,26,28,60,33,42,38,61,62,63,64,40,65,66,47,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,39,32,36,30,44])))}initializePipeline(e){let{output:t,hasEmission:n,transparent:r,hasSlicePlane:i,doubleSidedMode:a,hasOccludees:o,oitPass:s}=e,c=s===0,l=s===2;return Or({blending:V(t)&&r?Rr(s):null,culling:i&&!r&&a!==0?Dr:null,depthTest:Pr(s),depthWrite:c||l?Er:null,drawBuffers:yi(t,Br(s,n)),colorWrite:Tr,stencilWrite:o?ei:null,stencilTest:o?Hr:null,polygonOffset:c||l?null:Ir})}};function md(e){let t=Ci().vec3f(`position`).vec4f16(`profileVertexAndNormal`).vec2i16(`profileRight`,{glNormalized:!0}).vec2i16(`profileUp`,{glNormalized:!0});return e.hasVVSize&&t.f32(`sizeFeatureAttribute`),e.hasVVColor&&t.f32(`colorFeatureAttribute`),e.hasVVOpacity&&t.f32(`opacityFeatureAttribute`),Ki()&&t.vec4u8(`olidColor`),t.vec3f16(`profileAuxData`),t.freeze()}pd=F([Fe(`esri.views.3d.webgl-engine.materials.PathTechnique`)],pd);var Z=class extends Lr{constructor(e){super(),this.spherical=e,this.pbrMode=0,this.doubleSidedMode=0,this.emissionSource=0,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.transparent=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.snowCover=!1,this.textureCoordinateType=0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.draped=!1,this.overlayEnabled=!1}get discardInvisibleFragments(){return this.transparent}};F([H({count:7})],Z.prototype,`pbrMode`,void 0),F([H({count:3})],Z.prototype,`doubleSidedMode`,void 0),F([H({count:8})],Z.prototype,`emissionSource`,void 0),F([H()],Z.prototype,`receiveShadows`,void 0),F([H()],Z.prototype,`receiveAmbientOcclusion`,void 0),F([H()],Z.prototype,`hasVVSize`,void 0),F([H()],Z.prototype,`hasVVColor`,void 0),F([H()],Z.prototype,`hasVVOpacity`,void 0),F([H()],Z.prototype,`transparent`,void 0),F([H()],Z.prototype,`hasOccludees`,void 0),F([H()],Z.prototype,`terrainDepthTest`,void 0),F([H()],Z.prototype,`cullAboveTerrain`,void 0),F([H()],Z.prototype,`snowCover`,void 0);var hd=class extends Nr{constructor(e,t){super(e,vd),this.supportsEdges=!0,this._pp0=tn(0,0,1),this._pp1=tn(0,0,0),this.produces=new Map([[2,e=>(this.parameters.castShadows&&nr(e)||ar(e))&&!this.transparent],[4,e=>(this.parameters.castShadows&&nr(e)||ar(e))&&this.transparent]]),this._configuration=new Z(t.spherical)}get hasEmissions(){return this.parameters.emissiveStrength>0}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.transparent,this._configuration.hasOccludees=t.hasOccludees,V(e)?(this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType===`normal`?1:this.parameters.doubleSided&&this.parameters.doubleSidedType===`winding-order`?2:0,this._configuration.receiveShadows=t.shadowMap.enabled,this._configuration.receiveAmbientOcclusion=t.ssao!=null):this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=!1,this._configuration.pbrMode=this.parameters.usePBR?2:0,this._configuration.emissionSource=this.parameters.usePBR?1:0,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.snowCover=t.snowCover>0,this._configuration}isVisibleForOutput(e){return e!==3&&e!==5&&e!==4||this.parameters.castShadows}get visible(){return this.parameters.opacity>=$i}intersect(e,t,n,r,i,a){this._intersect(e,n,r,i,a)}intersectDraped(e,t,n,r){return this._pp0[0]=this._pp1[0]=n[0],this._pp0[1]=this._pp1[1]=n[1],this._intersect(e,t,this._pp0,this._pp1,r)}_intersect(e,t,n,r,i){let a=e;if(!ou(a))return;let o=a.path,s=Bt(this.parameters.size);if(this.parameters.vvSize){let{offset:e,factor:t,minSize:n,maxSize:r,fallback:i}=this.parameters.vvSize,a=o.sizeAttributeValue;Number.isNaN(a)?(s[0]*=i[0],s[1]*=i[2]):(s[0]*=en(e[0]+a*t[0],n[0],r[0]),s[1]*=en(e[2]+a*t[2],n[2],r[2]))}let c=new Gr(t.tolerance,!1,t.options.normalRequired),l=Math.max(s[0],s[1]),u=e.boundingInfo;if(u==null)return void _d(o,s,n,r,c,i);let d=pe(u.bbMin[0]-l,u.bbMin[1]-l,u.bbMin[2]-l,u.bbMax[0]+l,u.bbMax[1]+l,u.bbMax[2]+l),f=[r[0]-n[0],r[1]-n[1],r[2]-n[2]],p=Math.sqrt(f[0]*f[0]+f[1]*f[1]+f[2]*f[2]),m=[p/f[0],p/f[1],p/f[2]];Zr(d,n,m,t.tolerance)&&_d(o,s,n,r,c,i)}createBufferWriter(){return new $r(md(this.parameters))}createGLMaterial(e){return new gd(e)}get transparent(){let{parameters:e}=this;return e.drivenOpacity||e.opacity<1}},gd=class extends ir{beginSlot(e){return this.getTechnique(pd,e)}};function _d(e,t,n,r,i,a){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(n,r,i,a)}var vd=class extends fd{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType=`normal`,this.castShadows=!0,this.hasSlicePlane=!1,this.drivenOpacity=!1,this.usePBR=!1}},yd=[`polyline`],bd=class extends Ba{constructor(e,t,n,r){super(e,t,n,r,Td(t)),this._intrinsicSize=T(1,1),this._upVectorAlignment=1,this._stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){let e=this.symbolLayer,t=e.width==null?e.height:e.width,r=e.height==null?t:e.height;this._vvConvertOptions=new Wi({supports:{size:!0,color:!0,rotation:!1,opacity:!0},modelSize:[1,1,1],symbolSize:[t,1,r],unitInMeters:this._context.renderCoordsHelper.unitInMeters,fallbackColor:this._getFallbackOpacityAndColor(La),fallbackSize:[t,1,r]}),this._fastUpdates=this._context.renderer?.visualVariables?.length?Xi(this._context.renderer,this._vvConvertOptions):null;let i=e.anchor||`center`;this._upVectorAlignment=e.profileRotation===`heading`?0:1;let a=e.profile||`circle`;switch(a){default:case`circle`:this._profile=xu[i];break;case`quad`:this._profile=Su[i]}switch(e.join){case`round`:this._extruder=new $l(0,3);break;case`bevel`:this._extruder=new $l(0,1);break;case`miter`:this._extruder=new $l(.8*Math.PI,1);break;default:this._extruder=new Ql}switch(this._cap){case`none`:this._startCap=new ql,this._endCap=new ql;break;case`butt`:default:this._startCap=new Jl(this._profile,0),this._endCap=new Jl(this._profile,0,!0);break;case`square`:this._startCap=new Jl(this._profile,-.5),this._endCap=new Jl(this._profile,.5,!0);break;case`round`:{let e=a===`quad`;this._startCap=new Yl({profile:this._profile,flip:!1,breakNormals:e,subdivisions:3}),this._endCap=new Yl({profile:this._profile,flip:!0,breakNormals:e,subdivisions:3});break}}let o=this._materialColor,s=this._getCombinedOpacityAndColor(o),c=Qt(s),l=s[3],u=this.needsDrivenTransparentPass,d=e.material?.emissive,f={diffuse:c,ambient:c,emissiveStrengthFromSymbol:d?.strength??0,emissiveSource:1,opacity:l,drivenOpacity:u,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(S(this._intrinsicSize,t,r),!va(this._intrinsicSize[0])||!va(this._intrinsicSize[1])))throw new n(`graphics3dpathsymbollayer:invalid-size`,`Symbol sizes may not be negative values`);let p;this._fastUpdates?.visualVariables.size||_e(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates?p=new hd({...f,...this._fastUpdates.materialParameters,size:Be(this._intrinsicSize)},this._context):(f.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,f.normalType=1,p=new Qa(f,this._context)),p.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._materials[0]=p,this._updateTransparentDepedentMaterialParameters()}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,yd,this.symbolLayer.type))return null;let n=this.createElevationContextForGraphic(t);return this._createAs3DShape(e,n)}layerOpacityChanged(){let e=this._materialColor,t=this._getCombinedOpacity(e),n=this._materials[0];n&&(n.setParameters({opacity:t}),this._updateTransparentDepedentMaterialParameters())}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,fi)}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._materials[0]?.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}applyRendererDiff(e,t){for(let n in e.diff){if(n!==`visualVariables`||!Zi(this._fastUpdates,t,this._vvConvertOptions))return 0;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return 2}_getVertexData(e){let t=0,n=e.paths,r=[],i=e.spatialReference,a=this._context.elevationProvider.spatialReference,o=this._context.renderCoordsHelper.spatialReference;for(let e of n)t+=e.length;let s=Ne(3*t),c,l=0;for(let t of n){r.push({offset:l,numVertices:t.length});for(let n of t)s[l++]=n[0],s[l++]=n[1],s[l++]=e.hasZ?n[2]:0}return a==null||i.equals(a)||kt(s,i,0,s,a,0,t)?(a==null||a.equals(o)?c=le(s):(c=Ne(3*t),kt(s,a,0,c,o,0,t)),{pathVertexDataInfos:r,vertexDataES:s,vertexDataRS:c}):null}_createAs3DShape(e,t){let{graphic:n,renderingInfo:r}=e,i=n.geometry,a=this._getVertexData(i);if(a==null)return this.logger.warn(`PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)`),null;if(a.pathVertexDataInfos.length===0)return i.paths.length!==0&&i.paths.some(e=>e.length>0)||this.logger.warn(`PathSymbol3DLayer geometry failed to be created (no paths were defined)`),null;let s=[],c=i.spatialReference,l=o(),u=this._context.renderCoordsHelper,d=new si(a.vertexDataES),f=n.uid,p=Ti(a.vertexDataRS.length);for(let e of a.pathVertexDataInfos){let i=e.numVertices;if(i<2)continue;let o=e.offset;if(this._context.clippingExtent!=null&&(xe(a.vertexDataES,o,i,l),!at(l,this._context.clippingExtent)))continue;let m=[],h=o+3*i;for(let e=o;e<h;e+=3){d.offset=e;let n=oi(d,this._context.elevationProvider,t,u);A(Q,a.vertexDataRS[e],a.vertexDataRS[e+1],a.vertexDataRS[e+2]),u.setAltitude(Q,n),a.vertexDataRS[e]=Q[0],a.vertexDataRS[e+1]=Q[1],a.vertexDataRS[e+2]=Q[2],m.push(ed(this._upVectorAlignment))}let g=new Wl(m,a.vertexDataES,a.vertexDataRS,o,p);xd(g,this._upVectorAlignment,this._context.renderCoordsHelper);let _=new Gl(g,this._profile,this._extruder,this._startCap,this._endCap),v=null;if(this._fastUpdates){let e=this._fastUpdates.visualVariables,t=Yi(e.size?.field,n),r=Yi(e.color?.field,n),i=Yi(e.opacity?.field,n);v=new lu(_,t,r,i)}else{let e=Bt(this._intrinsicSize);if(this._drivenProperties.size){let t=r.size??[`symbol-value`,`symbol-value`,`symbol-value`];e[0]*=Sd(t[0],t[2]===`symbol-value`?this.symbolLayer.height||0:t[2],this.symbolLayer.width||0),e[1]*=Sd(t[2],t[0]===`symbol-value`?this.symbolLayer.width||0:t[0],this.symbolLayer.height||0)}let t=new cu(_);t.bake(e);let n=this._getDrivenColor(r);n&&t.bakeVertexColors(n),v=t}let y=v.createGeometryData(),b=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:f,layerViewUid:this._context.layerViewUid}),x=new au(this._materials[0],y,v,c,this._stencilWidth,b);x.transformation=ze(O(),He,_.path.origin),s.push(x)}if(s.length===0)return null;let m=new mi({geometries:s,layerViewUid:this._context.layerViewUid,graphicUid:f}),h=new Ha(this,m,null,(e,t,n,r,i)=>wd(e,t,r,i,this._upVectorAlignment),t,null);return h.alignedSampledElevation=0,h.needsElevationUpdates=fi(t.mode),h}_getDrivenColor(e){return this._hasDrivenColorOrOpacity?this._getDrivenUInt8ColorWithNaNSupport(e,this._materialColor,!1):null}get _materialColor(){return this.symbolLayer.material?.color}_getFallbackOpacityAndColor(e){return this._materialColor?.toUnitRGBA()??e}get _cap(){return this.symbolLayer.cap||`butt`}_updateTransparentDepedentMaterialParameters(){let e=this._materials[0];e&&e.setParameters({cullFace:e.transparent||this._cap===`none`?0:2})}};function xd(e,t,n){let{origin:r,positions:i}=e,a=e.offset;switch(t){default:case 0:for(let t of e.vertices)Q[0]=i[a++]+r[0],Q[1]=i[a++]+r[1],Q[2]=i[a++]+r[2],n.worldUpAtPosition(Q,Q),t.setFrameFromUpVector(Q);break;case 1:Q[0]=i[a]+r[0],Q[1]=i[a+1]+r[1],Q[2]=i[a+2]+r[2],n.worldUpAtPosition(Q,Q),gu(e,Q)}}function Sd(e,t,n){switch(e){case`symbol-value`:return n;case`proportional`:return t;default:return e}}function Cd(e,t,n,r){let i=0,{origin:a,vertices:o,positions:s,positionsES:c}=e,l=e.offset+3*o.length;for(let t=e.offset;t<l;t+=3)A(Q,c[t],c[t+1],c[t+2]),n(Q,Ed),i+=Ed.sampledElevation,Q[0]=s[t]+a[0],Q[1]=s[t+1]+a[1],Q[2]=s[t+2]+a[2],r.setAltitude(Q,Ed.z),s[t]=Q[0]-a[0],s[t+1]=Q[1]-a[1],s[t+2]=Q[2]-a[2];return e.updatePathVertexInformation(),i/o.length}function wd(e,t,n,r,i){let a=e.stageObject,o=a.geometries,s=0;for(let e of o){if(!ou(e))continue;let o=e.path,c=o.builder.path;s+=Cd(c,t,n,r),i!==0&&xd(c,i,r),o.onPathChanged(e),e.invalidateBoundingInfo(),a.geometryVertexAttributeUpdated(e,`position`)}return s/o.length}function Td(e){return(e.material?.color?.a??0)===1}var Q=z(),Ed=new ui;function Dd(e,t,n,r,i=1){if(n.isGeographic&&r===1){let e=Ne(t.length),r=t.length,i=mt(n);for(let n=0;n<r;n+=3)jt(t,n,e,n,i);t=e}S($,1/0,1/0);for(let e=0;e<t.length;e+=3)$[0]=Math.min($[0],t[e]),$[1]=Math.min($[1],t[e+1]);let a=$[0]%i,o=$[1]%i,s=$[0]-a,c=$[1]-o;for(let n=0;n<t.length;n+=3){let r=n/3*4;e[r]=(t[n]-s)/i,e[r+1]=(t[n+1]-c)/i,e[r+2]=s/i,e[r+3]=c/i}}function Od(e,t,n,r,i=1){A(Md,1,0,0),A(Nd,0,1,0),A(Pd,0,0,1),Wd(kd,n),kn(jd,n)&&zd(jd,Md,Nd,Pd,r,kd),S($,1/0,1/0),S(Fd,-1/0,-1/0);for(let e=0;e<n.length;e+=3){A(Ad,n[e],n[e+1],n[e+2]);let t=R(Md,Ad),r=R(Nd,Ad);$[0]=Math.min($[0],t),$[1]=Math.min($[1],r),Fd[0]=Math.max(Fd[0],t),Fd[1]=Math.max(Fd[1],r)}let a=R(Pd,kd);Kd(Id,$[0],$[1],a,Md,Nd,Pd),Kd(Ld,Fd[0],$[1],a,Md,Nd,Pd),Kd(Rd,$[0],Fd[1],a,Md,Nd,Pd),I(Ld,Ld,Id),k(Ld,Ld,.5),I(Rd,Rd,Id),k(Rd,Rd,.5),j(Id,Id,Ld),j(Id,Id,Rd);let o=$[0]%i,s=$[1]%i,c=$[0]-o,l=$[1]-s;for(let r=0;r<n.length;r+=3){A(Ad,n[r],n[r+1],n[r+2]);let a=r/3,o=4*a;e[o]=(R(Md,Ad)-c)/i,e[o+1]=(R(Nd,Ad)-l)/i,e[o+2]=c/i,e[o+3]=l/i;let s=9*a;for(let e=0;e<3;e++)t[s+e]=Id[e],t[s+e+3]=Ld[e],t[s+e+6]=Rd[e]}}var kd=z(),Ad=z(),jd=jn(),Md=z(),Nd=z(),Pd=z(),$=M(),Fd=M(),Id=z(),Ld=z(),Rd=z();function zd(e,t,n,r,i,a){i==null?(A(Vd,1,0,0),A(Hd,0,1,0),A(Ud,0,0,1)):(i.basisMatrixAtPosition(a,Bd),A(Vd,Bd[0],Bd[1],Bd[2]),A(Hd,Bd[4],Bd[5],Bd[6]),A(Ud,Bd[8],Bd[9],Bd[10]));let o=En(e);R(o,Ud)<0&&k(o,o,-1),E(r,o);let s=R(o,Hd),c=R(o,Vd);Math.abs(s)>Math.abs(c)?(f(t,Vd,o,-c),L(t,t),be(n,t,o),L(n,n),k(n,n,-1)):(f(n,Hd,o,-s),L(n,n),be(t,n,o),L(t,t))}var Bd=O(),Vd=z(),Hd=z(),Ud=z();function Wd(e,t){A(Gd,0,0,0);for(let e=0;e<t.length-3;e+=3)Gd[0]+=t[e],Gd[1]+=t[e+1],Gd[2]+=t[e+2];k(e,Gd,1/(t.length/3-1))}var Gd=z();function Kd(e,t,n,r,i,a,o){A(e,t*i[0]+n*a[0]+r*o[0],t*i[1]+n*a[1]+r*o[1],t*i[2]+n*a[2]+r*o[2])}var qd=class extends vi{constructor(e,n){super(e,n,Ei(Yd(n))),this.shader=new xi(wo,()=>t(()=>import(`./Pattern.glsl-DbkAOHtV.js`),__vite__mapDeps([93,94,55,2,3,41,23,35,27,22,38,34,24,21,25,26,28,29,30,61,56,39,40,32,33,36,44,45,37,46,43,47])))}_setPipelineState(e,t){let{oitPass:n,output:r,hasEmission:i,cullFace:a,draped:o,hasOccludees:s,polygonOffset:c}=e,l=n===0;return Or({blending:V(r)?Rr(n):null,culling:kr(a),depthTest:o?null:Pr(n),depthWrite:jr(e),drawBuffers:yi(r,Br(n,i)),colorWrite:Tr,stencilWrite:s?ei:null,stencilTest:s?t?Xr:Hr:null,polygonOffset:l?c?Jd:null:ni(e)})}initializePipeline(e){return this._occludeePipelineState=this._setPipelineState(e,!0),this._setPipelineState(e,!1)}getPipeline(e,t){return t?this._occludeePipelineState:super.getPipeline(e)}};qd=F([Fe(`esri.views.3d.webgl-engine.shaders.PatternTechnique`)],qd);var Jd={factor:1,units:1};function Yd(e){let t=Ci().vec3f(`position`).vec4f(`uvMapSpace`);return e.draped||t.mat3f(`boundingRect`),e.hasVVColor?t.f32(`colorFeatureAttribute`):t.vec4u8(`color`),Ki()&&t.vec4u8(`olidColor`),t.freeze()}var Xd=class extends Lr{constructor(){super(...arguments),this.cullFace=0,this.style=0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasOccludees=!1,this.enableOffset=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasVVColor=!1,this.draped=!1,this.textureCoordinateType=0,this.emissionSource=0,this.discardInvisibleFragments=!0,this.writeDepth=!0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasVVSize=!1,this.hasVVOpacity=!1,this.overlayEnabled=!1,this.snowCover=!1}};F([H({count:3})],Xd.prototype,`cullFace`,void 0),F([H({count:6})],Xd.prototype,`style`,void 0),F([H()],Xd.prototype,`hasVertexColors`,void 0),F([H()],Xd.prototype,`polygonOffset`,void 0),F([H()],Xd.prototype,`hasOccludees`,void 0),F([H()],Xd.prototype,`enableOffset`,void 0),F([H()],Xd.prototype,`terrainDepthTest`,void 0),F([H()],Xd.prototype,`cullAboveTerrain`,void 0),F([H()],Xd.prototype,`hasVVColor`,void 0),F([H()],Xd.prototype,`draped`,void 0);var Zd=class extends Mi{constructor(e){super(e,tf),this._configuration=new Xd,this.supportsEdges=!0,this.produces=new Map([[2,e=>rr(e)],[4,e=>V(e)],[5,e=>tr(e)],[19,e=>this.parameters.draped&&sr(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.draped=this.parameters.draped,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.enableOffset,this._configuration.terrainDepthTest=t.terrainDepthTest&&V(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration}get visible(){return this.parameters.color[3]>=$i}createGLMaterial(e){return new Qd(e)}createBufferWriter(){return new $d(Yd(this.parameters))}},Qd=class extends ir{beginSlot(e){return this.getTechnique(qd,e)}},$d=class extends $r{write(e,t,n,r,i,a){let o=Vr(n,r,this.layout,e,t,i,a);for(let t of this.layout.fields.keys()){let r=n.get(t),o=r?.indices;if(r&&o)switch(t){case`uvMapSpace`:{zn(r.size===4);let e=i.getField(t,Rn);e&&ti(r,e,a);break}case`boundingRect`:{zn(r.size===9);let n=i.getField(t,Ln);n&&ef(r,e,n,a);break}}}return o}};function ef(e,t,n,r){let{data:i,indices:a}=e,o=t,s=n.typedBuffer,c=n.typedBufferStride,l=a.length;r*=c;for(let e=0;e<l;++e){let t=9*a[e],n=i[t],l=i[t+1],u=i[t+2];s[r]=o[0]*n+o[4]*l+o[8]*u+o[12],s[r+1]=o[1]*n+o[5]*l+o[9]*u+o[13],s[r+2]=o[2]*n+o[6]*l+o[10]*u+o[14];for(let e=3;e<9;++e)s[r+e]=i[t+e];r+=c}}var tf=class extends Ji{constructor(){super(...arguments),this.color=Se(1,1,1,1),this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.hasOccludees=!1,this.style=2,this.draped=!0}};function nf(e,t){let n=e?.pattern;return n==null?new Pi(t):n.style===`none`||n.style===`solid`?(n.style===`none`&&(t.color=Se(0,0,0,0),t.forceTransparentMode=!0),new Pi(t)):(t.style=rf(n.style),new Zd(t))}function rf(e){switch(e){case`horizontal`:return 0;case`vertical`:return 1;case`cross`:return 2;case`forward-diagonal`:return 3;case`backward-diagonal`:return 4;case`diagonal-cross`:return 5;default:return}}function af(e){return e.material instanceof Zd&&!e.material.parameters.draped}function sf(e,t){if(af(e)){let n=e.attributes.get(`position`).data,r=e.getMutableAttribute(`uvMapSpace`).data,i=e.getMutableAttribute(`boundingRect`).data;Od(r,i,n,t)}}function cf(e,t,n,r,i){let a=Ra(e,t,n,r,i),o=e.stageObject.geometries;for(let e of o)sf(e,i);return a}var lf=[`polyline`,`polygon`,`extent`],uf=class e extends Ba{static{this.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,n,r){super(e,t,n,r,hf(t)),this._needsUV=!1,this._materials=[]}async doLoad(){this._fastUpdates=Xi(this._context.renderer,this._vvConvertOptions)}get _materialColor(){return this.symbolLayer.material?.color}_createMaterials(){if(this._materials.length>0)return;let e=this._materialColor,t=this._getCombinedOpacityAndColor(e);this._materials[0]=nf(this.symbolLayer,{color:t,forceTransparentMode:this.needsDrivenTransparentPass,discardInvisibleFragments:!0,polygonOffset:!1,hasVertexColors:!0,draped:this.draped,hasSlicePlane:this._context.slicePlaneEnabled,...this._fastUpdates?.materialParameters}),this._needsUV=this._materials[0]instanceof Zd;let n=this.symbolLayer.outline;if(mf(n)){let e=Li(n.pattern);this._materials[1]=new ii({width:N(n.size),color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:e,cap:Rs(n.patternCap||`butt`),screenSizePerspective:this._outlineScreenSizePerspective},this.view.state.isGlobal)}}get _outlineScreenSizePerspective(){return!this.draped&&hi(this._context.layer.screenSizePerspectiveEnabled)?this.view.screenSizePerspective.parameters:null}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,lf,this.symbolLayer.type))return null;let n=this._getDrivenUInt8Color(e.renderingInfo,this._materialColor,!1),r=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus(r.mode===`on-the-ground`),this._createMaterials(),this.draped?this._createAsOverlay(t,n):this._createAs3DShape(t,n,r)}applyRendererDiff(e,t){for(let n in e.diff){if(n!==`visualVariables`||!Zi(this._fastUpdates,t,this._vvConvertOptions))return 0;this._materials[0]?.setParameters(this._fastUpdates.materialParameters)}return 2}layerOpacityChanged(){if(this._materials[0]!=null){let e=this._materials[0].parameters.color,t=this._materialColor,n=this._getCombinedOpacity(t);this._materials[0].setParameters({color:[e[0],e[1],e[2],n],forceTransparentMode:this.needsDrivenTransparentPass})}if(this._materials[1]!=null){let e=this._materials[1].parameters.color;this._materials[1].setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerScreenSizePerspectiveChanged(){this._materials[1]?.setParameters({screenSizePerspective:this._outlineScreenSizePerspective})}layerElevationInfoChanged(t,n,r){let i=this._elevationContext.mode,a=di(e.elevationModeChangeTypes,r,i);if(a!==1)return a;let o=li(i);return this.updateGraphics3DGraphicElevationInfo(t,n,()=>o)}slicePlaneEnabledChanged(){if(this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]){let e={hasSlicePlane:this._context.slicePlaneEnabled};this._materials[1].setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,n){let r=ko(e.geometry);if(!r)return null;let i=jo(r,this._context.elevationProvider,this._context.renderCoordsHelper,n),a=new ff(i,t,this._context.layerViewUid,e.uid),o=a.renderData.position.length/3;if(this._needsUV&&(a.uvMapSpace=Ti(4*o,!0),a.boundingRect=Ne(9*o),Od(a.uvMapSpace,a.boundingRect,a.renderData.position,this._context.renderCoordsHelper)),a.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(a),this._createAs3DShapeFill(e,a),this._materials[1]&&this._createAs3DShapeOutline(a),this._logGeometryCreationWarnings(a.renderData,r.rings,`rings`,`FillSymbol3DLayer`),a.outGeometries.length===0)return null;let s=new mi({geometries:a.outGeometries,castShadow:!1,layerViewUid:this._context.layerViewUid,graphicUid:e.uid}),c=new Ha(this,s,null,cf,n);return c.alignedSampledElevation=a.renderData.sampledElevation,c.needsElevationUpdates=li(n.mode),c}_createAs3DShapeFill(e,t){let n=t.renderData.polygons;for(let{position:r,mapPositions:i,holeIndices:a,index:o,count:s}of n){if(this._context.clippingExtent!=null&&(ve(i,df),!at(df,this._context.clippingExtent)))continue;let n=Eo(i,a,this._context.elevationProvider.spatialReference);if(n.length===0)continue;let c=this._fastUpdates?.visualVariables.color,l=Do({material:this._materials[0],indices:n,mapPositions:i,attributeData:{position:r,color:c?null:t.color,colorFeature:c?Yi(c.field,e):null,uvMapSpace:this._needsUV?wi(t.uvMapSpace,4*o,4*s):null,boundingRect:this._needsUV?w(t.boundingRect,9*o,9*s):null,olidColor:t.olidColor}});t.outGeometries.push(l)}}_createAs3DShapeOutline(e){if(this._materials[1]==null)return;let t=e.renderData.outlines;for(let{mapPositions:n,position:r}of t){if(this._context.clippingExtent!=null&&(ve(n,df),!at(df,this._context.clippingExtent)))continue;let t=sa(this._materials[1],{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:n,attributeData:{position:r}},e.olidColor);e.outGeometries.push(t)}}_createAsOverlay(e,t){let n=ko(e.geometry);if(n==null)return null;this._materials[0].renderPriority=this._renderPriority+this._renderPriorityStep/2,this._materials[1]!=null&&(this._materials[1].renderPriority=this._renderPriority);let r=Mo(n,this._context.overlaySR),i=new pf(r,t,this._context.layerViewUid,e.uid),a=i.renderData.position.length/3;return this._needsUV&&(i.uvMapSpace=Ti(4*a,!0),Dd(i.uvMapSpace,i.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),i.outBoundingBox=ln(),i.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(i),this._createAsOverlayFill(e,i),this._materials[1]&&this._createAsOverlayOutline(i),this._logGeometryCreationWarnings(i.renderData,n.rings,`rings`,`FillSymbol3DLayer`),i.outGeometries.length===0?null:new ys(this,i.outGeometries,i.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e,t){let n=t.renderData.polygons;for(let{position:r,holeIndices:i,index:a,count:o}of n){let n=ve(r,df);if(!at(n,this._context.clippingExtent))continue;let s=vn(r,i,3);if(s.length===0)continue;_t(t.outBoundingBox,n);let c=this._fastUpdates?.visualVariables.color,l=Do({material:this._materials[0],indices:s,attributeData:{position:r,color:c?null:t.color,colorFeature:c?Yi(c.field,e):null,uvMapSpace:this._needsUV?wi(t.uvMapSpace,4*a,4*o):null,olidColor:t.olidColor}});t.outGeometries.push(new ji(l,t))}}_createAsOverlayOutline(e){if(this._materials[1]==null)return;let t=e.renderData.outlines;for(let n=0;n<t.length;++n){let{position:r}=t[n];if(ve(r,df),!at(df,this._context.clippingExtent))continue;_t(e.outBoundingBox,df);let i=sa(this._materials[1],{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:r}},e.olidColor);e.outGeometries.push(new ji(i,e))}}_getOutlineOpacity(){let e=this.symbolLayer?.outline?.color;return(this.draped?1:this._getLayerOpacity())*(e==null?0:e.a)}_getOutlineColor(){let e=this.symbolLayer?.outline?.color,t=this._getOutlineOpacity();return ha(e?.toUnitRGB(),t)}test(){return{...super.test(),createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,n)=>this._createAs3DShape(e,t,n)}}get _vvConvertOptions(){return new Wi({supports:{size:!1,color:!0,rotation:!1,opacity:!1},fallbackColor:this._materialColor?.toUnitRGBA()??D})}},df=o(),ff=class extends Ao{constructor(e,t,n,r){super(e,n,r),this.color=t}},pf=class extends Ao{constructor(e,t,n,r){super(e,n,r),this.color=t}};function mf(e){return e?.size!=null&&e.size>0&&e.color!=null&&(e.pattern==null||e.pattern.type!==`style`||e.pattern.style!==`none`)}function hf(e){return(e.material?.color?.a??0)===1}var gf=class{constructor(e,t=`center`,n=!1,r=M(),i=Se(0,0,0,-1),a=`world`,o=z(),s=0){this.verticalOffset=e,this.anchor=t,this.hasLabelVerticalOffset=n,this.screenOffset=r,this.centerOffset=i,this.centerOffsetUnits=a,this.translation=o,this.elevationOffset=s}},_f=class{constructor(e,t=`center`,n=`center`,r=null,i=M(),a=!0){this.placement=e,this.horizontalPlacement=t,this.verticalPlacement=n,this.text=r,this.displaySize=i,this.isFocused=a}},vf=class e{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=bf(e.color),this.haloStyle=yf(e.halo.color),this.backgroundStyle=e.background.color[3]===0?null:bf(e.background.color)}fontString(e){let t=this.definition.font;return`${t.style} ${t.weight} ${e}px ${t.family}, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji`}setFontProperties(e,t){e.font=this.fontString(t),e.textAlign=`left`,e.textBaseline=`alphabetic`}static async fromSymbol(t,n){let r=t?.material?.color?.toUnitRGBA()??D,i=t.size==null?12:N(t.size),a=t.lineHeight,o=t.background?.color?.toUnitRGBA()??D,s={family:t.font?.family??`sans-serif`,decoration:t.font?.decoration??`none`,weight:t.font?.weight??`normal`,style:t.font?.style??`normal`},c=t.halo,l=c?.color!=null&&c.size>0?{size:N(c.size),color:c.color.toUnitRGBA()}:{size:0,color:D},u=new e({color:r,size:i,background:{color:o,padding:t.background==null?[0,0]:[.65*i,.5*i],borderRadius:t.background==null?0:i*(6/16)},lineSpacingFactor:a,font:s,halo:l,pixelRatio:n});if(t.font){let e=!1,n=u.fontString(i);try{e=(await document.fonts.load(n)).some(e=>!hr(e))}catch{h.getLogger(`esri.views.3d.webgl-engine.lib.TextRenderParameters`).warnOnce(`Failed to preload font '${n}'. Some text symbology may be rendered using the default browser font.`)}if(!e&&!xf.has(t.font.family))try{await mr(t.font)}catch{}}return u}};function yf(e){return`rgb(${e.slice(0,3).map(e=>Math.floor(255*e)).toString()})`}function bf(e){return`rgba(${e.slice(0,3).map(e=>Math.floor(255*e)).toString()},${e[3]})`}var xf=new Set([`Arial`,`Times New Roman`,`Courier New`,`serif`,`sans-serif`,`monospace`,`cursive`,`fantasy`,`system-ui`,`ui-serif`,`ui-sans-serif`,`ui-monospace`,`ui-rounded`,`math`,`emoji`,`fangsong`]),Sf=4096,Cf=class extends c{constructor(e){super(e),this.id=ge(),this.events=new nt,this._texture=null,this._atlas=new Df(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement(`canvas`),this._canvas.setAttribute(`id`,`textAtlasCanvas`),this._canvas.setAttribute(`style`,`display:none`),this._ctx=this._canvas.getContext(`2d`),this._stage=this.view.stage,this._stage.addTexture(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._texture=wt(this._texture),this._frameWorker=y(this._frameWorker),this.updating=!1,this.events.emit(`unloaded`)}get loaded(){return this._texture!=null}get texture(){return this._texture}static get maxSize(){return kf=pi.stableRendering?wf:0,[Sf-wf-kf,Sf-wf-kf-Tf]}load(e){if(this._texture)return this._texture;let t=new on;return t.wrapMode=33071,t.samplingMode=9987,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,this._texture=new tt(e,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(Ye.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._texture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=y(this._frameWorker),this._texture&&=(this._stage.removeTexture(this),wt(this._texture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.width=e.width,this._canvas.height=e.height}_resizeAtlas(e,t){let{width:n,height:r}=this._atlas;n===e&&r===t||(this._atlas.width=e,this._atlas.height=t,this._texture?.resize(e,t),this._texture?.updateData(0,0,0,n,r,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach(e=>this._uvCallbacks.get(e.textRenderer.key)?.forEach(t=>t(e.uv))),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(e,t,n,r){let i=this._atlas;if(i.width<n||i.height<r)return!1;let a=i.cursors.get(r);if(!a){if(i.height<i.nextY+r)return!1;a=[new Of(i.nextY)],i.cursors.set(r,a),i.nextY+=r}let o=a.find(e=>i.width>=e.x+n);if(o==null){if(i.height<i.nextY+r)return!1;o=new Of(i.nextY),i.nextY+=r,a.push(o)}return e.setNewPosition(o),this._elements.set(t,e),this._elementsToRender.set(t,e),o.x+=n,!0}_ensureCallbacks(e){let t=this._uvCallbacks.get(e);if(t)return t;let n=new Set;return this._uvCallbacks.set(e,n),n}_addCallback(e,t){this._ensureCallbacks(e).add(t)}_removeCallback(e,t){let n=this._uvCallbacks.get(e);return!(!n?.delete(t)||n.size!==0)&&(this._uvCallbacks.delete(e),!0)}_processAddition(e){let t=e.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,e);let n=this._atlas,r=e.textRenderer.renderedWidth,i=e.textRenderer.renderedHeight,a=r+wf,o=i+wf+Tf;if(!this._addAtlasElement(e,t,a,o)){if(this._canRepack)this._reset();else if(n.width<a){let e=ea(Math.max(a,1.5*n.width),Sf);this._resizeAtlas(e,n.height)}else{let e=n.nextY+o,t=ea(Math.max(e,1.5*n.height),Sf);if(t>n.height)this._resizeAtlas(n.width,t);else if(n.width<Sf){let e=ea(1.5*n.width,Sf);this._resizeAtlas(e,n.height)}}this._elements.set(t,e)}}_renderElement(e){let t=e.commitNewPosition(),n=e.textRenderer;this._ctx.clearRect(t[0]-wf,t[1]-wf,n.renderedWidth+2*wf,n.renderedHeight+2*wf),n.render(this._ctx,t[0],t[1]),this._uvCallbacks.get(n.key)?.forEach(t=>t(e.uv))}get readyToRun(){return this.updating}runTask(e){if(this._texture==null)return ft;for(;this._needsRepack&&(this._canRepack||this._atlas.height<Sf&&this._atlas.height<Sf);){this._canRepack=this._needsRepack=!1;let t=this._elements;this._elements=new Map,t.forEach(e=>this._processAddition(e)),e.madeProgress()}if(this._elementsToRender.size>0){for(let[t,n]of this._elementsToRender){if(e.done)break;this._renderElement(n),this._elementsToRender.delete(t),e.madeProgress()}this._texture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(e,t){let n=e.key;this._addCallback(n,t);let r=this._elements.get(n);return r?At(r.uv,D)||t(r.uv):(r=new Ef(e),this._processAddition(r),this.setDirty()),{remove:()=>this._removeText(e,t)}}_removeText(e,t){let n=e.key;this._elements.get(n)&&this._removeCallback(n,t)&&(this._elements.delete(n),this._elementsToRender.delete(n),this._canRepack=!0)}setDirty(){this._texture&&(this.updating=!0)}get test(){}get usedMemory(){return(this._texture?.usedMemory??0)+(this._canvas?.width??0)*(this._canvas?.height??0)*4}};F([l({constructOnly:!0})],Cf.prototype,`view`,void 0),F([l({type:Boolean})],Cf.prototype,`updating`,void 0),Cf=F([Fe(`esri.views.3d.webgl-engine.lib.TextTextureAtlas`)],Cf);var wf=2,Tf=2,Ef=class{constructor(e){this.textRenderer=e,this._uv=qe(),this._newPosition=[0,0]}get uv(){if(this._xOffset==null||this._yOffset==null)return D;let{renderedWidth:e,renderedHeight:t}=this.textRenderer;return Dt(this._uv,this._xOffset,this._yOffset+t,this._xOffset+e,this._yOffset)}setNewPosition(e){this._newPosition[0]=e.x,this._newPosition[1]=e.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}},Df=class{constructor(e,t){this.width=e,this.height=t,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=kf}},Of=class{constructor(e){this.y=e,this.x=kf}},kf=0,Af=class{constructor(e,t,n){this._renderer=new go(e,t,n,Cf.maxSize)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){let e=fo(jf,this._renderer.renderedWidth,this._renderer.renderedHeight),t=e.getContext(`2d`);return t.save(),this._renderer.render(t,0,0),t.restore(),new ta(e,{wrap:{s:33071,t:33071},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0})}},jf={canvas:null},Mf=Qe(0,0,1),Nf=class extends Ba{constructor(e,t,n,r){super(e,t,n,r),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){let e=ga(this.symbolLayer.size);if(e)throw new n(`graphics3dtextsymbollayer:invalid-size`,e)}await this._createTextRenderParameters()}async _createTextRenderParameters(){let e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await vf.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){let t=e.graphic,n=Va(t.geometry);if(n==null)return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;let r=this.view.focusAreasView?.containsGeometry(n)??!0,i=this.symbolLayer.text;if(i==null||i===``)return null;let a=ce(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(a!=null&&!te(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;let{verticalAlignment:o}=this.symbolLayer,s=new gf(a);mo(o,s.screenOffset);let c=new _f(s,this.symbolLayer.horizontalAlignment,ho(o));return c.isFocused=r??c.isFocused,this._createAs3DShape(t,n,i,c)}get needsUpdateFocus(){return!0}createLabel(e,t,n,r,i){let a=e.graphic,o=Va(a.geometry);if(o==null)return this.logger.warn(`unsupported geometry type for label: ${a.geometry.type}`),null;let s=this.view.focusAreasView?.containsGeometry(o)??!0,c=t.text;return!c||/^\s+$/.test(c)?null:(t.isFocused=s??t.isFocused,this._createAs3DShape(a,o,c,t,n,r,i))}createElevationContextForGraphic(e,t=0){let n=super.createElevationContextForGraphic(e);return n.addOffsetRenderUnits(t),n}updateElevationContextForGraphic(e,t,n=0){super.updateElevationContextForGraphic(e,t),e.addOffsetRenderUnits(n)}layerOpacityChanged(){return this.logger.warn(`layer opacity change not yet implemented in Graphics3DTextSymbolLayer`),!1}layerScreenSizePerspectiveChanged(e,t){let n=!this.draped&&this._context.screenSizePerspectiveEnabled,r=n?this.view.screenSizePerspective.labelParameters:null,i=n?this.view.screenSizePerspective.parameters:null;Pf(e,t,e=>{for(let t of e.stageObject.geometries)t.material.setParameters({screenSizePerspective:r,screenSizePerspectiveAlignment:i})})}layerElevationInfoChanged(e,t){return Pf(e,t,(e,t)=>{this.graphics3DGraphicLayerElevationInfoChanged(t,e)}),1}slicePlaneEnabledChanged(e,t){return Pf(e,t,e=>{for(let t of e.stageObject.geometries)t.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}terrainTransparencyChanged(){return this.draped}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return!1}graphics3DGraphicLayerElevationInfoChanged(e,t){let{elevationContext:n,metadata:r}=t;this.updateElevationContextForGraphic(n,e,r?.elevationOffset??0),t.needsElevationUpdates=li(n.mode)||n.mode===`absolute-height`}updateGeometry(e,t){let n=e.geometry;if(this.draped||!n||!this._validateGeometry(n))return!1;let{elevationContext:r,stageObject:i}=t;if(r.mode!==this.getGeometryElevationMode(n))return!1;let a=Va(n);if(!a)return!1;r.updateFeatureExpressionFeature(e,this._context.layer);let o=Ea(i,this._context,a,r);if(o==null)return!1;let s=za(this._context,a);return i.geometries[0].localOrigin===s&&(t.alignedSampledElevation=o,Ia(t,a,this._context.elevationProvider),!0)}_defaultElevationInfoNoZ(){return If}_createAs3DShape(e,t,n,r,i,o=null,s=()=>r.placement.elevationOffset){let c=this.createElevationContextForGraphic(e,r.placement.elevationOffset),l=e.uid,u=null,d=null;if(o==null){let e=co(r.horizontalPlacement);u=new Af(n,e,this._textRenderParameters);let t=null;if(this._context.sharedResources.textures!=null){d=this._context.sharedResources.textures.fromData(u.key,()=>u.create()),d.managedTexture.events.on(`unloaded`,()=>t=a(t));let e=this._context.stage.renderView.textures.acquire(d.managedTexture.id);if(e==null||Te(e))return d.release(),null;t=e}}let f=this.symbolLayer.occludedVisibility?.mode??`hidden`,p=this.view.basemapTerrain,m=!p.opaque&&!p.invisible,h=Ff(u,r),g={useVisibilityPixel:m&&f===`hidden`,occludedVisibilityMode:this.symbolLayer.occludedVisibility?.mode??`hidden`,occludedFragmentFade:!1,horizonCullingEnabled:this._context.spherical,screenOffset:r.placement.screenOffset,anchorPosition:h,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:r.placement.centerOffsetUnits,depthEnabled:!1,drawAsLabel:!0,isLabel:!0,isFocused:r.isFocused};if(e.geometry?.type===`polyline`&&(g.shaderPolygonOffset=1e-4),o?g.textureId=o.id:d&&(g.textureId=d.managedTexture.id),r.placement.verticalOffset!=null){let{screenLength:e,minWorldLength:t,maxWorldLength:n}=r.placement.verticalOffset;g.verticalOffset={screenLength:N(e),minWorldLength:t||0,maxWorldLength:n??1/0}}let _=this._context.graphicsCoreOwner.view.focusAreasView?.polygons.length,v={screenOffset:g.screenOffset,anchorPosition:h,centerOffsetUnits:g.centerOffsetUnits,verticalOffset:g.verticalOffset,shaderPolygonOffset:g.shaderPolygonOffset,useVisibilityPixel:g.useVisibilityPixel,occludedVisibilityMode:g.occludedVisibilityMode,isFocused:r.isFocused,focusStyle:this.view.map?.focusAreas.style??`none`};if(this._context.screenSizePerspectiveEnabled){let{parameters:e,labelParameters:t}=this.view.screenSizePerspective,n=lo(this._textRenderParameters);g.screenSizePerspective=t,g.screenSizePerspectiveMinPixelReferenceSize=n.maxHeight,g.screenSizePerspectiveAlignment=e,v.fontHeight=n.maxHeight}g.hasSlicePlane=this._context.slicePlaneEnabled;let y=this._context.spherical,b=i?JSON.stringify(v):``,x=i?.get(b);if(x==null){if(!r.isFocused&&_){let e=this.view.map?.focusAreas.style;g.color=vs(g.color,e),g.outlineColor=vs(g.outlineColor,e)}x=new ma(g,y),i?.set(b,x)}let S=r.placement.translation,C=u?T(u.displayWidth,u.displayHeight):re,ee=r.placement.centerOffset,te=Mf,w=o?Se(0,0,0,0):null,ne=da(x,{normal:te,position:S,size:C,centerOffsetAndDistance:ee,uvi:w}),E=ja(this._context,t,ne,c,l);if(E==null)return null;let ie=(t,n,i,a,o,c)=>{let l=s()||r.placement.elevationOffset;return this.updateElevationContextForGraphic(n,e,l),Aa(t,n,i,a,o,c)},ae=new Ha(this,E.object,d,ie,c);return ae.alignedSampledElevation=E.sampledElevation,ae.hiddenIfDeconflicted=!0,ae.needsElevationUpdates=li(c.mode)||c.mode===`absolute-height`,ae.getScreenSize=(e=M())=>(e[0]=u?u.displayWidth:r.displaySize[0],e[1]=u?u.displayHeight:r.displaySize[1],e),ae.metadata=new Pa(r.placement.elevationOffset,n),Ia(ae,t,this._context.elevationProvider),ae}};function Pf(e,t,n){e?.forEach(e=>{let r=t(e);r!=null&&n(r,e.graphic)})}function Ff(e,t){if(t.verticalPlacement===`baseline`){let n=uo[t.horizontalPlacement],r=e==null?0:e.baselineAnchorY;return T(n,r)}let n=po(t.horizontalPlacement,t.verticalPlacement);return _o[n]}var If={mode:`relative-to-ground`,offset:0},Lf=class extends vi{constructor(e,n){super(e,n,Ki()?Bi:Oi),this.shader=new xi(To,()=>t(()=>import(`./WaterSurface.glsl-fa-SFsxo.js`),__vite__mapDeps([95,96,2,3,97,55,41,23,35,27,22,59,45,34,29,37,46,43,25,26,28,60,33,42,38,61,40,91,39,32,36,90,66,30,44,47])))}initializePipeline(e){let{oitPass:t,output:n,hasEmission:r,transparent:i,draped:a}=e;return Or({blending:n!==2&&n!==8&&n!==9&&i?Rr(t):null,depthTest:a?null:Pr(t),depthWrite:jr(e),drawBuffers:Br(t,r),colorWrite:Tr,polygonOffset:ni(e)})}};Lf=F([Fe(`esri.views.3d.webgl-engine.materials.WaterTechnique`)],Lf);var Rf=class extends ir{ensureResources(e){return this._techniques.context.waterTextures.ensureResources(e)}beginSlot(e){let t=this._techniques.context.waterTextures.passParameters;return this._material.setParameters({wavePerturbation:t.wavePerturbation,waveNormal:t.waveNormal}),this.getTechnique(Lf,e)}},zf=class extends Lr{constructor(e){super(),this.spherical=e,this.receiveShadows=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=0,this.emissionSource=0,this.pbrMode=3,this.occlusionPass=!1,this.useCustomDTRExponentForWater=!0,this.highStepCount=!0,this.useFillLights=!1,this.overlayEnabled=!1,this.snowCover=!1}get discardInvisibleFragments(){return this.transparent&&this.writeDepth}};F([H()],zf.prototype,`receiveShadows`,void 0),F([H()],zf.prototype,`transparent`,void 0),F([H()],zf.prototype,`enableOffset`,void 0),F([H()],zf.prototype,`writeDepth`,void 0),F([H()],zf.prototype,`screenSpaceReflections`,void 0),F([H()],zf.prototype,`cloudReflections`,void 0),F([H()],zf.prototype,`draped`,void 0),F([H()],zf.prototype,`terrainDepthTest`,void 0),F([H()],zf.prototype,`cullAboveTerrain`,void 0);var Bf=class extends Mi{constructor(e,t){super(e,Vf),this.visible=!0,this.produces=new Map([[2,e=>V(e)&&!this.parameters.transparent||rr(e)],[4,e=>V(e)&&this.parameters.transparent||rr(e)],[19,e=>this.parameters.draped&&V(e)||e===2||rr(e)],[20,e=>e===2]]),this._configuration=new zf(t.spherical)}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.writeDepth=!0,this._configuration.receiveShadows=V(e)&&t.shadowMap.enabled,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.screenSpaceReflections=t.ssr.lastFrameColor!=null,this._configuration.cloudReflections=t.clouds.data!=null,this._configuration.draped=this.parameters.draped,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.enableOffset,this._configuration.terrainDepthTest=t.terrainDepthTest&&V(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}update(e){return this.setParameters({timeElapsed:Ke(e.time)*this.parameters.animationSpeed},!1),this._animationEnabled(e.camera)&&e.dt>0}_animationEnabled(e){let t=Math.min(e.relativeElevation,e.distance);return Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<Hf}createGLMaterial(e){return new Rf(e)}createBufferWriter(){return new $r(Ki()?Fi:ki)}get test(){}},Vf=class extends Mr{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=T(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=Se(0,0,0,0),this.transparent=!0,this.hasSlicePlane=!1,this.draped=!1,this.origin=z(),this.modelTransformation=null}},Hf=35e3,Uf={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},Wf=[`polyline`,`polygon`,`extent`],Gf=class e extends Ba{static{this.unitSizeOfTexture=100}static{this.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2}}constructor(e,t,n,r){super(e,t,n,r)}async doLoad(){}createGraphics3DGraphic(e){let t=e.graphic;if(!this._validateGeometry(t.geometry,Wf,this.symbolLayer.type))return null;let n=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus(n.mode===`on-the-ground`),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,n,t.uid)}ensureMaterial(){if(this._materials[0])return;let e=new Vf,t=this.symbolLayer.color.toUnitRGBA();t[3]*=this._getLayerOpacity(),e.color=t,e.transparent=t[3]<1||this.needsDrivenTransparentPass,e.waveDirection=this.symbolLayer.waveDirection==null?T(0,0):Kf(this.symbolLayer.waveDirection);let n=this.symbolLayer.waveStrength+`-`+this.symbolLayer.waterbodySize,r=Uf[n];e.waveStrength=r.waveStrength,e.waveTextureRepeat=r.textureRepeat,e.waveVelocity=r.waveVelocity,e.flowStrength=r.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.draped=this.draped,this._materials[0]=new Bf(e,this._context)}layerOpacityChanged(){if(this._materials[0]==null)return;let e=this._materials[0].parameters.color,t=this.symbolLayer.color.a*this._getLayerOpacity(),n=t<1||this.needsDrivenTransparentPass;this._materials[0].setParameters({color:[e[0],e[1],e[2],t],transparent:n})}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(t,n,r){let i=this._elevationContext.mode,a=di(e.elevationModeChangeTypes,r,i);if(a!==1)return a;let o=li(i);return this.updateGraphics3DGraphicElevationInfo(t,n,()=>o)}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}get needsDrivenTransparentPass(){return!1}_createAs3DShape(e,t,n){let r=ko(e.geometry);if(r==null)return null;let i=jo(r,this._context.elevationProvider,this._context.renderCoordsHelper,t),a=i.position.length/3,o=Ti(2*a);qf(o,i.mapPositions,a,this._context.elevationProvider.spatialReference);let s=new Qf(i,o,this._context.layerViewUid,e.uid);if(s.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(s),this._create3DShapeGeometries(s),this._logGeometryCreationWarnings(s.renderData,r.rings,`rings`,`WaterSymbol3DLayer`),s.outGeometries.length===0)return null;let c=new mi({geometries:s.outGeometries,castShadow:!1,layerViewUid:this._context.layerViewUid,graphicUid:n}),l=new Ha(this,c,null,Ra,t);return l.alignedSampledElevation=s.renderData.sampledElevation,l.needsElevationUpdates=li(t.mode),l}_create3DShapeGeometries(e){let t=e.renderData.polygons,n=e.uvCoords;for(let{count:r,index:i,position:a,mapPositions:o,holeIndices:s}of t){if(this._context.clippingExtent!=null&&(ve(o,Zf),!at(Zf,this._context.clippingExtent)))continue;let t=vn(o,s,3);if(t.length===0)continue;let c=wi(n,2*i,2*r),l=Oo({material:this._materials[0],indices:t,mapPositions:o,attributeData:{position:a,uv0:c}},e.olidColor);e.outGeometries.push(l)}}_createAsOverlay(e){let t=ko(e.geometry);if(t==null)return null;this._materials[0].renderPriority=this._renderPriority;let n=Mo(t,this._context.overlaySR),r=n.position.length/3,i=Ti(2*r);qf(i,n.position,r,this._context.overlaySR);let a=new $f(n,i,this._context.layerViewUid,e.uid);return a.olidColor=this._context.stage.renderView?.getObjectAndLayerIdColor(a),a.outBoundingBox=ln(),this._createAsOverlayWater(a),this._logGeometryCreationWarnings(a.renderData,t.rings,`rings`,`WaterSymbol3DLayer`),a.outGeometries.length===0?null:new ys(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(e){let t=e.uvCoords,n=e.renderData.polygons;for(let{position:r,holeIndices:i,index:a,count:o}of n){if(ve(r,Zf),!at(Zf,this._context.clippingExtent))continue;_t(e.outBoundingBox,Zf);let n=vn(r,i,3);if(n.length===0)continue;let s=wi(t,2*a,2*o),c=Oo({material:this._materials[0],indices:n,attributeData:{position:r,uv0:s}},e.olidColor);e.outGeometries.push(new ji(c,e))}}test(){return{...super.test(),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}};function Kf(e){let t=M(),n=zt(e);return t[0]=Math.sin(n),t[1]=Math.cos(n),t}function qf(e,t,n,i){let a=r(i);pt(Yf);for(let e=0;e<n;e++)S(Xf,t[3*e],t[3*e+1]),Pt(Yf,Xf);Jt(Yf,Yf,a);let o=Yf[0]%Gf.unitSizeOfTexture,s=Yf[1]%Gf.unitSizeOfTexture;Jf[0]=Yf[0]-o,Jf[1]=Yf[1]-s;for(let r=0;r<n;r++)e[2*r]=(t[3*r]*a-Jf[0])/Gf.unitSizeOfTexture,e[2*r+1]=(t[3*r+1]*a-Jf[1])/Gf.unitSizeOfTexture}var Jf=M(),Yf=Ot(),Xf=M(),Zf=o(),Qf=class extends Ao{constructor(e,t,n,r){super(e,n,r),this.uvCoords=t}},$f=class extends Ao{constructor(e,t,n,r){super(e,n,r),this.uvCoords=t}};function ep(e,t,n,r){let i=np[e.type]?.[t.type]||tp[t.type];return i?new i(e,t,n,r):(h.getLogger(`esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory`).error(`GraphicsLayerFactory#make`,`unknown symbol type ${t.type}`),null)}var tp={icon:Ds,object:Pl,line:Ys,path:bd,fill:uf,extrude:Ho,text:Nf,water:Gf},np={"mesh-3d":{fill:Mc}};export{ep as make};