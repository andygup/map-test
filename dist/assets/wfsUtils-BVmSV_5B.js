import{Ag as e,BT as t,Fg as n,Fp as r,MC as i,RS as a,ST as o,WS as s,_S as c,_v as l,ax as u,mS as d,pC as f,sC as p,ud as m,wx as h,xT as g}from"./index-CzMixifc.js";import{i as _}from"./geojson-P0Lto7Ud.js";import{n as v,t as y}from"./xmlUtils-Dwxxb6WI.js";var b=`xlink:href`,x=`2.0.0`,S=`__esri_wfs_id__`,C=`wfs-layer:getWFSLayerTypeInfo-error`,w=`wfs-layer:empty-service`,T=`wfs-layer:feature-type-not-found`,E=`wfs-layer:geojson-not-supported`,D=`wfs-layer:kvp-encoding-not-supported`,O=`wfs-layer:malformed-json`,k=`wfs-layer:unknown-geometry-type`,ee=`wfs-layer:unknown-field-type`,te=`wfs-layer:unsupported-spatial-reference`,ne=`wfs-layer:unsupported-wfs-version`;async function re(e,t){let n=A((await a(e,{responseType:`text`,query:{SERVICE:`WFS`,REQUEST:`GetCapabilities`,VERSION:x,...t?.customParameters},signal:t?.signal})).data);return P(e,n),n}function A(e){let t=X(e);ae(t),Q(t);let n=t.firstElementChild,r=o(I(n));return{operations:N(n),get featureTypes(){return Array.from(r())},readFeatureTypes:r}}var j=[`json`,`application/json; subtype=geojson; charset=utf-8`,`application/json; subtype=geojson`,`application/json`,`geojson`,`application/geo+json`];function M(e){for(let t of j){let n=e.findIndex(e=>e.toLowerCase()===t);if(n>=0)return e[n]}return null}function N(e){let n=!0,r={GetCapabilities:{url:``},DescribeFeatureType:{url:``},GetFeature:{url:``,outputFormat:null,supportsPagination:!1}},i=[],a=[];if(v(e,{OperationsMetadata:{Parameter:e=>{if(e.getAttribute(`name`)?.toLowerCase()===`outputformat`)return{AllowedValues:{Value:({textContent:e})=>{e&&i.push(e)}}}},Operation:e=>{switch(e.getAttribute(`name`)){case`GetCapabilities`:return{DCP:{HTTP:{Get:e=>{r.GetCapabilities.url=e.getAttribute(b)}}}};case`DescribeFeatureType`:return{DCP:{HTTP:{Get:e=>{r.DescribeFeatureType.url=e.getAttribute(b)}}}};case`GetFeature`:return{DCP:{HTTP:{Get:e=>{r.GetFeature.url=e.getAttribute(b)}}},Parameter:e=>{if(e.getAttribute(`name`)?.toLowerCase()===`outputformat`)return{AllowedValues:{Value:({textContent:e})=>{e&&a.push(e)}}}}}}},Constraint:e=>{switch(e.getAttribute(`name`)){case`KVPEncoding`:return{DefaultValue:e=>{n=e.textContent.toLowerCase()===`true`}};case`ImplementsResultPaging`:return{DefaultValue:e=>{r.GetFeature.supportsPagination=e.textContent.toLowerCase()===`true`}}}}}}),r.GetFeature.outputFormat=M(a)??M(i),!n)throw new t(D,`WFS service doesn't support key/value pair (KVP) encoding`);if(r.GetFeature.outputFormat==null)throw new t(E,`WFS service doesn't support GeoJSON output format`);return r}function P(e,t){i(e)&&(f(e,t.operations.DescribeFeatureType.url,!0)&&(t.operations.DescribeFeatureType.url=p(t.operations.DescribeFeatureType.url)),f(e,t.operations.GetFeature.url,!0)&&(t.operations.GetFeature.url=p(t.operations.GetFeature.url)))}function F(e){let t=parseInt(e.textContent?.match(/(?<wkid>\d+$)/i)?.groups?.wkid??``,10);if(!Number.isNaN(t))return t}function I(e){return y(e,{FeatureTypeList:{FeatureType:e=>{let t={typeName:`undefined:undefined`,name:``,title:``,description:``,extent:null,namespacePrefix:``,namespaceUri:``,defaultSpatialReference:4326,supportedSpatialReferences:[]},n=new Set;return v(e,{Name:e=>{let{name:n,prefix:r}=Z(e.textContent);t.typeName=`${r}:${n}`,t.name=n,t.namespacePrefix=r,t.namespaceUri=e.lookupNamespaceURI(r)},Abstract:e=>{t.description=e.textContent},Title:e=>{t.title=e.textContent},WGS84BoundingBox:e=>{t.extent=u.fromJSON(L(e))},DefaultCRS:e=>{let r=F(e);r&&(t.defaultSpatialReference=r,n.add(r))},OtherCRS:e=>{let t=F(e);t&&n.add(t)}}),t.title||=t.name,n.add(4326),t.supportedSpatialReferences.push(...n),t}}})}function L(e){let t,n,r,i;for(let a of e.children)switch(a.localName){case`LowerCorner`:[t,n]=a.textContent.split(` `).map(e=>Number.parseFloat(e));break;case`UpperCorner`:[r,i]=a.textContent.split(` `).map(e=>Number.parseFloat(e))}return{xmin:t,ymin:n,xmax:r,ymax:i,spatialReference:d}}function R(e,t,n){return g(e,e=>n?e.name===t&&e.namespaceUri===n:e.typeName===t||e.name===t)}async function z(e,t,n,r={}){let{featureType:i,extent:a}=await B(e,t,n,r),{spatialReference:o}=$(e.operations.GetFeature.url,i,r.spatialReference),{fields:s,geometryType:c,swapXY:l,objectIdField:u,geometryField:d}=await V(e,i,o,r);return{url:e.operations.GetCapabilities.url,name:i.name,namespaceUri:i.namespaceUri,fields:s,geometryField:d,geometryType:c,objectIdField:u,spatialReference:r.spatialReference??new h({wkid:i.defaultSpatialReference}),extent:a,swapXY:l,wfsCapabilities:e,customParameters:r.customParameters}}async function B(r,i,a,o={}){let s=r.readFeatureTypes(),l=i?R(s,i,a):s.next().value,{spatialReference:u=new h({wkid:l?.defaultSpatialReference})}=o;if(l==null)throw i?new t(T,`The type '${i}' could not be found in the service`):new t(w,`The service is empty`);let d=l.extent;if(d&&!c(d.spatialReference,u))try{await e(d.spatialReference,u,void 0,o),d=n(d,u)}catch{throw new t(te,`Projection not supported`)}return{extent:d,spatialReference:u,featureType:l}}async function V(e,n,r,i={}){let{typeName:a}=n,[o,s]=await Promise.allSettled([W(e.operations.DescribeFeatureType.url,a,i),U(e,a,r,i)]),c=e=>new t(C,`An error occurred while getting info about the feature type '${a}'`,{error:e});if(o.status===`rejected`)throw c(o.reason);if(s.status===`rejected`)throw c(s.reason);let{fields:l,errors:u}=o.value??{},d=o.value?.geometryType||s.value?.geometryType,f=s.value?.swapXY??!1;if(d==null)throw new t(k,`The geometry type could not be determined for type '${a}`,{typeName:a,geometryType:d,fields:l,errors:u});return{...H(l??[]),geometryType:d,swapXY:f}}function H(e){let t=e.find(e=>e.type===`geometry`),n=e.find(e=>e.type===`oid`);return e=e.filter(e=>e.type!==`geometry`),n||(n=new m({name:`__esri_wfs_id__`,type:`oid`,alias:`__esri_wfs_id__`}),e.unshift(n)),{geometryField:t?.name??null,objectIdField:n.name,fields:e}}async function U(e,t,n,r={}){let i,o=!1,[s,c]=await Promise.all([J(e.operations.GetFeature.url,t,n,e.operations.GetFeature.outputFormat,{...r,count:1}),a(e.operations.GetFeature.url,{responseType:`text`,query:Y(t,n,void 0,{...r,count:1}),signal:r?.signal})]),u=s.type===`FeatureCollection`&&s.features[0]?.geometry;if(u){let e;switch(i=l.fromJSON(_(u.type)),u.type){case`Point`:e=u.coordinates;break;case`LineString`:case`MultiPoint`:e=u.coordinates[0];break;case`MultiLineString`:case`Polygon`:e=u.coordinates[0][0];break;case`MultiPolygon`:e=u.coordinates[0][0][0]}let t=/<[^>]*pos[^>]*> *(-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?)/.exec(c.data);if(t){let n=e[0].toFixed(3),r=e[1].toFixed(3),i=parseFloat(t[1]).toFixed(3);n===parseFloat(t[2]).toFixed(3)&&r===i&&(o=!0)}}return{geometryType:i,swapXY:o}}async function W(e,t,n){return G(t,(await a(e,{responseType:`text`,query:{SERVICE:`WFS`,REQUEST:`DescribeFeatureType`,VERSION:x,TYPENAME:t,TYPENAMES:t,...n?.customParameters},signal:n?.signal})).data)}function G(e,n){let{name:r}=Z(e),i=X(n);Q(i);let a=g(y(i.firstElementChild,{element:e=>e}),e=>e.getAttribute(`name`)===r);if(a!=null){let e=a.getAttribute(`type`),t=e?g(y(i.firstElementChild,{complexType:e=>e}),t=>t.getAttribute(`name`)===Z(e).name):g(y(a,{complexType:e=>e}),()=>!0);if(t)return q(t)}throw new t(T,`Type '${e}' not found in document`,{document:new XMLSerializer().serializeToString(i)})}var K=new Set([`objectid`,`fid`]);function q(e){let n=[],i=[],a,o=y(e,{complexContent:{extension:{sequence:{element:e=>e}}}});for(let s of o){let o=s.getAttribute(`name`);if(!o)continue;let c,l;if(s.hasAttribute(`type`)?c=Z(s.getAttribute(`type`)).name:v(s,{simpleType:{restriction:e=>(c=Z(e.getAttribute(`base`)).name,{maxLength:e=>{l=+e.getAttribute(`value`)}})}}),!c)continue;let u=s.getAttribute(`nillable`)===`true`,d=!1;switch(c.toLowerCase()){case`integer`:case`nonpositiveinteger`:case`negativeinteger`:case`long`:case`int`:case`short`:case`byte`:case`nonnegativeinteger`:case`unsignedlong`:case`unsignedint`:case`unsignedshort`:case`unsignedbyte`:case`positiveinteger`:i.push(new m({name:o,alias:o,type:`integer`,nullable:u,length:r(`integer`)}));break;case`float`:case`double`:case`decimal`:i.push(new m({name:o,alias:o,type:`double`,nullable:u,length:r(`double`)}));break;case`boolean`:case`string`:case`gyearmonth`:case`gyear`:case`gmonthday`:case`gday`:case`gmonth`:case`anyuri`:case`qname`:case`notation`:case`normalizedstring`:case`token`:case`language`:case`idrefs`:case`entities`:case`nmtoken`:case`nmtokens`:case`name`:case`ncname`:case`id`:case`idref`:case`entity`:case`duration`:case`time`:i.push(new m({name:o,alias:o,type:`string`,nullable:u,length:l??r(`string`)}));break;case`datetime`:case`date`:i.push(new m({name:o,alias:o,type:`date`,nullable:u,length:l??r(`date`)}));break;case`pointpropertytype`:a=`point`,d=!0;break;case`multipointpropertytype`:a=`multipoint`,d=!0;break;case`curvepropertytype`:case`multicurvepropertytype`:case`multilinestringpropertytype`:a=`polyline`,d=!0;break;case`surfacepropertytype`:case`multisurfacepropertytype`:case`multipolygonpropertytype`:a=`polygon`,d=!0;break;case`geometrypropertytype`:case`multigeometrypropertytype`:d=!0,n.push(new t(k,`geometry type '${c}' is not supported`,{type:new XMLSerializer().serializeToString(e)}));break;default:n.push(new t(ee,`Unknown field type '${c}'`,{type:new XMLSerializer().serializeToString(e)}))}d&&i.push(new m({name:o,alias:o,type:`geometry`,nullable:u}))}for(let e of i)if(e.type===`integer`&&!e.nullable&&K.has(e.name.toLowerCase())){e.type=`oid`;break}return{geometryType:a,fields:i,errors:n}}async function J(e,n,r,i,o){let{data:s}=await a(e,{responseType:`text`,query:Y(n,r,i,o),signal:o?.signal});s=s.replaceAll(/": +(-?\d+),(\d+)(,)?/g,`": $1.$2$3`);try{return JSON.parse(s)}catch(e){throw new t(O,`Error while parsing the\xA0response`,{response:s,error:e})}}function Y(e,t,n,r){let i=typeof t==`number`?t:t.wkid;return{SERVICE:`WFS`,REQUEST:`GetFeature`,VERSION:x,TYPENAMES:e,OUTPUTFORMAT:n,SRSNAME:`EPSG:`+i,STARTINDEX:r?.startIndex,COUNT:r?.count,...r?.customParameters}}async function ie(e,t,n){let r=await a(e,{responseType:`text`,query:{SERVICE:`WFS`,REQUEST:`GetFeature`,VERSION:x,TYPENAMES:t,RESULTTYPE:`hits`,...n?.customParameters},signal:n?.signal}),i=/numberMatched=["'](?<numberMatched>\d+)["']/gi.exec(r.data);if(i?.groups)return+i.groups.numberMatched}function X(e){return new DOMParser().parseFromString(e.trim(),`text/xml`)}function Z(e){let[t,n]=e.split(`:`);return{prefix:n?t:``,name:n??t}}function ae(e){let n=e.firstElementChild?.getAttribute(`version`);if(n&&n!==x)throw new t(ne,`Unsupported WFS version ${n}. Supported version: ${x}`)}function Q(e){let n=``,r=``;if(v(e.firstElementChild,{Exception:e=>(n=e.getAttribute(`exceptionCode`),{ExceptionText:e=>{r=e.textContent}})}),n)throw new t(`wfs-layer:${n}`,r)}function $(e,t,n){let r={wkid:t.defaultSpatialReference},i=n?.wkid==null?r:{wkid:n.wkid};return{spatialReference:i,getFeatureSpatialReference:s(e)||i.wkid&&t.supportedSpatialReferences.includes(i.wkid)?{wkid:i.wkid}:{wkid:t.defaultSpatialReference}}}export{ie as a,H as c,R as i,J as n,$ as o,z as r,re as s,S as t};