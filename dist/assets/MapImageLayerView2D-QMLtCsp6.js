import{BT as e,CE as t,Dd as n,VT as r,kD as i,oT as a,pv as o,rE as s}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import"./streamLayerUtils-82UmlW-3.js";import"./QueueProcessor-D6ozkjY6.js";import"./earcut-CEMcWA4Z.js";import"./layerViewUtils-CJcMVuwG.js";import"./popupUtils-z3ynpNjO.js";import"./tagSymbols-67pK6deD.js";import"./colorUtils-CzajW9E7.js";import"./timeSupport-vK4lVcYW.js";import"./queryUtils-DGU5ISbw.js";import"./sublayerUtils-Dk4DSA02.js";import"./floorFilterUtils-CPLVKkMB.js";import{t as c}from"./ExportImageParameters-BpzGm2mq.js";import"./normalizeUtilsSync-TXjrdJAe.js";import"./GeometryUtils-B-8QW9FG.js";import"./VertexAttributeLocations-BScEla0R.js";import"./VertexElementDescriptor-Cl_nC_ty.js";import"./labelPoint-1O-zXr9b.js";import"./callExpressionWithCursor-CKz4lb1p.js";import"./FeatureMetadata-rc_NIaUe.js";import"./CIMSymbolHelper-B2DBxDPE.js";import"./rasterizingUtils-BsmZb-O9.js";import"./Rect-LbcnjDUG.js";import"./BoundingBox-Dtf81F-g.js";import"./BidiEngine-DvXbVJau.js";import"./callExpressionWithFeature-UlbvTUQ4.js";import"./OverrideHelper-BahbnLvz.js";import"./FeatureCommandQueue-2UJWGVaq.js";import"./config-Dk3C6lVr.js";import"./dehydratedFeatureComparison-BCFMkftR.js";import{n as l}from"./drapedUtils-BaZZPZSM.js";import"./WGLContainer-jm6ZclzQ.js";import"./utils-B0heZPZY.js";import"./ProgramTemplate-B9k_04Md.js";import"./VertexArrayObject-ChtD6bwg.js";import"./BufferObject-B3_aJU6V.js";import"./VertexBuffer-Ra4pb4dR.js";import"./vec3f32-DDMWoxUL.js";import"./Container-uEjPEzbR.js";import"./GraphShaderModule-AgkKIWM0.js";import"./FramebufferObject-BoYk_2uK.js";import"./ShaderBuilder-BLOqjpgt.js";import"./bitmapUtils-53gkfkJ0.js";import"./Bitmap-BoQaGe8r.js";import{t as u}from"./BitmapContainer-C6h9gf6w.js";import{t as d}from"./LayerView2D-Bgb1zyoa.js";import{t as f}from"./ExportStrategy-DZKCAuVC.js";import{t as p}from"./LayerView-DQaVI2FN.js";import{t as m}from"./RefreshableLayerView-DdPullJP.js";import{t as h}from"./timeSupport-HhBEqX5E.js";import"./UpdateTracking2D-BMTZzgpI.js";import"./TechniqueInstance-fDAaVtEH.js";import"./TileContainer-BL1bFhTv.js";import"./constants-BOI_CTg-.js";import"./utils-DmZFjYOb.js";import{t as g}from"./highlightOptionsUtils-DmkXKeuF.js";import"./AGraphicContainer-DHUNjrd-.js";import"./ComputedAttributeStorage-BgTqXVQM.js";import{t as _}from"./GraphicsView2D-CUXbaTHc.js";import"./dehydratedFeatures-D5ZOMtMh.js";import{t as v}from"./HighlightGraphicContainer-IlTNsfaD.js";import{r as y}from"./highlightUtils-DVCBHSz1.js";import{t as b}from"./MapServiceLayerViewHelper-B84e40iY.js";var x=t=>{let n=t,a=class extends n{initialize(){this.exportImageParameters=new c({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get floors(){return this.view?.floors??null}get exportImageVersion(){return this.exportImageParameters?.commitProperty(`version`),this.commitProperty(`timeExtent`),this.commitProperty(`floors`),(this._get(`exportImageVersion`)||0)+1}get timeExtent(){return h(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return i([e()],a.prototype,`exportImageParameters`,void 0),i([e({readOnly:!0})],a.prototype,`floors`,null),i([e({readOnly:!0})],a.prototype,`exportImageVersion`,null),i([e()],a.prototype,`layer`,void 0),i([e()],a.prototype,`suspended`,void 0),i([e({readOnly:!0})],a.prototype,`timeExtent`,null),a=i([r(`esri.views.layers.MapImageLayerView`)],a),a},S=class extends x(m(d(p))){constructor(){super(...arguments),this._highlightGraphics=new n,this._updateHash=``}fetchPopupFeaturesAtLocation(e,t){return this._popupHighlightHelper.fetchPopupFeaturesAtLocation(e,t)}update(e){let n=`${this.exportImageVersion}/${e.state.id}/${e.pixelRatio}/${e.stationary}`;this._updateHash!==n&&(this._updateHash=n,this.strategy.update(e).catch(e=>{a(e)||t.getLogger(this).error(e)}),e.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(e.state.resolution)),this._highlightView.processUpdate(e)}attach(){let{imageMaxWidth:e,imageMaxHeight:t,version:n}=this.layer,r=n>=10.3,i=n>=10;this._bitmapContainer=new u,this.container.addChild(this._bitmapContainer),this._highlightView=new _({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new v(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1}),this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new b({createFetchPopupFeaturesQueryGeometry:(e,t)=>l(e,t,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:({graphic:e,property:t})=>this._highlightView.graphicUpdateHandler({graphic:e,property:t}),layerView:this,updatingHandles:this._updatingHandles}),this.strategy=new f({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:t,imageRotationSupported:r,imageNormalizationSupported:i,hidpi:!0}),this.addAttachHandles(o(()=>this.exportImageVersion,()=>this.requestUpdate())),this.requestUpdate()}detach(){this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy(),this._popupHighlightHelper.destroy()}viewChange(){}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}async doRefresh(){this._updateHash=``,this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,t,n,r){return this.layer.fetchImage(e,t,n,{timeExtent:this.timeExtent,floors:this.floors,...r})}fetchImageBitmap(e,t,n,r){return this.layer.fetchImageBitmap(e,t,n,{timeExtent:this.timeExtent,floors:this.floors,...r})}highlight(e,t){let n=y(e);if(n.length===0)return s();let r=g(t);return this._addHighlightGraphics(n,r),s(()=>!this.destroyed&&this._removeHighlightGraphics(n,r))}_processHighlight(){let e=this._getHighlights();this._highlightView?.setHighlight(e)}_addHighlightGraphics(e,t){this._highlightGraphics.addMany(e),this._addHighlights(e.map(e=>e.uid),t)}_removeHighlightGraphics(e,t){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map(e=>e.uid),t)}};i([e()],S.prototype,`strategy`,void 0),S=i([r(`esri.views.2d.layers.MapImageLayerView2D`)],S);var C=S;export{C as default};