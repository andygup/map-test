import{Al as e,BT as t,Bm as n,Bs as r,Cl as i,DT as a,Dm as o,Eb as s,Ey as c,FT as l,Fu as u,Gy as d,Il as f,Im as p,Is as m,Lu as h,Ml as g,Ms as _,Nb as v,Nl as y,Nm as b,Nu as x,OT as S,Ol as C,Om as w,Q as ee,Qh as te,Rf as T,Rm as E,Ss as ne,Tm as D,Um as O,Vv as re,YC as ie,Z as ae,ZC as k,_l as oe,_t as se,_w as ce,al as A,ax as le,bx as ue,c_ as j,dl as M,dw as de,ev as fe,f_ as pe,ft as me,fw as N,gD as P,gT as he,gm as ge,hl as _e,ht as ve,i_ as ye,jl as F,kl as be,kv as xe,l_ as Se,ll as Ce,lu as we,lw as I,mm as Te,mt as Ee,n_ as De,nt as Oe,nv as ke,nw as Ae,ob as je,og as Me,ol as L,ot as Ne,ow as Pe,pb as Fe,pl as Ie,rS as Le,rl as R,rt as Re,sl as ze,uE as Be,u_ as z,ut as Ve,vl as B,wm as He,wx as Ue,yl as V,zT as We}from"./index-CzMixifc.js";import{O as Ge,_ as Ke,b as qe,c as Je,j as Ye,m as Xe,o as Ze,y as Qe}from"./plane--nqwMDYx.js";import{n as $e}from"./projectPointToVector-D72S8Uh5.js";import{t as et}from"./projectVectorToVector-CZxjcyx6.js";import{n as tt,t as nt}from"./orientedBoundingBox-DQ8LQLAH.js";import{c as rt}from"./Emissions.glsl-nadaueeL.js";import{a as it,n as H,r as at,t as ot}from"./ray-XqUMyuyU.js";import{n as st,r as ct,t as lt}from"./HUDIntersectorResult-BZpY5C1W.js";import{n as ut}from"./VertexAttributeLocations-DOYYzMyn.js";import{t as dt}from"./VertexElementDescriptor-C9CNG143.js";import{t as ft}from"./sphere-DkSdrT5o.js";import{d as pt,l as mt,o as ht}from"./lineSegment-WEn1ku7V.js";import{a as gt,c as _t,n as vt}from"./renderState-DH1meWdn.js";import{a as yt,c as bt,d as xt,i as St,l as Ct,o as wt,r as Tt,s as Et,t as Dt,u as Ot}from"./frustum-DHXawB8f.js";function kt(e,t,n){e.worldUpAtPosition(t,At),V(jt,n,t);let r=F(jt);return r===0?0:Ae(M(jt,At)/r)}var At=j(),jt=j();function Mt(e,t,n){return 2*Math.atan(Math.sqrt(t*t+n*n)*Math.tan(.5*e)/t)}function Nt(e,t,n){return 2*Math.atan(Math.sqrt(t*t+n*n)*Math.tan(.5*e)/n)}function Pt(e,t,n){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+n*n))}function Ft(e,t,n){return 2*Math.atan(n*Math.tan(.5*e)/Math.sqrt(t*t+n*n))}var It,U=It=class extends ce{constructor(e){super(e),this._ray=H(),this._viewport=ee(0,0,1,1),this._padding=ee(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=u(1,1e3),this._viewDirty=!0,this._viewMatrix=T(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=T(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=T(),this._frustumDirty=!0,this._frustum=bt(),this._fullViewport=ae(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=j(),this._up=j(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,`_center`)}get ray(){return V(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,`_up`)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){E(this._viewMatrix,e),this.notifyChange(`_viewMatrix`),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),C(j(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),C(j(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),C(j(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_nearFar`))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_nearFar`))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;let e=Ve(ae(),this._viewport,1/this.pixelRatio),t=this._get(`screenViewport`);return t&&Re(e,t)?t:e}get screenPadding(){if(this.pixelRatio===1)return this._padding;let e=Ve(ae(),this._padding,1/this.pixelRatio),t=this._get(`screenPadding`);return t&&Re(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_viewport`))}get y(){return this._viewport[1]}set y(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_viewport`))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_viewport`))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_viewport`))}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(e){this.width=e-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(e){this.height=e-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){Oe(this._padding,e)||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),Ne(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange(`_padding`),this.notifyChange(`_viewport`))}get viewProjectionMatrix(){return this._viewProjectionDirty&&=(w(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return b(T(),this.projectionMatrix)||this._get(`inverseProjectionMatrix`)||T()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Pt(this._fov,this.width,this.height)}set fovX(e){this._fov=Mt(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return Ft(this._fov,this.width,this.height)}set fovY(e){this._fov=Nt(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return be(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(b(this._viewInverseTransposeMatrix,this.viewMatrix),O(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){let{near:t,far:n}=this;return 2*t*n/(n+t-e*(n-t))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){let e=this.width,t=this.height,n=this.near*Math.tan(this.fovY/2)*2,r=n*this._aspect,i=n/this.rows,a=r/this.columns,o=-r/2+this.column*a,s=o+a,c=-n/2+this.row*i,l=c+i,u=Te(T(),o*(1+2*this._padding[3]/e),s*(1+2*this._padding[1]/e),c*(1+2*this._padding[2]/t),l*(1+2*this._padding[0]/t),this.near,this.far),d=this._get(`projectionMatrix`);return d&&ge(d,u)?d:u}copyFrom(e){g(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,Ne(this._viewport,e.viewport),this.notifyChange(`_viewport`),Ne(this._padding,e.padding),this.notifyChange(`_padding`),s(this._nearFar,e.nearFar),this.notifyChange(`_nearFar`),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;let t=e;return this._viewDirty=t._viewDirty,this._viewDirty||(E(this._viewMatrix,e.viewMatrix),this.notifyChange(`_viewMatrix`)),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||=(Ot(this._frustum,e.frustum),!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(E(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Ne(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up,this.fov=e.fov}clone(){return new It().copyFrom(this)}equals(e){return L(this.eye,e.eye)&&L(this.center,e.center)&&L(this.up,e.up)&&Oe(this._viewport,e.viewport)&&Oe(this._padding,e.padding)&&je(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){let t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||ve(e.screenPadding,this.screenPadding)>=t||ve(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;Ie(G,e.eye,e.center),Ie(K,this.eye,this.center);let n=M(G,K),r=oe(G),i=oe(K),a=5e-4;return n*n>=.9999999999*r*i&&_e(e.eye,this.eye)<Math.max(r,i)*a*a}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs(Ye(this.viewForward,V(G,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=te()){return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,n=.5){return e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*n,e[2]=.5,e}setGLViewport(e){let t=this.viewport,n=this.padding;e.setViewport(t[0]-n[3],t[1]-n[2],t[2]+n[1]+n[3],t[3]+n[0]+n[2])}applyProjection(e,t){e!==W&&g(W,e),W[3]=1,se(W,W,this.projectionMatrix);let n=Math.abs(W[3]);i(W,W,1/n);let r=this.fullViewport;t[0]=I(0,r[0]+r[2],.5+.5*W[0]),t[1]=I(0,r[1]+r[3],.5+.5*W[1]),t[2]=.5*(W[2]+1),t[3]=n}unapplyProjection(e,t){let n=this.fullViewport;W[0]=(e[0]/(n[0]+n[2])*2-1)*e[3],W[1]=(e[1]/(n[1]+n[3])*2-1)*e[3],W[2]=(2*e[2]-1)*e[3],W[3]=e[3],this.inverseProjectionMatrix!=null&&(se(W,W,this.inverseProjectionMatrix),t[0]=W[0],t[1]=W[1],t[2]=W[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,zt),this.renderToScreen(zt,t),t}projectToRenderScreen(e,t){if(W[0]=e[0],W[1]=e[1],W[2]=e[2],W[3]=1,se(W,W,this.viewProjectionMatrix),W[3]===0)return null;let n=W;i(n,n,1/Math.abs(W[3]));let r=this.fullViewport,a=I(0,r[0]+r[2],.5+.5*n[0]),o=I(0,r[1]+r[3],.5+.5*n[1]);return`x`in t?(t.x=a,t.y=o):(t[0]=a,t[1]=o,t.length>2&&(t[2]=.5*(n[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,zt),t)}unprojectFromRenderScreen(e,t){if(w(Rt,this.projectionMatrix,this.viewMatrix),!b(Rt,Rt))return null;let n=this.fullViewport;return W[0]=2*(e[0]-n[0])/n[2]-1,W[1]=2*(e[1]-n[1])/n[3]-1,W[2]=2*e[2]-1,W[3]=1,se(W,W,Rt),W[3]===0?null:(t[0]=W[0]/W[3],t[1]=W[1]/W[3],t[2]=W[2]/W[3],t)}constrainWindowSize(e,t,n,r){let i=e*this.pixelRatio,a=t*this.pixelRatio,o=Math.max(i-n/2,0),s=Math.max(this.fullHeight-a-r/2,0),c=-Math.min(i-n/2,0),l=-Math.min(this.fullHeight-a-r/2,0),u=n-c- -Math.min(this.fullWidth-i-n/2,0),d=r-l- -Math.min(a-r/2,0);return[Math.round(o),Math.round(s),Math.round(u),Math.round(d)]}computeUp(e){e===1?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){let n=e[0]*this.pixelRatio,r=this.fullHeight-e[1]*this.pixelRatio;return t[0]=n,t[1]=r,t}renderToScreen(e,t){let n=e[0]/this.pixelRatio,r=(this.fullHeight-e[1])/this.pixelRatio;t[0]=n,t[1]=r}sphereFrustumCoverage(e,t){let{center:n,eye:r,distance:i,fovY:a}=this,o=Math.abs(Math.PI/2-kt(t,n,r));return e.frustumCoverage(o,i,a)}_computeUpGlobal(){V(G,this.center,this.eye);let e=F(this.center);e<1?L(this._up,De)&&(g(this._up,De),this._markViewDirty(),this.notifyChange(`_up`)):Math.abs(M(G,this.center))>.9999*F(G)*e||(B(K,G,this.center),B(K,K,G),R(K,K),L(this._up,K)||(g(this._up,K),this.notifyChange(`_up`),this._markViewDirty()))}_computeUpLocal(){Ce(G,this.eye,this.center),Math.abs(G[2])<=.9999&&(i(G,G,G[2]),C(G,-G[0],-G[1],1-G[2]),R(G,G),L(this._up,G)||(g(this._up,G),this.notifyChange(`_up`),this._markViewDirty()))}_compareAndSetView(e,t,n=``){typeof e[0]==`number`&&isFinite(e[0])&&typeof e[1]==`number`&&isFinite(e[1])&&typeof e[2]==`number`&&isFinite(e[2])?L(e,t)||(g(t,e),this._markViewDirty(),n.length&&this.notifyChange(n)):Be.getLogger(`esri.views.3d.webgl-engine.lib.RenderCamera`).warn(`RenderCamera vector contains invalid number, ignoring value`)}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&=(xt(this.viewMatrix,this.projectionMatrix,this._frustum),!1)}_ensureViewClean(){this._viewDirty&&(D(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange(`_viewMatrix`),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};P([a()],U.prototype,`_viewport`,void 0),P([a()],U.prototype,`_padding`,void 0),P([a()],U.prototype,`_fov`,void 0),P([a()],U.prototype,`_nearFar`,void 0),P([a()],U.prototype,`_viewDirty`,void 0),P([a()],U.prototype,`_viewMatrix`,void 0),P([a()],U.prototype,`_pixelRatio`,void 0),P([a()],U.prototype,`pixelRatio`,null),P([a()],U.prototype,`row`,void 0),P([a()],U.prototype,`column`,void 0),P([a()],U.prototype,`_rows`,void 0),P([a()],U.prototype,`rows`,null),P([a()],U.prototype,`_columns`,void 0),P([a()],U.prototype,`columns`,null),P([a()],U.prototype,`eye`,null),P([a()],U.prototype,`center`,null),P([a()],U.prototype,`_center`,void 0),P([a()],U.prototype,`up`,null),P([a()],U.prototype,`_up`,void 0),P([a()],U.prototype,`viewMatrix`,null),P([a({readOnly:!0})],U.prototype,`viewForward`,null),P([a({readOnly:!0})],U.prototype,`viewUp`,null),P([a({readOnly:!0})],U.prototype,`viewRight`,null),P([a({readOnly:!0})],U.prototype,`nearFar`,null),P([a()],U.prototype,`near`,null),P([a()],U.prototype,`far`,null),P([a()],U.prototype,`viewport`,null),P([a({readOnly:!0})],U.prototype,`screenViewport`,null),P([a({readOnly:!0})],U.prototype,`screenPadding`,null),P([a()],U.prototype,`x`,null),P([a()],U.prototype,`y`,null),P([a()],U.prototype,`width`,null),P([a()],U.prototype,`height`,null),P([a()],U.prototype,`fullWidth`,null),P([a()],U.prototype,`fullHeight`,null),P([a({readOnly:!0})],U.prototype,`_aspect`,null),P([a()],U.prototype,`padding`,null),P([a({readOnly:!0})],U.prototype,`projectionMatrix`,null),P([a({readOnly:!0})],U.prototype,`inverseProjectionMatrix`,null),P([a()],U.prototype,`fov`,null),P([a()],U.prototype,`fovX`,null),P([a()],U.prototype,`fovY`,null),P([a()],U.prototype,`viewInverseTransposeMatrix`,null),P([a({readOnly:!0})],U.prototype,`_projectionMatrixInternal`,null),P([a()],U.prototype,`relativeElevation`,void 0),U=It=P([S(`esri.views.3d.webgl.RenderCamera`)],U);var Lt=U,W=ae(),Rt=T(),G=j(),K=j(),zt=Me(),Bt=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerViewUids=[],this.store=2,this.normalRequired=!0,this.excludeLabels=!1}},Vt=class{constructor(){this._transform=T(),this._transformInverse=new Ht({value:this._transform},b,T),this._transformInverseTranspose=new Ht(this._transformInverse,O,T),this._transformTranspose=new Ht({value:this._transform},O,T),this._transformInverseRotation=new Ht({value:this._transform},d,c)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){E(this._transform,e)}multiplyTransform(e){w(this._transform,this._transform,e)}set(e){E(this._transform,e),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,t){this.setTransformMatrix(e),this.multiplyTransform(t),this._invalidateLazyTransforms()}},Ht=class{constructor(e,t,n){this._original=e,this._update=t,this._dirty=!0,this._transform=n()}invalidate(){this._dirty=!0}get value(){return this._dirty&&=(this._update(this._transform,this._original.value),!1),this._transform}},Ut=class{constructor(e=0){this.offset=e,this.tmpVertex=j()}applyToVertex(t,n,r){let i=C(qt,t,n,r),a=y(Jt,i,this.localOrigin),o=this.offset/F(a);return e(this.tmpVertex,i,a,o),this.tmpVertex}applyToAabb(e){let t=Yt,n=Xt,r=Zt;for(let i=0;i<3;++i)t[i]=e[0+i]+this.localOrigin[i],n[i]=e[3+i]+this.localOrigin[i],r[i]=t[i];let i=this.applyToVertex(t[0],t[1],t[2]);for(let t=0;t<3;++t)e[t]=i[t],e[t+3]=i[t];let a=t=>{let n=this.applyToVertex(t[0],t[1],t[2]);for(let t=0;t<3;++t)e[t]=Math.min(e[t],n[t]),e[t+3]=Math.max(e[t+3],n[t])};for(let e=1;e<8;++e){for(let i=0;i<3;++i)r[i]=e&1<<i?n[i]:t[i];a(r)}let o=0;for(let e=0;e<3;++e)t[e]*n[e]<0&&(o|=1<<e);if(o!==0&&o!==7){for(let e=0;e<8;++e)if((o&e)===0){for(let i=0;i<3;++i)r[i]=o&1<<i?0:e&1<<i?t[i]:n[i];a(r)}}for(let t=0;t<3;++t)e[t]-=this.localOrigin[t],e[t+3]-=this.localOrigin[t];return e}},Wt=class{constructor(e=0){this.componentLocalOriginLength=0,this._totalOffset=0,this._offset=0,this._tmpVertex=j(),this._tmpMbs=new ft,this._tmpObb=new nt,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=F(e)}applyToVertex(t,n,r){let i=C(qt,t,n,r),a=C(Jt,t,n,r+this.componentLocalOriginLength),o=this._totalOffset/F(a);return e(this._tmpVertex,i,a,o),this._tmpVertex}applyToAabb(e){let t=this.componentLocalOriginLength,n=e[0],r=e[1],i=e[2]+t,a=e[3],o=e[4],s=e[5]+t,c=Math.abs(n),l=Math.abs(r),u=Math.abs(i),d=Math.abs(a),f=Math.abs(o),p=Math.abs(s),m=.5*(1+Math.sign(n*a))*Math.min(c,d),h=.5*(1+Math.sign(r*o))*Math.min(l,f),g=.5*(1+Math.sign(i*s))*Math.min(u,p),_=Math.max(c,d),v=Math.max(l,f),y=Math.max(u,p),b=Math.sqrt(m*m+h*h+g*g),x=Math.sign(c+n),S=Math.sign(l+r),C=Math.sign(u+i),w=Math.sign(d+a),ee=Math.sign(f+o),te=Math.sign(p+s),T=this._totalOffset;if(b<T)return e[0]-=(1-x)*T,e[1]-=(1-S)*T,e[2]-=(1-C)*T,e[3]+=w*T,e[4]+=ee*T,e[5]+=te*T,e;let E=T/Math.sqrt(_*_+v*v+y*y),ne=T/b,D=ne-E,O=-D;return e[0]+=n*(x*O+ne),e[1]+=r*(S*O+ne),e[2]+=i*(C*O+ne),e[3]+=a*(w*D+E),e[4]+=o*(ee*D+E),e[5]+=s*(te*D+E),e}applyToMbs(t){let n=t.center,r=F(n),i=this._totalOffset/r;return e(this._tmpMbs.center,n,n,i),this._tmpMbs.radius=t.radius+t.radius*this._totalOffset/r,this._tmpMbs}applyToObb(e){return tt(e,this._totalOffset,this._totalOffset,1,this._tmpObb),this._tmpObb}},Gt=new class{constructor(e=0){this.offset=e,this.tmpVertex=j(),this._tmpSphere=new ft}applyToVertex(t,n,r){let i=this.objectTransform.transform,a=(C(qt,t,n,r)),o=(A(a,a,i)),s=this.offset/(F(o));e(o,o,o,s);let c=this.objectTransform.inverse;return A(this.tmpVertex,o,c),this.tmpVertex}applyToMinMax(t,n){let r=this.offset/(F(t));e(t,t,t,r);let i=this.offset/(F(n));e(n,n,n,i)}applyToAabb(e){let t=this.offset/(Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]));e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;let n=this.offset/(Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]));return e[3]+=e[3]*n,e[4]+=e[4]*n,e[5]+=e[5]*n,e}applyToBoundingSphere(t){let n=t.center,r=(F(n)),i=this.offset/r;return e(this._tmpSphere.center,n,n,i),this._tmpSphere.radius=t.radius+t.radius*this.offset/r,this._tmpSphere}};function Kt(e){return e==null?null:(Gt.offset=e,Gt)}new Wt,new Ut;var qt=j(),Jt=j(),Yt=j(),Xt=j(),Zt=j(),Qt=1e-5,$t=class{constructor(e){this.options=new Bt,this._results=new tn,this.transform=new Vt,this.camera=new Lt,this.tolerance=Qt,this.verticalOffset=null,this._ray=H(),this._rayEnd=j(),this._rayBeginTransformed=j(),this._rayEndTransformed=j(),this.viewingMode=e??1}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,n){this.resetWithRay(ot(e,t,this._ray),n)}resetWithRay(e,t){this.camera=t,e!==this._ray&&it(e,this._ray),this.options.verticalOffset===0?this.verticalOffset=null:this.viewingMode===2?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset,y(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,t,n,r,i){this.point=t,this.filterPredicate=r,this.tolerance=n??1e-5;let a=Kt(this.verticalOffset);if(e&&e.length>0){let t=i?e=>{i(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(let n of e){let e=n.getSpatialQueryAccelerator?.();e==null?n.objects.forEach(e=>t(e)):(a==null?e.forEachAlongRay(this._ray.origin,this._ray.direction,t):e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,a),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t))}}this.sortResults()}intersectObject(e){let t=e.geometries;if(!t)return;let n=e.effectiveTransformation,r=Kt(this.verticalOffset);for(let i of t){if(!i.visible)continue;let{material:t,id:a}=i;if(!t.visible)continue;this.transform.setAndInvalidateLazyTransforms(n,i.transformation),A(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),A(this._rayEndTransformed,this.rayEnd,this.transform.inverse);let o=this.transform.transform;r!=null&&(r.objectTransform=this.transform),t.intersect(i,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(t,n,r,i)=>this.handleObjectIntersection({object:e,geometryId:a,primitiveIndex:r},t,n,o,i))}}handleObjectIntersection(e,t,n,r,i){if(t<0||this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,t))return;let a=i?this._results.hud:this._results;e=i?new lt(e,i):e;let o=i?r=>r.set(1,e,t,n):i=>i.set(4,e,t,n,r);if((a.min.distance==null||t<a.min.distance)&&o(a.min),this.options.store!==0&&(a.max.distance==null||t>a.max.distance)&&o(a.max),this.options.store===2)if(i){let e=new st(this._ray);o(e),this._results.hud.all.push(e)}else{let e=new ct(this._ray);o(e),this._results.all.push(e)}}sortResults(e=this._results.all){e.sort((e,t)=>e.distance===t.distance?e.drapedLayerOrder===t.drapedLayerOrder?en(e.renderPriority,t.renderPriority):en(e.drapedLayerOrder,t.drapedLayerOrder):(e.distance??0)-(t.distance??0))}};function en(e,t){return(t??-Number.MAX_VALUE)-(e??-Number.MAX_VALUE)}var tn=class{constructor(){this.min=new ct(H()),this.max=new ct(H()),this.hud={min:new st(H()),max:new st(H()),all:[]},this.ground=new ct(H()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}};j(),j(),j();function nn(e,t){let n=[],r=[];return rn(n,e,t,0),rn(r,n,t,1),rn(n,r,t,2),rn(r,n,t,3),r}function rn(e,t,n,r){let i=on(n,r);if(e.length=0,t.length){i(sn,t[0],t[0])===1&&an(e,t[0]);for(let n=0;n<t.length;n++){let r=t[n===t.length-1?0:n+1];switch(i(sn,t[n],r)){case 1:an(e,r);break;case 3:an(e,h(sn));break;case 2:an(e,h(sn)),an(e,r)}}}}function an(e,t){e.length!==0&&Fe(e.at(-1),t)||e.push(t)}function on(e,t){let n=t===0||t===2?0:1,r=e[t],i=t===0||t===1?1:-1,a=n===0?1:0;return(e,t,o)=>{if(t[n]<r&&o[n]<r)return i===1?0:1;if(t[n]>r&&o[n]>r)return i===1?1:0;let s=(o[a]-t[a])/(o[n]-t[n]),c=t[a]+s*(r-t[n]);return e[n]=r,e[a]=c,(t[n]<r?1:-1)*i>0?2:3}}var sn=x(),cn=j(),ln=j();function un(){return{direction:j(),up:j()}}function dn(e,t,n,r,a){let o=R(cn,e),s=M(o,r),c=s>0;s=Math.abs(s),s>.99&&(s=Math.abs(M(t,r)),s<.99?(g(o,t),c&&i(o,o,-1)):o=null);let l=0;if(o){i(ln,r,M(r,o)),V(o,o,ln);let e=M(o,a)/(F(o)*F(a));B(ln,o,a),l=(M(ln,r)>0?1:-1)*k(Ae(e))}let u=k(Ae(-M(r,e)/F(e)));return n?(n.heading=l,n.tilt=u,n):{heading:l,tilt:u}}function fn(e,t,n,r){V(pn,n,t),Ze(r,mt(t,pn),e)||e===n||g(e,n)}var pn=j(),mn=z(0,1,0),hn=z(0,0,1),gn=T(),q=j(),J=j();function _n(e,t,n,r=un()){let{direction:a,up:o}=r;return He(gn,-N(t)),p(gn,gn,N(n)),A(a,hn,gn),i(a,a,-1),A(o,mn,gn),r}function vn(e,t,n,r){return dn(t,n,r,hn,mn)}function yn(e,t,n,r){let a=_n(e,n,r),o=j();return i(o,a.direction,-t),y(o,o,e),{up:a.up,eye:o,heading:n,tilt:r}}function bn(e){return k(e)}function xn(e){return N(e)}function Sn(e,t,n,r,i){let a=e.renderSpatialReference,o=e.spatialReference??t.spatialReference;return $e(t,q,a),$e(t,J,a),q[0]-=n/2,J[0]+=n/2,q[1]-=r/2,J[1]+=r/2,et(q,a,q,o),et(J,a,J,o),i?(i.xmin=q[0],i.ymin=q[1],i.xmax=J[0],i.ymax=J[1],i.spatialReference=o):i=new le(q[0],q[1],J[0],J[1],o),i}function Cn(e,t){let n=e.frustum,{renderCoordsHelper:r}=e,i=r.getAltitude(t),a=e.spatialReference,o=e.state.camera.eye,s=[],c=n.planes[5];for(let e=0;e<4;e++){let t=n.lines[e];r.intersectInfiniteManifold(at(t.origin,t.direction),i,Y)||wn(Y,n,r,t.endpoint,i),fn(Y,o,Y,c),s.push(u(Y[0],Y[1]))}return Tn(nn(s,r.extent),r,a)}function wn(t,n,r,i,a){let o=n.lines[11].direction,s=(a-r.getAltitude(i))/o[2];e(t,i,o,s)}function Tn(e,t,n){let r=e.map(e=>(C(Y,e[0],e[1],0),t.fromRenderCoords(Y,Y,n),[Y[0],Y[1]]));return r.length<=2?new xe({spatialReference:n}):(r.push(r[0].slice()),re(r)||r.reverse(),new xe({rings:[r],spatialReference:n}))}var Y=j();Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:vn,eyeForCenterWithHeadingTilt:yn,eyeTiltToLookAtTilt:xn,headingTiltToDirectionUp:_n,lookAtTiltToEyeTilt:bn,toArea:Cn,toExtent:Sn},Symbol.toStringTag,{value:`Module`}));var En=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}get origin(){return this._origin}get boundingSphere(){return this._boundingSphereDirty&&this._updateBoundingSphere(),this._boundingSphere}constructor(e){this.renderCoordsHelper=e,this.frustum=bt(),this._points=wt(),this.lines=Array(12),this._origin=j(),this._direction=j(),this._boundingSphere=new ft,this._altitude=null,this._boundingSphereDirty=!0;for(let e=0;e<12;e++)this.lines[e]={origin:null,direction:j(),endpoint:null}}update(e){xt(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),g(this._origin,e.eye),g(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines(),this._boundingSphereDirty=!0}updatePoints(e){for(let t=0;t<this._points.length;t++)g(this._points[t],e[t]);St(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return yt(this.frustum,e)}intersectsRay(e){return Ct(this.frustum,e)}intersectsLineSegment(e,t){return Tt(this.frustum,e,t)}intersectsPoint(e){return Et(this.frustum,e)}_updateLines(){let e=this._points;for(let t=0;t<4;t++){let n=t+4;Dn(this.lines[t],e[t],e[n]),Dn(this.lines[t+4],e[t],t===3?e[0]:e[t+1]),Dn(this.lines[t+8],e[n],t===3?e[4]:e[n+1])}}_updateBoundingSphere(){let{origin:t}=this,n=kn;R(n,this.direction);let r=On;Ie(r,this.points[4],t);let i=.5*M(r,r)/M(n,r),a=this._boundingSphere;a.center=e(An,t,n,i),a.radius=i}static{this.planePointIndices=Dt}static{this.nearFarLineIndices=[[0,4],[1,5],[2,6],[3,7]]}};function Dn(e,t,n){e.origin=t,e.endpoint=n,Ce(e.direction,t,n)}var On=j(),kn=j(),An=j(),jn=z(parseFloat(5802e-9.toFixed(6)),parseFloat(13558e-9.toFixed(6)),parseFloat(331e-7.toFixed(6))),Mn=3,Nn=z(Mn*parseFloat(65e-8.toFixed(6)),Mn*parseFloat(1881e-9.toFixed(6)),Mn*parseFloat(85e-9.toFixed(6)));z(parseFloat(Number(jn[0]+Nn[0]).toFixed(6)),parseFloat(Number(jn[1]+Nn[1]).toFixed(6)),parseFloat(Number(jn[2]+Nn[2]).toFixed(6)));var Pn=class e{constructor(e=1/0,t=-1/0){this.near=e,this.far=t}set(e,t){this.near=e,this.far=t}union(e){return e!=null&&(this.near=Math.min(this.near,e.near),this.far=Math.max(this.far,e.far)),this}within(e){return this.near<=e&&e<=this.far}equals(e){return this.near===e.near&&this.far===e.far}static{this.Zero=new e(0,0)}static{this.Infinite=new e}};j(),j(),new ft,H();function Fn(e,t,n){let r=t/n,i=N(e),a=Math.sin(r/2),o=Math.cos(i),s=2*Pe(Math.sqrt(a*a/(o*o)));return k(s)}var In=z(0,0,1),Ln=R(j(),z(1,1,1)),Rn=T(),X=j(),zn=j();function Bn(e,t,r,i=un()){B(X,e,In),M(X,X)===0&&B(X,e,Ln),n(Rn,-N(t),e),o(Rn,Rn,-N(r),X);let{up:a,direction:s}=i;return B(a,X,e),R(a,a),A(a,a,Rn),R(s,e),f(s,s),A(s,s,Rn),i}function Vn(e,t,n,r){let i=X,a=zn;return R(i,e),B(zn,i,In),M(zn,zn)===0&&B(zn,i,Ln),B(a,zn,i),dn(t,n,r,i,a)}function Hn(e,t,n,r){let a={eye:j(),up:null,tilt:r,heading:n},o=X;o[0]=e[0],o[1]=e[2],o[2]=-e[1];let s=t,c=N(n),l=N(r),u=Math.sin(c),d=Math.cos(c),f=Math.sin(l),p=Math.cos(l),m=F(o),h;if(Math.abs(l)<1e-8)h=s+m;else{let e=m/f,t=Pe(s/e),n=Math.PI-l-t;h=e*Math.sin(n)}let g=p*s,_=s*s*(f*f),v=d*d*_,y=h-g,b=y*y,x=v*(v+b-o[1]*o[1]);if(x<0)return i(a.eye,o,h/m),a.tilt=0,Wn(a,e);let S=Math.sqrt(x),C=o[1]*y,w=v+b,ee;if(ee=d>0?-S+C:S+C,Math.abs(w)<1e-8)return m<1e-8?(a.eye[0]=0,a.eye[1]=0,a.eye[2]=s):i(a.eye,o,h/m),a.tilt=0,Un(a.eye),Wn(a,e);a.eye[1]=ee/w;let te=u*u*_,T=f*s,E=d*T*a.eye[1],ne=a.eye[1]*a.eye[1],D=1-ne,O=Math.sqrt(D),re=v*ne+te-2*E*O*y+D*b;return Math.abs(re)<1e-8?(i(a.eye,o,h/m),a.tilt=0,Un(a.eye),Wn(a,e)):(a.eye[0]=(D*(h*o[0]-g*o[0])-T*O*(o[0]*a.eye[1]*d+o[2]*u))/re,a.eye[2]=(D*(h*o[2]-g*o[2])-T*O*(o[2]*a.eye[1]*d-o[0]*u))/re,i(a.eye,a.eye,h),Un(a.eye),Wn(a,e))}function Un(e){let t=e[1];e[1]=-e[2],e[2]=t}function Wn(e,t){return e.up=Bn(t,e.heading,e.tilt).up,e}function Gn(e,t,n){let r=F(t),i=Math.sqrt(n*n+r*r-2*n*r*Math.cos(Math.PI-e)),a=Pe(n/(i/Math.sin(e)));return k(e-a)}function Kn(e,t,n){let r=N(e),i=F(t);return Pe(n/(i/Math.sin(r)))+r}function qn(e,t,n,r,i){let a,o,s,c,l=t.latitude,u=Le(e.spatialReference).radius,d=t.longitude,f=Fn(l,n,u)/2;a=d-f,o=d+f;let p=N(l),m=(1+Math.sin(p))/(1-Math.sin(p)),h=(m+1)*Math.tan(r/u/2),g=h*h;function _(e){let t=Math.PI/2;return(e=ie.normalize(e,-t))>t&&(e=Math.PI-e),e}if(s=1.5*Math.PI-2*Math.atan(.5*(h+Math.sqrt(4*m+g))),c=s+r/u,s=_(s),c=_(c),c<s){let e=c;c=s,s=e}if(s=Math.max(k(s),-90),c=Math.min(k(c),90),o=we.monotonic(a,o),o-a>180){let e=(o-a-180)/2;a+=e,o-=e}let v=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:Ue.WGS84;return i?(i.xmin=a,i.ymin=s,i.xmax=o,i.ymax=c,i.spatialReference=v):i=new le(a,s,o,c,v),e.spatialReference&&e.spatialReference.isWebMercator&&ue(i,!1,i),i}function Jn(e,t){let{renderCoordsHelper:n}=e,r=e.state.camera.clone(),i=new En(n);r.near=2,i.update(r);let a=n.getAltitude(t),o=e.spatialReference,s=n.referenceEllipsoid.radius,c=r.eye,l=1+be(c,t)/(s+a),u=Math.sqrt(l*l-1),{minCurvature:d,maxCurvature:f,minSamples:p,maxSamples:m}=$n,h=Qn(e),g=de((u-d)/(f-d),0,1),_=Math.round(I(p,m,g)),v=r.aboveGround,y=i.planes[5],b=[],x=Xe(ye,er,Qe()),S=Xe(ye,tr,Qe());Ee(or,0,0,0,0);for(let e=0;e<4;e++){let t=e===1&&!v||e===3&&v?1-h:0,r=e===1&&v||e===3&&!v?h:1,o=i.lines[e],s=i.lines[e===3?0:e+1];for(let i=0;i<_;i++){let l=i/_,u=i===0?0:I(t,r,e===1?1-(1-l)**2:e===3?l**2:l),d=ze(rr,o.origin,s.origin,u),f=Ge(o.direction,s.direction,u,nr);n.intersectManifoldClosestSilhouette(at(d,f),a,Z),fn(Z,c,Z,y),b.push(pe(Z)),b.length!==0&&_e(b.at(-1),Z);let p=(Je(x,Z)?1:0)|(Je(S,Z)?2:0);or[p]=1}}b.length>2&&_e(b[0],b.at(-1));let C=Yn(me(or)>1?Xn(Zn(b,x),S):[b],n,o);return new xe({rings:C,spatialReference:o})}function Yn(e,t,n){let r=2*v();return e.map(e=>{let i=[],a=!1;for(let o of e)t.fromRenderCoords(o,Z,n),Math.abs(o[0])<r&&Math.abs(o[1])<r?(i.push([null,Z[1]]),i.push([null,Z[1]]),a=!0):i.push([Z[0],Z[1]]);if(a)for(let e=0;e<i.length;e++){let t=i[e];if(t[0]!=null)continue;let n=i[e+1];t[0]=i.at(e===0?-1:e-1)[0],e++,n[0]=i.at(e===i.length-1?0:e+1)[0]}return i.push(i[0]),re(i)||i.reverse(),i})}function Xn(e,t){let n=[];for(let r of e)n.push(...Zn(r,t));return n}function Zn(t,n){let r=[],i=[],a=v();for(let o=0;o<t.length;o++){let s=t[o],c=o===t.length-1?t[0]:t[o+1],l=ht(s,c,ar),u=Ke(n,l.origin,l.vector,0,Z);switch(u){case 2:r.push(s);break;case 3:i.push(s);break;case 0:case 1:{let[t,o,c]=u===0?[1,r,i]:[-1,i,r],l=qe(n),d=e(j(),Z,l,t*a),f=e(j(),Z,l,t*-a);o.push(s),o.push(d),c.push(f)}}}let o=[];return r.length&&o.push(r),i.length&&o.push(i),o}function Qn(e){let{renderCoordsHelper:t,state:n}=e,r=Math.abs(t.getAltitude(n.camera.center));return ir.radius=t.referenceEllipsoid.radius+r,n.camera.sphereFrustumCoverage(ir,t)}var $n={minCurvature:N(5),maxCurvature:N(50),minSamples:1,maxSamples:6},er=z(1,0,0),tr=z(0,1,0),nr=j(),rr=j(),Z=j(),ir=new ft,ar=pt(),or=ae();Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:Vn,eyeForCenterWithHeadingTilt:Hn,eyeTiltToLookAtTilt:Kn,headingTiltToDirectionUp:Bn,lookAtTiltToEyeTilt:Gn,toArea:Jn,toExtent:qn},Symbol.toStringTag,{value:`Module`}));var sr={OPAQUE:`opaque-color`,TRANSPARENT:`transparent-color`,COMPOSITE:`composite-color`,FINAL:`final-color`},cr={SSAO:`ssao`,LASERLINES:`laserline-color`,ANTIALIASING:`aa-color`,HIGHLIGHTS:`highlight-color`,MAGNIFIER:`magnifier-color`,OCCLUDED:`occluded-color`,VIEWSHED:`viewshed-color`,CUTFILL_DEPTH:`cutfill-depth`,CUTFILL_COLOR:`cutfill-color`,OPAQUE_TERRAIN:`opaque-terrain-color`,OPAQUE_ENVIRONMENT:`opaque-environment-color`,TRANSPARENT_ENVIRONMENT:`transparent-environment-color`,FOCUSAREA:`focusarea`,FOCUSAREA_COLOR:`focusarea-color`};j();var Q=class extends ce{constructor(e){super(e),this.view=null,this.consumes={required:[]},this.produces=sr.COMPOSITE,this.requireGeometryDepth=!1,this._dirty=!0}initialize(){this.addHandles([ke(()=>this.view.ready,e=>{e&&this.view.stage?.renderer.addRenderNode(this)},fe)])}destroy(){this.view.stage?.renderer?.removeRenderNode(this)}precompile(){}render(){throw new t(`RenderNode:render-function-not-implemented`,`render() is not implemented.`)}get camera(){return this.view.state.camera.clone()}get sunLight(){return this.bindParameters.lighting.legacy}get gl(){return this.view.stage.renderView.renderingContext.gl}get techniques(){return this.view.stage.renderView.techniques}acquireOutputFramebuffer(){let e=this._frameBuffer?.getTexture()?.descriptor,t=this.view.stage.renderer.fboCache.acquire(e?.width??640,e?.height??480,this.produces);return t.fbo?.initializeAndBind(),t}bindRenderTarget(){return this._frameBuffer?.fbo?.initializeAndBind(),this._frameBuffer}requestRender(e){switch(e){case 2:this.view.state.fading=!0;case 1:this.view.stage?.renderView.requestRender(e);case 0:case void 0:this._dirty=!0}}resetWebGLState(){this.renderingContext.resetState(),this.renderingContext.bindFramebuffer(this._frameBuffer?.fbo)}get fboCache(){return this.view.stage.renderer.fboCache}get bindParameters(){return this.renderContext.bind}get renderingContext(){return this.view.stage.renderView.renderingContext}get renderContext(){return this.view.stage?.renderer.renderContext}updateAnimation(e){return!!this._dirty&&(this._dirty=!1,!0)}doRender(e){this._frameBuffer=e.find(({name:e})=>e===this.produces);try{return this.render(e)}finally{this._frameBuffer=null}}};P([We({constructOnly:!0})],Q.prototype,`view`,void 0),P([We({constructOnly:!0})],Q.prototype,`consumes`,void 0),P([We()],Q.prototype,`produces`,void 0),P([We({readOnly:!0})],Q.prototype,`techniques`,null),Q=P([l(`esri.views.3d.webgl.RenderNode`)],Q);var lr=class{constructor(e,t){this._module=e,this._load=t}get(){return this._module}async reload(){return this._module=await this._load(),this._module}},ur=[],dr=[new dt(`position`,3,_.FLOAT,0,12)],fr=[new dt(`position`,2,_.FLOAT,0,8)],pr=ut(fr);ut(dr),new dt(`position`,2,_.FLOAT,0,12),new dt(`uv0`,2,_.HALF_FLOAT,8,12),new dt(`position`,2,_.FLOAT,0,16),new dt(`uv0`,2,_.FLOAT,8,16);var mr=class{constructor(e,t,n){this._context=e,this.locations=n,this._textures=new Map,this.source=r()?t:null,t.attributeNames.forEach(e=>{n.has(e)||console.error(`Missing VertexAttributeLocation for ${e} used in shader`)}),this._glProgram=e.programCache.acquire(t.generate(`vertex`,!0),t.generate(`fragment`,!0),n),this._glProgram.stop=()=>{throw Error(`Wrapped _glProgram used directly`)},this.bind=t.generateBind(this),this.bindPass=t.generateBindPass(this),this.bindDraw=t.generateBindDraw(this)}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get hasTransformFeedbackVaryings(){return this._glProgram.hasTransformFeedbackVaryings}get compiled(){return this._glProgram.compiled}setUniform1b(e,t){this._glProgram.setUniform1i(e,t?1:0)}setUniform1i(e,t){this._glProgram.setUniform1i(e,t)}setUniform1f(e,t,n){this._glProgram.setUniform1f(e,t,n)}setUniform2fv(e,t,n){this._glProgram.setUniform2fv(e,t,n)}setUniform3fv(e,t,n){this._glProgram.setUniform3fv(e,t,n)}setUniform4fv(e,t,n){this._glProgram.setUniform4fv(e,t,n)}setUniformMatrix3fv(e,t,n){this._glProgram.setUniformMatrix3fv(e,t,!1,n)}setUniformMatrix4fv(e,t,n){this._glProgram.setUniformMatrix4fv(e,t,!1,n)}setUniformMatrices4fv(e,t,n){this._glProgram.setUniformMatrices4fv(e,t,!1,n)}setUniform1fv(e,t,n){this._glProgram.setUniform1fv(e,t,n)}setUniform1iv(e,t){this._glProgram.setUniform1iv(e,t)}setUniform2iv(e,t){this._glProgram.setUniform2iv(e,t)}setUniform3iv(e,t){this._glProgram.setUniform3iv(e,t)}setUniform4iv(e,t){this._glProgram.setUniform4iv(e,t)}assertCompatibleVertexAttributeLocations(e,t){let n=e.locations;if(t){let e=new Map(n);t.forEach((t,r)=>e.set(r,n.size+t)),n=e}n.size!==this.locations.size&&console.error(`VertexAttributeLocations are incompatible: ${n}, ${this.locations}`),this.locations.forEach((e,t)=>{n.get(t)!==e&&console.error(`VertexAttributeLocations are incompatible: Program has ${t} at position ${e}, VAO has it at position ${n.get(t)}.`)})}stop(){this._textures.clear()}bindTexture(e,t){if(!t?.glName){let n=`Texture sampler ${e} in ${this._context.debugBoundTechnique} has no given Texture in ${Error().stack}`;r()&&console.error(n),t=this._context.emptyTexture}let n=this._ensureTextureUnit(e,t);this._context.useProgram(this),this.setUniform1i(e,n.unit),this._context.bindTexture(t,n.unit)}_ensureTextureUnit(e,t){let n=this._textures.get(e);return n==null?(n={texture:t,unit:this._textures.size},this._textures.set(e,n)):n.texture=t,n}},hr=()=>Be.getLogger(`esri.views.3d.webgl.ShaderTechnique`),gr=class extends ce{constructor(e,t,n=pr){super({}),this._context=e,this._configuration=t,this.locations=n,this.primitiveType=m.TRIANGLES,this.key=t.key,this._pipeline=this.initializePipeline(t),this.reload=async r=>{r&&await this.shader.reload(),this.key.equals(t.key)||hr().warn(`Configuration was changed after construction, cannot reload shader.`,this.shader),he(this._program);let i=this.shader.get().build(t);i.debugName=this.declaredClass,this._program=new mr(e.rctx,i,n),this._pipeline=this.initializePipeline(t)}}initialize(){let e=this.shader.get().build(this._configuration);e.debugName=this.declaredClass,this._program=new mr(this._context.rctx,e,this.locations)}destroy(){this._program=he(this._program),this._pipeline=null}get program(){return this._program}get compiled(){return this.program.compiled}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}getPipeline(e,t){return this._pipeline}initializePipeline(e){return vt({blending:_t,colorWrite:gt})}};function _r(e,t){return rt(e)?{buffers:[0]}:t??null}gr=P([S(`esri.views.3d.webgl-engine.core.shaderTechnique.ShaderTechnique`)],gr);var vr=class{constructor(e=Se()){this.intensity=e}},yr=class{constructor(e=Se(),t=z(.57735,.57735,.57735)){this.intensity=e,this.direction=t}},br=class{constructor(e=Se(),t=z(.57735,.57735,.57735),n=!0,r=1,i=1){this.intensity=e,this.direction=t,this.castShadows=n,this.specularStrength=r,this.environmentStrength=i}},xr=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}};function Sr(e,t,n){(n||=e).length=e.length;for(let r=0;r<e.length;r++)n[r]=e[r]*t[r];return n}function Cr(e,t,n){(n||=e).length=e.length;for(let r=0;r<e.length;r++)n[r]=e[r]*t;return n}function wr(e,t,n){(n||=e).length=e.length;for(let r=0;r<e.length;r++)n[r]=e[r]+t[r];return n}function Tr(e){return(e+1)*(e+1)}function Er(e){return de(Math.floor(Math.sqrt(e)-1),0,2)}function Dr(e,t,n){let r=e[0],i=e[1],a=e[2],o=n||[];return o.length=Tr(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*r,o[2]=.4886025119*a,o[3]=.4886025119*i),t>=2&&(o[4]=1.09254843059*r*i,o[5]=1.09254843059*i*a,o[6]=.31539156525*(3*a*a-1),o[7]=1.09254843059*r*a,o[8]=.54627421529*(r*r-i*i)),o}function Or(e,t){let n=Tr(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=n;for(let e=0;e<n;e++)r.r[e]=r.g[e]=r.b[e]=0;return r}function kr(e,t){let n=Er(t.r.length);for(let r of e)f(Ir,r.direction),Dr(Ir,n,$),Sr($,Lr),Cr($,r.intensity[0],Fr),wr(t.r,Fr),Cr($,r.intensity[1],Fr),wr(t.g,Fr),Cr($,r.intensity[2],Fr),wr(t.b,Fr);return t}function Ar(e,t){Dr(Ir,0,$);for(let n of e)t.r[0]+=$[0]*Lr[0]*n.intensity[0]*4*Math.PI,t.g[0]+=$[0]*Lr[0]*n.intensity[1]*4*Math.PI,t.b[0]+=$[0]*Lr[0]*n.intensity[2]*4*Math.PI;return t}function jr(e,t,n,r){Or(t,r),C(n.intensity,0,0,0);let i=!1,a=Mr,o=Nr,s=Pr;a.length=0,o.length=0,s.length=0;for(let t of e)t instanceof br&&!i?(g(n.direction,t.direction),g(n.intensity,t.intensity),n.specularStrength=t.specularStrength,n.environmentStrength=t.environmentStrength,n.castShadows=t.castShadows,i=!0):t instanceof br||t instanceof yr?a.push(t):t instanceof vr?o.push(t):t instanceof xr&&s.push(t);kr(a,r),Ar(o,r);for(let e of s)wr(r.r,e.r),wr(r.g,e.g),wr(r.b,e.b)}var Mr=[],Nr=[],Pr=[],$=[0],Fr=[0],Ir=j(),Lr=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398],Rr=class{constructor(){this.color=j(),this.intensity=1}},zr=class{constructor(){this.direction=j(),this.ambient=new Rr,this.diffuse=new Rr}},Br=.4,Vr=class{constructor(){this._shOrder=2,this._legacy=new zr,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new xr,this._mainLight=new br(j(),z(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(e){jr(e,this._shOrder,this._mainLight,this._sphericalHarmonics),this.updateLegacy()}updateLegacy(){g(this._legacy.direction,this._mainLight.direction);let e=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*e,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*e,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*e,i(this._legacy.diffuse.color,this._mainLight.intensity,e),g(Hr,this._legacy.diffuse.color),i(Hr,Hr,Br*this.globalFactor),y(this._legacy.ambient.color,this._legacy.ambient.color,Hr)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),g(this._mainLight.direction,e.mainLight.direction),g(this._mainLight.intensity,e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,t,n){if(ze(this._mainLight.intensity,e.mainLight.intensity,t.mainLight.intensity,n),this._mainLight.environmentStrength=I(e.mainLight.environmentStrength,t.mainLight.environmentStrength,n),this._mainLight.specularStrength=I(e.mainLight.specularStrength,t.mainLight.specularStrength,n),g(this._mainLight.direction,t.mainLight.direction),this._mainLight.castShadows=t.mainLight.castShadows,this.globalFactor=I(e.globalFactor,t.globalFactor,n),this.noonFactor=I(e.noonFactor,t.noonFactor,n),e.sh.r.length===t.sh.r.length)for(let r=0;r<t.sh.r.length;r++)this._sphericalHarmonics.r[r]=I(e.sh.r[r],t.sh.r[r],n),this._sphericalHarmonics.g[r]=I(e.sh.g[r],t.sh.g[r],n),this._sphericalHarmonics.b[r]=I(e.sh.b[r],t.sh.b[r],n);else for(let e=0;e<t.sh.r.length;e++)this._sphericalHarmonics.r[e]=t.sh.r[e],this._sphericalHarmonics.g[e]=t.sh.g[e],this._sphericalHarmonics.b[e]=t.sh.b[e];this.updateLegacy()}},Hr=j();export{gr as a,Q as c,$t as d,Kt as f,_r as i,cr as l,Br as n,ur as o,Lt as p,vr as r,lr as s,Vr as t,Pn as u};