import{Ap as e,BT as t,B_ as n,En as r,FC as i,Fp as a,Lg as o,Qp as s,RS as c,_S as l,dg as u,gC as d,kp as f,mS as p,qw as m,uE as h,vx as g,wS as _,wx as v}from"./index-ByaFsVj4.js";import{t as y}from"./number-CDIvbS1W.js";import"./memoryEstimations-C5pKF3kD.js";import{t as b}from"./OptimizedGeometry-DX91by73.js";import{n as x}from"./OptimizedFeatureSet-DAaREXtE.js";import"./featureConversionUtils-C045qQF5.js";import"./WhereClause-BExEDKCy.js";import"./WhereClauseCache-DsaoFJQA.js";import"./PooledRBush-7ERPfn8O.js";import"./QueryEngineCapabilities-COyCnRVj.js";import{r as S,t as C}from"./clientSideDefaults-8lL7sncR.js";import"./generateRendererUtils-D58mgMfu.js";import"./utils-2pGpZYJj.js";import"./BoundsStore-CXNHxGlb.js";import"./timeSupport-BE8MSrm_.js";import"./optimizedFeatureQueryEngineAdapter-CqB9xdgB.js";import{t as w}from"./FeatureStore-B4F50Cpk.js";import{t as T}from"./QueryEngine-D34fwTUK.js";import{c as E}from"./queryUtils-DJQEBA7c.js";import"./quantizationUtils-CzrQVcZ1.js";import"./utils-WI4_77dW.js";import"./utils-BV18to1a.js";import"./SnappingCandidate-BMrZX9Ey.js";import"./FixedIntervalBinParameters-CVvi6EKG.js";import{n as D,t as O}from"./date-DKxAu4UK.js";import{t as k}from"./locationUtils--XC6iMLt.js";var A=/^\s*"([\S\s]*)"\s*$/,j=/""/g,M=`
`,N=[`,`,` `,`;`,`|`,`	`];function*P(e,t,n){let r=0;for(;r<=e.length;){let i=e.indexOf(t,r),a=e.slice(r,i>-1?i:void 0);r+=a.length+t.length,n&&!a.trim()||(yield a)}}function F(e){let t=e.includes(`\r
`)?`\r
`:M;return P(e,t,!0)}function I(e,t){return P(e,t,!1)}function L(e,t,n){e=e.trim(),t=t?.trim();let r=[],i=Array.from(new Set([n?.delimiter,...N])).filter(e=>e!=null);for(let n of i){let i=B(e,n).length,a=B(t,n).length??i;i>1&&r.push({weight:Math.min(i,a),delimiter:n})}let a=r.sort(({weight:e},{weight:t})=>t-e).map(({delimiter:e})=>e);for(let t of a){let r=z(e,t).names,i=k(r,n?.longitudeField,n?.latitudeField);if(i.longitudeFieldName&&i.latitudeFieldName)return{delimiter:t,locationInfo:i}}return{delimiter:a[0],locationInfo:null}}function*R(e,t,n,r=()=>Object.create(null)){let i=F(e);i.next();let a=``,o=``,s=0,c=r(),l=0;e:for(let e of i){let i=I(e,n);for(let e of i)if(a+=o+e,o=``,s+=V(e),s%2==0){if(s>0){let e=A.exec(a);if(!e){c=r(),l=0,a=``,s=0;continue e}c[t[l]]=e[1].replaceAll(j,`"`),l++}else c[t[l]]=a,l++;a=``,s=0}else o=n;s===0?(yield c,c=r(),l=0):o=M}}function z(e,t){let n=B(e,t).filter(e=>e!=null),r=n.map(e=>f(e));for(let e=r.length-1;e>=0;e--)r[e]||(r.splice(e,1),n.splice(e,1));return{names:r,aliases:n}}function B(e,t){if(!e?.length)return[];let n=[],r=``,i=``,a=0,o=I(e,t);for(let e of o)if(r+=i+e,i=``,a+=V(e),a%2==0){if(a>0){let e=A.exec(r);e&&n.push(e[1].replaceAll(j,`"`))}else n.push(r);r=``,a=0}else i=t;return n}function V(e){let t=0,n=0;for(n=e.indexOf(`"`,n);n>=0;)t++,n=e.indexOf(`"`,n+1);return t}function H(e,t,n,r,i){let o=[],s=R(e,n,t),c=[];for(let e of s){if(c.length===10)break;c.push(e)}for(let e=0;e<n.length;e++){let t=n[e],s=r[e];if(t===i.longitudeFieldName||t===i.latitudeFieldName)o.push({name:t,type:`esriFieldTypeDouble`,alias:s});else{let e;switch(U(c.map(e=>e[t]))){case`integer`:e=`esriFieldTypeInteger`;break;case`double`:e=`esriFieldTypeDouble`;break;case`date`:e=`esriFieldTypeDate`;break;default:e=`esriFieldTypeString`}o.push({name:t,type:e,alias:s,length:a(e)})}}return o}function U(e){if(!e.length)return`string`;let t=/[^+\-.,0-9]/;return e.map(e=>{if(e!==``){if(!t.test(e)){let t=W(e);if(!isNaN(t))return/[.,]/.test(e)||!Number.isInteger(t)||t>214783647||t<-214783648?`double`:`integer`;if(e.includes(`E`)&&(t=Number(e),!Number.isNaN(t)||e.includes(`,`)&&(e=e.replace(`,`,`.`),t=Number(e),!Number.isNaN(t))))return`double`}return O(e)?`date`:`string`}}).reduce((e,t)=>e===void 0?t:t===void 0?e:e===t?t:e===`string`||t===`string`?`string`:e===`double`||t===`double`?`double`:void 0)}var W=function(){let e=y(),t=RegExp(`^`+e.regexp+`$`),n=RegExp(`[`+e.group+`\\s\\xa0]`,`g`),r=e.factor;return i=>{let a=t.exec(i);if(e.factor=r,!a)return NaN;let o=a[1];if(!a[1]){if(!a[2])return NaN;o=a[2],e.factor*=-1}return o=o.replace(n,``).replace(e.decimal,`.`),+o*e.factor}}();function G(e){return JSON.parse(JSON.stringify(e))}var K=S(`esriGeometryPoint`),q=[`csv`],J=[0,0],Y=class{constructor(e,t){this.x=e,this.y=t}},X=class{constructor(){this._queryEngine=null,this._snapshotFeatures=async e=>{let t=await this._fetch(e);return this._createFeatures(t)}}destroy(){this._queryEngine?.destroy(),this._queryEngine=null}async load(e,t={}){this._loadOptions=e;let[n]=await Promise.all([this._fetch(t.signal),this._checkProjection(e?.parsingOptions?.spatialReference)]),r=Z(n,e);this._locationInfo=r.locationInfo,this._delimiter=r.delimiter,this._queryEngine=this._createQueryEngine(r);let i=this._createFeatures(n);this._queryEngine.featureStore.addMany(i);let{fullExtent:a,timeExtent:o}=await this._queryEngine.fetchRecomputedExtents();if(r.layerDefinition.extent=a,o){let{start:e,end:t}=o;r.layerDefinition.timeInfo.timeExtent=[e,t]}return r}async applyEdits(){throw new t(`csv-layer:editing-not-supported`,`applyEdits() is not supported on CSVLayer`)}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),(await this._queryEngine.executeQueryForIds(e,t.signal)).filter(s)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),await this._queryEngine.executeQueryForSnapping(e,t.signal)}async queryAttributeBins(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeAttributeBinsQuery(e,t.signal)}async refresh(e){this._loadOptions.customParameters=e,this._snapshotTask?.abort(),this._snapshotTask=u(this._snapshotFeatures),this._snapshotTask.promise.then(e=>{this._queryEngine.featureStore.clear(),e&&this._queryEngine.featureStore.addMany(e)},e=>{this._queryEngine.featureStore.clear(),m(e)||h.getLogger(`esri.layers.CSVLayer`).error(new t(`csv-layer:refresh`,`An error occurred during refresh`,{error:e}))}),await this._waitSnapshotComplete();let{fullExtent:n,timeExtent:r}=await this._queryEngine.fetchRecomputedExtents();return{extent:n,timeExtent:r}}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _fetch(e){let{url:n,customParameters:r}=this._loadOptions;if(!n)throw new t(`csv-layer:invalid-source`,`url not defined`);let i=d(n);return(await c(i.path,{query:{...i.query,...r},responseType:`text`,signal:e})).data}_createQueryEngine(e){let{objectIdField:t,fields:n,extent:i,timeInfo:a}=e.layerDefinition,o=new w({geometryType:`esriGeometryPoint`,hasM:!1,hasZ:!1}),s={type:`object-id`,fieldName:t};return new T({fieldsIndex:r.fromLayerJSON({fields:n,dateFieldsTimeReference:{timeZoneIANA:`UTC`}}),geometryType:`esriGeometryPoint`,hasM:!1,hasZ:!1,timeInfo:a,featureIdInfo:s,spatialReference:i.spatialReference||{wkid:4326},featureStore:o})}_createFeatures(t){let{latitudeFieldName:n,longitudeFieldName:r}=this._locationInfo,{objectIdField:i,fieldsIndex:a,spatialReference:s}=this._queryEngine,c=[],u=[],d=a.fields.filter(e=>e.name!==i).map(e=>e.name),f=0,p={};for(let t of a.fields)if(t.type!==`esriFieldTypeOID`&&t.type!==`esriFieldTypeGlobalID`){let n=e(t);n!==void 0&&(p[t.name]=n)}let m=R(t,d,this._delimiter,C(p,i));for(let e of m){let t=this._parseCoordinateValue(e[n]),o=this._parseCoordinateValue(e[r]);if(o!=null&&t!=null&&!isNaN(t)&&!isNaN(o)){for(let i in e[n]=t,e[r]=o,e)if(i!==n&&i!==r)if(a.isDateField(i))e[i]=D(e[i]);else if(a.isNumericField(i)){let t=W(e[i]);isNaN(t)?e[i]=null:e[i]=t}else e[i]!=null&&(e[i]=G(e[i]));e[i]=f,f++,c.push(new Y(o,t)),u.push(e)}}if(!l({wkid:4326},s))if(_(s))for(let e of c)[e.x,e.y]=g(e.x,e.y,J);else c=o(c,v.WGS84,s);let h=[];for(let e=0;e<c.length;e++){let{x:t,y:n}=c[e],r=u[e];r[i]=e+1,h.push(new x(new b([],[t,n]),r,null,r[i]))}return h}_parseCoordinateValue(e){if(e==null||e===``)return null;let t=W(e);return(isNaN(t)||Math.abs(t)>181)&&(t=parseFloat(e)),t}async _checkProjection(e){try{await E(p,e)}catch{throw new t(`csv-layer:projection-not-supported`,`Projection not supported`)}}};function Z(e,n){let a=n.parsingOptions||{},o={delimiter:a.delimiter,layerDefinition:null,locationInfo:{latitudeFieldName:a.latitudeField,longitudeFieldName:a.longitudeField}},s=o.layerDefinition={name:i(n.url,q)||`csv`,dateFieldsTimeReference:{timeZoneIANA:`UTC`},drawingInfo:K,geometryType:`esriGeometryPoint`,objectIdField:null,fields:[],timeInfo:a.timeInfo,extent:{xmin:1/0,ymin:1/0,xmax:-1/0,ymax:-1/0,spatialReference:a.spatialReference||{wkid:4326}}},c=F(e),l=c.next().value?.trim(),u=c.next().value?.trim();if(!l)throw new t(`csv-layer:empty-csv`,`CSV is empty`,{csv:e});let{delimiter:d,locationInfo:f}=L(l,u,a);if(!d)throw new t(`csv-layer:invalid-delimiter`,`Unable to detect the delimiter from CSV`,{firstLine:l,secondLine:u,parsingOptions:a});if(!f)throw new t(`csv-layer:location-fields-not-found`,`Unable to identify latitude and longitude fields from the CSV file`,{firstLine:l,secondLine:u,parsingOptions:a});o.locationInfo=f,o.delimiter=d;let{names:p,aliases:m}=z(l,d),h=H(e,o.delimiter,p,m,o.locationInfo);if(a.fields?.length){let e=new r(a.fields);for(let t of h){let n=e.get(t.name);n&&Object.assign(t,n)}}if(!h.some(e=>e.type===`esriFieldTypeOID`&&(s.objectIdField=e.name,!0))){let e={name:`__OBJECTID`,alias:`__OBJECTID`,type:`esriFieldTypeOID`,editable:!1,nullable:!1};s.objectIdField=e.name,h.unshift(e)}s.fields=h;let g=new r(s.fields);if(o.locationInfo&&(o.locationInfo.latitudeFieldName=g.get(o.locationInfo.latitudeFieldName).name,o.locationInfo.longitudeFieldName=g.get(o.locationInfo.longitudeFieldName).name),s.timeInfo){let e=s.timeInfo;if(e.startTimeField){let t=g.get(e.startTimeField);t?(e.startTimeField=t.name,t.type=`esriFieldTypeDate`):e.startTimeField=null}if(e.endTimeField){let t=g.get(e.endTimeField);t?(e.endTimeField=t.name,t.type=`esriFieldTypeDate`):e.endTimeField=null}if(e.trackIdField){let t=g.get(e.trackIdField);e.trackIdField=t?t.name:null}e.startTimeField||e.endTimeField||(s.timeInfo=null)}return o}export{X as default};