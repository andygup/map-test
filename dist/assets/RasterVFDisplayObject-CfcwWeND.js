import{Aw as e,BT as t,CE as n,Ex as r,Gy as i,Hy as a,Ky as o,Ls as s,Ns as c,Od as l,Qy as u,Tw as d,Uy as f,VT as p,Yy as m,_s as h,au as g,hg as _,kD as v,oT as y,ou as b,pT as x,pv as S,qy as C,vx as ee,ys as te}from"./index-BN8X5Ryz.js";import{n as w,r as T}from"./vectorFieldUtils-BkGOIhR4.js";import{i as E}from"./dataUtils-CwkEyGtp.js";import{n as D}from"./VertexAttributeLocations-BScEla0R.js";import{t as O}from"./VertexElementDescriptor-Cl_nC_ty.js";import{p as k,t as ne}from"./WGLContainer-jm6ZclzQ.js";import{p as re}from"./utils-B0heZPZY.js";import{t as A}from"./VertexArrayObject-ChtD6bwg.js";import{t as j}from"./BufferObject-B3_aJU6V.js";import{t as M}from"./VertexBuffer-Ra4pb4dR.js";import{r as N}from"./Container-uEjPEzbR.js";function ie(e){let t=P(I(e)),n=t,r=Math.max(t/2,5),i=Math.round(_(e.maxPathLength)/r)+1,{density:a}=e;return{smoothing:_(e.smoothing),interpolate:!0,velocityScale:e.flowRepresentation===`flow-from`?1:-1,verticesPerLine:i,minSpeedThreshold:.001,segmentLength:r,maxTurnAngle:1,collisions:!0,lineCollisionWidth:n,lineSpacing:10,density:a,onlyForwardTracing:!0,wrapAround:!1}}function P(e){return e.kind===`constant`?e.value[0]:e.values[e.values.length-1]}function F(e){let t=e.toRgba();return[t[0]/255,t[1]/255,t[2]/255,t[3]]}function ae(e){return{kind:`constant`,value:[.1,.1,.1,1]}}function I(e){if(!e.hasVisualVariables(`size`))return{kind:`constant`,value:[_(e.trailWidth)]};let t=e.getVisualVariablesForType(`size`)[0],n=[],r=[],i;if(t.stops){for(let e of t.stops)n.push(e.value),r.push(_(e.size));i=t.stops.length}else n.push(t.minDataValue,t.maxDataValue),r.push(_(t.minSize),_(t.maxSize)),i=2;return{kind:`ramp`,stops:n,values:r,count:i}}function oe(e){if(!e.hasVisualVariables(`color`))return{kind:`constant`,value:F(e.color)};let t=e.getVisualVariablesForType(`color`)[0],n=[],r=[];for(let e of t.stops)n.push(e.value),Array.prototype.push.apply(r,F(e.color));return{kind:`ramp`,stops:n,values:r,count:t.stops.length}}function se(e){if(!e.hasVisualVariables(`opacity`))return{kind:`constant`,value:[1]};let t=e.getVisualVariablesForType(`opacity`)[0],n=[],r=[];for(let e of t.stops)n.push(e.value),r.push(e.opacity);return{kind:`ramp`,stops:n,values:r,count:t.stops.length}}function L(e,t,n,r){switch(t){case`int`:e.setUniform1iv(n,r);break;case`float`:e.setUniform1fv(n,r);break;case`vec2`:e.setUniform2fv(n,r);break;case`vec3`:e.setUniform3fv(n,r);break;case`vec4`:e.setUniform4fv(n,r)}}function R(e,t,n,r){r.kind===`constant`?L(e,n,`u_${t}`,r.value):(L(e,`float`,`u_${t}_stops`,r.stops),L(e,n,`u_${t}_values`,r.values),e.setUniform1i(`u_${t}_count`,r.count))}function ce(e,t){let n=!0;return n&&=e.collisions===t.collisions,n&&=e.density===t.density,n&&=e.interpolate===t.interpolate,n&&=e.lineCollisionWidth===t.lineCollisionWidth,n&&=e.lineSpacing===t.lineSpacing,n&&=e.maxTurnAngle===t.maxTurnAngle,n&&=e.minSpeedThreshold===t.minSpeedThreshold,n&&=e.segmentLength===t.segmentLength,n&&=e.smoothing===t.smoothing,n&&=e.velocityScale===t.velocityScale,n&&=e.verticesPerLine===t.verticesPerLine,n}function z(e,t){return e===t||e!=null&&t!=null&&e.equals(t)}function B(e,t){if(!ce(e.simulationSettings,t.simulationSettings)||!z(e.timeExtent,t.timeExtent))return!1;let n=!0;return n&&=e.loadImagery===t.loadImagery,n&&=e.createFlowMesh===t.createFlowMesh,n&&=e.color.kind===t.color.kind,n&&=e.opacity.kind===t.opacity.kind,n&&=e.size.kind===t.size.kind,n}var V=class e{constructor(e){this._params=e,this.animated=!1}isCompatible(t){if(!(t instanceof e)||!z(this._params.timeExtent,t._params.timeExtent))return!1;let n=!0;return n&&=this._params.loadImagery===t._params.loadImagery,n&&=this._params.color.kind===t._params.color.kind,n&&=this._params.opacity.kind===t._params.opacity.kind,n}async load(e,t){let{extent:n,size:r}=e;x(t);let i=await this._params.loadImagery(n,r[0],r[1],this._params.timeExtent,t);return new W(i,{color:this._params.color,opacity:this._params.opacity})}render(e,t,n){let{context:r}=e,{program:i}=n;r.setFaceCullingEnabled(!1),r.setBlendingEnabled(!0),r.setBlendFunction(1,771),r.useProgram(i),i.setUniformMatrix3fv(`u_dvsMat3`,t.dvsMat3),r.bindTexture(n.texture,0),i.setUniform1i(`u_texture`,0),i.setUniform1f(`u_Min`,n.min),i.setUniform1f(`u_Max`,n.max),R(i,`color`,`vec4`,this._params.color),R(i,`opacity`,`float`,this._params.opacity),r.bindVAO(n.vertexArray),r.drawArrays(s.TRIANGLE_STRIP,0,4)}},H=[new O(`a_position`,2,c.UNSIGNED_SHORT,0,8),new O(`a_texcoord`,2,c.UNSIGNED_SHORT,4,8)],U={vsPath:`raster/flow/imagery`,fsPath:`raster/flow/imagery`,locations:D(H)},W=class{constructor(e,t){this._flowData=e,this._values=t}attach(e){let{context:t}=e,{width:n,height:r}=this._flowData,i=new M(t,H,new Uint16Array([0,0,0,1,n,0,1,1,0,r,0,0,n,r,1,0])),a=new A(t,i),o=[];this._values.color.kind===`ramp`&&o.push(`vvColor`),this._values.opacity.kind===`ramp`&&o.push(`vvOpacity`);let s=e.getProgram(U,o),c=1e6,l=-1e6;for(let e=0;e<r;e++)for(let t=0;t<n;t++)if(this._flowData.mask[e*n+t]!==0){let r=this._flowData.data[2*(e*n+t)],i=this._flowData.data[2*(e*n+t)+1],a=Math.sqrt(r*r+i*i);c=Math.min(c,a),l=Math.max(l,a)}let u=new Uint8Array(4*n*r);for(let e=0;e<r;e++)for(let t=0;t<n;t++)if(this._flowData.mask[e*n+t]!==0){let r=this._flowData.data[2*(e*n+t)],i=this._flowData.data[2*(e*n+t)+1],a=(Math.sqrt(r*r+i*i)-c)/(l-c);u[4*(e*n+t)]=255*a,u[4*(e*n+t)+1]=0,u[4*(e*n+t)+2]=0,u[4*(e*n+t)+3]=255}else u[4*(e*n+t)]=0,u[4*(e*n+t)+1]=0,u[4*(e*n+t)+2]=0,u[4*(e*n+t)+3]=0;let d=new te(n,r);d.internalFormat=6408,d.wrapMode=33071,d.flipped=!0;let f=new h(t,d,u);this.vertexArray=a,this.program=s,this.texture=f,this.min=c,this.max=l,this._flowData=null}detach(){this.vertexArray.dispose(),this.texture.dispose()}get ready(){return this.program.compiled}},G=class e{constructor(e){this._params=e}get animated(){return this._params.flowSpeed>0}isCompatible(t){return t instanceof e&&B(this._params,t._params)}async load(e,t){let{extent:n,size:r}=e;x(t);let i=await this._params.loadImagery(n,r[0],r[1],this._params.timeExtent,t),{vertexData:a,indexData:o}=await this._params.createFlowMesh(`Particles`,this._params.simulationSettings,i,t);return new ue(a,o,{color:this._params.color,opacity:this._params.opacity,size:this._params.size})}render(e,t,n){let{context:r}=e,{program:i}=n;r.setFaceCullingEnabled(!1),r.setBlendingEnabled(!0),r.setBlendFunction(1,771),r.useProgram(i),i.setUniform1f(`u_time`,t.time),i.setUniform1f(`u_trailLength`,this._params.trailLength),i.setUniform1f(`u_flowSpeed`,this._params.flowSpeed),i.setUniform1f(`u_featheringSize`,this._params.featheringSize),i.setUniform1f(`u_featheringOffset`,this._params.featheringOffset),i.setUniform1f(`u_introFade`,this._params.introFade?1:0),i.setUniform1f(`u_fadeToZero`,this._params.fadeToZero?1:0),i.setUniform1f(`u_decayRate`,this._params.decayRate),i.setUniformMatrix3fv(`u_dvsMat3`,t.dvsMat3),i.setUniformMatrix3fv(`u_displayViewMat3`,t.displayViewMat3),R(i,`color`,`vec4`,this._params.color),R(i,`opacity`,`float`,this._params.opacity),R(i,`size`,`float`,this._params.size),r.bindVAO(n.vertexArray),r.drawElements(s.TRIANGLES,n.indexCount,c.UNSIGNED_INT,0)}},K=[new O(`a_xyts0`,4,c.FLOAT,0,64),new O(`a_xyts1`,4,c.FLOAT,16,64),new O(`a_typeIdDurationSeed`,4,c.FLOAT,32,64),new O(`a_extrudeInfo`,4,c.FLOAT,48,64)],le={vsPath:`raster/flow/particles`,fsPath:`raster/flow/particles`,locations:D(K)},ue=class{constructor(e,t,n){this._vertexData=e,this._indexData=t,this._values=n}attach(e){let{context:t}=e,n=new M(t,K,this._vertexData),r=j.createIndex(t,35044,this._indexData),i=new A(t,n,r),a=[];this._values.color.kind===`ramp`&&a.push(`vvColor`),this._values.opacity.kind===`ramp`&&a.push(`vvOpacity`),this._values.size.kind===`ramp`&&a.push(`vvSize`);let o=e.getProgram(le,a);this.vertexArray=i,this.program=o,this.indexCount=this._indexData.length,this._vertexData=null,this._indexData=null}detach(){this.vertexArray.dispose()}get ready(){return this.program.compiled}},de=class e{constructor(e){this._styles=e}get animated(){return this._styles.reduce((e,t)=>e||t.animated,!1)}isCompatible(t){if(!(t instanceof e)||this._styles.length!==t._styles.length)return!1;let n=this._styles.length;for(let e=0;e<n;e++)if(!this._styles[e].isCompatible(t._styles[e]))return!1;return!0}async load(e,t){let n=await Promise.all(this._styles.map(n=>n.load(e,t)));return new fe(n)}render(e,t,n){for(let r=0;r<this._styles.length;r++)this._styles[r].render(e,t,n.resources[r])}},fe=class{constructor(e){this.resources=e}attach(e){for(let t of this.resources)t.attach(e)}detach(){for(let e of this.resources)e.detach()}get ready(){return this.resources.reduce((e,t)=>e&&t.ready,!0)}},pe=class e{constructor(e){this._params=e}get animated(){return this._params.flowSpeed>0}isCompatible(t){return t instanceof e&&B(this._params,t._params)}async load(e,t){let{extent:n,size:r}=e;x(t);let i=await this._params.loadImagery(n,r[0],r[1],this._params.timeExtent,t),{vertexData:a,indexData:o}=await this._params.createFlowMesh(`Streamlines`,this._params.simulationSettings,i,t);return new he(a,o,{color:this._params.color,opacity:this._params.opacity,size:this._params.size})}render(e,t,n){let{context:r}=e,{program:i}=n;r.setFaceCullingEnabled(!1),r.setBlendingEnabled(!0),r.setBlendFunction(1,771),r.useProgram(i),i.setUniform1f(`u_time`,t.time),i.setUniform1f(`u_trailLength`,this._params.trailLength),i.setUniform1f(`u_flowSpeed`,this._params.flowSpeed),i.setUniform1f(`u_featheringSize`,this._params.featheringSize),i.setUniform1f(`u_featheringOffset`,this._params.featheringOffset),i.setUniform1f(`u_introFade`,this._params.introFade?1:0),i.setUniform1f(`u_fadeToZero`,this._params.fadeToZero?1:0),i.setUniform1f(`u_decayRate`,this._params.decayRate),i.setUniformMatrix3fv(`u_dvsMat3`,t.dvsMat3),i.setUniformMatrix3fv(`u_displayViewMat3`,t.displayViewMat3),R(i,`color`,`vec4`,this._params.color),R(i,`opacity`,`float`,this._params.opacity),R(i,`size`,`float`,this._params.size),r.bindVAO(n.vertexArray),r.drawElements(s.TRIANGLES,n.indexCount,c.UNSIGNED_INT,0)}},q=[new O(`a_positionAndSide`,3,c.FLOAT,0,36),new O(`a_timeInfo`,3,c.FLOAT,12,36),new O(`a_extrude`,2,c.FLOAT,24,36),new O(`a_speed`,1,c.FLOAT,32,36)],me={vsPath:`raster/flow/streamlines`,fsPath:`raster/flow/streamlines`,locations:D(q)},he=class{constructor(e,t,n){this._vertexData=e,this._indexData=t,this._values=n}attach(e){let{context:t}=e,n=new M(t,q,this._vertexData),r=j.createIndex(t,35044,this._indexData),i=new A(t,n,r),a=[];this._values.color.kind===`ramp`&&a.push(`vvColor`),this._values.opacity.kind===`ramp`&&a.push(`vvOpacity`),this._values.size.kind===`ramp`&&a.push(`vvSize`);let o=e.getProgram(me,a);this.vertexArray=i,this.program=o,this.indexCount=this._indexData.length,this._vertexData=null,this._indexData=null}detach(){this.vertexArray.dispose()}get ready(){return this.program.compiled}},ge=4,_e=1,ve=.5,ye=!0,be=!0,xe=2.3;function Se(e,t){let{flowSpeed:n,trailLength:r}=e,i=ie(e),a=null,o={opacity:se(e),size:I(e)},s=oe(e);if(e.background===`none`)o.color=s;else{s.kind===`constant`&&(s={kind:`ramp`,stops:[0,1],values:[0,0,0,1,s.value[0],s.value[1],s.value[2],s.value[3]],count:2});let e={loadImagery:t.loadImagery,timeExtent:t.timeExtent,color:s,opacity:{kind:`constant`,value:[1]}};a=new V(e),o.color=ae()}let c={loadImagery:t.loadImagery,createFlowMesh:t.createFlowMesh,simulationSettings:i,timeExtent:t.timeExtent,trailLength:r,flowSpeed:n,featheringSize:_e,featheringOffset:ve,introFade:ye,fadeToZero:be,decayRate:xe,color:o.color,opacity:o.opacity,size:o.size},l=e.trailCap===`butt`||P(I(e))<=ge?new pe(c):new G(c);return a==null?l:new de([a,l])}var Ce=class extends k{constructor(){super(...arguments),this._visualState={time:0,dvsMat3:b(),displayViewMat3:b()}}dispose(){}prepareState(e){let{context:t}=e;t.setColorMask(!0,!0,!0,!0),t.setStencilFunction(514,0,255)}draw(e,t){let{requestRender:n,allowDelayedRender:r}=e,{displayData:i}=t;if(i==null||(i.state.name===`loaded`&&i.attach({context:e.context,getProgram:(t,n)=>e.painter.materialManager.getProgram(t,n)}),i.state.name!==`attached`))return;let a=i.state.resources;!r||a.ready||n==null?(this._visualState.time=e.animationsEnabled?e.time/1e3:0,this._visualState.dvsMat3=t.transforms.displayViewScreenMat3,this._visualState.displayViewMat3=e.state.displayViewMat3,i.flowStyle.render({context:e.context,getProgram:(t,n)=>e.painter.materialManager.getProgram(t,n)},this._visualState,a),i.flowStyle.animated&&n!=null&&e.animationsEnabled&&n()):n()}},we=class extends ne{constructor(){super(...arguments),this.flowStyle=null}doRender(e){super.doRender(e)}prepareRenderPasses(e){let t=e.registerRenderPass({name:`flow`,brushes:[Ce],target:()=>this.children,drawPhase:1});return[...super.prepareRenderPasses(e),t]}},Te=class{constructor(e,t,n,r,i){this.state={name:`created`},this.flowStyle=e,this.extent=t,this.size=n,this.pixelRatio=r,this.startTime=i}async load(){let e=new AbortController;this.state={name:`loading`,abortController:e};let t={extent:this.extent,size:this.size,pixelRatio:this.pixelRatio,time:this.startTime};this.state={name:`loaded`,resources:await this.flowStyle.load(t,e.signal)}}attach(e){if(this.state.name!==`loaded`)return void n.getLogger(`esri.views.2d.engine.flow.FlowDisplayData`).error(`Only loaded resources can be attached.`);let t=this.state.resources;t.attach(e),this.state={name:`attached`,resources:t}}detach(){if(this.state.name===`loading`)return this.state.abortController.abort(),void(this.state={name:`detached`});this.state.name===`attached`&&(this.state.resources.detach(),this.state={name:`detached`})}update(e){return this.flowStyle.isCompatible(e.flowStyle)?!(!this.extent.equals(e.extent)||this.size[0]!==e.size[0]||this.size[1]!==e.size[1]||this.pixelRatio!==e.pixelRatio)&&(this.flowStyle=e.flowStyle,!0):!1}},J=class extends N{constructor(){super(...arguments),this._displayData=null}get displayData(){return this._displayData}set displayData(e){this._displayData=e,this.requestRender()}clear(){this._displayData!=null&&(this._displayData.detach(),this._displayData=null,this.requestRender())}setTransform(e){let{displayData:t}=this;if(t==null)return;let n=t.extent.xmin,r=t.extent.ymax,s=[0,0];e.toScreen(s,[n,r]);let c=(t.extent.xmax-t.extent.xmin)/t.size[0]/e.resolution,l=d(e.rotation),{displayViewScreenMat3:u}=this.transforms;m(u,[-1,1,0]),i(u,u,[2/(e.size[0]*e.pixelRatio),-2/(e.size[1]*e.pixelRatio),1]),a(u,u,[s[0],s[1],0]),o(u,u,l),i(u,u,[c*e.pixelRatio,c*e.pixelRatio,1])}_createTransforms(){return{displayViewScreenMat3:b()}}},Ee=1.15,Y=class extends e{constructor(e){super(e),this._flowDisplayObject=new J,this._loading=null}initialize(){this.flowContainer.addChild(this._flowDisplayObject)}destroy(){this._clear(),this.flowContainer.removeAllChildren()}get updating(){return this._loading!=null}update(e){let{flowStyle:t}=this.flowContainer;if(t==null)return void this._clear();let{extent:r,rotation:i,resolution:a,pixelRatio:o}=e.state,s=De(r,i);s.expand(Ee);let c=[Math.round((s.xmax-s.xmin)/a),Math.round((s.ymax-s.ymin)/a)],l=performance.now()/1e3,u=new Te(t,s,c,o,l);if(this._loading!=null){if(this._loading.update(u))return;this._loading.detach(),this._loading=null}this._flowDisplayObject.displayData!=null&&this._flowDisplayObject.displayData.update(u)||(u.load().then(()=>{this._flowDisplayObject.clear(),this._flowDisplayObject.displayData=this._loading,this._loading=null},e=>{y(e)||(n.getLogger(this).error(`A resource failed to load.`,e),this._loading=null)}),this._loading=u)}_clear(){this._flowDisplayObject.clear(),this._loading!=null&&(this._loading.detach(),this._loading=null)}};function De(e,t){let n=new r({x:(e.xmax+e.xmin)/2,y:(e.ymax+e.ymin)/2,spatialReference:e.spatialReference}),i=e.xmax-e.xmin,a=e.ymax-e.ymin,o=Math.abs(Math.cos(d(t))),s=Math.abs(Math.sin(d(t))),c=o*i+s*a,l=s*i+o*a,u=new ee({xmin:n.x-c/2,ymin:n.y-l/2,xmax:n.x+c/2,ymax:n.y+l/2,spatialReference:e.spatialReference});return u.centerAt(n),u}v([t()],Y.prototype,`_loading`,void 0),v([t()],Y.prototype,`flowContainer`,void 0),v([t()],Y.prototype,`updating`,null),Y=v([p(`esri.views.2d.engine.flow.FlowStrategy`)],Y);var X=class extends e{constructor(){super(...arguments),this._loadImagery=(e,t,n,r,i)=>E(this.layer,e,t,n,r,i),this._createFlowMesh=(e,t,n,r)=>this.layer.createFlowMesh({meshType:e,flowData:n,simulationSettings:t},{signal:r}),this.attached=!1,this.type=`flow`,this.timeExtent=null,this.redrawOrRefetch=async()=>{this._updateVisualization()}}get updating(){return!this.attached||this._strategy.updating}attach(){let{layer:e}=this,t=()=>{this._loadImagery=(t,n,r,i,a)=>E(e,t,n,r,i,a),this._updateVisualization()};`multidimensionalDefinition`in e?this.addHandles(S(()=>e.multidimensionalDefinition,t)):this.addHandles([S(()=>e.mosaicRule,t),S(()=>e.rasterFunction,t),S(()=>e.definitionExpression,t)]),this.container=new we,this._strategy=new Y({flowContainer:this.container}),this._updateVisualization()}detach(){this._strategy.destroy(),this.container?.removeAllChildren(),this.container=null,this.removeHandles()}update(e){e.stationary?this._strategy.update(e):this.layerView.requestUpdate()}hitTest(e){return new l({attributes:{},geometry:e.clone(),layer:this.layer})}moveEnd(){}async doRefresh(){}_updateVisualization(){let e=this.layer.renderer;if(e==null||e.type!==`flow`)return;let t=Se(e,{loadImagery:this._loadImagery,createFlowMesh:this._createFlowMesh,timeExtent:this.timeExtent});this.container.flowStyle=t,this.layerView.requestUpdate()}};v([t()],X.prototype,`_strategy`,void 0),v([t()],X.prototype,`attached`,void 0),v([t()],X.prototype,`container`,void 0),v([t()],X.prototype,`layer`,void 0),v([t()],X.prototype,`layerView`,void 0),v([t()],X.prototype,`type`,void 0),v([t()],X.prototype,`updating`,null),v([t()],X.prototype,`timeExtent`,void 0),X=v([p(`esri.views.2d.engine.flow.FlowView2D`)],X);var Z=new Float32Array([.27058823529411763,.4588235294117647,.7098039215686275,1,.396078431372549,.5372549019607843,.7215686274509804,1,.5176470588235295,.6196078431372549,.7294117647058823,1,.6352941176470588,.7058823529411765,.7411764705882353,1,.7529411764705882,.8,.7450980392156863,1,.8705882352941177,.8901960784313725,.7490196078431373,1,1,1,.7490196078431373,1,1,.8627450980392157,.6313725490196078,1,.9803921568627451,.7254901960784313,.5176470588235295,1,.9607843137254902,.596078431372549,.4117647058823529,1,.9294117647058824,.4588235294117647,.3176470588235294,1,.9098039215686274,.08235294117647059,.08235294117647059,1]),Q=new Float32Array([0,92/255,230/255,1]),Oe={beaufort_ft:Z,beaufort_m:Z,beaufort_km:Z,beaufort_mi:Z,beaufort_kn:new Float32Array([.1568627450980392,.5725490196078431,.7803921568627451,1,.34901960784313724,.6352941176470588,.7294117647058823,1,.5058823529411764,.7019607843137254,.6705882352941176,1,.6274509803921569,.7607843137254902,.6078431372549019,1,.7490196078431373,.8313725490196079,.5411764705882353,1,.8549019607843137,.9019607843137255,.4666666666666667,1,.9803921568627451,.9803921568627451,.39215686274509803,1,.9882352941176471,.8352941176470589,.3254901960784314,1,.9882352941176471,.7019607843137254,.4,1,.9803921568627451,.5529411764705883,.20392156862745098,1,.9686274509803922,.43137254901960786,.16470588235294117,1,.9411764705882353,.2784313725490196,.11372549019607843,1]),classified_arrow:new Float32Array([.2196078431372549,.6588235294117647,0,1,.5450980392156862,1.2117647058823529,0,1,1,1,0,1,1,.5019607843137255,0,1,1,0,0,1]),ocean_current_m:new Float32Array([.3058823529411765,.10196078431372549,.6,1,.7019607843137254,.10588235294117647,.10196078431372549,1,.792156862745098,.5019607843137255,.10196078431372549,1,.6941176470588235,.6941176470588235,.6941176470588235,1]),ocean_current_kn:new Float32Array([0,0,0,1,0,.1450980392156863,.39215686274509803,1,.3058823529411765,.10196078431372549,.6,1,.592156862745098,0,.39215686274509803,1,.7019607843137254,.10588235294117647,.10196078431372549,1,.6941176470588235,.3058823529411765,.10196078431372549,1,.792156862745098,.5019607843137255,.10196078431372549,1,.6941176470588235,.7019607843137254,.20392156862745098,1,.6941176470588235,.6941176470588235,.6941176470588235,1]),simple_scalar:Q,single_arrow:Q,wind_speed:new Float32Array([0,0,0,1])},$=[0,20],ke=class extends k{constructor(){super(...arguments),this._desc={magdir:{vsPath:`raster/magdir`,fsPath:`raster/magdir`,locations:new Map([[`a_pos`,0],[`a_offset`,1],[`a_vv`,2]])},scalar:{vsPath:`raster/scalar`,fsPath:`raster/scalar`,locations:new Map([[`a_pos`,0],[`a_offset`,1],[`a_vv`,2]])}}}dispose(){}prepareState({context:e}){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),e.setStencilWriteMask(0),e.setStencilTestEnabled(!0),e.setStencilOp(7680,7680,7681)}draw(e,t){if(t.source==null||t.source.validPixelCount===0)return;let{context:n,timeline:r}=e;if(r.begin(this.name),n.setStencilFunction(514,t.stencilRef,255),t.updateVectorFieldVAO(e),e.renderPass===`scalar`){let n=t.vaoData.scalar;n&&this._drawScalars(e,t,n.vao,n.elementCount)}else{let n=t.vaoData.magdir;n&&this._drawTriangles(e,t,n.vao,n.elementCount)}r.end(this.name)}_drawTriangles(e,t,n,r){let{context:i,painter:a,requestRender:o,allowDelayedRender:l}=e,{symbolizerParameters:u}=t,d=u.dataRange?[`dataRange`]:[];u.rotationType===`geographic`&&d.push(`rotationGeographic`);let f=a.materialManager.getProgram(this._desc.magdir,d);if(l&&o!=null&&!f.compiled)return void o();i.useProgram(f);let{coordScale:p,opacity:m,transforms:h}=t;f.setUniform2fv(`u_coordScale`,p),f.setUniform1f(`u_opacity`,m),f.setUniformMatrix3fv(`u_dvsMat3`,h.displayViewScreenMat3);let{style:g,dataRange:_,rotation:v,symbolPercentRange:y}=u;f.setUniform4fv(`u_colors`,Oe[g]),f.setUniform2fv(`u_dataRange`,_||$),f.setUniform1f(`u_rotation`,v),f.setUniform2fv(`u_symbolPercentRange`,y);let b=this._getSymbolSize(e,t);f.setUniform2fv(`u_symbolSize`,b),i.bindVAO(n),i.drawElements(s.TRIANGLES,r,c.UNSIGNED_INT,0)}_drawScalars(e,t,n,r){let{context:i,painter:a,requestRender:o,allowDelayedRender:l}=e,{symbolizerParameters:u}=t,d=[];u.style===`wind_speed`?d.push(`innerCircle`):u.dataRange&&d.push(`dataRange`),u.rotationType===`geographic`&&d.push(`rotationGeographic`);let f=a.materialManager.getProgram(this._desc.scalar,d);if(l&&o!=null&&!f.compiled)return void o();i.useProgram(f);let{coordScale:p,opacity:m,transforms:h}=t;f.setUniform2fv(`u_coordScale`,p),f.setUniform1f(`u_opacity`,m),f.setUniformMatrix3fv(`u_dvsMat3`,h.displayViewScreenMat3);let{dataRange:g,symbolPercentRange:_}=u;f.setUniform2fv(`u_dataRange`,g||$),f.setUniform2fv(`u_symbolPercentRange`,_);let v=this._getSymbolSize(e,t);f.setUniform2fv(`u_symbolSize`,v),i.bindVAO(n),i.drawElements(s.TRIANGLES,r,c.UNSIGNED_INT,0)}_getSymbolSize(e,t){let n=t.key?2**(e.displayLevel-t.key.level):t.resolution/e.state.resolution,{symbolTileSize:r}=t.symbolizerParameters;return[r/(Math.round((t.width-t.offset[0])/r)*r)/n,r/(Math.round((t.height-t.offset[1])/r)*r)/n]}},Ae=class extends N{constructor(e=null){super(),this._source=null,this._symbolizerParameters=null,this._vaoInvalidated=!0,this.coordScale=[1,1],this.height=null,this.key=null,this.offset=null,this.stencilRef=0,this.resolution=null,this.pixelRatio=1,this.x=0,this.y=0,this.rotation=0,this.rawPixelData=null,this.vaoData=null,this.width=null,this.source=e}destroy(){super.destroy(),this.vaoData!=null&&(this.vaoData.magdir?.vao.dispose(),this.vaoData.scalar?.vao.dispose(),this.vaoData=null)}get symbolizerParameters(){return this._symbolizerParameters}set symbolizerParameters(e){JSON.stringify(this._symbolizerParameters)!==JSON.stringify(e)&&(this._symbolizerParameters=e,this.invalidateVAO())}get source(){return this._source}set source(e){this._source=e,this.invalidateVAO()}invalidateVAO(){this._vaoInvalidated||this.vaoData==null||(this.vaoData.magdir?.vao.dispose(),this.vaoData.scalar?.vao.dispose(),this.vaoData=null,this._vaoInvalidated=!0,this.requestRender())}updateVectorFieldVAO(e){if(this._vaoInvalidated){if(this._vaoInvalidated=!1,this.source!=null&&this.vaoData==null){let{style:t}=this.symbolizerParameters;switch(t){case`beaufort_ft`:case`beaufort_km`:case`beaufort_kn`:case`beaufort_m`:case`beaufort_mi`:case`classified_arrow`:case`ocean_current_kn`:case`ocean_current_m`:case`single_arrow`:{let t=w(this.source,this.symbolizerParameters);this.vaoData={magdir:this._createVectorFieldVAO(e.context,t)}}break;case`simple_scalar`:{let t=T(this.source,this.symbolizerParameters);this.vaoData={scalar:this._createVectorFieldVAO(e.context,t)}}break;case`wind_speed`:{let t=w(this.source,this.symbolizerParameters),n=this._createVectorFieldVAO(e.context,t),r=T(this.source,this.symbolizerParameters),i=this._createVectorFieldVAO(e.context,r);this.vaoData={magdir:n,scalar:i}}}}this.ready(),this.requestRender()}}_createTransforms(){return{displayViewScreenMat3:b()}}setTransform(e){let t=u(this.transforms.displayViewScreenMat3),[n,r]=e.toScreenNoRotation([0,0],[this.x,this.y]),i=this.resolution/this.pixelRatio/e.resolution,s=i*this.width,c=i*this.height,l=Math.PI*this.rotation/180;a(t,t,g(n,r)),a(t,t,g(s/2,c/2)),o(t,t,-l),a(t,t,g(-s/2,-c/2)),f(t,t,g(s,c)),C(this.transforms.displayViewScreenMat3,e.displayViewMat3,t)}onAttach(){this.invalidateVAO()}onDetach(){this.invalidateVAO()}_createVectorFieldVAO(e,t){let{vertexData:n,indexData:r}=t,i=j.createIndex(e,35044,new Uint32Array(r)),a=re(`vector-field`,[{location:0,name:`a_pos`,count:2,type:c.FLOAT,normalized:!1},{location:1,name:`a_offset`,count:2,type:c.FLOAT,normalized:!1},{location:2,name:`a_vv`,count:2,type:c.FLOAT,normalized:!1}]),o=new M(e,a.bufferLayout,new Float32Array(n));return{vao:new A(e,o,i),elementCount:r.length}}};export{ke as n,X as r,Ae as t};