import{$T as e,AS as t,Bp as n,CE as r,DS as i,En as a,Gp as o,Rv as s,Sg as c,ZS as l,Z_ as u,oT as d,xd as f}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import{a as p,i as m,n as h,r as g,s as _}from"./featureConversionUtils-o9-cJXzl.js";import"./WhereClause-CATd9kVz.js";import"./closestPointOnCurve-CwZL45U3.js";import"./WhereClauseCache-BO4WYMj9.js";import"./PooledRBush-BH7_Gu1G.js";import"./QueryEngineCapabilities-CxeEdoTy.js";import{n as v,r as y,t as b}from"./clientSideDefaults-Iizf0eUh.js";import"./generateRendererUtils-DGV_dTnd.js";import"./utils-DCGMUq-q.js";import"./BoundsStore-DE7p6f_c.js";import"./timeSupport-vK4lVcYW.js";import"./optimizedFeatureQueryEngineAdapter-DQyaY_b1.js";import{t as x}from"./FeatureStore-DxVA8hqB.js";import{t as S}from"./QueryEngine-CD8WljsT.js";import{c as C,l as w}from"./queryUtils-DGU5ISbw.js";import"./utils-Bftaersa.js";import"./utils-BizEctJo.js";import"./SnappingCandidate-4DPnOY6Y.js";import"./FixedIntervalBinParameters-CMgMaWGN.js";import"./date-DluEMNTt.js";import{n as T,r as E,t as D}from"./geojson-Dz-UDVkw.js";import{a as O,i as k,n as A,o as j,r as M,t as N}from"./sourceUtils-DJLVoxjN.js";var P={hasAttachments:!1,capabilities:`query, editing, create, delete, update`,useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsQueryAttachmentOrderByFields:!1,supportsQueryAttachmentWithTypeWildcard:!1,supportsQueryBins:!0,supportsQueryPivot:!1,supportsQueryWithCacheHint:!0,supportsQueryWithDistance:!0,supportsQueryWithResultType:!0,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0},queryBinsCapabilities:A},F=class{constructor(){this._queryEngine=null,this._snapshotFeatures=async e=>{let t=await this._fetch(e);return this._createFeatures(t)}}destroy(){this._queryEngine?.destroy(),this._queryEngine=this._createDefaultAttributes=null}async load(t,r={}){this._loadOptions={url:t.url,customParameters:t.customParameters};let s=[],[c]=await Promise.all([t.url?this._fetch(r?.signal):null,this._checkProjection(t.spatialReference)]),l=E(c,{geometryType:t.geometryType}),u=t.fields||l.fields||[],d=t.hasZ==null?l.hasZ:t.hasZ,p=l.geometryType,m=t.objectIdField||l.objectIdFieldName||`__OBJECTID`,h=t.spatialReference||i,g=t.timeInfo;u===l.fields&&l.unknownFields.length>0&&s.push({name:`geojson-layer:unknown-field-types`,message:`Some fields types couldn't be inferred from the features and were dropped`,details:{unknownFields:l.unknownFields}});let _=new a(u),C=_.get(m);C?(C.type!==`esriFieldTypeString`&&(C.type=`esriFieldTypeOID`),C.editable=!1,C.nullable=!1,m=C.name):(C={alias:m,name:m,type:l.objectIdFieldType===`string`?`esriFieldTypeString`:`esriFieldTypeOID`,editable:!1,nullable:!1},u.unshift(C));let w={};for(let t of u){if(t.name??=t.alias,t.alias??=t.name,!t.name)throw new e(`geojson-layer:invalid-field-name`,`field name is missing`,{field:t});if(!f.jsonValues.includes(t.type))throw new e(`geojson-layer:invalid-field-type`,`invalid type for field "${t.name}"`,{field:t});if(t.name!==C.name){let e=n(t);e!==void 0&&(w[t.name]=e)}t.length??=o(t)}if(g){if(g.startTimeField){let e=_.get(g.startTimeField);e?(g.startTimeField=e.name,e.type=`esriFieldTypeDate`):g.startTimeField=null}if(g.endTimeField){let e=_.get(g.endTimeField);e?(g.endTimeField=e.name,e.type=`esriFieldTypeDate`):g.endTimeField=null}if(g.trackIdField){let e=_.get(g.trackIdField);e?g.trackIdField=e.name:(g.trackIdField=null,s.push({name:`geojson-layer:invalid-timeInfo-trackIdField`,message:`trackIdField is missing`,details:{timeInfo:g}}))}g.startTimeField||g.endTimeField||(s.push({name:`geojson-layer:invalid-timeInfo`,message:`startTimeField and endTimeField are missing`,details:{timeInfo:g}}),g=null)}let T=p?y(p):void 0,D=_.dateFields.length?{timeZoneIANA:`UTC`}:null,O={warnings:s,featureErrors:[],layerDefinition:{...P,drawingInfo:T??void 0,templates:v(w),extent:void 0,geometryType:p,objectIdField:m,fields:u,hasZ:!!d,timeInfo:g,dateFieldsTimeReference:D}},k={type:`object-id`,fieldName:m};this._queryEngine=new S({fieldsIndex:a.fromLayerJSON({fields:u,timeInfo:g,dateFieldsTimeReference:D}),geometryType:p,hasM:!1,hasZ:d,featureIdInfo:k,spatialReference:h,timeInfo:g,featureStore:new x({geometryType:p,hasM:!1,hasZ:d})});let A=this._queryEngine.fieldsIndex.requiredFields.indexOf(C);A>-1&&this._queryEngine.fieldsIndex.requiredFields.splice(A,1),this._createDefaultAttributes=b(w,m);let j=this._createFeatures(c);this._objectIdGenerator=this._createObjectIdGenerator(this._queryEngine,j);let M=this._normalizeFeatures(j,O.featureErrors);this._queryEngine.featureStore.addMany(M);let{fullExtent:N,timeExtent:F}=await this._queryEngine.fetchRecomputedExtents();if(O.layerDefinition.extent=N,F){let{start:e,end:t}=F;O.layerDefinition.timeInfo.timeExtent=[e,t]}return O}async applyEdits(e){let{spatialReference:t,geometryType:n}=this._queryEngine;return await Promise.all([N(t,n),C(e.adds,t),C(e.updates,t)]),await this._waitSnapshotComplete(),this._applyEdits(e)}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),await this._queryEngine.executeQueryForSnapping(e,t.signal)}async queryAttributeBins(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeAttributeBinsQuery(e,t.signal)}async refresh(t){this._loadOptions.customParameters=t,this._snapshotTask?.abort(),this._snapshotTask=c(this._snapshotFeatures),this._snapshotTask.promise.then(e=>{this._queryEngine.featureStore.clear(),this._objectIdGenerator=this._createObjectIdGenerator(this._queryEngine,e);let t=this._normalizeFeatures(e);t&&this._queryEngine.featureStore.addMany(t)},t=>{this._queryEngine.featureStore.clear(),d(t)||r.getLogger(`esri.layers.GeoJSONLayer`).error(new e(`geojson-layer:refresh`,`An error occurred during refresh`,{error:t}))}),await this._waitSnapshotComplete();let{fullExtent:n,timeExtent:i}=await this._queryEngine.fetchRecomputedExtents();return{extent:n,timeExtent:i}}_createFeatures(e){if(e==null)return[];let{geometryType:n,hasZ:r,objectIdField:a}=this._queryEngine,o=T(e,{geometryType:n,hasZ:r,objectIdField:a});if(!t(this._queryEngine.spatialReference,i))for(let e of o)e.geometry!=null&&(e.geometry=p(w(_(e.geometry,this._queryEngine.geometryType,this._queryEngine.hasZ,!1),i,this._queryEngine.spatialReference)));return o}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _fetch(e){let{url:t,customParameters:n}=this._loadOptions,r=(await l(t??``,{responseType:`json`,query:{...n},signal:e})).data;return D(r),r}_normalizeFeatures(e,t){let{objectIdField:n,fieldsIndex:r}=this._queryEngine,i=[];for(let a of e){let e=this._createDefaultAttributes(),o=M(r,e,a.attributes,!0);o?t?.push(o):(this._assignObjectId(e,a.attributes,!0),a.attributes=e,a.objectId=e[n],i.push(a))}return i}async _applyEdits(e){let{adds:t,updates:n,deletes:r}=e,i={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t?.length&&this._applyAddEdits(i,t),n?.length&&this._applyUpdateEdits(i,n),r?.length){for(let e of r)i.deleteResults.push(k(e));this._queryEngine.featureStore.removeManyById(r)}let{fullExtent:a,timeExtent:o}=await this._queryEngine.fetchRecomputedExtents();return{extent:a,timeExtent:o,featureEditResults:i}}_applyAddEdits(e,t){let{addResults:n}=e,{geometryType:r,hasM:i,hasZ:a,objectIdField:o,spatialReference:c,featureStore:l,fieldsIndex:u}=this._queryEngine,d=[],f={type:`object-id`,fieldName:o};for(let i of t){if(i.geometry&&r!==s(i.geometry)){n.push(j(`Incorrect geometry type.`));continue}let t=this._createDefaultAttributes(),a=M(u,t,i.attributes);if(a)n.push(a);else{if(this._assignObjectId(t,i.attributes),i.attributes=t,i.uid!=null){let t=i.attributes[o];e.uidToObjectId[i.uid]=t}if(i.geometry!=null){let e=i.geometry.spatialReference??c;i.geometry=w(O(i.geometry,e),e,c)}d.push(i),n.push(k(i.attributes[o]))}}l.addMany(g([],d,r,a,i,f))}_applyUpdateEdits({updateResults:e},t){let{geometryType:n,hasM:r,hasZ:i,objectIdField:a,spatialReference:o,featureStore:c,fieldsIndex:l}=this._queryEngine,u={type:`object-id`,fieldName:a};for(let d of t){let{attributes:t,geometry:f}=d,p=t?.[a];if(p==null){e.push(j(`Identifier field ${a} missing`));continue}if(!c.has(p)){e.push(j(`Feature with object id ${p} missing`));continue}let g=m(c.getFeature(p),n,i,r);if(f!=null){if(n!==s(f)){e.push(j(`Incorrect geometry type.`));continue}let t=f.spatialReference??o;g.geometry=w(O(f,t),t,o)}if(t){let n=M(l,g.attributes,t);if(n){e.push(n);continue}}c.add(h(g,n,i,r,u)),e.push(k(p))}}_createObjectIdGenerator(e,t){let n=e.fieldsIndex.get(e.objectIdField);if(n.type===`esriFieldTypeString`)return()=>n.name+`-`+Date.now().toString(16);let r=-1/0;for(let e of t)e.objectId&&(r=Math.max(r,e.objectId));return r=Math.max(0,r)+1,()=>r++}_assignObjectId(e,t,n=!1){let r=this._queryEngine.objectIdField;e[r]=n&&r in t?t[r]:this._objectIdGenerator()}async _checkProjection(t){try{await C(i,t)}catch{throw new e(`geojson-layer`,`Projection not supported`)}}};export{F as default};