import{A as e,BT as t,EE as n,JC as r,L as i,Li as a,Lx as o,M as s,Qh as c,Rh as l,UT as u,Ua as d,VT as f,WT as p,ba as m,cv as h,fv as g,gE as _,hv as v,j as y,kD as b,lv as x,ov as S,pv as C,rw as w,sT as T,ua as E,vx as D,xa as O,yv as k}from"./index-BN8X5Ryz.js";import{a as A,i as j,n as M,t as N}from"./kmlUtils-BeQJtYx4.js";var P=Symbol(`isKMLGraphicOrigin`),F,I=class extends m{get[(F=P,O)](){return this.layer}constructor(e,t){super(),this[F]=!0,this.type=`kml`,this.layer=e,this.sublayer=t}get id(){return`${this.layer.id}:__${this.sublayer.id}__`}},L,R=L=class extends k(w(c)){constructor(...e){super(...e),this.description=null,this.fullExtent=null,this.id=null,this.networkLink=null,this.parent=null,this.sublayers=null,this.title=null,this.sourceJSON=null,this.layer=null,this.addHandles([x(()=>this.sublayers,`after-add`,({item:e})=>{e.parent=this,e.layer=this.layer},h),x(()=>this.sublayers,`after-remove`,({item:e})=>{e.layer=e.parent=null},h),C(()=>this.sublayers,(e,t)=>{if(t)for(let e of t)e.layer=e.parent=null;if(e)for(let t of e)t.parent=this,t.layer=this.layer},h),C(()=>this.layer,e=>{if(this.sublayers)for(let t of this.sublayers)t.layer=e},h)])}initialize(){g(()=>this.networkLink).then(()=>g(()=>!0===this.visible)).then(()=>this.load())}load(e){if(!this.networkLink||this.networkLink.viewFormat)return;let t=e==null?null:e.signal,n=this._fetchService(this._get(`networkLink`)?.href??``,t).then(e=>{let t=N(e.sublayers);this.fullExtent=D.fromJSON(t),this.sourceJSON=e;let n=_(v.ofType(L),M(L,e));this.sublayers?this.sublayers.addMany(n):this.sublayers=n,this.layer?.emit(`sublayer-update`),this.layer&&this.layer.notifyChange(`visibleSublayers`)});return this.addResolvingPromise(n),Promise.resolve(this)}get visible(){return this._get(`visible`)}set visible(e){this._get(`visible`)!==e&&(this._set(`visible`,e),this.layer&&this.layer.notifyChange(`visibleSublayers`))}readVisible(e,t){return!!t.visibility}get origin(){return this.layer?new I(this.layer,this):null}_fetchService(e,t){return A(e,this.layer.outSpatialReference,this.layer.refreshInterval,t).then(e=>j(e.data))}};b([t()],R.prototype,`description`,void 0),b([t({type:D})],R.prototype,`fullExtent`,void 0),b([t()],R.prototype,`id`,void 0),b([t({readOnly:!0,value:null})],R.prototype,`networkLink`,void 0),b([t({json:{write:{allowNull:!0}}})],R.prototype,`parent`,void 0),b([t({type:v.ofType(R),json:{write:{allowNull:!0}}})],R.prototype,`sublayers`,void 0),b([t({value:null,json:{read:{source:`name`,reader:e=>n(e)}}})],R.prototype,`title`,void 0),b([t({value:!0})],R.prototype,`visible`,null),b([p(`visible`,[`visibility`])],R.prototype,`readVisible`,null),b([t()],R.prototype,`sourceJSON`,void 0),b([t()],R.prototype,`layer`,void 0),b([t()],R.prototype,`origin`,null),R=L=b([f(`esri.layers.support.KMLSublayer`)],R);var z=[`kml`,`xml`],B=class extends E(y(e(i(s(d(l)))))){constructor(...e){super(...e),this._visibleFolders=[],this.allSublayers=new S({getCollections:()=>[this.sublayers],getChildrenFunction:e=>e.sublayers}),this.outSpatialReference=o.WGS84,this.path=null,this.legendEnabled=!1,this.operationalLayerType=`KML`,this.sublayers=null,this.type=`kml`,this.url=null}initialize(){this.addHandles([C(()=>this.sublayers,(e,t)=>{t&&t.forEach(e=>{e.parent=null,e.layer=null}),e&&e.forEach(e=>{e.parent=this,e.layer=this})},h),this.on(`sublayer-update`,()=>this.notifyChange(`fullExtent`))])}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}get sublayerById(){let e=new Map;for(let t of this.allSublayers)e.set(t.id,t);return e}readSublayersFromItemOrWebMap(e,t){this._visibleFolders=t.visibleFolders}readSublayers(e,t,n){return M(R,t,n,this._visibleFolders)}writeSublayers(e,t){let n=[],r=e.toArray();for(;r.length;){let e=r[0];e.networkLink||(e.visible&&n.push(e.id),e.sublayers&&r.push(...e.sublayers.toArray())),r.shift()}t.visibleFolders=n}get title(){let e=this._get(`title`);return e&&this.originOf(`title`)!==`defaults`?e:this.url?r(this.url,z)||`KML`:e}set title(e){this._set(`title`,e)}get visibleSublayers(){let e=this.sublayers,t=[],n=e=>{e.visible&&(t.push(e),e.sublayers&&e.sublayers.forEach(n))};return e?.forEach(n),t}get fullExtent(){return this._recomputeFullExtent()}load(e){let t=e==null?null:e.signal;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:[`KML`],supportsData:!1},e).catch(T).then(()=>this._fetchService(t))),Promise.resolve(this)}destroy(){super.destroy(),this.allSublayers.destroy()}async _fetchService(e){let t=await Promise.resolve().then(()=>this.resourceInfo?{ssl:!1,data:this.resourceInfo}:A(this.url??``,this.outSpatialReference,this.refreshInterval,e)),n=j(t.data);n&&this.read(n,{origin:`service`})}_recomputeFullExtent(){let e=null;this.extent!=null&&(e=this.extent.clone());let t=n=>{if(n.sublayers)for(let r of n.sublayers.items)t(r),r.visible&&r.fullExtent&&(e==null?e=r.fullExtent.clone():e.union(r.fullExtent))};return t(this),e}};b([t({readOnly:!0})],B.prototype,`allSublayers`,void 0),b([t({readOnly:!0})],B.prototype,`sublayerById`,null),b([t({type:o})],B.prototype,`outSpatialReference`,void 0),b([t({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],B.prototype,`path`,void 0),b([t({readOnly:!0,json:{read:!1,write:!1}})],B.prototype,`legendEnabled`,void 0),b([t({type:[`show`,`hide`,`hide-children`]})],B.prototype,`listMode`,void 0),b([t({type:[`KML`]})],B.prototype,`operationalLayerType`,void 0),b([t({})],B.prototype,`resourceInfo`,void 0),b([t({type:v.ofType(R),json:{write:{ignoreOrigin:!0}}})],B.prototype,`sublayers`,void 0),b([p([`web-map`,`portal-item`],`sublayers`,[`visibleFolders`])],B.prototype,`readSublayersFromItemOrWebMap`,null),b([p(`service`,`sublayers`,[`sublayers`])],B.prototype,`readSublayers`,null),b([u(`sublayers`)],B.prototype,`writeSublayers`,null),b([t({readOnly:!0,json:{read:!1}})],B.prototype,`type`,void 0),b([t({json:{origins:{"web-map":{read:{source:`title`}}},write:{ignoreOrigin:!0}}})],B.prototype,`title`,null),b([t(a)],B.prototype,`url`,void 0),b([t({readOnly:!0})],B.prototype,`visibleSublayers`,null),b([t({type:D})],B.prototype,`extent`,void 0),b([t()],B.prototype,`fullExtent`,null),B=b([f(`esri.layers.KMLLayer`)],B);var V=B;export{V as default};