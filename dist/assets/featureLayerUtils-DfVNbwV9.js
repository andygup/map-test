const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CatalogLayer-BeitqVKN.js","assets/index-ByaFsVj4.js","assets/index-DiFef-Um.css","assets/quatf64-eO7UAs9K.js","assets/quat-sUyQdiZR.js","assets/memoryEstimations-C5pKF3kD.js","assets/pbf-DnDg_mXE.js","assets/MeshLocalVertexSpace-UBa2rGXG.js","assets/MeshTransform-DDT-1d0m.js","assets/axisAngleDegrees-jawZYrHR.js","assets/External-5UklRB0N.js","assets/meshVertexSpaceUtils-D9WJf86L.js","assets/OptimizedFeatureSet-DAaREXtE.js","assets/OptimizedGeometry-DX91by73.js","assets/applyEditsUtils-C7KND21k.js","assets/editingSupport-C4cREoG_.js","assets/QueryEngineCapabilities-COyCnRVj.js","assets/featureConversionUtils-C045qQF5.js","assets/FeatureLayerSource-BbOzSvUQ.js","assets/QueryTask-DN5wVWiO.js","assets/executeForIds-l9FUF4hj.js","assets/query-CshbOYjT.js","assets/urlUtils-7tPnOsRB.js","assets/pbfQueryUtils-DJL2m9Vo.js","assets/queryUtils-DQiwQ8xJ.js","assets/executeQueryJSON-BmD8vxfs.js","assets/executeQueryPBF-D_cgHlZg.js","assets/clientSideDefaults-8lL7sncR.js","assets/generateRendererUtils-D58mgMfu.js","assets/utils-2pGpZYJj.js","assets/FeatureLayer-Dg9gJqz2.js","assets/OrientedImageryLayer-TvFezKmw.js"])))=>i.map(i=>d[i]);
import{$E as e,BS as t,Ba as n,Fa as r,La as i,Na as a,Va as o,gh as s,qS as c,tD as l,za as u}from"./index-ByaFsVj4.js";import"./originUtils-BJaUzj5W.js";import"./saveUtils-BB0-rUbr.js";import{n as d,t as f}from"./fetchService-CCC5nmQq.js";import{n as p,t as m}from"./utils-rHaxpeMj.js";var h=`Feature Service`,g=`feature-layer-utils`,_=`${g}-save`,v=`${g}-save-as`;`${g}`,`${g}`;function y(e){return{isValid:s(e)&&(!(`dynamicDataSource`in e)||!e.dynamicDataSource),errorMessage:`Feature layer should be a layer or table in a map or feature service`}}function b(e,t){let n=a(e,`portal-item`);return t?.isTable&&(n.layerContainerType=`tables`),n}function x(e){let t=[],n=[];for(let{layer:r,layerJSON:i}of e)S(r)?n.push(i):t.push(i);return{layers:t,tables:n}}function S(e,t){return e.isTable}function C(e){return x([e])}async function w(e,t){return/\/\d+\/?$/.test(e.url)?C(t[0]):T(t,e)}async function T(e,t){if(e.reverse(),!t)return x(e);let n=await E(t,e);for(let t of e)I(t.layer,t.layerJSON,n);return k(n,e),n}async function E(e,t){let i=await e.fetchData(`json`);if(D(i)&&!n(e,r.HOSTED_SERVICE))return i;i||={},O(i);let{layer:{url:a,customParameters:o,apiKey:s}}=t[0];return await M(i,{url:a??``,customParameters:o,apiKey:s},t.map(e=>e.layer.layerId)),i}function D(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function O(e){e.layers||=[],e.tables||=[]}function k(e,t){let n=[],r=[];for(let{layer:e}of t){let{isTable:t,layerId:i}=e;t?r.push(i):n.push(i)}A(e.layers,n),A(e.tables,r)}function A(e,t){if(e.length<2)return;let n=[];for(let{id:t}of e)n.push(t);l(n.sort(j),t.slice().sort(j))&&e.sort((e,n)=>{let r=t.indexOf(e.id),i=t.indexOf(n.id);return r<i?-1:r>i?1:0})}function j(e,t){return e<t?-1:e>t?1:0}async function M(e,t,n){let{url:r,customParameters:i,apiKey:a}=t,{serviceJSON:o,layersJSON:s}=await f(r,{customParameters:i,apiKey:a}),c=N(e.layers,o.layers,n),l=N(e.tables,o.tables,n);e.layers=c.itemResources,e.tables=l.itemResources;let u=[...c.added,...l.added],d=s?[...s.layers,...s.tables]:[];await P(e,u,r,d)}function N(t,n,r){let i=e(t,n,(e,t)=>e.id===t.id);t=t.filter(e=>!i.removed.some(t=>t.id===e.id));let a=i.added;return a.forEach(({id:e})=>{t.push({id:e})}),{itemResources:t,added:a.filter(({id:e})=>!r.includes(e))}}async function P(e,t,n,r){let i=await F(t),a=t.map(({id:e,type:t})=>new(i.get(t))({url:n,layerId:e,sourceJSON:r.find(({id:t})=>t===e)}));await Promise.allSettled(a.map(e=>e.load())),a.forEach(t=>{let{layerId:n,loaded:r,defaultPopupTemplate:i}=t;if(!r||i==null)return;let a={id:n,popupInfo:i.toJSON()};I(t,t.operationalLayerType===`ArcGISFeatureLayer`?a:{...a,layerType:t.operationalLayerType},e)})}async function F(e){let n=[];e.forEach(({type:e})=>{switch(d(e)){case`CatalogLayer`:n.push(t(()=>import(`./CatalogLayer-BeitqVKN.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29])).then(e=>e.default));break;case`FeatureLayer`:n.push(t(()=>import(`./FeatureLayer-Dg9gJqz2.js`),__vite__mapDeps([30,1,2])).then(e=>e.default));break;case`OrientedImageryLayer`:n.push(t(()=>import(`./OrientedImageryLayer-TvFezKmw.js`),__vite__mapDeps([31,1,2])).then(e=>e.default))}});let r=await Promise.all(n),i=new Map;return e.forEach(({type:e},t)=>{i.set(e,r[t])}),i}function I(e,t,n){e.isTable?L(n.tables,t):L(n.layers,t)}function L(e,t){let n=e.findIndex(({id:e})=>e===t.id);n===-1?e.push(t):e[n]=t}function R(e){if(!(`layerType`in e))return!!e.charts?.length;switch(e.layerType){case`OrientedImageryLayer`:return!!e.charts?.length;case`SubtypeGroupLayer`:return!!e.layers.some(e=>!!e.charts?.length);case`SubtypeGroupTable`:return!!e.tables.some(e=>!!e.charts?.length);case`CatalogLayer`:return!!e.footprintLayer?.charts?.length}}function z(e,t){let n=0,i=0,a=0,s=0;for(let e of[...t.layers,...t.tables])if(R(e)&&s++,`layerType`in e)switch(e.layerType){case`OrientedImageryLayer`:n++;break;case`SubtypeGroupLayer`:i++;break;case`SubtypeGroupTable`:a++}o(e,r.ORIENTED_IMAGERY_LAYER,n>0),o(e,r.SUBTYPE_GROUP_LAYER,i>0),o(e,r.SUBTYPE_GROUP_TABLE,a>0),o(e,r.CHARTS,s>0)}function B(e,t,n){i(t,r.METADATA),o(t,r.MULTI_LAYER,e.length>1),o(t,r.SINGLE_LAYER,e.length===1),o(t,r.TABLE,n.tables.length>0&&n.layers.length===0),z(t,n)}async function V(e,t,n){z(t,n)}async function H(e,t,n){let{url:r,layerId:i,title:a,fullExtent:o,isTable:s}=e;t.url=(c(r)?.serverType===`FeatureServer`?r:`${r}/${i}`)??null,t.title||=a,t.extent=null,s||o==null||(t.extent=await u(o)),B([e],t,n)}async function U(e,t){return p({layer:e,itemType:h,validateLayer:y,createJSONContext:t=>b(t,e),createItemData:(e,t)=>w(t,[e]),errorNamePrefix:_,setItemProperties:V},t)}async function W(e,t,n){return m({layer:e,itemType:h,validateLayer:y,createJSONContext:t=>b(t,e),createItemData:(e,t)=>Promise.resolve(C(e)),errorNamePrefix:v,newItem:t,setItemProperties:H},n)}export{U as save,W as saveAs};