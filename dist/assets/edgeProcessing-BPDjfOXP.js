import{Ml as e,Nl as t,Ol as n,c_ as r,dl as i,fw as a,kl as o,lD as s,ll as c,nw as l,oT as u,rl as d,vl as f,yl as p}from"./index-CZ4oMP1N.js";import{t as m}from"./deduplicate-DAw_n_cX.js";import{a as h,s as g}from"./FloatArray-DqATud34.js";import{t as _}from"./TextureBackedBufferLayout-CRYrdH8z.js";import{n as v}from"./Normals-C9pyKGRR.js";var y=h().vec3f(`position`).u16(`componentIndex`,{integer:!0}).freeze(),b=h().vec2u8(`sideness`).freeze(),x=g(b),S=h().vec3f(`position0`).vec3f(`position1`).vec2i16(`normalCompressed`).u16(`componentIndex`,{integer:!0}).u8(`variantOffset`,{glNormalized:!0}).u8(`variantStroke`).u8(`variantExtension`,{glNormalized:!0}).freeze(),C=h().vec3f(`position0`).vec3f(`position1`).vec2i16(`normalCompressed`).vec2i16(`normal2Compressed`).u16(`componentIndex`,{integer:!0}).u8(`variantOffset`,{glNormalized:!0}).u8(`variantStroke`).u8(`variantExtension`,{glNormalized:!0}).freeze(),w=g(S,1),T=g(C,1);x.concat(w),x.concat(T),new _([{name:`color`,type:`vec4unorm8`},{name:`lineWidth`,type:`u8`},{name:`extensionLength`,type:`u8`},{name:`materialType`,type:`u8`},{name:`opacity`,type:`unorm8`},{name:`elevationOffset`,type:`f32`}]);var E=class{constructor(){this.position0=r(),this.position1=r(),this.faceNormal0=r(),this.faceNormal1=r(),this.componentIndex=0,this.cosAngle=0}},D=-1;function O(t,r,a){let s=t.vertices.position,c=t.vertices.componentIndex,l=N.position0,u=N.position1,d=N.faceNormal0,f=N.faceNormal1,{edges:p,normals:m}=ne(t),h=p.length/4,g=r.allocate(h),_=0,v=h,y=a?.allocate(v),b=0,x=0,S=0;A.length=0;for(let e=0;e<h;++e){let t=4*e;s.getVec(p.data[t],l),s.getVec(p.data[t+1],u);let n=A.pushNew();n.index=4*e,n.length=o(l,u)}A.sort((e,t)=>t.length-e.length);let C=[],w=[];A.forAll(({length:t,index:o})=>{let h=p.data[o],v=p.data[o+1],T=p.data[o+2],E=p.data[o+3],O=E===D;if(s.getVec(h,l),s.getVec(v,u),O){let t=3*T;n(d,m.data[t],m.data[t+1],m.data[t+2]),e(f,d),N.componentIndex=c.get(h),N.cosAngle=i(d,f)}else{let t=3*T;if(n(d,m.data[t],m.data[t+1],m.data[t+2]),t=3*E,n(f,m.data[t],m.data[t+1],m.data[t+2]),N.componentIndex=c.get(h),N.cosAngle=i(d,f),k(N,ae))return;N.cosAngle<-.9999&&e(f,d)}x+=t,S++,O||ee(N,B)?(r.write(g,_++,N),C.push(t)):te(N,R)&&(y&&a&&a.write(y,b++,N),w.push(t))});let T=new Float32Array(C.reverse()),E=new Float32Array(w.reverse()),O=y&&a?{instancesData:y.slice(0,b),lodInfo:{lengths:E}}:void 0;return{regular:{instancesData:g.slice(0,_),lodInfo:{lengths:T}},silhouette:O,averageEdgeLength:x/S}}function ee(e,t){return e.cosAngle<t}function k(e,t){return e.cosAngle>t}function te(e,t){let n=l(e.cosAngle);return c(P,e.position1,e.position0),n*(i(f(ie,e.faceNormal0,e.faceNormal1),P)>0?-1:1)>t}function ne(e){let t=e.faces.length/3,n=e.faces,r=e.neighbors,i=e.vertices.position;j.length=M.length=0;for(let e=0;e<t;e++){let t=3*e,a=r[t],o=r[t+1],s=r[t+2],c=n[t],l=n[t+1],u=n[t+2];i.getVec(c,F),i.getVec(l,I),i.getVec(u,L),p(I,I,F),p(L,L,F),f(F,I,L),d(F,F),M.pushArray(F),(a===D||c<l)&&(j.push(c),j.push(l),j.push(e),j.push(a)),(o===D||l<u)&&(j.push(l),j.push(u),j.push(e),j.push(o)),(s===D||u<c)&&(j.push(u),j.push(c),j.push(e),j.push(s))}return{edges:j,normals:M}}var re=class{constructor(){this.index=0,this.length=0}},A=new u({allocator:e=>e||new re,deallocator:null}),j=new u({deallocator:null}),M=new u({deallocator:null}),N=new E,ie=r(),P=r(),F=r(),I=r(),L=r(),R=a(4),ae=Math.cos(R),z=a(35),B=Math.cos(z);function V(e,t,n){let r=t/3,i=new Uint32Array(n+1),a=new Uint32Array(n+1),o=(e,t)=>{e<t?i[e+1]++:a[t+1]++};for(let t=0;t<r;t++){let n=e[3*t],r=e[3*t+1],i=e[3*t+2];o(n,r),o(r,i),o(i,n)}let s=0,c=0;for(let e=0;e<n;e++){let t=i[e+1],n=a[e+1];i[e+1]=s,a[e+1]=c,s+=t,c+=n}let l=new Uint32Array(6*r),u=i[n],d=(e,t,n)=>{if(e<t){let r=i[e+1]++;l[2*r]=t,l[2*r+1]=n}else{let r=a[t+1]++;l[2*u+2*r]=e,l[2*u+2*r+1]=n}};for(let t=0;t<r;t++){let n=e[3*t],r=e[3*t+1],i=e[3*t+2];d(n,r,t),d(r,i,t),d(i,n,t)}let f=(e,t)=>{let n=2*e,r=t-e;for(let e=1;e<r;e++){let t=l[n+2*e],r=l[n+2*e+1],i=e-1;for(;i>=0&&l[n+2*i]>t;i--)l[n+2*i+2]=l[n+2*i],l[n+2*i+3]=l[n+2*i+1];l[n+2*i+2]=t,l[n+2*i+3]=r}};for(let e=0;e<n;e++)f(i[e],i[e+1]),f(u+a[e],u+a[e+1]);let p=new Int32Array(3*r),m=(t,n)=>t===e[3*n]?0:t===e[3*n+1]?1:t===e[3*n+2]?2:-1,h=(e,t)=>{let n=m(e,t);p[3*t+n]=-1},g=(e,t,n,r)=>{let i=m(e,t);p[3*t+i]=r;let a=m(n,r);p[3*r+a]=t};for(let e=0;e<n;e++){let t=i[e],n=i[e+1],r=a[e],o=a[e+1];for(;t<n&&r<o;){let n=l[2*t],i=l[2*u+2*r];n===i?(g(e,l[2*t+1],i,l[2*u+2*r+1]),t++,r++):n<i?(h(e,l[2*t+1]),t++):(h(i,l[2*u+2*r+1]),r++)}for(;t<n;)h(e,l[2*t+1]),t++;for(;r<o;)h(l[2*u+2*r],l[2*u+2*r+1]),r++}return p}var H=.7,U=class{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?se:oe}write(e,t,n){X.seed=this._edgeHashFunction(n);let r=X.getIntRange(0,255),i=X.getIntRange(0,this.settings.variants-1),a=X.getFloat(),o=255*(.5*ce(-(1-Math.min(a/H,1))+Math.max(0,a-H)/(1-H),1.2)+.5);e.position0.setVec(t,n.position0),e.position1.setVec(t,n.position1),e.componentIndex.set(t,n.componentIndex),e.variantOffset.set(t,r),e.variantStroke.set(t,i),e.variantExtension.set(t,o)}},W=new Float32Array(6),G=new Uint32Array(W.buffer),K=new Uint32Array(1);function oe(e){return W[0]=e.position0[0],W[1]=e.position0[1],W[2]=e.position0[2],W[3]=e.position1[0],W[4]=e.position1[1],W[5]=e.position1[2],K[0]=31*(31*(31*(31*(31*(166811+G[0])+G[1])+G[2])+G[3])+G[4])+G[5],K[0]}function se(e){let t=W;t[0]=J(e.position0[0]),t[1]=J(e.position0[1]),t[2]=J(e.position0[2]),t[3]=J(e.position1[0]),t[4]=J(e.position1[1]),t[5]=J(e.position1[2]),K[0]=5381;for(let e=0;e<G.length;e++)K[0]=31*K[0]+G[e];return K[0]}var q=1e4;function J(e){return Math.round(e*q)/q}function ce(e,t){return Math.abs(e)**t*Math.sign(e)}var le=class{constructor(){this._commonWriter=new U}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return S.createBuffer(e)}write(e,n,r){this._commonWriter.write(e,n,r),t(Y,r.faceNormal0,r.faceNormal1),d(Y,Y);let{typedBuffer:i,typedBufferStride:a}=e.normalCompressed;v(i,n,Y[0],Y[1],Y[2],a)}},ue=class{constructor(){this._commonWriter=new U}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return C.createBuffer(e)}write(e,t,n){this._commonWriter.write(e,t,n);{let{typedBuffer:r,typedBufferStride:i}=e.normalCompressed;v(r,t,n.faceNormal0[0],n.faceNormal0[1],n.faceNormal0[2],i)}{let{typedBuffer:r,typedBufferStride:i}=e.normal2Compressed;v(r,t,n.faceNormal1[0],n.faceNormal1[1],n.faceNormal1[2],i)}}},Y=r(),X=new s;function de(e){let t=Z(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return Q.updateSettings(e.writerSettings),$.updateSettings(e.writerSettings),O(t,Q,$)}function Z(e,t,n,r){if(t){let t=V(n,r,e.count);return new fe(n,r,t,e)}let i=m(e.buffer,e.stride/4,{originalIndices:n}),a=V(i.indices,r,i.uniqueCount);return{faces:i.indices,facesLength:i.indices.length,neighbors:a,vertices:y.createView(i.buffer)}}var fe=class{constructor(e,t,n,r){this.faces=e,this.facesLength=t,this.neighbors=n,this.vertices=r}},Q=new le,$=new ue,pe=h().vec3f(`position0`).vec3f(`position1`),me=h().vec3f(`position0`).vec3f(`position1`).u16(`componentIndex`,{integer:!0});export{O as a,pe as i,de as n,y as o,Z as r,me as t};