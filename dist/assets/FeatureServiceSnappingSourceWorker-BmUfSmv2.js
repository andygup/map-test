import{$T as e,Af as t,Ag as n,Aw as r,BT as i,Bw as a,CE as o,Fw as s,Lw as c,Lx as l,Nw as u,Ov as d,Pw as ee,Sg as f,VT as p,Xw as te,_v as ne,_x as m,aC as h,bg as g,ch as _,cv as re,ex as ie,fv as ae,ix as v,jg as y,kD as b,kv as oe,lx as se,mD as x,mx as ce,pT as S,pd as C,pv as w,rp as T,sD as le,sT as E,sx as D,uf as ue,uv as de,vv as fe,vx as pe,wg as O,zi as me}from"./index-BN8X5Ryz.js";import{n as k}from"./memoryEstimations-D_IbKyOk.js";import{t as A}from"./OptimizedGeometry-BQJ7w5VU.js";import{i as j}from"./OptimizedFeatureSet-CLjmRHYn.js";import{b as M}from"./featureConversionUtils-o9-cJXzl.js";import"./WhereClause-CATd9kVz.js";import"./closestPointOnCurve-CwZL45U3.js";import"./urlUtils-CW4cnJ3W.js";import{a as N,o as P,r as F,t as I}from"./FlatGeometry-BsPiiSVP.js";import"./WhereClauseCache-BO4WYMj9.js";import"./PooledRBush-BH7_Gu1G.js";import"./QueryEngineCapabilities-CxeEdoTy.js";import"./generateRendererUtils-DGV_dTnd.js";import"./utils-DCGMUq-q.js";import"./pbf-CO6WFbVS.js";import{i as L}from"./pbfQueryUtils-CmJPTrN7.js";import"./queryUtils-8f7b9mi_.js";import{a as R,o as z,r as he,t as ge}from"./query-BXrgTHrc.js";import{t as B}from"./BoundsStore-DE7p6f_c.js";import{c as _e}from"./timeSupport-vK4lVcYW.js";import{t as ve}from"./QueryEngine-CD8WljsT.js";import"./queryUtils-DGU5ISbw.js";import"./utils-Bftaersa.js";import"./utils-BizEctJo.js";import"./SnappingCandidate-4DPnOY6Y.js";import"./FixedIntervalBinParameters-CMgMaWGN.js";import{n as V,r as H,t as U}from"./symbologySnappingCandidates-B-0zt98i.js";var W=class e{constructor(e=null,t={},n,r,i=0){this.geometry=e,this.attributes=t,this.centroid=n,this.objectId=r,this.displayId=i}weakClone(){return new e(this.geometry,this.attributes,this.centroid,this.objectId,this.displayId)}clone(){return new e(this.geometry?.clone(),{...this.attributes},this.centroid?.clone(),this.objectId,this.displayId)}get usedMemory(){return 128+k(this.attributes)+(this.geometry?.usedMemory??0)}ensureCentroid(e){return this.centroid??=j(this.geometry&&F(this.geometry)),this.centroid}};function ye(e,{geometry:t,attributes:n,centroid:r,objectId:i,displayId:a}){return new W(t&&I(e,t),n,r,i,a)}var be={getObjectId:e=>e.objectId,getAttributes:e=>e.attributes,getAttribute:(e,t)=>e.attributes[t],cloneWithGeometry:(e,t,n)=>new W(I(d.fromJSON(n),t),e.attributes,null,e.objectId),getGeometry:e=>e.geometry&&F(e.geometry),getGeometryWithCurves:e=>e.geometry,getCentroid:(e,t)=>e.ensureCentroid(t)},G=t(),xe=class{constructor(e,t,n){this.geometryType=e,this.hasZ=t,this.hasM=n,this._boundsStore=new B,this._featuresById=new Map,this._usedMemory=0,this.events=new ne,this.featureAdapter=be}get usedMemory(){return this._usedMemory}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=this._featuresById.size,t=0;return this._featuresById.forEach(({geometry:e})=>{t+=e?e.vertexCount:0}),{featureCount:e,vertexCount:t}}getFullExtent(e){if(this.fullBounds==null)return null;let[t,n,r,i]=this.fullBounds;return{xmin:t,ymin:n,xmax:r,ymax:i,spatialReference:_e(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(let t of e)this._add(t);this._emitChanged()}upsertMany(e){let t=e.map(e=>this._upsert(e));return this._emitChanged(),t.filter(le)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged(),this._usedMemory=0}removeById(e){let t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(let t of e){let e=this._featuresById.get(t);e&&this._remove(e)}this._emitChanged()}forEachBounds(e,t){for(let n of e){let e=this._boundsStore.get(n.objectId);e&&t(ue(G,e))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach(t=>e(t))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,e=>{t(this._featuresById.get(e))})}_emitChanged(){this.events.emit(`changed`,void 0)}_add(t){if(!t)return;let n=t.objectId;if(n==null)return void o.getLogger(`esri.layers.graphics.data.FeatureStore`).error(new e(`featurestore:invalid-feature`,`feature id is missing`,{feature:t}));let r=this._featuresById.get(n),i;if(r?(t.displayId=r.displayId,i=this._boundsStore.get(n)??void 0,this._boundsStore.delete(n),this._usedMemory-=this.estimateFeatureUsedMemory?.(r)??0):this.onFeatureAdd?.(t),!t.geometry)return this._boundsStore.set(n,null),void this._featuresById.set(n,t);this._boundsStore.set(n,P(t.geometry,i)),this._featuresById.set(n,t),this._usedMemory+=this.estimateFeatureUsedMemory?.(t)??0}_upsert(t){let n=t?.objectId;if(n==null)return o.getLogger(`esri.layers.graphics.data.FeatureStore`).error(new e(`featurestore:invalid-feature`,`feature id is missing`,{feature:t})),null;let r=this._featuresById.get(n);if(!r)return this._add(t),t;this._usedMemory-=this.estimateFeatureUsedMemory?.(r)??0;let{geometry:i,attributes:a}=t;for(let e in a)r.attributes[e]=a[e];return i&&(r.geometry=i,this._boundsStore.set(n,P(i)??null)),this._usedMemory+=this.estimateFeatureUsedMemory?.(r)??0,r}_remove(e){this.onFeatureRemove!=null&&this.onFeatureRemove(e);let t=e.objectId;return this._boundsStore.delete(t),this._featuresById.delete(t),this._usedMemory-=this.estimateFeatureUsedMemory?.(e)??0,e}},K=class e{constructor(){this.globalIdFieldName=null,this.geohashFieldName=null,this.geometryProperties=null,this.geometryType=null,this.spatialReference=null,this.hasZ=!1,this.hasM=!1,this.features=[],this.fields=[],this.transform=null,this.exceededTransferLimit=!1,this.uniqueIdField=null,this.queryGeometryType=null,this.queryGeometry=null}weakClone(){let t=new e;return t.globalIdFieldName=this.globalIdFieldName,t.geohashFieldName=this.geohashFieldName,t.geometryProperties=this.geometryProperties,t.geometryType=this.geometryType,t.spatialReference=this.spatialReference,t.hasZ=this.hasZ,t.hasM=this.hasM,t.features=this.features,t.fields=this.fields,t.transform=this.transform,t.exceededTransferLimit=this.exceededTransferLimit,t.uniqueIdField=this.uniqueIdField,t.queryGeometry=this.queryGeometry,t.queryGeometryType=this.queryGeometryType,t}};function Se(e){let t=d.fromJSON(e.geometryType),n=new K;return n.globalIdFieldName=e.globalIdFieldName,n.geohashFieldName=e.geohashFieldName,n.geometryProperties=e.geometryProperties,n.geometryType=e.geometryType,n.spatialReference=e.spatialReference,n.hasZ=e.hasZ,n.hasM=e.hasM,n.features=e.features.map(e=>ye(t,e)),n.fields=e.fields,n.transform=e.transform,n.exceededTransferLimit=e.exceededTransferLimit,n.uniqueIdField=e.uniqueIdField,n.queryGeometry=e.queryGeometry&&I(t,e.queryGeometry),n.queryGeometryType=e.queryGeometryType,n}function Ce({exceededTransferLimit:e,features:t,fields:n,geometryType:r,hasM:i,hasZ:a,spatialReference:o,transform:s},c){let l=new K;l.exceededTransferLimit=e??!1;for(let e of t??[]){let t,n;r&&(t=e.geometry&&N(e.geometry),n=e.centroid&&new A([],[e.centroid.x,e.centroid.y]));let i=T(e,c);l.features.push(new W(t,e.attributes,n,i))}return l.fields=n??l.fields,l.geometryType=r??null,l.hasM=i??!1,l.hasZ=a??!1,l.spatialReference=o??null,l.transform=s??null,l}var we=class{constructor(e,t){this.key=e,this.resolution=t,this.state={type:0},this.alive=!0}process(e){switch(this.state.type){case 0:return this.state=this._gotoFetchCount(this.state,e),this.state.task.promise.then(e.resume,e.resume);case 1:case 3:break;case 2:return this.state=this._gotoFetchFeatures(this.state,e),this.state.task.promise.then(e.resume,e.resume);case 4:this.state=this._goToDone(this.state,e)}return null}get debugInfo(){return{key:this.key,featureCount:this._featureCount,state:this._stateToString}}get _featureCount(){switch(this.state.type){case 0:case 1:return 0;case 2:return this.state.featureCount;case 3:return this.state.previous.featureCount;case 4:return this.state.features.length;case 5:return this.state.previous.features.length}}get _stateToString(){switch(this.state.type){case 0:return`created`;case 1:return`fetch-count`;case 2:return`fetched-count`;case 3:return`fetch-features`;case 4:return`fetched-features`;case 5:return`done`}}_gotoFetchCount(e,t){return{type:1,previous:e,task:f(async e=>{let n=await g(t.fetchCount(this,e));this.state.type===1&&(this.state=Te(this.state,n.ok?n.value:1/0))})}}_gotoFetchFeatures(e,t){return{type:3,previous:e,task:f(async n=>{let r=await g(t.fetchFeatures(this,e.featureCount,n));this.state.type===3&&(this.state=Ee(this.state,r.ok?r.value:[]))})}}_goToDone(e,t){return t.finish(this,e.features),{type:5,previous:e}}reset(){let e=this.state;switch(this.state={type:0},e.type){case 0:case 2:case 4:case 5:break;case 1:case 3:e.task.abort()}}};function Te(e,t){return{type:2,featureCount:t,previous:e}}function Ee(e,t){return{type:4,previous:e,features:t}}var q=class extends r{get _minimumVerticesPerFeature(){switch(this.store?.featureStore.geometryType){case`esriGeometryPoint`:case`esriGeometryMultipoint`:return 1;case`esriGeometryPolygon`:return 4;case`esriGeometryPolyline`:return 2}}get _mandatoryOutFields(){let e=new Set;return this.objectIdField&&e.add(this.objectIdField),this.globalIdField&&e.add(this.globalIdField),e}set outFields(e){let t=this._get(`outFields`),n=a(e,this._mandatoryOutFields);ee(n,t)||(this._set(`outFields`,n),c(n,t)||this.refresh())}get outFields(){return this._get(`outFields`)??this._mandatoryOutFields}set filter(e){let t=this._get(`filter`),n=this._filterProperties(e);JSON.stringify(t)!==JSON.stringify(n)&&this._set(`filter`,n)}set customParameters(e){let t=this._get(`customParameters`);JSON.stringify(t)!==JSON.stringify(e)&&this._set(`customParameters`,e)}get _configuration(){return{filter:this.filter,customParameters:this.customParameters,tileInfo:this.tileInfo,tileSize:this.tileSize}}set tileInfo(e){let t=this._get(`tileInfo`);t!==e&&(e!=null&&t!=null&&JSON.stringify(e)===JSON.stringify(t)||(this._set(`tileInfo`,e),this.store.tileInfo=e))}set tileSize(e){this._get(`tileSize`)!==e&&this._set(`tileSize`,e)}get updating(){return this._updatingHandles.updating}get hasZ(){return this.store.featureStore.hasZ}constructor(e){super(e),this.suspended=!0,this._historicMoment=null,this.tilesOfInterest=[],this.availability=0,this._pendingTiles=new Map,this._updatingHandles=new O}initialize(){this._initializeFetchExtent(),this._updatingHandles.add(()=>this._configuration,()=>this.refresh()),this._updatingHandles.add(()=>this.tilesOfInterest,()=>{this._updatePriorities(),this._process()},{sync:!0,initial:!0,equals:(e,t)=>x(e,t,({id:e},{id:t})=>e===t)}),this.addHandles(de(()=>!this.suspended,()=>this._process()))}_updatePriorities(){this.store.setPriorityOrderByKey(this.tilesOfInterest.map(({id:e})=>e)??[])}destroy(){this._pendingTiles.forEach(e=>this._deletePendingTile(e)),this._pendingTiles.clear(),this.store.destroy(),this.tilesOfInterest.length=0,this._updatingHandles.destroy()}refresh(){this.store.refresh(),this._pendingTiles.forEach(e=>this._deletePendingTile(e)),this._process()}async handleEdits(e){if(e.historicMoment&&(this._historicMoment=e.historicMoment),!e.addedFeatures.length&&!e.updatedFeatures.length&&!e.deletedFeatures.length)return;for(let e of this._pendingTiles.values())e.reset();let t={...e,deletedFeatures:e.deletedFeatures.map(({objectId:e,globalId:t})=>e&&e!==-1?e:this._lookupObjectIdByGlobalId(t))},n=f(async e=>{try{await this.store.processEdits(t,(e,t)=>this._queryFeaturesById(e,t),e),this._processPendingTiles()}catch(e){E(e),o.getLogger(this).warn(`Failed to apply edits`,e)}});this.addHandles(n),await this._updatingHandles.addPromise(n.promise)}setHistoricMoment(e){e?.getTime()!==this._historicMoment?.getTime()&&(this._historicMoment=e,this.refresh())}_initializeFetchExtent(){if(!this.capabilities.query.supportsExtent||!h(this.url))return;let e=f(async e=>{try{let t=await ge(this.url,new C({where:`1=1`,outSpatialReference:this.spatialReference,cacheHint:this.capabilities.query.supportsCacheHint??void 0}),{query:this._configuration.customParameters,signal:e});this.store.extent=pe.fromJSON(t?.extent)}catch(e){E(e),o.getLogger(this).warn(`Failed to fetch data extent`,e)}});this._updatingHandles.addPromise(e.promise.then(()=>this._process())),this.addHandles(e)}get debugInfo(){return{numberOfFeatures:this.store.featureStore.numFeatures,tilesOfInterest:this.tilesOfInterest,pendingTiles:Array.from(this._pendingTiles.values()).map(e=>e.debugInfo),storedTiles:this.store.debugInfo}}_process(){this._markTilesNotAlive(),this._createPendingTiles(),this._deletePendingTiles(),this._processPendingTiles()}_markTilesNotAlive(){for(let e of this._pendingTiles.values())e.alive=!1}_createPendingTiles(){if(this.suspended)return;let e=this._collectMissingTilesInfo();if(this._setAvailability(e==null?1:e.coveredArea/e.fullArea),e!=null)for(let{data:t,resolution:n}of e.missingTiles){let e=this._pendingTiles.get(t.id);e?(e.resolution=n,e.alive=!0):this._createPendingTile(t,n)}}_collectMissingTilesInfo(){let e=null;for(let t of this.tilesOfInterest){let n=this.store.process(t,(e,t)=>this._verifyTileComplexity(e,t),this.outFields);e==null?e=n:e.prepend(n)}return e}_deletePendingTiles(){for(let e of this._pendingTiles.values())e.alive||this._deletePendingTile(e)}_processPendingTiles(){let e={fetchCount:(e,t)=>this._fetchCount(e,t),fetchFeatures:(e,t,n)=>this._fetchFeatures(e,t,n),finish:(e,t)=>this._finishPendingTile(e,t),resume:()=>this._processPendingTiles()};if(this._ensureFetchAllCounts(e))for(let t of this._pendingTiles.values())this._verifyTileComplexity(this.store.getFeatureCount(t.key),t.resolution)&&this._updatingHandles.addPromise(t.process(e))}_verifyTileComplexity(e,t){return this._verifyVertexComplexity(e)&&this._verifyFeatureDensity(e,t)}_verifyVertexComplexity(e){return e*this._minimumVerticesPerFeature<Oe}_verifyFeatureDensity(e,t){if(this.tileInfo==null)return!1;let n=this.tileSize*t;return e*(ke/(n*n))<Ae}_ensureFetchAllCounts(e){let t=!0;for(let n of this._pendingTiles.values())n.state.type<2&&this._updatingHandles.addPromise(n.process(e)),n.state.type<=1&&(t=!1);return t}_finishPendingTile(e,t){this.store.add(e.key,t),this._deletePendingTile(e),this._updateAvailability()}_updateAvailability(){let e=this._collectMissingTilesInfo();this._setAvailability(e==null?1:e.coveredArea/e.fullArea)}_setAvailability(e){this._set(`availability`,e)}_createPendingTile(e,t){let n=new we(e,t);return this._pendingTiles.set(e.id,n),n}_deletePendingTile(e){e.reset(),this._pendingTiles.delete(e.key.id)}async _fetchCount(e,t){return this.store.fetchCount(e.key,this.url,this._createCountQuery(e),{query:this.customParameters,timeout:J,signal:t})}async _fetchFeatures(e,t,n){let r=0,i=[],a=0,o=t;for(;;){let s=this._createFeaturesQuery(e),c=this._setPagingParameters(s,r,o),{features:l,exceededTransferLimit:u}=await this._queryFeatures(s,n);c&&(r+=s.num),a+=l.length;for(let e of l)i.push(e);if(o=t-a,!c||!u||o<=0)return i}}_filterProperties(e){return e==null?{where:`1=1`,gdbVersion:void 0,timeExtent:void 0}:{where:e.where||`1=1`,timeExtent:e.timeExtent,gdbVersion:e.gdbVersion}}_lookupObjectIdByGlobalId(e){let t=this.globalIdField,n=this.objectIdField;if(t==null)throw Error(`Expected globalIdField to be defined`);let r=null,i=e&&_(e);if(this.store.featureStore.forEach(e=>{i===_(e.attributes[t])&&(r=e.objectId??e.attributes[n])}),r==null)throw Error(`Expected to find a feature with globalId ${e}`);return r}_queryFeaturesById(e,t){let n=this._createFeaturesQuery();return n.objectIds=e,this._queryFeatures(n,t)}async _queryFeatures(e,t){return e.num===0?new K:this.capabilities.query.supportsFormatPBF?this._queryFeaturesPBF(e,t):this._queryFeaturesJSON(e,t)}async _queryFeaturesPBF(e,t){let{sourceSpatialReference:n}=this,r=await he(this.url,e,new L({sourceSpatialReference:n}),{query:this._configuration.customParameters,timeout:J,signal:t});return Se(M(r))}async _queryFeaturesJSON(e,t){let{sourceSpatialReference:n}=this,r=await z(this.url,e,n,{query:this._configuration.customParameters,timeout:J,signal:t});return Ce(r,{type:`object-id`,fieldName:this.objectIdField})}_createCountQuery(e){let t=this._createBaseQuery(e);return this.capabilities.query.supportsCacheHint&&(t.cacheHint=!0),t}_createFeaturesQuery(e=null){let t=this._createBaseQuery(e),n=e?.key==null?null:this.store.getAttributesForTile(e?.key?.id),r=a(s(this.outFields,n??new Set),this._mandatoryOutFields);return t.outFields=Array.from(r),t.returnGeometry=!0,e!=null&&(this.capabilities.query.supportsResultType?t.resultType=`tile`:this.capabilities.query.supportsCacheHint&&(t.cacheHint=!0)),t}_createBaseQuery(e){let t=new C({returnZ:this.hasZ,returnM:!1,historicMoment:this._historicMoment,geometry:this.tileInfo!=null&&e!=null?se(e.key.extent,this.tileInfo.spatialReference):void 0}),n=this._configuration.filter;return n!=null&&(t.where=n.where,t.gdbVersion=n.gdbVersion,t.timeExtent=n.timeExtent),t.outSpatialReference=this.spatialReference,t}_setPagingParameters(e,t,n){if(!this.capabilities.query.supportsPagination)return!1;let{supportsMaxRecordCountFactor:r,supportsCacheHint:i,tileMaxRecordCount:a,maxRecordCount:o,supportsResultType:s}=this.capabilities.query,c=r?C.MAX_MAX_RECORD_COUNT_FACTOR:1,l=c*((s||i)&&a?a:o||De);return e.start=t,r?(e.maxRecordCountFactor=Math.min(c,Math.ceil(n/l)),e.num=Math.min(n,e.maxRecordCountFactor*l)):e.num=Math.min(n,l),!0}};b([i({constructOnly:!0})],q.prototype,`url`,void 0),b([i({constructOnly:!0})],q.prototype,`objectIdField`,void 0),b([i({constructOnly:!0})],q.prototype,`globalIdField`,void 0),b([i({constructOnly:!0})],q.prototype,`capabilities`,void 0),b([i({constructOnly:!0})],q.prototype,`sourceSpatialReference`,void 0),b([i({constructOnly:!0})],q.prototype,`spatialReference`,void 0),b([i({constructOnly:!0})],q.prototype,`store`,void 0),b([i({readOnly:!0})],q.prototype,`_minimumVerticesPerFeature`,null),b([i()],q.prototype,`_mandatoryOutFields`,null),b([i()],q.prototype,`outFields`,null),b([i()],q.prototype,`suspended`,void 0),b([i()],q.prototype,`_historicMoment`,void 0),b([i()],q.prototype,`filter`,null),b([i()],q.prototype,`customParameters`,null),b([i({readOnly:!0})],q.prototype,`_configuration`,null),b([i()],q.prototype,`tileInfo`,null),b([i()],q.prototype,`tileSize`,null),b([i()],q.prototype,`tilesOfInterest`,void 0),b([i({readOnly:!0})],q.prototype,`updating`,null),b([i({readOnly:!0})],q.prototype,`availability`,void 0),b([i()],q.prototype,`hasZ`,null),q=b([p(`esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher`)],q);var De=2e3,J=6e5,Oe=1e6,ke=25,Ae=1,je=class{constructor(){this._store=new Map,this._priorities=new Map}get size(){return this._store.size}setPriorityOrderByKey(e){this._priorities.clear();for(let t=e.length-1;t>=0;t--)this._priorities.set(e[t],e.length-t)}hasLowerPriority(e){let t=this._priorities.get(e);if(t==null)return!0;for(let[e]of this._store){let n=this._priorities.get(e);if(n==null||n<t)return!0}return!1}someFromLowestToHighestPriority(e){let{_priorities:t}=this;for(let[n,r]of this._store)if(!t.has(n)&&e(r,n))return!0;for(let[n]of t){let t=this._store.get(n);if(t&&e(t,n))return!0}return!1}set(e,t){this._store.set(e,t)}delete(e){return this._store.delete(e)}get(e){return this._store.get(e)}has(e){return this._store.has(e)}clear(){this._store.clear()}values(){return this._store.values()}[Symbol.iterator](){return this._store[Symbol.iterator]()}},Y=class extends r{setPriorityOrderByKey(e){this._tiles.setPriorityOrderByKey(e)}get _memoryLimitExceeded(){return this.featureStore.usedMemory>=this.maximumByteSize}constructor(e){super(e),this.tileInfo=null,this.extent=null,this.maximumByteSize=10485760,this._tileBounds=new B,this._tiles=new je,this._refCounts=new Map,this._tileFeatureCounts=new Map,this._tmpBoundingRect=ce()}add(e,t){for(let e of t)this._referenceFeature(e.objectId);let n=this.featureStore.upsertMany(t),r=n.map(e=>new Set(Object.keys(e.attributes))).reduce((e,t)=>u(e,t),new Set(Object.keys(n[0]?.attributes??[]))),i=this._memoryLimitExceeded;this._addTileStorage(e,new Set(n.map(e=>e.objectId)),r),i&&this._applyCacheMemoryLimits()}_applyCacheMemoryLimits(){if(!this._memoryLimitExceeded)return;let{_tiles:e,featureStore:t,maximumByteSize:n}=this;e.someFromLowestToHighestPriority(e=>!this._memoryLimitExceeded||t.usedMemory-this._estimateRemoveTileMemoryReduction(e)<n||(this._removeTileStorage(e),!1))}_estimateRemoveTileMemoryReduction(e){let t=0;for(let n of e.objectIds)if(this._refCounts.get(n)===1){let e=this.featureStore.getFeature(n);e&&(t+=this.featureStore.estimateFeatureUsedMemory?.(e)??0)}return t}_hasAttributesForTile(e,t){if(e){let n=this._tiles.get(e);if(n)return!n.objectIds.size||c(t,n.attributeKeys)}return!1}getAttributesForTile(e){return e?this._tiles.get(e)?.attributeKeys:null}destroy(){this.clear(),this._tileFeatureCounts.clear()}clear(){this.featureStore.clear(),this._tileBounds.clear(),this._tiles.clear(),this._refCounts.clear()}refresh(){this.clear(),this._tileFeatureCounts.clear()}processEdits(e,t,n){return this._processEditsDelete(e.deletedFeatures.concat(e.updatedFeatures)),this._processEditsRefetch(e.addedFeatures.concat(e.updatedFeatures),t,n)}_addTileStorage(e,t,n){let r=e.id;this._tiles.set(r,new Ne(e,t,n)),this._tileBounds.set(r,e.extent),this._tileFeatureCounts.set(r,t.size)}_remove({id:e}){let t=this._tiles.get(e);t&&this._removeTileStorage(t)}_removeTileStorage(e){let t=[];for(let n of e.objectIds)this._unreferenceFeature(n)===1&&t.push(n);this.featureStore.removeManyById(t);let n=e.key.id;this._tiles.delete(n),this._tileBounds.delete(n)}_processEditsDelete(e){this.featureStore.removeManyById(e);for(let t of this._tiles.values()){for(let n of e)t.objectIds.delete(n);this._tileFeatureCounts.set(t.key.id,t.objectIds.size)}for(let t of e)this._refCounts.delete(t)}async _processEditsRefetch(e,t,n){if(!e.length)return;let{features:r}=await t(e,n);for(let e of r){if(this._tmpBoundingRect.fill(0),e.geometry==null||e.geometry.vertexCount===0)continue;ie(this._tmpBoundingRect);let t=P(e.geometry,this._tmpBoundingRect);this._tileBounds.forEachInBounds(t,t=>{let n=this._tiles.get(t);this.featureStore.add(e);let r=e.objectId;n.objectIds.has(r)||(n.objectIds.add(r),this._referenceFeature(r),this._tileFeatureCounts.set(n.key.id,n.objectIds.size))})}}process(e,t=()=>!0,n){if(this.tileInfo==null||!e.extent||this.extent!=null&&!m(v(this.extent,this._tmpBoundingRect),e.extent)||this._memoryLimitExceeded&&!this._tiles.hasLowerPriority(e.id??``)||this._hasAttributesForTile(e.id,n))return new Z(e);let r=this._createTileTree(e,this.tileInfo);return this._simplify(r,t,null,0,1),this._collectMissingTiles(e,r,this.tileInfo,n)}get debugInfo(){return Array.from(this._tiles.values()).map(({key:e})=>({key:e.toJSON(),featureCount:this._tileFeatureCounts.get(e.id)||0}))}getFeatureCount(e){return this._tileFeatureCounts.get(e.id)??0}async fetchCount(e,t,n,r){let i=this._tileFeatureCounts.get(e.id);return i??(i=await R(t,n,r),this._tileFeatureCounts.set(e.id,i)),i}_createTileTree(e,t){let n=new X(e.level,e.row,e.col);return t.updateTileInfo(n,1),this._tileBounds.forEachInBounds(e.extent,r=>{let i=this._tiles.get(r)?.key;i&&Me(e,i)&&this._populateChildren(n,i,t,this._tileFeatureCounts.get(i.id)||0)}),n}_populateChildren(e,t,n,r){let i=t.level-e.level-1;if(i<0)return void(e.isLeaf=!0);let a=t.row>>i,o=t.col>>i,s=e.row<<1,c=o-(e.col<<1)+(a-s<<1),l=e.children[c];if(l!=null)this._populateChildren(l,t,n,r);else{let i=new X(e.level+1,a,o);n.updateTileInfo(i,1),e.children[c]=i,this._populateChildren(i,t,n,r)}}_simplify(e,t,n,r,i){let a=i*i;if(e.isLeaf)return t(this.getFeatureCount(e),i)?0:(this._remove(e),n!=null&&(n.children[r]=null),a);let o=i/2,s=o*o,c=0;for(let n=0;n<e.children.length;n++){let r=e.children[n];c+=r==null?s:this._simplify(r,t,e,n,o)}return c===0?this._mergeChildren(e):1-c/a<Fe&&(this._purge(e),n!=null&&(n.children[r]=null),c=a),c}_mergeChildren(e){let t=new Set,n;this._forEachLeaf(e,e=>{let r=this._tiles.get(e.id);if(r){n=n?u(n,r.attributeKeys):new Set(r.attributeKeys);for(let e of r.objectIds)t.has(e)||(t.add(e),this._referenceFeature(e));this._remove(e)}}),this._addTileStorage(e,t,n??new Set),e.isLeaf=!0,e.children[0]=e.children[1]=e.children[2]=e.children[3]=null,this._tileFeatureCounts.set(e.id,t.size)}_forEachLeaf(e,t){for(let n of e.children)n!=null&&(n.isLeaf?t(n):this._forEachLeaf(n,t))}_purge(e){if(e!=null)if(e.isLeaf)this._remove(e);else for(let t=0;t<e.children.length;t++){let n=e.children[t];this._purge(n),e.children[t]=null}}_collectMissingTiles(e,t,n,r){let i=new Pe(n,e,this.extent);return this._collectMissingTilesRecurse(t,i,1,r),i.info}_collectMissingTilesRecurse(e,t,n,r){let i=this._tiles.has(e.id)&&!this._hasAttributesForTile(e.id,r);if(i&&t.addMissing(e.level,e.row,e.col,n),e.isLeaf)return;if(!e.hasChildren)return void(i||t.addMissing(e.level,e.row,e.col,n));let a=n/2;for(let n=0;n<e.children.length;n++){let i=e.children[n];i==null?t.addMissing(e.level+1,(e.row<<1)+((2&n)>>1),(e.col<<1)+(1&n),a):this._collectMissingTilesRecurse(i,t,a,r)}}_referenceFeature(e){let t=(this._refCounts.get(e)||0)+1;return this._refCounts.set(e,t),t===1?0:2}_unreferenceFeature(e){let t=(this._refCounts.get(e)||0)-1;return t===0?(this._refCounts.delete(e),1):(t>0&&this._refCounts.set(e,t),2)}get test(){}};function Me(e,t){if(!e||!t)return!1;if(e.level===t.level)return e.row===t.row&&e.col===t.col;let n=e.level<t.level,r=n?e:t,i=n?t:e,a=1<<i.level-r.level;return Math.floor(i.row/a)===r.row&&Math.floor(i.col/a)===r.col}b([i({constructOnly:!0})],Y.prototype,`featureStore`,void 0),b([i()],Y.prototype,`tileInfo`,void 0),b([i()],Y.prototype,`extent`,void 0),b([i()],Y.prototype,`maximumByteSize`,void 0),Y=b([p(`esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTileStore`)],Y);var Ne=class{constructor(e,t,n){this.key=e,this.objectIds=t,this.attributeKeys=n}},X=class extends y{constructor(){super(...arguments),this.isLeaf=!1,this.children=[null,null,null,null]}get hasChildren(){return!this.isLeaf&&(this.children[0]!=null||this.children[1]!=null||this.children[2]!=null||this.children[3]!=null)}},Z=class{constructor(e,t=[]){this.missingTiles=t,this.fullArea=0,this.coveredArea=0,this.fullArea=D(e.extent),this.coveredArea=this.fullArea}prepend(e){this.missingTiles=e.missingTiles.concat(this.missingTiles),this.coveredArea+=e.coveredArea,this.fullArea+=e.fullArea}},Pe=class{constructor(e,t,n){this._tileInfo=e,this._extent=null,this.info=new Z(t),n!=null&&(this._extent=v(n))}addMissing(e,t,n,r){let i=new y(e,t,n);this._tileInfo.updateTileInfo(i,1)&&(this._extent==null||m(this._extent,i.extent))&&(this.info.missingTiles.push({data:i,resolution:r}),this.info.coveredArea-=D(i.extent))}},Fe=.18751,Q=class extends fe{constructor(){super(...arguments),this._isInitializing=!0,this.remoteClient=null,this._whenSetup=te(),this._elevationAligner=H(),this._elevationFilter=V(),this._symbologyCandidatesFetcher=U(),this._updatingHandles=new O,this._alignPointsInFeatures=async(e,t)=>{let n={query:e},r=await this.remoteClient.invoke(`alignElevation`,n,{signal:t});return S(t),r},this._getSymbologyCandidates=async(e,t)=>{let n={candidates:e,spatialReference:this._spatialReference.toJSON()},r=await this.remoteClient.invoke(`getSymbologyCandidates`,n,{signal:t});return S(t),r}}get updating(){return this._isInitializing||this._updatingHandles.updating||this._featureFetcher.updating}destroy(){this._featureFetcher?.destroy(),this._queryEngine?.destroy(),this._featureStore?.clear()}async setup(e){if(this.destroyed)return{result:{}};let{geometryType:t,objectIdField:n,timeInfo:r,fieldsIndex:i}=e.serviceInfo,{hasZ:a}=e,o=l.fromJSON(e.spatialReference);this._spatialReference=o,this._featureStore=new xe(t,a,!1),this._featureStore.estimateFeatureUsedMemory=e=>e.usedMemory,this._queryEngine=new ve({spatialReference:e.spatialReference,featureStore:this._featureStore,geometryType:t,fieldsIndex:i,hasZ:a,hasM:!1,featureIdInfo:{type:`object-id`,fieldName:n},timeInfo:r}),this._featureFetcher=new q({store:new Y({featureStore:this._featureStore}),url:e.serviceInfo.url,objectIdField:e.serviceInfo.objectIdField,globalIdField:e.serviceInfo.globalIdField,capabilities:e.serviceInfo.capabilities,spatialReference:o,sourceSpatialReference:l.fromJSON(e.serviceInfo.spatialReference),customParameters:e.configuration.customParameters});let s=e.configuration.viewType===`3d`;return this._elevationAligner=H(s,{elevationInfo:e.elevationInfo==null?null:me.fromJSON(e.elevationInfo),alignPointsInFeatures:this._alignPointsInFeatures}),this._elevationFilter=V(s),this.addHandles([w(()=>this._featureFetcher.availability,e=>this.emit(`notify-availability`,{availability:e}),re),w(()=>this.updating,()=>this._notifyUpdating())]),this._whenSetup.resolve(),this._isInitializing=!1,this.configure(e.configuration)}async configure(e){return await this._updatingHandles.addPromise(this._whenSetup.promise),this._updateFeatureFetcherConfiguration(e),$}async setSuspended(e,t){return await this._updatingHandles.addPromise(this._whenSetup.promise),S(t),this._featureFetcher.suspended=e,$}async updateOutFields(e,t){return await this._updatingHandles.addPromise(this._whenSetup.promise),S(t),this._featureFetcher.outFields=new Set(e??[]),$}async fetchCandidates(e,t){await this._whenSetup.promise,S(t);let n=Le(e,this._featureStore.hasZ),r=t?.signal,i=await this._queryEngine.executeQueryForSnapping(n,r);S(r);let a=await this._elevationAligner.alignCandidates(i.candidates,l.fromJSON(e.point.spatialReference)??l.WGS84,r);S(r);let o=await this._symbologyCandidatesFetcher.fetch(a,r);S(r);let s=o.length===0?a:a.concat(o);return{result:{candidates:this._elevationFilter.filter(n,s)}}}async updateTiles(e,t){return await this._updatingHandles.addPromise(this._whenSetup.promise),S(t),this._featureFetcher.tileSize=e.tileSize,this._featureFetcher.tilesOfInterest=e.tiles.map(e=>y.fromJSON(e)),this._featureFetcher.tileInfo=e.tileInfo==null?null:n.fromJSON(e.tileInfo),$}async refresh(e,t){return await this._updatingHandles.addPromise(this._whenSetup.promise),S(t),this._featureFetcher.refresh(),$}async whenNotUpdating(e,t){return await this._updatingHandles.addPromise(this._whenSetup.promise),S(t),await ae(()=>!this.updating,t),S(t),$}async getDebugInfo(e,t){return S(t),{result:this._featureFetcher.debugInfo}}async handleEdits(e,t){return await this._updatingHandles.addPromise(this._whenSetup.promise),S(t),await this._updatingHandles.addPromise(this._featureFetcher.handleEdits(e)),S(t),$}async setHistoricMoment(e,t){return this._featureFetcher.setHistoricMoment(e.moment),$}async notifyElevationSourceChange(e,t){return this._elevationAligner.notifyElevationSourceChange(),$}async notifySymbologyChange(e,t){return this._symbologyCandidatesFetcher.notifySymbologyChange(),$}async setSymbologySnappingSupported(e){return this._symbologyCandidatesFetcher=U(e,this._getSymbologyCandidates),$}_updateFeatureFetcherConfiguration(e){this._featureFetcher.filter=e.filter==null?null:C.fromJSON(e.filter),this._featureFetcher.customParameters=e.customParameters}_notifyUpdating(){this.emit(`notify-updating`,{updating:this.updating})}};b([i({readOnly:!0})],Q.prototype,`updating`,null),b([i()],Q.prototype,`_isInitializing`,void 0),Q=b([p(`esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorker`)],Q);var Ie=Q;function Le(e,t){let n=!!t||void 0;if(!e.filter)return{...e,query:{where:`1=1`,returnZ:n}};let{distance:r,units:i,spatialRel:a,where:o,timeExtent:s,objectIds:c}=e.filter,l={geometry:e.filter.geometry?oe(e.filter.geometry):void 0,distance:r,units:i,spatialRel:a,timeExtent:s,objectIds:c,returnZ:n,where:o??`1=1`};return{...e,query:l}}var $={result:{}};export{Ie as default};