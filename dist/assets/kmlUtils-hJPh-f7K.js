import{H as e,Qf as t,RS as n,SE as r,_E as i,aC as a,af as o,bf as s,ha as c,if as l,lC as u,lf as d,ny as f,wx as p}from"./index-ByaFsVj4.js";var m={esriGeometryPoint:`points`,esriGeometryPolyline:`polylines`,esriGeometryPolygon:`polygons`};function h(e){let t=e.folders||[],n=t.slice(),i=new Map,a=new Map,o=new Map,s=new Map,c=new Map,l={esriGeometryPoint:a,esriGeometryPolyline:o,esriGeometryPolygon:s};(e.featureCollection?.layers||[]).forEach(e=>{let t=r(e);t.featureSet.features=[];let n=e.featureSet.geometryType;i.set(n,t);let c=e.layerDefinition.objectIdField;n===`esriGeometryPoint`?v(a,c,e.featureSet.features):n===`esriGeometryPolyline`?v(o,c,e.featureSet.features):n===`esriGeometryPolygon`&&v(s,c,e.featureSet.features)}),e.groundOverlays&&e.groundOverlays.forEach(e=>{c.set(e.id,e)}),t.forEach(t=>{t.networkLinkIds.forEach(r=>{let i=b(r,t.id,e.networkLinks);i&&n.push(i)})}),n.forEach(e=>{if(e.featureInfos){e.points=r(i.get(`esriGeometryPoint`)),e.polylines=r(i.get(`esriGeometryPolyline`)),e.polygons=r(i.get(`esriGeometryPolygon`)),e.mapImages=[];for(let t of e.featureInfos)switch(t.type){case`esriGeometryPoint`:case`esriGeometryPolyline`:case`esriGeometryPolygon`:{let n=l[t.type].get(t.id);n&&e[m[t.type]]?.featureSet.features.push(n);break}case`GroundOverlay`:{let n=c.get(t.id);n&&e.mapImages.push(n);break}}e.fullExtent=S([e])}});let u=S(n);return{folders:t,sublayers:n,extent:u}}function g(e,t,r,o){let s=a?.findCredential(e);e=u(e,{token:s?.token});let c=i.kmlServiceUrl;return n(c,{query:{url:e,model:`simple`,folders:``,refresh:r!==0||void 0,outSR:JSON.stringify(t)},responseType:`json`,signal:o})}function _(e,t,n=null,r=[]){let i=[],a={},o=t.sublayers,s=new Set(t.folders.map(e=>e.id));return o.forEach(t=>{let o=new e;if(n?o.read(t,n):o.read(t),r.length&&s.has(o.id)&&(o.visible=r.includes(o.id)),a[t.id]=o,t.parentFolderId!=null&&t.parentFolderId!==-1){let e=a[t.parentFolderId];e.sublayers||=[],e.sublayers?.unshift(o)}else i.unshift(o)}),i}function v(e,t,n){n.forEach(n=>{e.set(n.attributes[t],n)})}function y(e,t){let n;return t.some(t=>t.id===e&&(n=t,!0)),n}function b(e,t,n){let r=y(e,n);return r&&(r.parentFolderId=t,r.networkLink=r),r}async function x(n,r,i,a){let o=n[r];if(!o)return[];let s=c.fromJSON(o.featureSet).features,l=o.layerDefinition,u=e(l.drawingInfo.renderer),d=t.fromJSON(o.popupInfo),f=[];for(let e of s)e.symbol=await u.getSymbolAsync(e),e.popupTemplate=d,e.visible=!0,e.origin=i.sublayerById.get(a).origin,f.push(e);return f}function S(e){let t=s(d),n=s(d);for(let r of e){if(r.polygons?.featureSet?.features)for(let e of r.polygons.featureSet.features)f(t,e.geometry),o(n,t);if(r.polylines?.featureSet?.features)for(let e of r.polylines.featureSet.features)f(t,e.geometry),o(n,t);if(r.points?.featureSet?.features)for(let e of r.points.featureSet.features)f(t,e.geometry),o(n,t);if(r.mapImages)for(let e of r.mapImages)f(t,e.extent),o(n,t)}return l(n,d)?void 0:{xmin:n[0],ymin:n[1],zmin:n[2],xmax:n[3],ymax:n[4],zmax:n[5],spatialReference:p.WGS84}}export{g as a,h as i,_ as n,x as r,S as t};