import{$n as e,Eg as t,Fw as n,Gw as r,Hn as i,Jn as a,Jw as o,Nw as s,Pw as c,Qn as l,RS as u,SC as d,Vn as f,WT as p,YS as ee,aE as m,eT as h,eh as g,fC as _,pD as v,uE as y,wx as b}from"./index-ByaFsVj4.js";import"./quatf64-eO7UAs9K.js";import"./quat-sUyQdiZR.js";import"./axisAngleDegrees-jawZYrHR.js";import"./MeshTransform-DDT-1d0m.js";import{a as x,c as S,n as C,r as w,t as T}from"./External-5UklRB0N.js";import{c as E,d as D,f as O,i as te,l as k,n as A,o as j,r as M,t as ne,u as re}from"./meshSpatialReferenceScaleUtils--Vbn6Pid.js";import{n as ie,t as ae}from"./meshFeatureAttributes-vo4Bry8B.js";var N={upload:{createFromFiles:.8,loadMesh:.2},uploadAssetBlobs:{prepareAssetItems:.9,uploadAssetItems:.1},uploadConvertibleSource:{uploadEditSource:.5,serviceAssetsToGlb:.5},uploadLocalMesh:{meshToAssetBlob:.5,uploadAssetBlobs:.5}};function P(e,t=e=>{},n){return new F(e,t,n)}var F=class{constructor(e,t=e=>{},n){if(this.onProgress=t,this.taskName=n,this._progressMap=new Map,this._startTime=void 0,this._timingsMap=new Map,typeof e==`number`){this._weights={};for(let t=0;t<e;t++){let n=t,r=1/e;this._weights[n]=r,this._progressMap.set(n,0)}}else this._weights=e;this.emitProgress()}emitProgress(){let e=0;for(let[t,n]of this._progressMap.entries())e+=n*this._weights[t];if(e===1&&v(`enable-feature:esri-3dofl-upload-timings`)){let e=Math.round(performance.now()-(this._startTime??0))/1e3;console.log(`${this.taskName} done in ${e} sec`);for(let[t,n]of this._timingsMap){let r=Math.round(n.end-n.start)/1e3,i=Math.round(r/e*100);console.log(this.taskName??`Task`,{stepKey:t,stepTime:r,relativeTime:i})}}this.onProgress(e)}setProgress(e,t){if(this._progressMap.set(e,t),v(`enable-feature:esri-3dofl-upload-timings`)){let n=performance.now();this._startTime??=n;let r=m(this._timingsMap,e,()=>({start:n,end:0}));t===1&&(r.end=n)}this.emitProgress()}simulate(e,t){return I(t=>this.setProgress(e,t),t)}makeOnProgress(e){return t=>this.setProgress(e,t)}};function I(e=e=>{},t=U){let n=performance.now();e(0);let r=setInterval(()=>{let r=performance.now()-n,i=1-Math.exp(-r/t);e(i)},H);return p(()=>{clearInterval(r),e(1)})}function L(e,t=z){return c(n(e*V/t))}function R(e,t=B){return c(n(e*V/t))}var z=10,B=10,V=8e-6,H=s(50),U=s(1e3),W=1e6,G=20*W,K=2e9,q=3;async function J({data:e,name:t,description:n},r,i){let a=null;try{let o=d(r,`uploads`),s=d(o,`info`),{data:c}=await u(s,{query:{f:`json`},responseType:`json`});h(i);let l=ee(r),f=c.maxUploadFileSize*W,p=l?K:f,m=l?Math.min(G,f):G;if(e.size>p)throw Error(`Data too large`);let g=d(o,`register`),{data:_}=await u(g,{query:{f:`json`,itemName:oe(t),description:n},responseType:`json`,method:`post`});if(h(i),!_.success)throw Error(`Registration failed`);let{itemID:v}=_.item;a=d(o,v);let y=d(a,`uploadPart`),b=Math.ceil(e.size/m),x=[];for(let t=0;t<b;++t)x.push(e.slice(t*m,Math.min((t+1)*m,e.size)));let S=x.slice().reverse(),C=[],w=P(b,i?.onProgress,`uploadItem`),T=async()=>{for(;S.length!==0;){let e=x.length-S.length,t=S.pop(),n=new FormData,r=w.simulate(e,L(t.size));try{n.append(`f`,`json`),n.append(`file`,t),n.append(`partId`,`${e}`);let{data:r}=await u(y,{timeout:0,body:n,responseType:`json`,method:`post`});if(h(i),!r.success)throw Error(`Part upload failed`)}finally{r.remove()}}};for(let e=0;e<q&&S.length!==0;++e)C.push(T());await Promise.all(C);let E=d(a,`commit`),{data:D}=await u(E,{query:{f:`json`,parts:x.map((e,t)=>t).join(`,`)},responseType:`json`,method:`post`});if(h(i),!D.success)throw Error(`Commit failed`);return D.item}catch(e){if(a!=null){let e=d(a,`delete`);await u(e,{query:{f:`json`},responseType:`json`,method:`post`})}throw e}}function oe(e){return e.replaceAll(`/`,`_`).replaceAll(`\\`,`_`)}async function se(e,t,n){let r=e.length;if(!r)return n?.onProgress?.(1),[];let i=P(r,n?.onProgress,`uploadAssets`);return Promise.all(e.map((e,r)=>ce(e,t,{...n,onProgress:i.makeOnProgress(r)})))}async function ce(e,{layer:t,ongoingUploads:n},r){let i=n.get(e);if(i)return i;if(!Te(t))throw new re;if(le(e,t))return r?.onProgress?.(1),{mesh:e};let a=ue(e,t,r);n.set(e,a);try{return await a}finally{n.delete(e)}}function le(e,t){let{parsedUrl:n}=t;return n!=null&&e.metadata.externalSources.some(e=>C(e,n))}async function ue(e,t,n){let{metadata:r}=e,{displaySource:i}=r,a=Y(i?.source,t,{checkForConversionRequired:!0}),o=a==null?r.externalSources.length>0?fe(e,t,n):pe(e,t,n):de(e,a,t,n),{external:s,info:c}=await o;return h(n),e.addExternalSources([s]),c}async function de(e,t,n,r){return{external:{source:{type:`service`,assets:await X(t,n,r)},original:!0,unitConversionDisabled:!0},info:{mesh:e}}}async function fe(e,n,r){let i=$(n),{externalSources:a}=e.metadata,o=he(a,n);if(!o)throw new E;let s=P(N.uploadConvertibleSource,r?.onProgress,`uploadConvertibleSource`),c={type:`service`,assets:await X(o,n,{onProgress:s.makeOnProgress(`uploadEditSource`)})};e.addExternalSources([{source:c,original:!0}]);let l=o.reduce((e,{asset:t})=>t instanceof File?e+t.size:e,0),u=s.simulate(`serviceAssetsToGlb`,R(l));try{let{source:a,transform:o,origin:s}=await Se(c,n,i);if(e.transform=o,s&&r?.useAssetOrigin){let n=await t(s,e.spatialReference,r);e.vertexSpace.origin=[n.x,n.y,n.z??0]}return{external:{source:a,unitConversionDisabled:!0},info:{mesh:e,georeferenceInfo:s?{origin:s}:void 0}}}finally{u.remove()}}async function pe(e,t,n){let r=P(N.uploadLocalMesh,n?.onProgress,`uploadLocalMesh`),i=me(e,t,{...n,onProgress:r.makeOnProgress(`meshToAssetBlob`)});return{external:{source:{type:`service`,assets:await Z([i],t,{...n,onProgress:r.makeOnProgress(`uploadAssetBlobs`)})},extent:e.extent.clone(),original:!0},info:{mesh:e}}}async function me(e,t,n){let r=$(t),i=await e.load(n),a=await i.toBinaryGLTF({origin:i.origin,signal:n?.signal,ignoreLocalTransform:!0,unitConversionDisabled:!0});return h(n),{blob:new Blob([a],{type:`model/gltf-binary`}),assetName:`${g()}.glb`,assetType:r}}function he(e,t){for(let n of e){let e=Y(n.source,t);if(e)return e}return null}function Y(e,{infoFor3D:t},n={}){if(!e)return null;let r=T(e);if(!r)return null;let{supportedFormats:i,editFormats:o}=t,s=[],c=f(t),l=a(t),u=!1;for(let e of r){let t=ge(e,i);if(!t)return null;let{assetType:r}=t;if(n.checkForConversionRequired&&(r===c||r===l))return null;o.includes(r)&&(u=!0),s.push(t)}return u?s:null}function ge(e,t){let n=S(e,t);return n?{asset:e,assetType:n}:null}async function X(e,t,n){return Z(e.map(e=>_e(e,n)),t,n)}async function Z(e,t,n){let r=P(N.uploadAssetBlobs,n?.onProgress,`uploadAssetBlobs`),i=await ye(e,t,{...n,onProgress:r.makeOnProgress(`prepareAssetItems`)});h(n);let a=i.map(({item:e})=>e),{uploadResults:o}=await be(a,t,{...n,onProgress:r.makeOnProgress(`uploadAssetItems`)});return h(n),e.map((e,n)=>xe(i[n],o[n],t))}async function _e(e,t){let{asset:n,assetType:r}=e;if(n instanceof File)return{blob:n,assetName:n.name,assetType:r};let i=await n.toBlob(t);return h(t),{blob:i,assetName:n.assetName,assetType:r}}async function ve(e,t,n){let{blob:r,assetType:i,assetName:a}=e,s=null;try{let e=await J({data:r,name:a},t.url,n);h(n),s={assetType:i,assetUploadId:e.itemID}}catch(e){o(e),Ee().warnOnce(`Service ${t.url} does not support the REST Uploads API.`)}if(!s){let e=await _(r);if(h(n),!e.isBase64)throw new O;s={assetType:i,assetData:e.data}}if(!s)throw new k;return{item:s,assetName:a}}function ye(e,t,n){let r=P(e.length,n?.onProgress,`prepareAssetItems`);return Promise.all(e.map(async(e,i)=>{let a=ve(await e,t,{...n,onProgress:r.makeOnProgress(i)});return h(n),a}))}async function be(e,t,n){let r=I(n?.onProgress);try{let r=await u(d(t.parsedUrl.path,`uploadAssets`),{timeout:0,query:{f:`json`,assets:JSON.stringify(e)},method:`post`,responseType:`json`});if(h(n),r.data.uploadResults.length!==e.length)throw new A(e.length,r.data.uploadResults.length);return r.data}finally{r.remove()}}function xe(e,t,n){let{success:r}=t;if(!r){let{error:n}=t;throw new te(e.assetName,n)}let{assetHash:i}=t,{assetName:a,item:{assetType:o}}=e,{infoFor3D:{supportedFormats:s}}=n,c=l(o,s);if(!c)throw new M(o);return new w(a,c,[new x(`${n.parsedUrl.path}/assets/${i}`,i)])}async function Se({assets:e},t,n){let r=e.map(({assetName:e,parts:t})=>({assetName:e,assetHash:t[0].partHash})),i;try{let e=d(t.parsedUrl.path,`convert3D`),a=t.capabilities?.operations.supportsAsyncConvert3D;i=(await(a?we:Ce)(e,{query:{f:`json`,assets:JSON.stringify(r),transportType:`esriTransportTypeUrl`,targetFormat:n,async:a},responseType:`json`,timeout:0})).data}catch{throw new j}return Q(t,i)}function Q(t,n){let r={source:{type:`service`,assets:n.assets.map(n=>{let r=e(n.contentType,t.infoFor3D.supportedFormats);if(!r)throw new M(r);return new w(n.assetName,n.contentType,[new x(n.assetURL,n.assetHash)])})},origin:void 0,transform:void 0};if(n.transform){if(r.transform=ae(n.transform),n.spatialReference){let e=b.fromJSON(n.spatialReference);r.origin=ie(n.transform,e)}}else r.transform=ne(t.spatialReference);return r}function Ce(e,t){return u(e,t)}async function we(e,t){let n=(await u(e,t)).data.statusUrl;for(;;){let e=(await u(n,{query:{f:`json`},responseType:`json`})).data;switch(e.status){case`Completed`:return u(e.resultUrl,{query:{f:`json`},responseType:`json`});case`CompletedWithErrors`:throw Error(e.status);case`Failed ImportChanges`:case`InProgress`:case`Pending`:case`ExportAttachments`:case`ExportChanges`:case`ExportingData`:case`ExportingSnapshot`:case`ImportAttachments`:case`ProvisioningReplica`:case`UnRegisteringReplica`:break;default:throw Error()}await r(De)}}function Te(e){return!!e.infoFor3D&&!!e.url}function $({infoFor3D:e}){let t=i(e);if(!t)throw new D;return t}function Ee(){return y.getLogger(`esri.layers.graphics.sources.support.uploadAssets`)}var De=s(1e3);export{se as uploadAssets};