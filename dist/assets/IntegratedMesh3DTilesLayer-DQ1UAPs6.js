import{$S as e,A as t,BT as n,DT as r,Dh as i,Ha as a,Ih as o,Jw as s,L as c,Li as l,M as u,OT as d,Ph as f,Q_ as p,RS as m,Z_ as h,ax as g,ca as _,gD as v,jT as y,ji as b,ma as x,pD as S,pa as C,qm as w,uE as T,wx as E}from"./index-ByaFsVj4.js";import{o as D,p as O,y as k}from"./elevationInfoUtils-CyQsBf6_.js";import{t as A}from"./tiles3DUtils-WqAc9Y2T.js";import{t as j}from"./SceneModifications-LoJwZXk2.js";var M=class extends C(c(u(t(a(_(x(i))))))){readModifications(t,n,r){this._modificationsSource={url:e(t,r),context:r}}initialize(){this.addHandles(p(()=>this.modifications,`after-changes`,()=>this.modifications=this.modifications,h))}constructor(e){super(e),this.operationalLayerType=`IntegratedMesh3DTilesLayer`,this.modifications=null,this._modificationsSource=null,this.spatialReference=new E({wkid:4326,vcsWkid:115700}),this.fullExtent=new g(-180,-90,180,90,this.spatialReference),this.url=null,this.type=`integrated-mesh-3dtiles`,this.path=null,this.minScale=0,this.maxScale=0,this._rootTilesetJSON=null,this._rootTileset=null,this._key=null,this._session=null,this._rootRequestPromise=null}set elevationInfo(e){e!=null&&e.mode!==`absolute-height`||this._set(`elevationInfo`,e),this._validateElevationInfo(e)}async load(e){return this.addResolvingPromise(this._doLoad(e)),this}get rootTilesetJSON(){return this._rootTilesetJSON}get rootTileset(){return this._rootTileset}get key(){return this._key}get session(){return this._session}_findSessionParameter(e){let t=[e];for(;t?.length>0;){let e=t.pop();if(!e)return;for(let[n,r]of Object.entries(e)){if(n===`uri`)try{let e=new URL(`https://tmp`+r).searchParams.get(`session`);if(e)return e}catch{}typeof r==`object`&&r&&t.push(r)}}return null}async requestRootAndSession(e){let t=(e,t)=>new n(`3dtiles-init:`+e,t);return this._rootRequestPromise||=new Promise((n,r)=>{this.url||r(t(`url-missing`,`Layer url missing`)),this._key=this.customParameters?this.customParameters.key:null,new Promise((e,n)=>{if(this.replacesTerrain&&!this._key){let r=this.portalItem?.portal||this.parent?.portalItem?.portal||o.getDefault();r.signIn().then(()=>{r.g3dTilesEnabled?m(r.restUrl+`/portals/self/modules/g3dtiles`,{responseType:`json`,query:{f:`json`}}).then(t=>{this._key=t.data.keyString,e()},()=>n(t(`g3dtiles-key-error`,`Error fetching Google 3D Tiles key from portal`))):n(t(`g3dTilesEnabled-false`,`Google 3D Tiles are not enabled on Portal `+r.url))},()=>n(t(`sign-in-failed`,`Error signing in to Portal`)))}else e()}).then(()=>{m(this.url,{query:this._key?{key:this._key,token:this.apiKey}:{token:this.apiKey},responseType:`array-buffer`,signal:e}).then(e=>{try{this._rootTilesetJSON=JSON.parse(new TextDecoder().decode(e.data))}catch(e){r(t(`root-parse-failed`,`Error parsing root tile, details: `+e));return}this._rootTilesetJSON?(this._session=this._findSessionParameter(this._rootTilesetJSON),this._rootTileset=e.data,this.fullExtent=A(this._rootTilesetJSON),n(),this._rootRequestPromise=null):r(t(`root-is-null`,`Root tile is null.`))},e=>{s(e),r(t(`root-load-failed`,`Error loading root tile`)),this._rootRequestPromise=null,T.getLogger(`IntegratedMesh3DTilesLayer`).error(`Layer loading failed`,e)})},e=>r(e))}),this._rootRequestPromise}async _doLoad(e){let t=e==null?null:e.signal;if(this.isUsedAsGroundLayer&&!S(`enable-feature:basemap-groundlayers`))throw new n(`3dtiles-init:not-supported-in-groundlayers`,`Layer is not supported in basemap.`);try{await this.loadFromPortal({supportedTypes:[`3DTiles Service`],validateItem:e=>{if(e.typeKeywords?.includes(`IntegratedMesh`))return!0;throw new n(`portal:invalid-layer-item-type`,"Invalid layer item, expected '${expectedType}' ",{expectedType:`3DTiles Service containing IntegratedMesh`})}},e)}catch(e){s(e)}if(this._modificationsSource!=null){let t=await j.fromUrl(this._modificationsSource.url,this.spatialReference,e);this.setAtOrigin(`modifications`,t,this._modificationsSource.context.origin),this._modificationsSource=null}await this.requestRootAndSession(t)}beforeSave(){if(this._modificationsSource!=null)return this.load().then(()=>{},()=>{})}get hasAttributionData(){return!1}_validateElevationInfo(e){let t=`Integrated mesh 3d tiles layers`;O(T.getLogger(this),k(t,`absolute-height`,e)),O(T.getLogger(this),D(t,e))}get replacesTerrain(){return!!S(`enable-feature:basemap-groundlayers`)&&this.hasGoogleUrl&&this.isUsedAsGroundLayer}get isUsedAsGroundLayer(){return f(this.parent)}get hasGoogleUrl(){return!!this.url?.match(/.+\.googleapis.com/)}};v([r({type:[`IntegratedMesh3DTilesLayer`]})],M.prototype,`operationalLayerType`,void 0),v([r({type:j,clonable:e=>e.clone()}),w({origins:[`web-scene`,`portal-item`],type:`resource`,prefix:`modifications`})],M.prototype,`modifications`,void 0),v([y([`web-scene`,`portal-item`],`modifications`)],M.prototype,`readModifications`,null),v([r({type:E})],M.prototype,`spatialReference`,void 0),v([r({type:g})],M.prototype,`fullExtent`,void 0),v([r(b)],M.prototype,`elevationInfo`,null),v([r({type:[`show`,`hide`]})],M.prototype,`listMode`,void 0),v([r(l)],M.prototype,`url`,void 0),v([r({readOnly:!0})],M.prototype,`type`,void 0),v([r({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],M.prototype,`path`,void 0),v([r({type:Number,json:{name:`layerDefinition.minScale`,write:!0,origins:{service:{read:!1,write:!1}}}})],M.prototype,`minScale`,void 0),v([r({type:Number,json:{name:`layerDefinition.maxScale`,write:!0,origins:{service:{read:!1,write:!1}}}})],M.prototype,`maxScale`,void 0),v([r({readOnly:!0})],M.prototype,`hasAttributionData`,null),v([r()],M.prototype,`replacesTerrain`,null),v([r()],M.prototype,`isUsedAsGroundLayer`,null),v([r()],M.prototype,`hasGoogleUrl`,null),M=v([d(`esri.layers.IntegratedMesh3DTilesLayer`)],M);var N=M;export{N as default};