import{$_ as e,DT as t,Dd as n,Fg as r,Nu as i,OT as a,Od as o,aT as s,eg as c,ev as l,gD as u,gT as d,gs as f,jd as p,kv as m,nv as h,px as g,rh as _,vT as v,vd as y,vs as b,wd as x,yT as S}from"./index-ByaFsVj4.js";import"./memoryEstimations-C5pKF3kD.js";import"./OptimizedGeometry-DX91by73.js";import"./OptimizedFeatureSet-DAaREXtE.js";import"./featureConversionUtils-C045qQF5.js";import"./streamLayerUtils-82UmlW-3.js";import"./QueueProcessor-B2D2Jh6F.js";import"./earcut-CsNwSYFA.js";import"./layerViewUtils--V83RFAv.js";import"./colorUtils-BunzVBdd.js";import{t as C}from"./cimSymbolUtils-CFPGcy5T.js";import"./utils-CTZ6h8kz.js";import{t as w}from"./GraphicsLayer-DwoVChbR.js";import"./timeSupport-BE8MSrm_.js";import"./queryUtils-DJQEBA7c.js";import"./quantizationUtils-CzrQVcZ1.js";import{t as T}from"./ControlPoint-BrlOE2tm.js";import"./normalizeUtilsSync-BT8jCZxT.js";import"./GeometryUtils-BAHLKUGl.js";import"./VertexAttributeLocations-BMy2FGBT.js";import"./VertexElementDescriptor-C9CNG143.js";import{c as E,p as D}from"./videoUtils-BSKER4Ia.js";import"./labelPoint-DoaytHlZ.js";import"./callExpressionWithCursor-Bq5gauaR.js";import"./FeatureMetadata-L_8PG9_P.js";import"./CIMSymbolHelper-CZHBBcY6.js";import"./rasterizingUtils-LzhctegF.js";import"./Rect-BMNJQxpm.js";import"./BoundingBox-ClylkApr.js";import"./BidiEngine-CpIovbIK.js";import"./callExpressionWithFeature-DYNi0_LX.js";import"./OverrideHelper-xKJ6WRO1.js";import"./FeatureCommandQueue-BbpRY2Wt.js";import"./config-BY05DP3l.js";import"./dehydratedFeatureComparison-S5E2zKzh.js";import"./WGLContainer-CiXk9por.js";import"./utils-Dm-H4TMy.js";import"./ProgramTemplate-DWR5_pn_.js";import"./VertexArrayObject-IhETPpMJ.js";import"./BufferObject-DWz5bVRd.js";import"./VertexBuffer-BwGrH3vw.js";import"./vec3f32-BWuLbfSR.js";import{r as O}from"./Container-S9H9uxgl.js";import"./GraphShaderModule-VKGmZBI7.js";import"./FramebufferObject-D2tOc-fp.js";import"./ShaderBuilder-NkkCCxyc.js";import{n as k,t as A}from"./LayerView2D-CV9r4nac.js";import{t as j}from"./LayerView-yVmpY809.js";import"./UpdateTracking2D-VGFir_CJ.js";import"./TechniqueInstance-xWE1qGx4.js";import"./TileContainer-Jj89hEGy.js";import"./constants-TfCITEY_.js";import"./utils-CXmRmFbM.js";import"./AGraphicContainer-CjdmKveK.js";import{t as M}from"./GraphicContainer-Brizha6m.js";import"./ComputedAttributeStorage-BSjVwTFB.js";import{t as N}from"./GraphicsView2D-B7tBTM9T.js";import"./dehydratedFeatures-C-2nu7sF.js";import"./utils-Bb-KLMVN.js";import{t as P}from"./OverlayContainer-BVkqKdc_.js";var F=2,I=class extends O{constructor(t){super(),this.element=t,this._handles=new S,this.isWrapAround=!1,this.perspectiveTransform=i(),this.wrapAroundShift=0,this.clipGeometry=null,this._handles.add(e(()=>this.element,()=>{let e=this.element;this.ready(),e&&this._handles.add(s(e,`play`,()=>this.requestRender()))},l))}getMesh(e){throw Error(`Method not implemented.`)}destroy(){super.destroy(),this._handles.destroy(),this.texture=d(this.texture)}get textureSize(){if(!this.texture)return[1,1];let e=this.texture.descriptor;return[e.width,e.height]}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){let t=this.element;if(t==null)return;let{context:n}=e,{videoWidth:r,videoHeight:i}=t;if(r!==0&&i!==0){if(this.texture)t.paused||e.animationsEnabled&&this.texture.setData(t);else{let e=new b(r,i);e.wrapMode=33071,e.preMultiplyAlpha=!0,this.texture=new f(n,e,t)}t.paused||this.texture.generateMipmap(),super.beforeRender(e)}}_createTransforms(){return null}updateDrawCoords(e,t,n,i){let a=this.element,o=this._getFrameInfo();if(!a||!o)return;let{spatialReference:s}=n;this._initializeData(e,o,s);let{controlPoints:c,horizon:l}=o,u=Math.sqrt(c.length),d=u,{x:f,y:p}=e,h=this._vertices,g=c[0],_=c[u-1],v=c[(d-1)*u],y=c[(d-1)*u+u-1],b=r(l?l[0].mapPoint:g.mapPoint,s),x=r(l?l[1].mapPoint:_.mapPoint,s),S=r(v.mapPoint,s),C=r(y.mapPoint,s);this.clipGeometry=l?new k({geometry:m.fromJSON({rings:[[[S.x,S.y],[C.x,C.y],[x.x,x.y],[b.x,b.y],[S.x,S.y]]],spatialReference:s})}):null;for(let e=0;e<c.length;e++){let t=c[e],{sourcePoint:n,mapPoint:i}=t;if(n==null||i==null)continue;let a=r(i,s);h[e*F+0]=a.x-f,h[e*F+1]=a.y-p}let w=t;if(i){let e=Math.min(b.x,x.x,S.x,C.x),t=Math.max(b.x,x.x,S.x,C.x),{worldWidth:n,xBounds:r}=i,[a,o]=r;e<a&&t>a?w=n:t>o&&e<o&&(w=-n)}this.wrapAroundShift=w,this.isWrapAround=w!==0}draw(e,t){if(this.visible){if(!(this.isReady&&this._vertices&&this._indices&&this._texCoords))return void this.requestRender();this.stage||console.warn(`OverlayMultipoint: stage is null`),t.render(e,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:this.textureSize,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._texCoords,index:this._indices})}}_initializeData(e,t,n){if(this._vertices!=null&&this._indices!=null)return;let{controlPoints:i}=t,a=Math.sqrt(i.length),o=a,s=new Float32Array(F*i.length),c=new Uint16Array(2*i.length);for(let t=0;t<i.length;t++){let a=i[t],{sourcePoint:o,mapPoint:l}=a;if(o==null||l==null)continue;let u=r(l,n);s[t*F+0]=u.x-e.x,s[t*F+1]=u.y-e.y,c[2*t+0]=o.x,c[2*t+1]=o.y}let l=new Uint16Array(o*a+(o-2)*(a+2)),u=0;for(let e=0;e<o;e++){for(let t=0;t<a;t++)l[u++]=e*a+t,l[u++]=(e+1)*a+t;e<o-2&&(l[u++]=(e+1)*a+(a-1),l[u++]=(e+1)*a)}this._vertices=s,this._texCoords=c,this._indices=l}_getFrameInfo(){if(!this.groundControlPoints)return null;let e=this._getFrameControlPoints(),t=this.frameHorizonPoints,n=null;if(t){let e=t.startX,r=t.startY,i=t.endX,a=t.endY;n=[new T({sourcePoint:c(e,r),mapPoint:new g(t.startLongitude,t.startLatitude)}),new T({sourcePoint:c(i,a),mapPoint:new g(t.endLongitude,t.endLatitude)})]}return{controlPoints:e,horizon:n}}_getFrameControlPoints(){let e=this.groundControlPoints,t=e?.length;if(!t)return[];let n=Array(t),r=Math.max(...e.map(({x:e})=>e)),i=this.element.videoWidth/r;for(let r=0;r<t;r++){let{x:t,y:a,lat:o,lon:s}=e[r];n[r]=new T({sourcePoint:c(t*i,-a*i),mapPoint:new g(s,o)})}return n}},L=new _([255,127,0]),R=10005,z=10018,B=class extends A(j){constructor(){super(...arguments),this._graphicsLayer=new w,this._frameOutlineGraphic=new y({symbol:new o({outline:{type:`simple-line`,color:L}})}),this._frameCenterGraphic=new y({symbol:new n({color:L,style:`cross`})}),this._sensorTrailGraphic=new y({symbol:new p({color:L})}),this._sensorSightlineGraphic=new y({symbol:new p({color:L})}),this._sensorLocationGraphic=new y({symbol:new n({color:L})}),this._overlayContainer=null,this._sensorLocationSymbolType=null,this.layer=null,this.sensorLocationSymbol=null,this.symbolAngle=0,this.visibleTelemetryElements=null}destroy(){this._graphicsLayer=v(this._graphicsLayer)}initialize(){this._sensorLocationSymbolType=this.layer?.sensorSymbol.type,this._graphicsLayer.graphics.addMany([this._frameCenterGraphic,this._frameOutlineGraphic,this._sensorLocationGraphic,this._sensorSightlineGraphic,this._sensorTrailGraphic]),this.visibleTelemetryElements=new D({frame:this.layer.telemetryDisplay?.frame??!1,frameCenter:this.layer.telemetryDisplay?.frameCenter??!0,frameOutline:this.layer.telemetryDisplay?.frameOutline??!0,lineOfSight:this.layer.telemetryDisplay?.lineOfSight??!0,sensorLocation:this.layer.telemetryDisplay?.sensorLocation??!0,sensorTrail:this.layer.telemetryDisplay?.sensorTrail??!0})}attach(){this._overlayContainer=new P,this.container.addChild(this._overlayContainer),this._addOverlayMultipoint(),this.graphicsView=new N({requestUpdateCallback:()=>this.requestUpdate(),view:this.view,graphics:this._graphicsLayer.graphics,container:new M(this.view.featuresTilingScheme)}),this.container.addChild(this.graphicsView.container),this.addAttachHandles(this._graphicsLayer.on(`graphic-update`,this.graphicsView.graphicUpdateHandler)),this.addAttachHandles([h(()=>[this.layer.telemetryDisplay?.frame,this.layer.telemetryDisplay?.frameCenter,this.layer.telemetryDisplay?.frameOutline,this.layer.telemetryDisplay?.sensorLocation,this.layer.telemetryDisplay?.sensorTrail,this.layer.telemetryDisplay?.lineOfSight],()=>this._updateVisibleTelemetryElements(),l),h(()=>[this.layer.telemetry,this.visibleTelemetryElements?.frameCenter,this.visibleTelemetryElements?.frameOutline,this.visibleTelemetryElements?.sensorLocation,this.visibleTelemetryElements?.sensorTrail,this.visibleTelemetryElements?.lineOfSight],()=>this._updateGraphicGeometries(),l),h(()=>this.layer.metadata,()=>this._updateSensorLocationSymbolAngle(),l),h(()=>this.layer?.frameCenterSymbol,()=>this._updateFrameCenterSymbol(),l),h(()=>this.layer?.frameOutlineSymbol,()=>this._updateFrameOutlineSymbol(),l),h(()=>this.layer?.sensorSightLineSymbol,()=>this._updateSensorSightlineSymbol(),l),h(()=>this.layer?.sensorSymbol,()=>this._updateSensorLocationSymbol(),l),h(()=>this.layer?.sensorTrailSymbol,()=>this._updateSensorTrailSymbol(),l),h(()=>this.symbolAngle,()=>this._updateSensorLocationSymbol(),l)])}detach(){this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this.graphicsView=v(this.graphicsView)}supportsSpatialReference(e){return!0}moveEnd(){}viewChange(){this.graphicsView.viewChange()}update(e){this.graphicsView.processUpdate(e)}isUpdating(){return!this.graphicsView||this.graphicsView.updating}_updateVisibleTelemetryElements(){this.view.animationsEnabled&&this.visibleTelemetryElements&&this.layer.telemetryDisplay&&(this.visibleTelemetryElements.frame=this.layer.telemetryDisplay.frame,this.visibleTelemetryElements.frameCenter=this.layer.telemetryDisplay.frameCenter,this.visibleTelemetryElements.frameOutline=this.layer.telemetryDisplay.frameOutline,this.visibleTelemetryElements.lineOfSight=this.layer.telemetryDisplay.lineOfSight,this.visibleTelemetryElements.sensorLocation=this.layer.telemetryDisplay.sensorLocation,this.visibleTelemetryElements.sensorTrail=this.layer.telemetryDisplay.sensorTrail)}_updateGraphicGeometries(){if(!this.view.animationsEnabled)return;let{telemetry:e}=this.layer,{visibleTelemetryElements:t}=this;e&&t&&(t.frameOutline&&e.frameOutline?this._frameOutlineGraphic.geometry=this.layer.telemetry.frameOutline:this._frameOutlineGraphic.geometry=null,t.sensorTrail&&e.sensorTrail?this._sensorTrailGraphic.geometry=this.layer.telemetry.sensorTrail:this._sensorTrailGraphic.geometry=null,t.lineOfSight&&e.lineOfSight?this._sensorSightlineGraphic.geometry=this.layer.telemetry.lineOfSight:this._sensorSightlineGraphic.geometry=null,t.sensorLocation&&e.sensorLocation?this._sensorLocationGraphic.geometry=this.layer.telemetry.sensorLocation:this._sensorLocationGraphic.geometry=null,t.frameCenter&&e.frameCenter?this._frameCenterGraphic.geometry=this.layer.telemetry.frameCenter:this._frameCenterGraphic.geometry=null)}_updateSensorLocationSymbolAngle(){if(!this.view.animationsEnabled||!this.layer?.metadata?.size)return;let{source:e,symbolOffset:t=0}=this.layer.sensorSymbolOrientation||{};if(!e&&!t)return;let n=this.layer?.metadata?.get(R)?.value??0,r=this.layer?.metadata?.get(z)?.value??0,i=E({cameraAzimuth:r,platformHeading:n,source:this.layer.sensorSymbolOrientation?.source,symbolOffset:this.layer.sensorSymbolOrientation?.symbolOffset??0});this.symbolAngle=Math.round(Math.abs(i))}_updateSensorLocationSymbol(){switch(this._sensorLocationSymbolType){case`simple-marker`:this.sensorLocationSymbol=this.layer.sensorSymbol.clone(),this.sensorLocationSymbol.angle=this.symbolAngle,this._sensorLocationGraphic.symbol=this.sensorLocationSymbol.clone();break;case`picture-marker`:this.sensorLocationSymbol=this.layer.sensorSymbol,this.sensorLocationSymbol.angle=this.symbolAngle,this._sensorLocationGraphic.symbol=this.sensorLocationSymbol;break;case`cim`:this.sensorLocationSymbol=this.layer.sensorSymbol,C(this.sensorLocationSymbol,this.symbolAngle,!0),this._sensorLocationGraphic.symbol=this.sensorLocationSymbol}}_updateFrameCenterSymbol(){this.layer?.frameCenterSymbol&&(this._frameCenterGraphic.symbol=this.layer.frameCenterSymbol.clone())}_updateFrameOutlineSymbol(){this.layer?.frameOutlineSymbol&&(this._frameOutlineGraphic.symbol=this.layer.frameOutlineSymbol.clone())}_updateSensorSightlineSymbol(){this.layer?.sensorSightLineSymbol&&(this._sensorSightlineGraphic.symbol=this.layer.sensorSightLineSymbol.clone())}_updateSensorTrailSymbol(){this.layer?.sensorTrailSymbol&&(this._sensorTrailGraphic.symbol=this.layer.sensorTrailSymbol.clone())}async _addOverlayMultipoint(){if(!this.layer.videoElement)return;let e=new I(this.layer.videoElement);this.addAttachHandles([h(()=>[this.layer.frameHorizonPoints,this.layer.groundControlPoints,this.layer.frameOpacity,this.layer.telemetryDisplay?.frame],()=>{if(!this.view.animationsEnabled)return;let{visibleTelemetryElements:t}=this;e.frameHorizonPoints=this.layer.frameHorizonPoints,e.groundControlPoints=this.layer.groundControlPoints,e.opacity=this.layer.frameOpacity,e.visible=t?.frame??!1},l)]),this._overlayContainer.addChild(e),this.view.stage.requestRender()}};u([t()],B.prototype,`graphicsView`,void 0),u([t()],B.prototype,`layer`,void 0),u([t({types:x})],B.prototype,`sensorLocationSymbol`,void 0),u([t()],B.prototype,`symbolAngle`,void 0),u([t({type:D})],B.prototype,`visibleTelemetryElements`,void 0),B=u([a(`esri.views.2d.layers.VideoLayerView2D`)],B);var V=B;export{V as default};