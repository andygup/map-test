import{BT as e,Ex as t,HT as n,L as r,OT as i,Ow as a,Rh as o,Tw as s,UT as c,Ua as l,VT as u,eg as d,fE as f,hv as p,kD as m,mD as h,mv as g,ow as _,pv as v,qg as y,rw as b,tg as x,vx as S,ww as C}from"./index-BN8X5Ryz.js";import"./quatf64-D37SEdPg.js";import"./vectorStacks-Cuo89CNO.js";import{t as w}from"./Analysis-Cy3EfPty.js";import"./ObjectStack-l5kM7JZu.js";import"./ray-LkJ58wpZ.js";import"./HUDIntersectorResult-C5AENPbM.js";import"./Intersector-DL9RPLNy.js";import{n as T,t as E}from"./featureReferenceUtils-B5plW_k2.js";var D=class extends b(a){constructor(e){super(e),this.observer=null,this.farDistance=1e3,this.heading=0,this.tilt=90,this.horizontalFieldOfView=45,this.verticalFieldOfView=45,this.feature=null}get valid(){return this.observer!=null&&this.farDistance>0}equals(e){return i(this.observer,e.observer)&&this.farDistance===e.farDistance&&this.heading===e.heading&&this.tilt===e.tilt&&this.horizontalFieldOfView===e.horizontalFieldOfView&&this.verticalFieldOfView===e.verticalFieldOfView&&E(this.feature,e.feature)}};m([e({type:t,json:{write:{isRequired:!0}}})],D.prototype,`observer`,void 0),m([e({type:Number,nonNullable:!0,range:{min:0},json:{write:{isRequired:!0}}})],D.prototype,`farDistance`,void 0),m([e({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),n(e=>_.normalize(f(e),void 0,!0))],D.prototype,`heading`,void 0),m([e({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],D.prototype,`tilt`,void 0),m([e({type:Number,nonNullable:!0,range:{min:0,max:360},json:{write:{isRequired:!0}}})],D.prototype,`horizontalFieldOfView`,void 0),m([e({type:Number,nonNullable:!0,range:{min:0,max:180},json:{write:{isRequired:!0}}})],D.prototype,`verticalFieldOfView`,void 0),m([e(T)],D.prototype,`feature`,void 0),m([e({readOnly:!0,json:{read:!1}})],D.prototype,`valid`,null),D=m([u(`esri.analysis.Viewshed`)],D);var O=p.ofType(D),k=class extends w{constructor(e){super(e),this.type=`viewshed`,this._extent=null}initialize(){this.addHandles(v(()=>this._computeExtent(),e=>{e.pending??(this._extent=e.extent)},g))}get viewsheds(){return this._get(`viewsheds`)||new O}set viewsheds(e){this._set(`viewsheds`,x(e,this.viewsheds,O))}get spatialReference(){for(let e of this.viewsheds)if(e.observer!=null)return e.observer.spatialReference;return null}get extent(){return this._extent}get valid(){return this.viewsheds.every(e=>e.valid)}async waitComputeExtent(){let e=this._computeExtent();e.pending!=null&&await e.pending}_computeExtent(){let{spatialReference:e}=this;if(e==null)return{pending:null,extent:null};let t=this.viewsheds.filter(e=>e.observer!=null),n=t.map(e=>e.observer).toArray(),r=y(n,e);return r.pending==null?{pending:null,extent:r.geometries.map((e,n)=>{let r=t.at(n);return e!=null&&r!=null?this._computeViewshedExtent(this.viewsheds.at(n),e):null}).filter(e=>e!=null).reduce((e,t)=>A(e,t),null)}:{pending:r.pending,extent:null}}_computeViewshedExtent(e,t){let{farDistance:n,heading:r,tilt:i,horizontalFieldOfView:a,verticalFieldOfView:o}=e,{spatialReference:c}=t,l=a/2,u=o/2,d=n/c.metersPerUnit,f=[_.normalize(r-l),r,_.normalize(r+l)],p=S.fromPoint(t),m=e=>{let t=f.map(t=>_.normalize(t-e));if(t[0]>t[2]||a===360)return d;let n=t.map(e=>Math.abs(e>180?360-e:e)).reduce((e,t)=>e>t?t:e);return n>90?0:d*Math.cos(s(n))};p.xmax+=m(90),p.xmin-=m(-90),p.ymax+=m(0),p.ymin-=m(180);let h=t.z;if(h!=null){let e=h,t=h,r=i-90,a=C(r+u,-90,90),o=C(r-u,-90,90),s=c?.isGeographic?n:d;e+=s*M(a),t+=s*M(o);let f=j(u)*s,m=M(r)*f*(1-j(l));i<90&&(e-=m),i>90&&(t-=m),p.zmax=Math.max(e,h),p.zmin=Math.min(t,h)}return p}equals(e){return this===e||super.equals(e)&&h(this.viewsheds.toArray(),e.viewsheds.toArray(),(e,t)=>e.equals(t))}clear(){this.viewsheds.removeAll()}};function A(e,t){return e==null?t:t==null?e:e.union(t)}function j(e){return Math.cos(s(e))}function M(e){return Math.sin(s(e))}m([e({type:[`viewshed`]})],k.prototype,`type`,void 0),m([e({cast:d,type:O,nonNullable:!0})],k.prototype,`viewsheds`,null),m([e({readOnly:!0})],k.prototype,`spatialReference`,null),m([e()],k.prototype,`_extent`,void 0),m([e()],k.prototype,`extent`,null),m([e({readOnly:!0})],k.prototype,`valid`,null),k=m([u(`esri.analysis.ViewshedAnalysis`)],k);var N=class extends r(l(o)){constructor(e){super(e),this.type=`viewshed`,this.operationalLayerType=`ViewshedLayer`,this.source=new k,this.opacity=1}initialize(){this.addHandles(v(()=>this.source,(e,t)=>{t!=null&&t.parent===this&&(t.parent=null),e!=null&&(e.parent=this)},g))}async load(){return this.addResolvingPromise(this.source.waitComputeExtent()),this}get spatialReference(){return this.source.spatialReference}get fullExtent(){return this.source.extent}releaseAnalysis(e){this.source===e&&(this.source=new k)}get analysis(){return this.source}set analysis(e){this.source=e}get viewsheds(){return this.source.viewsheds}set viewsheds(e){this.source.viewsheds=e}writeViewsheds(e,t,n,r){t.viewsheds=e.filter(e=>e.valid).toJSON(r)}};m([e({json:{read:!1},readOnly:!0})],N.prototype,`type`,void 0),m([e({type:[`ViewshedLayer`]})],N.prototype,`operationalLayerType`,void 0),m([e({type:k,nonNullable:!0})],N.prototype,`source`,void 0),m([e({readOnly:!0})],N.prototype,`spatialReference`,null),m([e({readOnly:!0})],N.prototype,`fullExtent`,null),m([e({readOnly:!0,json:{read:!1,write:!1,origins:{service:{read:!1,write:!1},"portal-item":{read:!1,write:!1},"web-document":{read:!1,write:!1}}}})],N.prototype,`opacity`,void 0),m([e({type:[`show`,`hide`]})],N.prototype,`listMode`,void 0),m([e({type:p.ofType(D),json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{ignoreOrigin:!0}}}}})],N.prototype,`viewsheds`,null),m([c(`web-scene`,`viewsheds`)],N.prototype,`writeViewsheds`,null),N=m([u(`esri.layers.ViewshedLayer`)],N);var P=N;export{P as default};