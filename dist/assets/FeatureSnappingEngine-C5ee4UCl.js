const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/FeatureServiceSnappingSource-BYsvaRJw.js","assets/index-BN8X5Ryz.js","assets/index-CWJhHB6-.css","assets/boundedPlane-DKHNKWJN.js","assets/ObjectStack-l5kM7JZu.js","assets/vectorStacks-Cuo89CNO.js","assets/quatf64-D37SEdPg.js","assets/lineSegment-BudcKS0C.js","assets/plane-Da5EsY0J.js","assets/ray-LkJ58wpZ.js","assets/vec3-B94Y7ih2.js","assets/sphere-d9-4vNcj.js","assets/memoize-Dl61_jt0.js","assets/WorkerHandle-CqB02i91.js","assets/geodesicUtils-D99LxQ6q.js","assets/dehydratedPoint-CWZQBefp.js","assets/elevationInfoUtils-uoMH3ofe.js","assets/constraints-Ch5tsKD8.js","assets/LineSnappingHint-CmFAetWF.js","assets/DrapedEdgeSnappingCandidate-CqXt8QLN.js","assets/EdgeSnappingCandidate-CCg5Xb97.js","assets/SnappingCandidate-DueCLuvH.js","assets/VertexSnappingCandidate-DgxoZtvD.js","assets/PointSnappingHint-F2JtYtXH.js","assets/queryEngineUtils-D9pJ9DzT.js","assets/snappingUtils-D3oTIKrZ.js","assets/layerViewUtils-CJcMVuwG.js","assets/FeatureCollectionSnappingSource-DM_4yW5V.js","assets/symbologySnappingCandidates-B-0zt98i.js","assets/GraphicsSnappingSource-C681bWh2.js","assets/PooledRBush-BH7_Gu1G.js","assets/memoryEstimations-D_IbKyOk.js","assets/WhereClause-CATd9kVz.js","assets/WhereClauseCache-BO4WYMj9.js","assets/closestPointOnCurve-CwZL45U3.js","assets/timeSupport-vK4lVcYW.js","assets/queryUtils-DGU5ISbw.js","assets/featureConversionUtils-o9-cJXzl.js","assets/OptimizedFeatureSet-CLjmRHYn.js","assets/OptimizedGeometry-BQJ7w5VU.js","assets/normalizeUtilsSync-TXjrdJAe.js","assets/QueryEngine-CD8WljsT.js","assets/QueryEngineCapabilities-CxeEdoTy.js","assets/SnappingCandidate-4DPnOY6Y.js","assets/FixedIntervalBinParameters-CMgMaWGN.js","assets/utils-BizEctJo.js","assets/utils-Bftaersa.js","assets/utils-DCGMUq-q.js","assets/generateRendererUtils-DGV_dTnd.js","assets/BoundsStore-DE7p6f_c.js","assets/FeatureStore-DxVA8hqB.js","assets/optimizedFeatureQueryEngineAdapter-DQyaY_b1.js","assets/cimSymbolUtils-CLt57XQ8.js","assets/utils-BGjabRH0.js","assets/SceneLayerSnappingSource-ByWHQa0A.js","assets/FloatArray-Dt98pDp2.js","assets/BufferView-BW77W5ev.js","assets/Util-BQgFCZvD.js","assets/types-BEunqM4i.js","assets/VertexAttributeLocations-BScEla0R.js","assets/VertexElementDescriptor-Cl_nC_ty.js","assets/Indices-tJiSUK6w.js","assets/Normals-B0YlgMdD.js","assets/deduplicate-D-tDe87s.js","assets/workerHelper-DL2pDLjw.js","assets/edgeProcessing-BiG5KLu5.js","assets/TextureBackedBufferLayout-C3PSJOOo.js"])))=>i.map(i=>d[i]);
import{$S as e,$x as t,Aw as n,BT as r,CE as i,Db as a,ED as o,Gb as s,Hl as c,Ki as l,Mh as u,Ph as d,VT as f,Wl as p,Zw as m,cv as h,im as g,kD as _,mv as v,nE as y,pT as b,pv as x,sD as S,sS as C,wg as w,y_ as T}from"./index-BN8X5Ryz.js";import"./quatf64-D37SEdPg.js";import"./plane-Da5EsY0J.js";import"./vectorStacks-Cuo89CNO.js";import"./dehydratedPoint-CWZQBefp.js";import{r as E}from"./layerViewUtils-CJcMVuwG.js";import"./memoize-Dl61_jt0.js";import{m as D}from"./elevationInfoUtils-uoMH3ofe.js";import"./ObjectStack-l5kM7JZu.js";import"./ray-LkJ58wpZ.js";import{n as O}from"./floorFilterUtils-CPLVKkMB.js";import"./geodesicUtils-D99LxQ6q.js";import{_ as k,g as A,h as j}from"./LineSnappingHint-CmFAetWF.js";import{c as M,l as N,n as P}from"./snappingUtils-D3oTIKrZ.js";import"./vec3-B94Y7ih2.js";import"./sphere-d9-4vNcj.js";import{u as F}from"./constraints-Ch5tsKD8.js";import"./SnappingCandidate-DueCLuvH.js";import{n as I,t as L}from"./EdgeSnappingCandidate-CCg5Xb97.js";import{t as R}from"./DrapedEdgeSnappingCandidate-CqXt8QLN.js";import"./RightAngleSnappingHint-tXLlHR_t.js";import{n as z,t as B}from"./viewUtils-GR2hLWLo.js";import"./viewUtils-H4dpIyqQ.js";import{n as V}from"./mapCollectionUtils-CMweJs6i.js";var H=class extends n{set attributeRulesEnabled(e){this._set(`attributeRulesEnabled`,e),e&&this.loadRules()}get layerView(){return this.view?.allLayerViews?.find(e=>e.layer===this.layer)}get valid(){let{_valid:e,snappingSource:t,layer:n}=this;return!(!t||!n)&&e}get subtypeFilter(){let{layer:e,snappingSource:t}=this;if(!u(e)||!e.subtypes?.length||!t)return{mode:`not-in-use`,filter:null};let n=t.layerSource.sublayerSources.filter(e=>e.enabled&&e.layer.visible&&E(this.view?.scale,e.layer.effectiveScaleRange.minScale,e.layer.effectiveScaleRange.maxScale)).map(e=>e.layer.subtypeCode);if(!n.length)return{mode:`none-visible`,filter:null};if(n.length===e.subtypes.length)return{mode:`all-visible`,filter:null};let r=e.fieldsIndex.get(e.subtypeField)?.name??e.subtypeField;return n.length===1?{mode:`in-use`,filter:`${r} = ${n.getItemAt(0)}`}:{mode:`in-use`,filter:`${r} IN (${n.join(`, `)})`}}get floorFilter(){let{view:e,layer:t}=this;return e&&t?O({view:e,layer:t}):null}constructor(e){super(e),this.layer=null,this.snappingSource=null,this.rulesTable=null,this._valid=null}initialize(){if(!this.snappingSource||!this.layer)return void(this._valid=!1);let{layer:e,snappingSource:t}=this;if(`refresh`in e){let n=e;this.addHandles(n.on(`refresh`,()=>t.refresh()))}this.loadRules(),this.addHandles([x(()=>t.updating,e=>t.layerSource.updating=e,v),x(()=>t.availability,e=>t.layerSource.availability=e,v)])}getFetchCandidatesParameters(e,t,n){if(!this.valid)return[];let{layer:r,layerView:i,floorFilter:a,rulesTable:s,subtypeFilter:c}=this,f={distance:n,mode:this.view?.type??`2d`,point:e,coordinateHelper:t.coordinateHelper,...U(),filter:i&&`filter`in i?i.filter:null};if(a&&(f.filter=W(f.filter,a)),c.mode!==`not-in-use`&&c.mode!==`all-visible`){if(c.mode===`none-visible`)return[];f.filter?f.filter.where=g(f.filter.where,c.mode):f.filter=new l({where:c.filter})}if(!this.attributeRulesEnabled)return[f];let p=t.feature,m=p?.sourceLayer?.type===`subtype-sublayer`?p.sourceLayer.parent:p?.sourceLayer;if(s&&p&&M(this.view?.map)&&(d(r)||u(r))&&(d(m)||u(m))&&this.view.map.utilityNetworks?.find(e=>e.isUtilityLayer(m))){if(s.loadStatus!==`loaded`)return[];let e=[],t=r.layerId,n=s.getFeatureSQL(m,p)?.[t];if(!n)return[];let i=n.anyVertex,a=n.endVertex;return a&&i&&a===i&&(a=``),a&&e.push({...f,returnEdge:!1,vertexMode:`ends`,filter:W(f.filter,a)}),i&&e.push({...f,returnEdge:o(`snapping-include-edges-when-applying-any-vertex-rule`)??!1,vertexMode:`all`,filter:W(f.filter,i)}),e}return[f]}async loadRules(){this._valid=null;let{layer:e,view:t,attributeRulesEnabled:n}=this;if(n&&e&&t&&M(t?.map)&&(d(e)||u(e)))try{await Promise.allSettled(t.map.utilityNetworks?.map(e=>e.load())??[]);let n=t.map.utilityNetworks?.find(t=>t.isUtilityLayer(e));n&&(this.rulesTable=await n.getRulesTable(),await this.rulesTable?.load())}catch{this._valid=!1,i.getLogger(`esri.views.interactive.snapping.FeatureSnappingSourceInfo`).error(`Failed to load rules table for snapping source`,e.title);return}this._valid=!0}remove(){this.destroy()}destroy(){this.snappingSource?.destroy()}};function U(){return{returnEdge:!0,vertexMode:`all`}}function W(e,t){return e==null?new l({where:t}):e.where?new l({where:g(e.where,t)}):new l({where:t})}_([r({constructOnly:!0})],H.prototype,`layer`,void 0),_([r({constructOnly:!0})],H.prototype,`snappingSource`,void 0),_([r({constructOnly:!0})],H.prototype,`view`,void 0),_([r({value:!1})],H.prototype,`attributeRulesEnabled`,null),_([r()],H.prototype,`layerView`,null),_([r()],H.prototype,`rulesTable`,void 0),_([r()],H.prototype,`valid`,null),_([r()],H.prototype,`subtypeFilter`,null),_([r()],H.prototype,`floorFilter`,null),_([r()],H.prototype,`_valid`,void 0),H=_([f(`esri.views.interactive.snapping.FeatureSnappingSourceInfo`)],H);var G=class extends n{get updating(){return this._snappingSources.some(e=>e?.valid==null||!0===e.valid&&!0===e.snappingSource?.updating)||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=1,this._updatingHandles=new w,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){let e=V(()=>this.options?._effectiveFeatureSources,(e,t)=>this._createSourceInfo(e,t));this._snappingSources=e,this.addHandles([y(e),x(()=>({rulesEnabled:!!this.options?.attributeRulesEnabled,sources:this._snappingSources.filter(S)}),({rulesEnabled:e,sources:t})=>{for(let n of t)n.attributeRulesEnabled=e},h)])}destroy(){this._set(`options`,null),this._updatingHandles.destroy()}async fetchCandidates(e,t,n,r){if(!(t&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];let i=[],a=this._computeScreenSizeDistanceParameters(e,n);for(let t of this._snappingSources){if(!t?.valid||!t.snappingSource?.layerSource?.enabled||t.layerView?.suspended)continue;let o=t.getFetchCandidatesParameters(e,n,a);for(let e of o)i.push(t.snappingSource.fetchCandidates(e,r).then(e=>e.filter(e=>!this._candidateIsExcluded(t.snappingSource,e,n.excludeFeature))))}let o=(await m(i)).flat();return this._addRightAngleCandidates(o,e,a,n),b(r),N(e,o),o}_addRightAngleCandidates(e,t,n,r){let i=r.vertexHandle==null?r.editGeometryOperations!=null&&r.editGeometryOperations.data.type===`polygon`?r.editGeometryOperations.data.parts[0]?.getFirstVertex()?.pos:null:r.vertexHandle.rightSegment?.rightVertex?.pos,a=r.vertexHandle==null?r.editGeometryOperations==null?null:r.editGeometryOperations.data.parts[0]?.getLastVertex()?.pos:r.vertexHandle.leftSegment?.leftVertex?.pos,{view:o}=this,s=j(i,o,r),c=j(a,o,r),l=e.length;for(let r=0;r<l;r++)this._addRightAngleCandidate(e[r],c,t,n,e),this._addRightAngleCandidate(e[r],s,t,n,e)}_addRightAngleCandidate(e,t,n,r,i){if(t==null||!K(e))return;let o=e.constraint.closestTo(t),s=(o[0]-n[0])/r.x,c=(o[1]-n[1])/r.y,{start:l,end:u}=e.constraint;if(s*s+c*c<=1){let n=a(k(o),k(l))>a(k(o),k(u))?l:u,r=new z({targetPoint:A(o),otherVertex:t,otherVertexType:0,previousVertex:n,constraint:new F(t,o),objectId:e.objectId,isDraped:e.isDraped,domain:1});i.push(r)}}_computeScreenSizeDistanceParameters(e,t){let n=this.options==null?0:this.options.distance*(t.pointer===`touch`?this.options.touchSensitivityMultiplier:1);return this.view==null?{x:n,y:n,z:n,distance:n}:this.view.type===`2d`?(n*=this.view.resolution,{x:n,y:n,z:n,distance:n}):this._computeScreenSizeDistanceParameters3D(e,n,this.view,t)}_computeScreenSizeDistanceParameters3D(e,n,r,i){let{spatialReference:a}=i;r.renderCoordsHelper.toRenderCoords(e,a,Y);let o=r.state.camera.computeScreenPixelSizeAt(Y),s=o*r.renderCoordsHelper.unitInMeters,c=s/t(a),l=s/C(a),u=n*c,d=n*l,f=B(e,a,D,r),p=f?J(f,e,c,0,0,r,i):0,m=f?J(f,e,0,c,0,r,i):0,h=f?J(f,e,0,0,l,r,i):0;return{x:p===0?0:u/p,y:m===0?0:u/m,z:h===0?0:d/h,distance:o*n}}_candidateIsExcluded(e,t,n){if(n==null)return!1;let r=this._getCandidateObjectId(t);if(r==null)return!1;let i=e.layerSource.layer;return i.type===`graphics`?n.uid===r:n.sourceLayer===i&&!(!n.attributes||!(`objectIdField`in i))&&n.attributes[i.objectIdField]===r}_getCandidateObjectId(e){return e instanceof I?e.objectId:null}async _createSourceInfo(e,t){let n=e.layer;n.loaded||(await n.load(),b(t));let{view:r}=this,i=await this._createFeatureSnappingSourceType(e);return b(t),new H(i==null?{}:{snappingSource:i,view:r,layer:n})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case`feature`:case`geojson`:case`csv`:case`oriented-imagery`:case`subtype-group`:case`wfs`:return this._createFeatureSnappingSourceFeatureLayer(e);case`graphics`:return this._createFeatureSnappingSourceGraphicsLayer(e);case`map-notes`:return this._createFeatureSnappingSourceMapNotesLayer(e);case`scene`:case`building-scene`:return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){let{view:t}=this;return t==null||t.type!==`3d`?null:new(await(this._getSourceModule(`scene`))).SceneLayerSnappingSource({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source?.type){case`feature-layer`:case`oriented-imagery`:return new(await(this._getSourceModule(`featureService`))).FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e});case`memory`:case`csv`:case`geojson`:case`wfs`:return e.layer.geometryType===`mesh`?null:new(await(this._getSourceModule(`featureCollection`))).FeatureCollectionSnappingSource({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new(await(this._getSourceModule(`graphics`))).GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new(await(this._getSourceModule(`notes`))).GraphicsSnappingSource({getGraphicsLayers:()=>e.layer.sublayers?.toArray()??[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){let t=this._sourceModules[e];if(t.loader==null){let t=this._loadSourceModule(e),n={module:null,loader:t};this._sourceModules[e]=n;let r=await t,i={module:r,loader:t};return this._sourceModules[e]=i,r}return t.module==null?t.loader:t.module}_loadSourceModule(t){let n=this._updatingHandles;switch(t){case`featureService`:return n.addPromise(e(()=>import(`./FeatureServiceSnappingSource-BYsvaRJw.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26])));case`featureCollection`:return n.addPromise(e(()=>import(`./FeatureCollectionSnappingSource-DM_4yW5V.js`),__vite__mapDeps([27,1,2,4,5,6,10,11,8,9,12,14,15,16,17,18,19,20,21,22,23,24,28,25])));case`graphics`:case`notes`:return n.addPromise(e(()=>import(`./GraphicsSnappingSource-C681bWh2.js`),__vite__mapDeps([29,1,2,4,5,6,10,11,8,9,30,12,31,32,33,14,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,15,16,52,53,17,18,19,20,21,22,23,24,28,25])));case`scene`:return n.addPromise(e(()=>import(`./SceneLayerSnappingSource-ByWHQa0A.js`),__vite__mapDeps([54,1,2,4,5,6,10,11,8,9,12,13,14,55,56,57,58,59,60,61,62,63,15,16,64,65,66,17,18,20,21,22,23])))}}get test(){}};function K(e){return(e instanceof L||e instanceof R)&&!q(e)}function q({constraint:{start:e,end:t}}){let n=p(e,t),r=a(k(e),k(t));return n<s()||r/n<Z}function J(e,t,n,r,i,a,{spatialReference:o}){let s=c(X,t);s[0]+=n,s[1]+=r,s[2]+=i;let l=B(s,o,D,a);return l?P(l,e):1/0}_([r({constructOnly:!0})],G.prototype,`spatialReference`,void 0),_([r({constructOnly:!0})],G.prototype,`view`,void 0),_([r()],G.prototype,`options`,void 0),_([r({readOnly:!0})],G.prototype,`updating`,null),_([r()],G.prototype,`_snappingSources`,void 0),G=_([f(`esri.views.interactive.snapping.FeatureSnappingEngine`)],G);var Y=T(),X=T(),Z=1e-4;export{G as FeatureSnappingEngine};