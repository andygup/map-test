const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/geometryEngineJSON-CzAYqc2S.js","assets/_commonjsHelpers-YBF0zzdz.js","assets/geometryEngineBase-tEU0133Y.js"])))=>i.map(i=>d[i]);
import{$S as e,$T as t,$p as n,$x as r,AS as i,Af as a,ET as o,En as s,Ep as c,FE as l,Gv as u,If as d,MS as f,Nv as p,Oy as m,Pv as h,Rg as g,Rp as _,Tp as v,Uv as y,Xl as b,Yp as x,Z_ as ee,Zp as S,dy as te,hf as ne,jT as re,kv as C,ly as ie,mx as ae,pT as oe,q_ as w,tl as se,tw as ce,uD as le,uT as T,ux as E,uy as D,wD as ue,xD as de,xd as fe,xu as pe,yf as me}from"./index-BN8X5Ryz.js";import{a as he}from"./featureConversionUtils-o9-cJXzl.js";import{t as ge}from"./closestPointOnCurve-CwZL45U3.js";import{t as _e}from"./WhereClauseCache-BO4WYMj9.js";import{n as ve}from"./QueryEngineCapabilities-CxeEdoTy.js";import{a as O,c as ye,d as k,f as be,g as A,h as j,i as xe,m as Se,n as Ce,o as we,r as Te,s as Ee,t as De,u as Oe,v as ke}from"./utils-DCGMUq-q.js";import{a as Ae,c as M,i as N,n as je,o as P,r as Me,s as F,t as Ne}from"./timeSupport-vK4lVcYW.js";import{a as Pe,c as I,i as L,l as R,o as Fe,r as z,s as Ie,t as B}from"./queryUtils-DGU5ISbw.js";import{s as Le}from"./utils-BizEctJo.js";import{n as V,t as H}from"./SnappingCandidate-4DPnOY6Y.js";import{a as Re,i as ze,n as Be,r as Ve,t as He}from"./FixedIntervalBinParameters-CMgMaWGN.js";var U=new _e(50,500),W=`unsupported-query`,Ue=` as `,We=new Set([`esriFieldTypeOID`,`esriFieldTypeSmallInteger`,`esriFieldTypeBigInteger`,`esriFieldTypeInteger`,`esriFieldTypeSingle`,`esriFieldTypeDouble`,`esriFieldTypeLong`]),Ge=new Set([`esriFieldTypeDate`,`esriFieldTypeDateOnly`,`esriFieldTypeTimeOnly`,`esriFieldTypeTimestampOffset`]),Ke=new Set([`esriFieldTypeString`,`esriFieldTypeGUID`,`esriFieldTypeGlobalID`,...We,...Ge]);function G(e,n,r={}){let i=K(n,e);if(!i){let r=U.getError(n,e);throw new t(W,`invalid SQL expression`,{expression:n,error:r})}let a=r.expressionName||`expression`;if(r.validateStandardized&&!i.isStandardized)throw new t(W,`${a} is not standard`,{expression:n});if(r.validateAggregate&&!i.isAggregate)throw new t(W,`${a} does not contain a valid aggregate function`,{expression:n});return i.fieldNames}function qe(e,t,n,r){if(!n)return!0;let i=`where clause`;return q(e,t,G(e,n,{validateStandardized:!0,expressionName:i}),{expressionName:i,query:r}),!0}function Je(e,n,r,i,a){if(!r)return!0;let o=`having clause`,s=G(e,r,{validateAggregate:!0,expressionName:o});if(q(e,n,s,{expressionName:o,query:a}),!K(r,e)?.getExpressions().every(t=>{let{aggregateType:n,field:r}=t,a=e.get(r)?.name;return i.some(t=>{let{onStatisticField:r,statisticType:i}=t;return e.get(r)?.name===a&&i.toLowerCase().trim()===n})}))throw new t(W,`expressions in having clause should also exist in outStatistics`,{having:r});return!0}function K(e,t){return e?U.get(e,t):null}function Ye(e){return/\((.*?)\)/.test(e)?e:e.split(Ue)[0]}function Xe(e){return e.split(Ue)[1]}function q(e,n,r,i={}){let a=new Map;if(Ze(a,e,n,i.allowedFieldTypes??Ke,r),a.size){let e=i.expressionName??`expression`;throw new t(W,`${e} contains invalid or missing fields`,{errors:Array.from(a.values()),query:i.query})}}function Ze(e,t,n,r,i){let a=i.includes(`*`)?[...n,...i.filter(e=>e!==`*`)]:i;for(let i of a)if(t.get(i))Qe(e,t,n,r,i);else try{let a=G(t,Ye(i),{validateStandardized:!0});for(let i of a)Qe(e,t,n,r,i)}catch(t){e.set(i,{type:`expression-error`,expression:i,error:t})}}function Qe(e,t,n,r,i){let a=t.get(i);a?n.has(a.name)?r!==`all`&&!1===r?.has(a.type)&&e.set(i,{type:`invalid-type`,fieldName:a.name,fieldType:fe.fromJSON(a.type),allowedFieldTypes:Array.from(r,e=>fe.fromJSON(e))}):e.set(i,{type:`missing-field`,fieldName:a.name}):e.set(i,{type:`invalid-field`,fieldName:i})}var $e=5,et=class{constructor(){this._storage=new Map,this._purgeInterval=$e,this._sweep=()=>{if(this._timer=void 0,!this._storage)return;let e=1e3*this._purgeInterval,t=performance.now()-e;for(let[n,r]of this._storage){if(!(r.time<t))return void(this._storage.size>0&&(this._timer=setTimeout(this._sweep,e)));this._storage.delete(n)}}}destroy(){this._storage?.clear(),this._storage=null,clearTimeout(this._timer)}put(e,t){this._storage?.set(e,new nt(t)),this._scheduleSweep()}get(e){let t=this._storage?.get(e);if(t)return this._storage?.delete(e),t.time=performance.now(),this._storage?.set(e,t),t.items}clear(){this._storage?.clear()}_scheduleSweep(){this._storage&&(this._timer??=setTimeout(this._sweep,1e3*this._purgeInterval))}get test(){}},tt=0,nt=class{constructor(e){this.items=e,this.time=performance.now(),this.id=tt++}},J=class{constructor(e,t,n){this._fieldDataCache=new Map,this._returnDistinctMap=new Map,this.returnDistinctValues=e.returnDistinctValues??!1,this.fieldsIndex=n,this.featureAdapter=t;let r=e.outFields;if(r&&!r.includes(`*`)){this.outFields=r;let e=0;for(let t of r){let r=Ye(t),i=this.fieldsIndex.get(r),a=i?null:K(r,n),o=i?i.name:Xe(t)||`FIELD_EXP_`+ e++;this._fieldDataCache.set(t,{alias:o,clause:a})}}}countDistinctValues(e){return this.returnDistinctValues?(e.forEach(e=>this.getAttributes(e)),this._returnDistinctMap.size):e.length}getAttributes(e){let t=this._processAttributesForOutFields(e);return this._processAttributesForDistinctValues(t)}getFieldValue(e,t,n){if(n)return this.featureAdapter.getAttribute(e,n.name);let r=t,i=null;return this._fieldDataCache.has(r)?i=this._fieldDataCache.get(r)?.clause:n||(i=K(t,this.fieldsIndex),this._fieldDataCache.set(r,{alias:r,clause:i})),i?.calculateValue(e,this.featureAdapter)}getDataValues(e,t,n=!0){let r=t.normalizationType,i=t.normalizationTotal,a=this.fieldsIndex.get(t.field),o=_(a)||x(a),s=S(a);return e.map(e=>{let a=t.field&&this.getFieldValue(e,t.field,this.fieldsIndex.get(t.field));if(t.field2?(a=`${j(a)}${t.fieldDelimiter}${j(this.getFieldValue(e,t.field2,this.fieldsIndex.get(t.field2)))}`,t.field3&&(a=`${a}${t.fieldDelimiter}${j(this.getFieldValue(e,t.field3,this.fieldsIndex.get(t.field3)))}`)):typeof a==`string`&&n&&(o?a=a?new Date(a).getTime():null:s&&(a=a?Le(a):null)),r&&Number.isFinite(a)){let n=r===`field`&&t.normalizationField?this.getFieldValue(e,t.normalizationField,this.fieldsIndex.get(t.normalizationField)):null;a=Ce(a,r,n,i)}return a})}async getExpressionValues(e,t,r,i,a){let{arcadeUtils:o}=await n(),s=o.hasGeometryOperations(t);s&&await o.enableGeometryOperations();let c=o.createFunction(t),l=o.getViewInfo(r),u={fields:this.fieldsIndex.fields};return e.map(e=>{let t={attributes:this.featureAdapter.getAttributes(e),layer:u,geometry:s?{...P(i.geometryType,this.featureAdapter.getGeometry(e)),spatialReference:r?.spatialReference}:null},n=o.createExecContext(t,l,a);return o.executeFunction(c,n)})}validateItem(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:K(t,this.fieldsIndex)}),this._fieldDataCache.get(t)?.clause?.testFeature(e,this.featureAdapter)??!1}validateItems(e,t){return this._fieldDataCache.has(t)||this._fieldDataCache.set(t,{alias:t,clause:K(t,this.fieldsIndex)}),this._fieldDataCache.get(t)?.clause?.testSet(e,this.featureAdapter)??!1}_processAttributesForOutFields(e){let t=this.outFields;if(!t?.length)return this.featureAdapter.getAttributes(e);let n={};for(let r of t){let{alias:t,clause:i}=this._fieldDataCache.get(r);n[t]=i?i.calculateValue(e,this.featureAdapter):this.featureAdapter.getAttribute(e,t)}return n}_processAttributesForDistinctValues(e){if(e==null||!this.returnDistinctValues)return e;let t=this.outFields,n=[];if(t)for(let r of t){let{alias:t}=this._fieldDataCache.get(r);n.push(e[t])}else for(let t in e)n.push(e[t]);let r=`${(t||[`*`]).join(`,`)}=${n.join(`,`)}`,i=this._returnDistinctMap.get(r)||0;return this._returnDistinctMap.set(r,++i),i>1?null:e}},Y=`bin`,X=class{constructor(e,t,n){this.items=e,this.query=t,this.geometryType=n.geometryType,this.hasM=n.hasM,this.hasZ=n.hasZ,this.fieldsIndex=n.fieldsIndex,this.objectIdField=n.objectIdField,this.spatialReference=n.spatialReference,this.featureAdapter=n.featureAdapter}get size(){return this.items.length}createQueryResponseForCount(){let e=new J(this.query,this.featureAdapter,this.fieldsIndex);if(!this.query.outStatistics)return e.countDistinctValues(this.items);let{groupByFieldsForStatistics:t,having:n,outStatistics:r}=this.query;if(!t?.length)return 1;let i=new Map,a=new Map,o=new Set;for(let s of r){let{statisticType:r}=s,c=r===`exceedslimit`?void 0:s.onStatisticField;if(!a.has(c)){let n=[];for(let r of t){let t=this._getAttributeValues(e,r,this.items,i);n.push(t)}a.set(c,this._calculateUniqueValues(n,this.items,e.returnDistinctValues))}let l=a.get(c);for(let t in l){let{data:r,items:i}=l[t],a=r.join(`,`);n&&!e.validateItems(i,n)||o.add(a)}}return o.size}async createQueryResponse(){let e;if(e=this.query.outStatistics?this.query.outStatistics.some(e=>e.statisticType===`exceedslimit`)?this._createExceedsLimitQueryResponse():await this._createStatisticsQueryResponse(this.query,this.items):this._createFeatureQueryResponse(this.query),this.query.returnQueryGeometry){let t=this.query.geometry;f(this.query.outSR)&&!i(t.spatialReference,this.query.outSR)?e.queryGeometry=M({spatialReference:this.query.outSR,...R(t,t.spatialReference,this.query.outSR)}):e.queryGeometry=M({spatialReference:this.query.outSR,...t})}return e}createSnappingResponse(e,t,n){let r=this.featureAdapter,i=it(this.hasZ,this.hasM),{point:a,mode:o}=e,s=typeof e.distance==`number`?e.distance:e.distance.x,c=typeof e.distance==`number`?e.distance:e.distance.y;function l(e,t){let n=(e-a.x)/s,r=(t-a.y)/c;return n*n+r*r}let u={candidates:[]},d=this.geometryType===`esriGeometryPolygon`,f=this.geometryType===`esriGeometryPolyline`||this.geometryType===`esriGeometryPoint`,p=this._getPointCreator(o,t,this.spatialReference,n),h=new at(null,0),g=new at(null,0),_={x:0,y:0,z:0};for(let e of this.items){let t=r.getObjectId(e),n=r.getGeometryWithCurves?.(e);if(n!=null){y(n,t);continue}let i=r.getGeometry(e);i==null||v(i,t)}return u.candidates.sort((e,t)=>e.distance-t.distance),u;function v(t,n){let{coords:r}=t,o=t.isPoint?ot:t.lengths;if(h.coords=r,g.coords=r,e.returnEdge){let e=0;for(let t=0;t<o.length;t++){let r=o[t],s=e;for(let t=0;t<r;t++,e+=i){if(!d&&t===r-1||(h.coordsIndex=e,g.coordsIndex=t===r-1?s:e+i,!rt(_,a,h,g)))continue;let o=l(_.x,_.y);o<=1&&u.candidates.push(new H(n,p(_),Math.sqrt(o),p(h),p(g)))}}}if(e.vertexMode===`all`){let e=0;for(let t=0;t<o.length;t++){let r=o[t],a=e,s=g;s.coordsIndex=a;for(let t=0;t<r;t++,e+=i){if(h.coordsIndex=e,d&&t===r-1&&h.x===s.x&&h.y===s.y)continue;let i=l(h.x,h.y);i<=1&&u.candidates.push(new V(n,p(h),Math.sqrt(i)))}}}else if(f&&e.vertexMode===`ends`){let e=0,t=[];for(let n=0;n<o.length;n++){t.push(e);let r=o[n];e+=r*i,r>1&&t.push(e-i)}for(let e of t){h.coordsIndex=e;let t=l(h.x,h.y);t<=1&&u.candidates.push(new V(n,p(h),Math.sqrt(t)))}}}function y(t,n){let{candidates:r}=u,i={x:0,y:0,z:0};if(e.returnEdge){let e=[a.x,a.y],o={x:0,y:0,z:0},s={x:0,y:0,z:0};for(let{segments:a}of t.parts)for(let{start:t,curve:c}of a){let a=ge(t,c,e);if(a==null)continue;let u=l(...a.curvePoint);u>1||([o.x,o.y]=t,[i.x,i.y]=a.curvePoint,[s.x,s.y]=m(c),r.push(new H(n,p(i),Math.sqrt(u),p(o),p(s))))}}function o(e){i.x=t.vertexXY[2*e],i.y=t.vertexXY[2*e+1];let a=l(i.x,i.y);a>1||(i.z=t.vertexZ?.[e]??0,r.push(new V(n,p(i),Math.sqrt(a))))}if(e.vertexMode===`all`){let{vertexCount:e}=t;for(let t=0;t<e;++t)o(t);return}if(e.vertexMode===`ends`)switch(t.type){case`point`:o(0);break;case`polyline`:for(let e=0;e<t.partCount;++e){let n=t.partOffsets[e],r=t.partOffsets[e+1];o(n),r!==n&&o(r)}}}}_getPointCreator(e,t,n,r){let a=r==null||i(n,r)?e=>e:e=>R(e,n,r),{hasZ:o}=this;return e===`3d`?o&&t?({x:e,y:t,z:n})=>a({x:e,y:t,z:n}):({x:e,y:t})=>a({x:e,y:t,z:0}):({x:e,y:t})=>a({x:e,y:t})}async createSummaryStatisticsResponse(e){let{field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,minValue:o,maxValue:s,scale:l,timeZone:u,outStatisticTypes:d}=e,f=this.fieldsIndex.get(t),p=c(f)||_(f)||x(f),m=await this._getDataValues({field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,scale:l,timeZone:u},this.items),h=Oe({normalizationType:i,normalizationField:r,minValue:o,maxValue:s}),g={value:.5,fieldType:f?.type},y=v(f)?k({values:m,supportsNullCount:h,percentileParams:g,outStatisticTypes:d}):A({values:m,minValue:o,maxValue:s,useSampleStdDev:!i,supportsNullCount:h,percentileParams:g,outStatisticTypes:d});return Te(y,d,p)}async createUniqueValuesResponse(e){let{field:t,valueExpression:n,domains:r,returnAllCodedValues:i,scale:a,timeZone:o}=e,s=await this._getDataValues({field:t,field2:e.field2,field3:e.field3,fieldDelimiter:e.fieldDelimiter,valueExpression:n,scale:a,timeZone:o},this.items,!1),c=Se(s);return De(c,r,i,e.fieldDelimiter)}async createClassBreaksResponse(e){let{field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:s,minValue:c,maxValue:l,numClasses:u,scale:d,timeZone:f}=e,p=await this._getDataValues({field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,scale:d,timeZone:f},this.items),m=xe(p,{field:t,normalizationField:r,normalizationType:i,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:s,minValue:c,maxValue:l,numClasses:u});return Ee(m,o)}async createHistogramResponse(e){let{field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:s,minValue:c,maxValue:l,numBins:u,scale:d,timeZone:f}=e,p=await this._getDataValues({field:t,valueExpression:n,normalizationField:r,normalizationType:i,normalizationTotal:a,scale:d,timeZone:f},this.items);return ye(p,{field:t,normalizationField:r,normalizationType:i,normalizationTotal:a,classificationMethod:o,standardDeviationInterval:s,minValue:c,maxValue:l,numBins:u})}_sortFeatures(e,t,n){if(e.length>1&&t?.length)for(let r of t.slice().reverse()){let t=r.split(` `),i=t[0],a=this.fieldsIndex.get(i),o=!!t[1]&&t[1].toLowerCase()===`desc`,s=be(a?.type,o,`case-sensitive`);e.sort((e,t)=>{let r=n(e,i,a),o=n(t,i,a);return s(r,o)})}}_createFeatureQueryResponse(e){let{items:t,geometryType:n,hasM:r,hasZ:i,objectIdField:a,spatialReference:o}=this,{outFields:s,outSR:c,quantizationParameters:l,resultRecordCount:u,resultOffset:d,returnZ:f,returnM:p}=e,m=u!=null&&t.length>(d||0)+u,h=s&&(s.includes(`*`)?[...this.fieldsIndex.fields]:s.map(e=>this.fieldsIndex.get(e)));return{exceededTransferLimit:m,features:this._createFeatures(e,t),fields:h,geometryType:n,hasM:r&&p,hasZ:i&&f,objectIdFieldName:a,spatialReference:M(c||o),transform:l&&se(l)||null}}_createFeatures(e,t){let n=new J(e,this.featureAdapter,this.fieldsIndex),{hasM:r,hasZ:i}=this,{orderByFields:a,quantizationParameters:o,returnGeometry:s,returnCentroid:c,maxAllowableOffset:l,resultOffset:u,resultRecordCount:d,returnZ:f=!1,returnM:p=!1}=e,m=i&&f,h=r&&p,g=[],_=0,v=[...t];if(this._sortFeatures(v,a,(e,t,r)=>n.getFieldValue(e,t,r)),this.geometryType&&(s||c)){let e=se(o)??void 0,t=this.geometryType===`esriGeometryPolygon`||this.geometryType===`esriGeometryPolyline`;if(s&&!c)for(let r of v){let i=this.featureAdapter.getGeometry(r),a=this._addFeatureJSONMetadata(r,{attributes:n.getAttributes(r),geometry:P(this.geometryType,i,l,e,m,h)});t&&i&&!a.geometry&&(a.centroid=F(this,this.featureAdapter.getCentroid(r,this),e)),g[_++]=a}else if(!s&&c)for(let t of v)g[_++]=this._addFeatureJSONMetadata(t,{attributes:n.getAttributes(t),centroid:F(this,this.featureAdapter.getCentroid(t,this),e)});else for(let t of v)g[_++]=this._addFeatureJSONMetadata(t,{attributes:n.getAttributes(t),centroid:F(this,this.featureAdapter.getCentroid(t,this),e),geometry:P(this.geometryType,this.featureAdapter.getGeometry(t),l,e,m,h)})}else for(let e of v){let t=n.getAttributes(e);t&&(g[_++]=this._addFeatureJSONMetadata(e,{attributes:t}))}let y=u||0;if(d!=null){let e=y+d;g=g.slice(y,Math.min(g.length,e))}return g}_addFeatureJSONMetadata(e,t){let n=this.featureAdapter.getMetadata?.(e);return n!==void 0&&(t.metadata=n),t}_createExceedsLimitQueryResponse(){let e=!1,t=1/0,n=1/0,r=1/0;for(let e of this.query.outStatistics??[])if(e.statisticType===`exceedslimit`){t=e.maxPointCount==null?1/0:e.maxPointCount,n=e.maxRecordCount==null?1/0:e.maxRecordCount,r=e.maxVertexCount==null?1/0:e.maxVertexCount;break}if(this.geometryType===`esriGeometryPoint`)e=this.items.length>t;else if(this.items.length>n)e=!0;else{let t=it(this.hasZ,this.hasM),n=this.featureAdapter;e=this.items.reduce((e,t)=>{let r=n.getGeometry(t);return e+(r!=null&&r.coords.length||0)},0)/t>r}return{fields:[{name:`exceedslimit`,type:`esriFieldTypeInteger`,alias:`exceedslimit`,sqlType:`sqlTypeInteger`,domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(e)}}]}}async _createStatisticsQueryResponse(e,t,n={attributes:{}}){let r=[],i=new Map,a=new Map,o=new Map,s=new Map,c=new J(e,this.featureAdapter,this.fieldsIndex),l=e.outStatistics,{groupByFieldsForStatistics:u,having:d,orderByFields:f,resultRecordCount:p}=e,m=u?.length,h=!!m,g=h?u[0]:null,_=h&&!this.fieldsIndex.get(g);for(let e of l??[]){let{outStatisticFieldName:l,statisticType:f}=e,p=e,y=f===`exceedslimit`?void 0:e.onStatisticField,b=f===`percentile_disc`||f===`percentile_cont`,x=f===`EnvelopeAggregate`||f===`CentroidAggregate`||f===`ConvexHullAggregate`,ee=h&&m===1&&(y===g||_)&&f===`count`;if(h){if(!o.has(y)){let e=[];for(let n of u){let r=this._getAttributeValues(c,n,t,i);e.push(r)}o.set(y,this._calculateUniqueValues(e,t,!x&&c.returnDistinctValues))}let e=o.get(y);if(!e)continue;let n=Object.keys(e);for(let r of n){let{count:n,data:a,items:o,itemPositions:f}=e[r],m=a.join(`,`);if(!d||c.validateItems(o,d)){let e=s.get(m)||{attributes:{}};if(x){e.aggregateGeometries||={};let{aggregateGeometries:t,outStatisticFieldName:n}=await this._getAggregateGeometry(p,o);e.aggregateGeometries[n]=t}else{let r=null;if(ee)r=n;else{let e=this._getAttributeValues(c,y,t,i),n=f.map(t=>e[t]);r=b&&`statisticParameters`in p?this._getPercentileValue(p,n):this._getStatisticValue(p,n,null,c.returnDistinctValues)}e.attributes[l]=r}let r=0;u.forEach((t,n)=>e.attributes[this.fieldsIndex.get(t)?t:`EXPR_`+ ++r]=a[n]),s.set(m,e)}}}else if(x){n.aggregateGeometries||={};let{aggregateGeometries:e,outStatisticFieldName:r}=await this._getAggregateGeometry(p,t);n.aggregateGeometries[r]=e}else{let e=this._getAttributeValues(c,y,t,i);n.attributes[l]=b&&`statisticParameters`in p?this._getPercentileValue(p,e):this._getStatisticValue(p,e,a,c.returnDistinctValues)}let S=f!==`min`&&f!==`max`||!v(this.fieldsIndex.get(y))&&!this._isAnyDateField(y)?null:this.fieldsIndex.get(y)?.type;r.push({name:l,alias:l,type:S||`esriFieldTypeDouble`})}let y=h?Array.from(s.values()):[n];return this._sortFeatures(y,f,(e,t)=>e.attributes[t]),p&&(y.length=Math.min(p,y.length)),{fields:r,features:y}}_isAnyDateField(e){let t=this.fieldsIndex.get(e);return c(t)||_(t)||x(t)||S(t)}async _getAggregateGeometry(t,n){let{convexHull:r,union:i}=await e(async()=>{let{convexHull:e,union:t}=await import(`./geometryEngineJSON-CzAYqc2S.js`);return{convexHull:e,union:t}},__vite__mapDeps([0,1,2])),{statisticType:a,outStatisticFieldName:o}=t,{featureAdapter:s,spatialReference:c,geometryType:l}=this,d=n.map(e=>P(l,s.getGeometry(e))),f=r(c,d,!0)[0],p={aggregateGeometries:null,outStatisticFieldName:null};if(a===`EnvelopeAggregate`)p.aggregateGeometries={...f?ie(f):D(i(c,d)),spatialReference:c},p.outStatisticFieldName=o||`extent`;else if(a===`CentroidAggregate`){let e=f?y(f):u(D(i(c,d)));p.aggregateGeometries={x:e[0],y:e[1],spatialReference:c},p.outStatisticFieldName=o||`centroid`}else a===`ConvexHullAggregate`&&(p.aggregateGeometries=f,p.outStatisticFieldName=o||`convexHull`);return p}_getStatisticValue(e,t,n,r){let{onStatisticField:i,statisticType:a}=e,o=null;return o=n?.has(i)?n.get(i):v(this.fieldsIndex.get(i))||this._isAnyDateField(i)?k({values:t,returnDistinct:r}):A({values:r?[...new Set(t)]:t,minValue:null,maxValue:null,useSampleStdDev:!0}),n&&n.set(i,o),o[a===`var`?`variance`:a]}_getPercentileValue(e,t){let{onStatisticField:n,statisticParameters:r,statisticType:i}=e,{value:a,orderBy:o}=r,s=this.fieldsIndex.get(n);return ke(t,{value:a,orderBy:o,fieldType:s?.type,isDiscrete:i===`percentile_disc`})}_getAttributeValues(e,t,n,r){if(r.has(t))return r.get(t);let i=this.fieldsIndex.get(t),a=n.map(n=>e.getFieldValue(n,t,i));return r.set(t,a),a}_calculateUniqueValues(e,t,n){let r={},i=t.length;for(let a=0;a<i;a++){let i=t[a],o=[];for(let t of e)o.push(t[a]);let s=o.join(`,`);r[s]==null?r[s]={count:1,data:o,items:[i],itemPositions:[a]}:(n||r[s].count++,r[s].items.push(i),r[s].itemPositions.push(a))}return r}async _getDataValues(e,t,n=!0){let r=new J(this.query,this.featureAdapter,this.fieldsIndex),{valueExpression:i,scale:a,timeZone:o}=e;return i?r.getExpressionValues(t,i,{viewingMode:`map`,scale:a,spatialReference:this.query.outSR||this.spatialReference},{geometryType:this.geometryType,hasZ:this.hasZ,hasM:this.hasM},o):r.getDataValues(t,l(e),n)}_calculateHistogramBins(e,t,n){if(t.min==null&&t.max==null)return[];let r=t.intervals,i=t.min??0,a=t.max??0,o=r.map(([e,t])=>({minValue:e,maxValue:t,count:0,items:[]}));for(let t=0;t<e.length;t++){let s=e[t],c=n[t];if(s!=null&&s>=i&&s<=a){let e=we(r,s);e>-1&&(o[e].count++,o[e].items.push(c))}}return o}async createQueryBinsResponse(e){let t=e.bin?.splitBy;if(!t)return this._createBinsResponse(e);let{value:n,outAlias:r,valueType:i}=t,a=[],o=[{name:r??n,alias:r??n,type:i??`esriFieldTypeString`},{name:Y,alias:Y,type:`esriFieldTypeInteger`}],s=new J(e,this.featureAdapter,this.fieldsIndex),c=new Map,l=[...this.items];this._sortFeatures(l,[n],(e,t,n)=>s.getFieldValue(e,t,n));let u=this._getAttributeValues(s,n,l,c),d=this._calculateUniqueValues([u],l,s.returnDistinctValues);for(let t in d){let{items:i}=d[t],s=await this._createBinsResponse(e,i);if(a.push(...s.features.map(e=>({...e,attributes:{...e.attributes,[r??n]:t}}))),s.fields)for(let e of s.fields)o.some(t=>t.name===e.name)||o.push(e)}return{fields:o,features:a}}async _createBinsResponse(e,t){let n=e.bin;switch(t??=this.items,n.type){case`autoIntervalBin`:return this._createAutoIntervalBinsResponse(Re.fromJSON(n),e,t);case`dateBin`:return this._createDateBinsResponse(Ve.fromJSON(n),e,t);case`fixedBoundariesBin`:return this._createFixedBoundariesBinsResponse(Be.fromJSON(n),e,t);case`fixedIntervalBin`:return this._createFixedIntervalBinsResponse(He.fromJSON(n),e,t)}}async _createAutoIntervalBinsResponse(e,t,n){let{field:r,normalizationField:i,numBins:a,normalizationType:o,normalizationTotal:s,start:c,end:l}=e,u=await this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},n),d=O(u,{field:r,normalizationField:i,normalizationType:o,normalizationTotal:s,numBins:a,minValue:z(c,!1),maxValue:z(l,!1)}),f=this._calculateHistogramBins(u,d,n);return this._createFeaturesFromHistogramBins(f,t)}async _createDateBinsResponse(e,t,n){let{field:r,interval:i,start:a,end:o,snapToData:s,returnFullIntervalBin:c}=e,l=i.unit,u=await this._getDataValues({field:e.field,timeZone:t.outTimeReference?.ianaTimeZone},n),d=S(this.fieldsIndex.get(r)),f=ze.toJSON(l),p=u.filter(Boolean).sort((e,t)=>e-t),m=a==null?p[0]:z(a,d),h=o==null?p[p.length-1]:z(o,d),g=[];if(m!=null&&h!=null){let e={zone:t.outTimeReference?.ianaTimeZone??`UTC`},n=w.fromMillis(m,e),r=w.fromMillis(h,e);if(s===`last`){let e=r;for(;e>n;){let t=e.minus({[f]:i.value});if(t<n){g.unshift([c?t.toMillis():n.toMillis(),e.toMillis()]);break}g.unshift([t.toMillis(),e.toMillis()]),e=t}}else{let e=s===`first`?n:n.startOf(f);for(;e<=r;){let t=e.plus({[f]:i.value});if(t>r){g.push([e.toMillis(),c?t.toMillis():r.toMillis()]);break}g.push([e.toMillis(),t.toMillis()]),e=t}}}let _=this._calculateHistogramBins(u,{intervals:g,min:m,max:h},n);return this._createFeaturesFromHistogramBins(_,t)}async _createFixedBoundariesBinsResponse(e,t,n){let{field:r}=e,i=await this._getDataValues({field:r,timeZone:t.outTimeReference?.ianaTimeZone},n),a=S(this.fieldsIndex.get(r)),o=e.boundaries.map(e=>z(e,a)).sort((e,t)=>e-t),s=[];for(let e=0;e<o.length-1;e++)s.push([o[e],o[e+1]]);let c={intervals:s,min:o.at(0),max:o.at(-1)},l=this._calculateHistogramBins(i,c,n);return this._createFeaturesFromHistogramBins(l,t)}async _createFixedIntervalBinsResponse(e,t,n){let{field:r,interval:i,start:a,end:o}=e,s=await this._getDataValues({field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationType,normalizationTotal:e.normalizationTotal,timeZone:t.outTimeReference?.ianaTimeZone},n),c=S(this.fieldsIndex.get(r)),l=O(s,{field:r,classificationMethod:`defined-interval`,definedInterval:i,minValue:z(a,c),maxValue:z(o,c)},!0),u=this._calculateHistogramBins(s,l,n);return this._createFeaturesFromHistogramBins(u,t)}async _createFeaturesFromHistogramBins(e,t){let{upperBoundaryAlias:n,lowerBoundaryAlias:r}=t,i=r||`lowerBoundary`,a=n||`upperBoundary`,o=[],s=[{name:i,alias:i,type:`esriFieldTypeDouble`},{name:a,alias:a,type:`esriFieldTypeDouble`}],c=t.bin?.stackBy?.value,l=t.bin?.stackBy?.outAlias;c&&s.push({name:Y,alias:Y,type:`esriFieldTypeInteger`},{name:l??c,alias:l??c,type:`esriFieldTypeString`});let u=0,d=t.bin.type===`dateBin`,f=t.outTimeReference?.ianaTimeZone;for(let n of e){let{minValue:e,maxValue:r,items:p}=n,m={attributes:{}},h;if(m.attributes[i]=d&&f&&e!=null?w.fromMillis(e,{zone:f}).toISO():e,m.attributes[a]=d&&f&&r!=null?w.fromMillis(r,{zone:f}).toISO():r,c?(h=await this._createStatisticsQueryResponse({...t,groupByFieldsForStatistics:[c],orderByFields:[c]},p),m.attributes[Y]=++u,t.bin.jsonStyle===`flat`?o.push(...h.features.map(({attributes:{EXPR_1:e,...t},...n})=>({...n,attributes:l??e?{...t,[l??e]:e,...m.attributes}:{...t,...m.attributes}}))):(m.stackedAttributes=h.features.map(({attributes:{EXPR_1:e,...t}})=>l??e?{...t,[l??e]:e}:t),o.push(m))):(t.bin?.splitBy&&(m.attributes[Y]=++u),h=await this._createStatisticsQueryResponse(t,p,m),o.push(m)),h.fields)for(let e of h.fields)s.some(t=>t.name===e.name)||s.push(e)}return t.binOrder===`desc`&&o.reverse(),{fields:s,features:o}}};function rt(e,t,n,r){let i=r.x-n.x,a=r.y-n.y,o=t.x-n.x,s=t.y-n.y,c=i*i+a*a;if(c===0)return!1;let l=o*i+s*a,u=Math.min(1,Math.max(0,l/c));return e.x=n.x+i*u,e.y=n.y+a*u,!0}function it(e,t){return e?t?4:3:t?3:2}var at=class{constructor(e,t){this.coords=e,this.coordsIndex=t}get x(){return this.coords[this.coordsIndex]}get y(){return this.coords[this.coordsIndex+1]}get z(){return this.coords[this.coordsIndex+2]}},ot=[1],Z=`unsupported-query`;async function st(e,n){let r=e.bin;if(!r.onField&&!r.onExpression?.value||r.type===`autoIntervalBin`&&r.parameters.numberOfBins==null||r.type===`dateBin`&&(r.parameters.number==null||r.parameters.unit==null)||r.type===`fixedBoundariesBin`&&r.parameters.boundaries==null||r.type===`fixedIntervalBin`&&r.parameters.interval==null)throw new t(Z,`Unsupported query options`,{query:e});return Q(e,n)}async function Q(e,{fieldsIndex:n,geometryType:r,spatialReference:i,availableFields:a}){if(e.geometryPrecision!=null||e.multipatchOption&&e.multipatchOption!==`xyFootprint`||e.pixelSize||e.relationParam||e.text)throw new t(Z,`Unsupported query options`,{query:e});return ct(n,a,e),ut(n,a,e),Promise.all([Me(e,r,i),I(i,e.outSR)]).then(()=>e)}function ct(e,n,r){let{returnDistinctValues:i,outStatistics:a}=r,o=a?a.map(e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase()).filter(Boolean):[];if(`orderByFields`in r&&r.orderByFields&&r.orderByFields.length>0){let t=` asc`,i=` desc`,a=r.orderByFields.map(e=>{let n=e.toLowerCase();return n.includes(t)?n.split(t)[0]:n.includes(i)?n.split(i)[0]:e}).filter(e=>!o.includes(e));q(e,n,a,{expressionName:`orderByFields`,query:r})}if(`outFields`in r){if(r.outFields?.length)q(e,n,r.outFields,{expressionName:`outFields`,query:r,allowedFieldTypes:`all`});else if(i)throw new t(Z,`outFields should be specified for returnDistinctValues`,{query:r})}qe(e,n,r.where,r)}var lt=new Set([...We,...Ge]);function ut(e,n,r){let{outStatistics:i,groupByFieldsForStatistics:a,having:o}=r,s=a?.length,c=i?.length;if(o){if(!s||!c)throw new t(Z,`outStatistics and groupByFieldsForStatistics should be specified with having`,{query:r});Je(e,n,o,i,r)}if(c){if(!pt(i))return;let o=i.map(e=>e.onStatisticField).filter(Boolean);q(e,n,o,{expressionName:`onStatisticFields`,query:r}),s&&q(e,n,a,{expressionName:`groupByFieldsForStatistics`,query:r});for(let a of i){let{onStatisticField:i,statisticType:o}=a;if((o===`percentile_disc`||o===`percentile_cont`)&&`statisticParameters`in a){let{statisticParameters:e}=a;if(!e)throw new t(Z,`statisticParameters should be set for percentile type`,{definition:a,query:r})}else e.get(i)&&o!==`count`&&o!==`min`&&o!==`max`&&q(e,n,[i],{expressionName:`outStatistics with '${o}' statistic type`,allowedFieldTypes:lt,query:r})}}}async function dt(e,n,{fieldsIndex:r,geometryType:i,spatialReference:a,availableFields:o}){if(e.geometryPrecision!=null||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new t(Z,`Unsupported query options`,{query:e});return ct(r,o,e),Promise.all([ft(r,o,n,e),Me(e,i,a),I(a,e.outSR)]).then(()=>e)}async function ft(e,r,i,a){let o=[];if(i.valueExpression){let{arcadeUtils:e}=await n();o=e.extractFieldNames(i.valueExpression)}if(i.field&&o.push(i.field),i.field2&&o.push(i.field2),i.field3&&o.push(i.field3),i.normalizationField&&o.push(i.normalizationField),!o.length&&!i.valueExpression)throw new t(Z,`field or valueExpression is required`,{params:i});q(e,r,o,{expressionName:`statistics`,query:a})}function pt(e){return e!=null&&e.every(e=>e.statisticType!==`exceedslimit`)}var mt=`unsupported-query`,ht=class{constructor(e){this._changeHandle=null,this.capabilities={query:ve},this.geometryType=e.geometryType,this.hasM=!!e.hasM,this.hasZ=!!e.hasZ,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._cache=e.cache??new et,this.timeInfo=e.timeInfo,this.featureIdInfo=e.featureIdInfo,e.featureIdInfo.type===`object-id`&&(this.objectIdField=e.featureIdInfo.fieldName),this._changeHandle=this.featureStore.events.on(`changed`,()=>this._clearCache()),this.fieldsIndex=ce(e.fieldsIndex)?e.fieldsIndex:s.fromJSON(e.fieldsIndex),!e.availableFields||e.availableFields.length===1&&e.availableFields[0]===`*`?this.availableFields=new Set(this.fieldsIndex.fields.map(e=>e.name)):this.availableFields=new Set(e.availableFields.map(e=>this.fieldsIndex.get(e)?.name).filter(e=>e!=null)),e.scheduler&&e.priority?this._frameTask=e.scheduler.registerTask(e.priority):this._frameTask=b}destroy(){this._changeHandle=o(this._changeHandle),this._frameTask=o(this._frameTask),this._clearCache(),re(this._cache)}get featureAdapter(){return this.featureStore.featureAdapter}async executeQuery(e,t){let n=T(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryFeatureSet(e),n)}async executeQueryForCount(e={},t){let n=T(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForCount(e),n)}async executeQueryForExtent(e,t){let n=T(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForExtent(e),n)}async executeQueryForIds(e,t){return Array.from(await this.executeQueryForIdSet(e,t))}async executeQueryForIdSet(e,t){let n=T(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForIdSet(e),n)}async executeQueryForLatestObservations(e,n){let r=T(n);if(!this.timeInfo?.trackIdField)throw new t(mt,`Missing timeInfo or timeInfo.trackIdField`,{query:e,timeInfo:this.timeInfo});return await this._frameTask.scheduleGenerator(()=>this._executeQueryForLatestObservations(e),r)}async executeQueryForOpaqueFeatures(e,t){let n=T(t);return(await this._frameTask.scheduleGenerator(()=>this._executeQuery(e,{}),n)).items}async executeAttributeBinsQuery(e,t){let n=T(t);return e=l(e),await this._frameTask.scheduleGenerator(()=>this._executeAttributeBinsQuery(e),n)}async executeQueryForSummaryStatistics(e={},t,n){let r=T(n);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForSummaryStatistics(e,t),r)}async executeQueryForUniqueValues(e={},t,n){let r=T(n);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForUniqueValues(e,t),r)}async executeQueryForClassBreaks(e={},t,n){let r=T(n);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForClassBreaks(e,t),r)}async executeQueryForHistogram(e={},t,n){let r=T(n);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForHistogram(e,t),r)}async executeQueryForSnapping(e,t){let n=T(t);return await this._frameTask.scheduleGenerator(()=>this._executeQueryForSnapping(e,n),n)}async fetchRecomputedExtents(e){let t=T(e);this._timeExtentPromise||=je(this.timeInfo,this.featureStore);let[n,r]=await Promise.all([this._getFullExtent(),this._timeExtentPromise]);return oe(t),{fullExtent:n,timeExtent:r}}_clearCache(){this._cache.clear(),this._allFeaturesPromise=null,this._timeExtentPromise=null,this._fullExtentPromise=null}async*_executeQueryFeatureSet(e){try{let t=yield*this._executeQuery(e,{});return yield,await t.createQueryResponse()}catch(t){if(t!==B)throw t;return await new X([],e,this).createQueryResponse()}}async*_executeQueryForCount(e){try{let t=yield*this._executeQuery(e,{returnGeometry:!1,returnCentroid:!1,outSR:null});return yield,t.createQueryResponseForCount()}catch(e){if(e!==B)throw e;return 0}}async*_executeQueryForExtent(e){let t=e.outSR;try{let n=yield*this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null});yield;let r=n.size;if(!r)return{count:0,extent:null};let i=await this._getBounds(n.items,n.spatialReference,t??this.spatialReference);return yield,{count:r,extent:i}}catch(e){if(e===B)return{count:0,extent:null};throw e}}async*_executeQueryForIdSet(e){try{let t=yield*this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null});yield;let n=t.items,r=new Set;for(let e of n)r.add(t.featureAdapter.getObjectId(e));return r}catch(e){if(e===B)return new Set;throw e}}async*_executeQueryForLatestObservations(e){try{let t=yield*this._executeQuery(e,{});return yield,this._filterLatest(t),yield,await t.createQueryResponse()}catch(t){if(t!==B)throw t;return await new X([],e,this).createQueryResponse()}}async*_executeAttributeBinsQuery(e){let t;try{e=await Fe(e,this.definitionExpression,this.spatialReference),yield,e=await st(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),yield;let n=yield*this._executeSceneFilterQuery(e);yield,t=yield*this._executeGeometryQuery(e,n),yield,this._executeAggregateIdsQuery(t),yield,this._executeObjectIdsQuery(t),yield,this._executeTimeQuery(t),yield,this._executeAttributesQuery(t),yield}catch(n){if(n!==B)throw n;t=new X([],e,this)}return await t.createQueryBinsResponse(e)}async*_executeQueryForSummaryStatistics(e={},t){let{field:n,normalizationField:r,valueExpression:i}=t,a=yield*this._executeQueryForStatistics(e,{field:n,normalizationField:r,valueExpression:i});return yield,await a.createSummaryStatisticsResponse(t)}async*_executeQueryForUniqueValues(e={},t){let{field:n,field2:r,field3:i,valueExpression:a}=t,o=yield*this._executeQueryForStatistics(e,{field:n,field2:r,field3:i,valueExpression:a});return yield,await o.createUniqueValuesResponse(t)}async*_executeQueryForClassBreaks(e,t){let{field:n,normalizationField:r,valueExpression:i}=t,a=yield*this._executeQueryForStatistics(e,{field:n,normalizationField:r,valueExpression:i});return yield,await a.createClassBreaksResponse(t)}async*_executeQueryForHistogram(e,t){let{field:n,normalizationField:r,valueExpression:i}=t,a=yield*this._executeQueryForStatistics(e,{field:n,normalizationField:r,valueExpression:i});return yield,await a.createHistogramResponse(t)}async*_executeQueryForSnapping(e,t){let{point:n,distance:r,returnEdge:a,vertexMode:o}=e;if(!a&&o===`none`)return{candidates:[]};let s=l(e.query);s=await Pe(s,this.definitionExpression,this.spatialReference),yield,s=await Q(s,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),yield;let c=!i(n.spatialReference,this.spatialReference);c&&(await I(n.spatialReference,this.spatialReference),yield);let u=typeof r==`number`?r:r.x,d=typeof r==`number`?r:r.y,f={xmin:n.x-u,xmax:n.x+u,ymin:n.y-d,ymax:n.y+d,spatialReference:n.spatialReference},p=c?R(f,this.spatialReference):f;if(!p)return{candidates:[]};let m=(await pe(C(n),null,{signal:t}))[0];yield;let h=(await pe(C(p),null,{signal:t}))[0];if(yield,m==null||h==null)return{candidates:[]};let g=await this._searchFeatures($(h.toJSON()));yield;let _=new X(g,s,this);this._executeObjectIdsQuery(_),yield,this._executeTimeQuery(_),yield,this._executeAttributesQuery(_),yield,yield*this._executeGeometryQueryForSnapping(_),yield;let v=m.toJSON(),y=c?R(v,this.spatialReference):v,b=c?Math.max(p.xmax-p.xmin,p.ymax-p.ymin)/2:r;return _.createSnappingResponse({...e,point:y,distance:b},s.returnZ,n.spatialReference)}async _getBounds(e,t,n){let r=d(a(),me);return await this.featureStore.forEachBounds(e,e=>ne(r,e)),gt(r,t,n,this.spatialReference,this.hasZ)}_getFullExtent(){return this._fullExtentPromise||=`getFullExtent`in this.featureStore&&this.featureStore.getFullExtent?Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)):this._getAllFeatures().then(e=>this._getBounds(e,this.spatialReference,this.spatialReference)),this._fullExtentPromise}async _getAllFeaturesQueryEngineResult(e){return new X(await this._getAllFeatures(),e,this)}async _getAllFeatures(){if(this._allFeaturesPromise==null){let e=[];this._allFeaturesPromise=(async()=>await this.featureStore.forEach(t=>e.push(t)))().then(()=>ue(e))}let e=this._allFeaturesPromise,t=await e;return e===this._allFeaturesPromise?t.slice():this._getAllFeatures()}async*_executeQuery(e,t){e=l(e),e=await L(e,this.definitionExpression,this.spatialReference),yield,e=await Q(e,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),yield,e={...e,...t};let n=yield*this._executeSceneFilterQuery(e);yield;let r=yield*this._executeGeometryQuery(e,n);return yield,this._executeAggregateIdsQuery(r),yield,this._executeObjectIdsQuery(r),yield,this._executeTimeQuery(r),yield,this._executeAttributesQuery(r),r}async*_executeSceneFilterQuery(e){if(e.sceneFilter==null)return null;let{outSR:t,returnGeometry:n,returnCentroid:r}=e,a=this.featureStore.featureSpatialReference,o=e.sceneFilter.geometry,s=a==null||i(a,o.spatialReference)?o:R(o,a);if(!s)return null;let c=n||r,l=f(t)&&!i(this.spatialReference,t)&&c?async e=>this._project(e,t):e=>e;yield;let u=this.featureAdapter,d=await this._searchFeatures($(s));if(yield,e.sceneFilter.spatialRelationship===`disjoint`){if(!d.length)return null;let t=new Set;for(let e of d)t.add(u.getObjectId(e));let n=await this._getAllFeatures();yield;let r=await N(`esriSpatialRelDisjoint`,s,this.geometryType);yield;let i=e=>!t.has(u.getObjectId(e))||r(u.getGeometry(e)),a=yield*this._runSpatialFilter(n,i);yield;let o=new X(a,e,this);return await l(o)}if(!d.length)return new X([],e,this);if(this._canExecuteSinglePass(s,e))return await l(new X(d,e,this));let p=await N(`esriSpatialRelContains`,s,this.geometryType);yield;let m=yield*this._runSpatialFilter(d,e=>p(u.getGeometry(e)));return yield,await l(new X(m,e,this))}async*_executeGeometryQuery(e,t){if(t!=null&&t.items.length===0)return t;let{geometry:n,outSR:r,returnGeometry:a,returnCentroid:o}=e,s=t?null:this._getCacheKey(e),c=s?this._cache.get(s):null;if(c)return new X(c,e,this);let l=f(r)&&!i(this.spatialReference,r),u=a||o,d=async e=>(l&&u&&await this._project(e,r),s&&this._cache.put(s,e.items),e),p=this.featureStore.featureSpatialReference,m=!n||p==null||i(p,n.spatialReference)?n:R(n,p);if(!m)return await d(t??await this._getAllFeaturesQueryEngineResult(e));yield;let h=this.featureAdapter,g=await this._searchFeatures($(n));yield;let _=e.spatialRel??`esriSpatialRelIntersects`;if(_===`esriSpatialRelDisjoint`){if(!g.length)return await d(t??await this._getAllFeaturesQueryEngineResult(e));let n=new Set;for(let e of g)n.add(h.getObjectId(e));let r;t==null?(yield,r=await this._getAllFeatures(),yield):r=t.items;let i=await N(_,m,this.geometryType);yield;let a=e=>!n.has(h.getObjectId(e))||i(h.getGeometry(e)),o=yield*this._runSpatialFilter(r,a);yield;let s=new X(o,e,this);return await d(s)}if(t!=null){let e=new de;g=g.filter(n=>le(t.items,n,t.items.length,e)>=0)}if(!g.length){let t=new X([],e,this);return s&&this._cache.put(s,t.items),t}if(this._canExecuteSinglePass(m,e))return await d(new X(g,e,this));let v=await N(_,m,this.geometryType);yield;let y=yield*this._runSpatialFilter(g,e=>v(h.getGeometry(e)));return yield,await d(new X(y,e,this))}_executeAggregateIdsQuery(e){if(e.items.length===0||!e.query.aggregateIds?.length||this.aggregateAdapter==null)return;let t=new Set;for(let n of e.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(n).forEach(e=>t.add(e));let n=this.featureAdapter.getObjectId;e.items=e.items.filter(e=>t.has(n(e)))}_executeObjectIdsQuery(e){if(e.items.length===0||!e.query.objectIds?.length)return;let t=new Set(e.query.objectIds),n=this.featureAdapter.getObjectId;e.items=e.items.filter(e=>t.has(n(e)))}_executeTimeQuery(e){if(e.items.length===0)return;let t=Ne(this.timeInfo,e.query.timeExtent,this.featureAdapter);t!=null&&(e.items=e.items.filter(t))}_executeAttributesQuery(e){if(e.items.length===0)return;let t=K(e.query.where,this.fieldsIndex);if(t){if(!t.isStandardized)throw TypeError(`Where clause is not standardized`);e.items=e.items.filter(e=>t.testFeature(e,this.featureAdapter))}}async*_executeGeometryQueryForSnapping(e){let{query:t}=e,{spatialRel:n}=t;if(!e?.items?.length||!t.geometry||!n)return;let r=await N(n,t.geometry,this.geometryType);yield;let i=this.featureAdapter;e.items=yield*this._runSpatialFilter(e.items,e=>r(i.getGeometry(e)))}*_runSpatialFilter(e,t){if(!t)return e;if(this._frameTask==null)return e.filter(e=>t(e));let n=yield,r=[];for(let i of e)t(i)&&r.push(i),n.madeProgress(),n.done&&(n=yield);return r}_filterLatest(e){let{trackIdField:t,startTimeField:n,endTimeField:r}=this.timeInfo,i=r||n,a=new Map,o=this.featureAdapter.getAttribute;for(let n of e.items){let e=o(n,t),r=o(n,i),s=a.get(e);(!s||r>o(s,i))&&a.set(e,n)}e.items=Array.from(a.values())}_getCacheKey(e){let{geometry:t,spatialRel:n,returnGeometry:r,returnCentroid:a,outSR:o,resultType:s,cacheHint:c}=e;if(s!==`tile`&&!c)return null;let l=r||a;return f(o)&&!i(this.spatialReference,o)&&l?JSON.stringify([t,n,o]):JSON.stringify([t,n])}_canExecuteSinglePass(e,t){let{spatialRel:n}=t;return Ae(e)&&(n===`esriSpatialRelEnvelopeIntersects`||this.geometryType===`esriGeometryPoint`&&(n===`esriSpatialRelIntersects`||n===`esriSpatialRelContains`))}async _project(e,t){if(!t||i(this.spatialReference,t))return e;let n=this.featureAdapter,r=g()?await this._getFullExtent():void 0,a=await Ie(e.items.map(e=>P(this.geometryType,n.getGeometry(e))),this.spatialReference,t,{areaOfInterestExtent:r});return e.items=ue(a.map((t,r)=>n.cloneWithGeometry(e.items[r],he(t,this.hasZ,this.hasM),this.geometryType))),e}async _searchFeatures(e){let t=new Set;await Promise.all(e.map(e=>this.featureStore.forEachInBounds(e,e=>t.add(e))));let n=Array.from(t.values());return t.clear(),n}async*_executeQueryForStatistics(e,t){e=l(e);try{e=await L(e,this.definitionExpression,this.spatialReference),yield,e=await dt(e,t,{availableFields:this.availableFields,fieldsIndex:this.fieldsIndex,geometryType:this.geometryType,spatialReference:this.spatialReference}),yield;let n=yield*this._executeSceneFilterQuery(e);yield;let r=yield*this._executeGeometryQuery(e,n);return yield,this._executeAggregateIdsQuery(r),yield,this._executeObjectIdsQuery(r),yield,this._executeTimeQuery(r),yield,this._executeAttributesQuery(r),yield,r}catch(t){if(t!==B)throw t;return new X([],e,this)}}get test(){}};function $(e){if(Ae(e)){if(p(e))return[E(Math.min(e.xmin,e.xmax),Math.min(e.ymin,e.ymax),Math.max(e.xmin,e.xmax),Math.max(e.ymin,e.ymax))];if(h(e))return e.rings.map(e=>E(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1])))}return[te(ae(),e)]}function gt(e,t,n,i,a){let o={xmin:e[0],ymin:e[1],xmax:e[3],ymax:e[4],spatialReference:M(i)};a&&isFinite(e[2])&&isFinite(e[5])&&(o.zmin=e[2],o.zmax=e[5],o.hasZ=!0);let s=R(o,t,n);if(s.spatialReference=M(n),s.xmax-s.xmin===0){let e=r(s.spatialReference);s.xmin-=e,s.xmax+=e}if(s.ymax-s.ymin===0){let e=r(s.spatialReference);s.ymin-=e,s.ymax+=e}if(a&&s.zmin!=null&&s.zmax!=null&&s.zmax-s.zmin===0){let e=r(s.spatialReference);s.zmin-=e,s.zmax+=e}return s}export{gt as n,X as r,ht as t};