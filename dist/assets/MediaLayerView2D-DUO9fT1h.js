const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/MediaLayerInteraction-B_uVL0On.js","assets/index-CZ4oMP1N.js","assets/index-CDgdHpAj.css"])))=>i.map(i=>d[i]);
import{$_ as e,BS as t,BT as n,Cb as r,DT as i,Ey as a,Nu as o,OT as s,Q_ as c,Vl as l,Xc as u,Zc as d,_w as f,aE as p,aT as m,ax as h,ev as g,fx as _,gD as v,gT as y,gs as b,iv as x,lx as S,nv as C,qw as w,rv as T,tx as E,uE as D,vs as O,yT as k}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./OptimizedFeatureSet-CTIqq8fn.js";import"./featureConversionUtils-_DSSMFQ2.js";import"./streamLayerUtils-82UmlW-3.js";import"./QueueProcessor-BtMHt_WC.js";import"./earcut-BF1-mB58.js";import"./glsl-CQsgM67j.js";import"./layerViewUtils-RSw-QNoB.js";import"./pbf-wXxPPz7x.js";import"./colorUtils-DJOs5VE1.js";import"./timeSupport-DTr00ezP.js";import"./queryUtils-DcyDFw5_.js";import"./quantizationUtils-CGy9nkLl.js";import{a as A,o as j,t as M}from"./MediaElementView-DXctSTwh.js";import"./normalizeUtilsSync-3fP05dGa.js";import"./constants-BwY8HRAs.js";import"./GeometryUtils-Dmca5Xm4.js";import"./VertexAttributeLocations-CfzeuYMz.js";import"./VertexElementDescriptor-ju-1bdWe.js";import"./labelPoint-vGsL2GFc.js";import"./callExpressionWithCursor-BmfrFX6I.js";import"./FeatureMetadata-i54qdN5K.js";import"./CIMSymbolHelper-l5sn5wJj.js";import"./rasterizingUtils-CKtfcOpu.js";import"./Rect-BhUrWpQm.js";import"./BoundingBox-CLkiiRfJ.js";import"./BidiEngine-BrFXRv7y.js";import"./callExpressionWithFeature-D55aOczd.js";import"./OverrideHelper-BhCM0ayL.js";import"./FeatureCommandQueue-CjFmAvd1.js";import"./config-BSvujflG.js";import"./TurboLine-BxbcbrGR.js";import"./dehydratedFeatureComparison-Uk3aLNrk.js";import"./WGLContainer-D_aBMsnu.js";import"./utils-DS5dbHj4.js";import"./ProgramTemplate-BXau1qoF.js";import"./VertexArrayObject-DEfjd5y-.js";import"./BufferObject-q8zuTMny.js";import"./VertexBuffer-xVpphTb4.js";import"./vec3f32-B2H3-fiA.js";import{r as N}from"./Container-BuEih3Ua.js";import"./GraphShaderModule-D5RCsL2_.js";import"./FramebufferObject-BhBPSr-C.js";import"./ShaderBuilder-D3cV1oap.js";import{t as P}from"./LayerView2D-BsKgTWnO.js";import{t as F}from"./LayerView-2jeNRFkG.js";import"./UpdateTracking2D-BiwypiBP.js";import"./constants-BuH6TGxi.js";import"./utils-Czjlo_U1.js";import"./CircularArray-CE2T6ZES.js";import"./ComputedAttributeStorage-B3XSA2BQ.js";import"./GraphicsView2D-CPqKya-9.js";import"./dehydratedFeatures-8DNmK2px.js";import"./utils-CyTmGCxv.js";import"./renderState-Be6uDhGv.js";import"./DisjointTimerQuery-mSqh8LCt.js";import"./GridShader-B_akBvUI.js";import"./PieChartMeshWriter-Al2loCUm.js";import"./SymbolFader-Cfn7eEL5.js";import{n as I,t as L}from"./utils-Cr_Wm5JE.js";import{t as R}from"./OverlayContainer-DNIcA0Lc.js";var z=[1,1],B=a(),V={none:`None`,loop:`Loop`,oscillate:`Oscillate`};function H(e){return e?{type:`CIMAnimatedSymbolProperties`,...e,playAnimation:e.playing,repeatType:e.repeatType?V[e.repeatType]:void 0}:{type:`CIMAnimatedSymbolProperties`}}var U=class extends N{constructor(t){super(),this.elementView=t,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=o(),this._handles=new k,this._vertices=new Float32Array(8),this._indices=new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]),this._handles.add([C(()=>this.elementView.element.opacity,e=>this.opacity=e,g),C(()=>[this.elementView.coords],()=>{this.requestRender()},g),C(()=>[`animationOptions`in this.elementView.element&&this.elementView.element.animationOptions],()=>{this.texture=y(this.texture),this.requestRender()},g),e(()=>this.elementView.element.loaded,()=>{let e=this.elementView.element;this.ready(),A(e)&&e.content!=null&&(this._handles.add([m(e.content,`play`,()=>this.requestRender()),m(e.content,`loadeddata`,()=>this.requestRender()),m(e.content,`loaded`,()=>this.requestRender())]),`requestVideoFrameCallback`in e.content?e.content.requestVideoFrameCallback(()=>this.requestRender()):this._handles.add([m(e.content,`seeked`,()=>this.requestRender())]),this.requestRender())},g)]),t.element.load().catch(e=>{D.getLogger(`esri.views.2d.layers.MediaLayerView2D`).error(new n(`element-load-error`,`Element cannot be displayed`,{element:t,error:e}))})}getMesh(e){throw Error(`Method not implemented.`)}destroy(){super.destroy(),this._handles.destroy(),this.texture=y(this.texture)}get textureSize(){return z}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){let{context:t}=e,n=this.elementView.element.content;if(n!=null){let r=n instanceof HTMLImageElement,i=n instanceof HTMLVideoElement,a=r?n.naturalWidth:i?n.videoWidth:n.width,o=r?n.naturalHeight:i?n.videoHeight:n.height;if(this._updatePerspectiveTransform(a,o),this.texture)if(i)if(n.readyState>=n.HAVE_CURRENT_DATA)e.animationsEnabled&&this._updateTextureAndRequestRender(n);else{let e=()=>{this._updateTextureAndRequestRender(n),n.removeEventListener(`canplay`,e),n.removeEventListener(`seeked`,e)};n.addEventListener(`canplay`,e),n.addEventListener(`seeked`,e)}else `getFrame`in n&&e.animationsEnabled&&this.requestRender();else{let e=new O(a,o);e.wrapMode=33071,e.preMultiplyAlpha=!0,`getFrame`in n?`animationOptions`in this.elementView.element&&(this._player=L(n,H(this.elementView.element.animationOptions),null,n=>{this.texture?this.texture.setData(n):this.texture=new b(t,e,n)})):this.texture=new b(t,e,n),this.texture.generateMipmap(),i&&this._requestVideoFrame(n)}}super.beforeRender(e)}_updateTextureAndRequestRender(e){this.texture.setData(e),this.texture.generateMipmap(),this._requestVideoFrame(e)}_requestVideoFrame(e){`requestVideoFrameCallback`in e?e.requestVideoFrameCallback(()=>this.requestRender()):e.paused||this.requestRender()}_createTransforms(){return null}draw(e,t){this.isReady&&this.texture!=null?(I(e,this._player),t.render(e,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:z,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._indices})):this.requestRender()}updateDrawCoords(e,t,n,r){let{coords:i,bounds:a}=this.elementView;if(i==null||a==null)return;let[o,s,c,l]=i.rings[0],u=this._vertices,{x:d,y:f}=e;u.set([s[0]-d,s[1]-f,o[0]-d,o[1]-f,c[0]-d,c[1]-f,l[0]-d,l[1]-f]);let p=t;if(r){let[e,,t]=a,{worldWidth:n,xBounds:i}=r,[o,s]=i;e<o&&t>o?p=n:t>s&&e<s&&(p=-n)}this.wrapAroundShift=p,this.isWrapAround=p!==0}_updatePerspectiveTransform(e,t){let n=this._vertices;j(B,[0,0,e,0,0,t,e,t],[n[0],n[1],n[4],n[5],n[2],n[3],n[6],n[7]]),r(this.perspectiveTransform,B[6]/B[8]*e,B[7]/B[8]*t)}},W=class extends f{constructor(e){super(e),this.editSourcePoints=!1}};v([i()],W.prototype,`editSourcePoints`,void 0),W=v([s(`esri.views.3d.layers.support.MediaLayerInteractionReshapeOptions`)],W);var G=class extends f{constructor(e){super(e),this.tool=`transform`,this.reshapeOptions=new W}};v([i()],G.prototype,`tool`,void 0),v([i({type:W})],G.prototype,`reshapeOptions`,void 0),G=v([s(`esri.views.3d.layers.support.MediaLayerInteractionOptions`)],G);var K=e=>{let t=e,n=class extends t{constructor(...e){super(...e),this.layer=null,this.interactive=!1,this.interactionOptions=new G,this.selectedElement=null}highlight(e,t){throw Error(`missing implementation`)}};return v([i()],n.prototype,`layer`,void 0),v([i()],n.prototype,`interactive`,void 0),v([i({type:G})],n.prototype,`interactionOptions`,void 0),v([i()],n.prototype,`selectedElement`,void 0),n=v([s(`esri.views.layers.MediaLayerViewMixin`)],n),n},q=class extends P(K(F)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this._interaction=null,this.layer=null,this.elements=new x}initialize(){this.addHandles([C(()=>[this.interactive,this.suspended],async()=>{if(this.interactive&&!this._interaction){let{MediaLayerInteraction:e}=await t(async()=>{let{MediaLayerInteraction:e}=await import(`./MediaLayerInteraction-B_uVL0On.js`);return{MediaLayerInteraction:e}},__vite__mapDeps([0,1,2]));this._interaction=new e({view:this.view,layer:this.layer}),this.selectedElement!==this._interaction.selectedElement&&(this._interaction.selectedElement=this.selectedElement),this.interactionOptions!==this._interaction.options&&(this._interaction.options=this.interactionOptions)}this._interaction&&(this._interaction.enabled=!this.suspended&&this.interactive)},T),C(()=>this.interactionOptions,e=>{this._interaction&&(this._interaction.options=e)},T),C(()=>this.selectedElement,e=>{this._interaction&&(this._interaction.selectedElement=e)},T)])}attach(){this.addAttachHandles([c(()=>this.layer.effectiveSource,`refresh`,()=>{this._tileStrategy.refresh(e=>this._updateTile(e)),this.requestUpdate()}),c(()=>this.layer.effectiveSource,`change`,({element:e})=>this._elementUpdateHandler(e))]),this._overlayContainer=new R,this.container.addChild(this._overlayContainer),this._fetchQueue=new d({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t),scheduler:this.scheduler,priority:l.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new u({cachePolicy:`purge`,resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(e){return!0}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(e){this._tileStrategy.update(e),this._debugGraphicsView?.update(e)}async hitTest(e,t){let n=[],r=e.normalize(),i=[r.x,r.y];for(let{elementView:{normalizedCoords:t,element:r}}of this._elementReferences.values())t!=null&&_(t.rings,i)&&n.push({type:`media`,element:r,layer:this.layer,mapPoint:e,sourcePoint:r.toSource(e)});return n.reverse()}canResume(){return this.layer.source!=null&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh(e=>this._updateTile(e))}_acquireTile(e){let t=new Z(e.clone());return this._updateTile(t),t}_updateTile(e){this._updatingHandles.addPromise(this._fetchQueue.push(e.key).then(t=>{let[n,r]=e.setElements(t);this._referenceElements(e,n),this._dereferenceElements(e,r),this.requestUpdate()},e=>{w(e)||D.getLogger(this).error(e)}))}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._dereferenceElements(e,e.elements),this.requestUpdate()}async _queryElements(e,t){let n=this.layer.effectiveSource;if(n==null)return[];this.view.featuresTilingScheme.getTileBounds(J,e,!0);let r=new h({xmin:J[0],ymin:J[1],xmax:J[2],ymax:J[3],spatialReference:this.view.spatialReference});return n.queryElements(r,t)}_referenceElements(e,t){if(this.layer.source!=null)for(let n of t)this._referenceElement(e,n)}_referenceElement(e,t){p(this._elementReferences,t.uid,()=>{let e=new M({element:t,spatialReference:this.view.spatialReference}),r=new U(e);return this._overlayContainer.addChild(r),this.elements.add(t),this._updatingHandles.addPromise(t.load().catch(e=>{D.getLogger(`esri.views.2d.layers.MediaLayerView2D`).error(new n(`element-load-error`,`Element cannot be displayed`,{element:t,error:e}))})),{debugGraphic:null,elementView:e,overlay:r,tiles:new Set}}).tiles.add(e)}_dereferenceElements(e,t){for(let n of t)this._dereferenceElement(e,n)}_dereferenceElement(e,t){let n=this._elementReferences.get(t.uid);n.tiles.delete(e),n.tiles.size||(this._overlayContainer.removeChild(n.overlay),n.overlay.destroy(),n.elementView.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),this._debugGraphicsView?.graphics.remove(n.debugGraphic))}_elementUpdateHandler(e){let t=this._elementReferences.get(e.uid);if(t){let n=t.elementView.normalizedCoords;if(n==null)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.elementView.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),void this._debugGraphicsView?.graphics.remove(t.debugGraphic);let r=[],i=[];for(let e of this._tileStrategy.tiles){let a=X(this.view.featuresTilingScheme,e,n);t.tiles.has(e)?a||i.push(e):a&&r.push(e)}for(let t of r)this._referenceElement(t,e);for(let t of i)this._dereferenceElement(t,e);t=this._elementReferences.get(e.uid),t?.debugGraphic&&(t.debugGraphic.geometry=t.elementView.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:`geometry`}));return}let n=new M({element:e,spatialReference:this.view.spatialReference}).normalizedCoords;if(n!=null)for(let t of this._tileStrategy.tiles)X(this.view.featuresTilingScheme,t,n)&&this._referenceElement(t,e)}};v([i()],q.prototype,`layer`,void 0),v([i({readOnly:!0})],q.prototype,`elements`,void 0),q=v([s(`esri.views.2d.layers.MediaLayerView2D`)],q);var J=E(),Y={xmin:0,ymin:0,xmax:0,ymax:0};function X(e,t,n){return e.getTileBounds(J,t.key,!0),Y.xmin=J[0],Y.ymin=J[1],Y.xmax=J[2],Y.ymax=J[3],S(Y,n)}var Z=class{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}setElements(e){let t=[],n=new Set(this.elements);this.elements=e;for(let r of e)n.has(r)?n.delete(r):t.push(r);return this.isReady=!0,[t,Array.from(n)]}destroy(){}},Q=q;export{Q as default};