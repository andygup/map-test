import{$T as e,An as t,Aw as n,BT as r,FE as i,Gw as a,VT as o,ZS as s,aT as c,dv as l,hT as u,jg as d,kD as f,mT as p,oT as m,pv as h,rE as g,tD as _,xC as v,yT as y}from"./index-BN8X5Ryz.js";import{r as b}from"./memoryEstimations-D_IbKyOk.js";function x(e,t=!1){return e<=1024?t?Array(e).fill(0):Array(e):new Uint32Array(e)}var S=class t{constructor(e){T(e);let{location:t,data:n}=e;this.location=Object.freeze(i(t));let r=this.location.width,a=this.location.height,o=!0,s=!0,c=Math.ceil(r*a/32),l=x(c),u=0;for(let e=0;e<n.length;e++){let t=e%32;n[e]?(s=!1,l[u]|=1<<t):o=!1,t===31&&++u}s?(this._availability=`unavailable`,this.byteSize=40):o?(this._availability=`available`,this.byteSize=40):(this._availability=l,this.byteSize=40+b(l))}getAvailability(e,t){if(this._availability===`unavailable`||this._availability===`available`)return this._availability;let n=(e-this.location.top)*this.location.width+(t-this.location.left),r=n%32,i=n>>5,a=this._availability;return i<0||i>a.length?`unknown`:a[i]&1<<r?`available`:`unavailable`}static fromDefinition(n,r){let i=n.service.request||s,{row:a,col:o,width:c,height:l}=n,u={query:{f:`json`}};return r=r?{...u,...r}:u,i(w(n),r).then(e=>e.data).catch(e=>{if(e?.details?.httpStatus===422)return{location:{top:a,left:o,width:c,height:l},valid:!0,data:Array(c*l).fill(0)};throw e}).then(n=>{if(n.location&&(n.location.top!==a||n.location.left!==o||n.location.width!==c||n.location.height!==l))throw new e(`tilemap:location-mismatch`,`Tilemap response for different location than requested`,{response:n,definition:{top:a,left:o,width:c,height:l}});return t.fromJSON(n)})}static fromJSON(e){return Object.freeze(new t(e))}};function C(e){return`${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`}function w(e){let t;if(e.service.tileServers?.length){let n=e.service.tileServers;t=`${n&&n.length?n[e.row%n.length]:e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`}else t=`${e.service.url}/tilemap/${e.level}/${e.row}/${e.col}/${e.width}/${e.height}`;let n=e.service.query;return n&&(t=`${t}?${n}`),t}function T(t){if(!t?.location)throw new e(`tilemap:missing-location`,`Location missing from tilemap response`);if(!1===t.valid)throw new e(`tilemap:invalid`,`Tilemap response was marked as invalid`);if(!t.data)throw new e(`tilemap:missing-data`,`Data missing from tilemap response`);if(!Array.isArray(t.data))throw new e(`tilemap:data-mismatch`,`Data must be an array of numbers`);if(t.data.length!==t.location.width*t.location.height)throw new e(`tilemap:data-mismatch`,`Number of data items does not match width/height of tilemap`)}var E;function D(t,n,r){return new e(`tile-map:tile-unavailable`,`Tile is not available`,{level:t,row:n,col:r})}var O=class extends n{static{E=this}constructor(e){super(e),this._pendingTilemapRequests={},this.request=s,this.size=32,this._prefetchingEnabled=!0}initialize(){this._tilemapCache=new t(2097152),this.addHandles(h(()=>{let{layer:e}=this;return[e?.parsedUrl,e?.tileServers,e?.apiKey,e?.customParameters]},()=>this._initializeTilemapDefinition(),l))}get effectiveMinLOD(){return this.minLOD??this.layer.tileInfo.lods[0].level}get effectiveMaxLOD(){return this.maxLOD??this.layer.tileInfo.lods[this.layer.tileInfo.lods.length-1].level}getAvailability(e,t,n){if(!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD)return`unavailable`;let r=this._tilemapFromCache(e,t,n,this._tmpTilemapDefinition);return r?r.getAvailability(t,n):`unknown`}fetchAvailability(e,t,n,r){return!this.layer.tileInfo.lodAt(e)||e<this.effectiveMinLOD||e>this.effectiveMaxLOD?Promise.reject(D(e,t,n)):this._fetchTilemap(e,t,n,r).catch(e=>e).then(r=>{if(r instanceof S){let i=r.getAvailability(t,n);if(i===`unavailable`)throw D(e,t,n);return i}if(m(r))throw r;return`unknown`})}fetchAvailabilityUpsample(e,t,n,r,i){r.level=e,r.row=t,r.col=n;let a=this.layer.tileInfo;a.updateTileInfo(r);let o=this.fetchAvailability(e,t,n,i).catch(e=>{if(m(e))throw e;if(a.upsampleTile(r))return this.fetchAvailabilityUpsample(r.level,r.row,r.col,r,i);throw e});return this._fetchAvailabilityUpsamplePrefetch(e,t,n,i,o),o}async _fetchAvailabilityUpsamplePrefetch(e,t,n,r,i){if(!this._prefetchingEnabled)return;let o=`prefetch-${e}-${t}-${n}`;if(this.hasHandles(o))return;let s=new AbortController;i.then(()=>s.abort(),()=>s.abort());let l=!1,u=g(()=>{l||(l=!0,s.abort())});if(this.addHandles(u,o),await a(10,s.signal).catch(()=>{}),l||(l=!0,this.removeHandles(o)),c(s))return;let f=new d(e,t,n),p={...r,signal:s.signal},m=this.layer.tileInfo;for(let e=0;E._prefetches.length<E._maxPrefetch&&m.upsampleTile(f);++e){let e=this.fetchAvailability(f.level,f.row,f.col,p);E._prefetches.push(e);let t=()=>{E._prefetches.removeUnordered(e)};e.then(t,t)}}static{this._maxPrefetch=4}static{this._prefetches=new y({initialSize:E._maxPrefetch})}static cleanupTilemapCache(){this._prefetches.prune()}_fetchTilemap(t,n,r,i){if(!this.layer.tileInfo.lodAt(t)||t<this.effectiveMinLOD||t>this.effectiveMaxLOD)return Promise.reject(new e(`tilemap-cache:level-unavailable`,`Level ${t} is unavailable in the service`));let a=this._tmpTilemapDefinition,o=this._tilemapFromCache(t,n,r,a);if(o)return Promise.resolve(o);let s=i?.signal;return i={...i,signal:null},new Promise((e,t)=>{u(s,()=>t(p()));let n=C(a),r=this._pendingTilemapRequests[n];if(!r){r=S.fromDefinition(a,i).then(e=>(this._tilemapCache.put(n,e,e.byteSize),e));let e=()=>{delete this._pendingTilemapRequests[n]};this._pendingTilemapRequests[n]=r,r.then(e,e)}r.then(e,t)})}_initializeTilemapDefinition(){if(!this.layer.parsedUrl)return;let{parsedUrl:e,apiKey:t,customParameters:n}=this.layer;this._tilemapCache.clear(),this._tmpTilemapDefinition={service:{url:e.path,query:v({...e.query,...n,token:t??e.query?.token}),tileServers:this.layer.tileServers,request:this.request},width:this.size,height:this.size,level:0,row:0,col:0}}_tilemapFromCache(e,t,n,r){r.level=e,r.row=t-t%this.size,r.col=n-n%this.size;let i=C(r);return this._tilemapCache.get(i)}get test(){}};f([r({constructOnly:!0})],O.prototype,`layer`,void 0),f([r({constructOnly:!0})],O.prototype,`minLOD`,void 0),f([r({constructOnly:!0})],O.prototype,`maxLOD`,void 0),f([r({constructOnly:!0})],O.prototype,`request`,void 0),f([r({constructOnly:!0})],O.prototype,`size`,void 0),O=E=f([o(`esri.layers.support.TilemapCache`)],O);export{O as t};