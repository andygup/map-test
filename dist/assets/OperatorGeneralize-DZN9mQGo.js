import{_D as e,mD as t}from"./index-ByaFsVj4.js";import{Dt as n,cn as r,dn as i,gn as a,in as o,kt as s,mn as c,pn as l,wn as u,z as d}from"./Point2D-BslC4Gs9.js";import{$t as f,Wn as p,hn as m,un as h,yn as g}from"./SpatialReference-Cd_hfGxp.js";import{n as _}from"./SimpleGeometryCursor-BbFgAuic.js";var v=class{getOperatorType(){return 10204}supportsCurves(){return!0}accelerateGeometry(e,t,n){return!1}canAccelerateGeometry(e){return!1}executeMany(e,t,n,r){return new y(e,t,n,r)}execute(e,t,n,r){return e||o(`null param is not allowed.`),new y(null,t,n,r).generalize(e)}},y=class extends _{constructor(e,t,n,r){super(),this.m_pline=null,this.m_point=new p,this.m_stack=[],this.m_resultstack=[],this.m_callCount=0,this.m_progressTracker=r,this.m_geoms=e,this.m_maxDeviation=t,this.m_bRemoveDegenerateParts=n}tock(){return!0}getRank(){return 1}next(){let e=this.m_geoms.next();return e===null?null:(c(e),this.generalize(e))}getGeometryID(){return this.m_geoms.getGeometryID()}generalize(o){let s=o.getGeometryType();if(a(s))return o;if(s===r.enumEnvelope){let e=new g({vd:o.getDescription()});return e.addEnvelope(o,!1),this.generalize(e)}if(i(s)){let e=new h({vd:o.getDescription()});return e.addSegment(o,!0),this.generalize(e)}if(l(s)||u(``),o.isEmpty()||this.m_maxDeviation<=0)return o;let c=new f().execute(o,0,.05*this.m_maxDeviation,0,this.m_progressTracker);o.hasNonLinearSegments()&&(this.m_maxDeviation*=.95);let d=c,p=o.createInstance();p.getGeometryType()===r.enumPolygon&&p.setFillRule(o.getFillRule()),this.m_xy=d.getAttributeStreamRef(0);{let r={stack:[],error:void 0,hasError:!1};try{this.m_pline=new m,t(r,n(()=>{this.m_pline=null},!1),!1);for(let e=0,t=d.getPathCount();e<t;e++)this.generalizePath(d.getImpl(),e,p.getImpl())}catch(e){r.error=e,r.hasError=!0}finally{e(r)}}return this.m_resultstack.length=0,this.m_stack.length=0,p}generalizePath(e,t,n){if(e.getPathSize(t)<2)return;this.m_resultstack.length=0,this.m_stack.length=0;let r=e.getPathStart(t),i=e.getPathEnd(t)-1,a=e.isClosedPath(t),o=e.isClosedPathInXYPlane(t),c=0,l=-1;this.m_stack.push(a?r:i),this.m_stack.push(r);let u=!1,f=!1;for(!this.m_bRemoveDegenerateParts&&o&&(u=!0,f=!0);this.m_stack.length>1;){let t=this.m_stack.at(-1);this.m_stack.pop();let n=this.m_stack.at(-1),r=e.getXY(t);this.m_pline.setStartXY(r),r=e.getXY(n),this.m_pline.setEndXY(r);let a=[NaN],o=this.findGreatestDistance(t,n,i,a);o>=0&&(u?u=!1:(f&&a[0]>c&&(c=a[0],l=o),a[0]<=this.m_maxDeviation&&(o=-1))),o>=0?(this.m_stack.push(o),this.m_stack.push(t)):this.m_resultstack.push(t)}a||this.m_resultstack.push(this.m_stack[0]);let p=this.m_resultstack.length;if(p===e.getPathSize(t)&&p===this.m_stack.length)n.addPath(e,t,!0);else if(this.m_resultstack.length>0){if(this.m_bRemoveDegenerateParts&&this.m_resultstack.length<=2&&(a||this.m_resultstack.length===1||s.distance(e.getXY(this.m_resultstack[0]),e.getXY(this.m_resultstack[1]))<=this.m_maxDeviation))return;if(f&&l>=0&&c<=this.m_maxDeviation){let e=this.m_resultstack.at(-1)>l;this.m_resultstack.push(l),e&&(this.m_resultstack[this.m_resultstack.length-2]=d(this.m_resultstack[this.m_resultstack.length-1],this.m_resultstack[this.m_resultstack.length-1]=this.m_resultstack[this.m_resultstack.length-2]))}for(let t=0,r=this.m_resultstack.length;t<r;t++)e.getPointByVal(this.m_resultstack[t],this.m_point),t===0?n.startPathPoint(this.m_point):n.lineToPoint(this.m_point);if(a){for(let e=this.m_resultstack.length;e<3;e++)n.lineToPoint(this.m_point);n.closePathWithLine()}}}findGreatestDistance(e,t,n,r){let i=t-1;t<=e&&(i=n);let a=-1,o=0,c=new s;for(let t=e+1;t<=i;t++){this.m_xy.queryPoint2D(2*t,c);let e=c.x,n=c.y,r=this.m_pline.getClosestCoordinate(c,!1);c.assign(this.m_pline.getCoord2D(r)),c.x-=e,c.y-=n;let i=c.length();i>o&&(a=t,o=i),this.m_callCount++}return r[0]=o,a}};export{v as t};