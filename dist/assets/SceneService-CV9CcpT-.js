import{$T as e,BT as t,CE as n,Kh as r,Lx as i,Na as a,Pi as o,VT as s,WT as c,ZS as l,cC as u,iC as d,kD as f,nr as p,pm as m,qh as h,sC as g,tT as _,tr as v,vx as y}from"./index-BN8X5Ryz.js";import{t as b}from"./originUtils-CJnuu7mB.js";import{n as x,t as S}from"./resourceUtils-t_8WR2aj.js";import{r as C}from"./saveUtils-CEfw3trS.js";async function w(t,n,r,i,a,o,s){let c=null;if(r!=null){let e=`${t}/nodepages/`,n=e+Math.floor(r.rootIndex/r.nodesPerPage);try{return{type:`page`,rootPage:(await l(n,{query:{f:`json`,...i,token:a},responseType:`json`,signal:s})).data,rootIndex:r.rootIndex,pageSize:r.nodesPerPage,lodMetric:r.lodSelectionMetricType,urlPrefix:e}}catch(e){o?.warn(`#fetchIndexInfo()`,`Failed to load root node page. Falling back to node documents.`,n,e),c=e}}if(!n)return null;let u=n?.split(`/`).pop(),d=`${t}/nodes/`,f=d+u;try{return{type:`node`,rootNode:(await l(f,{query:{f:`json`,...i,token:a},responseType:`json`,signal:s})).data,urlPrefix:d}}catch(t){throw new e(`sceneservice:root-node-missing`,`Root node missing.`,{pageError:c,nodeError:t,url:f})}}var T=null;function E(){return T}var D=T=>{let D=T,P=class extends D{constructor(){super(...arguments),this.spatialReference=null,this.fullExtent=null,this.heightModelInfo=null,this.minScale=0,this.maxScale=0,this.version={major:NaN,minor:NaN,versionString:``},this.copyright=null,this.sublayerTitleMode=`item-title`,this.title=null,this.layerId=null,this.url=null,this.indexInfo=null,this._debouncedSaveOperations=_(async(e,t,n)=>{switch(e){case 0:return this._save(t);case 1:return this._saveAs(n,t)}})}readSpatialReference(e,t){return k(t)}readFullExtent(e,t,n){if(typeof e==`object`&&e){let r=e.spatialReference==null?{...e,spatialReference:k(t)}:e;return y.fromJSON(r,n)}let r=t.store,i=k(t);return i==null||r?.extent==null||!Array.isArray(r.extent)||r.extent.some(e=>e<O)?null:new y({xmin:r.extent[0],ymin:r.extent[1],xmax:r.extent[2],ymax:r.extent[3],spatialReference:i})}parseVersionString(e){let t={major:NaN,minor:NaN,versionString:e},n=e.split(`.`);return n.length>=2&&(t.major=parseInt(n[0],10),t.minor=parseInt(n[1],10)),t}readVersion(e,t){let n=t.store,r=n.version==null?``:n.version.toString();return this.parseVersionString(r)}readTitlePortalItem(e){return this.sublayerTitleMode===`item-title`?e:void 0}readTitleService(e,t){let n=this.portalItem?.title;if(this.sublayerTitleMode===`item-title`)return this.url?u(this.url,t.name):t.name;let r=t.name;if(!r&&this.url){let e=d(this.url);e!=null&&(r=e.title)}return this.sublayerTitleMode===`item-title-and-service-name`&&n&&(r=n+` - `+r),g(r)}get parsedUrl(){return p(this,{separator:`layers`})}async _fetchIndexAndUpdateExtent(e,t){this.indexInfo=w(this.parsedUrl?.path??``,this.rootNode,e,this.customParameters,this.apiKey,n.getLogger(this),t);let{fullExtent:r}=this;r==null||r.hasZ||this._updateExtent(r,await this.indexInfo)}_updateExtent(e,t){if(t?.type===`page`){let n=t.rootIndex%t.pageSize,r=t.rootPage?.nodes?.[n];A(e,r?.obb)}else if(t?.type===`node`){let n=t.rootNode?.mbs;if(!Array.isArray(n)||n.length!==4||n[0]<O)return;let r=n[2],i=n[3];e.zmin=r-i,e.zmax=r+i}}async _fetchService(t){if(this.url==null)throw new e(`sceneservice:url-not-set`,`Scene service can not be loaded without valid portal item or url`);if(this.layerId==null&&/SceneServer\/*$/i.test(this.url)){let e=await this._fetchFirstLayerId(t);e!=null&&(this.layerId=e)}return this._fetchServiceLayer(t)}async _fetchFirstLayerId(e){let t=await l(this.url??``,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:e});if(t.data&&Array.isArray(t.data.layers)&&t.data.layers.length>0)return t.data.layers[0].id}async _fetchServiceLayer(e){let t=await l(this.parsedUrl?.path??``,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:e});t.ssl&&this.url&&(this.url=this.url.replace(/^http:/i,`https:`));let n=!1;if(t.data.layerType&&t.data.layerType===`Voxel`&&(n=!0),n)return this._fetchVoxelServiceLayer();let r=t.data;this.read(r,this._getServiceContext()),this.validateLayer(r)}async _fetchVoxelServiceLayer(e){let t=(await l(this.parsedUrl?.path+`/layer`,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:e})).data;this.read(t,this._getServiceContext()),this.validateLayer(t)}_getServiceContext(){return{origin:`service`,portalItem:this.portalItem,portal:this.portalItem?.portal,url:this.parsedUrl}}async _ensureLoadBeforeSave(){await this.load(),`beforeSave`in this&&typeof this.beforeSave==`function`&&await this.beforeSave()}validateLayer(e){}async _saveAs(t,n){let i={...N,...n},o=r.from(t);if(!o)throw new e(`sceneservice:portal-item-required`,`_saveAs() requires a portal item to save to`);o.id&&=(o=o.clone(),null);let s=o.portal||h.getDefault();await this._ensureLoadBeforeSave(),o.type=M,o.portal=s;let c=a(o,`portal-item`,!0),l={layers:[this.write({},c)]};return await Promise.all(c.resources.pendingOperations??[]),await this._validateAgainstJSONSchema(l,c,i),this.url&&(o.url=this.url),o.title||=this.title,j(o,i,1),await s.signIn(),await s.user.addItem({item:o,folder:i?.folder,data:l}),await x(this.resourceReferences,c),this.portalItem=o,b(c),c.portalItem=o,o}async _save(t){let n={...N,...t};if(!this.portalItem)throw new e(`sceneservice:portal-item-not-set`,`Portal item to save to has not been set on this SceneService`);if(this.portalItem.type!==`Scene Service`)throw new e(`sceneservice:portal-item-wrong-type`,`Portal item needs to have type "${M}"`);await this._ensureLoadBeforeSave();let r=a(this.portalItem,`portal-item`,!0),i={layers:[this.write({},r)]};return await Promise.all(r.resources.pendingOperations??[]),await this._validateAgainstJSONSchema(i,r,n),this.url&&(this.portalItem.url=this.url),this.portalItem.title||(this.portalItem.title=this.title),j(this.portalItem,n,0),await S(this.portalItem,i,this.resourceReferences,r),b(r),this.portalItem}async _validateAgainstJSONSchema(t,r,i){let a=i?.validationOptions;C(r,{errorName:`sceneservice:save`},{ignoreUnsupported:a?.ignoreUnsupported,supplementalUnsupportedErrors:[`scenemodification:unsupported`]});let o=a?.enabled,s=E();if(o&&s){let r=(await s()).validate(t,i.portalItemLayerType);if(!r.length)return;let o=`Layer item did not validate:\n${r.join(`
`)}`;if(n.getLogger(this).error(`_validateAgainstJSONSchema(): ${o}`),a.failPolicy===`throw`){let t=r.map(t=>new e(`sceneservice:schema-validation`,t));throw new e(`sceneservice-validate:error`,"Failed to save layer item due to schema validation, see `details.errors`.",{validationErrors:t})}}}};return f([t(o)],P.prototype,`id`,void 0),f([t({type:i})],P.prototype,`spatialReference`,void 0),f([c(`spatialReference`,[`spatialReference`,`store.indexCRS`,`store.geographicCRS`])],P.prototype,`readSpatialReference`,null),f([t({type:y})],P.prototype,`fullExtent`,void 0),f([c(`fullExtent`,[`fullExtent`,`store.extent`,`spatialReference`,`store.indexCRS`,`store.geographicCRS`])],P.prototype,`readFullExtent`,null),f([t({readOnly:!0,type:m})],P.prototype,`heightModelInfo`,void 0),f([t({type:Number,json:{name:`layerDefinition.minScale`,write:!0,origins:{service:{read:{source:`minScale`},write:!1}}}})],P.prototype,`minScale`,void 0),f([t({type:Number,json:{name:`layerDefinition.maxScale`,write:!0,origins:{service:{read:{source:`maxScale`},write:!1}}}})],P.prototype,`maxScale`,void 0),f([t({readOnly:!0})],P.prototype,`version`,void 0),f([c(`version`,[`store.version`])],P.prototype,`readVersion`,null),f([t({type:String,json:{read:{source:`copyrightText`}}})],P.prototype,`copyright`,void 0),f([t({type:String,json:{read:!1}})],P.prototype,`sublayerTitleMode`,void 0),f([t({type:String})],P.prototype,`title`,void 0),f([c(`portal-item`,`title`)],P.prototype,`readTitlePortalItem`,null),f([c(`service`,`title`,[`name`])],P.prototype,`readTitleService`,null),f([t({type:Number,json:{origins:{service:{read:{source:`id`}},"portal-item":{write:{target:`id`,isRequired:!0,ignoreOrigin:!0},read:!1}}}})],P.prototype,`layerId`,void 0),f([t(v({separator:`layers`}))],P.prototype,`url`,void 0),f([t({readOnly:!0})],P.prototype,`parsedUrl`,null),f([t({readOnly:!0})],P.prototype,`store`,void 0),f([t({type:String,readOnly:!0,json:{read:{source:`store.rootNode`}}})],P.prototype,`rootNode`,void 0),P=f([s(`esri.layers.mixins.SceneService`)],P),P},O=-1e38;function k(e){if(e.spatialReference!=null)return i.fromJSON(e.spatialReference);let t=e.store,n=t.indexCRS||t.geographicCRS,r=n&&parseInt(n.slice(n.lastIndexOf(`/`)+1),10);return r==null?null:new i(r)}function A(t,n){if(n?.center==null||n.halfSize==null)throw new e(`sceneservice:invalid-node-page`,`Invalid node page.`);if(n.center[0]<O)return;let r=n.halfSize,i=n.center[2],a=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);t.zmin=i-a,t.zmax=i+a}function j(e,t,n){e.typeKeywords||=[];let r=t.getTypeKeywords();for(let t of r)e.typeKeywords.push(t);e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((e,t,n)=>n.indexOf(e)===t),n===1&&(e.typeKeywords=e.typeKeywords.filter(e=>e!==`Hosted Service`)))}var M=`Scene Service`,N={getTypeKeywords:()=>[],portalItemLayerType:`unknown`,validationOptions:{enabled:!0,ignoreUnsupported:!1,failPolicy:`throw`}};export{D as n,w as r,A as t};