import{$T as e,AD as t,Af as n,Bf as r,CE as i,DD as a,ED as o,En as s,If as c,Lx as l,bd as u,hf as d,hv as f,kp as p,pT as m,uf as h,wD as g,yf as _}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import"./WhereClause-CATd9kVz.js";import"./closestPointOnCurve-CwZL45U3.js";import{n as v}from"./QueueProcessor-D6ozkjY6.js";import"./bundle-DgRwUxDT.js";import"./WhereClauseCache-BO4WYMj9.js";import"./QueryEngineCapabilities-CxeEdoTy.js";import{r as y}from"./clientSideDefaults-Iizf0eUh.js";import"./generateRendererUtils-DGV_dTnd.js";import"./utils-DCGMUq-q.js";import"./timeSupport-vK4lVcYW.js";import{n as b,r as x,t as S}from"./QueryEngine-CD8WljsT.js";import"./queryUtils-DGU5ISbw.js";import"./utils-Bftaersa.js";import"./utils-BizEctJo.js";import"./SnappingCandidate-4DPnOY6Y.js";import"./FixedIntervalBinParameters-CMgMaWGN.js";import"./locationUtils-DIRJcjU5.js";import{a as C,i as w,o as T,r as E,t as D}from"./parquetUtils-C6neaXu0.js";import{i as O,n as k,t as A}from"./parquet-CCCEcOEs.js";import"./labelPoint-1O-zXr9b.js";import{i as j}from"./callExpressionWithCursor-CKz4lb1p.js";import{i as M,n as N,t as P}from"./FeatureSetReaderParquet-qX-RVCae.js";import{t as F}from"./FeatureMetadata-rc_NIaUe.js";function I(e){switch(e.type){case`wkb`:return C.fromJSON(e);case`location`:return T.fromJSON(e)}}var L=new j,R=4,z=`__OBJECTID`,B=class{constructor(){this._fileInfos=new Map,this._queue=new v({concurrency:R,process:(e,t)=>this._executeQuery(e,t)})}async load(o){let d=o.spatialReference?l.fromJSON(o.spatialReference):void 0;if(d&&!d.isWGS84&&!d.isWebMercator)throw new e(`parquet:unsupported-projection`,`Only WGS84 and Web Mercator are supported`);let p=await E({urls:new f(o.urls),fields:o.fields?.map(e=>u.fromJSON(e)),geometryEncoding:o.geometryEncoding?I(o.geometryEncoding):null,geometryType:o.geometryType?w(o.geometryType):null,displayOptimization:o.displayOptimization,spatialReference:d},{customParameters:o.customParameters});if(!p.fields)throw new e(`parquet:unsupported`,`Fields must be defined`);let m;if(p.spatialReference&&p.geometryType){if(!p.spatialReference)throw new e(`parquet:unsupported`,`SpatialReference must be defined`);if(!p.spatialReference.isGeographic&&!p.spatialReference.isWebMercator)throw new e(`parquet:unsupported-projection`,`Only WGS84 and Web Mercator are supported`);p.spatialReference.isGeographic&&!p.spatialReference.isWGS84&&(i.getLogger(`parquet:unsupported-projection`).warn(`Found a geographic projection that is not WGS84. Handling as WGS84.`,{spatialReference:p.spatialReference}),p.spatialReference=l.WGS84),m={geometry:p.geometryEncoding?{geometryType:D(p.geometryType),spatialReference:p.spatialReference.toJSON(),encoding:p.geometryEncoding.toJSON()}:null,displayOptimization:p.displayOptimization}}this.setCustomParameters(o.customParameters),this._geometryInfo=m;let h=o.urls;for(let e of h){let t=await k(e,{geometryInfo:m,getCustomParameters:()=>this._customParameters});this._fileInfos.set(e,{index:this._fileInfos.size,file:t})}this._capabilities=K(this.getFileStatistics());let g=this._fileInfos.values().next().value?.file;if(!g)return{layerDefinition:{},capabilities:K(null)};let{fields:v}=p;if(v==null)throw new e(`parquet-layer:missing-metadata`,`Unable to create parquet source: cannot infer fields`,v);v.push(new u({name:z,type:`oid`,alias:z}));let b={fields:v.map(e=>({...e.toJSON(),column:g.columnForFieldName(e.name)})),timeZoneByFieldName:null};this._fieldsIndex=s.fromJSON(b);let x=D(p.geometryType??`point`);if(this._metadata=F.createFeature({fieldsIndex:b,geometryType:x,featureIdInfo:{type:`object-id`,fieldName:`rowId`},subtypes:null,subtypeField:null,types:null,typeIdField:null,globalIdField:null,spatialReference:p.spatialReference,outSpatialReference:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null}),this._queryEngineParams={fieldsIndex:this._metadata.fieldsIndex,geometryType:x,featureIdInfo:{type:`object-id`,fieldName:`rowId`},hasM:!1,hasZ:!1,spatialReference:p.spatialReference?.toJSON()??{wkid:4326},aggregateAdapter:null,timeInfo:null,definitionExpression:null},p.spatialReference&&(this._fullExtent=G(this._fileInfos.values(),p.spatialReference.toJSON())),this._fullExtent==null&&p.geometryEncoding?.type===`location`){let{xField:e,yField:i}=p.geometryEncoding,o=c(n(),_);for(let n of this._fileInfos.values())for(let s of n.file.rowGroups()){let n={stack:[],error:void 0,hasError:!1};try{let t=a(n,s.columnDescriptorForAttribute(e),!1),c=a(n,s.columnDescriptorForAttribute(i),!1),l=[t.minValue(),c.minValue(),t.maxValue(),c.maxValue()];r(o,l),s.free()}catch(e){n.error=e,n.hasError=!0}finally{t(n)}}this._fullExtent={xmin:o[0],ymin:o[1],xmax:o[3],ymax:o[4],spatialReference:p.spatialReference?.toJSON()}}return{capabilities:this._capabilities,layerDefinition:{fields:p.fields?.map(e=>e.toJSON()),drawingInfo:y(x),extent:this._fullExtent??void 0,geometryType:x,geometryEncoding:p.geometryEncoding?.toJSON(),displayOptimization:p.displayOptimization}}}destroy(){for(let e of this._fileInfos.values())e.file.free();this._fileInfos.clear(),this._queue.destroy()}setCustomParameters(e){this._customParameters=e}getFileStatistics(){if(!this._fileInfos.size)return null;let e=Array.from(this._fileInfos.values()).reduce((e,t)=>e+t.file.byteLength(),0);return{featureCount:this._getFeatureCount(),byteLength:e}}async updateFiles(e){let t=new Set(e);for(let[e,n]of this._fileInfos.entries())t.has(e)?t.delete(e):(n.file.free(),this._fileInfos.delete(e));for(let e of t){let t=await k(e,{geometryInfo:this._geometryInfo,getCustomParameters:()=>this._customParameters});this._fileInfos.set(e,{index:this._fileInfos.size,file:t})}}async queryFeatures(e,t){return this._validateQuery(e),q(e)||(e.resultRecordCount=e.resultRecordCount?Math.min(e.resultRecordCount,8e3):8e3,e.resultOffset=e.resultOffset??0),(e.outStatistics||e.returnDistinctValues)&&delete e.returnGeometry,(await this._enqueueQuery(e,t)).createQueryResponse()}async queryFeatureCount(e,t){return this._validateQuery(e),V(e)?(delete e.outFields,delete e.returnGeometry,(await this._enqueueQuery(e,t)).createQueryResponseForCount()):this._getFeatureCount()}async queryObjectIds(e,t){return this._validateQuery(e),V(e)?(e.resultRecordCount=e.resultRecordCount?Math.min(e.resultRecordCount,8e3):8e3,e.resultOffset=e.resultOffset??0,delete e.returnGeometry,delete e.outFields,(await this._enqueueQuery(e,t)).items.map(e=>e.getObjectId())):Array.from({length:this._getFeatureCount()},(e,t)=>t)}async queryExtent(e,t){if(this._validateQuery(e),this._fullExtent&&!V(e))return{count:this._getFeatureCount(),extent:this._fullExtent};let r=g(this._metadata.spatialReference);e.returnGeometry=!0,delete e.outFields;let i=c(n(),_),a=n(),o=await this._enqueueQuery(e,t),s=0;for(let e of o.items)e.getBounds(a)&&(d(i,a),s+=1);return{count:s,extent:b(i,r,e.outSR?g(e.outSR):r,r,!1)}}_getFeatureCount(){return Array.from(this._fileInfos.values()).reduce((e,t)=>e+t.file.numRows(),0)}_validateQuery(t){if(!this._capabilities.query.supportsStatistics&&t.outStatistics)throw new e(`parquet:unsupported`,`Statistics queries are not supported`,{query:t});if(!this._capabilities.query.supportsOrderBy&&t.orderByFields?.length)throw new e(`parquet:unsupported`,`Queries using orderBy are not supported`,{query:t});if(!this._capabilities.query.supportsDistinct&&t.returnDistinctValues)throw new e(`parquet:unsupported`,`Queries using returnDistinctValues are not supported`,{query:t})}async*_fetchChunks(e,t){let n=await O();for(let r of this._fileInfos.values()){let i=n.Query.new();i.setOutFields(e.fields),i.setReturnGeometry(e.returnGeometry);let a=await r.file.executeQuery(i),o=[],s=a.next(t);for(let e=0;e<R;e++)o.push(a.next(t));let c=await s;for(;c!=null;){m(t);let e=new P(this._metadata,this._fieldsIndex,c,r.index),n=U([new M(e,null,0,!1)],this._queryEngineParams),i=o.shift();o.push(a.next(t)),yield n,c=await i}}}_enqueueQuery(e,t){return this._queue.push(e,t)}async _executeQuery(e,t){let n=await this._getReadParams(e),r=await O();if(e.objectIds?.length)for(let i of this._fileInfos.values()){let a=r.Query.new();a.setOutFields(n.fields),a.setReturnGeometry(n.returnGeometry),a.setIds(new Uint32Array(e.objectIds));let o=await i.file.executeQuery(a,t),s=await o.next(t),c=0,l=[];for(;s!=null;){let e=new P(this._metadata,this._fieldsIndex,s,i.index),n=new M(e,null,c++,!1);l.push(n),s=await o.next(t)}let u=[],d=U(l,this._queryEngineParams),f=await d.executeQueryForOpaqueFeatures(e,t);for(let e of f)u.push(e);return new x(u,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:`rowId`,hasM:!1,hasZ:!1,featureAdapter:L})}let i=e.resultRecordCount??this._getFeatureCount(),a=e.resultOffset??0;delete e.resultRecordCount,delete e.resultOffset;let o=[];for await(let r of this._fetchChunks(n,t)){let n=await r.executeQueryForOpaqueFeatures(e,t);if(n.length>a){let t=n.slice(a,Math.min(a+i,n.length));for(let e of t)o.push(e);if(a=0,i-=t.length,i===0)return new x(o,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:`rowId`,hasM:!1,hasZ:!1,featureAdapter:L})}else a-=n.length}return new x(o,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:`rowId`,hasM:!1,hasZ:!1,featureAdapter:L})}async _getReadParams(e){let t=new Set;if(e.where&&await p(t,this._fieldsIndex,e.where),e.outStatistics)for(let n of e.outStatistics)n.onStatisticField!=null&&t.add(n.onStatisticField);if(e.outFields)for(let n of e.outFields)t.add(n);return{fields:(t.has(`*`)?this._fieldsIndex.fields.map(e=>e.name):Array.from(t)).filter(e=>this._fieldsIndex.get(e)?.column!=null),returnGeometry:!!e.returnGeometry||!!e.geometry}}};function V(e){return Object.keys(e).some(e=>H(e))}function H(e){switch(e){case`resultOffset`:case`resultRecordCount`:case`aggregateIds`:case`distance`:case`gdbVersion`:case`geometry`:case`having`:case`timeExtent`:case`where`:case`objectIds`:case`historicMoment`:return!0;default:return!1}}function U(e,t){let n=new N;for(let t of e)n.insert(t);return new S({...t,featureStore:n})}function W(t){switch(t.length){case 4:return h(n(),t);case 6:return t;default:throw new e(`parquet:protocol-violation`,`Invalid Geoparquet file. BoundingBox size must be 4 or 6.`,{bbox:t})}}function G(e,t){let r=c(n(),_);for(let t of e){let e=A(t.file);if(!e)return null;let n=e.columns[e.primary_column];if(!n.bbox)return null;let i=W(n.bbox);d(r,i)}return{xmin:r[0],ymin:r[1],xmax:r[3],ymax:r[4],spatialReference:t}}function K(e){let t=e?.featureCount,n=!1;return t!=null&&t<o(`parquetlayer-full-query-feature-count`)&&(n=!0),{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,isBranchVersioned:!1,supportedCurveTypes:[],supportsAttachment:!1,supportsM:!1,supportsTrueCurve:!1,supportsZ:!1},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryBins:!1,supportsQueryPivot:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},query:{maxRecordCount:8e3,maxRecordCountFactor:void 0,maxUniqueIDCount:void 0,standardMaxRecordCount:void 0,supportsCacheHint:!1,supportsCentroid:!0,supportsCentroidOnDegeneratedQuantizedGeometry:!1,supportsCurrentUser:!1,supportsDegeneratedQuantizedGeometry:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:n,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:n,supportsPagination:!0,supportsPaginationOnAggregatedQueries:!1,supportsPercentileStatistics:!1,supportsQuantization:!0,supportsQuantizationEditMode:!1,supportsQueryByAnonymous:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsReturnMesh:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsStatistics:n,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsCompactGeometry:!1,supportsSqlExpression:!1,supportsTrueCurve:!1,tileMaxRecordCount:void 0},queryAttributeBins:{supportsDate:!1,supportsFixedInterval:!1,supportsAutoInterval:!1,supportsFixedBoundaries:!1,supportsStackBy:!1,supportsSplitBy:!1,supportsSnapToData:!1,supportsReturnFullIntervalBin:!1,supportsFirstDayOfWeek:!1,supportsNormalization:!1},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsTrueCurveUpdate:!1,supportsTrueCurveUpdateByTrueCurveClientsOnly:!0,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUploadWithItemId:!1,supportsUpdateWithoutM:!1,supportsAsyncApplyEdits:!1,zDefault:void 0}}}function q(e){return!!(e.objectIds?.length||e.outStatistics||e.orderByFields?.length||e.returnDistinctValues)}export{B as default};