const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/mediaLayerUtils-DF0gJB_K.js","assets/index-BN8X5Ryz.js","assets/index-CWJhHB6-.css","assets/originUtils-CJnuu7mB.js","assets/utils-BnryXVma.js","assets/saveUtils-CEfw3trS.js","assets/resourceUtils-Bt8ctqoA.js","assets/resourceUtils-t_8WR2aj.js"])))=>i.map(i=>d[i]);
import{$S as e,$T as t,$h as n,A as r,AS as i,BT as a,Bv as o,CE as s,Eb as c,Ex as l,FC as u,Fb as d,Gu as f,HT as p,Kg as ee,L as te,LC as ne,Lx as m,M as re,Ng as h,OC as ie,Ow as ae,Qh as oe,RC as g,Rh as se,Ry as _,ST as ce,Sx as le,UT as v,Ua as ue,Uu as y,VT as b,Vg as de,WT as x,XC as fe,YC as pe,Yl as me,ZS as he,Zh as ge,bb as S,dC as _e,dg as C,es as ve,fC as ye,gw as be,hv as w,ih as xe,iw as Se,ix as Ce,jC as we,kD as T,kg as Te,lh as Ee,pC as De,pT as Oe,pv as ke,qb as Ae,rw as je,tT as Me,tb as Ne,tg as Pe,ua as Fe,uw as Ie,vv as Le,vx as E,ww as Re,zC as ze,zy as Be}from"./index-BN8X5Ryz.js";import"./PooledRBush-BH7_Gu1G.js";import{t as Ve}from"./BoundsStore-DE7p6f_c.js";import{i as He,n as D,o as Ue,r as We,s as O,t as Ge}from"./MediaElementView-bd5xETBn.js";import{t as k}from"./ControlPoint-CrbdjHAy.js";import"./normalizeUtilsSync-TXjrdJAe.js";import{t as Ke}from"./videoUtils-CRYmuPNe.js";var A=class extends ae{projectOrWarn(e,t){if(e==null)return e;let{geometry:n,pending:r}=h(e,t);return r?null:r||n?n:(s.getLogger(this).warn(`geometry could not be projected to the spatial reference`,{georeference:this,geometry:e,sourceSpatialReference:e.spatialReference,targetSpatialReference:t}),null)}};A=T([b(`esri.layers.support.GeoreferenceBase`)],A);var j=_(),M=y(),N=class extends Se{};T([a({type:Number,json:{write:{isRequired:!0}}})],N.prototype,`x`,void 0),T([a({type:Number,json:{write:{isRequired:!0}}})],N.prototype,`y`,void 0),N=T([b(`esri.layers.support.ControlPointsGeoreference.ControlPointJSONType`)],N);var P=class extends je(A){constructor(e){super(e),this.height=0,this.type=`control-points`,this.width=0}get controlPoints(){return this._get(`controlPoints`)??null}set controlPoints(e){this._set(`controlPoints`,e)}readControlPoints(e,t){let n=m.fromJSON(t.spatialReference),r=Be(...t.coefficients,1);return e.map(e=>(d(M,e.x,e.y),O(M,M,r),{sourcePoint:e,mapPoint:new l({x:M[0],y:M[1],spatialReference:n})}))}writeControlPoints(e,n,r,i){if(this.transform==null){let e=new t(`web-document-write:invalid-georeference`,`Invalid 'controlPoints', 'width', 'height' configuration. Make sure the parent media element is loaded i.e. the ImageElement or VideoElement set as 'MediaLayer.source'.`,{layer:i?.layer,georeference:this});i?.messages?i.messages.push(e):s.getLogger(this).error(e.name,e.message);return}e!=null&&F(e[0])&&(n.controlPoints=e.map(e=>{let t=e.sourcePoint;return{x:t.x,y:t.y}}),n.spatialReference=e[0].mapPoint.spatialReference.toJSON(),n.coefficients=this.transform.slice(0,8))}get coords(){if(this.controlPoints==null)return null;let e=this._updateTransform(j);if(e==null||!F(this.controlPoints[0]))return null;let t=this.controlPoints[0].mapPoint.spatialReference;return et(e,this.width,this.height,t)}set coords(e){if(this.controlPoints==null||!F(this.controlPoints[0]))return;let t=this.controlPoints[0].mapPoint.spatialReference;if((e=this.projectOrWarn(e,t))==null)return;let{width:n,height:r}=this,{rings:[[i,a,o,s]]}=e,c=new k({sourcePoint:C(0,r),mapPoint:new l({x:i[0],y:i[1],spatialReference:t})}),u=new k({sourcePoint:C(0,0),mapPoint:new l({x:a[0],y:a[1],spatialReference:t})}),f=new k({sourcePoint:C(n,0),mapPoint:new l({x:o[0],y:o[1],spatialReference:t})}),p=new k({sourcePoint:C(n,r),mapPoint:new l({x:s[0],y:s[1],spatialReference:t})});F(c)&&F(u)&&F(f)&&F(p)&&(Ye(j,c,u,f,p),this.controlPoints=this.controlPoints.map(({sourcePoint:e})=>(d(M,e.x,e.y),O(M,M,j),{sourcePoint:e,mapPoint:new l({x:M[0],y:M[1],spatialReference:t})})))}get inverseTransform(){return this.transform==null?null:Ne(_(),this.transform)}get transform(){return this._updateTransform()}toMap(e){if(e==null||this.transform==null||this.controlPoints==null||!F(this.controlPoints[0]))return null;d(M,e.x,e.y);let t=this.controlPoints[0].mapPoint.spatialReference;return O(M,M,this.transform),new l({x:M[0],y:M[1],spatialReference:t})}toSource(e){if(e==null||this.inverseTransform==null||this.controlPoints==null||!F(this.controlPoints[0]))return null;let t=this.controlPoints[0].mapPoint.spatialReference;return e=e.normalize(),(e=h(e,t).geometry)==null?null:(d(M,e.x,e.y),O(M,M,this.inverseTransform),C(M[0],M[1]))}toSourceNormalized(e){let t=this.toSource(e);return t!=null&&(t.x/=this.width,t.y/=this.height),t}_updateTransform(e){let{controlPoints:t,width:n,height:r}=this;if(!(t!=null&&n>0&&r>0))return null;let[i,a,o,s]=t;if(!F(i))return null;let c=i.mapPoint.spatialReference,l=this._projectControlPoint(a,c),u=this._projectControlPoint(o,c),d=this._projectControlPoint(s,c);if(!l.valid||!u.valid||!d.valid||!F(l.controlPoint))return null;e??=_();let f=null;return f=F(u.controlPoint)&&F(d.controlPoint)?Ye(e,i,l.controlPoint,u.controlPoint,d.controlPoint):F(u.controlPoint)?Je(e,i,l.controlPoint,u.controlPoint):qe(e,i,l.controlPoint),f.every(e=>e===0)?null:f}_projectControlPoint(e,t){if(!F(e))return{valid:!0,controlPoint:e};let{sourcePoint:n,mapPoint:r}=e,{geometry:i,pending:a}=h(r,t);return a?{valid:!1,controlPoint:null}:a||i?{valid:!0,controlPoint:new k({sourcePoint:n,mapPoint:i})}:(s.getLogger(this).warn(`map point could not be projected to the spatial reference`,{georeference:this,controlPoint:e,sourceSpatialReference:r.spatialReference,targetSpatialReference:t}),{valid:!1,controlPoint:null})}};function F(e){return e?.sourcePoint!=null&&e.mapPoint!=null}T([a({type:[k],json:{write:{allowNull:!1,isRequired:!0,target:{controlPoints:{type:[N],isRequired:!0},coefficients:{type:[Number],isRequired:!0},spatialReference:{type:m,isRequired:!0}}}}})],P.prototype,`controlPoints`,null),T([x(`controlPoints`)],P.prototype,`readControlPoints`,null),T([v(`controlPoints`)],P.prototype,`writeControlPoints`,null),T([a({clonable:!1})],P.prototype,`coords`,null),T([a({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],P.prototype,`height`,void 0),T([a({readOnly:!0})],P.prototype,`inverseTransform`,null),T([a({readOnly:!0})],P.prototype,`transform`,null),T([a({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],P.prototype,`width`,void 0),P=T([b(`esri.layers.support.ControlPointsGeoreference`)],P);var I=y(),L=y(),R=y(),z=y(),B=y(),V=y(),H=y(),U=y(),W=Math.PI/2;function G(e,t,n){d(e,n.sourcePoint.x,n.sourcePoint.y),d(t,n.mapPoint.x,n.mapPoint.y)}function qe(e,t,n){return G(I,B,t),G(L,V,n),S(R,L,I,W),S(z,I,L,W),S(H,V,B,-W),S(U,B,V,-W),$e(e,I,L,R,z,B,V,H,U)}function Je(e,t,n,r){return G(I,B,t),G(L,V,n),G(R,H,r),c(z,I,L,.5),S(z,R,z,Math.PI),c(U,B,V,.5),S(U,H,U,Math.PI),$e(e,I,L,R,z,B,V,H,U)}function Ye(e,t,n,r,i){return G(I,B,t),G(L,V,n),G(R,H,r),G(z,U,i),$e(e,I,L,R,z,B,V,H,U)}var Xe=Array(8).fill(0),Ze=Array(8).fill(0);function Qe(e,t,n,r,i){return e[0]=t[0],e[1]=t[1],e[2]=n[0],e[3]=n[1],e[4]=r[0],e[5]=r[1],e[6]=i[0],e[7]=i[1],e}function $e(e,t,n,r,i,a,o,s,c){return Ue(e,Qe(Xe,t,n,r,i),Qe(Ze,a,o,s,c))}function et(e,t,n,r){let i=f(0,n),a=f(0,0),s=f(t,0),c=f(t,n);return O(i,i,e),O(a,a,e),O(s,s,e),O(c,c,e),new o({rings:[[i,a,s,c,i]],spatialReference:r})}var K=y(),q=class extends A{constructor(e){super(e),this.bottomLeft=null,this.bottomRight=null,this.topLeft=null,this.topRight=null,this.type=`corners`}get coords(){let{topLeft:e,topRight:t,bottomLeft:n,bottomRight:r}=this;if(e==null||t==null||n==null||r==null)return null;let i=e.spatialReference;return t=this.projectOrWarn(t,i),n=this.projectOrWarn(n,i),r=this.projectOrWarn(r,i),t==null||n==null||r==null?null:new o({rings:[[[n.x,n.y],[e.x,e.y],[t.x,t.y],[r.x,r.y],[n.x,n.y]]],spatialReference:i})}set coords(e){let{topLeft:t}=this;if(t==null)return;let n=t.spatialReference;if((e=this.projectOrWarn(e,n))==null)return;let{rings:[[r,i,a,o]]}=e;this.bottomLeft=new l({x:r[0],y:r[1],spatialReference:n}),this.topLeft=new l({x:i[0],y:i[1],spatialReference:n}),this.topRight=new l({x:a[0],y:a[1],spatialReference:n}),this.bottomRight=new l({x:o[0],y:o[1],spatialReference:n})}toSourceNormalized(e){let{topLeft:t,topRight:n,bottomRight:r,bottomLeft:i}=this;if(e==null||t==null||n==null||r==null||i==null)return null;let a=t.spatialReference;e=e.normalize();let o=h(e,a).geometry;if(o==null)return null;d(K,o.x,o.y);let s=Ue(_(),[t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y],[0,0,0,1,1,0,1,1]);return O(K,K,s),C(K[0],K[1])}};T([a({clonable:!1})],q.prototype,`coords`,null),T([a({type:l})],q.prototype,`bottomLeft`,void 0),T([a({type:l})],q.prototype,`bottomRight`,void 0),T([a({type:l})],q.prototype,`topLeft`,void 0),T([a({type:l})],q.prototype,`topRight`,void 0),q=T([b(`esri.layers.support.CornersGeoreference`)],q);var tt=q,J=class extends A{constructor(e){super(e),this.extent=null,this.rotation=0,this.type=`extent-and-rotation`}get coords(){if(this.extent==null)return null;let{xmin:e,ymin:t,xmax:n,ymax:r,spatialReference:i}=this.extent,a;if(this.rotation){let{x:i,y:o}=this.extent.center,s=nt(i,o,this.rotation);a=[s(e,t),s(e,r),s(n,r),s(n,t)],a.push(a[0])}else a=[[e,t],[e,r],[n,r],[n,t],[e,t]];return new o({rings:[a],spatialReference:i})}set coords(e){if(e==null||this.extent==null)return;let t=this.extent.spatialReference;if(e=this.projectOrWarn(e,t),e?.extent==null)return;let{rings:[[n,r,i]],extent:{center:{x:a,y:o}}}=e,s=Ie(Math.PI/2-Math.atan2(r[1]-n[1],r[0]-n[0])),c=nt(a,o,-s),[l,u]=c(n[0],n[1]),[d,f]=c(i[0],i[1]);this.extent=new E({xmin:l,ymin:u,xmax:d,ymax:f,spatialReference:t}),this.rotation=s}toSourceNormalized(e){let{extent:t,rotation:n}=this;if(e==null||t==null)return null;let{xmin:r,ymin:i,xmax:a,ymax:o,center:s,spatialReference:c}=t;e=e.normalize();let l=h(e,c).geometry;if(l==null)return null;let u=l.x,d=l.y;return n&&([u,d]=nt(s.x,s.y,-n)(u,d)),C(be(u,r,a,0,1),be(d,o,i,0,1))}};function nt(e,t,n){let r=Ae(n),i=Math.cos(r),a=Math.sin(r);return(n,r)=>[i*(n-e)+a*(r-t)+e,i*(r-t)-a*(n-e)+t]}T([a({clonable:!1})],J.prototype,`coords`,null),T([a({type:E})],J.prototype,`extent`,void 0),T([a({type:Number})],J.prototype,`rotation`,void 0),J=T([b(`esri.layers.support.ExtentAndRotationGeoreference`)],J);var rt=J;function it(e){return e?.type===`media`}function at(e,t){let n=ce(t);return it(e)&&!!e.portalItem&&n!=null&&n>3}function ot(e,t,n){if(!e||e.type===`control-points`)return e;let{coords:r}=e;if(r?.rings[0]?.length!==5)return null;let[i,a,o,s]=r.rings[0],{spatialReference:c}=r;return new P({controlPoints:[new k({mapPoint:new l({x:i[0],y:i[1],spatialReference:c}),sourcePoint:C(0,n)}),new k({mapPoint:new l({x:a[0],y:a[1],spatialReference:c}),sourcePoint:C(0,0)}),new k({mapPoint:new l({x:o[0],y:o[1],spatialReference:c}),sourcePoint:C(t,0)}),new k({mapPoint:new l({x:s[0],y:s[1],spatialReference:c}),sourcePoint:C(t,n)})],width:t,height:n})}function st(e,t,n){return{enabled:!at(n?.layer,n?.origin),ignoreOrigin:!0}}var ct={json:{name:`url`,type:String,write:{overridePolicy:st}}},lt={readOnly:!0,json:{read:!1,write:{target:`mediaType`,overridePolicy:st}}},ut={types:{key:`type`,base:A,typeMap:{"control-points":P,corners:tt,"extent-and-rotation":rt}},json:{types:{key:`type`,base:A,typeMap:{"control-points":P}},write:{overridePolicy:()=>({enabled:!0,ignoreOrigin:!0})}}},Y=class extends me(ue(oe)){constructor(e){super(e),this.georeference=null,this.opacity=1}readGeoreference(e){return P.fromJSON(e)}writeGeoreference(e,n,r,i){let a=i?.resources?.pendingOperations,o=()=>{let a=ot(this.georeference,this.contentWidth,this.contentHeight);if(a){if(e.type!==`control-points`&&s.getLogger(this).warn(`only georeference of type 'control-points' may be persisted. The georeference of type '${e.type}' has been automatically converted.`),a.controlPoints?.length!==4&&i?.messages)return void i.messages.push(new t(`property:unsupported`,`only 'control-points' georeference with 4 control points may be persisted.`));n[r]=a.write({},i)}};if(e.type!==`control-points`&&!this.loaded&&a)return n[r]={},void a.push(this.load().then(o));o()}get contentWidth(){return 0}get contentHeight(){return 0}toSource(e){let{georeference:t,contentWidth:n,contentHeight:r}=this;if(e==null||t==null||n===0||r===0)return null;let i=t.toSourceNormalized(e);return i==null?null:(i.x*=n,i.y*=r,i)}};T([a(ut)],Y.prototype,`georeference`,void 0),T([x(`georeference`)],Y.prototype,`readGeoreference`,null),T([v(`georeference`)],Y.prototype,`writeGeoreference`,null),T([a({json:{read:!1,write:!1}})],Y.prototype,`opacity`,void 0),Y=T([b(`esri.layers.support.MediaElementBase`)],Y);var dt,X=class extends Y{static{dt=He}constructor(e){super(e),this.animationOptions=null,this.content=null,this.image=null,this.type=`image`,this[dt]=!0,this.image=null}load(){let e=this.image;if(typeof e==`string`){let t=ve(e).then(e=>{this._set(`content`,e)});this.addResolvingPromise(t)}else if(e instanceof HTMLImageElement){let t=e.decode().then(()=>{this._set(`content`,e)});this.addResolvingPromise(t)}else e?this._set(`content`,e):this.addResolvingPromise(Promise.reject(new t(`image-element:invalid-image-type`,`Invalid image type`,{image:e})));return Promise.resolve(this)}get contentWidth(){return this.content==null?0:this.content instanceof HTMLImageElement?this.content.naturalWidth:this.content.width}get contentHeight(){return this.content==null?0:this.content instanceof HTMLImageElement?this.content.naturalHeight:this.content.height}readImage(e,t,n){return ye(t.url,n)}writeImage(e,t,n,r){if(e==null)return;let i=r?.portalItem,a=r?.resources;if(!i||!a)return void(typeof e==`string`&&(t[n]=_e(e,r)));let o=ft(e)?e:null;if(o){if(De(o)==null)return void(t[n]=o);let e=_e(o,{...r,verifyItemRelativeUrls:r?.verifyItemRelativeUrls?{writtenUrls:r.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},1);if(i&&e&&!ne(e))return a.toKeep.push({resource:i.resourceFromPath(e),compress:!1}),void(t[n]=e)}t[n]=`<pending>`,a.pendingOperations.push(pt(e).then(e=>{let r=ht(e,i);t[n]=r.itemRelativeUrl,a.toAdd.push({resource:r,content:{type:`blob`,blob:e},compress:!1,finish:e=>{this.image=e.url}})}))}};function ft(e){return typeof e==`string`&&!pe(e)&&!g(e)}async function pt(e){return typeof e==`string`?pe(e)?fe(e):(await he(e,{responseType:`blob`})).data:new Promise(t=>mt(e).toBlob(t))}function mt(e){if(e instanceof HTMLCanvasElement)return e;let t=e instanceof HTMLImageElement?e.naturalWidth:e.width,n=e instanceof HTMLImageElement?e.naturalHeight:e.height,r=document.createElement(`canvas`),i=r.getContext(`2d`);return r.width=t,r.height=n,e instanceof HTMLImageElement?i.drawImage(e,0,0,e.width,e.height):e instanceof ImageData&&i.putImageData(e,0,0),r}function ht(e,t){let n=Ee(),r=`${u(`media`,n)}.${xe({type:`blob`,blob:e})}`;return t.resourceFromPath(r)}T([a()],X.prototype,`animationOptions`,void 0),T([a({readOnly:!0})],X.prototype,`content`,void 0),T([a({readOnly:!0})],X.prototype,`contentWidth`,null),T([a({readOnly:!0})],X.prototype,`contentHeight`,null),T([a(ct)],X.prototype,`image`,void 0),T([x(`image`,[`url`])],X.prototype,`readImage`,null),T([v(`image`)],X.prototype,`writeImage`,null),T([a(lt)],X.prototype,`type`,void 0),X=T([b(`esri.layers.support.ImageElement`)],X);var gt,_t=Symbol(`canplay`),Z=class extends Y{static{gt=We}constructor(e){super(e),this.autoplay=!0,this.content=null,this.type=`video`,this[gt]=!0}load(){let e=this.video;return typeof e==`string`?this.addResolvingPromise(this._preProcessVideoUrl(e).then(async e=>{let t=document.createElement(`video`);return t.src=Te.sanitizeUrl(ze(e)),t.crossOrigin=`anonymous`,t.autoplay=this.autoplay,t.muted=!0,t.loop=!0,t.playsInline=!0,this._loadVideo(t).then(()=>{this._set(`content`,t)})})):e instanceof HTMLVideoElement?this.addResolvingPromise(this._loadVideo(e).then(()=>{this._set(`content`,e)})):this.addResolvingPromise(Promise.reject(new t(`video-element:invalid-video-type`,`Invalid video type`,{video:e}))),Promise.resolve(this)}get contentWidth(){return this.content?.videoWidth??0}get contentHeight(){return this.content?.videoHeight??0}get currentTime(){return this.content?.currentTime}set currentTime(e){if(!this.content)return;let t=Re(e,0,this.content.duration);`fastSeek`in this.content?this.content.fastSeek(t):this.content.currentTime=t,this.content.play().then(()=>{this.content?.pause()}).catch(()=>{})}get duration(){return this.content?.duration}set video(e){this.loadStatus===`not-loaded`?this._set(`video`,e):s.getLogger(this).error(`#video`,`video cannot be changed after the element is loaded.`)}writeVideo(e,n,r,i){if(!e)return void(i?.messages&&i.messages.push(new t(`video-element:unsupported-video`,`video source is missing`)));let a=vt(e)?e:null;if(!a)return void(i?.messages&&i.messages.push(new t(`video-element:unsupported-video`,`video source must be an absolute url`)));!ne(a)&&i?.blockedRelativeUrls&&i.blockedRelativeUrls.push(a);let o=ze(a);De(o)?i?.messages&&i.messages.push(new t(`video-element:unsupported-video`,`video source cannot be an item resource`)):n[r]=o}async _preProcessVideoUrl(e){if(ie(e))return we(e);try{return await he(e,{method:`head`}),e}catch{try{return we(e,!0)}catch{return e}}}async _loadVideo(e){e.crossOrigin!==`anonymous`&&(e.crossOrigin=`anonymous`,g(e.src)||(e.src=e.src));try{await Ke(e,e=>this.addHandles(e,_t)),this.autoplay&&await e.play().catch(e=>{throw console.error(e),e})}finally{this.removeHandles(_t)}}};function vt(e){return typeof e==`string`&&!pe(e)&&!g(e)}T([a()],Z.prototype,`autoplay`,void 0),T([a({readOnly:!0})],Z.prototype,`content`,void 0),T([a({readOnly:!0})],Z.prototype,`contentWidth`,null),T([a({readOnly:!0})],Z.prototype,`contentHeight`,null),T([a({type:Number})],Z.prototype,`currentTime`,null),T([a({type:Number})],Z.prototype,`duration`,null),T([a(ct)],Z.prototype,`video`,null),T([v(`video`)],Z.prototype,`writeVideo`,null),T([a(lt)],Z.prototype,`type`,void 0),Z=T([b(`esri.layers.support.VideoElement`)],Z);var yt={key:`type`,defaultKeyValue:`image`,base:Y,typeMap:{image:X,video:Z}},bt=w.ofType(yt),Q=class extends ge(n(Le)){constructor(e){super(e),this._index=new Ve,this._elementViewsMap=new Map,this._elementsIndexes=new Map,this._elementsChangedHandler=e=>{for(let t of e.removed){let e=this._elementViewsMap.get(t);this._elementViewsMap.delete(t),this._index.delete(e),this.removeHandles(e),e.destroy(),this.notifyChange(`fullExtent`)}let{spatialReference:t}=this;for(let n of e.added){if(this._elementViewsMap.get(n))continue;let e=new Ge({spatialReference:t,element:n});this._elementViewsMap.set(n,e);let r=ke(()=>e.coords,()=>this._updateIndexForElement(e,!1));this._updateIndexForElement(e,!0),this.addHandles(r,e)}this._elementsIndexes.clear(),this.elements.forEach((e,t)=>this._elementsIndexes.set(e,t)),this.emit(`refresh`)},this.elements=new bt}async load(e){if(Oe(e),!this.spatialReference){let e=this.elements.find(e=>e.georeference?.coords!=null);this._set(`spatialReference`,e?e.georeference.coords.spatialReference:m.WGS84)}return this._elementsChangedHandler({added:this.elements.items,removed:[]}),this.addHandles(this.elements.on(`change`,this._elementsChangedHandler)),this}destroy(){this._index.clear(),this._elementViewsMap.clear(),this._elementsIndexes.clear()}get elements(){return this._get(`elements`)}set elements(e){this._set(`elements`,Pe(e,this._get(`elements`),bt))}get fullExtent(){if(this.loadStatus===`not-loaded`)return null;let e=this._index.fullBounds;return e==null?null:new E({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:this.spatialReference})}set spatialReference(e){this.loadStatus===`not-loaded`?this._set(`spatialReference`,e):s.getLogger(this).error(`#spatialReference`,`spatialReference cannot be changed after the source is loaded.`)}async queryElements(e,t){await this.load(),await de(e.spatialReference,this.spatialReference,null,t);let n=i(e.spatialReference,this.spatialReference)?e:ee(e,this.spatialReference);if(!n)return[];let r=n.normalize(),a=[];for(let e of r)this._index.forEachInBounds(Ce(e),({normalizedCoords:t,element:n})=>{t!=null&&le(e,t)&&a.push(n)});return a.sort((e,t)=>this._elementsIndexes.get(e)-this._elementsIndexes.get(t)),a}hasElement(e){return this.elements.includes(e)}_updateIndexForElement(e,t){let n=e.normalizedBounds,r=this._index.has(e),i=n!=null;this._index.delete(e),i&&this._index.set(e,n),this.notifyChange(`fullExtent`),t||(r===i?this.emit(`change`,{element:e.element}):this.emit(`refresh`))}};T([a()],Q.prototype,`elements`,null),T([a({readOnly:!0})],Q.prototype,`fullExtent`,null),T([a()],Q.prototype,`spatialReference`,null),Q=T([b(`esri.layers.support.LocalMediaElementSource`)],Q);var $=class extends Fe(r(te(re(ue(se))))){constructor(t){super(t),this.effectiveSource=null,this.georeference=null,this.copyright=null,this.operationalLayerType=`MediaLayer`,this.spatialReference=null,this.type=`media`,this._debouncedSaveOperations=Me(async(t,n,r)=>{let{save:i,saveAs:a}=await e(async()=>{let{save:e,saveAs:t}=await import(`./mediaLayerUtils-DF0gJB_K.js`);return{save:e,saveAs:t}},__vite__mapDeps([0,1,2,3,4,5,6,7]));switch(t){case 0:return i(this,n);case 1:return a(this,r,n)}}),this.source=new Q}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}async _doLoad(e){await this.loadFromPortal({supportedTypes:[`Media Layer`]},e);let n=this.source;if(!n)throw new t(`media-layer:source-missing`,`Set 'MediaLayer.source' before loading the layer.`);let r=this._getSourceOverride(n,this.georeference);r&&(this.setAtOrigin(`source`,r,`web-map`),this.setAtOrigin(`source`,r,`web-scene`),n=r);let i=D(n)?new Q({elements:new w([n])}):n;this._set(`effectiveSource`,i),this.spatialReference&&(i.spatialReference=this.spatialReference),await i.load(e),this.spatialReference=i.spatialReference}destroy(){this.effectiveSource?.destroy(),this.effectiveSource!==this.source&&this.source?.destroy()}readGeoreference(e,t){return e&&`itemId`in t&&t.itemId?e:void 0}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}get loaded(){return super.loaded}get source(){return this._get(`source`)}set source(e){this.loadStatus!==`loaded`&&this.loadStatus!==`failed`?this._set(`source`,e):s.getLogger(this).error(`#source`,`source cannot be changed after the layer is loaded.`)}castSource(e){return e?Array.isArray(e)?new Q({elements:new w(e)}):e instanceof w?new Q({elements:e}):e:null}readSource(e,t,n){if(`itemId`in t&&t.itemId)return;let r=this._createSource(t);return r?.read(t,n),r}writeSource(e,n,r,i){if(e&&e instanceof Q){let n=e.elements.length;if(n!==1)return void(i?.messages&&i.messages.push(new t(`media-layer:unsupported-source`,`local media element source can only be persisted if it contains exactly one ImageElement, but it has ${n}.`)));e=e.elements.at(0)}D(e)?e.write(n,i):i?.messages&&(e?i.messages.push(new t(`media-layer:unsupported-source`,`only media elements of type 'ImageElement' or 'VideoElement' can be persisted`)):i.messages.push(new t(`media-layer:unsupported-source`,`the media layer is missing a source`)))}async save(e){return this._debouncedSaveOperations(0,e)}async saveAs(e,t){return this._debouncedSaveOperations(1,t,e)}_createSource(e){if(`mediaType`in e)switch(e.mediaType){case`image`:return new X;case`video`:return new Z}return null}_getSourceOverride(e,t){if(D(e)&&this.originIdOf(`source`)===3&&t&&(this.originIdOf(`georeference`)===5||this.originIdOf(`georeference`)===4)){let n=e.toJSON(),r=this._createSource(n);return r.read({...n},{origin:`portal-item`}),r.read({georeference:t},{origin:`web-map`}),r.read({georeference:t},{origin:`web-scene`}),r}return null}};T([a({readOnly:!0})],$.prototype,`effectiveSource`,void 0),T([a({readOnly:!0,json:{read:!1,write:!1,origins:{"web-document":{read:!0}}}})],$.prototype,`georeference`,void 0),T([x(`web-document`,`georeference`)],$.prototype,`readGeoreference`,null),T([a({type:String})],$.prototype,`copyright`,void 0),T([a({readOnly:!0})],$.prototype,`fullExtent`,null),T([a({type:[`MediaLayer`]})],$.prototype,`operationalLayerType`,void 0),T([a({type:[`show`,`hide`]})],$.prototype,`listMode`,void 0),T([a({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1,target:{url:{type:String},mediaType:{type:[`image`,`video`]},georeference:{type:P}},overridePolicy(e,t,n){return{enabled:!0,allowNull:!1,ignoreOrigin:at(this,n?.origin)&&D(e)&&!!e.georeference&&e.originIdOf(`georeference`)>3}}}}})],$.prototype,`source`,null),T([p(`source`)],$.prototype,`castSource`,null),T([x(`source`,[`url`])],$.prototype,`readSource`,null),T([v(`source`)],$.prototype,`writeSource`,null),T([a({type:m})],$.prototype,`spatialReference`,void 0),T([a({readOnly:!0})],$.prototype,`type`,void 0),$=T([b(`esri.layers.MediaLayer`)],$);var xt=$;export{xt as default};