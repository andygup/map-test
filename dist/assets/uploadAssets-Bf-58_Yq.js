import{$n as e,CE as t,ED as n,FC as r,Hn as i,Jn as a,Jw as o,Kw as s,Lg as c,Lx as l,Qn as u,TC as d,Vn as f,ZS as p,aC as m,iT as h,pT as g,qw as _,rE as v,sT as y,uh as b,vE as x}from"./index-BN8X5Ryz.js";import"./quatf64-D37SEdPg.js";import"./quat-C8PgLo31.js";import"./axisAngleDegrees-DzAS4tF-.js";import"./MeshTransform-BaPjlQwH.js";import{a as S,c as C,n as w,r as T,t as E}from"./External-C55iwtd6.js";import{c as D,d as O,f as ee,i as te,l as k,n as A,o as j,r as M,t as ne,u as re}from"./meshSpatialReferenceScaleUtils-wsPB6tEL.js";import{n as ie,t as ae}from"./meshFeatureAttributes-DdbGwu_X.js";var N={upload:{createFromFiles:.8,loadMesh:.2},uploadAssetBlobs:{prepareAssetItems:.9,uploadAssetItems:.1},uploadConvertibleSource:{uploadEditSource:.5,serviceAssetsToGlb:.5},uploadLocalMesh:{meshToAssetBlob:.5,uploadAssetBlobs:.5}};function P(e,t=e=>{},n){return new F(e,t,n)}var F=class{constructor(e,t=e=>{},n){if(this.onProgress=t,this.taskName=n,this._progressMap=new Map,this._startTime=void 0,this._timingsMap=new Map,typeof e==`number`){this._weights={};for(let t=0;t<e;t++){let n=t,r=1/e;this._weights[n]=r,this._progressMap.set(n,0)}}else this._weights=e;this.emitProgress()}emitProgress(){let e=0;for(let[t,n]of this._progressMap.entries())e+=n*this._weights[t];if(e===1&&n(`enable-feature:esri-3dofl-upload-timings`)){let e=Math.round(performance.now()-(this._startTime??0))/1e3;console.log(`${this.taskName} done in ${e} sec`);for(let[t,n]of this._timingsMap){let r=Math.round(n.end-n.start)/1e3,i=Math.round(r/e*100);console.log(this.taskName??`Task`,{stepKey:t,stepTime:r,relativeTime:i})}}this.onProgress(e)}setProgress(e,t){if(this._progressMap.set(e,t),n(`enable-feature:esri-3dofl-upload-timings`)){let n=performance.now();this._startTime??=n;let r=x(this._timingsMap,e,()=>({start:n,end:0}));t===1&&(r.end=n)}this.emitProgress()}simulate(e,t){return I(t=>this.setProgress(e,t),t)}makeOnProgress(e){return t=>this.setProgress(e,t)}};function I(e=e=>{},t=U){let n=performance.now();e(0);let r=setInterval(()=>{let r=performance.now()-n,i=1-Math.exp(-r/t);e(i)},H);return v(()=>{clearInterval(r),e(1)})}function L(e,t=z){return _(o(e*V/t))}function R(e,t=B){return _(o(e*V/t))}var z=10,B=10,V=8e-6,H=s(50),U=s(1e3),W=1e6,G=20*W,K=2e9,q=3;async function J({data:e,name:t,description:n},i,a){let o=null;try{let s=r(i,`uploads`),c=r(s,`info`),{data:l}=await p(c,{query:{f:`json`},responseType:`json`});g(a);let u=m(i),d=l.maxUploadFileSize*W,f=u?K:d,h=u?Math.min(G,d):G;if(e.size>f)throw Error(`Data too large`);let _=r(s,`register`),{data:v}=await p(_,{query:{f:`json`,itemName:oe(t),description:n},responseType:`json`,method:`post`});if(g(a),!v.success)throw Error(`Registration failed`);let{itemID:y}=v.item;o=r(s,y);let b=r(o,`uploadPart`),x=Math.ceil(e.size/h),S=[];for(let t=0;t<x;++t)S.push(e.slice(t*h,Math.min((t+1)*h,e.size)));let C=S.slice().reverse(),w=[],T=P(x,a?.onProgress,`uploadItem`),E=async()=>{for(;C.length!==0;){let e=S.length-C.length,t=C.pop(),n=new FormData,r=T.simulate(e,L(t.size));try{n.append(`f`,`json`),n.append(`file`,t),n.append(`partId`,`${e}`);let{data:r}=await p(b,{timeout:0,body:n,responseType:`json`,method:`post`});if(g(a),!r.success)throw Error(`Part upload failed`)}finally{r.remove()}}};for(let e=0;e<q&&C.length!==0;++e)w.push(E());await Promise.all(w);let D=r(o,`commit`),{data:O}=await p(D,{query:{f:`json`,parts:S.map((e,t)=>t).join(`,`)},responseType:`json`,method:`post`});if(g(a),!O.success)throw Error(`Commit failed`);return O.item}catch(e){if(o!=null){let e=r(o,`delete`);await p(e,{query:{f:`json`},responseType:`json`,method:`post`})}throw e}}function oe(e){return e.replaceAll(`/`,`_`).replaceAll(`\\`,`_`)}async function se(e,t,n){let r=e.length;if(!r)return n?.onProgress?.(1),[];let i=P(r,n?.onProgress,`uploadAssets`);return Promise.all(e.map((e,r)=>ce(e,t,{...n,onProgress:i.makeOnProgress(r)})))}async function ce(e,{layer:t,ongoingUploads:n},r){let i=n.get(e);if(i)return i;if(!Te(t))throw new re;if(le(e,t))return r?.onProgress?.(1),{mesh:e};let a=ue(e,t,r);n.set(e,a);try{return await a}finally{n.delete(e)}}function le(e,t){let{parsedUrl:n}=t;return n!=null&&e.metadata.externalSources.some(e=>w(e,n))}async function ue(e,t,n){let{metadata:r}=e,{displaySource:i}=r,a=Y(i?.source,t,{checkForConversionRequired:!0}),o=a==null?r.externalSources.length>0?fe(e,t,n):pe(e,t,n):de(e,a,t,n),{external:s,info:c}=await o;return g(n),e.addExternalSources([s]),c}async function de(e,t,n,r){return{external:{source:{type:`service`,assets:await X(t,n,r)},original:!0,unitConversionDisabled:!0},info:{mesh:e}}}async function fe(e,t,n){let r=$(t),{externalSources:i}=e.metadata,a=he(i,t);if(!a)throw new D;let o=P(N.uploadConvertibleSource,n?.onProgress,`uploadConvertibleSource`),s={type:`service`,assets:await X(a,t,{onProgress:o.makeOnProgress(`uploadEditSource`)})};e.addExternalSources([{source:s,original:!0}]);let l=a.reduce((e,{asset:t})=>t instanceof File?e+t.size:e,0),u=o.simulate(`serviceAssetsToGlb`,R(l));try{let{source:i,transform:a,origin:o}=await Se(s,t,r);if(e.transform=a,o&&n?.useAssetOrigin){let t=await c(o,e.spatialReference,n);e.vertexSpace.origin=[t.x,t.y,t.z??0]}return{external:{source:i,unitConversionDisabled:!0},info:{mesh:e,georeferenceInfo:o?{origin:o}:void 0}}}finally{u.remove()}}async function pe(e,t,n){let r=P(N.uploadLocalMesh,n?.onProgress,`uploadLocalMesh`),i=me(e,t,{...n,onProgress:r.makeOnProgress(`meshToAssetBlob`)});return{external:{source:{type:`service`,assets:await Z([i],t,{...n,onProgress:r.makeOnProgress(`uploadAssetBlobs`)})},extent:e.extent.clone(),original:!0},info:{mesh:e}}}async function me(e,t,n){let r=$(t),i=await e.load(n),a=await i.toBinaryGLTF({origin:i.origin,signal:n?.signal,ignoreLocalTransform:!0,unitConversionDisabled:!0});return g(n),{blob:new Blob([a],{type:`model/gltf-binary`}),assetName:`${b()}.glb`,assetType:r}}function he(e,t){for(let n of e){let e=Y(n.source,t);if(e)return e}return null}function Y(e,{infoFor3D:t},n={}){if(!e)return null;let r=E(e);if(!r)return null;let{supportedFormats:i,editFormats:o}=t,s=[],c=f(t),l=a(t),u=!1;for(let e of r){let t=ge(e,i);if(!t)return null;let{assetType:r}=t;if(n.checkForConversionRequired&&(r===c||r===l))return null;o.includes(r)&&(u=!0),s.push(t)}return u?s:null}function ge(e,t){let n=C(e,t);return n?{asset:e,assetType:n}:null}async function X(e,t,n){return Z(e.map(e=>_e(e,n)),t,n)}async function Z(e,t,n){let r=P(N.uploadAssetBlobs,n?.onProgress,`uploadAssetBlobs`),i=await ye(e,t,{...n,onProgress:r.makeOnProgress(`prepareAssetItems`)});g(n);let a=i.map(({item:e})=>e),{uploadResults:o}=await be(a,t,{...n,onProgress:r.makeOnProgress(`uploadAssetItems`)});return g(n),e.map((e,n)=>xe(i[n],o[n],t))}async function _e(e,t){let{asset:n,assetType:r}=e;if(n instanceof File)return{blob:n,assetName:n.name,assetType:r};let i=await n.toBlob(t);return g(t),{blob:i,assetName:n.assetName,assetType:r}}async function ve(e,t,n){let{blob:r,assetType:i,assetName:a}=e,o=null;try{let e=await J({data:r,name:a},t.url,n);g(n),o={assetType:i,assetUploadId:e.itemID}}catch(e){y(e),Ee().warnOnce(`Service ${t.url} does not support the REST Uploads API.`)}if(!o){let e=await d(r);if(g(n),!e.isBase64)throw new ee;o={assetType:i,assetData:e.data}}if(!o)throw new k;return{item:o,assetName:a}}function ye(e,t,n){let r=P(e.length,n?.onProgress,`prepareAssetItems`);return Promise.all(e.map(async(e,i)=>{let a=ve(await e,t,{...n,onProgress:r.makeOnProgress(i)});return g(n),a}))}async function be(e,t,n){let i=I(n?.onProgress);try{let i=await p(r(t.parsedUrl.path,`uploadAssets`),{timeout:0,query:{f:`json`,assets:JSON.stringify(e)},method:`post`,responseType:`json`});if(g(n),i.data.uploadResults.length!==e.length)throw new A(e.length,i.data.uploadResults.length);return i.data}finally{i.remove()}}function xe(e,t,n){let{success:r}=t;if(!r){let{error:n}=t;throw new te(e.assetName,n)}let{assetHash:i}=t,{assetName:a,item:{assetType:o}}=e,{infoFor3D:{supportedFormats:s}}=n,c=u(o,s);if(!c)throw new M(o);return new T(a,c,[new S(`${n.parsedUrl.path}/assets/${i}`,i)])}async function Se({assets:e},t,n){let i=e.map(({assetName:e,parts:t})=>({assetName:e,assetHash:t[0].partHash})),a;try{let e=r(t.parsedUrl.path,`convert3D`),o=t.capabilities?.operations.supportsAsyncConvert3D;a=(await(o?we:Ce)(e,{query:{f:`json`,assets:JSON.stringify(i),transportType:`esriTransportTypeUrl`,targetFormat:n,async:o},responseType:`json`,timeout:0})).data}catch{throw new j}return Q(t,a)}function Q(t,n){let r={source:{type:`service`,assets:n.assets.map(n=>{let r=e(n.contentType,t.infoFor3D.supportedFormats);if(!r)throw new M(r);return new T(n.assetName,n.contentType,[new S(n.assetURL,n.assetHash)])})},origin:void 0,transform:void 0};if(n.transform){if(r.transform=ae(n.transform),n.spatialReference){let e=l.fromJSON(n.spatialReference);r.origin=ie(n.transform,e)}}else r.transform=ne(t.spatialReference);return r}function Ce(e,t){return p(e,t)}async function we(e,t){let n=(await p(e,t)).data.statusUrl;for(;;){let e=(await p(n,{query:{f:`json`},responseType:`json`})).data;switch(e.status){case`Completed`:return p(e.resultUrl,{query:{f:`json`},responseType:`json`});case`CompletedWithErrors`:throw Error(e.status);case`Failed ImportChanges`:case`InProgress`:case`Pending`:case`ExportAttachments`:case`ExportChanges`:case`ExportingData`:case`ExportingSnapshot`:case`ImportAttachments`:case`ProvisioningReplica`:case`UnRegisteringReplica`:break;default:throw Error()}await h(De)}}function Te(e){return!!e.infoFor3D&&!!e.url}function $({infoFor3D:e}){let t=i(e);if(!t)throw new O;return t}function Ee(){return t.getLogger(`esri.layers.graphics.sources.support.uploadAssets`)}var De=s(1e3);export{se as uploadAssets};