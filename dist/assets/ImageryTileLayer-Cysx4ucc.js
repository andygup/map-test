const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/imageryUtils-CkENtvf8.js","assets/index-BN8X5Ryz.js","assets/index-CWJhHB6-.css","assets/originUtils-CJnuu7mB.js","assets/datasetUtils-QzMOwZxx.js","assets/utils-BnryXVma.js","assets/saveUtils-CEfw3trS.js"])))=>i.map(i=>d[i]);
import{$S as e,$T as t,A as n,Ag as r,BT as i,CE as a,CS as o,DT as s,Di as c,ED as l,Ex as u,L as d,Lx as f,M as p,Ni as m,O as h,Rh as g,Ua as _,VT as v,_ as y,ba as b,bd as x,ca as S,cp as C,ha as w,j as T,kC as E,kD as D,kw as O,lT as k,mE as A,mT as ee,pa as te,ph as ne,pv as re,sD as ie,sT as ae,tT as oe,tv as se,ua as ce,vx as j,xa as le,zi as ue}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./QueueProcessor-D6ozkjY6.js";import"./_commonjsHelpers-YBF0zzdz.js";import"./memoize-Dl61_jt0.js";import{o as de,p as fe,t as pe}from"./elevationInfoUtils-uoMH3ofe.js";import"./generateRendererUtils-DGV_dTnd.js";import{t as me}from"./TilemapCache-jwsQgZr5.js";import{p as he,t as ge}from"./multidimensionalUtils-CoDZYrcG.js";import{$ as _e,E as ve,G as ye,H as be,J as xe,K as Se,Q as Ce,T as M,W as we,X as Te,Y as Ee,Z as De,d as Oe,et as ke,g as Ae,m as je,q as Me}from"./RasterSymbolizer-C04g1f48.js";import{o as Ne,t as N}from"./PixelBlock-D0vUlFM9.js";import{f as Pe,m as Fe,p as Ie}from"./vectorFieldUtils-BkGOIhR4.js";import{t as Le,y as Re}from"./RasterJobHandlerMixin-v7ic83Yl.js";import"./colorUtils-CzajW9E7.js";import{a as ze,c as Be,d as Ve,f as He,i as Ue,o as We,p as Ge,t as Ke}from"./rasterFieldUtils-D1_HkZOo.js";import{n as qe,r as Je}from"./datasetUtils-QzMOwZxx.js";import"./cimSymbolUtils-CLt57XQ8.js";import"./utils-BGjabRH0.js";import{n as Ye,r as Xe,t as Ze}from"./RasterPresetRendererMixin-CKxP1IOk.js";import"./dataUtils-CwkEyGtp.js";import{t as Qe}from"./isImageryTileGraphicOrigin-C3baAvdY.js";import"./RawBlockCache-BzmVyUjy.js";import"./rasterProjectionHelper-BpX32CQ6.js";import{a as $e,c as P,d as et,f as F,l as I,n as L,o as R,r as tt,u as nt}from"./xmlUtilities-DflNPpCk.js";import"./clipUtils-D_rTuWN2.js";import{n as rt,t as it}from"./rasterFunctionHelper-CEhF_KcG.js";import{n as at,t as ot}from"./GCSShiftTransform-C8HefaDz.js";var st,ct=class extends b{get[(st=Qe,le)](){return this.layer}constructor(e){super(),this[st]=!0,this.type=`imagery-tile`,this.layer=e}get id(){return this.layer.id}};function lt(e){return[`x`,`e`,`east`,`long`,`longitude`].includes(e.toLowerCase())}function ut(e){return[`y`,`n`,`west`,`lat`,`latitude`].includes(e.toLowerCase())}function dt(e){let{axes:t}=e.domain,n=Object.keys(t),r=[],i=[],a=-1,o=-1,s=[];for(let e=0;e<n.length;e++){let c=n[e];lt(c)?a=e:ut(c)&&(o=e);let l=t[c],u=[];if(`values`in l){l.values.forEach(e=>u.push(typeof e==`string`?new Date(e).getTime():e));let e=u[1]-u[0];r.push([u[0]-.5*e,u[u.length-1]+.5*e]),i.push(e)}else{let{start:e,stop:t,num:n}=l,a=(t-e)/(n-1);r.push([e-.5*a,t+.5*a]),i.push(a);for(let t=0;t<n;t++)u.push(e+a*t)}s.push({name:c,values:u,extent:[u[0],u[u.length-1]]})}a>-1&&o===-1?o=a===0?1:0:o>-1&&a===-1?a=o===0?1:0:o===-1&&a===-1&&(a=0,o=1),s=s.filter((e,t)=>!(t===a||t===o));let{referencing:c}=e.domain,l=c.find(e=>e.coordinates.includes(n[a])).system.id,u=l?.slice(l.lastIndexOf(`/`)+1),d=u==null||u===`CRS84`?4326:Number(u),p=new f({wkid:d}),[m,h]=r[a],[g,_]=r[o],v=new j({xmin:m,xmax:h,ymin:g,ymax:_,spatialReference:p});return{width:Math.round(v.width/i[a]),height:Math.round(v.height/i[o]),extent:v,dimensions:s}}function ft(e){let t=se();return t?e[t]??Object.values(e)[0]:Object.values(e)[0]}function pt(){return Math.round(255*Math.random())}function mt(e){let t={},{parameters:n}=e;if(!n)return t;for(let[e,r]of Object.entries(n)){let{type:n,description:i,unit:a,categoryEncoding:o,observedProperty:s}=r;if(n===`Parameter`&&(t[e]={},i&&(t[e].description=ft(i)),a&&(t[e].unit=a.label?ft(a.label):null,t[e].symbol=a.symbol?.value),o)){let n=Object.entries(o).map((e,t)=>({OID:t,Value:Number(e[1]),ClassName:e[0].slice(e[0].lastIndexOf(`/`)+1),Count:1})),r=!1;s?.categories?.length&&(s.categories.forEach(e=>{if(!e.id)return;let t=e.id.slice(e.id.lastIndexOf(`/`)+1),i=n.find(e=>e.ClassName===t);if(i&&(i.Label=e.label?ft(e.label):null,e.preferredColor)){let t=ne.fromHex(e.preferredColor);t&&(r=!0,i.Red=t.r,i.Green=t.g,i.Blue=t.b)}}),r&&n.forEach(e=>{e.Red??(e.Red=pt(),e.Green=pt(),e.Blue=pt())}));let i={objectIdFieldName:``,fields:[{name:`OID`,type:`esriFieldTypeOID`,alias:`OID`,domain:null},{name:`Value`,type:`esriFieldTypeInteger`,alias:`Value`,domain:null},{name:`Count`,type:`esriFieldTypeDouble`,alias:`Count`,domain:null},{name:`ClassName`,type:`esriFieldTypeString`,alias:`ClassName`,domain:null,length:50},{name:`Label`,type:`esriFieldTypeString`,alias:`Label`,domain:null,length:50}],features:n.map(e=>({attributes:e}))};r&&i.fields.push({name:`Red`,type:`esriFieldTypeInteger`,alias:`Red`,domain:null},{name:`Green`,type:`esriFieldTypeInteger`,alias:`Green`,domain:null},{name:`Blue`,type:`esriFieldTypeInteger`,alias:`Blue`,domain:null}),t[e].attributeTable=i}}return t}function ht(e){let t=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let r=0;r<e.length;r++){let i=e[r];i!=null&&(i<t&&(t=i),i>n&&(n=i))}return Ne(t,n)}function gt(e,t,n){let r=e.map((e,n)=>({name:e,count:t[n]})).sort((e,t)=>e.name>t.name?-1:1),i=(a=1,e=>a*=e.count);var a;let o=[...r.slice(1),{name:``,count:1}].reverse().map(i).reverse(),s=0;for(let i=e.length-1;i>=0;i--)s+=o[r.findIndex(({name:t})=>t===e[i])]*(n%t[i]),n=Math.floor(n/t[i]);return s}function _t(e){let{width:t,height:n,extent:r,dimensions:i}=dt(e),{ranges:a}=e,o=Object.keys(a).sort((e,t)=>e<t?-1:1),s=[];for(let e=0;e<o.length;e++){let t=o[e];i?.length&&s.push({name:t,dimensions:i})}let c=mt(e);s.forEach(e=>c[e.name]&&Object.assign(e,c[e.name]));let l=s.length?{variables:s}:void 0,u=[];for(let e=0;e<o.length;e++){let r=o[e],{values:s,dataType:c,axisNames:l,shape:d}=a[r],f=d.length>2?e*d.slice(0,-2).reduce((e,t)=>e*t):0,p=l.slice(0,-2),m=d.slice(0,-2),h=c===`float`?`f32`:ht(s),g=t*n,_=s.length/g;for(let r=0;r<_;r++){let a=N.createEmptyBand(h,g),o=new Uint8Array(g).fill(255),c=!1,l=r*g;for(let e=0;e<g;e++){let t=s[l+e];t==null?(o[e]=0,c=!0):a[e]=t}if(e===0||i?.length){let e=new N({width:t,height:n,mask:c?o:null,pixels:[a],pixelType:h});e.updateStatistics(),i?.length?u[gt(p,m,r)+f]=e:u.push(e)}else{let e=u[r];e.pixels.push(a),c?e.mask&&=N.combineBandMasks([e.mask,o]):e.mask=c?o:null}}}let d=Object.values(c).find(e=>e.attributeTable)?.attributeTable;return{extent:r,pixelBlocks:u,multidimensionalInfo:l,attributeTable:d,bandNames:l?void 0:o}}var z=class extends F{constructor(){super(...arguments),this.datasetFormat=`MEMORY`,this.source=null}get url(){return``}fetchRawTile(e,t,n,r={}){if(!this._pixelBlockTiles){let{rasterInfo:i}=this,[a,o]=i.storageInfo.tileInfo.size,{sliceId:s}=r,{pixelBlocks:c}=this.source,l={pixelBlock:s==null?c[0]:c[s],useBilinear:i.dataType!==`thematic`,tileSize:{width:a,height:o},level:e,row:t,col:n},u=this.rasterJobHandler?this.rasterJobHandler.clipTile(l,r):Ie(l);return Promise.resolve(u)}let i=this._pixelBlockTiles.get(`${e}/${t}/${n}`);return Promise.resolve(i)}async _open(e){let t=this.source,{pixelBlocks:n,attributeTable:r,statistics:i,histograms:a,name:o,nativeExtent:s,transform:c,colormap:l}=t,u=n[0],{width:d,height:p,pixelType:m}=u,h=t.extent??new j({xmin:-.5,ymin:.5,xmax:d-.5,ymax:p-.5,spatialReference:new f({wkid:3857})}),g=t.isPseudoSpatialReference??!t.extent,_={x:h.width/d,y:h.height/p},v={...t.keyProperties};t.dataType&&(v.DataType=t.dataType),t.bandInfos&&(v.BandProperties=t.bandInfos.map(e=>e.toJSON())),r&&(v.DataType=`Thematic`);let y=new M({width:d,height:p,pixelType:m,extent:h,nativeExtent:s,attributeTable:r,colormap:l,transform:c,pixelSize:_,spatialReference:h.spatialReference,bandCount:u.pixels.length,keyProperties:v,multidimensionalInfo:t.multidimensionalInfo,statistics:i,isPseudoSpatialReference:g,histograms:a});this.ioConfig.skipMapInfo&&this.updateImageSpaceRasterInfo(y),this.createRemoteDatasetStorageInfo(y,512,512),this._set(`rasterInfo`,y),this.updateTileInfo(),y.multidimensionalInfo?await this._buildMDimStats(t.pixelBlocks,y.multidimensionalInfo):await this._buildInMemoryRaster(u,{width:512,height:512},e),y.multidimensionalInfo||(this.source=null),this.datasetName=o}async _buildInMemoryRaster(e,n,r){let{rasterInfo:i}=this,a=i.storageInfo.maximumPyramidLevel??0,o=i.dataType!==`thematic`,s=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:e,tileSize:n,maximumPyramidLevel:a,useBilinear:o},r):Promise.resolve(Fe(e,n,a,o)),c=i.statistics!=null,l=i.histograms!=null,u=this.ioConfig.skipStatistics||c?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:e},r):Promise.resolve(Ae(e)),d=await k([s,u]);if(!d[0].value&&d[1].value)throw new t(`inmemory-raster:open`,`failed to build in memory raster`);this._pixelBlockTiles=d[0].value,c||(i.statistics=d[1].value?.statistics),l||(i.histograms=d[1].value?.histograms)}async _buildMDimStats(e,t,n){for(let r=0;r<t.variables.length;r++){let i=t.variables[r];if(i.statistics)continue;let a=i.dimensions.map(e=>new he({variableName:i.name,dimensionName:e.name,values:[e.values?.[0]??e.extent?.[0]],isSlice:!0})),o=ge(a,t),s=o==null?null:e[o];if(s==null)continue;let c=this.rasterJobHandler?await this.rasterJobHandler.computeStatisticsHistograms({pixelBlock:s},n):Oe(s);i.statistics=c.statistics,i.histograms||=c.histograms}}};D([i({type:String,json:{write:!0}})],z.prototype,`datasetFormat`,void 0),D([i()],z.prototype,`source`,void 0),D([i()],z.prototype,`url`,null),z=D([v(`esri.layers.raster.datasets.InMemoryRaster`)],z);var vt=z,B=class extends F{constructor(){super(...arguments),this.datasetFormat=`CovJSON`}fetchRawTile(e,t,n,r={}){return this._inMemoryRaster.fetchRawTile(e,t,n,r)}async _open(e){let{extent:t,pixelBlocks:n,multidimensionalInfo:r,attributeTable:i,bandNames:a}=await this._fetchData(e),{statistics:o,histograms:s}=Oe(n[0]),c=a?.map(e=>({BandName:e})),l={DataType:i?`Thematic`:r?`Scientific`:`Generic`,BandProperties:c},u=new vt({source:{extent:t,pixelBlocks:n,attributeTable:i?w.fromJSON(i):null,multidimensionalInfo:r,statistics:o,histograms:s,keyProperties:l,isPseudoSpatialReference:!1}});await u.open(),this._inMemoryRaster=u;let d=this.source?``:this.url.slice(this.url.lastIndexOf(`/`)+1);this._set(`datasetName`,d.slice(0,d.indexOf(`.`))),this._set(`rasterInfo`,u.rasterInfo)}async _fetchData(e){let n=this.source??(await this.request(this.url,{signal:e?.signal})).data,r=`imagery-tile-layer:open-coverage-json`;if(n.type?.toLowerCase()!==`coverage`||n.domain?.domainType?.toLowerCase()!==`grid`)throw new t(r,`Only coverage with Grid domain type is supported`);if(!n.ranges)throw new t(r,`Missing ranges in the grid coverage data`);if(!n.domain.referencing?.length)throw new t(r,`Missing domain referencing in the grid coverage data`);let i=Object.values(n.ranges);for(let e=0;e<i.length;e++){let{axisNames:n,shape:a,type:o,values:s}=i[e];if(!(o.toLowerCase()===`ndarray`&&s?.length&&n?.length&&a?.length))throw new t(r,`Only ranges with valid NdArray, axisNames, shape, and inline values are supported`);if(!(lt(n[n.length-1])&&ut(n[n.length-2])))throw new t(r,`Only row-major ordered pixel values are supported. X axis must be the last axis.`)}return _t(n)}};D([i({type:String,json:{write:!0}})],B.prototype,`datasetFormat`,void 0),D([i({constructOnly:!0})],B.prototype,`source`,void 0),B=D([v(`esri.layers.raster.datasets.CovJSONRaster`)],B);var yt=B;function bt(e,t){if(!e||!t)return null;let n=[];for(let r=0;r<e.length;r++)n.push(e[r]),n.push(t[r]);return n}function xt(e){let t=L(e,`GeodataXform`),n=V(R(t,`SpatialReference/WKID`)||P(t,`SpatialReference/WKT`));if(t.getAttribute(`xsi:type`)!==`typens:PolynomialXform`)return{spatialReference:n,transform:null};let r=R(t,`PolynomialOrder`)??1,i=I(t,`CoeffX/Double`),a=I(t,`CoeffY/Double`),o=I(t,`InverseCoeffX/Double`),s=I(t,`InverseCoeffY/Double`),c=bt(i,a),l=bt(o,s);return{spatialReference:n,transform:c&&l&&c.length&&l.length?new at({spatialReference:n,polynomialOrder:r,forwardCoefficients:c,inverseCoefficients:l}):null}}function St(e){let t=R(e,`NoDataValue`),n=L(e,`Histograms/HistItem`),r=R(n,`HistMin`),i=R(n,`HistMax`),a=R(n,`BucketCount`),o=P(n,`HistCounts`)?.split(`|`).map(e=>Number(e)),s,c,l,u;$e(e,`Metadata/MDI`).forEach(e=>{let t=Number(e.textContent??e.nodeValue);switch(e.getAttribute(`key`).toUpperCase()){case`STATISTICS_MINIMUM`:s=t;break;case`STATISTICS_MAXIMUM`:c=t;break;case`STATISTICS_MEAN`:l=t;break;case`STATISTICS_STDDEV`:u=t}});let d=R(e,`Metadata/SourceBandIndex`);return{noDataValue:t,histogram:o?.length&&r!=null&&i!=null?{min:r,max:i,size:a||o.length,counts:o}:null,sourceBandIndex:d,statistics:s!=null&&c!=null?{min:s,max:c,avg:l,stddev:u}:null}}function V(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&t!==0)return new f({wkid:t});if(e=String(e).trim(),o(e))return new f({wkt2:e});let n=e.toUpperCase();if(n.startsWith(`COMPD_CS`)){if(!n.includes(`VERTCS`)||!n.includes(`GEOGCS`)&&!n.startsWith(`PROJCS`))return null;let r=n.indexOf(`VERTCS`),i=n.indexOf(`PROJCS`),a=i>-1?i:n.indexOf(`GEOGCS`);if(a===-1)return null;let o=e.slice(a,e.lastIndexOf(`]`,r)+1).trim(),s=e.slice(r,e.lastIndexOf(`]`)).trim();t=Ct(o);let c=new f(t?{wkid:t}:{wkt:o}),l=Ct(s);return l&&(c.vcsWkid=l),c}return n.startsWith(`GEOGCS`)||n.startsWith(`PROJCS`)?(t=Ct(e),new f(t===0?{wkt:e}:{wkid:t})):null}function Ct(e){let t=e.replaceAll(`]`,`[`).replaceAll(`"`,``).split(`[`).map(e=>e.trim()).filter(e=>e!==``),n=t[t.length-1].split(`,`),r=n[0]?.toLowerCase();if((r===`epsg`||r===`esri`)&&e.endsWith(`"]]`)){let e=Number(n[1]);if(!isNaN(e)&&e!==0)return e}return 0}function wt(e){if(e?.documentElement.tagName?.toLowerCase()!==`pamdataset`)return{};let t={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach(e=>{if(e.nodeType===1){if(tt(e,`SRS`)){if(!t.spatialReference){let n=P(e);t.spatialReference=V(n)}}else if(tt(e,`Metadata`))if(e.getAttribute(`domain`)===`xml:ESRI`){let{spatialReference:n,transform:r}=xt(e);t.transform=r,t.spatialReference||=n}else $e(e,`MDI`).forEach(e=>t.metadata[e.getAttribute(`key`)]=P(e));else if(tt(e,`PAMRasterBand`)){let n=St(e);n.sourceBandIndex!=null&&t.rasterBands[n.sourceBandIndex]==null?t.rasterBands[n.sourceBandIndex]=n:t.rasterBands.push(n)}}});let n=t.rasterBands;return n.length&&(t.statistics=n[0].statistics?n.map(e=>e.statistics).filter(ie):null,t.histograms=n[0].histogram?n.map(e=>e.histogram).filter(ie):null),t}var H=class extends F{fetchRawTile(e,t,n,r={}){return this._inMemoryRaster.fetchRawTile(e,t,n,r)}async _open(e){let t=await this._fetchData(e),{spatialReference:n,statistics:r,histograms:i,transform:a}=await this._fetchAuxiliaryData(e),o=!n;o&&(n=new f({wkid:3857})),i?.length&&r==null&&(r=je(i));let{width:s,height:c}=t,l=new j({xmin:-.5,ymin:.5-c,xmax:s-.5,ymax:.5,spatialReference:n}),u=a?a.forwardTransform(l):l,d=!0;if(a){let e=a.forwardCoefficients;d=e&&e[1]===0&&e[2]===0,d&&(a=null,l=u)}let p=new vt({source:{extent:u,nativeExtent:l,transform:a,pixelBlocks:[t],statistics:r,histograms:i,keyProperties:{DateType:`Processed`},isPseudoSpatialReference:o},ioConfig:{sampling:`closest`,skipStatistics:!0}});this.ioConfig.skipMapInfo&&(p.ioConfig.skipMapInfo=!0),await p.open(),p.source=null,this._set(`rasterInfo`,p.rasterInfo),this._inMemoryRaster=p}async _fetchData(e){let{data:n}=await this.request(this.url,{responseType:`array-buffer`,signal:e?.signal}),r=be(n).toUpperCase();if(r!==`JPG`&&r!==`PNG`&&r!==`GIF`&&r!==`BMP`)throw new t(`image-aux-raster:open`,`the data is not a supported format`);this._set(`datasetFormat`,r);let i=r.toLowerCase(),a=i===`gif`||i===`bmp`||!l(`ios`),o=await this.decodePixelBlock(n,{format:i,useCanvas:a,hasNoZlibMask:!0});if(o==null)throw new t(`image-aux-raster:open`,`the data cannot be decoded`);return o}async _fetchAuxiliaryData(e){let t=e?.signal,{skipExtensions:n=[],skipMapInfo:r}=this.ioConfig,i=r||n.includes(`aux.xml`)?null:this.request(this.url+`.aux.xml`,{responseType:`xml`,signal:t}),a=this.datasetFormat,o=a===`JPG`?`jgw`:a===`PNG`?`pgw`:a===`BMP`?`bpw`:null,s=o&&n.includes(o)?null:this.request(this.url.slice(0,this.url.lastIndexOf(`.`))+`.`+o,{responseType:`text`,signal:t}),c=await k([i,s]);if(t?.aborted)throw ee();let l=wt(c[0].value?.data);if(!l.transform){let e=c[1].value?c[1].value.data.split(`
`).slice(0,6).map(e=>Number(e)):null;l.transform=e?.length===6?new at({forwardCoefficients:[e[4],e[5],e[0],-e[1],e[2],-e[3]]}):null}return l}};D([i({type:String,json:{write:!0}})],H.prototype,`datasetFormat`,void 0),H=D([v(`esri.layers.raster.datasets.ImageAuxRaster`)],H);var U=H,W=class extends F{constructor(){super(...arguments),this._levelOffset=0,this._tilemapCache=null,this._slices=null,this.datasetFormat=`RasterTileServer`,this.tileType=null}async fetchRawTile(e,t,n,r={}){let{storageInfo:i,extent:a}=this.rasterInfo,{transposeInfo:o}=i,s=o!=null&&!!r.transposedVariableName;if(this._slices&&!s&&r.sliceId==null)return null;let c=s?0:i.maximumPyramidLevel-e+this._levelOffset,l=`${this.url}/tile/${c}/${t}/${n}`,u=this._slices?s?{variable:r.transposedVariableName}:{sliceId:r.sliceId||0}:null,d,f;if(i.isBsqTile){let e=(r.bandIds?.length?r.bandIds:[0,1,2]).map(e=>this.request(l,{query:{...u,bandId:e},responseType:`array-buffer`,signal:r.signal})),t=await Promise.all(e),n=t.map(e=>e.data.byteLength).reduce((e,t)=>e+t),i=new Uint8Array(n);f=[];let a=0;for(let{data:e}of t)f.push(a),i.set(new Uint8Array(e),a),a+=e.byteLength;d=i.buffer}else d=(await this.request(l,{query:u,responseType:`array-buffer`,signal:r.signal})).data;if(!d)return null;let p=s?o.tileSize:i.tileInfo.size,m=await this.decodePixelBlock(d,{width:p[0],height:p[1],planes:f?.length,offsets:f,pixelType:null,isPoint:this.tileType===`Elevation`,returnInterleaved:s,noDataValue:this.rasterInfo.noDataValue});if(m==null)return null;let h=i.blockBoundary[e];if(i.compression!==`jpg`||n>h.minCol&&n<h.maxCol&&t>h.minRow&&t<h.maxRow)return m;let{origin:g,blockWidth:_,blockHeight:v}=i,{x:y,y:b}=this.getPyramidPixelSize(e),x=Math.round((a.xmin-g.x)/y)%_,S=Math.round((a.xmax-g.x)/y)%_||_,C=Math.round((g.y-a.ymax)/b)%v,w=Math.round((g.y-a.ymin)/b)%v||v,T=n===h.minCol?x:0,E=t===h.minRow?C:0,D=n===h.maxCol?S:_,O=t===h.maxRow?w:v;return Pe(m,{x:T,y:E},{width:D-T,height:O-E}),m}getSliceIndex(e){if(!this._slices||e==null||e.length===0)return null;let t=e;for(let e=0;e<this._slices.length;e++){let n=this._slices[e].multidimensionalDefinition;if(n.length===t.length&&!n.some(e=>{let n=t.find(t=>e.variableName===t.variableName&&t.dimensionName===e.dimensionName);return n?(Array.isArray(e.values[0])?`${e.values[0][0]}-${e.values[0][1]}`:e.values[0])!==(Array.isArray(n.values[0])?`${n.values[0][0]}-${n.values[0][1]}`:n.values[0]):!0}))return e}return null}async fetchVariableStatisticsHistograms(e,t){let n=this.request(this.url+`/statistics`,{query:{variable:e,f:`json`},signal:t}).then(e=>e.data?.statistics),r=this.request(this.url+`/histograms`,{query:{variable:e,f:`json`},signal:t}).then(e=>e.data?.histograms),i=await Promise.all([n,r]);return i[0]&&i[0].forEach(e=>{e.avg=e.mean,e.stddev=e.standardDeviation}),i[1]?.[0]?.counts?.length||(i[1]=null),{statistics:i[0]||null,histograms:i[1]||null}}async computeBestPyramidLevelForLocation(e,t={}){if(!this._tilemapCache)return 0;let n=this.identifyPixelLocation(e,0,t.datumTransformation);if(n===null)return null;let r=0,{maximumPyramidLevel:i}=this.rasterInfo.storageInfo,a=i-r+this._levelOffset,o=n.srcLocation;for(;a>=0;){try{if(await this._tilemapCache.fetchAvailability(a,n.row,n.col,t)===`available`)break}catch{}if(a--,r++,n=this.identifyPixelLocation(o,r,t.datumTransformation),n===null)return null}return a===-1||n==null?null:r}async _open(e){let n=e?.signal,i=this.sourceJSON?{data:this.sourceJSON}:await this.request(this.url,{query:{f:`json`},signal:n});i.ssl&&(this.url=this.url.replace(/^http:/i,`https:`));let a=i.data;if(this.sourceJSON=a,!a)throw new t(`imageserverraster:open`,`cannot initialize tiled image service, missing service info`);if(!a.tileInfo)throw new t(`imageserverraster:open`,`use ImageryLayer to open non-tiled image services`);this._fixScaleInServiceInfo(),this.tileType=a.cacheType,this.tileType??([`jpg`,`jpeg`,`png`,`png8`,`png24`,`png32`,`mixed`].includes(a.tileInfo.format.toLowerCase())?this.tileType=`Map`:a.tileInfo.format.toLowerCase()===`lerc`?this.tileType=`Elevation`:this.tileType=`Raster`),this.datasetName=a.name?.slice(a.name.indexOf(`/`)+1)??``;let o=await this._fetchRasterInfo({signal:n});if(o==null)throw new t(`image-server-raster:open`,`cannot initialize image service`);Ye(o,a);let c=this.tileType===`Map`?Tt(a.tileInfo,a):r.fromJSON(a.tileInfo);s(c);let[l,u]=this._computeMinMaxLOD(o,c),{extent:d,pixelSize:f}=o,p=.5/o.width*f.x,m=Math.max(f.x,f.y),{lods:h}=c;(this.tileType!==`Map`&&a.maxScale!==0||Math.abs(f.x-f.y)>p||!h.some(e=>Math.abs(e.resolution-m)<p))&&(f.x=f.y=l.resolution,o.width=Math.ceil((d.xmax-d.xmin)/f.x-.1),o.height=Math.ceil((d.ymax-d.ymin)/f.y-.1));let g=l.level-u.level,[_,v]=c.size,y=[],b=[];h.forEach((e,t)=>{e.level>=u.level&&e.level<=l.level&&y.push({x:e.resolution,y:e.resolution}),t<h.length-1&&b.push(Math.round(10*e.resolution/h[t+1].resolution)/10)}),y.sort((e,t)=>e.x-t.x);let x=this.computeBlockBoundary(d,_,v,c.origin,y,g),S=y.length>1?y.slice(1):null,C;a.transposeInfo&&(C={tileSize:[a.transposeInfo.rows,a.transposeInfo.cols],packetSize:o.keyProperties?._yxs.PacketSize??0});let w=b.length<=1||b.length>=3&&b.slice(0,-1).every(e=>e===b[0])?b[0]??2:Math.round(10/(u.resolution/l.resolution)**(-1/g))/10;if(o.storageInfo=new ve({blockWidth:c.size[0],blockHeight:c.size[1],pyramidBlockWidth:c.size[0],pyramidBlockHeight:c.size[1],pyramidResolutions:S,pyramidScalingFactor:w,compression:c.format,origin:c.origin,firstPyramidLevel:1,maximumPyramidLevel:g,tileInfo:c,isBsqTile:!!a.bsq,transposeInfo:C,blockBoundary:x}),Et(o),this._set(`rasterInfo`,o),a.capabilities.toLowerCase().includes(`tilemap`)){let e={tileInfo:o.storageInfo.tileInfo,parsedUrl:E(this.url),url:this.url,tileServers:[]};this._tilemapCache=new me({layer:e})}}async _fetchRasterInfo(e){let t=this.sourceJSON;if(this.tileType===`Map`){let e=t.fullExtent||t.extent,n=Math.ceil((e.xmax-e.xmin)/t.pixelSizeX-.1),r=Math.ceil((e.ymax-e.ymin)/t.pixelSizeY-.1),i=f.fromJSON(t.spatialReference||e.spatialReference),a=new u({x:t.pixelSizeX,y:t.pixelSizeY,spatialReference:i});return new M({width:n,height:r,bandCount:3,extent:j.fromJSON(e),spatialReference:i,pixelSize:a,pixelType:`u8`,statistics:null,keyProperties:{DataType:`processed`}})}let{signal:n}=e,r=Xe(this.url,this.sourceJSON,{signal:n,query:this.ioConfig.customFetchParameters}),i=t.hasMultidimensions?this.request(`${this.url}/slices`,{query:{f:`json`},signal:n}).then(e=>e.data?.slices).catch(()=>null):null,a=await Promise.all([r,i]);return this._slices=a[1],a[0]}_fixScaleInServiceInfo(){let{sourceJSON:e}=this;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}_computeMinMaxLOD(e,t){let{pixelSize:n}=e,r=.5/e.width*n.x,{lods:i}=t,a=t.lodAt(Math.max.apply(null,i.map(e=>e.level))),o=t.lodAt(Math.min.apply(null,i.map(e=>e.level))),{tileType:s}=this;if(s===`Map`)return this._levelOffset=i[0].level,[a,o];if(s===`Raster`)return[i.find(e=>e.resolution===n.x)??a,o];let{minScale:c,maxScale:l}=this.sourceJSON,u=a;l>0&&(u=i.find(e=>Math.abs(e.scale-l)<r),u||=i.filter(e=>e.scale>l).sort((e,t)=>e.scale>t.scale?1:-1)[0]??a);let d=o;return c>0&&(d=i.find(e=>Math.abs(e.scale-c)<r)??o,this._levelOffset=d.level-o.level),[u,d]}};function Tt(e,t){if(!e)return null;let{minScale:n,maxScale:i,minLOD:a,maxLOD:o}=t;if(a!=null&&o!=null)return r.fromJSON({...e,lods:e.lods.filter(({level:e})=>e!=null&&e>=a&&e<=o)});if(n!==0&&i!==0){let t=e=>Math.round(1e4*e)/1e4,a=n?t(n):1/0,o=i?t(i):-1/0;return r.fromJSON({...e,lods:e.lods.filter(e=>{let n=t(e.scale);return n<=a&&n>=o})})}return r.fromJSON(e)}function Et(e){let{extent:t,spatialReference:n}=e;t.xmin>-1&&t.xmax>181&&n?.wkid&&n.isGeographic&&(e.nativeExtent=e.extent,e.transform=new ot,e.extent=e.transform.forwardTransform(t))}D([i({type:String,json:{write:!0}})],W.prototype,`datasetFormat`,void 0),D([i()],W.prototype,`tileType`,void 0),W=D([v(`esri.layers.raster.datasets.ImageServerRaster`)],W);var Dt=W,G=new Map;G.set(`Int8`,`s8`),G.set(`UInt8`,`u8`),G.set(`Int16`,`s16`),G.set(`UInt16`,`u16`),G.set(`Int32`,`s32`),G.set(`UInt32`,`u32`),G.set(`Float32`,`f32`),G.set(`Float64`,`f32`),G.set(`Double64`,`f32`);var K=new Map;K.set(`none`,{blobExtension:`.til`,isOneSegment:!0,decoderFormat:`bip`}),K.set(`lerc`,{blobExtension:`.lrc`,isOneSegment:!1,decoderFormat:`lerc`}),K.set(`deflate`,{blobExtension:`.pzp`,isOneSegment:!0,decoderFormat:`deflate`}),K.set(`jpeg`,{blobExtension:`.pjg`,isOneSegment:!0,decoderFormat:`jpg`}),K.set(`qb3`,{blobExtension:`.pq3`,isOneSegment:!0,decoderFormat:`qb3`});var q=class extends F{constructor(){super(...arguments),this._files=null,this._storageIndex=null,this.datasetFormat=`MRF`}async fetchRawTile(e,t,n,r={}){let{blockWidth:i,blockHeight:a,blockBoundary:o}=this.rasterInfo.storageInfo,s=o[e];if(!s||s.maxRow<t||s.maxCol<n||s.minRow>t||s.minCol>n)return null;let{bandCount:c,pixelType:l}=this.rasterInfo,{ranges:u,actualTileWidth:d,actualTileHeight:f}=this._getTileLocation(e,t,n);if(!u||u.length===0)return null;if(u[0].from===0&&u[0].to===0){let e=new Uint8Array(i*a);return new N({width:i,height:a,pixels:void 0,mask:e,validPixelCount:0})}let{bandIds:p}=this.ioConfig,m=this._getBandSegmentCount(),h=[],g=0;for(g=0;g<m;g++)p&&!p.includes(g)||h.push(this.request(this._files.data,{range:{from:u[g].from,to:u[g].to},responseType:`array-buffer`,signal:r.signal}));let _=await Promise.all(h),v=_.map(e=>e.data.byteLength).reduce((e,t)=>e+t),y=new Uint8Array(v),b=[],x=0;for(g=0;g<m;g++)b.push(x),y.set(new Uint8Array(_[g].data),x),x+=_[g].data.byteLength;let S=K.get(this.rasterInfo.storageInfo.compression).decoderFormat,C=await this.decodePixelBlock(y.buffer,{width:i,height:a,format:S,planes:p?.length||c,offsets:b,pixelType:l}).catch(()=>null);if(C==null)return null;let{noDataValue:w}=this.rasterInfo;if(w!=null&&S!==`lerc`&&!C.mask&&(w=w[0],w!=null)){let e=C.width*C.height,t=new Uint8Array(e);if(Math.abs(w)>1e24)for(g=0;g<e;g++)Math.abs((C.pixels[0][g]-w)/w)>1e-6&&(t[g]=1);else for(g=0;g<e;g++)C.pixels[0][g]!==w&&(t[g]=1);C.mask=t}let T=0,E=0;if(d!==i||f!==a){let e=C.mask;if(e)for(g=0;g<a;g++)if(E=g*i,g<f)for(T=d;T<i;T++)e[E+T]=0;else for(T=0;T<i;T++)e[E+T]=0;else for(e=new Uint8Array(i*a),C.mask=e,g=0;g<f;g++)for(E=g*i,T=0;T<d;T++)e[E+T]=1}return C}async _open(e){this.datasetName=this.url.slice(this.url.lastIndexOf(`/`)+1);let t=e?e.signal:null,n=await this.request(this.url,{responseType:`xml`,signal:t}),{rasterInfo:r,files:i}=this._parseHeader(n.data),{skipMapInfo:a,skipExtensions:o=[]}=this.ioConfig;if(!o.includes(`aux.xml`)&&!a){let t=await this._fetchAuxiliaryData(e);t!=null&&(r.statistics=t.statistics??r.statistics,r.histograms=t.histograms,t.histograms&&r.statistics==null&&(r.statistics=je(t.histograms)))}a&&this.updateImageSpaceRasterInfo(r),this._set(`rasterInfo`,r),this._files=i;let s=await this.request(i.index,{responseType:`array-buffer`,signal:t});this._storageIndex=Ot(s.data);let{blockWidth:c,blockHeight:l}=this.rasterInfo.storageInfo,u=this.rasterInfo.storageInfo.pyramidScalingFactor,{width:d,height:f}=this.rasterInfo,p=[],m=this._getBandSegmentCount(),h=0,g=-1;for(;h<this._storageIndex.length;){g++;let e=Math.ceil(d/c/u**g)-1,t=Math.ceil(f/l/u**g)-1;h+=(e+1)*(t+1)*m*4,p.push({maxRow:t,maxCol:e,minCol:0,minRow:0})}this.rasterInfo.storageInfo.blockBoundary=p,g>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=g),this.updateTileInfo()}_getBandSegmentCount(){return K.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}_getTileLocation(e,t,n){let{blockWidth:r,blockHeight:i,pyramidScalingFactor:a}=this.rasterInfo.storageInfo,{width:o,height:s}=this.rasterInfo,c=this._getBandSegmentCount(),l,u,d,f=0,p=0;for(d=0;d<e;d++)p=a**d,l=Math.ceil(o/r/p),u=Math.ceil(s/i/p),f+=l*u;p=a**e,l=Math.ceil(o/r/p),u=Math.ceil(s/i/p),f+=t*l+n,f*=4*c;let m=this._storageIndex.subarray(f,f+4*c),h=0,g=0,_=[];for(let e=0;e<c;e++)h=m[4*e]*2**32+m[4*e+1],g=h+m[4*e+2]*2**32+m[4*e+3]-1,_.push({from:h,to:g});return{ranges:_,actualTileWidth:n<l-1?r:Math.ceil(o/p)-r*(l-1),actualTileHeight:t<u-1?i:Math.ceil(s/p)-i*(u-1)}}_parseHeader(e){let n=L(e,`MRF_META/Raster`);if(!n)throw new t(`mrf:open`,`not a valid MRF format`);let r=L(n,`Size`),i=parseInt(r.getAttribute(`x`),10),a=parseInt(r.getAttribute(`y`),10),o=parseInt(r.getAttribute(`c`),10),s=(P(n,`Compression`)||`none`).toLowerCase();if(!K.has(s))throw new t(`mrf:open`,`currently does not support compression `+s);let c=P(n,`DataType`)||`UInt8`,l=G.get(c);if(l==null)throw new t(`mrf:open`,`currently does not support pixel type `+c);let d=L(n,`PageSize`),p=parseInt(d.getAttribute(`x`),10),m=parseInt(d.getAttribute(`y`),10),h=L(n,`DataValues`),g,_;if(h&&(_=h.getAttribute(`NoData`),_!=null&&(g=_.trim().split(` `).map(e=>parseFloat(e)))),L(e,`MRF_META/CachedSource`))throw new t(`mrf:open`,`currently does not support MRF referencing other data files`);let v=L(e,`MRF_META/GeoTags`),y=L(v,`BoundingBox`),b,x=!1;if(y!=null){let e=parseFloat(y.getAttribute(`minx`)),t=parseFloat(y.getAttribute(`miny`)),n=parseFloat(y.getAttribute(`maxx`)),r=parseFloat(y.getAttribute(`maxy`)),i=P(v,`Projection`)||``,a=f.WGS84;if(i!==`LOCAL_CS[]`)if(i.toLowerCase().startsWith(`epsg:`)){let e=Number(i.slice(5));isNaN(e)||e===0||(a=new f({wkid:e}))}else a=V(i)??f.WGS84;else x=!0,a=new f({wkid:3857});b=new j(e,t,n,r),b.spatialReference=a}else x=!0,b=new j({xmin:-.5,ymin:.5-a,xmax:i-.5,ymax:.5,spatialReference:new f({wkid:3857})});let S=L(e,`MRF_META/Rsets`),C=parseInt(S?.getAttribute(`scale`)||`2`,10),w=b.spatialReference,T=new ve({origin:new u({x:b.xmin,y:b.ymax,spatialReference:w}),blockWidth:p,blockHeight:m,pyramidBlockWidth:p,pyramidBlockHeight:m,compression:s,pyramidScalingFactor:C}),E=new u({x:b.width/i,y:b.height/a,spatialReference:w}),D=new M({width:i,height:a,extent:b,isPseudoSpatialReference:x,spatialReference:w,bandCount:o,pixelType:l,pixelSize:E,noDataValue:g,storageInfo:T}),O=P(e,`datafile`),k=P(e,`IndexFile`);return{rasterInfo:D,files:{mrf:this.url,index:k||this.url.replace(`.mrf`,`.idx`),data:O||this.url.replace(`.mrf`,K.get(s).blobExtension)}}}async _fetchAuxiliaryData(e){try{let{data:t}=await this.request(this.url+`.aux.xml`,{responseType:`xml`,signal:e?.signal});return wt(t)}catch{return null}}};function Ot(e){if(e.byteLength%16>0)throw Error(`invalid array buffer must be multiples of 16`);let t,n,r,i,a,o;if(De){for(n=new Uint8Array(e),i=new ArrayBuffer(e.byteLength),r=new Uint8Array(i),a=0;a<e.byteLength/4;a++)for(o=0;o<4;o++)r[4*a+o]=n[4*a+3-o];t=new Uint32Array(i)}else t=new Uint32Array(e);return t}D([i()],q.prototype,`_files`,void 0),D([i()],q.prototype,`_storageIndex`,void 0),D([i({type:String,json:{write:!0}})],q.prototype,`datasetFormat`,void 0),q=D([v(`esri.layers.raster.datasets.MRFRaster`)],q);var kt=q;function At(e){let t=e.fields,n=e.records,r=t.some(e=>e.name.toLowerCase()===`oid`)?`OBJECTID`:`OID`,i=[{name:r,type:`esriFieldTypeOID`,alias:`OID`}].concat(t.map(e=>({name:e.name,type:`esriFieldType`+e.typeName,alias:e.name}))),a=i.map(e=>e.name),o=[],s=0,c=0;return n.forEach(e=>{let t={};for(t[r]=s++,c=1;c<a.length;c++)t[a[c]]=e[c-1];o.push({attributes:t})}),{displayFieldName:``,fields:i,features:o}}var jt=class{static get supportedVersions(){return[5]}static parse(e){let t=new DataView(e),n=3&t.getUint8(0);if(n!==3)return{header:{version:n},recordSet:null};let r=t.getUint32(4,!0),i=t.getUint16(8,!0),a=t.getUint16(10,!0),o={version:n,recordCount:r,headerByteCount:i,recordByteCount:a},s=32,c=[],l=[],u;if(n===3){for(;t.getUint8(s)!==13;)u=String.fromCharCode(t.getUint8(s+11)).trim(),c.push({name:ke(new Uint8Array(e,s,11)),type:u,typeName:[`String`,`Date`,`Double`,`Boolean`,`String`,`Integer`][[`C`,`D`,`F`,`L`,`M`,`N`].indexOf(u)],length:t.getUint8(s+16)}),s+=32;if(s+=1,c.length>0)for(;l.length<r&&e.byteLength-s>a;){let n=[];t.getUint8(s)===32?(s+=1,c.forEach(t=>{if(t.type===`C`)n.push(ke(new Uint8Array(e,s,t.length)).trim());else if(t.type===`N`)n.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,s,t.length)).trim(),10));else if(t.type===`F`)n.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,s,t.length)).trim()));else if(t.type===`D`){let r=String.fromCharCode.apply(null,new Uint8Array(e,s,t.length)).trim();n.push(new Date(parseInt(r.slice(0,4),10),parseInt(r.slice(4,6),10)-1,parseInt(r.slice(6,8),10)))}s+=t.length}),l.push(n)):s+=a}}return{header:o,fields:c,records:l,recordSet:At({fields:c,records:l})}}},J=(e,t)=>e.get(t)?.values,Y=(e,t)=>e.get(t)?.values?.[0],X=class extends F{constructor(){super(...arguments),this._files=null,this._headerInfo=null,this._bufferSize=1048576,this._chunkSize=10485760,this.datasetFormat=`TIFF`}async fetchRawTile(e,t,n,r={}){if(!this._headerInfo?.isSupported||this.isBlockOutside(e,t,n))return null;let i=await this._fetchRawTiffTile(e,t,n,!1,r);if(i!=null&&this._headerInfo.hasMaskBand){let a=await this._fetchRawTiffTile(e,t,n,!0,r);a!=null&&a.pixels[0]instanceof Uint8Array&&(i.mask=a.pixels[0])}return i}async _open(e){let n=e?e.signal:null,{data:r}=await this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:`array-buffer`,signal:n});if(!r)throw new t(`tiffraster:open`,`failed to open url `+this.url);this.datasetName=this.url.slice(this.url.lastIndexOf(`/`)+1,this.url.lastIndexOf(`.`));let{littleEndian:i,firstIFDPos:o,isBigTiff:s}=Se(r),c=[],l={fileChunk:r,posIFD:o,fileOffset:0};await this._readIFDs(c,l,i,s?8:4,n);let{imageInfo:u,rasterInfo:d}=Mt(c),f=ye(c),p=Te(c);if(this._headerInfo={littleEndian:i,isBigTiff:s,ifds:c,pyramidIFDs:f,maskIFDs:p,...u},this._set(`rasterInfo`,d),!u.isSupported)throw new t(`tiffraster:open`,`this tiff is not supported: `+u.message);if(!u.tileWidth)throw new t(`tiffraster:open`,`none-tiled tiff is not optimized for access, convert to COG and retry.`);d.isPseudoSpatialReference&&a.getLogger(this).warn(`The spatial reference for this tiff is unsupported. Only EPSG spatial reference codes and Esri WKTs are supported.`);let m=c[0].get(`PREDICTOR`)?.values?.[0];if(c[0].get(`SAMPLEFORMAT`)?.values?.[0]===3&&m===2)throw new t(`tiffraster:open`,`unsupported horizontal difference encoding. Predictor=3 is supported for floating point data`);let{skipMapInfo:h,skipExtensions:g=[]}=this.ioConfig;if(!g.includes(`aux.xml`)&&!h){let t=await this._fetchAuxiliaryMetaData(e);t!=null&&Nt(t,d)}g.includes(`vat.dbf`)||d.bandCount!==1||d.pixelType!==`u8`||h||(d.attributeTable=await this._fetchAuxiliaryTable(e),d.attributeTable!=null&&(d.keyProperties.DataType=`thematic`)),h&&this.updateImageSpaceRasterInfo(d),this.updateTileInfo()}async _validateOrFetchHeaderBuffer(e,t){let{fileChunk:n,fileOffset:r,posIFD:i}=e;return(i+8>=n.byteLength||i<0)&&(r=i+r,n=(await this.request(this.url,{range:{from:r,to:r+this._bufferSize},responseType:`array-buffer`,signal:t})).data,i=0),{fileChunk:n,fileOffset:r,posIFD:i}}async _readIFDs(e,n,r,i=4,a){if(!n.posIFD)return null;n=await this._validateOrFetchHeaderBuffer(n,a);let o=await this._readIFD(n,r,Ce,i,a);if(!o?.ifd)throw new t(`tiffraster:open`,`cannot parse tiff header. failed to open url `+this.url);if(e.push(o.ifd),!o.nextIFD)return null;n.posIFD=o.nextIFD-n.fileOffset,await this._readIFDs(e,n,r,i,a)}async _readIFD(e,t,n=Ce,r=4,i){let{fileChunk:a,posIFD:o,fileOffset:s}=e;if(!e.fileChunk)return null;let c=xe(a,t,o,s,n,r);if(c.success){let e=[];if(c.ifd?.forEach(t=>{t.values||e.push(t)}),e.length>0&&await this._fillOffsets(e,t,c.nextIFD,i),c.ifd?.has(`GEOKEYDIRECTORY`)){let e=c.ifd.get(`GEOKEYDIRECTORY`),n=e?.values;if(n&&n.length>4){let r=n[0]+`.`+n[1]+`.`+n[2];o=e.valueOffset+6-s;let c=await this._validateOrFetchHeaderBuffer({fileChunk:a,posIFD:o,fileOffset:s},i);e.data=(await this._readIFD(c,t,_e,2,i))?.ifd,e.data&&e.data.set(`GEOTIFFVersion`,{id:0,type:2,valueCount:1,valueOffset:null,values:[r]})}}return c}return c.requiredBufferSize?(a=(await this.request(this.url,{range:{from:s,to:s+o+c.requiredBufferSize+8},responseType:`array-buffer`,signal:i})).data,a.byteLength<o+c.requiredBufferSize?null:(e.fileChunk=a,e.fileOffset=s,this._readIFD(e,t,n,r,i))):null}async _fillOffsets(e,t,n,r){let i=e.filter(e=>e.offlineOffsetSize!=null);if(i.length===0)return;let a=i.map(e=>e.offlineOffsetSize),o=Math.min.apply(null,a.map(e=>e[0])),s=Math.max.apply(null,a.map(e=>e[0]+e[1])),c=a.length===1||s-o<=this._bufferSize;if(!c&&a.length>1&&(a.sort((e,t)=>e[0]-t[0]),c=a.reduce((e,t)=>e===t[0]?t[0]+t[1]:0,a[0][0])===s),c){let e=await this._fetchOffsets(o,Math.max(s,o+this._bufferSize),r);i.forEach(n=>Me(e,t,n,o));return}let l=i.map(async e=>{let n=e.offlineOffsetSize,i=await this._fetchOffsets(n[0],n[1]+n[0],r);Me(i,t,e,n[0])});await Promise.all(l)}async _fetchOffsets(e,t,n){let r=[],i=this._chunkSize,a=Math.ceil((t-e)/i),o=e;for(let e=0;e<a;e++)r.push(this.request(this.url,{range:{from:o,to:e===a-1?t:o+i-1},responseType:`array-buffer`,signal:n})),o+=i;let s=await Promise.all(r);if(a===1)return s[0].data;let c=new Uint8Array(t-e+1);for(let e=0;e<a;e++)c.set(new Uint8Array(s[e].data),e*i);return c.buffer}async _fetchRawTiffTile(e,t,n,r,i={}){let a=this._getTileLocation(e,t,n,r);if(!a)return null;let{ranges:o,actualTileWidth:s,actualTileHeight:c,ifd:l}=a,u=o.map(e=>this.request(this.url,{range:e,responseType:`array-buffer`,signal:i.signal})),d=await Promise.all(u),f=d.map(e=>e.data.byteLength).reduce((e,t)=>e+t),p=d.length===1?d[0].data:new ArrayBuffer(f),m=[0],h=[0];if(d.length>1){let e=new Uint8Array(p);for(let t=0,n=0;t<d.length;t++){let r=d[t].data;e.set(new Uint8Array(r),n),m[t]=n,n+=r.byteLength,h[t]=r.byteLength}}let{blockWidth:g,blockHeight:_}=this.getBlockWidthHeight(e),v=await this.decodePixelBlock(p,{format:`tiff`,customOptions:{headerInfo:this._headerInfo,ifd:l,offsets:m,sizes:h},width:g,height:_,planes:null,pixelType:null});if(v==null)return null;let y,b,x;if(s!==g||c!==_){let e=v.mask;if(e)for(y=0;y<_;y++)if(x=y*g,y<c)for(b=s;b<g;b++)e[x+b]=0;else for(b=0;b<g;b++)e[x+b]=0;else for(e=new Uint8Array(g*_),v.mask=e,y=0;y<c;y++)for(x=y*g,b=0;b<s;b++)e[x+b]=1}return v}_getTileLocation(e,t,n,r=!1){let{firstPyramidLevel:i,blockBoundary:a}=this.rasterInfo.storageInfo,o=e===0?0:e-(i-1),{_headerInfo:s}=this;if(!s)return null;let c=r?s.maskIFDs[o]:o===0?s?.ifds[0]:s?.pyramidIFDs[o-1];if(!c)return null;let l=we(c,s),u=J(c,`TILEOFFSETS`);if(u===void 0)return null;let d=J(c,`TILEBYTECOUNTS`),{minRow:f,minCol:p,maxRow:m,maxCol:h}=a[o];if(t>m||n>h||t<f||n<p)return null;let g=Y(c,`IMAGEWIDTH`),_=Y(c,`IMAGELENGTH`),v=Y(c,`TILEWIDTH`),y=Y(c,`TILELENGTH`),b=[];if(l){let{bandCount:e}=this.rasterInfo;for(let r=0;r<e;r++){let e=r*(m+1)*(h+1)+t*(h+1)+n;b[r]={from:u[e],to:u[e]+d[e]-1}}}else{let e=t*(h+1)+n;b.push({from:u[e],to:u[e]+d[e]-1})}for(let e=0;e<b.length;e++)if(b[e].from==null||!b[e].to||b[e].to<0)return null;return{ranges:b,ifd:c,actualTileWidth:n===h&&g%v||v,actualTileHeight:t===m&&_%y||y}}async _fetchAuxiliaryMetaData(e){try{let{data:t}=await this.request(this.url+`.aux.xml`,{responseType:`xml`,signal:e?.signal});return wt(t)}catch{return null}}async _fetchAuxiliaryTable(e){try{let{data:t}=await this.request(this.url+`.vat.dbf`,{responseType:`array-buffer`,signal:e?.signal}),n=jt.parse(t);return n?.recordSet?w.fromJSON(n.recordSet):null}catch{return null}}};function Mt(e){let t=Ee(e),{width:n,height:r,tileWidth:i,tileHeight:a,planes:o,pixelType:s,compression:c,firstPyramidLevel:l,maximumPyramidLevel:d,pyramidBlockWidth:p,pyramidBlockHeight:m,pyramidResolutions:h,tileBoundary:g,affine:_,metadata:v}=t,y=t.extent.spatialReference?.wkt||t.extent.spatialReference?.wkid,b=V(y),x=!!t.isPseudoGeographic;b??=(x=!0,new f({wkid:3857}));let S=new j({...t.extent,spatialReference:b}),C=new u(S?{x:S.xmin,y:S.ymax,spatialReference:b}:{x:0,y:0}),w=new ve({blockWidth:i,blockHeight:a,pyramidBlockWidth:p,pyramidBlockHeight:m,compression:c,origin:C,firstPyramidLevel:l,maximumPyramidLevel:d,pyramidResolutions:h,blockBoundary:g}),T=new u({x:(S.xmax-S.xmin)/n,y:(S.ymax-S.ymin)/r,spatialReference:b}),E=v?{BandProperties:v.bandProperties,DataType:v.dataType}:{},D=null,O=Y(e[0],`PHOTOMETRICINTERPRETATION`),k=J(e[0],`COLORMAP`);if(O<=3&&k?.length>3&&k.length%3==0){D=[];let e=k.length/3;for(let t=0;t<e;t++)D.push([t,k[t]>>>8,k[t+e]>>>8,k[t+2*e]>>>8])}let A=new M({width:n,height:r,bandCount:o,pixelType:s,pixelSize:T,storageInfo:w,spatialReference:b,isPseudoSpatialReference:x,keyProperties:E,extent:S,colormap:D,statistics:v?v.statistics:null});if(_?.length&&(A.nativeExtent=new j({xmin:-.5,ymin:.5-r,xmax:n-.5,ymax:.5,spatialReference:b}),A.transform=new at({polynomialOrder:1,forwardCoefficients:[_[2]+_[0]/2,_[5]-_[3]/2,_[0],_[3],-_[1],-_[4]]}),A.extent=A.transform.forwardTransform(A.nativeExtent),A.pixelSize=new u({x:(S.xmax-S.xmin)/n,y:(S.ymax-S.ymin)/r,spatialReference:b}),w.origin.x=-.5,w.origin.y=.5),h){let{x:e,y:t}=A.pixelSize;h.forEach(n=>{n.x*=e,n.y*=t})}return{imageInfo:t,rasterInfo:A}}function Nt(e,t){if(t.statistics=e.statistics??t.statistics,t.histograms=e.histograms,e.histograms&&t.statistics==null&&(t.statistics=je(e.histograms)),e.transform&&t.transform==null){t.transform=e.transform,t.nativeExtent=t.extent;let n=t.transform.forwardTransform(t.nativeExtent);t.pixelSize=new u({x:(n.xmax-n.xmin)/t.width,y:(n.ymax-n.ymin)/t.height,spatialReference:t.spatialReference}),t.extent=n}t.isPseudoSpatialReference&&e.spatialReference&&(t.spatialReference=e.spatialReference,t.extent.spatialReference=t.nativeExtent.spatialReference=t.storageInfo.origin.spatialReference=t.spatialReference)}D([i()],X.prototype,`_files`,void 0),D([i()],X.prototype,`_headerInfo`,void 0),D([i()],X.prototype,`_bufferSize`,void 0),D([i()],X.prototype,`_chunkSize`,void 0),D([i({type:String,json:{write:!0}})],X.prototype,`datasetFormat`,void 0),X=D([v(`esri.layers.raster.datasets.TIFFRaster`)],X);var Pt=X,Z=new Map;Z.set(`MRF`,{desc:`Meta Raster Format`,constructor:kt}),Z.set(`TIFF`,{desc:`GeoTIFF`,constructor:Pt}),Z.set(`RasterTileServer`,{desc:`Raster Tile Server`,constructor:Dt}),Z.set(`JPG`,{desc:`JPG Raster Format`,constructor:U}),Z.set(`PNG`,{desc:`PNG Raster Format`,constructor:U}),Z.set(`GIF`,{desc:`GIF Raster Format`,constructor:U}),Z.set(`BMP`,{desc:`BMP Raster Format`,constructor:U}),Z.set(`CovJSON`,{desc:`COVJSON Raster Format`,constructor:yt}),Z.set(`MEMORY`,{desc:`In Memory Raster Format`,constructor:vt});var Q=class{static get supportedFormats(){let e=new Set;return Z.forEach((t,n)=>e.add(n)),e}static async open(e){let{url:n,ioConfig:r,source:i,sourceJSON:a}=e,o=e.datasetFormat??r?.datasetFormat;o??(n.includes(`.`)?o=n.slice(n.lastIndexOf(`.`)+1).toUpperCase():i?.type?.toLowerCase()===`coverage`?o=`CovJSON`:i?.extent&&i.pixelblocks&&(o=`MEMORY`)),o===`OVR`||o===`TIF`?o=`TIFF`:o===`JPG`||o===`JPEG`||o===`JFIF`?o=`JPG`:o===`COVJSON`&&(o=`CovJSON`),n.toLowerCase().includes(`/imageserver`)&&!n.toLowerCase().includes(`/wcsserver`)&&(o=`RasterTileServer`);let s={url:n,source:i,sourceJSON:a,datasetFormat:o,ioConfig:r??{bandIds:null,sampling:null}};if(Object.keys(s).forEach(e=>{s[e]??delete s[e]}),o){if(!this.supportedFormats.has(o))throw new t(`rasterfactory:open`,`not a supported format `+o);if(o===`CRF`)throw new t(`rasterfactory:open`,`cannot open raster: ${n}`);let r=new(Z.get(o)).constructor(s);return await r.open({signal:e.signal}),r}let c=Array.from(Z.keys()).filter(e=>e!==`CovJSON`&&e!==`Memory`),l=0,u=()=>{if(o=c[l++],!o||o===`CRF`)return null;let t=new(Z.get(o)).constructor(s);return t.open({signal:e.signal}).then(()=>t).catch(()=>u())};return u()}static register(e,t,n){Z.has(e.toUpperCase())||Z.set(e.toUpperCase(),{desc:t,constructor:n})}},$=class extends ce(n(d(p(Ze(S(nt(Le(h(te(T(_(O(g))))))))))))){constructor(...t){super(...t),this._primaryRasters=[],this.graphicOrigin=new ct(this),this.legendEnabled=!0,this.isReference=null,this.listMode=`show`,this.sourceJSON=null,this.version=null,this.type=`imagery-tile`,this.operationalLayerType=`ArcGISTiledImageServiceLayer`,this.popupEnabled=!0,this.popupTemplate=null,this.screenSizePerspectiveEnabled=!0,this.fields=null,this.source=void 0,this._debouncedSaveOperations=oe(async(t,n,r)=>{let{save:i,saveAs:a}=await e(async()=>{let{save:e,saveAs:t}=await import(`./imageryUtils-CkENtvf8.js`);return{save:e,saveAs:t}},__vite__mapDeps([0,1,2,3,4,5,6]));switch(t){case 0:return i(this,n);case 1:return a(this,r,n)}})}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}load(e){let t=e==null?null:e.signal;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:[`Image Service`]},e).catch(ae).then(()=>this._openRaster(t))),Promise.resolve(this)}set elevationInfo(e){e?.mode!==`relative-to-scene`&&this._set(`elevationInfo`,e),this._validateElevationInfo(e)}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){let e=[Ve(`Pixel Value`),ze(`Raw Pixel Value`)],t=this.raster?.rasterInfo??this.serviceRasterInfo,n=t?.attributeTable;if(n){let t=Ge(n);e.push(...t)}let r=t?.dataType,i=t?.multidimensionalInfo;if((r===`vector-magdir`||r===`vector-uv`)&&i!=null){let t=i.variables[0].unit?.trim(),n=We(t),r=Ke();e.push(n,r)}if(i){let t=He(i);e.push(...t)}return e}get renderer(){return super.renderer}set renderer(e){super.renderer=e}createPopupTemplate(e){let{rasterFields:t}=this,n=e?.visibleFieldNames??new Set(t.map(({name:e})=>e).filter(e=>e!==Be.rawServicePixelValue)),r=y({fields:t,title:this.title},{...e,visibleFieldNames:n}),{rasterInfo:i}=this.raster;return r?.fieldInfos&&i&&Ue(r.fieldInfos,i),r}async generateRasterInfo(e,n){let r=A(Re,e);if(await this.load(),!r||r.functionName?.toLowerCase()===`none`)return this.serviceRasterInfo;try{let{rasterInfo:e}=await this._openFunctionRaster(r,n);return e}catch(e){throw e instanceof t?e:new t(`imagery-tile-layer`,`the given raster function is not supported`)}}async save(e){return this._debouncedSaveOperations(0,e)}async saveAs(e,t){return this._debouncedSaveOperations(1,t,e)}supportsWrite(){let e=this._primaryRasters[0]??this.raster;return!!(this.loaded?e.datasetFormat===`RasterTileServer`&&(e.tileType===`Raster`||e.tileType===`Map`):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))}write(e,n){if(this.supportsWrite())return super.write(e,n);if(n?.messages){let e=`${n.origin}/${n.layerContainerType||`operational-layers`}`;n.messages.push(new t(`layer:unsupported`,`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${e}'`,{layer:this}))}return null}async _openRaster(e){let n=!1;if(this.raster)await this._openFromRaster(this.raster,e),n=Je(this.raster),!n&&this.rasterFunction&&(this._primaryRasters=[this.raster],await this._initializeWithFunctionRaster(this.rasterFunction));else{let{url:n,rasterFunction:r,source:i}=this;if(!n&&!i)throw new t(`imagery-tile-layer:open`,`missing url or source parameter`);i?await this._openFromSource(i,e):r?await this._openFromUrlWithRasterFunction(n,r,e):await this._openFromUrl(n,e)}let r=this.raster.rasterInfo;if(!r)throw new t(`imagery-tile-layer:load`,`cannot load resources on `+this.url);if(this._set(`serviceRasterInfo`,n?r:this._primaryRasters[0].rasterInfo),this._set(`spatialReference`,r.spatialReference),this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,this.sourceJSON!=null){let e=this.raster.tileType===`Map`&&this.sourceJSON.minLOD!=null&&this.sourceJSON.maxLOD!=null?this.sourceJSON:{...this.sourceJSON,minScale:0,maxScale:0};this.read(e,{origin:`service`})}else this.read({tileInfo:this.serviceRasterInfo?.storageInfo.tileInfo.toJSON()},{origin:`service`});this.title||=this.raster.datasetName,this.raster.tileType===`Map`&&(this.popupEnabled=!1),this._configDefaultSettings(),this.addHandles(re(()=>this.customParameters,e=>{this.raster&&(this.raster.ioConfig.customFetchParameters=e)}))}async _openFromRaster(e,t){e.rasterInfo||await e.open({signal:t}),this._primaryRasters=qe(e),this.url||=this._primaryRasters[0].url}async _openFromUrlWithRasterFunction(e,n,r){let i=[e];n&&rt(n.toJSON(),i);let a=await Promise.all(i.map(e=>Q.open({url:e,sourceJSON:this.sourceJSON,ioConfig:{sampling:`closest`,...this.ioConfig,customFetchParameters:this.customParameters},signal:r}))),o=a.findIndex(e=>e==null);if(o>-1)throw new t(`imagery-tile-layer:open`,`cannot open raster: ${i[o]}`);return this._primaryRasters=a,this._initializeWithFunctionRaster(n)}async _openFromUrl(e,n){let r=await Q.open({url:e,sourceJSON:this.sourceJSON,ioConfig:{sampling:`closest`,...this.ioConfig,customFetchParameters:this.customParameters},signal:n});if(r==null)throw new t(`imagery-tile-layer:open`,`cannot open raster: ${e}`);this._primaryRasters=[r],this.raster=r}async _openFromSource(e,n){let r=`the tiled imagery data source is not supported`,i=e.type?.toLowerCase()===`coverage`?`CovJSON`:e.extent&&e.pixelBlock?`MEMORY`:null;if(!i)throw new t(`imagery-tile-layer:open`,r);i===`MEMORY`&&(e={...e,pixelBlock:void 0,pixelBlocks:[e.pixelBlock]});let a=await Q.open({url:``,source:e,datasetFormat:i,ioConfig:{sampling:`closest`,...this.ioConfig,customFetchParameters:this.customParameters},signal:n});if(a==null)throw new t(`imagery-tile-layer:open`,r);this._primaryRasters=[a],this.rasterFunction?await this._initializeWithFunctionRaster(this.rasterFunction):this.raster=a}async _openFunctionRaster(e,t){let n={raster:this._primaryRasters[0]};this._primaryRasters.length>1&&this._primaryRasters.forEach(e=>n[e.url]=e);let r=it(e.functionDefinition?.toJSON()??e.toJSON(),n),i=new et({rasterFunction:r});return await i.open(t),i}async _initializeWithFunctionRaster(e,n){try{this.raster=await this._openFunctionRaster(e,n)}catch(e){e instanceof t&&a.getLogger(this).error(`imagery-tile-layer:open`,e.message),a.getLogger(this).warn(`imagery-tile-layer:open`,`the raster function cannot be applied and is removed`),this._set(`rasterFunction`,null),this.raster=this._primaryRasters[0]}}_validateElevationInfo(e){fe(a.getLogger(this),pe(`ImageryTile layers`,`relative-to-scene`,e)),fe(a.getLogger(this),de(`ImageryTile layers`,e))}};D([i({clonable:!1})],$.prototype,`_primaryRasters`,void 0),D([i({type:ue,value:null,json:{name:`layerDefinition.elevationInfo`,write:!0,origins:{"portal-item":{read:!1,write:!1},"web-map":{read:!1,write:!1}}}})],$.prototype,`elevationInfo`,null),D([i({type:r})],$.prototype,`tileInfo`,void 0),D([i({readOnly:!0,clonable:!1})],$.prototype,`graphicOrigin`,void 0),D([i(c)],$.prototype,`legendEnabled`,void 0),D([i({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],$.prototype,`isReference`,void 0),D([i({type:[`show`,`hide`]})],$.prototype,`listMode`,void 0),D([i({json:{read:!0,write:!0}})],$.prototype,`blendMode`,void 0),D([i({type:Re,json:{name:`renderingRule`,write:!0}})],$.prototype,`rasterFunction`,void 0),D([i()],$.prototype,`sourceJSON`,void 0),D([i({readOnly:!0,json:{origins:{service:{read:{source:`currentVersion`}}}}})],$.prototype,`version`,void 0),D([i({readOnly:!0,json:{read:!1}})],$.prototype,`type`,void 0),D([i({type:[`ArcGISTiledImageServiceLayer`]})],$.prototype,`operationalLayerType`,void 0),D([i({type:Boolean,value:!0,json:{read:{source:`disablePopup`,reader:(e,t)=>!t.disablePopup},write:{target:`disablePopup`,overridePolicy(){return{enabled:!this.loaded||this.raster.tileType===`Raster`}},writer(e,t,n){t[n]=!e}}}})],$.prototype,`popupEnabled`,void 0),D([i({type:C,json:{read:{source:`popupInfo`},write:{target:`popupInfo`,overridePolicy(){return{enabled:!this.loaded||this.raster.tileType===`Raster`}}}}})],$.prototype,`popupTemplate`,void 0),D([i({readOnly:!0})],$.prototype,`defaultPopupTemplate`,null),D([i(m)],$.prototype,`screenSizePerspectiveEnabled`,void 0),D([i({readOnly:!0,type:[x]})],$.prototype,`fields`,void 0),D([i({readOnly:!0,type:[x]})],$.prototype,`rasterFields`,null),D([i({constructOnly:!0})],$.prototype,`source`,void 0),$=D([v(`esri.layers.ImageryTileLayer`)],$);var Ft=$;export{Ft as default};