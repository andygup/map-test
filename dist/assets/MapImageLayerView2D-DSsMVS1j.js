import{DT as e,OT as t,WT as n,_d as r,gD as i,nv as a,qw as o,uE as s}from"./index-ByaFsVj4.js";import"./memoryEstimations-C5pKF3kD.js";import"./OptimizedGeometry-DX91by73.js";import"./OptimizedFeatureSet-DAaREXtE.js";import"./featureConversionUtils-C045qQF5.js";import"./streamLayerUtils-82UmlW-3.js";import"./QueueProcessor-B2D2Jh6F.js";import"./earcut-CsNwSYFA.js";import"./layerViewUtils--V83RFAv.js";import"./popupUtils-CCVHXhjm.js";import"./tagSymbols-CNjeVVdC.js";import"./colorUtils-BunzVBdd.js";import"./timeSupport-BE8MSrm_.js";import"./queryUtils-DJQEBA7c.js";import"./quantizationUtils-CzrQVcZ1.js";import"./sublayerUtils-CdLiCppr.js";import"./floorFilterUtils-CQ-SmVM_.js";import{t as c}from"./ExportImageParameters-BU-oXeYM.js";import"./normalizeUtilsSync-BT8jCZxT.js";import"./GeometryUtils-BAHLKUGl.js";import"./VertexAttributeLocations-BMy2FGBT.js";import"./VertexElementDescriptor-C9CNG143.js";import"./labelPoint-DoaytHlZ.js";import"./callExpressionWithCursor-Bq5gauaR.js";import"./FeatureMetadata-L_8PG9_P.js";import"./CIMSymbolHelper-CZHBBcY6.js";import"./rasterizingUtils-LzhctegF.js";import"./Rect-BMNJQxpm.js";import"./BoundingBox-ClylkApr.js";import"./BidiEngine-CpIovbIK.js";import"./callExpressionWithFeature-DYNi0_LX.js";import"./OverrideHelper-xKJ6WRO1.js";import"./FeatureCommandQueue-BbpRY2Wt.js";import"./config-BY05DP3l.js";import"./dehydratedFeatureComparison-S5E2zKzh.js";import{n as l}from"./drapedUtils-EsGgYHzF.js";import"./WGLContainer-CiXk9por.js";import"./utils-Dm-H4TMy.js";import"./ProgramTemplate-DWR5_pn_.js";import"./VertexArrayObject-IhETPpMJ.js";import"./BufferObject-DWz5bVRd.js";import"./VertexBuffer-BwGrH3vw.js";import"./vec3f32-BWuLbfSR.js";import"./Container-S9H9uxgl.js";import"./GraphShaderModule-VKGmZBI7.js";import"./FramebufferObject-D2tOc-fp.js";import"./ShaderBuilder-NkkCCxyc.js";import"./bitmapUtils-D6zvcU9e.js";import"./Bitmap-DQXXeK0i.js";import{t as u}from"./BitmapContainer-CdDkSfGz.js";import{t as d}from"./LayerView2D-CV9r4nac.js";import{t as f}from"./ExportStrategy-D7IAoxFO.js";import{t as p}from"./LayerView-yVmpY809.js";import{t as m}from"./RefreshableLayerView-BVTbJynu.js";import{t as h}from"./timeSupport-H6sryCAf.js";import"./UpdateTracking2D-VGFir_CJ.js";import"./TechniqueInstance-xWE1qGx4.js";import"./TileContainer-Jj89hEGy.js";import"./constants-TfCITEY_.js";import"./utils-CXmRmFbM.js";import{t as g}from"./highlightOptionsUtils-CtpxD6Lo.js";import"./AGraphicContainer-CjdmKveK.js";import"./ComputedAttributeStorage-BSjVwTFB.js";import{t as _}from"./GraphicsView2D-B7tBTM9T.js";import"./dehydratedFeatures-C-2nu7sF.js";import{t as v}from"./HighlightGraphicContainer-C9eNP637.js";import{r as y,t as b}from"./MapServiceLayerViewHelper-DJ16_cmV.js";var x=n=>{let r=n,a=class extends r{initialize(){this.exportImageParameters=new c({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get floors(){return this.view?.floors??null}get exportImageVersion(){return this.exportImageParameters?.commitProperty(`version`),this.commitProperty(`timeExtent`),this.commitProperty(`floors`),(this._get(`exportImageVersion`)||0)+1}get timeExtent(){return h(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return i([e()],a.prototype,`exportImageParameters`,void 0),i([e({readOnly:!0})],a.prototype,`floors`,null),i([e({readOnly:!0})],a.prototype,`exportImageVersion`,null),i([e()],a.prototype,`layer`,void 0),i([e()],a.prototype,`suspended`,void 0),i([e({readOnly:!0})],a.prototype,`timeExtent`,null),a=i([t(`esri.views.layers.MapImageLayerView`)],a),a},S=class extends x(m(d(p))){constructor(){super(...arguments),this._highlightGraphics=new r,this._updateHash=``}fetchPopupFeaturesAtLocation(e,t){return this._popupHighlightHelper.fetchPopupFeaturesAtLocation(e,t)}update(e){let t=`${this.exportImageVersion}/${e.state.id}/${e.pixelRatio}/${e.stationary}`;this._updateHash!==t&&(this._updateHash=t,this.strategy.update(e).catch(e=>{o(e)||s.getLogger(this).error(e)}),e.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(e.state.resolution)),this._highlightView.processUpdate(e)}attach(){let{imageMaxWidth:e,imageMaxHeight:t,version:n}=this.layer,r=n>=10.3,i=n>=10;this._bitmapContainer=new u,this.container.addChild(this._bitmapContainer),this._highlightView=new _({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new v(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1}),this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new b({createFetchPopupFeaturesQueryGeometry:(e,t)=>l(e,t,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:({graphic:e,property:t})=>this._highlightView.graphicUpdateHandler({graphic:e,property:t}),layerView:this,updatingHandles:this._updatingHandles}),this.strategy=new f({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:t,imageRotationSupported:r,imageNormalizationSupported:i,hidpi:!0}),this.addAttachHandles(a(()=>this.exportImageVersion,()=>this.requestUpdate())),this.requestUpdate()}detach(){this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy(),this._popupHighlightHelper.destroy()}viewChange(){}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}async doRefresh(){this._updateHash=``,this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,t,n,r){return this.layer.fetchImage(e,t,n,{timeExtent:this.timeExtent,floors:this.floors,...r})}fetchImageBitmap(e,t,n,r){return this.layer.fetchImageBitmap(e,t,n,{timeExtent:this.timeExtent,floors:this.floors,...r})}highlight(e,t){let r=y(e);if(r.length===0)return n();let i=g(t);return this._addHighlightGraphics(r,i),n(()=>!this.destroyed&&this._removeHighlightGraphics(r,i))}_processHighlight(){let e=this._getHighlights();this._highlightView?.setHighlight(e)}_addHighlightGraphics(e,t){this._highlightGraphics.addMany(e),this._addHighlights(e.map(e=>e.uid),t)}_removeHighlightGraphics(e,t){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map(e=>e.uid),t)}};i([e()],S.prototype,`strategy`,void 0),S=i([t(`esri.views.2d.layers.MapImageLayerView2D`)],S);var C=S;export{C as default};