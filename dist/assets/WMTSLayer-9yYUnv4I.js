import{A as e,AT as t,BT as n,DS as r,DT as i,Dh as a,GC as o,Ha as s,JE as c,Jw as l,L as u,M as d,OT as f,Q_ as p,RS as m,SE as h,Z_ as g,ax as _,cC as v,gC as y,gD as b,iv as x,j as S,jT as C,nS as ee,nv as w,px as te,ua as ne,xE as re,xg as ie,yg as T}from"./index-CZ4oMP1N.js";import{t as E}from"./imageBitmapUtils-DDIV6X3i.js";import{t as ae}from"./TileInfoTilemapCache-B4g2sXyM.js";import{n as D,t as oe}from"./WebTileLayer-BSp91R-U.js";import{t as O}from"./crsUtils-j4_LRiqB.js";import{n as k}from"./xmlUtils-CfkRQroA.js";var A,j=A=class extends o{constructor(e){super(e),this.fullExtent=null,this.id=null,this.tileInfo=null}clone(){let e=new A;return this.hasOwnProperty(`fullExtent`)&&(e.fullExtent=this.fullExtent?.clone()??null),this.hasOwnProperty(`id`)&&(e.id=this.id),this.hasOwnProperty(`tileInfo`)&&(e.tileInfo=this.tileInfo?.clone()??null),e}};b([i({type:_,json:{read:{source:`fullExtent`}}})],j.prototype,`fullExtent`,void 0),b([i({type:String,json:{read:{source:`id`}}})],j.prototype,`id`,void 0),b([i({type:T,json:{read:{source:`tileInfo`}}})],j.prototype,`tileInfo`,void 0),j=A=b([f(`esri.layers.support.TileMatrixSet`)],j);var se=j,M,N=M=class extends o{constructor(e){super(e),this.id=null,this.title=null,this.description=null,this.legendUrl=null}clone(){let e=new M;return this.hasOwnProperty(`description`)&&(e.description=this.description),this.hasOwnProperty(`id`)&&(e.id=this.id),this.hasOwnProperty(`isDefault`)&&(e.isDefault=this.isDefault),this.hasOwnProperty(`keywords`)&&(e.keywords=this.keywords&&this.keywords.slice()),this.hasOwnProperty(`legendUrl`)&&(e.legendUrl=this.legendUrl),this.hasOwnProperty(`title`)&&(e.title=this.title),e}};b([i({json:{read:{source:`id`}}})],N.prototype,`id`,void 0),b([i({json:{read:{source:`title`}}})],N.prototype,`title`,void 0),b([i({json:{read:{source:`abstract`}}})],N.prototype,`description`,void 0),b([i({json:{read:{source:`legendUrl`}}})],N.prototype,`legendUrl`,void 0),b([i({json:{read:{source:`isDefault`}}})],N.prototype,`isDefault`,void 0),b([i({json:{read:{source:`keywords`}}})],N.prototype,`keywords`,void 0),N=M=b([f(`esri.layers.support.WMTSStyle`)],N);var ce=N,P,F=P=class extends o{constructor(e){super(e),this.description=null,this.fullExtent=null,this.fullExtents=null,this.id=null,this.imageFormats=null,this.layer=null,this.parent=null,this.styles=null,this.title=null,this.tileMatrixSetId=null,this.tileMatrixSets=null}readFullExtent(e,t){return(e=t.fullExtent)?_.fromJSON(e):null}readFullExtents(e,t){return t.fullExtents?.length?t.fullExtents.map(e=>_.fromJSON(e)):t.tileMatrixSets?.map(e=>_.fromJSON(e.fullExtent)).filter(e=>e)??[]}get imageFormat(){let e=this._get(`imageFormat`);return e||=this.imageFormats?.length?this.imageFormats[0]:``,e}set imageFormat(e){let t=this.imageFormats;e&&(e.includes(`image/`)||t&&!t.includes(e))&&(e.includes(`image/`)||(e=`image/`+e),t&&!t.includes(e))?console.error(`The layer doesn't support the format of `+e):this._set(`imageFormat`,e)}get styleId(){let e=this._get(`styleId`);return e||=this.styles?.at(0)?.id??``,e}set styleId(e){this._set(`styleId`,e)}get tileMatrixSet(){return this.tileMatrixSets?.find(({id:e})=>e===this.tileMatrixSetId)??null}clone(){let e=new P;return this.hasOwnProperty(`description`)&&(e.description=this.description),this.hasOwnProperty(`imageFormats`)&&(e.imageFormats=this.imageFormats?.slice()??null),this.hasOwnProperty(`imageFormat`)&&(e.imageFormat=this.imageFormat),this.hasOwnProperty(`fullExtent`)&&(e.fullExtent=this.fullExtent?.clone()),this.hasOwnProperty(`id`)&&(e.id=this.id),this.hasOwnProperty(`layer`)&&(e.layer=this.layer),this.hasOwnProperty(`styleId`)&&(e.styleId=this.styleId),this.hasOwnProperty(`styles`)&&(e.styles=this.styles?.clone()),this.hasOwnProperty(`tileMatrixSetId`)&&(e.tileMatrixSetId=this.tileMatrixSetId),this.hasOwnProperty(`tileMatrixSets`)&&(e.tileMatrixSets=this.tileMatrixSets?.clone()),this.hasOwnProperty(`title`)&&(e.title=this.title),e}};b([i()],F.prototype,`description`,void 0),b([i({type:_})],F.prototype,`fullExtent`,void 0),b([C(`fullExtent`,[`fullExtent`])],F.prototype,`readFullExtent`,null),b([i({readOnly:!0})],F.prototype,`fullExtents`,void 0),b([C(`fullExtents`,[`fullExtents`,`tileMatrixSets`])],F.prototype,`readFullExtents`,null),b([i()],F.prototype,`id`,void 0),b([i()],F.prototype,`imageFormat`,null),b([i({json:{read:{source:`formats`}}})],F.prototype,`imageFormats`,void 0),b([i()],F.prototype,`layer`,void 0),b([i()],F.prototype,`parent`,void 0),b([i()],F.prototype,`styleId`,null),b([i({type:x.ofType(ce),json:{read:{source:`styles`}}})],F.prototype,`styles`,void 0),b([i({json:{write:{ignoreOrigin:!0}}})],F.prototype,`title`,void 0),b([i()],F.prototype,`tileMatrixSetId`,void 0),b([i({readOnly:!0})],F.prototype,`tileMatrixSet`,null),b([i({type:x.ofType(se),json:{read:{source:`tileMatrixSets`}}})],F.prototype,`tileMatrixSets`,void 0),F=P=b([f(`esri.layers.support.WMTSSublayer`)],F);var I=90.71428571428571;function L(e){let t=e.replaceAll(/ows:/gi,``);return new DOMParser().parseFromString(t,`text/xml`)}function R(e){if(!B(`Contents`,e.documentElement))throw new n(`wmtslayer:wmts-capabilities-xml-is-not-valid`,`the wmts get capabilities response is not compliant`)}function le(e,t){let r=e.documentElement,i=new Map,a=new Map,o=B(`Contents`,r);if(!o)throw new n(`wmtslayer:wmts-capabilities-xml-is-not-valid`,`Can't retrieve xml capabilities element`);let s=B(`OperationsMetadata`,r),c=s?.querySelector(`[name='GetTile']`),l=c?.getElementsByTagName(`Get`),u=l&&Array.prototype.slice.call(l),d=t.url?.indexOf(`https`),f=d!==void 0&&d>-1,p,m,h=t.serviceMode,g=t?.url;u?.length&&u.some(e=>{let t=B(`Constraint`,e);return!t||W(`AllowedValues`,`Value`,h,t)?(g=e.attributes[0].nodeValue,!0):(!t||W(`AllowedValues`,`Value`,`RESTful`,t)||W(`AllowedValues`,`Value`,`REST`,t)?m=e.attributes[0].nodeValue:t&&!W(`AllowedValues`,`Value`,`KVP`,t)||(p=e.attributes[0].nodeValue),!1)}),!g&&(m?(g=m,h=`RESTful`):p?(g=p,h=`KVP`):g=B(`ServiceMetadataURL`,r)?.getAttribute(`xlink:href`));let _=g.indexOf(`1.0.0/`);_===-1&&h===`RESTful`?g+=`/`:_>-1&&(g=g.slice(0,_)),h===`KVP`&&(g+=_>-1?``:`?`),f&&(g=g.replace(/^http:/i,`https:`));let v=U(`ServiceIdentification>ServiceTypeVersion`,r),y=U(`ServiceIdentification>AccessConstraints`,r),b=y&&/^none$/i.test(y)?null:y,x=V(`Layer`,o),S=V(`TileMatrixSet`,o),C=x.map(e=>{let t=U(`Identifier`,e);return i.set(t,e),G(t,e,S,f,v)});return{copyright:b,dimensionMap:a,layerMap:i,layers:C,serviceMode:h,tileUrl:g}}function ue(e){for(let t of e.layers)for(let e of t.tileMatrixSets??[]){let{tileInfo:t}=e;if(t&&t.dpi!==96){for(let n of t.lods??[])n.scale=96*n.scale/t.dpi,n.resolution=X(t.spatialReference?.wkid,n.scale*I/96,e.id);t.dpi=96}}}function z(e){return e.nodeType===Node.ELEMENT_NODE}function B(e,t){for(let n=0;n<t.childNodes.length;n++){let r=t.childNodes[n];if(z(r)&&r.nodeName===e)return r}return null}function V(e,t){let n=[];for(let r=0;r<t.childNodes.length;r++){let i=t.childNodes[r];z(i)&&i.nodeName===e&&n.push(i)}return n}function H(e,t){let n=[];for(let r=0;r<t.childNodes.length;r++){let i=t.childNodes[r];z(i)&&i.nodeName===e&&n.push(i)}return n.map(e=>e.textContent).filter(c)}function U(e,t){return e.split(`>`).forEach(e=>{t&&=B(e,t)}),t&&t.textContent}function W(e,t,n,r){let i;return Array.prototype.slice.call(r.childNodes).some(r=>{if(r.nodeName.includes(e)){let e=B(t,r),a=e?.textContent;if(a===n||n.split(`:`)&&n.split(`:`)[1]===a)return i=r,!0}return!1}),i}function G(e,t,n,r,i){let a=U(`Abstract`,t),o=H(`Format`,t);return{id:e,fullExtent:me(t),fullExtents:he(t),description:a,formats:o,styles:ge(t,r),title:U(`Title`,t),tileMatrixSets:_e(i,t,n)}}function K(e,t){let n=[],r=e.layerMap?.get(t);if(!r)return null;let i=V(`ResourceURL`,r),a=V(`Dimension`,r),o,s,c,l;return a.length&&(o=U(`Identifier`,a[0]),s=H(`Default`,a[0])||H(`Value`,a[0])),a.length>1&&(c=U(`Identifier`,a[1]),l=H(`Default`,a[1])||H(`Value`,a[1])),e.dimensionMap.set(t,{dimensions:s,dimensions2:l}),i.forEach(e=>{let t=e.getAttribute(`template`);if(e.getAttribute(`resourceType`)===`tile`){if(o&&s.length)if(t.includes(`{`+o+`}`))t=t.replace(`{`+o+`}`,`{dimensionValue}`);else{let e=t.toLowerCase().indexOf(`{`+o.toLowerCase()+`}`);e>-1&&(t=t.slice(0,e)+`{dimensionValue}`+t.slice(e+o.length+2))}if(c&&l.length)if(t.includes(`{`+c+`}`))t=t.replace(`{`+c+`}`,`{dimensionValue2}`);else{let e=t.toLowerCase().indexOf(`{`+c.toLowerCase()+`}`);e>-1&&(t=t.slice(0,e)+`{dimensionValue2}`+t.slice(e+c.length+2))}n.push({template:t,format:e.getAttribute(`format`),resourceType:`tile`})}}),n}function de(e,t,n,r,i,a,o,s){let c=fe(e,t,r);if(!(c?.length>0))return``;let{dimensionMap:l}=e,u=l.get(t).dimensions?.[0],d=l.get(t).dimensions2?.[0];return c[o%c.length].template.replaceAll(/\{Style\}/gi,i??``).replaceAll(/\{TileMatrixSet\}/gi,n??``).replaceAll(/\{TileMatrix\}/gi,a).replaceAll(/\{TileRow\}/gi,``+o).replaceAll(/\{TileCol\}/gi,``+s).replaceAll(/\{dimensionValue\}/gi,u).replaceAll(/\{dimensionValue2\}/gi,d)}function fe(e,t,n){let r=K(e,t),i=r?.filter(e=>e.format===n);return(i?.length?i:r)??[]}function pe(e,t,n,r){let{dimensionMap:i}=e,a=K(e,t),o=``;if(a&&a.length>0){let e=i.get(t).dimensions?.[0],s=i.get(t).dimensions2?.[0];o=a[0].template,o.endsWith(`.xxx`)&&(o=o.slice(0,-4)),o=o.replaceAll(/\{Style\}/gi,r),o=o.replaceAll(/\{TileMatrixSet\}/gi,n),o=o.replaceAll(/\{TileMatrix\}/gi,`{level}`),o=o.replaceAll(/\{TileRow\}/gi,`{row}`),o=o.replaceAll(/\{TileCol\}/gi,`{col}`),o=o.replaceAll(/\{dimensionValue\}/gi,e),o=o.replaceAll(/\{dimensionValue2\}/gi,s)}return o}function me(e){let t=B(`WGS84BoundingBox`,e),n=t?U(`LowerCorner`,t).split(` `):[`-180`,`-90`],r=t?U(`UpperCorner`,t).split(` `):[`180`,`90`];return{xmin:parseFloat(n[0]),ymin:parseFloat(n[1]),xmax:parseFloat(r[0]),ymax:parseFloat(r[1]),spatialReference:{wkid:4326}}}function he(e){let t=[];return k(e,{BoundingBox:e=>{if(!e.getAttribute(`crs`))return;let n=e.getAttribute(`crs`).toLowerCase(),r=q(n),i=n.includes(`epsg`)&&O(r.wkid),a,o,s,c;k(e,{LowerCorner:e=>{[a,o]=e.textContent.split(` `).map(e=>Number.parseFloat(e)),i&&([a,o]=[o,a])},UpperCorner:e=>{[s,c]=e.textContent.split(` `).map(e=>Number.parseFloat(e)),i&&([s,c]=[c,s])}}),t.push({xmin:a,ymin:o,xmax:s,ymax:c,spatialReference:r})}}),t}function ge(e,t){return V(`Style`,e).map(e=>{let n=B(`LegendURL`,e),r=B(`Keywords`,e),i=r?H(`Keyword`,r):[],a=n?.getAttribute(`xlink:href`);return t&&(a=a?.replace(/^http:/i,`https:`)),{abstract:U(`Abstract`,e),id:U(`Identifier`,e),isDefault:e.getAttribute(`isDefault`)===`true`,keywords:i,legendUrl:a,title:U(`Title`,e)}})}function _e(e,t,n){return V(`TileMatrixSetLink`,t).map(t=>ve(e,t,n))}function ve(e,t,n){let r=B(`TileMatrixSet`,t).textContent,i=H(`TileMatrix`,t),a=n.find(e=>{let t=B(`Identifier`,e),n=t?.textContent;return!!(n===r||r.split(`:`)&&r.split(`:`)[1]===n)}),o=B(`TileMatrixSetLimits`,t),s=o&&V(`TileMatrixLimits`,o),c=new Map;if(s?.length)for(let e of s){let t=B(`TileMatrix`,e).textContent,n=+B(`MinTileRow`,e).textContent,r=+B(`MaxTileRow`,e).textContent,i=+B(`MinTileCol`,e).textContent,a=+B(`MaxTileCol`,e).textContent;c.set(t,{minCol:i,maxCol:a,minRow:n,maxRow:r})}let l=U(`SupportedCRS`,a).toLowerCase(),u=ye(a,l),d=u.spatialReference,f=B(`TileMatrix`,a),p=[parseInt(U(`TileWidth`,f),10),parseInt(U(`TileHeight`,f),10)],m=[];i.length?i.forEach((e,t)=>{let n=W(`TileMatrix`,`Identifier`,e,a);m.push(Y(n,l,t,r,c))}):V(`TileMatrix`,a).forEach((e,t)=>{m.push(Y(e,l,t,r,c))});let h=be(e,a,u,p,m[0]).toJSON(),g=new T({dpi:96,spatialReference:d,size:p,origin:u,lods:m}).toJSON();return{id:r,fullExtent:h,tileInfo:g}}function q(e){e=e.toLowerCase();let t=parseInt(e.split(`:`).pop(),10);t!==900913&&t!==3857||(t=102100);let n=Se(e);return n!=null&&(t=n),{wkid:t}}function ye(e,t){return J(B(`TileMatrix`,e),t)}function J(e,t){let n=q(t),[r,i]=U(`TopLeftCorner`,e).split(` `).map(e=>parseFloat(e)),a=t.includes(`epsg`)&&O(n.wkid);return new te(a?{x:i,y:r,spatialReference:n}:{x:r,y:i,spatialReference:n})}function be(e,t,n,r,i){let a=B(`BoundingBox`,t),o,s,c,l,u,d;if(a&&(o=U(`LowerCorner`,a).split(` `),s=U(`UpperCorner`,a).split(` `)),o&&o.length>1&&s&&s.length>1)c=parseFloat(o[0]),u=parseFloat(o[1]),l=parseFloat(s[0]),d=parseFloat(s[1]);else{let e=B(`TileMatrix`,t),a=parseInt(U(`MatrixWidth`,e),10),o=parseInt(U(`MatrixHeight`,e),10);c=n.x,d=n.y,l=c+a*r[0]*i.resolution,u=d-o*r[1]*i.resolution}return xe(e,n.spatialReference,n)?new _(u,c,d,l,n.spatialReference):new _(c,u,l,d,n.spatialReference)}function xe(e,t,n){return e===`1.0.0`&&O(t.wkid)&&!(n.spatialReference.isGeographic&&n.x<-90&&n.y>=-90)}function Se(e){return e.includes(`crs84`)||e.includes(`crs:84`)?4326:e.includes(`crs83`)||e.includes(`crs:83`)?4269:e.includes(`crs27`)||e.includes(`crs:27`)?4267:null}function Y(e,t,n,r,i){let a=q(t),o=U(`Identifier`,e),s=parseFloat(U(`ScaleDenominator`,e)),c=X(a.wkid,s,r);s*=96/I;let l=+U(`MatrixWidth`,e),u=+U(`MatrixHeight`,e),{maxCol:d=l-1,maxRow:f=u-1,minCol:p=0,minRow:m=0}=i.get(o)??{},{x:h,y:g}=J(e,t);return new ie({cols:[p,d],level:n,levelValue:o,origin:[h,g],scale:s,resolution:c,rows:[m,f]})}function X(e,t,n){let i;return i=r.hasOwnProperty(``+e)?r.values[r[e]]:n===`default028mm`?6370997*Math.PI/180:ee(e).metersPerDegree,7*t/25e3/i}var Z,Q={"image/png":`.png`,"image/png8":`.png`,"image/png24":`.png`,"image/png32":`.png`,"image/jpg":`.jpg`,"image/jpeg":`.jpeg`,"image/gif":`.gif`,"image/bmp":`.bmp`,"image/tiff":`.tif`,"image/jpgpng":``,"image/jpegpng":``,"image/unknown":``},Ce=new Set([`version`,`service`,`request`,`layer`,`style`,`format`,`tilematrixset`,`tilematrix`,`tilerow`,`tilecol`]),$=Z=class extends ne(S(e(u(d(s(a)))))){constructor(...e){super(...e),this.activeLayer=null,this.copyright=``,this.customParameters=null,this.customLayerParameters=null,this.fullExtent=null,this.operationalLayerType=`WebTiledLayer`,this.resourceInfo=null,this.serviceMode=`RESTful`,this.sublayers=null,this.type=`wmts`,this.version=`1.0.0`,this.addHandles([w(()=>this.activeLayer,(e,t)=>{t&&!this.sublayers?.includes(t)&&(t.layer=null,t.parent=null),e&&(e.layer=this,e.parent=this)},g),p(()=>this.sublayers,`after-add`,({item:e})=>{e.layer=this,e.parent=this},g),p(()=>this.sublayers,`after-remove`,({item:e})=>{e.layer=null,e.parent=null},g),w(()=>this.sublayers,(e,t)=>{if(t)for(let e of t)e.layer=null,e.parent=null;if(e)for(let t of e)t.layer=this,t.parent=this},g)])}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}load(e){return this.addResolvingPromise(this.loadFromPortal({supportedTypes:[`WMTS`]},e).catch(l).then(()=>this._fetchService(e)).catch(e=>{throw l(e),new n(`wmtslayer:unsupported-service-data`,`Invalid response from the WMTS service.`,{error:e})})),Promise.resolve(this)}readActiveLayerFromService(e,t,n){this.activeLayer||=new F;let r=t.layers.find(e=>e.id===this.activeLayer.id);return r||=t.layers[0],this.activeLayer.read(r,n),this.activeLayer}readActiveLayerFromItemOrWebDoc(e,t){let{templateUrl:n,wmtsInfo:r}=t,i=n?this._getLowerCasedUrlParams(n):null,a=r?.layerIdentifier,o=null,s=r?.tileMatrixSet;s&&(Array.isArray(s)?s.length&&(o=s[0]):o=s);let c=i?.format,l=i?.style;return new F({id:a,imageFormat:c,styleId:l,tileMatrixSetId:o})}writeActiveLayer(e,t,n,r){let i=this.activeLayer;t.templateUrl=this.getUrlTemplate(i.id,i.tileMatrixSetId,i.imageFormat,i.styleId);let a=re(`tileMatrixSet.tileInfo`,i);t.tileInfo=a?a.toJSON(r):null,t.wmtsInfo={...t.wmtsInfo,layerIdentifier:i.id,tileMatrixSet:i.tileMatrixSetId}}readCustomParameters(e,t){let n=t.wmtsInfo;return n?this._mergeParams(n.customParameters,n.url):null}get fullExtents(){return this.activeLayer.fullExtents}readServiceMode(e,t){return t.templateUrl.includes(`?`)?`KVP`:`RESTful`}readSublayersFromService(e,t,n){return we(t.layers,n)}get supportedSpatialReferences(){return this.activeLayer.tileMatrixSets?.map(e=>e.tileInfo?.spatialReference).toArray().filter(c)??[]}get tilemapCache(){let e=this.activeLayer?.tileMatrixSet?.tileInfo;return e?new ae(e):void 0}get title(){return this.activeLayer?.title??`Layer`}set title(e){this._overrideIfSome(`title`,e)}get url(){return this._get(`url`)}set url(e){e&&e.endsWith(`/`)?this._set(`url`,e.slice(0,-1)):this._set(`url`,e)}createWebTileLayer(e){let t=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId),n=this._getTileMatrixSetById(e.tileMatrixSetId),r=n?.tileInfo,i=e.fullExtent,a=new D({layerIdentifier:e.id,tileMatrixSet:e.tileMatrixSetId,url:this.url});return this.customLayerParameters&&(a.customLayerParameters=this.customLayerParameters),this.customParameters&&(a.customParameters=this.customParameters),new oe({fullExtent:i,urlTemplate:t,tileInfo:r,wmtsInfo:a})}async fetchTile(e,t,n,r={}){let{signal:i}=r,a=this.getTileUrl(e,t,n),{data:o}=await m(a,{responseType:`image`,signal:i});return o}async fetchImageBitmapTile(e,t,n,r={}){let{signal:i}=r;if(this.fetchTile!==Z.prototype.fetchTile){let a=await this.fetchTile(e,t,n,r);return E(a,e,t,n,i)}let a=this.getTileUrl(e,t,n),{data:o}=await m(a,{responseType:`blob`,signal:i});return E(o,e,t,n,i)}findSublayerById(e){return this.sublayers?.find(t=>t.id===e)}getTileUrl(e,t,n){let r=this._getTileMatrixSetById(this.activeLayer.tileMatrixSetId),i=r?.tileInfo?.lods[e],a=i?i.levelValue||`${i.level}`:`${e}`,o=this.resourceInfo?``:de({dimensionMap:this.dimensionMap,layerMap:this.layerMap},this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId,a,t,n);return o||=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId).replaceAll(/\{level\}/gi,a).replaceAll(/\{row\}/gi,`${t}`).replaceAll(/\{col\}/gi,`${n}`),o=this._appendCustomLayerParameters(o),o}getUrlTemplate(e,t,n,r){if(!this.resourceInfo){let n=pe({dimensionMap:this.dimensionMap,layerMap:this.layerMap},e,t,r);if(n)return n}if(this.serviceMode===`KVP`)return this.url+`?SERVICE=WMTS&VERSION=`+this.version+`&REQUEST=GetTile&LAYER=`+e+`&STYLE=`+r+`&FORMAT=`+n+`&TILEMATRIXSET=`+t+`&TILEMATRIX={level}&TILEROW={row}&TILECOL={col}`;if(this.serviceMode===`RESTful`){let i=``;return Q[n.toLowerCase()]&&(i=Q[n.toLowerCase()]),this.url+e+`/`+r+`/`+t+`/{level}/{row}/{col}`+i}return``}async _fetchService(e){if(this.resourceInfo)return this.resourceInfo.serviceMode!==`KVP`||this.url.includes(`?`)||(this.url+=`?`),ue(this.resourceInfo),void this.read(this.resourceInfo,{origin:`service`});let t=null;try{let{data:n}=await this._getCapabilities(this.serviceMode,e);t=L(n),R(t)}catch{let r=this.serviceMode===`KVP`?`RESTful`:`KVP`;try{let{data:n}=await this._getCapabilities(r,e);t=L(n),R(t),this.serviceMode=r}catch(e){throw new n(`wmtslayer:unsupported-service-data`,`Services does not support RESTful or KVP service modes.`,{error:e})}}let{serviceMode:r,url:i}=this,a=le(t,{serviceMode:r,url:i});this.read(a,{origin:`service`})}async _getCapabilities(e,t){let n=this._getCapabilitiesUrl(e);return await m(n,{...t,responseType:`text`})}_getTileMatrixSetById(e){return this.findSublayerById(this.activeLayer.id)?.tileMatrixSets?.find(({id:t})=>t===e)}_appendCustomParameters(e){return this._appendParameters(e,this.customParameters)}_appendCustomLayerParameters(e){return this._appendParameters(e,{...h(this.customParameters),...this.customLayerParameters})}_appendParameters(e,t){let n=y(e),r={...n.query,...t},i=v(r);return i===``?n.path:`${n.path}?${i}`}_getCapabilitiesUrl(e){this.url=y(this.url).path;let t=this.url;switch(e){case`KVP`:t+=`?request=GetCapabilities&service=WMTS&version=${this.version}`;break;case`RESTful`:{let e=`/${this.version}/WMTSCapabilities.xml`,n=new RegExp(e,`i`);t=t.replace(n,``),t+=e;break}}return this._appendCustomParameters(t)}_getLowerCasedUrlParams(e){if(!e)return null;let t=y(e).query;if(!t)return null;let n={};return Object.keys(t).forEach(e=>{n[e.toLowerCase()]=t[e]}),n}_mergeParams(e,t){let n=this._getLowerCasedUrlParams(t);if(n){let t=Object.keys(n);t.length&&(e=e?h(e):{},t.forEach(t=>{e.hasOwnProperty(t)||Ce.has(t)||(e[t]=n[t])}))}return e}};function we(e,t){return e.map(e=>{let n=new F;return n.read(e,t),n})}b([i()],$.prototype,`dimensionMap`,void 0),b([i()],$.prototype,`layerMap`,void 0),b([i({type:F,json:{origins:{"web-document":{write:{ignoreOrigin:!0}}}}})],$.prototype,`activeLayer`,void 0),b([C(`service`,`activeLayer`,[`layers`])],$.prototype,`readActiveLayerFromService`,null),b([C([`web-document`,`portal-item`],`activeLayer`,[`wmtsInfo`])],$.prototype,`readActiveLayerFromItemOrWebDoc`,null),b([t([`web-document`,`portal-item`],`activeLayer`,{templateUrl:{type:String},tileInfo:{type:T},"wmtsInfo.layerIdentifier":{type:String},"wmtsInfo.tileMatrixSet":{type:String}})],$.prototype,`writeActiveLayer`,null),b([i({type:String,value:``,json:{write:!0}})],$.prototype,`copyright`,void 0),b([i({type:[`show`,`hide`]})],$.prototype,`listMode`,void 0),b([i({json:{read:!0,write:!0}})],$.prototype,`blendMode`,void 0),b([i({json:{origins:{"web-document":{read:{source:[`wmtsInfo.customParameters`,`wmtsInfo.url`]},write:{target:`wmtsInfo.customParameters`}},"portal-item":{read:{source:[`wmtsInfo.customParameters`,`wmtsInfo.url`]},write:{target:`wmtsInfo.customParameters`}}}}})],$.prototype,`customParameters`,void 0),b([C([`portal-item`,`web-document`],`customParameters`)],$.prototype,`readCustomParameters`,null),b([i({json:{origins:{"web-document":{read:{source:`wmtsInfo.customLayerParameters`},write:{target:`wmtsInfo.customLayerParameters`}},"portal-item":{read:{source:`wmtsInfo.customLayerParameters`},write:{target:`wmtsInfo.customLayerParameters`}}}}})],$.prototype,`customLayerParameters`,void 0),b([i({type:_,json:{write:{ignoreOrigin:!0},origins:{"web-document":{read:{source:`fullExtent`}},"portal-item":{read:{source:`fullExtent`}}}}})],$.prototype,`fullExtent`,void 0),b([i({readOnly:!0})],$.prototype,`fullExtents`,null),b([i({type:[`WebTiledLayer`]})],$.prototype,`operationalLayerType`,void 0),b([i()],$.prototype,`resourceInfo`,void 0),b([i()],$.prototype,`serviceMode`,void 0),b([C([`portal-item`,`web-document`],`serviceMode`,[`templateUrl`])],$.prototype,`readServiceMode`,null),b([i({type:x.ofType(F)})],$.prototype,`sublayers`,void 0),b([C(`service`,`sublayers`,[`layers`])],$.prototype,`readSublayersFromService`,null),b([i({readOnly:!0})],$.prototype,`supportedSpatialReferences`,null),b([i({readOnly:!0})],$.prototype,`tilemapCache`,null),b([i({json:{read:{source:`title`}}})],$.prototype,`title`,null),b([i({json:{read:!1},readOnly:!0,value:`wmts`})],$.prototype,`type`,void 0),b([i({json:{origins:{service:{read:{source:`tileUrl`}},"web-document":{read:{source:`wmtsInfo.url`},write:{target:`wmtsInfo.url`}},"portal-item":{read:{source:`wmtsInfo.url`},write:{target:`wmtsInfo.url`}}}}})],$.prototype,`url`,null),b([i()],$.prototype,`version`,void 0),$=Z=b([f(`esri.layers.WMTSLayer`)],$);var Te=$;export{Te as default};