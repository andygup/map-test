import{$p as e,BT as t,FT as n,GC as r,Ih as i,RS as a,Xp as o,aE as s,gD as c,gu as l,hu as u,mu as d,uE as f,wn as p,zT as m}from"./index-ByaFsVj4.js";import{t as h}from"./arcadeEnvironment-_F8igoCf.js";import{Y as g,t as _,tt as v,z as y}from"./Dictionary-CX-Dz5lT.js";import{t as b}from"./commonProperties-CaHgSHvW.js";var x=class extends r{constructor(e){super(e),this.text=null,this.detectedLanguage=`en`,this.detectedLanguageScore=-1}};c([m({type:String,json:{write:!0}})],x.prototype,`key`,void 0),c([m({type:String,json:{write:!0}})],x.prototype,`text`,void 0),c([m({type:String,json:{read:{source:`detectedLanguage.language`},write:{target:`detectedLanguage.language`}}})],x.prototype,`detectedLanguage`,void 0),c([m({type:Number,json:{read:{source:`detectedLanguage.score`},write:{target:`detectedLanguage.score`}}})],x.prototype,`detectedLanguageScore`,void 0),c([m({type:Object,json:{write:!0}})],x.prototype,`translation`,void 0),x=c([n(`esri.rest.support.TranslateResult`)],x);async function S(e,t,n){let r=t.toJSON();r.contents=JSON.stringify(r.contents),r.token=await d(t.portalUrl,t.apiKey,{signal:n?.signal,prompt:n?.authMode!==`no-prompt`});let i=u(e),o=l(i.query,{...n,query:r,method:`post`,authMode:`anonymous`});return(await a(i.path,o)).data.results.map(e=>x.fromJSON(e))}var C=class extends r{constructor(e){super(e)}};c([m({type:String,json:{write:!0}})],C.prototype,`key`,void 0),c([m({type:String,json:{write:!0}})],C.prototype,`text`,void 0),C=c([n(`esri.rest.support.TranslateContent`)],C);var w=class extends r{constructor(e){super(e),this.to=null,this.contents=null,this.portalUrl=`https://www.arcgis.com`,this.translator=`esri`,this.from=null,this.apiKey=null,this.requestSource=null}};c([m({type:[String],json:{write:!0}})],w.prototype,`to`,void 0),c([m({type:[C],json:{write:!0}})],w.prototype,`contents`,void 0),c([m({type:String,json:{write:!0}})],w.prototype,`portalUrl`,void 0),c([m({type:String,json:{write:!0,default:`esri`}})],w.prototype,`translator`,void 0),c([m({type:String,json:{write:!0}})],w.prototype,`from`,void 0),c([m(b)],w.prototype,`apiKey`,void 0),c([m({type:String,json:{name:`x-esri-request-source`}})],w.prototype,`requestSource`,void 0),w=c([n(`esri.rest.support.TranslateParameters`)],w);var T=class{constructor(e,t){this.portal=e,this._debugLog=t}async translate(e){this.portal.loaded||await this.portal.load();let n=this.portal.helperServices?.aiUtilityServices;if(n==null)return{success:!1};let r=n.url+n.translateUtility;try{return e.requestSource??=`arcade`,{success:!0,results:(await S(r,e,{authMode:`no-prompt`})).map(e=>e.toJSON())}}catch(e){return this._debugLog!=null&&(e instanceof Error||e instanceof t)&&this._debugLog(`TranslateText error: ${e.message}`),f.getLogger(`esri.arcade.functions.aiServices`).error(e),{success:!1}}}},E=class{constructor(e,t,n){this._parameters=e,this._maxTotalContentSize=t,this._maxContentsLength=n,this._requests=[],this._normalizedContents=new Map,this._contentsTotalSize=0}tryAdd(e){let t=new Set(e.filter(e=>!this._normalizedContents.has(e.text)).map(e=>e.text));if(this._requests.length+t.size>this._maxContentsLength)return null;let n=0;for(let e of t)n+=e.length;if((n+this._contentsTotalSize)*(this._parameters.to.length??1)>this._maxTotalContentSize)return null;let r=this._requests.length;for(let{key:t,text:n}of e)s(this._normalizedContents,n,()=>[]).push({batchIdx:r,key:t});return this._requests.push(e),this._contentsTotalSize+=n,r}async send(e){let t=[],n=[],r=0;for(let[e,i]of this._normalizedContents)t.push(new C({key:String(r++),text:e})),n.push(i);let i=new w(this._parameters);i.contents=t;let a=await e.translate(i);if(!a.success)return Array.from(this._requests,()=>a);let o=Array.from(this._requests,()=>({success:!0,results:[]}));for(let e of a.results){let t=Number(e.key);for(let r of n[t])o[r.batchIdx].results.push({...e,key:r.key})}return o}};function D(e){let t=[...new Set(e.to)].sort(),n=e.from??null,r=e.portalUrl,i=e.translator,a=e.apiKey??null;return JSON.stringify([t,n,r,i,a])}async function O(e,t,n){try{return(await e.yieldFor(n))[t]}catch{return{success:!1}}}var k=class{constructor(e,t,{maxTotalContentSize:n=5e4,maxContentsLength:r=1e3}={}){this._executor=e,this._service=t,this._openBatches=new Map,this._maxTotalContentSize=n,this._maxContentsLength=r}create(e){return{translate:async t=>{let n=D(t),{contents:r,to:i,from:a,translator:o,portalUrl:s,apiKey:c}=t;if(i==null||r==null||r.every(e=>e.text.length===0))return{success:!1};let l=this._openBatches.get(n);if(l!=null){let t=l.data.tryAdd(r);if(t!=null)return await O(e,t,l);l.send()}let u=new E({to:i,from:a,translator:o,portalUrl:s,apiKey:c},this._maxTotalContentSize,this._maxContentsLength),d=u.tryAdd(r);if(d!=null){let t=this._executor.openBatch(u,{open:e=>{this._openBatches.set(n,e)},execute:e=>e.send(this._service),close:e=>{this._openBatches.get(n)===e&&this._openBatches.delete(n)}});return await O(e,d,t)}return await this._service.translate(t)}}}};function A(t){t.mode===`async`&&(t.functions[h(`TranslateText`)]=function(n,r){return t.standardFunctionAsync(n,r,async(t,n,r)=>{if(g(r,2,3,t,n),!o(r[0])&&!e(r[0])&&!v(r[0]))throw new p(t,`InvalidParameter`,n);let a=y(r[0]);if(!o(r[1])&&!e(r[1])&&!v(r[1]))throw new p(t,`InvalidParameter`,n);let s=y(r[1]),c=null;if(r.length>=3){if(!o(r[2]))throw new p(t,`InvalidParameter`,n);c=r[2]}let l=a.map((e,t)=>new C({key:String(t),text:e})),u=t.services?.portal??i.getDefault(),d=new w({to:s,contents:l,from:c,portalUrl:u.restUrl.replace(/\/sharing\/rest$/,``)}),f=new Map,m=null;if(t.lrucache!=null){let e=t.lrucache;m??=D(d),d.contents=d.contents?.filter(t=>{let n=e.getCachedTranslation(m,t.text);return n==null||(f.set(t.key,{...n,key:t.key,text:t.text}),!1)})}if(d.contents?.length){let e=t.services?.translation??new T(u,t.console),n=await e.translate(d);if(!n.success)return new _({__proto__:null,success:!1});for(let e of n.results){let n=d.contents?.find(t=>t.key===e.key)?.text;if(n==null)throw new p(null,`NeverReach`,null);f.set(e.key,e),t.lrucache!=null&&(m??=D(d),t.lrucache.setCachedTranslation(m,n,{detectedLanguage:e.detectedLanguage,translation:e.translation}))}}let h=Array.from(l,e=>{let n=x.fromJSON(f.get(e.key));if(n==null)throw new p(null,`NeverReach`,null);return n.text=e.text,_.convertJsonToArcade(n.toJSON(),t.timeZone??`system`,!0)});return new _({__proto__:null,success:!0,results:h})})})}var j=Object.freeze(Object.defineProperty({__proto__:null,BatchTranslationServiceFactory:k,PortalTranslationService:T,getTranslateParametersKey:D,registerFunctions:A},Symbol.toStringTag,{value:`Module`}));export{D as a,k as i,j as n,T as r,A as t};