const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/apiConverter-BpSdY5Dk.js","assets/SpatialReference-CfUjvF_j.js","assets/index-BN8X5Ryz.js","assets/index-CWJhHB6-.css","assets/Envelope2D-B7gkUj4e.js","assets/Point2D-DJueHbCy.js","assets/OperatorDefinitions-C5Pat-Jx.js","assets/SimpleGeometryCursor-BILtMaQf.js","assets/Transformation2D-D07KwcEj.js","assets/memoryEstimations-D_IbKyOk.js","assets/FlatGeometry-BsPiiSVP.js","assets/OptimizedGeometry-BQJ7w5VU.js","assets/apiConverter-Dsm0pxcs.js","assets/jsonConverter-CoA5-zxu.js","assets/jsonConverter-BwXvCkWa.js"])))=>i.map(i=>d[i]);
import{$S as e,$T as t,Af as n,Ag as r,Aw as i,BT as a,CE as o,DT as s,ED as c,En as l,Fw as u,JT as d,Jb as f,Kc as p,Lx as m,ME as h,QT as g,SD as _,VT as v,Vr as ee,Xw as te,ZS as ne,_d as re,_v as ie,_x as ae,bT as oe,bu as se,dT as y,dl as b,ex as ce,fn as le,gT as ue,hT as x,hg as de,iT as fe,iv as pe,jT as me,kD as S,lE as C,lh as he,ll as ge,nv as _e,oT as ve,ox as ye,pT as w,pd as be,pv as xe,qc as Se,sD as Ce,tT as we,tl as Te,un as Ee,ux as De,vE as Oe,ww as ke,zc as Ae}from"./index-BN8X5Ryz.js";import{o as je,r as T}from"./memoryEstimations-D_IbKyOk.js";import{t as E}from"./OptimizedGeometry-BQJ7w5VU.js";import{n as D}from"./OptimizedFeatureSet-CLjmRHYn.js";import{d as Me,h as Ne,i as Pe,l as O,m as Fe,s as Ie,x as Le,y as Re}from"./featureConversionUtils-o9-cJXzl.js";import"./WhereClause-CATd9kVz.js";import{a as ze,i as k,n as Be,r as Ve,t as He}from"./streamLayerUtils-82UmlW-3.js";import"./closestPointOnCurve-CwZL45U3.js";import{n as A}from"./QueueProcessor-D6ozkjY6.js";import"./urlUtils-CW4cnJ3W.js";import"./SimpleGeometryCursor-BILtMaQf.js";import{t as Ue}from"./geodeticCurveType-CcdKHJt5.js";import{a as We,i as Ge,r as Ke}from"./operatorGeodeticDensify-0EE8Fc4Y.js";import"./bundle-DgRwUxDT.js";import"./WhereClauseCache-BO4WYMj9.js";import"./QueryEngineCapabilities-CxeEdoTy.js";import"./clientSideDefaults-Iizf0eUh.js";import"./generateRendererUtils-DGV_dTnd.js";import"./utils-DCGMUq-q.js";import{t as qe}from"./pbf-CO6WFbVS.js";import{n as Je,r as Ye}from"./pbfQueryUtils-CmJPTrN7.js";import"./queryUtils-8f7b9mi_.js";import{n as Xe,o as Ze}from"./query-BXrgTHrc.js";import"./timeSupport-vK4lVcYW.js";import{t as Qe}from"./optimizedFeatureQueryEngineAdapter-DQyaY_b1.js";import{t as $e}from"./QueryEngine-CD8WljsT.js";import{c as et}from"./queryUtils-DGU5ISbw.js";import"./utils-Bftaersa.js";import"./utils-BizEctJo.js";import"./SnappingCandidate-4DPnOY6Y.js";import"./FixedIntervalBinParameters-CMgMaWGN.js";import{t as tt}from"./normalizeUtilsSync-TXjrdJAe.js";import"./date-DluEMNTt.js";import"./geojson-Dz-UDVkw.js";import"./sourceUtils-DJLVoxjN.js";import{a as nt}from"./ogcFeatureUtils-PsfUAxHY.js";import{i as rt,n as it}from"./parquet-CCCEcOEs.js";import"./GeometryUtils-B-8QW9FG.js";import"./VertexElementDescriptor-Cl_nC_ty.js";import{t as at}from"./createConnection-oMDLXxC0.js";import"./labelPoint-1O-zXr9b.js";import{a as j,o as ot,s as st}from"./callExpressionWithCursor-CKz4lb1p.js";import{a as M,c as ct,i as N,l as lt,n as ut,o as dt,r as ft,s as pt,t as mt}from"./FeatureSetReaderParquet-qX-RVCae.js";import{t as P}from"./FeatureMetadata-rc_NIaUe.js";import"./CIMSymbolHelper-B2DBxDPE.js";import"./rasterizingUtils-BsmZb-O9.js";import"./Rect-LbcnjDUG.js";import"./BoundingBox-Dtf81F-g.js";import"./BidiEngine-DvXbVJau.js";import"./TurboLine-B-4S6x00.js";import"./utils-B0heZPZY.js";import{t as ht}from"./UpdateTracking2D-BMTZzgpI.js";import"./constants-BOI_CTg-.js";import{t as gt}from"./CircularArray-Bnt6GPkP.js";import{n as _t,t as vt}from"./FeatureIdInfo-DyWyIgoW.js";import{a as yt,i as F,r as bt,s as xt,t as I}from"./ComputedAttributeStorage-BgTqXVQM.js";import"./PieChartMeshWriter-DaT7xrZR.js";import{n as St,t as Ct}from"./MeshWriterRegistry-DK9CIqdl.js";var wt=class{constructor(e){this._client=e,this.layerView=this._client.createInvokeProxy(``),this.container=this._client.createInvokeProxy(`container`),this._eventLog=this._client.createInvokeProxy(`eventLog`)}onEvent(e){e.type===`error`&&e.error&&`toJSON`in e.error&&(e.error=e.error.toJSON()),pe(this._eventLog.onEvent(e))}},Tt=1,L=2,Et=4,R=8,Dt=16,Ot=32,kt=64,At=128;function z(e){switch(e){case Tt:case R:case Ot:return-1;case L:case kt:return 0;case Et:case Dt:case At:return 1}}function jt(e){switch(e){case Tt:case L:case Et:return-1;case R:case Dt:return 0;case Ot:case kt:case At:return 1}}var Mt=R|33,Nt=Dt|132,Pt=L|5,Ft=kt|160,It=class{constructor(e,t,n,r,i=0){this.tileKey=e,this._bufferingEnabled=t,this._sizeHint=i,this._meshes={self:new xt(this.id,this._sizeHint),neighbors:[]},this._currentRecordOverlaps=0,this._currentEntityOverlaps=0;let a=r?1:0;this._copyBufferedDataIntoSelf=n&&this._bufferingEnabled&&e.level===a}get id(){return this.tileKey.id}vertexStart(){return this._meshes.self.vertexStart()??0}vertexCount(){return this._meshes.self.vertexCount()}indexCount(){return this._meshes.self.indexCount()}indexEnsureSize(e){this._meshes.self.indexEnsureSize(e)}entityStart(e,t=e){this._currentEntityOverlaps=0,this._meshes.self.entityStart(e,t)}entityRecordCount(){return this._meshes.self.entityRecordCount()}entityEnd(){if(this._meshes.self.entityEnd(),this._bufferingEnabled){if(this._copyBufferedDataIntoSelf)return;for(let e=0;e<8;e++){let t=1<<e;this._currentEntityOverlaps&t&&this._meshes.neighbors[e].entityEnd()}}}recordStart(e,t,n){this._currentRecordOverlaps=0,this._meshes.self.recordStart(e,t,n)}recordEnd(e=0){let t=this._meshes.self.recordEnd(this._currentRecordOverlaps);return t&&this._currentRecordOverlaps!==0?(this._copyIntoNeighbors(),this._currentEntityOverlaps|=this._currentRecordOverlaps,!0):t}recordBounds(e,t,n,r){this._bufferingEnabled&&this._addOverlap(e,t,n,r)}recordCount(){return this._meshes.self.recordCount()}metricStart(e){this._meshes.self.metricStart(e)}metricBoxWrite(e){this._meshes.self.metricBoxWrite(e)}metricEnd(){this._meshes.self.metricEnd()}vertexWrite(e){this._meshes.self.vertexWrite(e)}vertexWriteF32(e){this._meshes.self.vertexWriteF32(e)}vertexWriteRegion(e){this._meshes.self.vertexWriteRegion(e)}indexWrite(e){this._meshes.self.indexWrite(e)}serialize(e){let t={message:[],transferList:[]},n=this._meshes.self.serialize();return t.message.push({tileId:this.tileKey.id,...n.message}),t.transferList.push(...n.transferList),this._meshes.neighbors.forEach((n,r)=>{let i=n.serialize(),a=1<<r,o=z(a),s=jt(a),c=new b(this.tileKey).getNormalizedNeighbor(o,s,e);t.message.push({tileId:c.id,...i.message}),t.transferList.push(...i.transferList)}),t}_addOverlap(e,t,n,r){let i=Math.min(512/2,n),a=Math.min(512/2,r),o=255^((e<0+i?Nt:e>=512-i?Mt:Nt|Mt)|(t<0+a?Ft:t>=512-a?Pt:Ft|Pt));this._currentRecordOverlaps|=o}_copyIntoNeighbors(){for(let e=0;e<8;e++){let t=1<<e;if(this._currentRecordOverlaps&t){if(this._copyBufferedDataIntoSelf){let e=-z(t)*512,n=-jt(t)*512;if(n!==0)continue;this._meshes.self.copyLast(e,n);continue}if(!this._meshes.neighbors[e]){let n=Math.floor(this._sizeHint/16);this._meshes.neighbors[e]=new xt(t,n)}let n=this._meshes.neighbors[e],r=-z(t)*512,i=-jt(t)*512;n.copyLastFrom(this._meshes.self,r,i)}}}},Lt=class{},B=class e{constructor(){this._defaultResult=null,this._backgroundFillResult=null}static async from(t,n){let r=new e;return r.setDefault(await t.createMeshWriters(n.meshes)),r}size(){return 1}getDefault(){return this._defaultResult}setDefault(e){this._defaultResult=e}getBackgroundFill(){return this._backgroundFillResult}setBackgroundFill(e){this._backgroundFillResult=e}hasArcadeDependency(e){return this._defaultResult?.some(t=>t.hasArcadeDependency(e))??!1}match(e,t,n){let r=this.doMatch(e,t)||this.getDefault();if(r&&r.length>0){let e=this.getBackgroundFill();if(e)return[...e,...r]}return r}getSortKey(e,t){return 0}doMatch(e,t){return null}async fetchResources(e,t){}},Rt=class e extends B{static async fromDictionaryRenderer(t,n){let r=await Ee.from(n.dictionaryInfo,n.userConfig,n.fieldMap);return new e(t,r)}constructor(e,t){super(),this._context=e,this._evaluator=t,this._controlStringToPromise=new Map,this._controlStringToGroup=new Map}async fetchResources(e,t){let n=t.getCursor(),r=new Set;for(;n.next();){let e=this._evaluateControlString(n);e&&r.add(e)}let i=Array.from(r.values()).map(t=>this._ensureGroup(e,t));await Promise.all(i)}match(e,t){let n=this._evaluateControlString(e);return n?this._controlStringToGroup.get(n):null}_evaluateControlString(e){let t=e.readLegacyFeatureWorldSpace();return this._evaluator.evaluate(t,0,e.fields,null)}_ensureGroup(e,t){let n=this._controlStringToPromise.get(t);return n??(n=this._fetchGroup(e,t),this._controlStringToPromise.set(t,n)),n}async _fetchGroup(e,t){let n=await e.fetchDictionaryResourceImmediate({type:`dictionary-request`,controlString:t});if(!n)return;let r=await this._context.createMeshWriters(n.meshes);this._controlStringToGroup.set(t,r)}},zt=class e extends B{constructor(e,t){super(),this._intervals=[],this._isMaxInclusive=t,this._field=e}static async fromIntervalSchema(t,n){let r=await t.storage.createComputedField(n),i=new e(r,n.isMaxInclusive);await Promise.all(n.intervals.map(async e=>{let n=await t.createMeshWriters(e.meshes);i.add(e,n)}));let a=await t.createMeshWriters(n.defaultSymbol);i.setDefault(a);let o=await t.createMeshWriters(n.backgroundFill);return i.setBackgroundFill(o),i}add(e,t){this._intervals.push({interval:e,result:t}),this._intervals.sort((e,t)=>e.interval.min-t.interval.min)}size(){return super.size()+this._intervals.length}hasArcadeDependency(e){return this._field?.hasArcadeDependency(e)||this._intervals.some(t=>t.result.some(t=>t.hasArcadeDependency(e)))}doMatch(e,t){let n=this._field?.read(e,t);if(n==null||isNaN(n)||n===1/0||n===-1/0)return null;for(let e=0;e<this._intervals.length;e++){let{interval:t,result:r}=this._intervals[e],i=n>=t.min,a=this._isMaxInclusive?n<=t.max:n<t.max;if(i&&a)return r}return null}},Bt=class e extends B{static async fromLabelSchema(t,n){let r=n.classes.map(async e=>{let n=await t.createMeshWriters(e.meshes);return{minScale:e.minScale,maxScale:e.maxScale,meshes:n,expression:null,where:await t.storage.createWhereClause(e.where)}}),i=await Promise.all(r);return new e(i)}constructor(e){super(),this._labels=e}match(e,t,n){if(!this._labels.length)return null;let r=this._getLabels(t.$view.scale),i=[];for(let t of r)t.where&&!t.where(e,n)||i.push(...t.meshes);return i}hasArcadeDependency(e){return this._labels.some(t=>t.meshes.some(t=>t.hasArcadeDependency(e)))}_getLabels(e){return this._labels.filter(t=>this._validForTileScale(t,e))}_validForTileScale(e,t){let n=t-t/4,r=t+t/2;return(!e.minScale||e.minScale>=n)&&(!e.maxScale||e.maxScale<=r)}},Vt=class e extends B{constructor(e,t){super(),this._defaultSymbolSortKey=0,this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fields=e,this._separator=t||``}static async fromMatcherSchema(t,n){let r=n.expression?[t.storage.createComputedField({expression:n.expression})]:[n.field?t.storage.createComputedField({field:n.field}):null,n.field2?t.storage.createComputedField({field:n.field2}):null,n.field3?t.storage.createComputedField({field:n.field3}):null],i=(await Promise.all(r)).filter(e=>!!e),a=new e(i,n.fieldDelimiter),o=await t.createMeshWriters(n.defaultSymbol);a.setDefault(o);let s=await t.createMeshWriters(n.backgroundFill);return a.setBackgroundFill(s),await Promise.all(n.map.map(async(e,n)=>{let r=await t.createMeshWriters(e.symbol);e.value===`<Null>`?a.setNullResult(r):a.add(e.value,r,n+1)})),a}setNullResult(e){this._nullResult=e}getSortKey(e,t){let n=this._getValueFromFields(e,t);if(n==null||n===``||n===`<Null>`)return 0;let r=this._resultsMap.get(n.toString());return r?r.sortKey:this._defaultSymbolSortKey}add(e,t,n){this._resultsMap.set(e.toString(),{meshWriters:t,sortKey:n}),this._defaultSymbolSortKey=Math.max(this._defaultSymbolSortKey,n+1)}size(){return super.size()+this._resultsMap.size}hasArcadeDependency(e){return this._fields.some(t=>t.hasArcadeDependency(e))||[...this._resultsMap.values()].some(t=>t.meshWriters.some(t=>t.hasArcadeDependency(e)))||this._nullResult?.some(t=>t.hasArcadeDependency(e))||!1}doMatch(e,t){let n=this._getValueFromFields(e,t);if(this._nullResult!==null&&(n==null||n===``||n===`<Null>`))return this._nullResult;if(n==null)return null;let r=n.toString();return this._resultsMap.get(r)?.meshWriters}_getValueFromFields(e,t){let n=[];for(let r of this._fields){let i=r.read(e,t);i==null||i===``?n.push(`<Null>`):n.push(i)}return n.join(this._separator)}};async function V(e,t){switch(t.type){case`simple`:case`heatmap`:case`dot-density`:case`pie-chart`:return B.from(e,t);case`interval`:return zt.fromIntervalSchema(e,t);case`dictionary`:return Rt.fromDictionaryRenderer(e,t);case`label`:return Bt.fromLabelSchema(e,t);case`map`:return Vt.fromMatcherSchema(e,t);case`subtype`:return Ht.fromSubtypes(e,t);case`cluster`:return Ut.fromClusterSchema(e,t);case`track`:return Wt.fromTrackSchema(e,t);default:throw Error(`Impl`)}}var Ht=class e extends B{constructor(e,t){super(),this._subMatchers=e,this._subtypeField=t}static async fromSubtypes(t,n){let r=new Map,i=[];for(let e in n.renderers){let a=parseInt(e,10),o=V(t,n.renderers[e]).then(e=>r.set(a,e));i.push(o)}return await Promise.all(i),new e(r,n.subtypeField)}match(e,t,n){let r=e.readAttribute(this._subtypeField),i=this._subMatchers.get(r);return i?i.match(e,t,n):null}hasArcadeDependency(e){for(let t of this._subMatchers.values())if(t.hasArcadeDependency(e))return!0;return!1}},Ut=class e extends B{static async fromClusterSchema(t,n){let[r,i]=await Promise.all([V(t,n.feature),V(t,n.cluster)]);return new e(r,i)}constructor(e,t){super(),this._featureMatcher=e,this._clusterMatcher=t}match(e,t,n){return e.readAttribute(`cluster_count`)===1?this._featureMatcher.match(e,t,n):this._clusterMatcher.match(e,t,n)}hasArcadeDependency(e){return this._featureMatcher.hasArcadeDependency(e)||this._clusterMatcher.hasArcadeDependency(e)}},Wt=class e extends B{static async fromTrackSchema(t,n){let[r,i,a]=await Promise.all([V(t,n.previousObservation),V(t,n.latestObservation),V(t,n.trackLine)]);return new e(r,i,a)}constructor(e,t,n){super(),this._previousObservationMatcher=e,this._latestObservationMatcher=t,this._trackLineMatcher=n}match(e,t,n){switch(e.readAttribute(k)){case 0:return this._trackLineMatcher.match(e,t,n);case 1:return this._latestObservationMatcher.match(e,t,n);case 2:return this._previousObservationMatcher.match(e,t,n)}return null}hasArcadeDependency(e){return this._trackLineMatcher.hasArcadeDependency(e)||this._latestObservationMatcher.hasArcadeDependency(e)||this._previousObservationMatcher.hasArcadeDependency(e)}},Gt=class e extends Lt{static async create(t,n){let r=await V(t,n.symbology),i=n.labels?await V(t,n.labels):null;return new e(r,i)}constructor(e,t){super(),this._symbology=e,this._labels=t}destroy(){}async enqueueMatcherRequests(e,t){await Promise.all([this._symbology.fetchResources(e,t),this._labels?.fetchResources(e,t)])}enqueueWriterRequests(e,t,n,r){let i=this._symbology.match(t,n,r);if(i){for(let r of i)r.enqueueRequest(e,t,n);if(this._labels){let i=this._labels.match(t,n,r);if(!i)return;for(let r of i)r.enqueueRequest(e,t,n)}}}write(e,t,n,r,i,a){let o=this._symbology.match(n,r,i);if(o){for(let i of o)i.write(e,t,n,r,a);if(e.entityRecordCount()>=1&&this._labels){let s=this._labels.match(n,r,i);if(!s)return;for(let i of s)i.setReferences(o),i.write(e,t,n,r,a)}}}getSortKey(e,t){return this._symbology.getSortKey(e,t)}hasArcadeDependency(e){return!(!this._symbology.hasArcadeDependency(e)&&!this._labels?.hasArcadeDependency(e))}},Kt=class{constructor(e,t,n,r,i){this.storage=e,this.proxy=t,this.viewParams=n,this.registry=r,this.fieldsMap=i}async createMeshWriters(e){let t=e.map(e=>this.registry.createMeshWriter(this.storage,this.proxy,this.viewParams,e,this.fieldsMap));return Promise.all(t)}},qt=class{constructor(e){this._outstandingMessages=[],this._queue=new A({concurrency:e.concurrency,process:t=>e.process(t)})}async push(e){if(e.end)return await Promise.all(this._outstandingMessages),await this._queue.push(e),void(this._outstandingMessages=[]);let t=this._queue.push(e);return this._outstandingMessages.push(t),t}},Jt=class e{static async create(t,n){if(n.statisticType===`count`){let t=new St(1);return new e(n.name,n.alias,n.type,n.statisticType,t)}let r=await t.createComputedField({expression:n.onStatisticExpression?.expression,field:n.onStatisticField});return new e(n.name,n.alias,n.type,n.statisticType,r)}constructor(e,t,n,r,i){this.name=e,this.alias=t,this.type=n,this.statisticType=r,this.computed=i}},H=class{constructor(e){this.subscription=e,this.handledChunks=new Set}destroy(){}},Yt=class{constructor(e,t,n){this._source=e,this._attributeStore=t,this._sqlOptions=n,this._sendStates=new Map}destroy(){}get enablePixelBuffering(){return!0}get isAggregate(){return!1}get usedMemory(){return 0}onSubscribe(e){let t=this.createState(e);this._sendStates.set(e.key.id,t),this.updateChunks()}onUnsubscribe(e){this._sendStates.get(e.key.id)?.destroy(),this._sendStates.delete(e.key.id)}get hasSubscribers(){return this._sendStates.size>0}requiresInvalidation(){return!1}invalidate(){let e=Array.from(this._sendStates.values());this._sendStates.clear();for(let t of e)t.destroy(),this.onSubscribe(t.subscription)}invalidateAttributeData(e){}hasArcadeDependency(e){return!1}getFeatureObjectIdsForAggregate(e){throw Error(`InternalError: AggregateId lookup not supported`)}getDisplayIds(e){return this.displayMap(e,e=>e,e=>e)}getDisplayAndObjectIds(e){return this.displayMap(e,e=>e,(e,t,n)=>[e,n])}afterUpdateChunks(){}},Xt=class extends Yt{constructor(e,t,n,r,i){super(e,t,i),this.spatialReference=n,this.aggregateFields=r,this._arcadeDependencies=new Set,this.events=new ie,this.featureAdapter=Qe;for(let e of r)le(this._arcadeDependencies,e.computed)}get aggregateQueryEngine(){return this._aggregateQueryEngine||=new $e({featureStore:this,fieldsIndex:this._metadata.fieldsIndex,geometryType:this._metadata.geometryType,featureIdInfo:this._metadata.featureIdInfo,spatialReference:this.spatialReference}),this._aggregateQueryEngine}get isAggregate(){return!0}removeChunks(e){}hasArcadeDependency(e){return this._arcadeDependencies.has(e)}forEach(e){return this.forEachAggregateWorldSpace(e)}forEachInBounds(e,t){}forEachBounds(e,t){let r=n();for(let n of e){let e=Le(r,n.geometry);e&&t(e)}}},U=class{constructor(e,t,n,r,i){this.subscription=e,this.reader=t,this.clear=n,this.end=r,this.debugInfo=i,this.type=`append`}get id(){return this.subscription.tile.id}createMessage(e,t,n){return{type:`append`,clear:this.clear,id:this.id,append:e,end:this.end,debugInfo:this.debugInfo,subscriptionVesrion:this.subscription.version,version:t,attributeEpoch:n}}},Zt=class{constructor(e,t,n,r,i){this.subscription=e,this.reader=t,this.remove=n,this.end=r,this.debugInfo=i,this.type=`update`}get id(){return this.subscription.tile.id}createMessage(e,t,n){return{type:`update`,id:this.id,modify:e,debugInfo:this.debugInfo,remove:this.remove,version:t,subscriptionVesrion:this.subscription.version,end:this.end,attributeEpoch:n}}},Qt=class extends H{constructor(e,t){super(e),this.bins=new Map,this.featureCache=new Map,this.done=!1,this._store=t}reset(){this.destroy(),this.done=!1}destroy(){let e=this.subscription.tile.key.level;for(let t of this.featureCache.keys())this._store.releaseDisplayIdForObjectId(`${t}.${e}`);this.bins.clear(),this.featureCache.clear(),this.handledChunks.clear()}get tile(){return this.subscription.tile}*featuresWorldSpace(){for(let e of this.featureCache.values()){let t=e.clone();t.geometry&&Ne(t.geometry,this.subscription.tile.transform),yield t}}},$t=class e extends Xt{static async create(t,n,r,i,a){let o=n.metadata.outSpatialReference,s=new I({spatialReference:o}),c=await Promise.all(t.fields.map(async e=>Jt.create(s,e))),l=t.featureFilter?await F.create({geometryType:n.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:n.metadata.timeInfo,fieldsIndex:n.metadata.fieldsIndex,spatialReference:o,filterJSON:t.featureFilter}):null;return t.index.type===`geohash`&&await et(o,m.WGS84),new e(t,l,i,c,o,n,r,a)}constructor(e,t,n,r,i,a,o,s){super(a,o,i,r,s),this._schema=e,this._featureFilter=t,this._arcadeContextInfo=n,this._metadata=P.createFeature({geometryType:`esriGeometryPolygon`,featureIdInfo:{type:`object-id`,fieldName:`aggregateId`},fieldsIndex:new l(e.fields).toJSON(),globalIdField:null,spatialReference:a.metadata.spatialReference,outSpatialReference:a.metadata.outSpatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null,types:null})}createState(e){return new Qt(e,this._attributeStore)}async*applyOverrideUpdate(e){for(let e of this._sendStates.values())e.reset(),yield new U(e.subscription,j.empty(this._source.metadata),!0,!1,{})}displayMap(e,t,n){let r=new Map(e.map(e=>[t(e),e])),i=[];for(let e of this._sendStates.values())for(let t of e.featuresWorldSpace()){let{objectId:e,displayId:a}=t,o=r.get(e);if(o!=null){let t=n(a,o,e);i.push(t),r.delete(e)}}return i}getDisplayFeatures(e){let t=new Set(e),n=new Set,r=[];for(let e of this._sendStates.values())for(let i of e.featuresWorldSpace())t.has(i.displayId)&&!n.has(i.objectId)&&(i.geometry&&r.push({...Pe(i,this._metadata.geometryType,!1,!1),displayId:i.displayId}),n.add(i.objectId));return{features:[],aggregates:r,tracks:[]}}getFeatureObjectIdsForAggregate(e){for(let t of this._sendStates.values())for(let n of t.bins.values())if(n.id===e)return Array.from(n.containedObjectIds);return[]}async*updateChunks(){for(let e of this._sendStates.values())yield*this._update(e,this._source)}forEachAggregateWorldSpace(e){let t=new Set;for(let n of this._sendStates.values())for(let r of n.featuresWorldSpace())t.has(r.objectId)||(e(r),t.add(r.objectId))}_createIndexOptions(e){switch(this._schema.index.type){case`geohash`:return{type:`geohash`,fields:this.aggregateFields,featureFilter:this._featureFilter,geohashLevel:this._schema.index.fixBinLevel,spatialReference:this.spatialReference,arcadeContextInfo:this._arcadeContextInfo,scale:e.scale,sqlOptions:this._sqlOptions};case`grid`:{let t=this._schema.index.fixedBinLevel,n=t==null?e.scale:e.tileInfoView.getLODInfoAt(t).scale;return{type:`grid`,fields:this.aggregateFields,cellSize:this._schema.index.size,featureFilter:this._featureFilter,spatialReference:this.spatialReference,arcadeContextInfo:this._arcadeContextInfo,scale:n,sqlOptions:this._sqlOptions}}}}async*_update(e,t){let{handledChunks:n,subscription:r,bins:i,featureCache:a}=e,o=r.tile;if(e.done)return;for(let r of t.chunks()){if(n.has(r.chunkId))continue;n.add(r.chunkId);let t=r.queryInfo;if(`tileId`in t){let e=new b(t.tileId);if(e.level!==o.level||e.world!==o.key.world)continue}r.getAggregateIndex(this._createIndexOptions(e.tile)).putBounded(i,e.tile.extent,e.tile.resolution)}let s=[],c=r.tile.transform,l=r.tile.key.level;for(let e of i.values()){let t=a.get(e.id);if(t)t.attributes=e.getAttributes();else{let n=e.getGeometry(this.spatialReference,c);t=new D(n,e.getAttributes(),null,e.id),n||(t.centroid=e.getGeometricCentroid(this.spatialReference,c)),t.displayId=this._attributeStore.createDisplayIdForObjectId(`${t.objectId}.${l}`),a.set(e.id,t)}s.push(t)}this.events.emit(`changed`),e.done=!t.updateTracking.updating;let u=j.fromOptimizedFeatures(s,this._metadata,c),d=u.getCursor(),f=e.subscription.tile.createArcadeEvaluationOptions(this._arcadeContextInfo);for(;d.next();)this._attributeStore.setAttributeData(d.getDisplayId(),d,f,this._sqlOptions);yield new Zt(e.subscription,u,[],e.done,{})}},en=class{constructor(e,t){this.inner=e,this.displayId=t}},W=128,tn=class extends H{constructor(e){super(e),this.didSend=!1,this.done=!1}},nn=class{constructor(e,t,n,r,i){this._level=e,this._scale=t,this._indexOptions=n,this._clusterRadius=r,this._store=i,this._cells=new Map,this._handledChunks=new Set,this._statistics=new Map,this._clusters=new Map}destroy(){this._clearClusters()}_clearClusters(){for(let e of this._clusters.values())this._store.releaseDisplayIdForObjectId(e.inner.id);this._clusters.clear()}*aggregatesWorldSpace(){for(let e of this._clusters.values()){let t=e.inner.getCentroid(null);yield new D(t,e.inner.getAttributes(),null,e.inner.id,e.displayId)}}clusters(){return this._clusters.values()}updateChunks(e,t){let n=!1;for(let t of e){let e=t.queryInfo;if(`tileId`in e&&new b(e.tileId).level!==this._level)continue;this._handledChunks.has(t.normalizedChunkId)||(this._handledChunks.add(t.normalizedChunkId),n=!0,t.getAggregateIndex({...this._indexOptions,scale:this._scale}).put(this._cells))}let r={xMin:1/0,yMin:1/0,xMax:-1/0,yMax:-1/0},i=pt(this._indexOptions.spatialReference,this._scale),a=this._indexOptions.cellSize;for(let{subscription:e}of t){let t=e.tile.bounds,n=Math.floor(t[0]*i/a),o=Math.floor(t[1]*i/a),s=Math.ceil(t[2]*i/a),c=Math.ceil(t[3]*i/a);r.xMin=Math.min(r.xMin,n),r.yMin=Math.min(r.yMin,o),r.xMax=Math.max(r.xMax,s),r.yMax=Math.max(r.yMax,c)}return this._lastCellBounds!=null&&r.xMin===this._lastCellBounds.xMin&&r.yMin===this._lastCellBounds.yMin&&r.yMin===this._lastCellBounds.yMin&&r.yMax===this._lastCellBounds.yMax||(n=!0,this._lastCellBounds=r),n&&this._clusterCells(r),n}async updateStatistics(e){let t=!1;for(let e of this._clusters.values())e.inner.count>1&&(t=this._updateAggregateStatistics(this._statistics,e.inner)||t);if(t){let t=Array.from(this._statistics.entries()).map(([e,t])=>({fieldName:e,minValue:t.minValue,maxValue:t.maxValue}));await e.container.updateStatistics(this._level,t)}}createAggregateFeatures(e,t){let n=e.subscription,r=[],i=n.tile.transform;for(let e of this._clusters.values()){let t=e.inner.getCentroidX(i),a=e.inner.getCentroidY(i),o=n.tile.lod,s=o.wrap?o.worldSize[0]:null,c=e.inner.count===1?e.inner.firstObjectId:e.inner.id,l=e.displayId;if(s!=null)if(s===1){let n=new E([],[t,a]),i=new D(n,e.inner.getAttributes(),null,c,l);i.geometry.coords[0]-=512,r.push(i);let o=new E([],[t,a]),s=new D(o,e.inner.getAttributes(),null,c,l);s.geometry.coords[0]+=512,r.push(s)}else t>768?t-=s*512:t<-256&&(t+=s*512);if(t<512+W&&t>=-W&&a<512+W&&a>=-W){let n=new E([],[t,a]),i=new D(n,e.inner.getAttributes(),null,c,l);r.push(i)}}return j.fromOptimizedFeatures(r,t,n.tile.transform)}_clusterCells(e){let t=Array.from(this._cells.values());t=t.sort((e,t)=>t.count-e.count);let n=[];for(let e of this._clusters.values())n.push(e.inner.id);this._clusters.clear();let r=this._clusterRadius*(1/pt(this._indexOptions.spatialReference,this._scale)),i=1+this._clusterRadius/this._indexOptions.cellSize,a=new Set;for(let n of t){if(a.has(n.id)||n.gridX<e.xMin||n.gridX>e.xMax||n.gridY<e.yMin||n.gridY>e.yMax)continue;let t=this._store.createDisplayIdForObjectId(n.id),o=new en(n.clone(),t);a.add(n.id),this._clusters.set(n.id,o);let s=n.centroidXWorld,c=n.centroidYWorld;for(let e=n.gridY-i;e<=n.gridY+i;e++)for(let t=n.gridX-i;t<=n.gridX+i;t++){if(e===n.gridY&&t===n.gridX)continue;let i=this._cells.get(ct.createId(t,e));if(!i||a.has(i.id))continue;let l=Math.abs(i.centroidXWorld-s),u=Math.abs(i.centroidYWorld-c);l<r&&u<r&&(o.inner.merge(i),a.add(i.id))}}for(let e of n)this._store.releaseDisplayIdForObjectId(e)}_updateAggregateStatistics(e,t){let n=!1;for(let r of t.statistics.values()){if(r.field.type===`esriFieldTypeString`)continue;let t=r.value,i=r.field,a=e.get(i.name);if(a){let{minValue:e,maxValue:r}=a,i=Math.min(a.minValue,t),o=Math.max(a.maxValue,t);e===i&&r===o||(a.minValue=i,a.maxValue=o,n=!0);continue}e.set(i.name,{minValue:t,maxValue:t}),n=!0}return n}},rn=class e extends Xt{static async create(t,n,r,i,a,o){let s=r.metadata.outSpatialReference,c=new I({spatialReference:s}),l={type:`grid`,fields:await Promise.all(n.fields.map(async e=>Jt.create(c,e))),spatialReference:s,featureFilter:n.featureFilter?await F.create({geometryType:r.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:r.metadata.timeInfo,fieldsIndex:r.metadata.fieldsIndex,spatialReference:s,filterJSON:n.featureFilter}):null,cellSize:n.clusterRadius/4,arcadeContextInfo:a,sqlOptions:o};return new e(t,n.clusterRadius,l,n.fields,r,i,o)}constructor(e,t,n,r,i,a,o){super(i,a,n.spatialReference,n.fields,o),this._connection=e,this._clusterRadius=t,this._indexOptions=n,this._cellsPerScale=new Map,this._metadata=P.createFeature({geometryType:`esriGeometryPoint`,featureIdInfo:{type:`object-id`,fieldName:`aggregateId`},fieldsIndex:new l([...r,...this._source.metadata.fieldsIndex.fields,{name:`aggregateId`,alias:`aggregateId`,type:`esriFieldTypeOID`}]).toJSON(),globalIdField:null,spatialReference:i.metadata.spatialReference,outSpatialReference:i.metadata.outSpatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null,types:null})}get enablePixelBuffering(){return!1}invalidate(){super.invalidate();for(let e of this._cellsPerScale.values())e.destroy();this._cellsPerScale.clear()}onSubscribe(e){super.onSubscribe(e),this._requiredLevel=e.tile.level,this._requiredScale=e.tile.scale}createState(e){return new tn(e)}async*applyOverrideUpdate(e){for(let e of this._cellsPerScale.values())e.destroy();this._cellsPerScale.clear();for(let e of this._sendStates.values())e.done=!1}displayMap(e,t,n){let r=new Map(e.map(e=>[t(e),e])),i=[],a=this._getClusterState(this._requiredLevel,this._requiredScale);for(let e of a.clusters()){let t=r.get(e.inner.id);if(t!=null){let a=n(e.displayId,t,e.inner.id);i.push(a),r.delete(e.inner.id);continue}if(e.inner.count===1){let{firstObjectId:t}=e.inner,a=t?r.get(t):null;if(a!=null){let o=n(e.displayId,a,t);i.push(o),r.delete(t)}}}return i}getDisplayFeatures(e){let t=new Set(e),n=new Set,r=[],i=[],a=this._getClusterState(this._requiredLevel,this._requiredScale);for(let e of a.aggregatesWorldSpace())if(t.has(e.displayId)&&!n.has(e.displayId)){let t=Pe(e,this._metadata.geometryType,!1,!1);if(n.add(e.displayId),t.attributes.cluster_count===1){r.push({...t,displayId:e.displayId});continue}i.push({...t,displayId:e.displayId})}return{features:r,aggregates:i,tracks:[]}}getFeatureObjectIdsForAggregate(e){let t=this._getClusterState(this._requiredLevel,this._requiredScale);for(let n of t.clusters())if(n.inner.id===e)return Array.from(n.inner.containedObjectIds);return[]}async*updateChunks(){let e=this._source.chunks();if(!e.length)return;let t=this._getClusterState(this._requiredLevel,this._requiredScale),n=Array.from(this._sendStates.values()).filter(e=>e.subscription.tile.level===this._requiredLevel);if(t.updateChunks(e,n)||!this._source.updateTracking.updating)for(let e of n)e.subscription.tile.level===this._requiredLevel&&(e.didSend=!1,e.done=!1);let r=Array.from(this._sendStates.values()).filter(e=>e.done).map(e=>e.subscription.tile.key),i=new Set(r);for(let e of this._sendStates.values()){if(this._source.updateTracking.updating&&(r.some(t=>t.containsChild(e.subscription.tile.key))||e.subscription.tile.key.getChildKeys().every(e=>i.has(e))))continue;e.didSend||e.subscription.tile.level!==this._requiredLevel||(e.didSend=!0,yield*this._update(e,t,this._source))}await t.updateStatistics(this._connection)}forEachAggregateWorldSpace(e){if(this._requiredLevel==null||this._requiredScale==null)return;let t=this._getClusterState(this._requiredLevel,this._requiredScale);for(let n of t.aggregatesWorldSpace())e(n)}_getClusterState(e,t){if(e==null||t==null)throw Error(`InternalError: Level and scale must be defined`);let n=this._cellsPerScale.get(t);return n||(n=new nn(e,t,this._indexOptions,this._clusterRadius,this._attributeStore),this._cellsPerScale.set(t,n)),n}async*_update(e,t,n){if(e.done)return;let r=t.createAggregateFeatures(e,this._metadata);this.events.emit(`changed`),e.done=!n.updateTracking.updating;let i=r.getCursor(),a=e.subscription.tile.createArcadeEvaluationOptions(this._indexOptions.arcadeContextInfo);for(;i.next();)this._attributeStore.setAttributeData(i.getDisplayId(),i,a,this._sqlOptions);yield new U(e.subscription,r,!0,e.done,{})}},an=class extends H{},on=class extends Yt{constructor(e,t,n,r){super(e,t,r),this._arcadeContextInfo=n,this.handledChunks=new Set,this.handledChunksForIdCreation=new Set,this.handledChunksForAttributeData=new Set,this._streamLayerDeferredObjectIdsToRemove=[]}destroy(){super.destroy();for(let e of this._source.chunks())this._cleanupChunkIds(e)}invalidateAttributeData(e){this.handledChunksForAttributeData.clear(),this._arcadeContextInfo=e,this._evalOptions!=null&&(this._evalOptions=Se(this._evalOptions.$view.scale,e))}onSubscribe(e){super.onSubscribe(e),this._evalOptions=e.tile.createArcadeEvaluationOptions(this._arcadeContextInfo)}createState(e){return new an(e)}get aggregateQueryEngine(){return null}displayMap(e,t,n){let r=new Map(e.map(e=>[t(e),e])),i=[];for(let e of this._source.chunks()){let t=e.reader.getCursor();for(;t.next();){let e=t.getObjectId(),a=t.getDisplayId(),o=r.get(e);if(o!=null){let t=n(a,o,e);i.push(t),r.delete(e)}}}return i}getDisplayFeatures(e){let t=new Set(e),n=new Set,r=[];for(let e of this._source.chunks()){let i=e.reader.getCursor();for(;i.next();){let e=i.getObjectId(),a=i.getDisplayId();t.has(a)&&!n.has(e)&&(r.push({...i.readLegacyFeatureWorldSpace(),displayId:a}),n.add(e))}}return{features:r,aggregates:[],tracks:[]}}async*applyOverrideUpdate(e){let t=[];for(let n of e.modified.values()){let e=this._attributeStore.createDisplayIdForObjectId(n.objectId);n.displayId=e,t.push(e)}let n=j.fromOptimizedFeatures(Array.from(e.modified.values()),this._source.metadata).getCursor();for(;n.next();)this._attributeStore.setAttributeData(n.getDisplayId(),n,this._evalOptions,this._sqlOptions);let r=[];for(let t of e.removed){let e=this._attributeStore.getDisplayIdForObjectId(t);e!=null&&r.push(e)}c(`esri-2d-update-debug`)&&console.debug(`FeatureUpdateStrategy.applyLocalEdit`,{message:e,modifiedDisplayIds:t,removedDisplayIds:r});let i=ft.fromFeatures(Array.from(e.modified.values()),this._source.metadata);this.handledChunks.add(i.chunkId),this.handledChunksForAttributeData.add(i.chunkId),this.handledChunksForIdCreation.add(i.chunkId);for(let e of this._sendStates.values())e.handledChunks.add(i.chunkId),yield new Zt(e.subscription,null,t,!1,i.queryInfo);for(let e of this._sendStates.values()){let t=i.getTileReader(e.subscription.tile);yield new Zt(e.subscription,t,r,!1,i.queryInfo)}for(let t of e.removed)this._attributeStore.releaseDisplayIdForObjectId(t)}async*updateChunks(){if(this._source.chunks().length){this._updateAttributeData();for(let e of this._sendStates.values())yield*this._update(e)}}removeChunks(e){for(let t of e)this.handledChunks.delete(t.chunkId),this.handledChunksForAttributeData.delete(t.chunkId),this._cleanupChunkIds(t)}afterUpdateChunks(){for(let e of this._streamLayerDeferredObjectIdsToRemove)this._attributeStore.releaseDisplayIdForObjectId(e);this._streamLayerDeferredObjectIdsToRemove=[]}_cleanupChunkIds(e){if(this.handledChunksForIdCreation.has(e.chunkId)){let t=e.reader.getCursor();for(;t.next();){let e=t.getObjectId();this._source.isStream?this._streamLayerDeferredObjectIdsToRemove.push(e):this._attributeStore.releaseDisplayIdForObjectId(e)}this.handledChunksForIdCreation.delete(e.chunkId)}}_updateAttributeData(){for(let e of this._source.chunks()){let{chunkId:t,reader:n}=e;if(!this.handledChunksForIdCreation.has(t)){this.handledChunksForIdCreation.add(t);let e=n.getCursor();for(;e.next();){let t=this._attributeStore.createDisplayIdForObjectId(e.getObjectId());e.setDisplayId(t)}}}for(let e of this._source.chunks())if(this._attributeStore.referencesScale()||!this.handledChunksForAttributeData.has(e.chunkId)){this.handledChunksForAttributeData.add(e.chunkId);let t=e.reader.getCursor();for(;t.next();){let e=t.getDisplayId();this._attributeStore.setAttributeData(e,t,this._evalOptions,this._sqlOptions)}}}*_update(e){let{subscription:t,handledChunks:n}=e;for(let r of this._source.chunks()){let{chunkId:i}=r;if(n.has(i)||!this.handledChunksForIdCreation.has(i)||!this.handledChunksForAttributeData.has(i))continue;n.add(i);let a=r.getTileReader(t.tile);a&&(yield new U(e.subscription,a,!1,r.end,r.queryInfo))}}},G,sn=()=>o.getLogger(`esri.views.2d.layers.features.processor.TrackStrategy`),cn=32,ln=class{constructor(e,t,n,r,i){this.chunkIndex=e,this.featureIndex=t,this.objectId=n,this.displayId=r,this.time=i}},un=class{static getOid(e){return ze+e}constructor(e,t,n,r,i,a,o,s){this._schema=e,this.trackId=t,this.objectId=n,this.displayId=r,this._fields=i,this._spatialReference=a,this._metadata=o,this._isStream=s,this._maxDisplayDuration=this._schema.maxDisplayDuration>0?this._schema.maxDisplayDuration:1/0,this._maxDisplayObservationsPerTrack=this._schema.maxDisplayObservationsPerTrack>=1?this._schema.maxDisplayObservationsPerTrack:1/0,this._observationRecords=[],this._nextObservationRecords=[],this._trackLinePath=[],this._bounds=[],this._trackLineGeometry=new E}get _trackLineAttributes(){let e={...this._latestObservationFeature?.attributes,aggregateId:this.objectId,[k]:0};if(this._statistics!=null)for(let t of this._statistics.values())e[t.field.name]=t.value;return e}get _startTimeField(){return this._metadata.timeInfo?.startTimeField}get length(){return this._observationRecords.length}*observations(){yield*this._observationRecords}*previousObservations(){for(let e=0;e<this._observationRecords.length-1;e++)yield this._observationRecords[e]}get latestObservationFeature(){return this._latestObservationFeature}get latestObservationRecord(){return this._latestObservationRecord}stageObservation(e,t){this._nextObservationRecords.push(new ln(e,t.getIndex(),t.getObjectId(),t.getDisplayId(),this._startTimeField==null?null:t.readAttributeAsTimestamp(this._startTimeField)))}commitObservations(e,t,n){let r=new Set(this._nextObservationRecords.map(e=>e.objectId)),i=this._observationRecords.filter(e=>!r.has(e.objectId)).map(e=>e.objectId),a,o;switch(this._observationRecords=[],this._trackLinePath=[],this._isStream||this._startTimeField==null||this._nextObservationRecords.sort((e,t)=>{let n=e.time,r=t.time;return n!=null&&r!=null?n-r:0}),this._schema.timeField){case`startTimeField`:a=this._metadata.timeInfo?.startTimeField;break;case`endTimeField`:a=this._metadata.timeInfo?.endTimeField;break;case`timeReceived`:a=this._isStream?Ve:null}o=this._isStream?n?.end??Date.now():n?.end??-1/0;let c=t.map(e=>e.reader.getCursor()),l;for(let e=this._nextObservationRecords.length-1;e>=0&&!(this._observationRecords.length>=this._maxDisplayObservationsPerTrack);e--){let t=this._nextObservationRecords[e],n=c[t.chunkIndex];s(n),n.setIndex(t.featureIndex);let r=a==null?null:n.readAttributeAsTimestamp(a);(r==null?0:o-r)>=this._maxDisplayDuration||(this._commitObservation(t,n),l??=t)}if(l!=null){let{chunkIndex:t,featureIndex:n}=l,r=`${l.objectId}.latest`,a=e.createDisplayIdForObjectId(r),o=c[t];s(o),o.setIndex(n);let u=new D(o.readGeometryWorldSpace(),{...o.readAttributes(),[k]:1},null,r,a);this._latestObservationFeature&&i.push(this._latestObservationFeature.objectId),this._latestObservationFeature=u,this._latestObservationRecord=l}else this._latestObservationFeature=null;return this._trackLineGeometry=pn(this._trackLinePath,this._spatialReference),this._bounds=hn(this._trackLineGeometry),this._nextObservationRecords=[],i}updateStatistics(e,t){this._statistics=lt.create(this._fields);let n=e.map(e=>e.reader.getCursor());for(let{chunkIndex:e,featureIndex:r}of this._observationRecords){let i=n[e];s(i),i.setIndex(r),this._statistics.insert(i,t)}}overlapsTile(e){for(let t of this._bounds)if(f(t,e.bounds,cn))return!0;return!1}getLatestObservationFeatureForTile(e){if(this._latestObservationFeature==null)return null;let{objectId:t,displayId:n,geometry:r,attributes:i}=this._latestObservationFeature,a=Re(r,this._metadata.geometryType,e.subscription.tile.transform)??new E,o=De(1/0,1/0,-1/0,-1/0);return mn(a,(e,t)=>ye(o,[e,t])),ae(o,De(0,0,512,512))?new D(a,i,null,t,n):null}getTrackLineFeatureForTile(e){let t=Re(this._trackLineGeometry,`esriGeometryPolyline`,e.subscription.tile.transform)??new E;return new D(t,this._trackLineAttributes,null,this.objectId,this.displayId)}getTrackLineOptimizedFeature(){return new D(this._trackLineGeometry,this._trackLineAttributes,null,this.objectId,this.displayId)}getTrackLineDisplayFeature(){let{_trackLineGeometry:e,_trackLineAttributes:t,displayId:n}=this;return{geometry:Ie(e,`esriGeometryPolyline`,!1,!1),attributes:t,displayId:n}}_commitObservation(e,t){let n=t.readCentroidWorldSpace(),r=n?.coords[0],i=n?.coords[1];n??(r=t.readXWorldSpace(),i=t.readYWorldSpace()),r!=null&&i!=null&&(this._observationRecords.unshift(e),this._trackLinePath.unshift([r,i]))}},dn=class extends H{constructor(e){super(e),this.done=!1}},fn=class t extends Xt{static async create(n,r,i,a,o){let s=r.metadata.outSpatialReference,c=new I({spatialReference:s}),l=await Promise.all(n.fields.map(async e=>Jt.create(c,e))),u=n.featureFilter?await F.create({geometryType:r.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:r.metadata.timeInfo,fieldsIndex:r.metadata.fieldsIndex,spatialReference:s,filterJSON:n.featureFilter}):null;return s.isWrappable||Ge()||await Promise.all([e(()=>import(`./apiConverter-BpSdY5Dk.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])),e(()=>import(`./jsonConverter-BwXvCkWa.js`),__vite__mapDeps([14,1,2,3,4,5,6,7,8,9,10,11,13])),Ke()]).then(([e,t,n])=>{G={fromGeometryToGXGeometry:t.fromGeometryToGXGeometry,toGeometry:t.toGeometry,fromSpatialReference:e.fromSpatialReference}}),new t(n,r,i,s,l,u,a,o)}constructor(e,t,n,r,i,a,o,s){super(t,n,r,i,s),this._schema=e,this._featureFilter=a,this._arcadeContextInfo=o,this._tracks=new Map,this._handledChunks=new Set,this._metadata=t.metadata.weakCloneWithAdditionalFields([{name:k,alias:`trackPart`,type:`esriFieldTypeSmallInteger`}]),this._trackLineMetadata=P.createFeature({geometryType:`esriGeometryPolyline`,featureIdInfo:{type:`object-id`,fieldName:`aggregateId`},fieldsIndex:{fields:[...this._source.metadata.fieldsIndex.fields,...this.aggregateFields,{name:k,alias:`trackPart`,type:`esriFieldTypeSmallInteger`},{name:`aggregateId`,alias:`aggregateId`,type:`esriFieldTypeOID`}],timeZoneByFieldName:null},globalIdField:null,spatialReference:t.metadata.spatialReference,outSpatialReference:t.metadata.outSpatialReference,subtypeField:null,subtypes:null,timeInfo:t.metadata.timeInfo,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null,types:null})}destroy(){super.destroy(),this._clear()}get _isStream(){return this._source.isStream}get enablePixelBuffering(){return!0}get isAggregate(){return!1}requiresInvalidation(){return!0}invalidate(){super.invalidate(),this._clear()}createState(e){return new dn(e)}async*applyOverrideUpdate(e){sn().error(`Applying override to tracks is not supported`)}displayMap(e,t,n){let r=new Map(e.map(e=>[t(e),e])),i=[];for(let e of this._tracks.values()){let t=r.get(e.objectId);if(t!=null){let a=n(e.displayId,t,e.objectId);i.push(a),r.delete(e.objectId);continue}let a=e.latestObservationFeature;if(a?.objectId){let e=r.get(a.objectId);if(e!=null){let t=n(a.displayId,e,a.objectId);i.push(t),r.delete(a.objectId);continue}}for(let t of e.observations()){let e=r.get(t.objectId);if(e!=null){let a=n(t.displayId,e,t.objectId);i.push(a),r.delete(t.objectId)}}}return i}getDisplayFeatures(e){let t=new Set(e),n=[],r=[],i=this._source.chunks().map(e=>e.reader.getCursor());for(let e of this._tracks.values()){if(t.has(e.displayId)&&r.push(e.getTrackLineDisplayFeature()),e.latestObservationFeature!=null&&t.has(e.latestObservationFeature.displayId)){let{displayId:t,chunkIndex:r,featureIndex:a}=e.latestObservationRecord,o=i[r];o.setIndex(a),n.push({displayId:t,...o.readLegacyFeatureWorldSpace()})}for(let{displayId:r,chunkIndex:a,featureIndex:o}of e.observations())if(t.has(r)){let e=i[a];e.setIndex(o),n.push({displayId:r,...e.readLegacyFeatureWorldSpace()})}}return{features:n,aggregates:[],tracks:r}}getFeatureObjectIdsForAggregate(e){for(let t of this._tracks.values())if(t.objectId===e)return Array.from(t.observations(),e=>e.objectId);return[]}async*updateChunks(){this._handledChunks.size===0&&this._rebuildTracks();for(let e of this._sendStates.values())yield*this._update(e)}forEachAggregateWorldSpace(e){for(let t of this._tracks.values())e(t.getTrackLineOptimizedFeature())}_clear(){for(let e of this._source.chunks())if(this._handledChunks.has(e.chunkId)){let t=e.reader.getCursor();for(;t.next();){let e=t.getObjectId();this._attributeStore.releaseDisplayIdForObjectId(e)}}this._handledChunks.clear();for(let e of this._tracks.values())this._removeTrack(e);this._tracks.clear()}_rebuildTracks(){let e=this._source.chunks();if(!e.length)return;let t=this._metadata.timeInfo?.trackIdField;if(t==null)return;let n=new Set;for(let r=0;r<e.length;r++){let i=e[r];if(this._handledChunks.has(i.chunkId))continue;this._handledChunks.add(i.chunkId);let a=i.reader.getCursor();for(;a.next();){let e=a.getObjectId();a.setDisplayId(this._attributeStore.createDisplayIdForObjectId(e));let i=a.readAttribute(t);if(i!=null&&e!=null&&(this._featureFilter===null||this._featureFilter.check(a,this._sqlOptions))){if(!this._tracks.has(i)){let e=un.getOid(i),t=this._attributeStore.createDisplayIdForObjectId(e),n=new un(this._schema,i,e,t,this.aggregateFields,this.spatialReference,this._source.metadata,this._isStream);this._tracks.set(i,n)}this._tracks.get(i).stageObservation(r,a),n.add(i)}}}for(let t of this._tracks.values())if(n.has(t.trackId)){let n=t.commitObservations(this._attributeStore,e,this._featureFilter?.timeExtent);for(let e of n)this._attributeStore.releaseDisplayIdForObjectId(e);t.updateStatistics(e,Se(1,this._arcadeContextInfo))}else this._removeTrack(t)}_removeTrack(e){this._tracks.delete(e.trackId),this._attributeStore.releaseDisplayIdForObjectId(e.objectId),e.latestObservationFeature!=null&&this._attributeStore.releaseDisplayIdForObjectId(e.latestObservationFeature.objectId)}*_update(e){if(e.done)return;e.done=!this._source.updateTracking.updating;let t=[],n=[];for(let r of this._tracks.values())if(r.length>0){if(this._schema.showLatestObservation){let n=r.getLatestObservationFeatureForTile(e);n!=null&&t.push(n)}this._schema.showTrackLine&&r.overlapsTile(e.subscription.tile)&&n.push(r.getTrackLineFeatureForTile(e))}let r=j.fromOptimizedFeatures(t,this._metadata,e.subscription.tile.transform),i=j.fromOptimizedFeatures(n,this._trackLineMetadata,e.subscription.tile.transform),a=[];if(this._schema.showPreviousObservations){let t=this._source.chunks().map(()=>[]);for(let e of this._tracks.values())for(let{chunkIndex:n,featureIndex:r}of e.previousObservations())t[n].push(r);a=this._source.chunks().map((n,r)=>{let i=n.getTileReader(e.subscription.tile);if(i==null)return null;let a=dt.from(i,t[r]);return a.setProcessorAttributes({[k]:2}),a.geometryType!==`esriGeometryPoint`&&a.getInTransform()!=null||a.setTransformForDisplay(e.subscription.tile.transform),a}).filter(Ce)}this.events.emit(`changed`);let o=e.subscription.tile.createArcadeEvaluationOptions(this._arcadeContextInfo),s=i.getCursor();for(;s.next();)this._attributeStore.setAttributeData(s.getDisplayId(),s,o,this._sqlOptions);for(let e of a){let t=e.getCursor();for(;t.next();)this._attributeStore.setAttributeData(t.getDisplayId(),t,o,this._sqlOptions)}let c=r.getCursor();for(;c.next();)this._attributeStore.setAttributeData(c.getDisplayId(),c,o,this._sqlOptions);yield new U(e.subscription,i,!1,!1,{});for(let t of a)yield new U(e.subscription,t,!1,!1,{});yield new U(e.subscription,r,!1,e.done,{})}};function pn(e,t){if(e.length<2)return O({paths:[e]},!1,!1);if(t.isWrappable){let n=!1;for(let r=1;r<e.length;r++){let i=e[r][0],a=se(i,e[r-1][0],t);i!==a&&(e[r][0]=a,n=!0)}if(n){let n=tt({paths:[e],spatialReference:t});if(n!=null)return O({paths:n.paths},!1,!1)}return O({paths:[e]},!1,!1)}let n=G.fromGeometryToGXGeometry({hasM:!1,hasZ:!1,paths:[e]}),r=G.fromSpatialReference(t);if(r!=null){let e=We(n,1e6,r,Ue.geodesic);if(e!=null){let t=G.toGeometry(e,r);if(t!=null&&`paths`in t)return O({paths:t.paths},!1,!1)}}return O({paths:[e]},!1,!1)}function mn(e,t){let{coords:n,lengths:r}=e;if(!r.length)return void t(n[0],n[1]);let i=0;for(let e=0;e<r.length;e++){let a=r[e],o=0,s=0;for(let e=0;e<a;e++)o+=n[2*(e+i)],s+=n[2*(e+i)+1],t(o,s);i+=a}}function hn(e){let{lengths:t,coords:n}=e;if(!t.length)return[ce()];let r=[],i=0;for(let e=0;e<t.length;e++){let a=t[e],o=ce();r.push(o);for(let e=0;e<a;e++){let t=n[2*(e+i)],r=n[2*(e+i)+1];ye(o,[t,r])}i+=a}return r}var gn=class{constructor(e,t){this._connection=e,this._source=t,this._version=1,this._registry=new Ct,this._proxy=new yt({fetch:(e,t)=>this._connection.layerView.fetch(e,t),fetchDictionary:(e,t)=>this._connection.layerView.fetchDictionary(e,t)}),this._attributeStore=new bt({isLocal:!1,update:e=>pe(this._connection.container.updateAttributeView(e))})}destroy(){this._proxy.destroy(),this._strategy?.destroy(),this._attributeStore.destroy()}get aggregateQueryEngine(){return this._strategy?.aggregateQueryEngine}get usedMemory(){let e=0;return e+=this._attributeStore.usedMemory,this._strategy&&(e+=this._strategy.usedMemory),e}get version(){return this._version}getDisplayFeatures(e){return this._strategy?this._strategy.getDisplayFeatures(e):{features:[],aggregates:[],tracks:[]}}getDisplayIds(e){let t={};return this._strategy&&this._strategy.displayMap(e,e=>e,(e,n,r)=>{t[r]=e}),t}getFeatureObjectIdsForAggregate(e){return this._strategy?this._strategy.getFeatureObjectIdsForAggregate(e):[]}onSubscribe(e){this._strategy?.onSubscribe(e)}onUnsubscribe(e){this._strategy?.onUnsubscribe(e)}requiresInvalidation(){return this._strategy?.requiresInvalidation()??!1}async update(e,t,n,r,i){let a=e.processor,o=h(this._schema?.storage,a.storage),s=h(this._schema?.mesh.properties,a.mesh.properties),l=h(this._schema?.mesh.factory,a.mesh.factory),u=h(this._schema?.mesh.strategy,a.mesh.strategy),d=_n(this._schema?.expressionProperties,a.expressionProperties),f=d.some(e=>this._attributeStore.hasArcadeDependency(e)),p=d.some(e=>this._factory?.hasArcadeDependency(e)??!1),m=d.some(e=>this._strategy?.hasArcadeDependency(e))||this._strategy?.isAggregate&&f,g=p||m,_=s||l||u;if(!(o||_||p||f||m)&&!r)return!1;c(`esri-2d-update-debug`)&&console.debug(`Version[${this._version}] SymbolProcessor.update`,{changes:ee(this._schema,a),schema:a}),this._schema=a;let v=new I({fields:this._source.metadata.fieldsIndex,spatialReference:this._source.metadata.outSpatialReference}),te={currentUser:a.mesh.properties.currentUser};if((o||_||f)&&(await this._attributeStore.update(a.storage,v,this._source.metadata,t),this._strategy?.invalidateAttributeData(K(a))),!r&&!_&&!g)return!1;(u||s||g)&&await this._updateStrategy(a.mesh.strategy,i,K(a),te),this._updateSortKey(v,`sortKey`in a.mesh.properties?a.mesh.properties.sortKey:null);let ne=a.mesh.factory.symbology.type===`dictionary`?a.mesh.factory.symbology.fieldMap:null,re=new Kt(v,this._proxy,n,this._registry,ne);return(l||a.mesh.factory.symbology.type===`dictionary`)&&(this._factory=await Gt.create(re,a.mesh.factory)),this._version=t,!0}async applyOverrideUpdate(e){if(!this._strategy)return;let t=this._strategy.applyOverrideUpdate(e);for await(let e of t)try{await this._process(e)}catch{}}async updateChunks(){await this._doUpdateChunks(),this._strategy?.afterUpdateChunks()}async removeChunks(e){this._strategy?.removeChunks(e),this._attributeStore.incrementDisplayIdGeneration()}updateHighlight({highlights:e}){if(!this._strategy||!this._strategy.hasSubscribers)return void this._attributeStore.setHighlight(e.map(({objectId:e,highlightFlags:t})=>({objectId:e,highlightFlags:t,displayId:-1})),e);let t=this._strategy.displayMap(e,({objectId:e})=>e,(e,{highlightFlags:t},n)=>({objectId:n,displayId:e,highlightFlags:t}));this._attributeStore.setHighlight(t,e)}invalidate(){this._strategy&&this._strategy.invalidate()}async _doUpdateChunks(){if(!this._strategy)return;let e=this._strategy.updateChunks(),t=[],n=new Map;for await(let r of e){let e=n.get(r.id);e??(e=new qt({concurrency:16,process:e=>this._process(e)}),n.set(r.id,e));let i=e.push(r).catch(e=>y(e));t.push(i)}try{await Promise.all(t)}catch{}c(`esri-2d-update-debug`)&&console.log(`SendUpdates`),this._attributeStore.sendUpdates(),c(`esri-2d-update-debug`)&&console.log(`SendUpdates.await`)}async _updateStrategy(e,t,n,r){switch(this._strategy?.destroy(),e.type){case`feature`:this._strategy=new on(this._source,this._attributeStore,n,r);break;case`binning`:this._strategy=await $t.create(e,this._source,this._attributeStore,n,r);break;case`cluster`:this._strategy=await rn.create(this._connection,e,this._source,this._attributeStore,n,r);break;case`track`:this._strategy=await fn.create(e,this._source,this._attributeStore,n,r)}for(let e of t)this._strategy.onSubscribe(e)}async _updateSortKey(e,t){if(this._sortInfo=me(this._sortInfo?.computed),t!=null){let n=t.byRenderer?null:await e.createComputedField(t);this._sortInfo={...t,computed:n}}}async _process(e){let t=e.subscription;if(c(`esri-2d-update-debug`)){let n=t.tile;console.debug(`Version[${this._version}] Tile[${n.key.id}, end=${e.end}] Processor._process`)}let n={currentUser:this._schema?.mesh.properties.currentUser};await this._fetchResources(e,n),w(t.signal);let r=await this._write(e,t.tile.createArcadeEvaluationOptions(K(this._schema)),n),i=t.tile.tileInfoView.getLODInfoAt(t.tile.key);w(t.signal);let{message:a,transferList:o}=r.serialize(i),s={objectIdMap:null,inner:e.createMessage(a,this._version,this._attributeStore.epoch)};if(this._schema?.mesh.properties.returnMeshObjectId){s.objectIdMap={};let t=e.reader?.getCursor();if(t)for(;t.next();)s.objectIdMap[t.getDisplayId()]=t.getObjectId()}if(w(t.signal),await this._connection.container.onMessage(s,{signal:t.signal,transferList:o}),this._attributeStore.sendUpdates(),c(`esri-2d-update-debug`)){let n=t.tile;console.debug(`Version[${this._version}] Tile[${n.key.id}, end=${e.end}] Processor._process.await`)}}async _fetchResources(e,t){await this._fetchMatcherResources(e),await this._fetchWriterResources(e,t)}async _fetchMatcherResources(e){if(e.reader)return this._factory.enqueueMatcherRequests(this._proxy,e.reader)}async _fetchWriterResources(e,t){if(!e.reader)return;let n=e.reader.getCursor(),r=e.subscription.tile.createArcadeEvaluationOptions(K(this._schema));for(;n.next();)this._factory.enqueueWriterRequests(this._proxy,n,r,t);await this._proxy.fetchEnqueuedResources()}async _write(e,t,n){let r=e.subscription.tile,i=e.reader?.getCursor(),a=i?.getSize()??0,o=r.tileInfoView.tileInfo.isWrappable,s=r.tileInfoView.tileInfo.spatialReference.isWGS84,c=new It(r.key,this._strategy.enablePixelBuffering,o,s,a);if(!i)return c;let l=r.createArcadeEvaluationOptions(K(this._schema)),u=0;for(;i.next();){++u%1e3||(await fe(0),w(e.subscription));let a=this._getSortKeyValue(i,t);c.entityStart(i.getDisplayId(),a),this._factory.write(c,this._proxy,i,l,n,r.level),c.entityEnd()}return c}_getSortKeyValue(e,t){if(!this._sortInfo)return 0;let{computed:n,order:r,byRenderer:i}=this._sortInfo,a=i?this._factory.getSortKey(e,t):n?.read(e,t);return a==null||isNaN(a)?0:a*(r===`asc`?-1:1)}};function _n(e,t){let n=[];return e?.timeExtent?.start===t.timeExtent?.start&&e?.timeExtent?.end===t.timeExtent?.end||n.push(`timeProperties`),n}function K(e){let{timeZone:t}=e?.mesh.properties??{},{timeExtent:n}=e?.expressionProperties??{};return{timeZone:t,timeExtent:n}}var vn=class e{static from(t){let n=0,r=0,i=0;return t.forEach(e=>{let t=e._readGeometry();t&&(r+=t.isPoint?1:t.lengths.reduce((e,t)=>e+t,0),i+=t.isPoint?1:t.lengths.length,n+=1)}),new e(n,r,i)}constructor(e,t,n){this.featureCount=e,this.vertexCount=t,this.ringCount=n}toJSON(){return{featureCount:this.featureCount,ringCount:this.featureCount,vertexCount:this.featureCount}}},yn=2500,q=class extends i{constructor(e){super(),this._connection=e,this._enabledEventTypes=new Set,this._updateInfo={websocket:0,client:0},this._lastTime=performance.now(),this._queuedCommands=[],this.addHandles([xe(()=>this._strategy?.connectionStatus??`disconnected`,e=>{this._layerView.setProperty({propertyName:`pipelineConnectionStatus`,value:e})},{initial:!0}),xe(()=>this._strategy?.errorString||null,e=>this._layerView.setProperty({propertyName:`pipelineErrorString`,value:e}),{initial:!0})])}destroy(){this._strategy=null,this.removeAllHandles()}get _layerView(){return this._connection.layerView}set strategy(e){this._strategy??this._resetUpdateInfo(performance.now());let t=`event-handles`;this.removeHandles(t),e!=null&&(this.addHandles([e.events.on(`data-received`,e=>this._onFeature(e)),e.events.on(`message-received`,e=>this._onWebSocketMessage(e)),e.events.on(`features-updated`,e=>this._onUpdate(e)),e.events.on(`tick`,()=>this._onTick())],t),this._queuedCommands.forEach(t=>t(e)),this._queuedCommands=[]),this._strategy=e}updateCustomParameters(e){e!=null&&this._callOrEnqueue(t=>t.updateCustomParameters(e))}sendMessageToSocket(e){this._callOrEnqueue(t=>t.sendMessageToSocket(e))}sendMessageToClient(e){this._callOrEnqueue(t=>t.sendMessageToClient(e))}enableEvent(e,t){t?this._enabledEventTypes.add(e):this._enabledEventTypes.delete(e)}disconnect(){this._strategy?.disconnect()}connect(){this._strategy?.connect()}clear(){this._strategy?.clear()}_onWebSocketMessage(e){this._enabledEventTypes.has(`message-received`)&&this._layerView.emitEvent({name:`message-received`,event:e})}_onFeature(e){this._updateInfo.websocket++,this._enabledEventTypes.has(`data-received`)&&this._layerView.emitEvent({name:`data-received`,event:{attributes:e.attributes,centroid:e.centroid,geometry:e.geometry}})}_onUpdate(e){this._updateInfo.client+=e}_onTick(){let e=performance.now(),t=e-this._lastTime;if(t>yn){let n=Math.round(this._updateInfo.client/(t/1e3)),r=Math.round(this._updateInfo.websocket/(t/1e3));this._resetUpdateInfo(e),this._layerView.emitEvent({name:`update-rate`,event:{client:n,websocket:r}})}}_resetUpdateInfo(e){this._lastTime=e,this._updateInfo.client=0,this._updateInfo.websocket=0}_callOrEnqueue(e){this._strategy==null?this._queuedCommands.push(e):e(this._strategy)}};S([a()],q.prototype,`_strategy`,void 0),q=S([v(`esri.views.2d.layers.features.sources.StreamMessenger`)],q);var bn=class{constructor(){this._requiresInvalidation=!1}get requiresInvalidation(){return this._requiresInvalidation}requireInvalidation(){this._requiresInvalidation=!0}},J=class{constructor(e,t,n){this._context=n,this._controller=new AbortController,this.metadata=P.createFeature(e),this._schema=t}destroy(){this._controller.abort(),this.store.destroy()}get store(){return this._context.store}get _connection(){return this._context.connection}get _options(){return{signal:this._controller.signal}}get _signal(){return this._controller.signal}async applyOverride(e){this._onOverride(),await this.store.applyOverride(e)}takeOverrideUpdate(){return this.store.takeOverrideUpdate()}unsafeSetQueryHistoricMoment(e){throw Error(`InternalError: LoadStrategy does not support query info`)}async queryByObjectId(e,t){throw Error(`InternalError: LoadStrategy does not support fetching`)}prepareCacheUpdate(e,t){}applyCacheUpdate(){return null}};async function xn(e,n,r,i={}){let a=(await Promise.allSettled(r.map(t=>Sn(e,n,t,i)))).filter(e=>e.status===`rejected`).map(e=>e.reason);if(a.length)throw new t(`featurelayer-query`,`Encountered errors when downloading data`,{errors:a})}async function Sn(e,t,n,r={}){let i=`${e.chunkPrefix??``}${n.num}`,a=await e.fetch(n.query,r,{chunkId:i}),o=new N(a,n.query.inner.toJSON(),n.num,!1);o.chunkId=o.normalizedChunkId=i,w(r),t.insert(o)}var Cn=8e3,wn=class{constructor(e,n,r,i){this.store=e,this.queryInfo=n,this._options=r,this._fetch=i,this._nextBatch=new Set,this._fetchFeatures=we(async()=>{if(this._nextBatch.size===0||this._options.signal?.aborted)return;let e=Array.from(this._nextBatch);this._nextBatch.clear(),e.length>Cn&&o.getLogger(`esri.views.2d.layers.FeatureLayerView2D`).warn(new t(`highlight-too-many-features`,`highlight is limited to ${Cn} features on large layers configured with a display filter to avoid performance issues`));let n=this.queryInfo.objectIdsQueryPageSize,r=Math.ceil(Cn/n),i=Math.min(r,Math.ceil(e.length/n)),a=Array.from({length:i},(t,r)=>{let i=r*n,a=Math.min(i+n,e.length);return{num:r,query:this.queryInfo.createObjectIdsQuery(e.slice(i,a))}});try{await xn({chunkPrefix:`cache.`+he(),fetch:this._fetch},this.store,a,this._options)}catch{}})}prepareCacheUpdate(e,t){if(t)for(let e of t)this._nextBatch.delete(e);for(let t of e)this._nextBatch.add(t)}applyCacheUpdate(){return this._nextBatch.size===0||this._options.signal?.aborted?null:this._fetchFeatures().catch(()=>{})}},Y=268435455,Tn=class{constructor(){this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.idFieldIndices=[],this.vertexCount=0,this.offsets={attributes:[],geometry:[]},this.centroid=[]}get usedMemory(){let e=0;return e+=T(this.idFieldIndices),e+=T(this.offsets.attributes),e+=T(this.offsets.geometry),e+=T(this.centroid),this.displayIds&&(e+=T(this.displayIds)),this.groupIds&&(e+=T(this.groupIds)),e}};function En(e,t,n,r=!1){let i=e.asUnsafe(),a=i.pos(),o=new Tn,s=0,c=0,u=null,d=!1,f=[];for(;i.next();)switch(i.tag()){case 12:u=i.processMessage(Ye);break;case 9:if(o.exceededTransferLimit=i.getBool(),o.exceededTransferLimit){o.offsets.geometry=r?new Float64Array(8e3):new Int32Array(8e3),o.centroid=r?new Float64Array(16e3):new Int32Array(16e3);for(let e=0;e<o.centroid.length;e++)o.centroid[e]=Y}break;case 13:{let e=i.processMessage(Je);e.index=s++,f.push(e);break}case 15:{let e=i.getLength(),n=i.pos()+e;if(!o.exceededTransferLimit){let e=o.offsets.geometry,t=o.centroid;e.push(0),t.push(Y),t.push(Y)}!d&&o.exceededTransferLimit&&(d=!0,o.offsets.attributes=r?new Float64Array(8e3*s):new Uint32Array(8e3*s));let a=c*s;for(;i.pos()<n&&i.next();)switch(i.tag()){case 1:{d?o.offsets.attributes[a++]=i.pos():o.offsets.attributes.push(i.pos());let e=i.getLength();i.skipLen(e);break}case 2:if(t){let e=i.getLength(),t=i.pos()+e;for(;i.pos()<t&&i.next();)switch(i.tag()){case 3:{i.getUInt32();let e=i.getSInt64(),t=i.getSInt64();o.centroid[2*c]=e,o.centroid[2*c+1]=t;break}default:i.skip()}}else{o.offsets.geometry[c]=i.pos();let e=i.getLength();o.vertexCount+=e,i.skipLen(e)}break;case 4:{let e=i.getLength(),t=i.pos()+e;for(;i.pos()<t&&i.next();)switch(i.tag()){case 3:{i.getUInt32();let e=i.getSInt64(),t=i.getSInt64();o.centroid[2*c]=e,o.centroid[2*c+1]=t;break}default:i.skip()}break}default:i.skip()}c++,o.hasFeatures=!0;break}default:i.skip()}o.fields=new l(f),o.featureCount=c,o.fieldCount=s;let p=vt(n);return o.idFieldIndices=Array.from(p,e=>o.fields.get(e)?.index),o.transform=u,o.displayIds=new Uint32Array(o.featureCount),o.groupIds=new Uint16Array(o.featureCount),i.move(a),o}var Dn=268435455,On=128,kn=128e3,X={small:{delta:new Int32Array(On),decoded:new Int32Array(On)},small64:{delta:new Float64Array,decoded:new Float64Array},large:{delta:new Int32Array(kn),decoded:new Int32Array(kn)},large64:{delta:new Float64Array,decoded:new Float64Array}};function An(e,t){return t?e<=X.small64.delta.length?X.small64:(e<=X.large64.delta.length||(X.large64.delta=new Float64Array(Math.round(1.25*e)),X.large64.decoded=new Float64Array(Math.round(1.25*e))),X.large64):e<=X.small.delta.length?X.small:(e<=X.large.delta.length||(X.large.delta=new Int32Array(Math.round(1.25*e)),X.large.decoded=new Int32Array(Math.round(1.25*e))),X.large)}function jn(e){try{let t=new qe(new Uint8Array(e),new DataView(e));for(;t.next();){if(t.tag()===2)return Mn(t.getMessage());t.skip()}}catch(e){let n=new t(`query:parsing-pbf`,`Error while parsing FeatureSet PBF payload`,{error:e});o.getLogger(`esri.view.2d.layers.features.support.FeatureSetReaderPBF`).error(n)}return null}function Mn(e){for(;e.next();){if(e.tag()===1)return e.getMessage();e.skip()}return null}function Nn(e){let t=e.getLength(),n=e.pos()+t;for(;e.pos()<n&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}function Pn(e,t,n,r,i){return e?t*i-r*n===0&&t*r+n*i>0:!1}var Fn=class e extends ot{static fromBuffer(t,n,r=!1){let i=n.geometryType,a=jn(t),o=En(a,i===`esriGeometryPoint`,n.featureIdInfo,r);return new e(a,o,n,r)}constructor(e,t,n,r){super(n),this._use64Bit=r,this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0},this._parseCaches=[],this._geometryType=n.geometryType,this._reader=e,this._header=t,this._hasNext=t.hasFeatures,this._isPoints=n.geometryType===`esriGeometryPoint`}get _size(){return this._header.featureCount}get fields(){return this._header.fields}get geometryType(){return this._geometryType}get hasZ(){return!1}get hasM(){return!1}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this._size}getInTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._featureIndex=e}getAttributeHash(){let e=``;for(let t of this._header.fields.fields)e+=this._readAttributeAtIndex(t.index)+`.`;return e}getObjectId(){if(this._header.idFieldIndices.length===1)return this._readAttributeAtIndex(this._header.idFieldIndices[0]);let e=this._header.idFieldIndices.map(e=>this._readAttributeAtIndex(e));return JSON.stringify(e)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(e){this._header.displayIds[this._featureIndex]=e}readGeometryArea(){return this._cache.area||this._readGeometry(!0),this._cache.area}copy(){let t=this._reader.clone(),n=new e(t,this._header,this.metadata,this._use64Bit);return this.copyInto(n),n}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}get usedMemory(){return 32+(this._cache.geometry?.usedMemory??0)}get underlyingMemory(){return super.underlyingMemory+this._reader.usedMemory+this._header.usedMemory}_readX(){return this._header.centroid[2*this._featureIndex]}_readY(){return this._header.centroid[2*this._featureIndex+1]}_readServerCentroid(){let e=this._header.centroid[2*this._featureIndex],t=this._header.centroid[2*this._featureIndex+1];return e===Dn?null:new E([],[e,t])}_readGeometry(e=!1){if(this._cache.geometry===void 0){let t=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===Dn)return null;let e=this._header.centroid[2*this._featureIndex],n=this._header.centroid[2*this._featureIndex+1];t=new E([],[e,n])}else{let n=this._header.offsets.geometry[this._featureIndex],r=this._reader;if(n===0)return null;r.move(n);try{t=e?this._parseGeometryForDisplay(r):this._parseGeometry(r)}catch{return null}}return t?.coords.length===0&&(t=null),this._cache.geometry=t,t}return this._cache.geometry}_readAttribute(e,t){let n=this._header.fields.get(e);if(n==null)return;let r=this._readAttributeAtIndex(n.index),i=this._header.fields.isDateField(n.name);return t?r==null?r:i?new Date(r):r:r}_readAttributes(){let e={};for(let t of this._header.fields.fields)e[t.name]=this._readAttributeAtIndex(t.index);return e}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext,e._parseCaches=this._parseCaches}_readAttributeAtIndex(e){let t=this._parseCaches[e];if(t||(t=new st(this.getSize()),this._parseCaches[e]=t),t.has(this._featureIndex))return t.get(this._featureIndex);let n=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],r=this._reader;r.move(n);let i=Nn(r);return t.set(this._featureIndex,i),i}_readGeometryDeltaDecoded(e=!1){if(this._cache.unquantGeometry===void 0){let t=this._readGeometry(e);if(!t)return this._cache.unquantGeometry=void 0,null;if(!this.getInTransform())return this._cache.unquantGeometry=t,t;let n=An(t.coords.length,this._use64Bit).decoded,r=t.clone(n),i=r.coords,a=0;for(let e of r.lengths){for(let t=1;t<e;t++){let e=2*(a+t),n=2*(a+t-1);i[e]+=i[n],i[e+1]+=i[n+1]}a+=e}return this._cache.unquantGeometry=r,r}return this._cache.unquantGeometry}_parseGeometry(e){let t=e.asUnsafe(),n=t.getLength(),r=t.pos()+n,i=[],a=[];for(;t.pos()<r&&t.next();)switch(t.tag()){case 2:{let e=t.getUInt32(),n=t.pos()+e;for(;t.pos()<n;)a.push(t.getUInt32());break}case 3:{let e=t.getUInt32(),n=t.pos()+e;for(i.push(t.getSInt64()),i.push(t.getSInt64()),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();t.pos()<n;)i.push(t.getSInt64()),i.push(t.getSInt64()),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();break}default:t.skip()}return new E(a,i,this.hasZ,this.hasM)}_parseGeometryForDisplay(e){let t=e.asUnsafe(),n=t.getLength(),r=t.pos()+n,i=[],a=[],o=0,c=0,l=null,u=0,d=this.geometryType===`esriGeometryPolygon`,f=this.geometryType===`esriGeometryPolyline`,p=d?3:f?2:1,m=d||f;for(;t.pos()<r&&t.next();)switch(t.tag()){case 2:{let e=t.getUInt32(),n=t.pos()+e;for(;t.pos()<n;){let e=t.getUInt32();i.push(e),o+=e}l=An(2*o,this._use64Bit).delta;break}case 3:{t.getUInt32();let e=2+(this.hasZ?1:0)+(this.hasM?1:0);s(l);for(let n of i){if(c+e*n>l.length){for(let e=0;e<n;e++)t.getSInt64(),t.getSInt64(),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64();continue}let r=0,i=t.getSInt64(),o=t.getSInt64();this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64(),l[c++]=i,l[c++]=o,r+=1;for(let e=1;e<n;e++){let e=t.getSInt64(),n=t.getSInt64(),a=i+e,s=o+n;u+=-.5*(a-i)*(s+o),this.hasZ&&t.getSInt64(),this.hasM&&t.getSInt64(),e===0&&n===0||Pn(m,l[c-2],l[c-1],e,n)?(l[c-2]+=e,l[c-1]+=n):(l[c++]=e,l[c++]=n,r+=1),i=a,o=s}r>=p?a.push(r):c-=r*e}break}default:t.skip()}return this._cache.area=u,a.length?new E(a,l,this.hasZ,this.hasM):l==null?null:this._createDeltaQuantizedExtrudedGeometry(l[0],l[1])}},Z=class{constructor(e,t){this.service=e,this._metadata=t}destroy(){}};function In(e,t,n){switch(e.type){case`memory`:return new Rn(e,t,n);case`ogc`:return new Vn(e,t);case`feature-service`:return e.queryMetadata.supportsFormatPBF&&c(`featurelayer-pbf`)?new zn(e,t):new Bn(e,t)}}async function Ln(e){let t=new _e;return await t.open(e,{}),t}var Rn=class extends Z{constructor(e,t,n){super(e,t),this._ports=[],this._loaded=this._load(n)}destroy(){this._loaded.finally(()=>{this._client.close(),this._client=null;for(let e of this._ports)e.close()}).catch(()=>{})}async _load(e){this._ports=await e.layerView.openMemoryPorts(),this._client=await Ln(this._ports)}async executeQuery(e,t){await this._loaded;let n=await this._client.invoke(`queryFeatures`,e.toJSON(),t);return j.fromFeatureSet(n,this._metadata)}},zn=class extends Z{async executeQuery(e,t){let n=await Xe(this.service.source,e,t),r=!e.quantizationParameters;return Fn.fromBuffer(n,this._metadata,r)}},Bn=class extends Z{async executeQuery(e,t){let{source:n,queryMetadata:r}=this.service;if(e.quantizationParameters!=null&&!r.supportsQuantization){let r=e.clone(),i=Te(r.quantizationParameters);r.quantizationParameters=null;let a=await Ze(n,r,this._metadata.spatialReference,t),o=Me(a,this._metadata.featureIdInfo);return Fe(i,o),j.fromOptimizedFeatureSet(o,this._metadata)}let i=await Ze(n,e,this._metadata.spatialReference,t);return this._metadata.geometryType===`esriGeometryPoint`&&(i.features=i.features?.filter(e=>{if(e.geometry!=null){let t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0})),j.fromFeatureSet(i,this._metadata)}},Vn=class extends Z{async executeQuery(e,t){if(e.quantizationParameters&&!this.service.queryMetadata.supportsQuantization){let n=e.clone(),r=Te(n.quantizationParameters);n.quantizationParameters=null;let i=await nt(this.service.source,e,t);return Fe(r,i),j.fromOptimizedFeatureSet(i,this._metadata)}let n=await nt(this.service.source,e,t);return j.fromOptimizedFeatureSet(n,this._metadata)}},Hn=class extends J{constructor(e,t,n){super(e.metadata,t,n),this._service=e,this._didApplyOverride=!1,this._queue=new A({concurrency:32,process:async e=>{let t={signal:e.options?.signal,query:e.query.customParameters,useQueue:!0};return this._adapter.executeQuery(e.query.inner,t)}}),this._queryInfo=_t.create(e,{...t.full,...t.partial},this.metadata),this._adapter=In(e,this.metadata,n.connection),this._lastEditDate=e.queryMetadata.lastEditDate}destroy(){super.destroy(),this._adapter.destroy()}unsafeSetQueryHistoricMoment(e){this._queryInfo.updateHistoricMoment(e)}async tryUpdate(e,t){if(h(this.availableFields,t.availableFields)){if(this._didApplyOverride||await this._queryLastEditDateChanged())return!1;await this._updateFields(t.availableFields)}return this._schema.partial=t,!0}async queryByObjectId(e,t){if(e.length===0)return j.empty(this.metadata);let n=this._queryInfo.createQuery({objectIds:e});return n.inner.outFields=t,this._fetch(n,null,null)}get availableFields(){return this._schema.partial.availableFields}get definitionExpression(){return this._schema.full.definitionExpression}_onOverride(){this._didApplyOverride=!0}async _updateFields(e){this._queryInfo.updateFields(e);let n=Array.from(this.store.chunks()).map(async e=>{let t=be.fromJSON(e.queryInfo.queryJSON);if(t)try{return await this._tryUpdateFields(e.reader,t,{chunkId:e.chunkId}),null}catch(e){return e}}),r=(await Promise.all(n)).filter(e=>e);if(r.length)throw new t(`featurelayer-query`,`Encountered errors when downloading fields`,{errors:r})}async _fetch(e,t,n){let r=await this._enqueue(e,t);return await this._tryUpdateFields(r,e.inner,n),r}async _queryLastEditDateChanged(){if(this._lastEditDate==null||!(`source`in this._service))return!1;let e=this._service.source,t={...e.query,f:`json`},n=(await ne(e.path,{query:t,responseType:`json`})).data.editingInfo.lastEditDate;return n!==this._lastEditDate&&(this._lastEditDate=n,!0)}async _tryUpdateFields(e,n,r){let i=this._queryInfo.createPatchFieldsQuery(n,e,r);if(!i)return;let a=await this._enqueue(i,this._options);a.getSize()===e.getSize()?e.joinAttributes(a):o.getLogger(`esri.views.2d.layers.features.sources.strategies.AFetchLoadStrategy`).error(new t(`featurelayer-query`,`Failed to join features. Expected a count of ${e.getSize()} features, but got ${a.getSize()}`,{query:i.inner.toJSON(),debugInfo:r}))}async _enqueue(e,t){return this._connection.onEvent({type:`fetchStart`}),this._queue.push({query:e,options:t}).finally(()=>{this._connection.onEvent({type:`fetchEnd`,done:this._queue.length===0})})}},Un=class extends Hn{constructor(e,t,n){super(e,t,n),this._chunksById=new Map,this._featureCache=new wn(this.store,this._queryInfo,this._options,this._fetch.bind(this))}prepareCacheUpdate(e,t){return this._featureCache.prepareCacheUpdate(e,t)}applyCacheUpdate(){return this._featureCache.applyCacheUpdate()}unload(e){this._removeChunks(e.tile)}_addChunk(e){let t=e.tile.id;this._chunksById.has(t)||this._chunksById.set(t,[]);let n=e.size();(n||e.first||e.end)&&(c(`esri-2d-update-debug`)&&console.debug(`Chunk[${e.chunkId}] ATileLoadStrategy.addChunk [count=${n}]`),this._chunksById.get(t).push(e),this.store.insert(e))}_removeChunks(e){let t=this._chunksById.get(e.key.id)??[];for(let n of t)c(`esri-2d-update-debug`)&&console.debug(`Tile[${e.key.id}] Chunk[${n.chunkId}] ATileLoadStrategy.removeChunk`),this.store.remove(n);this._chunksById.delete(e.key.id)}},Wn=class extends M{constructor(e,t,n,r,i,a){super(),this._reader=e,this._queryJSON=t,this._tile=n,this._sourceTile=r,this._sourceTileDepth=i,this._end=a,this.chunkId=`${this._tile.key.id}.${this._sourceTile?.key.id}${this._end?`e`:``}`,this.normalizedChunkId=`${this._tile.key.normalizedId}.${this._sourceTile?.key.normalizedId}${this._end?`e`:``}`}get queryInfo(){return{type:`drill-down-tile`,chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,sourceTileDepth:this._sourceTileDepth,sourceTileId:this._sourceTile?.key.id,size:this.size(),end:this.end}}get first(){return this._sourceTileDepth===0}get reader(){return this._reader}get end(){return this._end}get tile(){return this._tile}get isTiled(){return!0}getTileReader(e){return this._tile.key.id===e.key.id?this.reader:null}},Gn=c(`featurelayer-query-max-depth`),Kn=class{constructor(e,t){this.subscription=e,this._tileIdToResult=new Map,this._controller=new AbortController,this._handles=C([x(e.signal,()=>this._controller.abort()),x(t,()=>this._controller.abort())])}destroy(){this._controller.abort(),this._handles.remove()}get(e){return this._tileIdToResult.get(e)}set(e,t){this._tileIdToResult.set(e,t)}get options(){return{signal:this._controller.signal}}},qn=class extends Un{constructor(){super(...arguments),this._loadStates=new Map}destroy(){super.destroy();for(let e of this._loadStates.values())e.destroy();this._loadStates.clear()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(e){this._loadStates.has(e.key.id)||this._loadStates.set(e.key.id,new Kn(e,this._options));let t=this._loadStates.get(e.key.id),n;try{for await(let n of this._fetchChunkInfos(t,e.tile,0)){let{queryJSON:e,reader:r,sourceTile:i,sourceTileDepth:a,tile:o}=n,s=new Wn(r,e,o,i,a,!1);w(t.options),this._addChunk(s)}}catch(e){n=e}w(t.options);let r=new Wn(j.empty(this.metadata),null,e.tile,null,-1,!0);if(this._addChunk(r),n)throw n}unload(e){super.unload(e),this._loadStates.get(e.key.id)?.destroy(),this._loadStates.delete(e.key.id)}async*_fetchChunkInfos(e,t,n){let r=e.get(t.id),i=!!r;if(r||(r=await this._fetchChunkInfo(e,t,n),e.set(t.id,r)),r.reader.exceededTransferLimit&&n<c(`featurelayer-query-max-depth`))for(let r of t.createChildTiles())yield*this._fetchChunkInfos(e,r,n+1);else i||(yield r)}async _fetchChunkInfo(e,t,n){let r=e.subscription.tile.getQuantizationParameters(),i=this._queryInfo.createTileQuery(t,{returnExceededLimitFeatures:n===Gn,quantizationParameters:r});return{reader:await this._fetch(i,e.options,{chunkId:t.id}),queryJSON:i.inner.toJSON(),tile:e.subscription.tile,sourceTile:t,sourceTileDepth:n}}},Jn=class extends M{constructor(e,t,n,r,i){super(),this._reader=e,this._queryJSON=t,this._tile=n,this._page=r,this._end=i,this.chunkId=`${this._tile.key.id}.${this._page}${this.end?`e`:``}`,this.normalizedChunkId=`${this._tile.key.normalizedId}.${this._page}${this.end?`e`:``}`}get queryInfo(){return{type:`paged-tile`,chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get reader(){return this._reader}get first(){return this._page===0}get end(){return this._end}get page(){return this._page}get tile(){return this._tile}get isTiled(){return!0}getTileReader(e){return this._tile.key.id===e.key.id?this.reader:null}},Yn=class{constructor(e,t){this.subscription=e,this._pages=new Set,this._controller=new AbortController,this._done=!1,this._handles=C([x(e.signal,()=>this._controller.abort()),x(t,()=>this._controller.abort())])}destroy(){this._controller.abort(),this._handles.remove()}get pageStart(){let e=-1;for(let t of this._pages.values())e=Math.max(e,t);return e+1}get done(){return this._done}get options(){return{signal:this._controller.signal}}add(e,t){this._pages.add(e),this._done=this._done||t}},Xn=class extends Un{constructor(){super(...arguments),this._loadStates=new Map}destroy(){super.destroy();for(let e of this._loadStates.values())e.destroy();this._loadStates.clear()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}async load(e){let t=Oe(this._loadStates,e.key.id,()=>new Yn(e,this._options));for await(let e of this._fetchPages(t))this._addChunk(e)}unload(e){super.unload(e),this._loadStates.get(e.key.id)?.destroy(),this._loadStates.delete(e.key.id)}async*_fetchPages(e){let t;try{for await(let t of this._concurrentPageStream(e))w(e.options),t.size()!==0&&(yield t)}catch(e){t=e}if(t&&ve(t)||(yield new Jn(j.empty(this.metadata),null,e.subscription.tile,-1,!0)),t)throw t}async*_concurrentPageStream(e){let t=c(`featurelayer-query-tile-concurrency`),n=this._pageStreamAll(e),r=[],i=!1,a=1;for(;!i;){let e=[];for(;!i&&r.length<a;){let t=n.next();if(!t.value){i=!0;break}let a=t.value;a.then(e=>{e.reader.exceededTransferLimit||(i=!0)}).catch(e=>{i=!0}).finally(()=>{r.splice(r.indexOf(a),1)}),r.push(a),e.push(a)}for(let t of e)yield t;r.length&&await Promise.race(r),a<t&&(a+=1)}}*_pageStreamAll(e){let t=Math.ceil(c(`featurelayer-query-tile-max-features`)/this._queryInfo.pageSize);for(let n=0;n<t;n++)yield this._downloadPage(n,e)}async _downloadPage(e,t){w(t.options);let n=t.subscription.tile,r=this._queryInfo.createPagedTileQuery(n,e),i=await this._fetch(r,t.options,{chunkId:`${n.id}-${e}`});return w(t.options),new Jn(i,r.inner.toJSON(),n,e,!1)}},Zn=class extends Hn{constructor(e,t,n){super(e,t,n)}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}load(e){return this._promise??=this._download(),this._promise}unload(e){}async _download(){let e=this._schema.snapshotInfo.initialTolerance,t=e?new re({mode:`view`,originPosition:`upper-left`,tolerance:e}):null;await this._downloadStreaming(t),t!=null&&await this._downloadRefresh()}async _downloadStreaming(e){try{for await(let t of this._fetchPages(e))this.store.insert(t)}catch(e){throw new t(`featurelayer-query`,`Encountered error when downloading data`,{error:e})}}async _downloadRefresh(){try{let e=[];for await(let t of this._fetchPages(null))e.push(t);this.store.clear();for(let t of e)this.store.insert(t);this.store.refresh()}catch(e){throw new t(`featurelayer-query`,`Encountered error when downloading data`,{error:e})}}async*_fetchPages(e){let t;try{for await(let t of this._concurrentPageStream(e))t.size()!==0&&(yield t)}catch(e){t=e}if(t&&ve(t)||(yield new N(j.empty(this.metadata),null,-1,!0)),t)throw t}async*_concurrentPageStream(e){let t=c(`featurelayer-snapshot-concurrency`),n=this._pageStreamAll(e),r=[],i=!1,a=1;for(;!i;){let e=[];for(;!i&&r.length<a;){let t=n.next();if(!t.value){i=!0;break}let a=t.value;a.then(e=>{e.reader.exceededTransferLimit||(i=!0)}).catch(e=>{i=!0}).finally(()=>{r.splice(r.indexOf(a),1)}),r.push(a),e.push(a)}for(let t of e)yield t;r.length&&await Promise.race(r),a<t&&(a+=1)}}*_pageStreamAll(e){let t=Math.ceil(this._schema.snapshotInfo.maxFeatureCount/this._queryInfo.pageSize);for(let n=0;n<t;n++)yield this._downloadPage(n,e)}async _downloadPage(e,t){w(this._options);let n=this._queryInfo.createPagedQuery(e,t),r=await this._fetch(n,this._options,{chunkId:e.toString()}),i=new N(r,n.inner.toJSON(),e,!1);return w(this._options),i}},Qn=12,$n=class extends J{constructor(e,t,n){super(e.metadata,t,n),this._service=e,this._chunkId=0,this._files=new Map,this._chunksByFile=new Map}destroy(){super.destroy();for(let{file:e}of this._files.values())e.free();this._files.clear()}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}get availableFields(){return this._schema.partial.availableFields}get definitionExpression(){return this._schema.full.definitionExpression}async tryUpdate(e,n){if(h(this.availableFields,n.availableFields)&&await this._updateFields(n.availableFields),h(this._schema.partial.urls,n.urls)){for(let e of n.urls)this._files.has(e)||await this._insert(e);for(let e of this._files.keys())if(!n.urls.includes(e))throw new t(`unsupported`,`Removing parquet files is not supported`,{previous:this._schema.partial.urls,next:n.urls})}return this._schema.partial=n,!0}async load(e){return this._promise??=this._download(),this._promise}unload(e){}_onOverride(){}async _updateFields(e){await this._promise;let t=new Set(e),n=u(t,new Set(this.availableFields));if(this._fieldsIndex!=null&&n.size){let e=Array.from(n),t=[];for(let[n,r]of this._chunksByFile.entries()){let{file:i}=this._files.get(n);for(let n of r)t.push(i.updateChunkFields(n,e))}await Promise.all(t)}}_ensureFieldsIndex(e){if(!this._fieldsIndex){let t=e.fields(!1).map(t=>({name:t.name,alias:t.name,type:t.type,column:e.columnForFieldName(t.name)})),{timeZoneByFieldName:n}=this._service.metadata.fieldsIndex;this._fieldsIndex=l.fromJSON({fields:t,timeZoneByFieldName:n})}return this._fieldsIndex}async _insert(e){let t=await rt(),n=await it(e,{geometryInfo:this._service.geometryInfo,getCustomParameters:()=>this._schema.full.customParameters}),r=this._files.size;this._files.set(e,{file:n,fileId:r}),w(this._options);let i=this._ensureFieldsIndex(n),a=t.Query.new();a.setOutFields(this.availableFields.filter(e=>i.get(e)?.column!=null)),a.setReturnGeometry(!0),a.setOutSpatialReference(this.metadata.outSpatialReference.toJSON().wkid);let o=await n.executeQuery(a,this._signal);w(this._signal);let s=[],c=o.next(this._signal);for(let e=0;e<Qn;e++)s.push(o.next(this._signal));let l=[];this._chunksByFile.set(e,l);let u=await c;for(;u!=null;){w(this._signal),l.push(u);let e=this._chunkId++,t=new mt(this.metadata,i,u,r),n=new N(t,null,e,!1);this.store.insert(n);let a=s.shift();s.push(o.next(this._signal)),u=await a}}async _download(){try{await Promise.all(this._schema.partial.urls.map(e=>this._insert(e)));let e=new N(j.empty(this.metadata),null,-1,!0);this.store.insert(e)}catch(e){throw console.error(e),e}}},er=class extends M{constructor(e,t,n,r,i){super(),this._metadata=e,this._reader=t,this._tile=n,this._page=r,this._end=i,this.chunkId=`${this._tile.key.id}.${this._page}${this.end?`e`:``}`,this.normalizedChunkId=`${this._tile.key.normalizedId}.${this._page}${this.end?`e`:``}`}get reader(){return this._reader??j.empty(this._metadata)}get first(){return this._page===0}get end(){return this._end}get tile(){return this._tile}get queryInfo(){return{type:`parquet`,chunkId:this.chunkId,queryJSON:null,page:this._page,size:this.size(),tileId:this._tile.id,end:this.end}}get isTiled(){return!0}getTileReader(e){return this._tile.key.id===e.key.id?this.reader:null}},tr=4,nr=class{constructor(e,t){this.subscription=e,this.chunks=[],this.ids=[],this._controller=new AbortController,this._handles=C([x(e.signal,()=>this._controller.abort()),x(t,()=>this._controller.abort())])}destroy(){this._controller.abort(),this._handles.remove()}get options(){return{signal:this._controller.signal}}addBinaryData(e){this.chunks.push(e)}addSourceChunkId(e){this.ids.push(e)}},rr=class extends J{constructor(e,t,n){if(super(e.metadata,t,n),this._service=e,this._loadStates=new Map,this._files=new Map,this._queue=new A({concurrency:32,process:e=>this._loadTile(e)}),!e.geometryInfo.displayOptimization)throw Error(`InternalError: ParquetTileLoadStrategy only supports XZ-enabled parquet files`);this._loaded=this._load()}destroy(){super.destroy();for(let{file:e}of this._files.values())e.free()}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}get availableFields(){return this._schema.partial.availableFields}get definitionExpression(){return this._schema.full.definitionExpression}async tryUpdate(e,n){await this._loaded;let r=!0;if(h(this.availableFields,n.availableFields)&&await this._updateFields(n.availableFields),h(this._schema.partial.urls,n.urls)){for(let e of n.urls)this._files.has(e)||(r=!1,await this._insert(e));for(let e of this._files.keys())if(!n.urls.includes(e))throw new t(`unsupported`,`Removing parquet files is not supported`,{previous:this._schema.partial.urls,next:n.urls})}return this._schema.partial=n,r}async load(e){return await this._loaded,Oe(this._loadStates,e.key.id,()=>new nr(e,this._options)),this._queue.push(e)}unload(e){let t=this._loadStates.get(e.tile.id);if(t!=null){for(let e of t.ids)this.store.removeById(e);t.destroy(),this._loadStates.delete(e.tile.id)}}async _load(){let e=this._schema.partial.urls;await Promise.all(e.map(e=>this._insert(e)))}async _insert(e){let t=await it(e,{geometryInfo:this._service.geometryInfo,getCustomParameters:()=>this._schema.full.customParameters}),n=this._files.size;this._ensureFieldsIndex(t),this._files.set(e,{file:t,fileId:n})}_onOverride(){}async _updateFields(e){let t=new Set(e),n=u(t,new Set(this.availableFields));if(this._fieldsIndex!=null&&n.size){let e=Array.from(n),t=[];for(let n of this._loadStates.values())for(let{fileUrl:r,data:i}of n.chunks){let{file:a}=this._files.get(r);t.push(a.updateChunkFields(i,e,n.options.signal))}await Promise.all(t)}}_ensureFieldsIndex(e){if(!this._fieldsIndex){let t=e.fields(!1).map(t=>({name:t.name,alias:t.name,type:t.type,column:e.columnForFieldName(t.name)})),{timeZoneByFieldName:n}=this._service.metadata.fieldsIndex;this._fieldsIndex=l.fromJSON({fields:t,timeZoneByFieldName:n})}return this._fieldsIndex}async _loadTile(e){let t=await rt(),n=e.tile,r=e.signal,{scale:i,translate:a}=n.normalizedTransform,o=t.Query.new();o.setExtent(n.extent),o.setQuantizationTransform({scale:i,translate:a}),o.setScale(n.scale),o.setOutFields(Array.from(this.availableFields).filter(e=>this._fieldsIndex.get(e)?.column!=null)),o.setOutSpatialReference(this.metadata.outSpatialReference.toJSON().wkid),o.setReturnGeometry(!0);let s=this._loadStates.get(n.id),c=0;for(let[e,{file:t,fileId:i}]of this._files.entries()){let a=await t.executeQuery(o,r),l=[],u=a.next(r);for(let e=0;e<tr;e++)l.push(a.next(r));let d=await u;for(;d!=null;){w(r);let t=new mt(this.metadata,this._fieldsIndex,d,i),o=new er(this.metadata,t,n,c++,!1);s.addBinaryData({data:d,fileUrl:e}),s.addSourceChunkId(o.chunkId),this.store.insert(o);let u=l.shift();l.push(a.next(r)),d=await u}}w(r);let l=new er(this.metadata,null,n,c++,!0);s.addSourceChunkId(l.chunkId),this.store.insert(l)}},ir=1e3,ar=class{constructor(e,n,r,i,a=128){if(this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=r,this._purgeOptions=i,this.store=e,n.type===`unique-id-composite`)throw new t(`stream-layer`,`composite uniqueIds are not supported`);this.idField=n.fieldName,this.purgeInterval=a,this._useGeneratedIds=this.idField===He}removeById(e){this._removed.push(e)}removeByTrackId(e){let t=this._trackIdToObservations.get(e);if(t)for(let e of t.entries)this._removed.push(e)}add(e){if(this._useGeneratedIds){let t=this._nextId();e.attributes[this.idField]=t,e.objectId=t}else e.objectId=e.attributes[this.idField];let t=e.objectId;if(this._addOrUpdated.set(t,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return this._trackIdLessObservations??=new gt(1e5),void this._trackIdLessObservations.enqueue(t);let n=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(n)){let e=this._purgeOptions?.maxObservations==null?ir:this._purgeOptions.maxObservations,t=ke(e,0,ir);this._trackIdToObservations.set(n,new gt(t))}let r=this._trackIdToObservations.get(n),i=r?.enqueue(t);i!=null&&(this._addOrUpdated.has(i)?this._addOrUpdated.delete(i):this._removed.push(i))}checkForUpdates(){let e=this._getToAdd(),t=this._getToRemove(),n=performance.now(),r=n-this._lastPurge,i=Date.now();r>=this.purgeInterval&&(this._purge(n),this._lastPurge=n);let a=[];if(t!=null)for(let e of t){let t=this.store.removeById(e);t!=null&&a.push(t)}let o=[];if(e!=null){let r=new Set(t??[]);for(let t of e)r.has(t.objectId)||(t.attributes.__esri_timestamp__=n,t.attributes.__esri_time_received__=i,this.store.add(t),o.push(t))}return!(!o.length&&!a?.length)&&(this.store.update(o,a),!0)}_getToAdd(){if(!this._addOrUpdated.size)return null;let e=Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach(n=>e[t++]=n),this._addOrUpdated.clear(),e}_getToRemove(){let e=this._removed;return this._removed.length?(this._removed=[],e):null}_nextId(){let e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}_purge(e){let t=this._purgeOptions;t!=null&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}_purgeSomeByDisplayCount(e){if(!e.displayCount)return;let t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField){for(let n of this._trackIdToObservations.values())if(t>e.displayCount&&n.size){let e=n.dequeue();this._removed.push(e),t--}}if(this._trackIdLessObservations!=null){let n=t-e.displayCount;for(;n-- >0;){let e=this._trackIdLessObservations.dequeue();e!=null&&this._removed.push(e)}}}}_purgeByAge(e){let t=this._timeInfo?.startTimeField;if(!e.age||!t)return;let n=60*e.age*1e3,r=this._maxAge-n;this.store.forEach(e=>{e.attributes[t]<r&&this._removed.push(e.objectId)})}_purgeByAgeReceived(e,t){if(!t.ageReceived)return;let n=e-60*t.ageReceived*1e3;this.store.forEach(e=>{e.attributes.__esri_timestamp__<n&&this._removed.push(e.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((e,t)=>{e.size===0&&this._trackIdToObservations.delete(t)})}},Q=class extends i{constructor(e){super(e)}get connectionStatus(){return this.connection?.connectionStatus}get errorString(){return this.connection?.errorString}};S([g()],Q.prototype,`connection`,void 0),S([g()],Q.prototype,`connectionStatus`,null),S([g()],Q.prototype,`errorString`,null),Q=S([d(`esri.views.2d.layers.features.sources.StreamConnectionState`)],Q);var or=class{constructor(e,t){this._metadata=e,this._onUpdate=t,this._objectIdToFeature=new Map}get size(){return this._objectIdToFeature.size}get reader(){return j.fromFeatures([...this._objectIdToFeature.values()],this._metadata)}add(e){this._objectIdToFeature.set(e.objectId,e)}forEach(e){this._objectIdToFeature.forEach(e)}removeById(e){let t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),t):null}clear(){this._objectIdToFeature=new Map}update(e,t){this._onUpdate(e?.length??0)}},sr=class extends M{constructor(e){super(),this._reader=e,this.chunkId=`stream-chunk`,this.normalizedChunkId=`stream-chunk`}get reader(){return this._reader}get first(){return!0}get end(){return!0}get queryInfo(){return{type:`stream`,chunkId:this.chunkId,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(e){let t=this.queryFeaturesInBounds(e.bounds);return t.setTransformForDisplay(e.transform),t}},cr=class extends J{constructor(e,t,n){super(e.metadata,t,n),this._service=e,this._connectionState=new Q,this._forceRefresh=!1,this.events=new ie;let{timeInfo:r}=this.metadata,{purgeOptions:i}=t.full;this._stagingStore=new or(this.metadata.weakCloneWithAdditionalFields([{name:Ve,alias:`timeReceived`,type:`esriFieldTypeDate`}]),e=>this.events.emit(`features-updated`,e)),this._manager=new ar(this._stagingStore,this.metadata.featureIdInfo,r,i),this.connect()}destroy(){super.destroy(),this.disconnect()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}get connectionStatus(){return this._connectionState.connectionStatus}get errorString(){return this._connectionState?.errorString}get availableFields(){return this._schema.full.availableFields}get definitionExpression(){return this._schema.full.definitionExpression}async tryUpdate(e,t){let n=this._chunk!=null;if(t.sourceRefreshVersion!==this._refreshVersion){if(this._refreshVersion=t.sourceRefreshVersion,!this._manager.checkForUpdates()&&n&&!this._forceRefresh)return this.events.emit(`tick`),!0;this._chunk&&(this.store.remove(this._chunk),e.requireInvalidation()),this._forceRefresh=!1,this._chunk=new sr(this._stagingStore.reader),this.store.insert(this._chunk),this.events.emit(`tick`)}return this._schema.partial=t,!0}async load(e){}unload(e){}disconnect(){this._streamConnection=me(this._streamConnection),this._connectionState.connection=null,this._handlesGroup?.remove()}connect(){if(this._streamConnection!=null)return;let{geometryType:e,spatialReference:t}=this.metadata,{maxReconnectionAttempts:n,maxReconnectionInterval:r,geometryDefinition:i,definitionExpression:a,customParameters:o}=this._schema.full;this._streamConnection=at(this._service.source,t,this._service.outSpatialReference,e,a,i,n,r,o),this._handlesGroup=C([this._streamConnection.on(`data-received`,e=>this._onFeature(e)),this._streamConnection.on(`message-received`,e=>this._onWebSocketMessage(e))]),this._connectionState.connection=this._streamConnection}clear(){this._manager.checkForUpdates(),this._stagingStore.clear(),this._forceRefresh=!0}updateCustomParameters(e){this._streamConnection?.updateCustomParameters(e)}sendMessageToSocket(e){this._streamConnection?.sendMessageToSocket(e)}sendMessageToClient(e){this._streamConnection?.sendMessageToClient(e)}_onOverride(){}_onWebSocketMessage(e){if(`type`in e)switch(e.type){case`delete`:if(e.objectIds)for(let t of e.objectIds)this._manager.removeById(t);if(e.trackIds)for(let t of e.trackIds)this._manager.removeByTrackId(t);break;case`clear`:this.clear()}this.events.emit(`message-received`,e)}_onFeature(e){try{this._manager.add(e),this.events.emit(`data-received`,e)}catch{}}},lr=class{constructor(e,t,n,r){this._aggregateAdapter=e,this._subscriptions=t,this._connection=n,this._cachedObjectIds=r,this._updateTracking=new ht({debugName:`FeatureSource`}),this.store=new ut}destroy(){this._strategy?.destroy(),this._streamMessenger?.destroy(),this._updateTracking?.destroy(),this.store.destroy()}get metadata(){return this._strategy.metadata}get streamMessenger(){return this._streamMessenger??this._initStreamMessenger(),this._streamMessenger}get statistics(){return vn.from(this.store)}get updateTracking(){return this._updateTracking}get usedMemory(){return this.store.usedMemory}get queryEngine(){if(!this._queryEngine){if(!this.store||!this._strategy)return null;this._queryEngine=new $e({featureStore:this.store,fieldsIndex:this.metadata.fieldsIndex,geometryType:this.metadata.geometryType,featureIdInfo:this.metadata.featureIdInfo,hasM:!1,hasZ:!1,spatialReference:this.metadata.outSpatialReference,aggregateAdapter:this._aggregateAdapter,timeInfo:this.metadata.timeInfo,definitionExpression:this._strategy?.definitionExpression,availableFields:this._strategy?.availableFields})}return this._queryEngine}get isStream(){return this._schema.type===`stream`}get hasQueryDisplayFilter(){if(!this._schema)return!1;switch(this._schema.type){case`feature`:return this._schema.strategy.full.displayFilterInfo!=null;case`parquet`:case`stream`:return!1}}chunks(){return Array.from(this.store.chunks())}prepareCacheUpdate(e,t){let n=new Set,r=new Set;for(let t of e)this._cachedObjectIds.has(t)||(this._cachedObjectIds.add(t),n.add(t));for(let e of t)this._cachedObjectIds.delete(e),r.add(e);this.hasQueryDisplayFilter&&this._strategy.prepareCacheUpdate(n,r)}async applyCacheUpdate(){this.hasQueryDisplayFilter&&await this._updateTracking.addPromise(this._strategy.applyCacheUpdate())}cleanup(){return this.store.cleanup()}onSubscribe(e){if(this._connection.onEvent({type:`subscribe`,tile:e.tile.id}),!this._strategy)return;let t=this._strategy.load(e);t.then(()=>this._connection.onEvent({type:`loaded`,tile:e.tile.id})).catch(t=>this._connection.onEvent({type:`error`,tile:e.tile.id,error:t})),this._updateTracking.addPromise(t)}onResume(e){this._updateTracking.addPromise(ue(this._strategy?.load(e)))}onUnsubscribe(e){this._connection.onEvent({type:`unsubscribe`,tile:e.tile.id}),this._strategy?.unload(e)}async applyOverride(e){await this._strategy?.applyOverride(e)}takeOverrideUpdate(){return this._strategy?.takeOverrideUpdate()}async update(e,t){let n=this._schema;if(this._schema=e,this._queryEngine=me(this._queryEngine),n&&n.type!==e.type)throw Error(`InternalError: Reconfiguring source types is not supported.`);let r=new bn;return!n||h(n.service,e.service)||n.strategy.type!==e.strategy.type||h(e.strategy.full,n.strategy.full)||!await this._strategy.tryUpdate(r,e.strategy.partial)?(await this._updateStrategyType(this._schema.service,e,t),await this.store.update({metadata:this.metadata,definitionExpression:this._schema.strategy.full.definitionExpression}),!0):r.requiresInvalidation}unsafeSetQueryHistoricMoment(e){this._schema.type===`feature`&&(this._schema.strategy.full.historicMoment=e,this._strategy.unsafeSetQueryHistoricMoment(new Date(e)))}_initStreamMessenger(){this._streamMessenger??=new q(this._connection)}async normalizeOverrides(e){let t={historicMoment:e.historicMoment,commands:{updateWeak:e.commands.updateWeak.map(D.fromJSON),removeWeak:e.commands.removeWeak,update:e.commands.update.map(D.fromJSON),remove:e.commands.remove,release:e.commands.release}},n=e.commands.updateByIdWeak,r=await this._queryOptimizedFeatures(n);if(r.length!==n.length){let e=new Set(r.map(e=>e.objectId));for(let r of n)e.has(r)||t.commands.removeWeak.push(r)}return t.commands.updateWeak.push(...r),t}async _queryOptimizedFeatures(e){if(e.length===0)return[];let t=[],n=(await this._strategy.queryByObjectId(e,[`*`])).getCursor();for(;n.next();)t.push(n.readOptimizedFeatureWorldSpace());return t}getObjectIdsFromGlobalIds(e){let t=this.metadata.globalIdField;if(t==null)throw Error(`InternalError: Recieved an edit with globalIds, but not supported by the service`);let n=this.store.mapObjectIdsFromGlobalIds(e,t).values();return Array.from(n)}async _updateStrategyType(e,t,n){let r=this._createStrategy(e,t);this._connection.onEvent({type:`updateStrategyStart`,about:r.about});let i=!!this._strategy;this.store.clear(),this._strategy?.destroy(),this._strategy=r,c(`esri-2d-update-debug`)&&console.debug(`Version[${n}] FeatureSource.updateStrategy`,{strategy:r});let a=Array.from(this._subscriptions.values());if(!a.length)return void this._connection.onEvent({type:`updateStrategyEnd`});let o=Promise.all(a.map(e=>this._strategy.load(e).then(()=>this._connection.onEvent({type:`loaded`,tile:e.tile.id})).catch(t=>this._connection.onEvent({type:`error`,tile:e.tile.id,error:t}))));this._updateTracking.addPromise(o),this._strategy.prepareCacheUpdate(this._cachedObjectIds);try{i&&await o}catch(e){y(e)}this._connection.onEvent({type:`updateStrategyEnd`}),c(`esri-2d-update-debug`)&&console.debug(`Version[${n}] FeatureSource.updateStrategyEnd`,{strategy:r})}_createStrategy(e,t){let n={connection:this._connection,store:this.store};switch(t.type){case`feature`:return this._createFeatureLoadStrategy(e,t.strategy,n);case`parquet`:return this._createParquetLoadStrategy(e,t.strategy,n);case`stream`:return this._createStreamLoadStrategy(e,t.strategy,n)}}_createFeatureLoadStrategy(e,t,n){switch(t.type){case`drill-down`:return new qn(e,t,n);case`paged-tile`:return new Xn(e,t,n);case`snapshot`:return new Zn(e,t,n)}}_createParquetLoadStrategy(e,t,n){switch(t.type){case`xz`:return new rr(e,t,n);case`snapshot`:return new $n(e,t,n)}}_createStreamLoadStrategy(e,t,n){let r=new cr(e,t,n);return this.streamMessenger.strategy=r,r}},ur=class{constructor(e,t){this.tile=e,this.version=t,this._abortController=new AbortController}get key(){return this.tile.key}get signal(){return this._abortController.signal}abort(){this._abortController.abort()}},$=class{constructor(e){this.inner=e,this.resolver=te()}},dr=class{constructor(){this._aggregateAdapter={getFeatureObjectIds:e=>this._processor.getFeatureObjectIdsForAggregate(e)},this._subscriptions=new Map,this._cachedObjectIds=new Set,this._updateRequested=!1,this._didSourceRefresh=!1,this._updateSubscriptionRequests=[],this._updateHighlightRequests=[]}destroy(){this._subscriptions.clear(),this._processor?.destroy(),this._source?.destroy(),this._handles?.remove(),this._updateOverridesRequest=null,this._tileInfoView=null}onAttach(e){c(`esri-2d-update-debug`)&&console.debug(`Pipeline.onAttach`);let t=this._connection,n=r.fromJSON(e.tileInfoJSON);this._tileInfoView=new ge(n),this._source=new lr(this._aggregateAdapter,this._subscriptions,t,this._cachedObjectIds),this._processor=new gn(t,this._source),this._handles=C([this._source.store.events.on(`changed`,()=>this._requestUpdate()),this._source.store.events.on(`refresh`,()=>this._requestRefresh()),xe(()=>this._source.updateTracking.updating,()=>{this._requestUpdate(),ue(this._connection.layerView.setUpdating({source:this._source.updateTracking.updating,pipeline:!0}))})])}onDetach(){c(`esri-2d-update-debug`)&&console.debug(`Pipeline.onDetach`),this.destroy()}set remoteClient(e){this._connection=new wt(e)}get features(){let e=this._source?.queryEngine;if(!e)throw new t(`no-queryEngine`,`No query engine defined`);return e}get aggregates(){let e=this._processor?.aggregateQueryEngine;if(!e)throw new t(`no-queryEngine`,`No aggregate query engine defined`);return e}get processor(){return this._processor}get streamMessenger(){return this._source.streamMessenger}getUsedMemory(){return this._source.usedMemory+this._processor.usedMemory}getDisplayFeatures(e){return this._processor.getDisplayFeatures(e)}getDisplayIds(e){return this._processor.getDisplayIds(e)}getObjectIdsFromGlobalIds(e){return this._source.getObjectIdsFromGlobalIds(e)}async updateSchema(e,t){return c(`esri-2d-update-debug`)&&this._updateSchemaRequest&&console.error(`InternalError: Schema already updating`),this._updateSchemaRequest=new $({schema:e,version:t}),this._requestUpdate(),this._updateSchemaRequest.resolver.promise}updateSubscriptions(e){let t=new $(e);return this._updateSubscriptionRequests.push(t),this._requestUpdate(),t.resolver.promise}updateHighlight(e){let t=new $(e);return this._updateHighlightRequests.push(t),this._requestUpdate(),t.resolver.promise}async onOverride(e){if(this._updateOverridesRequest!=null)throw new t(`featurelayer`,`InternalError - Already processing an edit`);this._updateOverridesRequest=new $(e);let n=this._updateOverridesRequest.resolver.promise;return this._requestUpdate(),n}queryStatistics(){return this._source.statistics.toJSON()}async queryVisibleFeatures(e,t){return this.features.executeQuery(e,t)}async queryHeatmapStatistics(e){let t=Math.round(de(e.radius)),n=1/0,r=-1/0,i=typeof e.fieldOffset==`string`,a=e.fieldOffset??0,o=Array.from(this._subscriptions.values()),s=this._source.chunks(),c=t**2,l=3/(Math.PI*c),u=2*t,d=Math.ceil(512/u);for(let t of o){let o=t.tile,f=new Float64Array(d*d);for(let t of s){let n=t.getTileReader(o);if(!n)continue;let r=n.getCursor();for(;r.next();){let t=1;if(e.field!=null){let n=r.readAttribute(e.field);t=i?-1*n:+n+a}let n=r.readXForDisplay()/u,o=r.readYForDisplay()/u,s=Math.floor(n),p=Math.floor(o);if(s<0||p<0||s>=d||p>=d)continue;let m=((.5+s-n)*u)**2+((.5+p-o)*u)**2;if(m>c)continue;let h=t*(l*(1-m/c)**2);f[p+s*d]+=h}}for(let e=0;e<f.length;e++)n=Math.min(n,f[e]),r=Math.max(r,f[e])}return{max:r,min:n}}async getSampleFeatures(e){let t=this._source.chunks();if(t.reduce((e,t)=>e+t.size(),0)<=e.minFeatureCount){if(!this._source.updateTracking.updating){let e=[];return this._source.store.forEachUnsafe(t=>e.push(t.readLegacyFeatureWorldSpace())),e}return null}let n=new Set,r=[],i=t.map(e=>e.reader.getCursor()),a=new _,o=3*e.sampleSize;for(let s=0;s<o&&r.length<e.sampleSize;s++){let e=i[a.getIntRange(0,t.length-1)];if(e.getSize()===0)continue;let o=a.getIntRange(0,e.getSize()-1);e.setIndex(o);let s=e.getObjectId();n.has(s)||(n.add(s),r.push(e.readLegacyFeatureWorldSpace()))}return r.length>=e.sampleSize?r:null}_requestUpdate(){this._updateRequested||(this._updateRequested=!0,oe(()=>this._scheduleNextUpdate()))}_requestRefresh(){this._didSourceRefresh=!0,this._requestUpdate()}_scheduleNextUpdate(){this._updateRequested&&(this._ongoingUpdate||(this._ongoingUpdate=pe(this._doUpdate()).finally(()=>{this._ongoingUpdate=null,this._scheduleNextUpdate()}),this._updateRequested=!1))}_subscribe(e){let t=e.tileId;if(this._subscriptions.has(t))return;c(`esri-2d-update-debug`)&&console.debug(`Tile[${t}] Pipeline.subscribe`);let n=new p(this._tileInfoView,t),r=new ur(n,e.version);this._subscriptions.set(t,r),this._source.onSubscribe(r),this._processor.onSubscribe(r)}_unsubscribe(e){let t=this._subscriptions.get(e);t&&(c(`esri-2d-update-debug`)&&console.debug(`Tile[${e}] Pipeline.unsubscribe`),t.abort(),this._source.onUnsubscribe(t),this._processor.onUnsubscribe(t),this._subscriptions.delete(t.key.id))}async _doUpdate(){if(c(`esri-2d-update-debug`)&&console.debug(`Pipeline._doUpdateStart`),await this._connection.layerView.setUpdating({source:this._source.updateTracking.updating,pipeline:!0}),this._updateSubscriptionRequests.length){let e=this._updateSubscriptionRequests;this._updateSubscriptionRequests=[];for(let t of e)this._doUpdateSubscriptions(t.inner),t.resolver.resolve()}if(this._updateHighlightRequests.length){let e=this._updateHighlightRequests,t=new Set,n=new Set;for(let r of e)for(let{objectId:e,highlightFlags:i}of r.inner.highlights)i?(t.add(e),n.delete(e)):(n.add(e),t.delete(e));this._source.prepareCacheUpdate(t,n)}let e=this._updateSchemaRequest;this._updateSchemaRequest=null;let t=!1;if(e!=null){let{schema:n,version:r}=e.inner;t=await this._doUpdateSchema(n,r)}this._processor.requiresInvalidation()&&(t=!0),this._didSourceRefresh&&=(t=!0,!1),t&&(this._processor.invalidate(),await this._connection.container.updateRenderState(this._processor.version));let n=this._updateOverridesRequest;if(this._updateOverridesRequest=null,n!=null){c(`esri-2d-update-debug`)&&console.debug(`Pipeline.applyOverride`,n.inner),n.inner.historicMoment!=null&&this._source.unsafeSetQueryHistoricMoment(n.inner.historicMoment);let e=await this._source.normalizeOverrides(n.inner);await this._source.applyOverride(e),c(`esri-2d-update-debug`)&&console.debug(`Pipeline.endOverride`,n.inner)}if(await this._source.applyCacheUpdate(),this._updateHighlightRequests.length){let e=this._updateHighlightRequests;this._updateHighlightRequests=[];for(let t of e)this._processor.updateHighlight(t.inner),t.resolver.resolve()}let r=this._source.cleanup();this._processor.removeChunks(r);try{let e=this._source.takeOverrideUpdate();if(e!=null&&this._subscriptions.size){c(`esri-2d-update-debug`)&&console.debug(`Pipeline.applyOverrideChangesStart`),await this._connection.container.lockForOverrides();try{await this._processor.applyOverrideUpdate(e)}catch(e){c(`esri-2d-update-debug`)&&console.debug(`InternalError`,e)}await this._connection.container.unlockForOverrides(),c(`esri-2d-update-debug`)&&console.debug(`Pipeline.applyOverrideChangesEnd`)}this._subscriptions.size&&(c(`esri-2d-update-debug`)&&console.debug(`Pipeline.updateChunksStart`),await this._processor.updateChunks(),c(`esri-2d-update-debug`)&&console.debug(`Pipeline.updateChunksEnd`))}catch(e){y(e)}n?.resolver.resolve(),e?.resolver.resolve(),e==null&&t&&await this._connection.container.trySwapRenderState(),this._connection.onEvent({type:`performance`,usedMemory:this.getUsedMemory()}),this._updateRequested?(c(`esri-2d-update-debug`)&&console.debug(`Pipeline._doUpdateEnd [updateRequested=true]`),await this._connection.layerView.setUpdating({source:this._source.updateTracking.updating,pipeline:!0})):(c(`esri-2d-update-debug`)&&console.debug(`Pipeline._doUpdateEnd [updateRequested=false, After flush]`),await this._connection.layerView.setUpdating({source:this._source.updateTracking.updating,pipeline:this._updateRequested}))}async _doUpdateSchema(e,t){c(`esri-2d-update-debug`)&&console.debug(`Version[${t}] Pipeline.updateStart`,{schema:e});let n={tileInfo:this._tileInfoView?.tileInfo},r=await this._source.update(e.source,t),i=Array.from(this._subscriptions.values()),a=this._processor.update(e,t,n,r,i);return c(`esri-2d-update-debug`)&&console.debug(`Version[${t}] Pipeline.updateEnd`),a}_doUpdateSubscriptions(e){c(`esri-2d-update-debug`)&&console.debug(`Pipeline.updateSubscriptions`,e);for(let t of e.subscribe)this._subscribe(t);for(let t of e.unsubscribe)this._unsubscribe(t)}};export{dr as default};