const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HighlightApply.glsl-Ckti349P.js","assets/HighlightApply.glsl-CNyWELqn.js","assets/HighlightDownsample.glsl-DyJdjhu-.js","assets/ScreenSpacePass.glsl-MQijsFL9.js","assets/glsl-B__sVAcg.js","assets/NoParameters-B66z9IwQ.js","assets/ShaderBuilder-NkkCCxyc.js","assets/index-ByaFsVj4.js","assets/index-DiFef-Um.css","assets/Uniform-CfHWJqSg.js","assets/HighlightCellGridScreenSpacePass.glsl-BBeEssS1.js","assets/IntegerPassUniform-BWtfz08R.js","assets/HighlightReadBitmap.glsl-yTX333eD.js","assets/Float2DrawUniform-DrsJI05n.js","assets/FloatPassUniform-D-_T45xB.js","assets/Texture2DPassUniform-wY08hxIn.js","assets/HighlightBlur.glsl-DAauDA3p.js","assets/HighlightBlur.glsl-BQAYX9u9.js","assets/Texture2DDrawUniform-CV_1kucp.js","assets/HighlightDownsample.glsl-BITL2CrS.js","assets/HighlightToSingle.glsl-B0qirTCJ.js","assets/HighlightToSingle.glsl-gu8UOLTK.js","assets/TextureOnly.glsl-C5B-kH5x.js","assets/TextureOnly.glsl-LCLoOTrW.js","assets/Float3PassUniform-BIrLVK7_.js","assets/OverlayCompositing.glsl-XTdj7HNT.js","assets/OverlayCompositing.glsl-xMBM1ouP.js","assets/ColorMaterial.glsl-DI0NBGuB.js","assets/ColorMaterial.glsl-BH2-Jwwj.js","assets/Transform.glsl-BzRx33WP.js","assets/Float2BindUniform-COpkFEGz.js","assets/FloatBindUniform-BPgZfINH.js","assets/Slice.glsl-ILtGSCz4.js","assets/Float3DrawUniform-UWnIK6YY.js","assets/VisualVariables.glsl-0raoMJkY.js","assets/FloatsPassUniform-7FLgAvOu.js","assets/AlphaCutoff-qYsC5qb0.js","assets/Texture2DBindUniform-BW-pj6EM.js","assets/Float4PassUniform-CYWbrPzx.js","assets/ObjectAndLayerIdColor.glsl-DLOlMhcf.js","assets/VertexColor.glsl-D6K20lwp.js","assets/TerrainDepthTest.glsl-8QLA4mH-.js","assets/ReadDepth.glsl-D7iXVNKu.js","assets/View.glsl-DOc5qj3l.js","assets/Float3BindUniform-DnRIK6cJ.js","assets/Matrix4BindUniform-DNS5lGEU.js","assets/OutputColorHighlightOLID.glsl-DrcS4MFv.js","assets/Emissions.glsl-CK4HR9OW.js"])))=>i.map(i=>d[i]);
import{BS as e,Bb as t,Bf as n,Cb as r,Cl as i,Cm as a,Cw as o,DT as s,Db as c,Dm as l,Eb as u,Ey as d,Ff as f,Gg as p,Hl as m,Il as h,Is as ee,J as g,Kb as te,Ls as _,Ml as v,Ms as y,Nf as ne,Nm as re,Nu as b,Nw as ie,OT as x,Ob as ae,Ol as oe,Om as se,Pm as ce,QE as le,Q_ as ue,Rf as S,Rm as de,Tl as fe,Tm as pe,UC as me,Vl as he,Vm as ge,Yu as _e,Z as ve,_T as ye,_b as C,_t as be,_w as xe,a_ as Se,al as Ce,cE as we,c_ as w,dw as Te,ev as Ee,gD as T,gT as De,gs as Oe,hb as ke,jl as Ae,kb as je,lw as Me,mb as Ne,mt as Pe,nv as E,nw as Fe,oE as Ie,oT as Le,ol as Re,ot as ze,ov as Be,pD as Ve,qh as He,rl as Ue,rv as We,tx as Ge,uD as Ke,uE as qe,u_ as Je,vs as Ye,xb as D,yb as O,yl as Xe,yw as Ze}from"./index-ByaFsVj4.js";import{a as Qe,r as $e,s as et}from"./axisAngleDegrees-jawZYrHR.js";import{D as tt}from"./plane-Dmhe_zL4.js";import{n as nt}from"./triangulationUtils-DrUA1_Jh.js";import{a as k,n as rt,o as it,t as A}from"./Util-uF9mYnOn.js";import{_ as at,f as ot,g as st,i as ct,l as lt}from"./Emissions.glsl-CK4HR9OW.js";import{t as ut}from"./NoParameters-B66z9IwQ.js";import{n as dt}from"./VertexAttributeLocations-BMy2FGBT.js";import{r as ft,t as pt}from"./sphere-BCy4W-Wa.js";import{t as mt}from"./VertexArrayObject-IhETPpMJ.js";import{t as ht}from"./BufferObject-DWz5bVRd.js";import{t as gt}from"./VertexBuffer-BwGrH3vw.js";import{a as j,n as M,r as _t,u as vt}from"./renderState-DH1meWdn.js";import{B as yt,E as bt,F as xt,I as St,N as Ct,O as wt,P as N,R as Tt,V as Et,a as Dt,c as Ot,o as kt,p as At,t as jt,u as Mt,z as Nt}from"./DefaultBufferWriter-BACGnssJ.js";import{g as Pt,l as Ft,y as It}from"./ElevationContext-CrjPNTXX.js";import{a as P,c as Lt,i as Rt,l as zt,o as Bt,p as Vt,r as Ht,s as F,t as Ut}from"./SceneLighting-BZCjD1kJ.js";import{a as I,s as Wt}from"./FloatArray-CclVVn1u.js";import{d as Gt,f as Kt,i as qt}from"./FloatsPassUniform-7FLgAvOu.js";import{n as Jt,t as Yt}from"./TextureOnly.glsl-LCLoOTrW.js";import{i as Xt,o as Zt,t as Qt}from"./HighlightDownsample.glsl-DyJdjhu-.js";import{t as $t}from"./HighlightApply.glsl-CNyWELqn.js";import{r as en,t as tn}from"./HighlightBlur.glsl-BQAYX9u9.js";import{t as nn}from"./HighlightToSingle.glsl-gu8UOLTK.js";import{t as rn}from"./NestedMap-BEhJHzak.js";import{t as an}from"./AlphaCutoff-qYsC5qb0.js";import{n as on}from"./ManagedTexture-DsmE3OU2.js";import{n as sn}from"./weather-BKWZP1Rd.js";import{n as cn,r as ln}from"./OverlayCompositing.glsl-xMBM1ouP.js";import{n as un}from"./ColorMaterial.glsl-BH2-Jwwj.js";import{t as dn}from"./TextureBackedBufferLayout-BKch40yL.js";var fn=class extends mt{},pn=class{constructor(){this._extent=Ge(),this.resolution=0,this.renderLocalOrigin=It(0,0,0,`O`),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new mn}get extent(){return this._extent}setExtent(e){ze(this._extent,e)}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;let n=.001*e.range;if(this._extent[0]-n<=e.min){let n=this.canvasGeometries.extents[this.canvasGeometries.numViews++];t(this._extent,e.range,0,n)}if(this._extent[2]+n>=e.max){let n=this.canvasGeometries.extents[this.canvasGeometries.numViews++];t(this._extent,-e.range,0,n)}}_setupGeometryView(){this.canvasGeometries.numViews=1,te(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){let t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},mn=class{constructor(){this.extents=[Ge(),Ge(),Ge()],this.numViews=0}},hn=class{constructor(e,t,n){this._fbos=e,this._format=t,this._name=n}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=ye(this._handle)}get texture(){return this._handle?.getTexture()}ensureFramebuffer(e,t){this._handle&&this._handle.fbo?.width===e&&this._handle.fbo?.height===t||(this._handle?.release(),this._handle=this._fbos.acquire(e,t,this._name,this._format))}bind(e){e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}},L=class{constructor(e,t,n,r,i=1,a=6){this.output=n,this.content=r,this.redrawOnRequest=i,this.fbo=new hn(e,a,t)}handleRenderRequest(e){return e===1||e===this.redrawOnRequest}get valid(){return this.fbo.valid}},gn=class{constructor(e){this.targets=[new L(e,`overlay color`,0,0),new L(e,`overlay IM color`,0,1),new L(e,`overlay highlight`,8,2,1,3),new L(e,`overlay water`,2,3,0),new L(e,`overlay occluded`,0,4)],Gt()&&this.targets.push(new L(e,`overlay olid`,9,5,1,5))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(e){if(e!==0)for(let e of this.targets)e.fbo.dispose();else this.targets[3].fbo.dispose()}computeValidity(){return this.targets.reduce((e,t,n)=>t.valid?e|=1<<n:e,0)}},_n={required:[]},vn=class extends xe{precompile(e){return!!this.acquireTechniques(e)}consumes(){return _n}get usedMemory(){return 0}get renderOccludedFlags(){return 1}get isDecoration(){return!1}get readyToRun(){return!1}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmitters(){return!1}forEachGeometry(e){}},yn=class extends vn{},bn=class extends vn{},xn=class extends P{constructor(t,n){super(t,n,dt(Bt)),this.shader=new F($t,()=>e(()=>import(`./HighlightApply.glsl-Ckti349P.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15])))}initializePipeline(){return M({blending:vt,colorWrite:j})}};xn=T([x(`esri.views.3d.webgl-engine.effects.highlight.HighlightApplyTechnique`)],xn);var Sn=class extends P{constructor(t,n){super(t,n,dt(Bt)),this.shader=new F(tn,()=>e(()=>import(`./HighlightBlur.glsl-DAauDA3p.js`),__vite__mapDeps([16,17,7,8,10,2,3,4,5,6,9,11,13,18])))}initializePipeline(){return M({colorWrite:j})}};Sn=T([x(`esri.views.3d.webgl-engine.effects.highlight.HighlightBlurTechnique`)],Sn);var Cn=class extends P{constructor(){super(...arguments),this.shader=new F(Qt,()=>e(()=>import(`./HighlightDownsample.glsl-BITL2CrS.js`),__vite__mapDeps([19,2,3,4,5,6,7,8,9])))}initializePipeline(){return M({colorWrite:j})}};Cn=T([x(`esri.views.3d.webgl-engine.effects.highlight.HighlightDownsampleTechnique`)],Cn);var wn=class extends ut{constructor(){super(...arguments),this.occludedFactor=_e,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}},Tn=class extends P{constructor(t,n){super(t,n,dt(Bt)),this.shader=new F(nn,()=>e(()=>import(`./HighlightToSingle.glsl-B0qirTCJ.js`),__vite__mapDeps([20,2,3,4,5,6,7,8,9,21,10,11,12])))}initializePipeline(){return M({colorWrite:j})}};Tn=T([x(`esri.views.3d.webgl-engine.effects.highlight.HighlightToSingleTechnique`)],Tn);var En=class extends Lt{constructor(){super(...arguments),this.produces=zt.HIGHLIGHTS,this.consumes={required:[zt.HIGHLIGHTS,`highlights`]},this._downsampleDrawParameters=new Xt,this._passParameters=new wn,this._highlightBlurDrawParameters=new en,this._grid=new Dn}initialize(){this.addHandles([E(()=>this._updateOptionsTexture(),()=>{},Ee)])}destroy(){this._grid.coverage=ye(this._grid.coverage),this._grid.vao=De(this._grid.vao),this._passParameters.highlightOptionsTexture=ye(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){let e=new Ye(16,2);e.internalFormat=6408,e.samplingMode=9728,this._passParameters.highlightOptionsTexture=new Oe(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(On(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(Cn),this.techniques.precompile(Tn),this.techniques.precompile(Sn),this.techniques.precompile(xn)}render(e){let t=e.find(({name:e})=>e===zt.HIGHLIGHTS),{techniques:n,bindParameters:r}=this;if(!r.decorations)return t;if(!n.get(Cn).compiled)return this.requestRender(1),t;let i=e.find(({name:e})=>e===`highlights`).getTexture();return this._renderHighlightPostprocess(i,t),t}_prepareAndDownSample(e){this._gridUpdateResources(e);let t=this.techniques.get(Cn),n=this._gridComputeCoverage(t,e),{horizontalCellCount:r,verticalCellCount:i}=n,a=this._passParameters;return a.horizontalCellCount=r,a.verticalCellCount=i,a.coverageTexture=n.coverage?.getTexture(),n}_renderGrid(e){let t=e.verticalCellCount*e.horizontalCellCount;this.renderingContext.bindVAO(e.vao),this.renderingContext.drawElementsInstanced(ee.TRIANGLES,6,y.UNSIGNED_BYTE,0,t)}_renderHighlightPostprocess(e,t){let{fboCache:n,techniques:i,bindParameters:a,_passParameters:o,renderingContext:s}=this,c=i.get(Tn),l=i.get(Sn),u=i.get(xn);if(!u.compiled||!l.compiled||!c.compiled)return void this.requestRender(1);o.highlightTexture=e;let d=this._prepareAndDownSample(e),{width:f,height:p}=e.descriptor;o.highlightTexture=e;let{camera:m}=a,{fullWidth:h,fullHeight:ee,pixelRatio:g,fullViewport:te}=m,_=Math.ceil(h/g),v=Math.ceil(ee/g),{_highlightBlurDrawParameters:y}=this,ne=this.view.stage.renderView.renderer,{highlights:re}=a;for(let e=0;e<re.length;++e){let{name:i}=re[e];if(!ne.hasHighlight(i))continue;o.highlightLevel=e,s.setClearColor(0,0,0,0);let m=n.acquire(f,p,`single highlight`,2);s.bindFramebuffer(m.fbo),s.setViewport(0,0,f,p),s.clear(16384),s.bindTechnique(c,a,o),this._renderGrid(d),y.blurInput=m.getTexture(),r(y.blurSize,1/_,0);let h=n.acquire(_,v,`single highlight blur`,2);s.unbindTexture(h.fbo?.colorTexture),s.bindFramebuffer(h.fbo),s.setViewport(0,0,_,v),s.clear(16384),s.bindTechnique(l,a,o,y),this._renderGrid(d),m.release(),r(y.blurSize,0,1/v),o.highlightBlurTexture=h.getTexture(),s.bindFramebuffer(t.fbo),s.setViewport4fv(te),s.bindTechnique(u,a,o,y),this._renderGrid(d),h.release()}o.coverageTexture=o.highlightTexture=null}_gridUpdateResources(e){let t=this._grid,{width:n,height:r}=e.descriptor;if(t.horizontalCellCount=Math.ceil(n/32),t.verticalCellCount=Math.ceil(r/32),t.vao)return;let i=this.renderingContext,a=ht.createIndex(i,35044,jn);t.vao=new fn(i,new gt(i,Bt),a)}_gridComputeCoverage(e,t){let n=this.renderingContext,r=this._grid,i=t.descriptor,a=Math.ceil(i.width/32),o=Math.ceil(i.height/32);this._downsampleDrawParameters.input=t;let{highlights:s}=this.bindParameters;r.coverage?.release();let c=this.fboCache.acquire(a,o,`highlight coverage`,s.length>4?3:1);return r.coverage=c,n.bindFramebuffer(c.fbo),n.bindTechnique(e,this.bindParameters,this._passParameters,this._downsampleDrawParameters),n.setViewport(0,0,a,o),n.screen.draw(),r}get test(){}};T([s()],En.prototype,`produces`,void 0),T([s()],En.prototype,`consumes`,void 0),En=T([x(`esri.views.3d.webgl-engine.effects.highlight.Highlight`)],En);var Dn=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function On(e){let t=new Uint8Array(128),n=0;for(let r of e){let e=4*n,i=4*n+64;++n;let{color:a}=r,o=r.haloColor??a;t[e+0]=a.r,t[e+1]=a.g,t[e+2]=a.b,t[e+3]=r.fillOpacity*a.a*255,t[i+0]=o.r,t[i+1]=o.g,t[i+2]=o.b,t[i+3]=r.haloOpacity*o.a*255}return t}var kn=0;function An(e){let t=0;for(let n of e){let{name:e}=n;t+=e.length;let{color:r,fillOpacity:i,haloColor:a,haloOpacity:o}=n;t+=r.r+r.g+r.b+r.a+i,t+=a?a.r+a.g+a.b+a.a+o:0}let n=e.at(0);if(n){let{shadowOpacity:e,shadowDifference:r,shadowColor:i}=n;t+=e+r+i.r+i.g+i.b+i.a}return kn+++(t>=0?0:1)}var jn=new Uint8Array([0,1,2,2,1,3]);function Mn(e,t,n,i,a,o=0){let{highlights:s}=i,c=s.length>1?t.acquire(n.width,n.height,`highlight mix`,s.length>4?3:1):null,{gl:l}=e;if(c){let t=e.getBoundFramebufferObject();e.bindFramebuffer(c.fbo),l.clearBufferuiv(l.COLOR,0,[0,0,0,0]),e.bindFramebuffer(t)}let u=c?.getTexture();i.highlightMixTexture=u,r(i.highlightMixOrigin,o,0),s.forEach((t,r)=>{if(r>0){let t=Oe.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(u,t),e.setActiveTexture(t),l.copyTexSubImage2D(3553,0,0,0,o,0,n.width,n.height),e.bindTexture(null,t)}e.clear(256),i.highlightLevel=r,a()}),i.highlightLevel=null,i.highlightMixTexture=null,c?.release()}var Nn=class{constructor(e,t,n,r){this.material=e,this.output=t,this.techniques=n,this.textures=r}},Pn=class{constructor(e,t,n,r){this._textures=e,this._techniques=t,this.materialChanged=n,this.requestRender=r,this._id2glMaterialRef=new rn}dispose(){this._textures.destroy()}acquire(e,t,n){if(this._ownMaterial(e),!e.produces.get(t)?.(n))return null;let r=this._id2glMaterialRef.get(n,e.id);if(r==null){let t=e.createGLMaterial(new Nn(e,n,this._techniques,this._textures));r=new Fn(t),this._id2glMaterialRef.set(n,e.id,r)}return r.ref(),r.glMaterial}release(e,t){let n=this._id2glMaterialRef.get(t,e.id);n!=null&&(n.unref(),n.referenced||(De(n.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&qe.getLogger(`esri.views.3d.webgl-engine.lib.GLMaterialRepository`).error(`Material is already owned by a different material repository`),e.repository=this}},Fn=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,k(this._refCnt>=0)}get referenced(){return this._refCnt>0}};function In(e){return e!=null&&!e.readyToRun}var Ln=class{constructor(){this.startTime=0,this._data=He(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new Rn,this.parallaxNew=new Rn,this._anchorPoint=w(),this._fadeState=He(0),this._fadeFactor=He(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(e,t,n){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=n?Te((t-this.startTime)/(Vn*n),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(e,t),this._updateParallax(e)}_evaluateState(e,t){let n=e.relativeElevation,r=this._updateAnchorPoint(e);(n>1.7*1e4||n<-1e4||r>Un)&&this.opacity>0?this._startFade(0,t):this.isFading||(n>1e4||n<-.35*1e4||r>Hn*Un?this.opacity>0&&this._startFade(4,t):In(this.data)&&(this.opacity===0?this._startFade(1,t):this.data.state===2&&(this.fadeState===2?this._startFade(3,t):this._startFade(2,t))))}_updateParallax(e){let t=fe(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-me.radius*me.radius,0))/Math.sqrt(t),Qe(zn,this.parallax.anchorPoint,R),l(this.parallax.transform,n,R[3],et(R)),Qe(zn,this.parallaxNew.anchorPoint,R),l(this.parallaxNew.transform,n,R[3],et(R))}_updateAnchorPoint(e){return Ue(this._anchorPoint,e.eye),i(this._anchorPoint,this._anchorPoint,me.radius),this.fadeState===0&&this.data?.state===2?(v(this.parallax.anchorPoint,this._anchorPoint),0):Ae(Xe(Bn,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,t){switch(this._fadeState.value=e,this.startTime=t,e){case 3:this.requestFade(),this._switchReadChannels(),v(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),v(this.parallax.anchorPoint,this._anchorPoint),v(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),v(this.parallax.anchorPoint,this._anchorPoint),v(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==2&&(this.data.state=0),this.fadeState){case 3:v(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:Ke(this.fadeState)}}_switchReadChannels(){this.data?.state===2&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return this.fadeState===4||this.fadeState===1||this.fadeState===3}},Rn=class{constructor(){this.anchorPoint=w(),this.radiusCurvatureCorrection=0,this.transform=S()}},zn=Je(0,0,1),R=$e(),Bn=w(),Vn=1.25,Hn=.5,Un=2e5,Wn=class{constructor(e){this.shadowMap=e,this.slot=2,this.slicePlane=null,this.hasOccludees=!1,this.hasEmission=!1,this.enableFillLights=!0,this.oitPass=0,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this.cutFillEnabled=!1,this._camera=new Vt,this._inverseViewport=b(),this._oldLighting=new Ut,this._newLighting=new Ut,this._fadedLighting=new Ut,this._lighting=this._newLighting,this.ssr=new Gn,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=[],this.highlightOrderMap=new Map,this.highlightMixOrigin=b(),this.highlightMixTexture=null,this.hudRenderStyle=0,this.hudOccludedFragmentOpacity=1,this.snowCover=0,this.clouds=new Ln,this.shadowHighlightsVisible=!1}destroy(){this._camera=null,this.contentCamera=null,this.depth=null,this.geometryDepth=null,this.mainDepth=null,this.overlay=null,this.ssao=null,this.terrainDepth=null}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get enableOffset(){return this.oitPass===1&&this.camera.relativeElevation<5e5}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,n,r){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=n,this._newLighting.set(e),this._oldLighting.updateLegacy(),r===1&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}get occluder(){return this.slot===11||this.slot===12?this.slot:null}},Gn=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=S()}},Kn=class{constructor(e,t,n){this.rctx=e,this.techniques=n,this.lastFrameCamera=new Vt,this.output=0,this.renderOccludedMask=13,this.time=ie(0),this.bind=new Wn(t),this.bind.alignPixelEnabled=!0}},qn=class extends Vt{constructor(){super(...arguments),this._projectionMatrix=S()}get projectionMatrix(){return this._projectionMatrix}};T([s()],qn.prototype,`_projectionMatrix`,void 0),T([s({readOnly:!0})],qn.prototype,`projectionMatrix`,null),qn=T([x(`esri.views.3d.webgl-engine.lib.CascadeCamera`)],qn);var Jn=class{constructor(){this.camera=new qn,this.lightMat=S()}},Yn=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},Xn=class{constructor(e,t){this._fbos=e,this._viewingMode=t,this._snapshots=[],this._textureHeight=0,this._numCascades=1,this.settings=new Yn,this._projectionView=S(),this._projectionViewInverse=S(),this._modelViewLight=S(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=ve(),this._cascades=[new Jn,new Jn,new Jn,new Jn],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(Ve(`esri-mobile`)?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(_)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return Pe(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=ye(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=Te(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)ar[e]=this._cascades[e];return ar.length=this._numCascades,ar}start(e,t,n,r,i){k(this.enabled);let{near:a,far:o}=hr(n);this._computeCascadeDistances(a,o,r),this._textureHeight=this._computeTextureHeight(e,i,r),this._setupMatrices(e,t);let{viewMatrix:s,projectionMatrix:c}=e;for(let e=0;e<this._numCascades;++e)this._constructCascade(e,c,s,t);this._lastOrigin=null,this.clear()}finish(){k(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!Re(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||w(),v(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){ce(or,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)sr[16*t+e]=or[e]}}return sr}moveSnapshot(e){k(this.enabled),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle?.setName(e===0?`shadow map highlight`:`shadow map excluding highlight`),this._handle=null}copySnapshot(e){if(!this.enabled||!this._handle?.getTexture(33306)?.descriptor)return;this._snapshots[e]?.release();let t=e===0?`shadow map highlight`:`shadow map excluding highlight`,n=this._acquireFBO(t);this._snapshots[e]=n;let r=this._handle?.fbo;if(!r||!n?.fbo)return void console.error(`No FBO`);let{rctx:i}=this._fbos;i.blitFramebuffer(r,n.fbo,256)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture(_):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight({pixelRatio:e,fullWidth:t,fullHeight:n},r,i){let a=Math.min(window.devicePixelRatio,r)/e,o=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return on(Math.max(t,n)*a*o,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO(`shadow map`))}_acquireFBO(e){let t=this._fbos.acquire(this._textureWidth,this._textureHeight,e,12);return t.getTexture(_)?.setShadowFiltering(!0),t}_discardSnapshot(e){this._snapshots[e]=ye(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,n,r){let i=this._cascades[e],a=-this._cascadeDistances[e],o=-this._cascadeDistances[e+1],s=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),c=(t[10]*o+t[14])/Math.abs(t[11]*o+t[15]);k(s<c);for(let e=0;e<8;++e){Pe(Qn,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?s:c,1);let t=z[e];be(t,Qn,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}h(ir,z[0]),i.camera.viewMatrix=ce(Zn,this._modelViewLight,ir);for(let e=0;e<8;++e)Ce(z[e],z[e],i.camera.viewMatrix);let l=z[0][2],u=z[0][2];for(let e=1;e<8;++e)l=Math.min(l,z[e][2]),u=Math.max(u,z[e][2]);l-=200,u+=200,i.camera.near=-u,i.camera.far=-l,mr(n,r,l,u,i.camera),se(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);let d=this._textureHeight;i.camera.viewport=[e*d,0,d,d]}_setupMatrices(e,t){se(this._projectionView,e.projectionMatrix,e.viewMatrix),re(this._projectionViewInverse,this._projectionView);let n=this._viewingMode===1?e.eye:oe(ir,0,0,1);pe(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],n)}_computeCascadeDistances(e,t,n){let r=n?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(it(t/e,4)),r);let i=(t-e)/this._numCascades,a=(t/e)**(1/this._numCascades),o=e,s=e;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=Me(o,s,this.settings.splitSchemeLambda),o*=a,s+=i}get test(){}},Zn=S(),Qn=ve(),z=[];for(let e=0;e<8;++e)z.push(ve());var $n=b(),er=b(),tr=b(),nr=b(),rr=b(),ir=w(),ar=[],or=S(),sr=n.concat(n,n,n),B=b(),V=b(),H=[b(),b(),b(),b()],U=b(),cr=b(),W=b(),lr=b(),G=b(),K=b(),ur=b();function dr(e,t,n,i,a,o,s,l){r(B,0,0);for(let t=0;t<4;++t)c(B,B,e[t]);D(B,B,.25),r(V,0,0);for(let t=4;t<8;++t)c(V,V,e[t]);D(V,V,.25),Ne(H[0],e[4],e[5],.5),Ne(H[1],e[5],e[6],.5),Ne(H[2],e[6],e[7],.5),Ne(H[3],e[7],e[4],.5);let d=0,f=ke(H[0],B);for(let e=1;e<4;++e){let t=ke(H[e],B);t<f&&(f=t,d=e)}C(U,H[d],e[d+4]);let p=U[0],m,h;U[0]=-U[1],U[1]=p,C(cr,V,B),O(cr,U)<0&&je(U,U),Ne(U,U,cr,n),ae(U,U),m=h=O(C(W,e[0],B),U);for(let t=1;t<8;++t){let n=O(C(W,e[t],B),U);n<m?m=n:n>h&&(h=n)}u(i,B),D(W,U,m-t),c(i,i,W);let ee=-1,g=1,te=0,_=0;for(let t=0;t<8;++t){C(lr,e[t],i),ae(lr,lr);let n=U[0]*lr[1]-U[1]*lr[0];n>0?n>ee&&(ee=n,te=t):n<g&&(g=n,_=t)}A(ee>0,`leftArea`),A(g<0,`rightArea`),D(G,U,m),c(G,G,B),D(K,U,h),c(K,K,B),ur[0]=-U[1],ur[1]=U[0];let v=rt(i,e[_],K,c(W,K,ur),1,a),y=rt(i,e[te],K,W,1,o),ne=rt(i,e[te],G,c(W,G,ur),1,s),re=rt(i,e[_],G,W,1,l);A(v,`rayRay`),A(y,`rayRay`),A(ne,`rayRay`),A(re,`rayRay`)}function q(e,t){return 3*t+e}var fr=b();function J(e,t){return r(fr,e[t],e[t+3]),fr}var Y=b(),X=d();function pr(e,t,n,r,i){C(Y,n,r),D(Y,Y,.5),X[0]=Y[0],X[1]=Y[1],X[2]=0,X[3]=Y[1],X[4]=-Y[0],X[5]=0,X[6]=Y[0]*Y[0]+Y[1]*Y[1],X[7]=Y[0]*Y[1]-Y[1]*Y[0],X[8]=1,X[q(0,2)]=-O(J(X,0),e),X[q(1,2)]=-O(J(X,1),e);let a=O(J(X,0),n)+X[q(0,2)],o=O(J(X,1),n)+X[q(1,2)],s=O(J(X,0),r)+X[q(0,2)],c=O(J(X,1),r)+X[q(1,2)];a=-(a+s)/(o+c),X[q(0,0)]+=X[q(1,0)]*a,X[q(0,1)]+=X[q(1,1)]*a,X[q(0,2)]+=X[q(1,2)]*a,a=1/(O(J(X,0),n)+X[q(0,2)]),o=1/(O(J(X,1),n)+X[q(1,2)]),X[q(0,0)]*=a,X[q(0,1)]*=a,X[q(0,2)]*=a,X[q(1,0)]*=o,X[q(1,1)]*=o,X[q(1,2)]*=o,X[q(2,0)]=X[q(1,0)],X[q(2,1)]=X[q(1,1)],X[q(2,2)]=X[q(1,2)],X[q(1,2)]+=1,a=O(J(X,1),t)+X[q(1,2)],o=O(J(X,2),t)+X[q(2,2)],s=O(J(X,1),n)+X[q(1,2)],c=O(J(X,2),n)+X[q(2,2)],a=-.5*(a/o+s/c),X[q(1,0)]+=X[q(2,0)]*a,X[q(1,1)]+=X[q(2,1)]*a,X[q(1,2)]+=X[q(2,2)]*a,a=O(J(X,1),t)+X[q(1,2)],o=O(J(X,2),t)+X[q(2,2)],s=-o/a,X[q(1,0)]*=s,X[q(1,1)]*=s,X[q(1,2)]*=s,i[0]=X[0],i[1]=X[1],i[2]=0,i[3]=X[2],i[4]=X[3],i[5]=X[4],i[6]=0,i[7]=X[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=X[6],i[13]=X[7],i[14]=0,i[15]=X[8]}function mr(e,t,n,r,i){let a=1/z[0][3],o=1/z[4][3];k(a<o);let s=a+Math.sqrt(a*o),c=Math.sin(Fe(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));s/=c,dr(z,s,c,$n,er,tr,nr,rr),pr($n,er,nr,rr,i.projectionMatrix),i.projectionMatrix[10]=2/(n-r),i.projectionMatrix[14]=-(n+r)/(n-r)}function hr(e){let{near:t,far:n}=e;return t<2&&(t=2),n<2&&(n=2),t>=n&&(t=2,n=4),{near:t,far:n}}var gr=class extends P{constructor(){super(...arguments),this.shader=new F(Jt,()=>e(()=>import(`./TextureOnly.glsl-C5B-kH5x.js`),__vite__mapDeps([22,23,7,8,3,4,24,9,15,5,6])))}initializePipeline(e){return e.hasAlpha?M({blending:vt,colorWrite:j}):M({colorWrite:j})}};gr=T([x(`esri.views.3d.webgl-engine.lib.TextureTechnique`)],gr);var _r=class extends Ct{constructor(){super(...arguments),this.hasAlpha=!1}};T([N()],_r.prototype,`hasAlpha`,void 0);var vr=class extends P{constructor(){super(...arguments),this.shader=new F(cn,()=>e(()=>import(`./OverlayCompositing.glsl-XTdj7HNT.js`),__vite__mapDeps([25,26,3,4,14,9,11,15,5,6,7,8])))}};vr=T([x(`esri.views.3d.webgl-engine.shaders.OverlayCompositingTechnique`)],vr);var Z=class extends yn{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new ln,this.hasHighlights=!1,this.renderOccludedFlags=1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new Le,this._passParameters=new Yt,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new Vt,this.events=new Be,this.longitudeCyclical=null,this.produces=new Map([[19,e=>e!==8||this.hasHighlights],[20,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1,this._hasDrapedFlowSource=!1}initialize(){let e=this._view,t=e.stage,n=t.renderer.fboCache,{waterTextures:r,techniques:i}=t.renderView;this._renderContext=new Kn(this._rctx,new Xn(n,e.state.viewingMode),i),this.addHandles([E(()=>r.updating,()=>this.events.emit(`content-changed`),We),E(()=>this._spatialReference,e=>this._localOriginFactory=new Pt(e),We),ue(()=>e.allLayerViews,`after-changes`,()=>this._sortedDrapeSourceRenderersDirty=!0),E(()=>An(e.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,Ee),E(()=>e.state.highlights,t=>{this._bindParameters.highlights=t,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap},Ee),e.resourceController.scheduler.registerTask(he.OVERLAY_RENDERER,this)]);let a=this._camera;a.near=1,a.far=1e4,a.relativeElevation=null,this._bindParameters.slot=19,this._bindParameters.camera=a,this._bindParameters.updateLighting([new Ht(Se())],0,0,0)}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._passParameters.texture=De(this._passParameters.texture),this.disposeOverlays(),this._renderContext=null,this._sortedRenderers.prune()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get _spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){let t=new Pn(this._view.stage.renderView.textures,this._techniques,()=>{this._onMaterialOrContentChanged(),this.events.emit(`content-changed`),this.notifyChange(`updating`),this.notifyChange(`isEmpty`)},()=>this.events.emit(`content-changed`));this._pluginContext={...e,materials:t},this._techniques.precompile(vr)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||Ie(this._renderers,e=>e.updating||e.canCompact)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(e){for(let t of this._renderers.values()){let n=t.getMaterialRenderer(e);if(n)return n}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),le(this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e))}registerDrapeSource(e,t){this._renderers.get(e)?.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,`fullOpacity`in e&&this.addHandles(E(()=>e.fullOpacity,()=>this.events.emit(`content-changed`)),e)}removeDrapeSourceRenderer(e){if(e==null)return;let t=this._renderers.get(e);t!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(e){this._renderTargets?.dispose(e)}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&o(e,e=>e.drapeTargetType===1)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=o(e,e=>e.drapeSourceType===1),this._hasDrapedRasterSource=o(e,e=>e.drapeSourceType===0),this._hasDrapedFlowSource=o(e,e=>e.drapeSourceType===2)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=this._hasDrapedFlowSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,n=this._bindParameters.overlayStretch){this._overlays??=(this._renderTargets=new gn(this._stage.renderer.fboCache),[new pn,new pn]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=n}disposeOverlays(){this._overlays=null,this._renderTargets?.dispose(1),this._renderTargets=null,this.events.emit(`textures-disposed`)}_useOverlayColorInsteadOfColorNoRasterImage(e){return e===1&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource}getTexture(e){let t=this._useOverlayColorInsteadOfColorNoRasterImage(e);return this._renderTargets?.getTexture(t?0:e)}get readyToRun(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_onMaterialOrContentChanged(){this.renderOccludedFlags=Ie(this._renderers,e=>e.hasOccluders)?4:1}_processDrapeSources(e,t){let n=!1;for(let[r,i]of this._renderers){if(e.done)break;(r.destroyed||t(r))&&i.commitChanges()&&(n=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,n=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),n&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange(`updating`),this.notifyChange(`isEmpty`),this._onMaterialOrContentChanged(),this.hasHighlights=Ie(this._renderers,e=>e.hasHighlights),this.events.emit(`content-changed`))}compact(e){let t=!1;for(let n of this._renderers.values()){if(e.done)break;t=n.compact(e)||t}return t&&this.notifyChange(`updating`),t}hasHighlight(e){return Ie(this._renderers,t=>t.hasHighlight(e))}processSyncDrapeSources(){this._processDrapeSources(m,e=>e.updatePolicy===1)}get isEmpty(){return!Kt.OVERLAY_DRAW_DEBUG_TEXTURE&&we(this._renderers,e=>e.isEmpty)}get hasWater(){let e=Ie(this._renderers,({hasWater:e})=>e);return e!==this._hasWater&&(this._hasWater=e,this.events.emit(`has-water`)),this._hasWater}renders(e){if(Kt.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==4&&e!==2)return!0;if(!this._overlays)return!1;let t=this._overlays[0];for(let e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);if(!t.hasSomeSizedView())return!1;let n=this._setOutput(this._renderTargets?.targets.find(t=>t.content===e)?.output??0);++this._techniques.precompiling;let r=this._sortedRenderers.some(({renderer:e})=>e.precompile(this._renderContext));return--this._techniques.precompiling,this._setOutput(n),r}_setOutput(e){let t=this._renderContext.output;return this._renderContext.output=e,this._bindParameters.slot=e===2?20:19,t}get mode(){return this.isEmpty?0:this.hasWater&&this.renders(3)?2:this._renderTargets?.getTexture(0)?1:0}updateAnimation(e){let t=!1;return this._renderers.forEach(n=>t=n.updateAnimation(e)||t),t&&this.parent.requestRender(0),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return!1;let t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(let e of this._renderTargets.targets){if(e.content===1&&!this._needsColorWithoutRasterImage)continue;let{output:n}=e;this._setOutput(n),n===8&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null);let r=this._renderContext.renderOccludedMask;e.content===4&&(this._renderContext.renderOccludedMask=4),this._sortedRenderers.forAll(({drapeSource:t,renderer:n})=>{e.content===1&&t.drapeSourceType===0||e.content===4&&n.hasOnlyOccluders||n.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=r,t.highlightMixTexture=null}return--this._techniques.precompiling,!0}drawOverlays(e,t){if(!this._overlays||!this._renderTargets)return;for(let e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;let n=this.allSourcesOccluders;for(let e of this._renderTargets.targets){if(!(e.content===0&&this._hasDrapedFlowSource)&&!e.handleRenderRequest(t)||e.content===1&&!this._needsColorWithoutRasterImage||e.content===4&&n)continue;let r=this._drawTarget(0,e),i=this._drawTarget(1,e);(r||i)&&e.fbo.generateMipMap()}}_drawTarget(e,t){let n=this._overlays[e],r=n.canvasGeometries;if(r.numViews===0)return!1;let i=this._view.state.contentPixelRatio;this._screenToWorldRatio=i*n.mapUnitsPerPixel/this._bindParameters.overlayStretch;let{output:a,content:o}=t;if(this.isEmpty||a===2&&!this.hasWater||!n.hasSomeSizedView())return!1;let{_rctx:s,_camera:c,_renderContext:l,_bindParameters:u}=this;if(c.pixelRatio=n.pixelRatio*i,this._setOutput(a),u.screenToWorldRatio=this._screenToWorldRatio,u.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,o===4&&(l.renderOccludedMask=4),!this.renders(o))return l.renderOccludedMask=13,!1;let{resolution:d}=n,f=e===0,p=f?0:d;if(s.setViewport(p,0,d,d),this._bindTargetFBO(t),f&&(a===8?s.gl.clearBufferuiv(s.gl.COLOR,0,[0,0,0,0]):(s.setClearColor(0,0,0,0),s.clear(16384))),Kt.OVERLAY_DRAW_DEBUG_TEXTURE&&o!==4&&o!==2){this._techniques.precompile(gr,Sr);let t=this._techniques.get(gr,Sr);for(let i=0;i<r.numViews;i++)this._setViewParameters(r.extents[i],n),this._ensureDebugPatternResources(n.resolution,br[e]),s.bindTechnique(t,u,this._passParameters),s.screen.draw()}if(a===8){let{fboCache:n}=this._stage.renderer,r=this._resolution;this._bindTargetFBO(t),Mn(s,n,{width:r,height:r},u,()=>this._renderAllGeometry(e,t),p)}else this._renderAllGeometry(e,t);return s.bindFramebuffer(null),l.renderOccludedMask=13,!0}get allSourcesOccluders(){return we(this._renderers,e=>e.hasOnlyOccluders)}_renderAllGeometry(e,t){let n=this._overlays[e],r=n.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:i,renderer:a})=>{if(t.content===1&&i.drapeSourceType===0)return;let{fullOpacity:o}=i,s=o!=null&&o<1&&t.output===0&&this._bindTemporaryFBO();for(let e=0;e<r.numViews;e++)this._setViewParameters(r.extents[e],n),a.render(this._renderContext);if(s){this._bindTargetFBO(t),this._overlayParameters.texture=s.getTexture(),this._overlayParameters.opacity=o,this._overlayParameters.overlayIndex=e;let n=this._techniques.get(vr);this._rctx.bindTechnique(n,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),s.release()}})}_bindTargetFBO(e){let t=this._resolution,n=2*t;e.fbo.ensureFramebuffer(n,t),e.fbo.bind(this._rctx)}_bindTemporaryFBO(){let e=this._resolution,t=2*e,n=this._stage.renderer.fboCache,r=n.acquire(t,e,`overlay tmp`);return n.rctx.bindFramebuffer(r.fbo),n.rctx.clear(16384),r}get _resolution(){return this._overlays?.[0].resolution??0}notifyContentChanged(){this.events.emit(`content-changed`)}intersect(e,t,n,r){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let i=0;for(let{renderer:a}of this._sortedRenderers)i=a.intersect?.(e,t,n,r,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;let e=this._view.map.allLayers.map(e=>e.uid),t=e.length;this._renderers.forEach((n,r)=>{let i=e.indexOf(r.layer?.uid),a=i>=0,o=r.renderGroup??(a?0:1),s=r.drapeSourcePriorityOffset??0,c=t*o+(a?i:0)+s;this._sortedRenderers.push(new yr(r,n,c))}),this._sortedRenderers.sort((e,t)=>e.index-t.index)}_setViewParameters(e,t){let n=this._camera;n.viewport=[0,0,t.resolution,t.resolution],a(n.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],n.near,n.far),ge(n.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if(oe(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;let n=new Uint8Array(e*e*4),r=0;for(let t=0;t<e;t++)for(let i=0;i<e;i++){let a=Math.floor(i/10),o=Math.floor(t/10);a<2||o<2||10*a>e-20||10*o>e-20?(n[r++]=255,n[r++]=255,n[r++]=255,n[r++]=255):(n[r++]=255,n[r++]=255,n[r++]=255,n[r++]=1&a&&1&o?1&i^1&t?0:255:1&a^1&o?0:128)}let i=new Ye(e);i.samplingMode=9728,this._passParameters.texture=new Oe(this._rctx,i,n)}get test(){}};T([s()],Z.prototype,`hasHighlights`,void 0),T([s()],Z.prototype,`renderOccludedFlags`,void 0),T([s()],Z.prototype,`_sortedDrapeSourceRenderersDirty`,void 0),T([s({constructOnly:!0})],Z.prototype,`parent`,void 0),T([s({readOnly:!0})],Z.prototype,`_techniques`,null),T([s({type:Boolean,readOnly:!0})],Z.prototype,`updating`,null),T([s()],Z.prototype,`isEmpty`,null),Z=T([x(`esri.views.3d.terrain.OverlayRenderer`)],Z);var yr=class{constructor(e,t,n){this.drapeSource=e,this.renderer=t,this.index=n}},br=[[1,.5,.5],[.5,.5,1]],xr=-2,Sr=new _r;Sr.hasAlpha=!0;var Cr=class{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=S(),this._shaderTransformation=null,this._boundingSphere=null,this.id=Ze(),this.layerViewUid=t.layerViewUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){de(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??=S(),se(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere??(this._boundingSphere??=new pt,Ce(this._boundingSphere.center,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere.radius=this.boundingInfo.radius*tt(this.shaderTransformation)),this._boundingSphere):ft}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get positionAttribute(){return this.geometry.positionAttribute}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}},wr=class extends bt{intersect(e,t,n,r,i,a){return kt(e,n,r,i,void 0,a)}intersectDraped(e,t,n,r){return Dt(n[0],n[1],e,r)}},Tr=class extends P{constructor(t,n){super(t,n,Dr(n).locations),this.shader=new F(un,()=>e(()=>import(`./ColorMaterial.glsl-DI0NBGuB.js`),__vite__mapDeps([27,28,29,7,8,30,9,31,4,5,32,33,34,35,36,12,37,24,38,39,40,41,42,43,44,45,46,47,14,18,15,6])))}_createPipeline(e,t){let{oitPass:n,output:r,hasEmission:i,transparent:a,cullFace:o,draped:s,hasOccludees:c,polygonOffset:l}=e,u=n===0;return M({blending:lt(r)&&a?Tt(n):null,culling:_t(o),depthTest:s?null:xt(n),depthWrite:yt(e),drawBuffers:Rt(r,Et(n,i)),colorWrite:j,stencilWrite:c?Mt:null,stencilTest:c?t?At:Ot:null,polygonOffset:u?l?Er:null:Nt(e)})}initializePipeline(e){return this._occludeePipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}getPipeline(e,t){return t?this._occludeePipelineState:super.getPipeline(e)}};Tr=T([x(`esri.views.3d.webgl-engine.shaders.ColorMaterialTechnique`)],Tr);var Er={factor:1,units:1};function Dr(e){let t=I().vec3f(`position`);return Gt()&&t.vec4u8(`olidColor`),e.hasVVColor?t.f32(`colorFeatureAttribute`):t.vec4u8(`color`),t.freeze()}var Q=class extends wt{constructor(){super(...arguments),this.cullFace=0,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasVVColor=!1,this.draped=!1,this.textureCoordinateType=0,this.emissionSource=0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.hasVVInstancing=!1,this.hasVVSize=!1,this.hasVVOpacity=!1,this.snowCover=!1}};T([N({count:3})],Q.prototype,`cullFace`,void 0),T([N()],Q.prototype,`hasVertexColors`,void 0),T([N()],Q.prototype,`transparent`,void 0),T([N()],Q.prototype,`discardInvisibleFragments`,void 0),T([N()],Q.prototype,`polygonOffset`,void 0),T([N()],Q.prototype,`enableOffset`,void 0),T([N()],Q.prototype,`writeDepth`,void 0),T([N()],Q.prototype,`hasOccludees`,void 0),T([N()],Q.prototype,`terrainDepthTest`,void 0),T([N()],Q.prototype,`cullAboveTerrain`,void 0),T([N()],Q.prototype,`hasVVColor`,void 0),T([N()],Q.prototype,`draped`,void 0);var Or=class extends wr{constructor(e){super(e,Ar),this._configuration=new Q,this.supportsEdges=!0,this.produces=new Map([[2,e=>this._isOpaqueMaterialPass(e)],[3,e=>this._isOpaqueNoSSAODepthPass(e)],[4,e=>ot(e)&&this._transparent&&this.parameters.writeDepth],[5,e=>at(e)&&this._transparent&&this.parameters.writeDepth],[9,e=>ot(e)&&this._transparent&&!this.parameters.writeDepth],[19,e=>st(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(e)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=t.hasOccludees,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.enableOffset,this._configuration.terrainDepthTest=t.terrainDepthTest&&lt(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=an}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(e){return this._isOpaqueMaterialPass(e)||this._isOpaqueNoSSAODepthPass(e)}_isOpaqueMaterialPass(e){return e===8||ot(e)&&!this._transparent}_isOpaqueNoSSAODepthPass(e){return at(e)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(e){return new kr(e)}createBufferWriter(){return new jt(Dr(this.parameters))}},kr=class extends ct{beginSlot(e){return this.getTechnique(Tr,e)}},Ar=class extends qt{constructor(){super(...arguments),this.color=g,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.draped=!1,this.discardInvisibleFragments=!1}},$={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},jr={dash:$.dash,"dash-dot":[...$.dash,...$.dot],dot:$.dot,"long-dash":$[`long-dash`],"long-dash-dot":[...$[`long-dash`],...$.dot],"long-dash-dot-dot":[...$[`long-dash`],...$.dot,...$.dot],none:null,"short-dash":$[`short-dash`],"short-dash-dot":[...$[`short-dash`],...$[`short-dot`]],"short-dash-dot-dot":[...$[`short-dash`],...$[`short-dot`],...$[`short-dot`]],"short-dot":$[`short-dot`],solid:null},Mr=8;function Nr(e,t){return e==null?e:{pattern:e.slice(),pixelRatio:t}}function Pr(e){return{pattern:[e,e],pixelRatio:2}}function Fr(e){return e?.type===`style`?Ir(e.style):null}function Ir(e){return e==null?null:Nr(jr[e],Mr)}function Lr(e,t,n,r){let i=e.type===`polygon`?1:0,a=e.type===`polygon`?e.rings:e.paths,{position:o,outlines:s}=nt(a,!!e.hasZ,i,e.spatialReference),c=ne(o.length),l=Ft(o,e.spatialReference,0,c,0,o,0,o.length/3,t,n,r),u=l!=null;return{lines:u?zr(s,o,c):[],projectionSuccess:u,sampledElevation:l}}function Rr(e,t){let n=e.type===`polygon`?1:0,r=e.type===`polygon`?e.rings:e.paths,{position:i,outlines:a}=nt(r,!1,n),o=p(i,e.spatialReference,0,i,t,0);for(let e=2;e<i.length;e+=3)i[e]=-2;return{lines:o?zr(a,i):[],projectionSuccess:o}}function zr(e,t,n=null){let r=[];for(let{index:i,count:a}of e){if(a<=1)continue;let e=3*i,o=3*a;r.push({position:f(t,3*i,3*a),mapPositions:n==null?void 0:f(n,e,o)})}return r}var Br=I().vec3f(`position`).freeze(),Vr=I().vec3f(`position`).vec2f16(`uv0`).freeze(),Hr=I().vec3f(`position`).vec4u8(`color`).freeze(),Ur=I().vec3f(`position`).vec2f(`uv0`).freeze(),Wr=I().vec3f(`position`).vec2f(`uv0`).vec4u8(`olidColor`).freeze();Wt(I().u16(`componentIndex`,{integer:!0}));var Gr=[{name:`colorAndCastShadows`,type:`vec4u8`},{name:`elevationOffset`,type:`f32`},{name:`emissiveStrength`,type:`f16`},{name:`emissiveSourceMode`,type:`u8`}],Kr={name:`olidColor`,type:`vec4u8`};new dn(Gr),new dn([...Gr,Kr]);export{Ur as a,Pr as c,wr as d,Cr as f,fn as h,Hr as i,Fr as l,bn as m,Br as n,Rr as o,xr as p,Vr as r,Lr as s,Wr as t,Or as u};