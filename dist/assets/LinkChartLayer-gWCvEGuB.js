import{$T as e,A as t,BT as n,CE as r,CT as i,Ex as a,L as o,Li as s,Rh as c,Ua as l,VT as u,Wv as d,cv as f,hv as p,kD as m,mT as h,oT as g,pT as _,pv as v,ua as y,vE as b,vx as x,zv as S}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import{a as C}from"./featureConversionUtils-o9-cJXzl.js";import"./WhereClause-CATd9kVz.js";import"./closestPointOnCurve-CwZL45U3.js";import"./Relationship-CyGEtlAI.js";import"./GraphQueryStreaming-DUkFf9hi.js";import"./WhereClauseCache-BO4WYMj9.js";import"./PooledRBush-BH7_Gu1G.js";import"./QueryEngineCapabilities-CxeEdoTy.js";import"./clientSideDefaults-Iizf0eUh.js";import"./generateRendererUtils-DGV_dTnd.js";import"./utils-DCGMUq-q.js";import"./cimSymbolUtils-CLt57XQ8.js";import"./utils-BGjabRH0.js";import{_ as w,a as T,c as ee,d as te,f as ne,g as E,h as re,i as D,l as O,m as k,n as A,o as j,p as M,r as N,s as P,t as F,u as I}from"./KnowledgeGraphSublayer-CS9ztNyM.js";import{M as L}from"./knowledgeGraphService-IHR0Dm6J.js";import{a as ie,i as R,n as z,o as B,r as V}from"./constants-nHW_AykQ.js";import"./GraphicsLayer-DBcl42yN.js";import"./networkEnums-DSwvS-2R.js";import"./GPMessage-BiUuPRZS.js";import"./BoundsStore-DE7p6f_c.js";import"./timeSupport-vK4lVcYW.js";import"./optimizedFeatureQueryEngineAdapter-DQyaY_b1.js";import"./FeatureStore-DxVA8hqB.js";import"./QueryEngine-CD8WljsT.js";import"./queryUtils-DGU5ISbw.js";import"./utils-Bftaersa.js";import"./utils-BizEctJo.js";import"./SnappingCandidate-4DPnOY6Y.js";import"./FixedIntervalBinParameters-CMgMaWGN.js";var H={MULTIPLIER:`multiplier`,ABSOLUTE:`absolute-value`},U=class extends o(y(t(l(c)))){constructor(t){if(super(t),this.url=null,this.dataPreloadedInLocalCache=!1,this.initializationLinkChartConfig=null,this.membershipModified=!0,this._currentLinkChartConfig={layoutMode:`organic-standard`},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new(p.ofType(F)),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new x({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType=`LinkChartLayer`,this.sublayerIdsCache=new Map,this.tables=new(p.ofType(F)),this.type=`link-chart`,this.userHasEditingPrivileges=!0,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1,this.chronologicalAuxiliaryGraphics=null,this._originalInclusionList=t?.initializationInclusionModeDefinition,t?.dataPreloadedInLocalCache&&!t?.initializationInclusionModeDefinition)throw new e(`knowledge-graph:linkchart-layer-constructor`,`If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it`);this.addHandles(v(()=>this.layers.concat(this.tables),(e,t)=>this._handleSublayersChange(e,t),f))}normalizeCtorArgs(e){if(!e)return{};let{url:t,title:n,dataPreloadedInLocalCache:r,initializationLinkChartConfig:i}=e;return{url:t,title:n,dataPreloadedInLocalCache:r,initializationLinkChartConfig:i}}_initializeLayerProperties(t){if(!this.title&&this.url){let e=this.url.split(`/`);this.title=e[e.length-2]}let n=new Set,i=[],a=[];if(t.inclusionModeDefinition&&(!t.inclusionModeDefinition.namedTypeDefinitions||t.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new e(`knowledge-graph:composite-layer-constructor`,`If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined`);t.inclusionModeDefinition?.generateAllSublayers?(i=t.knowledgeGraph.dataModel.entityTypes??[],a=t.knowledgeGraph.dataModel.relationshipTypes??[]):t.inclusionModeDefinition?.namedTypeDefinitions&&t.inclusionModeDefinition?.namedTypeDefinitions.size>0?t.inclusionModeDefinition?.namedTypeDefinitions.forEach((e,o)=>{let s=this._graphTypeLookup.get(o);if(!s)return r.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't in the data model and will be removed`),void t.inclusionModeDefinition?.namedTypeDefinitions.delete(o);s.type===`relationship`?n.has(o)||(n.add(o),a.push(s)):s.type===`entity`?n.has(o)||(n.add(o),i.push(s)):(r.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't properly modeled and will be removed`),t.inclusionModeDefinition?.namedTypeDefinitions.delete(o))}):(i=t.knowledgeGraph.dataModel.entityTypes??[],a=t.knowledgeGraph.dataModel.relationshipTypes??[]);let o=new T({knowledgeGraph:t.knowledgeGraph,inclusionModeDefinition:t.inclusionModeDefinition});this.knowledgeGraph=t.knowledgeGraph,this.memberEntityTypes=i,this.memberRelationshipTypes=a,this.dataManager=o}load(e){let t=async()=>{let e=[],t=[];this.loadLayerAssumingLocalCache(),this._layersLoadedFromAuthoritativeItem()||await A(this),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(e=>{e.useAllData=!1}),await this._initializeDiagram(),this.layers.forEach(n=>{t.push(n.refreshCachedQueryEngine()),e.push(new Promise(e=>{n.on(`layerview-create`,()=>{e(null)})}))}),this.tables.forEach(e=>{t.push(e.refreshCachedQueryEngine())}),await Promise.all(t)};return this.addResolvingPromise(new Promise(n=>{L(this.url).then(async r=>{r.dataModel.entityTypes?.forEach(e=>{e.name&&this._graphTypeLookup.set(e.name,e)}),r.dataModel.relationshipTypes?.forEach(e=>{e.name&&this._graphTypeLookup.set(e.name,e)});let i=this.linkChart?.linkChartProperties;i?.originIdOf(`entitiesUrl`)===6&&(this.membershipModified=!1,this._originalInclusionList=await w.fetchAndConvertSerializedLinkChart({entitiesUrl:i?.entitiesUrl,relationshipsUrl:i?.relationshipsUrl},{signal:e?.signal}),this._alignLayersDataModelAndInclusionDefinition(r.dataModel),this.initializationLinkChartConfig={layoutSettings:i?.layoutSettings??void 0,layoutMode:j(i.layoutType)}),this._initializeLayerProperties({knowledgeGraph:r,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0})}));let{edit:a,fullEdit:o,updateItem:s}=await N(r.serviceDefinition.serviceItemId,this.url,e);if(this._set(`userHasEditingPrivileges`,a),this._set(`userHasFullEditingPrivileges`,o),this._set(`userHasUpdateItemPrivileges`,s),this.dataPreloadedInLocalCache){let e=E.getInstance();for(let[t,n]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions??[])for(let r of n.members?.values()??[]){let n=e.readFromStoreById(`${t}__${r.id}`);n&&b(this.dataManager.sublayerCaches,t,()=>new Map).set(r.id,n)}await t()}else{let n=this.initializationLinkChartConfig?.layoutMode===`geographic-organic-standard`;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,n,!0).then(async()=>{_(e),await t()}))}n(null)})})),Promise.resolve(this)}set initializationInclusionModeDefinition(e){this.loadStatus!==`loaded`&&this.loadStatus!==`failed`?this._set(`initializationInclusionModeDefinition`,e):r.getLogger(this).error(`#initializationInclusionModeDefinition`,`initializationInclusionModeDefinition cannot be changed after the layer is loaded.`)}get linkChart(){return this.parent}get sublayerCapabilities(){return D(this.knowledgeGraph)}async addRecords(e,t){let n=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(n=await P(e,this.dataManager.knowledgeGraph));let r=e.concat(n).filter(e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id));r.length>0&&(this.membershipModified=!0),await this._handleNewRecords(r,t)}async createSublayerForNamedType(t){await this.load();let n=this._graphTypeLookup.get(t);if(!n)throw new e(`knowledge-graph:missing-type`,`The specified type does not exist in the knowledge graph.`);if(this.dataManager.sublayerCaches.has(t))throw new e(`knowledge-graph:duplicate-type`,`The specified type already exists as a sublayer.`);this.dataManager.sublayerCaches.set(t,new Map),b(this.sublayerIdsCache,t,()=>new Set);let r=this._createSublayer(n);return n.type===`entity`?this.dataManager.entityTypeNames.add(t):this.dataManager.relationshipTypeNames.add(t),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.set(t,{useAllData:!1,members:new Map}),r.geometryType?this.layers.push(r):this.tables.push(r),await A(this,[t]),this._refreshNamedTypes(),r}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:n=!1,overrideMembershipCheck:r=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1,overrideMembershipCheck:!1}){let i=[];for(let t of e)(r||!1===this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.useAllData&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.members?.has(t.id))&&i.push(t);if(t){let e=new Set,t=[];for(let t of i)if(this.dataManager.nodeConnectionsLookup.has(t.id))for(let n of this.dataManager.nodeConnectionsLookup.get(t.id))e.add(n);for(let n of e)if(this.dataManager.memberIdTypeLookup.has(n))for(let e of this.dataManager.memberIdTypeLookup.get(n))this.dataManager.relationshipTypeNames.has(e)&&t.push({id:n,typeName:e});i=i.concat(t)}this.dataManager.removeFromLayer(i);for(let e of i)this.sublayerIdsCache.get(e.typeName)?.delete(e.id),this.dataManager.relationshipTypeNames.has(e.typeName)?this.relationshipLinkChartDiagramLookup.delete(e.id):this.entityLinkChartDiagramLookup.delete(e.id);let a=n?void 0:this.getCurrentNodeLocations();await this._calculateLayoutWithSublayerTimeInfo(this._currentLinkChartConfig.layoutMode,{layoutSettings:this._currentLinkChartConfig.layoutSettings,lockedNodeLocations:a}),i.length>0&&(this.membershipModified=!0);let o=[];return this.layers.forEach(e=>{o.push(e.refreshCachedQueryEngine())}),await Promise.all(o),this._refreshNamedTypes(),i}async expand(e,t){let n=[];try{let r=await this.dataManager.getConnectedRecordIds(e,t?.relationshipTypeNames,t);n=r.filter(e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)),await this._handleNewRecords(n,t),r.length>0&&(this.membershipModified=!0),_(t?.signal)}catch(e){throw g(e)&&n.length>0&&await this.removeRecords(n,{overrideMembershipCheck:!0}),e}return{records:n}}loadLayerAssumingLocalCache(){let e=[...this.memberRelationshipTypes,...this.memberEntityTypes];this.layers.length||this.originIdOf(`tables`)===0?this.originIdOf(`layers`)===0?this._createSublayers(e,this.layers,e=>!!e.geometryType):this._updateSublayers(e,this.layers):this.layers=new p,this.tables.length||this.originIdOf(`layers`)===0?this.originIdOf(`tables`)===0?this._createSublayers(e,this.tables,e=>!e.geometryType):this._updateSublayers(e,this.tables):this.tables=new p,this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{let n=b(this.sublayerIdsCache,t,()=>new Set);e.members?.forEach(({id:e,linkChartLocation:r})=>{if(n.add(e),r){let n=`coords`in r&&`lengths`in r?r:C(r);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e,n):this.entityLinkChartDiagramLookup.set(e,n)}})})}async calculateLinkChartLayout(t=`organic-standard`,n){let i=[],o=[],s=[];this.dataManager.sublayerCaches.forEach((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach(e=>{i.push({typeName:t,feature:e})}):this.dataManager.relationshipTypeNames.has(t)&&e.forEach(e=>{o.push({typeName:t,feature:e})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;let c=new Map,l=new Map,u=new Map,f=new Map,p=new Uint8Array(i.length),m=new Float64Array(i.length),g=new Float64Array(i.length),v=new Float64Array(i.length),y=new Float64Array(i.length),w=new Uint32Array(o.length),T=new Uint32Array(o.length),E=new Float64Array(o.length),D=new Float64Array(o.length),A=[],j=!1,N=new x({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),P,F=`organic-standard`,L=0,H=0,U=te.apply;switch(F=t===`geographic-organic-standard`?`organic-standard`:t,F){case`organic-standard`:P=k.apply;break;case`organic-community`:P=M.apply;break;case`hierarchical-bottom-to-top`:P=I.apply;break;case`radial-root-centric`:P=O.apply;break;case`tree-left-to-right`:P=ne.apply;break;default:P=ee.apply}let W=!1;i.forEach(({typeName:e,feature:r})=>{if(t!==`chronological-mono-timeline`&&t!==`chronological-multi-timeline`&&n?.lockedNodeLocations?.has(r.attributes.ESRI__ID)){t===`geographic-organic-standard`&&this.dataManager.geographicLookup.has(e)?p[L]=2:p[L]=0;let i=n.lockedNodeLocations.get(r.attributes[R]);m[L]=i.x,g[L]=i.y}else if(t===`geographic-organic-standard`&&this.dataManager.geographicLookup.has(e)){p[L]=2;let t=null,n=r.attributes[this.dataManager.geographicLookup.get(e).name];switch(this.dataManager.geographicLookup.get(e)?.geometryType){case`esriGeometryPoint`:m[L]=n?.x,g[L]=n?.y;break;case`esriGeometryPolygon`:{let e=d(n);t=e?a.fromJSON(e):null,t?.x!=null&&t?.y!=null?(m[L]=t.x,g[L]=t.y):p[L]=1;break}case`esriGeometryPolyline`:case`esriGeometryMultipoint`:t=n?.extent?.center,t?.x!=null&&t?.y!=null?(m[L]=t.x,g[L]=t.y):p[L]=1;break;default:p[L]=1}(m[L]==null||g[L]==null||Number.isNaN(m[L])||Number.isNaN(g[L]))&&(p[L]=1,m[L]=0,g[L]=0)}else if(t===`chronological-mono-timeline`||t===`chronological-multi-timeline`){!W&&n?.lockedNodeLocations?.has(r.attributes.ESRI__ID)&&(W=!0);let t=n?.timeInfoByTypeName?.get(e),i=t?.startField,a=i&&t?.startField?r.attributes[i]:null;v[L]=a?new Date(a).getTime():NaN;let o=t?.endField,s=o&&t?.endField?r.attributes[o]:null;y[L]=s?new Date(s).getTime():NaN,m[L]=0,g[L]=0,p[L]=1}else p[L]=1,m[L]=0,g[L]=0;f.set(r.attributes[R],L),A[L]={feature:r,typeName:e},L++}),W&&r.getLogger(this).warn(`Locked node locations are not supported for chronological layout at this time.  Requested node locations were ignored`);let G=!1,K=new Map;o.forEach(e=>{let r=e.feature.attributes[z],i=e.feature.attributes[B],a=f.get(r),o=f.get(i),c=n?.timeInfoByTypeName?.get(e.typeName),l=n?.timeInfoByTypeName?c?.startField:null,u=l?e.feature.attributes[l]:null,d=c?.endField,p=d?e.feature.attributes[d]:null;if(a!==void 0&&o!==void 0){let n=r+`-`+i;t!==`chronological-mono-timeline`&&t!==`chronological-multi-timeline`||(n=n+`-`+u+`-`+p);let c=K.get(n);c?.has(e.typeName)||(w[H]=a,T[H]=o,t!==`chronological-mono-timeline`&&t!==`chronological-multi-timeline`||(E[H]=u?new Date(u).getTime():NaN,D[H]=p?new Date(p).getTime():NaN),c===void 0?K.set(n,new Map([[e.typeName,H]])):c.set(e.typeName,H),H++),s.push(e)}else G=!0,this.relationshipLinkChartDiagramLookup.set(r,null)}),G&&r.getLogger(this).warn(`A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null`);let ae=this._validateOrganicLayoutSettings(t,n?.layoutSettings?.organicLayoutSettings),q=this._convertValidatedOrganicSettingsToCalculationSettings(ae);await re();let J=1,Y=null;if(t===`chronological-mono-timeline`||t===`chronological-multi-timeline`){let e;({status:J,links:Y,graphics:e}=U(()=>n?.signal?.aborted??!1,p,m,g,v,y,w.subarray(0,H),T.subarray(0,H),E.subarray(0,H),D.subarray(0,H),t===`chronological-multi-timeline`,n?.layoutSettings?.chronologicalLayoutSettings)),J===0&&(this.chronologicalAuxiliaryGraphics=e)}else ({status:J,links:Y}=P(()=>n?.signal?.aborted??!1,p,m,g,w.subarray(0,H),T.subarray(0,H),q.computationBudgetTime,q.idealEdgeLengthMultiplier,q.repulsionRadiusMultiplier));if(_(n?.signal),J===1)throw new e(`knowledge-graph:layout-failed`,`Attempting to arrange the records in the specified layout failed`);if(J===2)throw h();for(let e=0;e<A.length;e++){if(g[e]>84.9999?g[e]=84.9999:g[e]<-84.9999&&(g[e]=-84.9999),m[e]>179.9999?m[e]=179.9999:m[e]<-179.9999&&(m[e]=-179.9999),A[e].feature.attributes.ESRI__LayoutGeometry=new a(m[e],g[e]),c.has(A[e].typeName))c.get(A[e].typeName)?.set(A[e].feature.attributes[R],A[e].feature);else{let t=new Map;t.set(A[e].feature.attributes[R],A[e].feature),c.set(A[e].typeName,t)}u.set(A[e].feature.attributes[R],A[e].feature);let t=C(A[e].feature.attributes[V]);this.entityLinkChartDiagramLookup.set(A[e].feature.attributes[R],A[e].feature.attributes.ESRI__LayoutGeometry?t:null);let n=b(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,A[e].typeName,()=>({useAllData:!1,members:new Map}));b(n.members,A[e].feature.attributes[R],()=>({id:A[e].feature.attributes[R],linkChartLocation:void 0})).linkChartLocation=A[e].feature.attributes[V];let{x:r,y:i}=A[e].feature.attributes[V];if(j)N.xmin=Math.min(N.xmin,r),N.xmax=Math.max(N.xmax,r),N.ymin=Math.min(N.ymin,i),N.ymax=Math.max(N.ymax,i);else{let e=1e-7;N.xmin=r-e,N.xmax=r+e,N.ymin=i-e,N.ymax=i+e,j=!0}}if(this.linkChartExtent.xmin=N.xmin,this.linkChartExtent.xmax=N.xmax,this.linkChartExtent.ymin=N.ymin,this.linkChartExtent.ymax=N.ymax,!Y)throw new e(`knowledge-graph:layout-failed`,`Attempting to retrieve link geometry from diagram engine failed`);let X=new Map,Z=new Map,Q=new Map,$=new Set;for(let e=0;e<s.length;e++){let i=[],a=s[e],o=a.feature.attributes[z],c=a.feature.attributes[B],d=o+`-`+c;if(t===`chronological-mono-timeline`||t===`chronological-multi-timeline`){let e=n?.timeInfoByTypeName?.get(a.typeName),t=n?.timeInfoByTypeName?e?.startField:null,r=t?a.feature.attributes[t]:null,i=e?.endField;d+=`-`+r+`-`+(i?a.feature.attributes[i]:null)}let p=K.get(d).get(a.typeName),m=p===0?0:Y?.vertexEndIndex[p-1];if(!$.has(p)){if($.add(p),Y.types[p]===2){let e=[Y.vertices[2*m],Y.vertices[2*m+1]],t=[Y.vertices[2*(m+1)],Y.vertices[2*(m+1)+1]],n=[.5*(e[0]+t[0]),.5*(e[1]+t[1])],r=[n[0]-e[0],n[1]-e[1]],a=[n[0]+r[1],n[1]-r[0]],o=[n[0]-r[1],n[1]+r[0]];i.push(e),i.push(a),i.push(t),i.push(o),i.push(e)}else{if(Y.types[p]!==0){r.getLogger(this).warn(`A relationship generated an unsupported link geometry type.  It will not be rendered`);continue}for(let e=m;e<Y.vertexEndIndex[p];e++)i.push([Y.vertices[2*e],Y.vertices[2*e+1]])}if(t!==`chronological-mono-timeline`&&t!==`chronological-multi-timeline`){let e=A[f.get(o)]?.feature.attributes[V],t=A[f.get(c)]?.feature.attributes[V];i[0][0]===e.x&&i[0][1]===e.y||(i[0]=[e.x,e.y]),i[i.length-1][0]===t.x&&i[i.length-1][1]===t.y||(i[i.length-1]=[t.x,t.y])}for(let e=1;e<i.length-1;e++)i[e][1]>85.5?i[e][1]=85.5:i[e][1]<-85.5&&(i[e][1]=-85.5),i[e][0]>179.9999?i[e][0]=179.9999:i[e][0]<-179.9999&&(i[e][0]=-179.9999);X.has(d)?X.get(d).push(i):X.set(d,[i])}let h=X.get(d);Z.has(d)||(Z.set(d,new Map),Q.set(d,new Map));let g=Z.get(d),_=Q.get(d);g.has(a.typeName)||(g.set(a.typeName,h.shift()),_.set(a.typeName,0));let v=g.get(a.typeName);_.set(a.typeName,_.get(a.typeName)+1);let y=new S({paths:[v]});if(a.feature.attributes.ESRI__LayoutGeometry=y,l.has(a.typeName))l.get(a.typeName)?.set(a.feature.attributes[R],a.feature);else{let e=new Map;e.set(a.feature.attributes[R],a.feature),l.set(a.typeName,e)}u.set(a.feature.attributes[R],a.feature);let x=C(a.feature.attributes[V]);this.relationshipLinkChartDiagramLookup.set(a.feature.attributes[R],a.feature.attributes.ESRI__LayoutGeometry?x:null);let w=b(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,a.typeName,()=>({useAllData:!1,members:new Map}));b(w.members,a.feature.attributes[R],()=>({id:a.feature.attributes[R],linkChartLocation:void 0})).linkChartLocation=x}for(let e of s)e.feature.attributes[ie]=Q.get(e.feature.attributes.ESRI__OriginID+`-`+e.feature.attributes.ESRI__DestID)?.get(e.typeName)??null;return this._currentLinkChartConfig={layoutMode:t,layoutSettings:n?.layoutSettings?.clone()},{nodes:c,links:l,idMap:u}}async applyNewLinkChartLayout(e=`organic-standard`,t){let n=[];await this._calculateLayoutWithSublayerTimeInfo(e,t),this.layers.forEach(e=>{n.push(e.refreshCachedQueryEngine())}),this.membershipModified=!0,await Promise.all(n),this._refreshNamedTypes()}getCurrentNodeLocations(){let e=new Map;for(let[t,n]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.entries()??[])this.dataManager.relationshipTypeNames.has(t)||n?.members?.forEach(t=>{let n=t.linkChartLocation,r,i=t.id;n&&(r=`x`in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]},e.set(i,new a({x:r.x,y:r.y})))});return e}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);let t=[];this.layers.forEach(e=>{t.push(e.refreshCachedQueryEngine())}),await Promise.all(t),this._refreshNamedTypes()}async connectBetweenEntities(e,t){if(!e.length)return{records:[]};let n=[];try{let r=[];for(let e of this.dataManager.relationshipTypeNames){let t=this.sublayerIdsCache.get(e);t&&(r=r.concat(Array.from(t.keys())))}n=await this.dataManager.getRelationshipsBetweenNodes(e,r,t),await this._handleNewRecords(n,t),_(t)}catch(e){throw g(e)&&this.removeRecords(n),e}return{records:n}}async connectFromEntities(e,t){if(!e.length)return{records:[]};let n=[];try{let r=[];for(let e of this.dataManager.relationshipTypeNames){let t=this.sublayerIdsCache.get(e);t&&(r=r.concat(Array.from(t.keys())))}let i=[];for(let e of this.dataManager.entityTypeNames){let t=this.sublayerIdsCache.get(e);t&&(i=i.concat(Array.from(t)))}n=await this.dataManager.getRelationshipsFromNodes(e,i,r,t),await this._handleNewRecords(n,t),n.length>0&&(this.membershipModified=!0),_(t)}catch(e){throw g(e)&&this.removeRecords(n),e}return{records:n}}getCurrentLayout(){return this._currentLinkChartConfig.layoutMode}async _calculateLayoutWithSublayerTimeInfo(e=`organic-standard`,t){let n=new Map;this.layers.forEach(e=>{n.set(e.objectType.name,e.timeInfo)}),await this.calculateLinkChartLayout(e,{timeInfoByTypeName:n,...t}),this.linkChart?.handleChronologicalOverlay()}async _handleNewRecords(e,t){let n=new Set,r=[],i=this.layers.concat(this.tables);for(let t of e){if(!this._graphTypeLookup.has(t.typeName))continue;!1===i.some(e=>e.objectType.name===t.typeName)&&(this.dataManager.sublayerCaches.set(t.typeName,new Map),n.add(t.typeName)),b(this.sublayerIdsCache,t.typeName,()=>new Set).add(t.id),r.push(t)}this.dataManager.addToLayer(r);for(let e of n){let t=this._graphTypeLookup.get(e);if(t){let n=this._createSublayer(t);t.type===`entity`?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e),n.geometryType?this.layers.push(n):this.tables.push(n)}}await A(this,Array.from(n),t),await this.dataManager.refreshCacheContent(e.map(e=>e.id),void 0,void 0,void 0,t);let o={layoutSettings:this._currentLinkChartConfig.layoutSettings,lockedNodeLocations:new Map};for(let[e,t]of this.entityLinkChartDiagramLookup.entries())t&&o.lockedNodeLocations.set(e,new a(t.coords[0],t.coords[1]));await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,o)}_createSublayers(e,t,n){e.forEach(e=>{let r=this._createSublayer(e);n(r)&&t.push(r),this._updateSublayerCaches(e)})}_updateSublayers(e,t){t.forEach(t=>{t.parentCompositeLayer=this;let n=e.find(e=>e.type===t.graphType&&e.name===t.graphTypeName);n&&(t.objectType=n,t.read({title:n.name},{origin:`service`}),this._updateSublayerCaches(n))})}_updateSublayerCaches({name:e}){if(!e)return;let t=this.dataManager.sublayerCaches;t.has(e)||t.set(e,new Map)}_layersLoadedFromAuthoritativeItem(){let e=this.originIdOf(`layers`);return e>=3&&e<7}async _initializeDiagram(){this.initializationLinkChartConfig?this.initializationLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{e?.members?.forEach(e=>{let n=e.linkChartLocation,r,i=e.id;if(!n)return;r=`x`in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]};let a=C(r);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(i,a):this.entityLinkChartDiagramLookup.set(i,a),this.linkChartExtent.xmin>r.x&&(this.linkChartExtent.xmin=r.x),this.linkChartExtent.xmax<r.x&&(this.linkChartExtent.xmax=r.x),this.linkChartExtent.ymin>r.y&&(this.linkChartExtent.ymin=r.y),this.linkChartExtent.ymax<r.y&&(this.linkChartExtent.ymax=r.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(e=>{let t=this.relationshipLinkChartDiagramLookup.get(e.attributes.ESRI__OriginID),n=this.relationshipLinkChartDiagramLookup.get(e.attributes.ESRI__DestID);if(t&&n){let r=C(new S({paths:[[[t.coords[0],t.coords[1]],[n.coords[0],n.coords[1]]]]}));this.relationshipLinkChartDiagramLookup.set(e.attributes.ESRI__ID,r)}else this.relationshipLinkChartDiagramLookup.set(e.attributes.ESRI__ID,null)})})):await this._calculateLayoutWithSublayerTimeInfo(this.initializationLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations(),...this.initializationLinkChartConfig}):await this._calculateLayoutWithSublayerTimeInfo(`organic-standard`,{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(let e of this.layers)e.emit(`refresh`,{dataChanged:!0});for(let e of this.tables)e.emit(`refresh`,{dataChanged:!0})}_validateOrganicLayoutSettings(e,t){let n=e=>typeof e==`number`&&!isNaN(e),i=e=>n(e)&&e>=1,a=e=>n(e)&&e>=1,o=e=>Object.values(H).includes(e),s=e=>n(e)&&e>=0,c={};if(!new Set([`organic-standard`,`organic-community`,`geographic-organic-standard`,`chronological-multi-timeline`,`chronological-mono-timeline`]).has(e)||!t)return c;let{computationBudgetTime:l,autoRepulsionRadius:u,repulsionRadiusMultiplier:d,absoluteIdealEdgeLength:f,multiplicativeIdealEdgeLength:p,idealEdgeLengthType:m}=t;return a(l)?c.computationBudgetTime=l:l&&r.getLogger(this).warn(`Invalid layout computationBudgetTime setting, will revert to default setting`),c.autoRepulsionRadius=u,!u&&i(d)?c.repulsionRadiusMultiplier=d:u||(c.autoRepulsionRadius=!0,r.getLogger(this).warn(`Invalid layout repulsionRadiusMultiplier setting, will revert to default setting`)),e===`geographic-organic-standard`&&(o(m)?c.idealEdgeLengthType=m:m!==void 0&&r.getLogger(this).warn(`Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting`),m===`absolute-value`&&s(f)?c.absoluteIdealEdgeLength=f:m===`absolute-value`&&f!==void 0?r.getLogger(this).warn(`Invalid layout idealEdgeLength setting, will revert to default setting`):m===`multiplier`&&s(p)?c.multiplicativeIdealEdgeLength=p:m===`multiplier`&&p!==void 0&&r.getLogger(this).warn(`Invalid layout idealEdgeLength setting, will revert to default setting`)),c}_convertValidatedOrganicSettingsToCalculationSettings(e){let t=e.idealEdgeLengthType===H.ABSOLUTE?e.absoluteIdealEdgeLength:e.multiplicativeIdealEdgeLength;return e.idealEdgeLengthType===H.ABSOLUTE&&(t===void 0?t=-1:t*=-1),{computationBudgetTime:e.computationBudgetTime??void 0,repulsionRadiusMultiplier:e.repulsionRadiusMultiplier&&!e.autoRepulsionRadius?e.repulsionRadiusMultiplier:void 0,idealEdgeLengthMultiplier:t}}_createSublayer(e){return new F({objectType:e,parentCompositeLayer:this,graphType:e.type})}_handleSublayersChange(e,t){t&&(t.forEach(e=>{e.parent=null}),this.removeHandles(`sublayers-owner`)),e&&(e.forEach(e=>{e.parent=this}),this.addHandles([e.on(`after-add`,({item:e})=>{e.parent=this}),e.on(`after-remove`,({item:e})=>{e.parent=null})],`sublayers-owner`))}_alignLayersDataModelAndInclusionDefinition(e){let t=new Set((e.entityTypes??[]).map(e=>e.name).concat((e.relationshipTypes??[]).map(e=>e.name))),n=new Set((e.entityTypes??[]).map(e=>e.name)),a=new Set((e.relationshipTypes??[]).map(e=>e.name));if(this.layers){for(let e of this.layers)!e.graphType&&t.has(e.graphTypeName)&&(e.graphType=n.has(e.graphTypeName)?`entity`:`relationship`);let e=this.layers.filter(e=>t.has(e.graphTypeName)&&(e.graphType===`entity`?n.has(e.graphTypeName):a.has(e.graphTypeName)));this.setAtOrigin(`layers`,e,i(this.originIdOf(`layers`)))}else this.layers=new p;if(this.layers&&this._originalInclusionList){let e=new Set(this._originalInclusionList.namedTypeDefinitions.keys()),t=this.tables?.map(e=>e.graphTypeName)??[],n=this.layers.map(e=>e.graphTypeName).concat(t);for(let t of n)e.has(t)||this._originalInclusionList.namedTypeDefinitions.set(t,{useAllData:!1,members:new Map});let i=[];for(let e of this._originalInclusionList.namedTypeDefinitions.keys())n.includes(e)||(r.getLogger(this).warn(`A named type, ${e}, was in the serialized feature collection but did not have a sublayer config in the item, so will be removed`),i.push(e));for(let e of i)this._originalInclusionList.namedTypeDefinitions.delete(e)}}};m([n(s)],U.prototype,`url`,void 0),m([n()],U.prototype,`dataPreloadedInLocalCache`,void 0),m([n()],U.prototype,`initializationLinkChartConfig`,void 0),m([n()],U.prototype,`membershipModified`,void 0),m([n()],U.prototype,`dataManager`,void 0),m([n()],U.prototype,`initializationInclusionModeDefinition`,null),m([n()],U.prototype,`knowledgeGraph`,void 0),m([n({type:p.ofType(F),json:{write:{ignoreOrigin:!0}}})],U.prototype,`layers`,void 0),m([n({readOnly:!0})],U.prototype,`linkChart`,null),m([n()],U.prototype,`entityLinkChartDiagramLookup`,void 0),m([n()],U.prototype,`relationshipLinkChartDiagramLookup`,void 0),m([n()],U.prototype,`linkChartExtent`,void 0),m([n()],U.prototype,`memberEntityTypes`,void 0),m([n()],U.prototype,`memberRelationshipTypes`,void 0),m([n({type:[`LinkChartLayer`]})],U.prototype,`operationalLayerType`,void 0),m([n()],U.prototype,`sublayerCapabilities`,null),m([n()],U.prototype,`sublayerIdsCache`,void 0),m([n({type:p.ofType(F),json:{write:{ignoreOrigin:!0}}})],U.prototype,`tables`,void 0),m([n({json:{read:!1}})],U.prototype,`type`,void 0),m([n({readOnly:!0})],U.prototype,`userHasEditingPrivileges`,void 0),m([n({readOnly:!0})],U.prototype,`userHasFullEditingPrivileges`,void 0),m([n({readOnly:!0})],U.prototype,`userHasUpdateItemPrivileges`,void 0),m([n({json:{read:!1}})],U.prototype,`chronologicalAuxiliaryGraphics`,void 0),U=m([u(`esri.layers.LinkChartLayer`)],U);var W=U;export{W as default};