import{Od as e,Qw as t,bd as n,bn as r,g as i,gn as a,lm as o,oD as s,oh as c,om as l,pn as u,qh as d,s as f,sh as p,um as m,vn as h,wn as g,yn as _}from"./index-BN8X5Ryz.js";import{n as v}from"./arcadeEnvironment-DUP-IKH2.js";import{t as ee}from"./ImmutableArray-C3KNQCVd.js";import{B as y,G as b,I as te,L as x,P as S,R as ne,X as C,Y as w,b as T,et as E,k as D,lt as O,m as k,nt as A,o as j,q as M,s as N,t as P,y as re}from"./Dictionary-Db5-uVgu.js";import{a as F,c as ie,d as I,l as L,m as R,n as z,p as ae,u as oe}from"./shared-Bq4SQ-mm.js";import"./number-bRvGjlJj.js";import{n as se}from"./Feature-BbsZTluv.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import{i as ce,n as le,r as B,t as V}from"./WhereClause-CATd9kVz.js";import{t as ue}from"./fieldStats-BspZIJTx.js";import{t as de}from"./ArcadePortal-CBZerHI1.js";import"./Attachment-BDp8KxLR.js";import{t as fe}from"./portalUtils-Bs81nDRc.js";import"./operatorsWorkerConnection-DOouwDAw.js";import{a as pe,c as me,d as H,l as he,n as ge,o as _e,s as ve,u as ye}from"./featureSetUtils-D5qz0SKk.js";import{C as U,S as W,_ as G,b as be,c as xe,d as Se,f as Ce,g as K,h as q,i as we,l as Te,m as Ee,n as De,o as Oe,p as ke,s as Ae,u as je,v as Me,y as Ne}from"./FeatureSet-Mo_jGewE.js";import"./urlUtils-CW4cnJ3W.js";import"./queryRelatedRecords-D3kRWjXS.js";import{t as Pe}from"./Empty-DGPqEhPn.js";import"./Association-DqPaiO3H.js";import{t as Fe}from"./queryAssociations-BbDkO10M.js";import{t as Ie}from"./QueryAssociationsParameters-CC3TeP1B.js";var Le=class{constructor(e){this.field=e,this.sqlRewritable=!1}postInitialization(e,t){}},J=class extends Le{constructor(e){super(e),this.sqlRewritable=!0}extractValue(e){return e.attributes[this.field.name]}rewriteSql(e){return{rewritten:this.sqlRewritable,where:e}}},Y=class extends Le{constructor(e,t,n){super(R(e)),this.originalField=e,this.sqlRewritable=!0,this.field.name=t,this.field.alias=n}rewriteSql(e,t){return{rewritten:this.sqlRewritable,where:K(e,this.field.name,this.originalField.name,t.getFieldsIndex())}}extractValue(e){return e.attributes[this.originalField.name]}},Re=class e extends Le{constructor(e,t,n){for(let r in super(e),this.codefield=t,this._stringToCode=n,this._codeToString={},n)this._codeToString[n[r]]=r;this.sqlRewritable=!0}static{this.BADNESS=`_!!!_BAD_LKP_!!!!`}rewriteSql(t,n){let r=this.evaluateNodeToWhereClause(t.parseTree,0,this.field.name,this.codefield instanceof V?q(this.codefield,0):this.codefield,t.parameters);return r.includes(e.BADNESS)?{rewritten:!1,where:t}:{rewritten:this.sqlRewritable,where:V.create(r,{fieldsIndex:n._parent.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})}}evaluateNodeToWhereClause(t,n,r=null,i=null,a){switch(t.type){case`interval`:return Ae(this.evaluateNodeToWhereClause(t.value,n,r,i,a),t.qualifier,t.op);case`case-expression`:{let i=` CASE `;t.format===`simple`&&(i+=this.evaluateNodeToWhereClause(t.operand,n,r,e.BADNESS,a));for(let o of t.clauses)i+=` WHEN `+this.evaluateNodeToWhereClause(o.operand,n,r,e.BADNESS,a)+` THEN `+this.evaluateNodeToWhereClause(o.value,n,r,e.BADNESS,a);return t.else!==null&&(i+=` ELSE `+this.evaluateNodeToWhereClause(t.else,n,r,e.BADNESS,a)),i+=` END `,i}case`parameter`:{let e=a[t.value.toLowerCase()];return typeof e==`string`?`'`+e.toString().replaceAll(`'`,`''`)+`'`:L(e)||ae(e)?Oe(e,n):oe(e)?xe(e,n):ie(e)?be(e,n):I(e)?je(e,n):Array.isArray(e)?e.map(e=>typeof e==`string`?`'`+e.toString().replaceAll(`'`,`''`)+`'`:L(e)||ae(e)?Oe(e,n):oe(e)?xe(e,n):ie(e)?be(e,n):I(e)?je(e,n):e.toString()):e.toString()}case`expression-list`:{let e=[];for(let o of t.value)e.push(this.evaluateNodeToWhereClause(o,n,r,i,a));return e}case`unary-expression`:return` ( NOT `+this.evaluateNodeToWhereClause(t.expr,n,r,e.BADNESS,a)+` ) `;case`binary-expression`:switch(t.operator){case`AND`:return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` AND `+this.evaluateNodeToWhereClause(t.right,n,r,i,a)+`) `;case`OR`:return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` OR `+this.evaluateNodeToWhereClause(t.right,n,r,i,a)+`) `;case`IS`:if(t.right.type!==`null`)throw new B(`UnsupportedIsRhs`);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IS NULL )`;case`ISNOT`:if(t.right.type!==`null`)throw new B(`UnsupportedIsRhs`);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IS NOT NULL )`;case`IN`:{if(t.right.type===`expression-list`){if(t.left.type===`column-reference`&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){let e=[],o=!0;for(let n of t.right.value){if(n.type!==`string`){o=!1;break}if(this._stringToCode[n.value]===void 0){o=!1;break}e.push(this._stringToCode[n.value].toString())}if(o)return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IN (`+e.join(`,`)+`)) `}let e=this.evaluateNodeToWhereClause(t.right,n,r,i,a);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IN (`+e.join(`,`)+`)) `}let e=this.evaluateNodeToWhereClause(t.right,n,r,i,a);return Array.isArray(e)?` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IN (`+e.join(`,`)+`)) `:` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IN (`+e+`)) `}case`NOT IN`:{if(t.right.type===`expression-list`){if(t.left.type===`column-reference`&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){let e=[],o=!0;for(let n of t.right.value){if(n.type!==`string`){o=!1;break}if(this._stringToCode[n.value]===void 0){o=!1;break}e.push(this._stringToCode[n.value].toString())}if(o)return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` NOT IN (`+e.join(`,`)+`)) `}let e=this.evaluateNodeToWhereClause(t.right,n,r,i,a);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` NOT IN (`+e.join(`,`)+`)) `}let e=this.evaluateNodeToWhereClause(t.right,n,r,i,a);return Array.isArray(e)?` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` NOT IN (`+e.join(`,`)+`)) `:` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` NOT IN (`+e+`)) `}case`BETWEEN`:{let i=this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` BETWEEN `+i[0]+` AND `+i[1]+` ) `}case`NOTBETWEEN`:{let i=this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` NOT BETWEEN `+i[0]+` AND `+i[1]+` ) `}case`LIKE`:return t.escape===``?` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` LIKE `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+`) `:` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` LIKE `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+` ESCAPE '`+t.escape+`') `;case`NOT LIKE`:return t.escape===``?` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` NOT LIKE `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+`) `:` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` NOT LIKE `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+` ESCAPE '`+t.escape+`') `;case`<>`:case`=`:if(t.left.type===`column-reference`&&t.right.type===`string`){if(t.left.column.toUpperCase()===this.field.name.toUpperCase()&&this._stringToCode[t.right.value.toString()]!==void 0)return` (`+i+` `+t.operator+` `+this._stringToCode[t.right.value.toString()].toString()+`) `}else if(t.right.type===`column-reference`&&t.left.type===`string`&&t.right.column.toUpperCase()===this.field.name.toUpperCase())return` (`+this._stringToCode[t.left.value.toString()].toString()+` `+t.operator+` `+i+`) `;return` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` `+t.operator+` `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+`) `;case`<`:case`>`:case`>=`:case`<=`:case`*`:case`-`:case`+`:case`/`:case`||`:return` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` `+t.operator+` `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+`) `}case`null`:return`null`;case`boolean`:return!0===t.value?`1`:`0`;case`string`:return`'`+t.value.toString().replaceAll(`'`,`''`)+`'`;case`timestamp`:return`timestamp '${t.value}'`;case`date`:return`date '${t.value}'`;case`time`:return`time '${t.value}'`;case`number`:return t.value.toString();case`current-time`:return Ne(t.mode,n);case`current-user`:return`CURRENT_USER`;case`column-reference`:return r&&r.toLowerCase()===t.column.toLowerCase()?`(`+i+`)`:Ce(t);case`data-type`:return t.value;case`function`:{let i=this.evaluateNodeToWhereClause(t.args,n,r,e.BADNESS,a);return Ee(t.name,i,n)}}throw new B(`UnsupportedSyntax`,{node:t.type})}extractValue(e){if(this.codefield instanceof V){let t=this.codefield.calculateValueCompiled(e);return this._codeToString[V.convertValueToStorageFormat(t)]}return this._codeToString[e.attributes[this.codefield]]}},X=class extends Le{constructor(e,t){super(e),this._sql=t}rewriteSql(e,t){return{rewritten:!0,where:K(e,this.field.name,q(this._sql,0),t.getFieldsIndex())}}extractValue(e){return V.convertValueToStorageFormat(this._sql.calculateValueCompiled(e),this.field.type)}},Z=class extends we{static findField(e,t){for(let n of e)if(n.name.toLowerCase()===t.toString().toLowerCase())return n;return null}constructor(e){super(),this.declaredClass=`esri.arcade.featureset.actions.Adapted`,this._maxProcessing=30,this._parent=e.parentfeatureset,this._adaptedFields=e.adaptedFields,this._extraFilter=e.extraFilter}_initialiseFeatureSet(){this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.fields=[];for(let e of this._adaptedFields)e.postInitialization(this,this._parent),this.fields.push(e.field)}async _queryAll(){return await this._ensureLoaded(),this._extraFilter?(await this.query({abortSignal:v})).features:this._calculateFields(await this._parent.queryAll(v))}async query(e){let t=e.where??null,n=this._reformulateWithoutAdaptions(t),r=n.cannot;t=n.where;let i=!1,a=e.orderBy;if(a!=null){i=!0;let e=[];for(let t of this._adaptedFields)if(!(t instanceof J)&&!0===a.scanForField(t.field.name)){if(!(t instanceof Y)){a=null,i=!1;break}e.push({field:t.field.name,newfield:t.originalField.name})}a&&e.length>0&&(a=a.replaceFields(e))}t==null?t=this._extraFilter:this._extraFilter!=null&&(t=G(this._extraFilter,t)),await this._ensureLoaded();let o=await this._parent.query({...e,where:t,orderBy:a});return U(e.abortSignal),r?{...o,filterApplied:!1,ordered:!!i&&o.ordered,features:this._calculateFields(o.features)}:{...o,ordered:!!i&&o.ordered,features:this._calculateFields(o.features)}}async*_calculateFields(e){for await(let t of e)yield t.map(e=>{let t={};for(let n of this._adaptedFields)t[n.field.name]=n.extractValue(e);return{attributes:t,geometry:e.geometry}})}async queryStat(e){let t=!1,n=e.field,r=this._reformulateWithoutAdaptions(n);t=r.cannot,n=r.where;let i=e.where??null;if(r=this._reformulateWithoutAdaptions(i),t||=r.cannot,i=r.where,i==null?i=this._extraFilter:this._extraFilter!==null&&(i=G(this._extraFilter,i)),t)return i==null&&e.spatialFilter==null?this._manualStat(e.stat,n,e.limit??1e3,e.abortSignal):{calculated:!1};let a=await this._parent.queryStat({...e,field:n,where:i});return a.calculated?a:i==null&&e.spatialFilter==null?this._manualStat(e.stat,n,e.limit??1e3,e.abortSignal):{calculated:!1}}async canQueryAggregate(e){for(let t of e.groupBy)for(let e of this._adaptedFields)if(t.toLowerCase()===e.field.name.toLowerCase()&&!(e instanceof J))return!1;let t=[];for(let n of e.statistics)if(n.workingexpr!==null){let e=this._reformulateWithoutAdaptions(n.workingexpr);if(e.cannot)return!1;let r=n.clone();r.workingexpr=e.where,t.push(r)}else t.push(n);let n=e.where??null,r=this._reformulateWithoutAdaptions(n);return!r.cannot&&(n=r.where,n===null?n=this._extraFilter:this._extraFilter!==null&&(n=G(this._extraFilter,n)),this._parent.canQueryAggregate({...e,statistics:t,where:n}))}async queryAggregate(e){let t=[];for(let n of e.statistics)if(n.workingexpr!==null){let e=this._reformulateWithoutAdaptions(n.workingexpr);if(e.cannot)throw new W(`NeverReach`);let r=n.clone();r.workingexpr=e.where,t.push(r)}else t.push(n);let n=e.where??null,r=this._reformulateWithoutAdaptions(n);if(r.cannot)throw new W(`NeverReach`);return n=r.where,n===null?n=this._extraFilter:this._extraFilter!==null&&(n=G(this._extraFilter,n)),this._parent.queryAggregate({...e,statistics:t,where:n})}_reformulateWithoutAdaptions(e){let t={cannot:!1,where:e};if(e!==null){for(let n of this._adaptedFields)if(!0===Se(e,n.field.name)){let r=n.rewriteSql(e,this);if(!0!==r.rewritten){t.cannot=!0,t.where=null;break}t.where=r.where}}return t}},ze=class extends we{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.actions.OrderBy`,this._maxProcessing=100,this._parent=e.parentfeatureset,this._orderByClause=e.orderbyclause}async _queryAll(){return(await this.query({abortSignal:v})).features}async query(e){await this._ensureLoaded();let t=await this._parent.query({...e,orderBy:e.orderBy==null?this._orderByClause:e.orderBy});return U(e.abortSignal),!1===t.ordered?{...t,ordered:!0,features:this._sortFeatures(t.features,e.abortSignal)}:t}async*_sortFeatures(e,t){let n=[];for await(let r of e)n.push(r),await x(),U(t);let r=n.flat();this._orderByClause.order(r);for(let e of s(r,this._maxQueryRate()))yield e}async queryStat(e){let t=await this._parent.queryStat(e);return t.calculated?t:e.where==null&&e.spatialFilter==null?this._manualStat(e.stat,e.field,e.limit??1e3,e.abortSignal):{calculated:!1}}async canQueryAggregate(e){return this._parent.canQueryAggregate(e)}async queryAggregate(e){return this._parent.queryAggregate(e)}getFieldsIndex(){return this._parent.getFieldsIndex()}};function Be(e,t){return e===t?0:e===null?-1:t===null?1:e<t?-1:1}var Ve=class e{constructor(e){let t=e.split(`,`);this._fields=[],this._directions=[];for(let e=0;e<t.length;e++){let n=t[e].match(/\S+/g);this._fields.push(n[0]),n.length===2?n[1].toLowerCase()===`asc`?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let e=``;for(let t=0;t<this._fields.length;t++)t!==0&&(e+=`,`),e+=this._fields[t],this._directions[t]===1?e+=` ASC`:e+=` DESC`;return e}order(e){e.sort((e,t)=>{for(let n=0;n<this._fields.length;n++){let r=this.featureValue(e,this._fields[n],n),i=this.featureValue(t,this._fields[n],n),a=0;if(a=this._directions[n]===1?Be(r,i):-1*Be(r,i),a!==0)return a}return 0})}scanForField(e){for(let t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===e.toLowerCase().trim())return!0;return!1}replaceFields(t){let n=``;for(let e=0;e<this._fields.length;e++){e!==0&&(n+=`,`);let r=this._fields[e];for(let e of t)if(r.toLowerCase()===e.field.toLowerCase()){r=e.newfield;break}n+=r,this._directions[e]===1?n+=` ASC`:n+=` DESC`}return new e(n)}featureValue(e,t,n){let r=e.attributes[t];if(r!==void 0)return r;for(let r in e.attributes)if(t.toLowerCase()===r.toLowerCase())return this._fields[n]=r,e.attributes[r];return null}};function He(e){if(e.parseTree.type===`function`){if(e.parseTree.args.value.length===0)return{name:e.parseTree.name,expr:null};if(e.parseTree.args.value.length>1)throw new B(`MissingStatisticParameters`);let t=V.create(ke(e.parseTree.args.value[0],0,e.parameters),{fieldsIndex:e.fieldsIndex,timeZone:e.timeZone,currentUser:e.currentUser});return{name:e.parseTree.name,expr:t}}return null}var Ue=class e{constructor(){this.field=``,this.tofieldname=``,this.typeofstat=`MIN`,this.workingexpr=null}clone(){let t=new e;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}static parseStatField(t,n,r,i){let a=new e;a.field=t;let o=V.create(n,{fieldsIndex:r,timeZone:i}),s=He(o);if(s===null)throw new B(`UnsupportedSqlFunction`,{function:``});let c=s.name.toUpperCase().trim();if(c===`MIN`){if(a.typeofstat=`MIN`,a.workingexpr=s.expr,o===null)throw new B(`InvalidFunctionParameters`,{function:`min`})}else if(c===`MAX`){if(a.typeofstat=`MAX`,a.workingexpr=s.expr,o===null)throw new B(`InvalidFunctionParameters`,{function:`max`})}else if(c===`COUNT`)a.typeofstat=`COUNT`,a.workingexpr=s.expr;else if(c===`STDEV`){if(a.typeofstat=`STDDEV`,a.workingexpr=s.expr,o===null)throw new B(`InvalidFunctionParameters`,{function:`stdev`})}else if(c===`SUM`){if(a.typeofstat=`SUM`,a.workingexpr=s.expr,o===null)throw new B(`InvalidFunctionParameters`,{function:`sum`})}else if(c===`MEAN`){if(a.typeofstat=`AVG`,a.workingexpr=s.expr,o===null)throw new B(`InvalidFunctionParameters`,{function:c})}else if(c===`AVG`){if(a.typeofstat=`AVG`,a.workingexpr=s.expr,o===null)throw new B(`InvalidFunctionParameters`,{function:`avg`})}else{if(c!==`VAR`)throw new B(`UnsupportedSqlFunction`,{function:c});if(a.typeofstat=`VAR`,a.workingexpr=s.expr,o===null)throw new B(`InvalidFunctionParameters`,{function:`var`})}return a}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case`MIN`:return`min`;case`MAX`:return`max`;case`SUM`:return`sum`;case`COUNT`:default:return`count`;case`VAR`:return`var`;case`STDDEV`:return`stddev`;case`AVG`:return`avg`}}},We=new _([`MIN`,`MAX`,`VAR`,`STDDEV`,`COUNT`,`SUM`,`AVG`],[[`VARIANCE`,`VAR`],[`AVERAGE`,`AVG`],[`MEAN`,`AVG`],[`STDEV`,`STDDEV`]]),Ge=class extends we{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.actions.Aggregate`,this._decodedStatsFields=[],this._decodedGroupByFields=[],this._canDoSimpleGroupBy=!0,this._physicalGroupByFields=[],this.objectIdField=`ROW__ID`,this._adaptedFields=[],this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_nextUniqueName(e){for(;e[`T`+this._uniqueIds.toString()]===1;)this._uniqueIds++;let t=`T`+this._uniqueIds.toString();return e[t]=1,t}_convertToEsriFieldType(e){return e}_initialiseFeatureSet(){let e=this._parent.getFieldsIndex();this.objectIdField=`ROW__ID`,this.globalIdField=``;let t=!1,r=1;for(;!1===t;){let e=!1;for(let t of this._config.groupbyfields)if(t.name.toLowerCase()===this.objectIdField.toLowerCase()){e=!0;break}if(!1===e){for(let t of this._config.statsfields)if(t.name.toLowerCase()===this.objectIdField.toLowerCase()){e=!0;break}}!1===e?t=!0:(this.objectIdField=`ROW__ID`+r.toString(),r++)}for(let t of this._config.statsfields){let n=new Ue;n.field=t.name,n.tofieldname=t.name,n.workingexpr=t.expression instanceof V?t.expression:V.create(t.expression,{fieldsIndex:e,timeZone:this.dateFieldsTimeZoneDefaultUTC}),n.typeofstat=We.lookup(t.statistic)??`COUNT`,this._decodedStatsFields.push(n)}this._decodedGroupByFields=[];for(let t of this._config.groupbyfields){let n={name:t.name,singlefield:null,tofieldname:t.name,expression:t.expression instanceof V?t.expression:V.create(t.expression,{fieldsIndex:e,timeZone:this.dateFieldsTimeZoneDefaultUTC}),sqlType:null};this._decodedGroupByFields.push(n)}let i={};this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=``;for(let e of this._parent.fields)i[e.name.toUpperCase()]=1;this.types=null,this.subtypes=null,this.subtypeField=``,this.fields=[];let a=new Ue;a.field=this._nextUniqueName(i),a.tofieldname=this.objectIdField,a.workingexpr=V.create(this._parent.objectIdField,{fieldsIndex:this._parent.getFieldsIndex(),timeZone:this.dateFieldsTimeZoneDefaultUTC}),a.typeofstat=`MIN`,this._decodedStatsFields.push(a);for(let e of this._decodedGroupByFields){let t=new n;if(e.name=this._nextUniqueName(i),t.name=e.tofieldname,t.alias=t.name,Me(e.expression)){let n=this._parent.getField(q(e.expression,0));if(!n)throw new W(`AggregationFieldNotFound`);e.name=n.name,e.singlefield=n.name,this._physicalGroupByFields.push(n.name),t.type=n.type,e.sqlType=n.type}else{t.type=this._convertToEsriFieldType(Te(e.expression,this._parent.fields));let r=new n;r.name=e.name,r.alias=r.name,this._physicalGroupByFields.push(e.name),this._adaptedFields.push(new X(r,e.expression)),this._canDoSimpleGroupBy=!1,e.sqlType=t.type}this.fields.push(t)}if(this._adaptedFields.length>0)for(let e of this._parent.fields)this._adaptedFields.push(new J(e));for(let e of this._decodedStatsFields){let t=new n,r=null;e.field=this._nextUniqueName(i),t.name=e.tofieldname,t.alias=t.name;let a=e.workingexpr!==null&&Me(e.workingexpr)?q(e.workingexpr,0):``;switch(e.typeofstat){case`SUM`:if(a!==``){if(r=this._parent.getField(a),!r)throw new W(`AggregationFieldNotFound`);t.type=r.type}else t.type=`double`;break;case`MIN`:case`MAX`:if(a!==``){if(r=this._parent.getField(a),!r)throw new W(`AggregationFieldNotFound`);t.type=r.type}else t.type=`double`;break;case`COUNT`:t.type=`integer`;break;case`STDDEV`:case`VAR`:case`AVG`:if(a!==``&&(r=this._parent.getField(a),!r))throw new W(`AggregationFieldNotFound`);t.type=`double`}this.fields.push(t)}}async _queryAll(){return(await this.query({abortSignal:v})).features}async query(e){if(e.spatialFilter!=null)return De;let t={ordered:!1,nowhereclause:!1};await this._ensureLoaded();let n=e.where;if(n!=null){for(let e of this._decodedStatsFields)if(!0===Se(n,e.tofieldname)){t.nowhereclause=!0,n=null;break}}let r=e.orderBy;if(r!=null){t.ordered=!0;for(let e of this._decodedStatsFields)if(!0===r.scanForField(e.tofieldname)){r=null,t.ordered=!1;break}if(r!==null){for(let e of this._decodedGroupByFields)if(e.singlefield===null&&!0===r.scanForField(e.tofieldname)){r=null,t.ordered=!1;break}}}if(!1!==this._canDoSimpleGroupBy&&await this._parent.canQueryAggregate({groupBy:this._physicalGroupByFields,statistics:this._decodedStatsFields,where:null,spatialFilter:null,abortSignal:e.abortSignal})){let i=await this._parent.queryAggregate({groupBy:this._physicalGroupByFields,statistics:this._decodedStatsFields,where:n?this._reformulateWhereClauseWithoutGroupByFields(n):null,spatialFilter:null,orderBy:r?this._reformulateOrderClauseWithoutGroupByFields(r):null,abortSignal:e.abortSignal});return U(e.abortSignal),{...i,filterApplied:!t.nowhereclause&&i.filterApplied,ordered:!0===t.ordered&&i.ordered,features:this._fixAggregateAttributeNames(i.features)}}let i=this._adaptedFields.length>0?new Z({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null}):this._parent;if(!0===t.nowhereclause){let t=new ze({parentfeatureset:i,orderbyclause:new Ve(this._physicalGroupByFields.join(`,`)+`,`+this._parent.objectIdField+` ASC`)});return{filterApplied:!1,spatialFilterApplied:!1,ordered:!1,features:this._aggregateSortedFeatureGroups((await t.query({abortSignal:e.abortSignal})).features,this._maxQuery,e.abortSignal)}}let a=i;n!=null&&(a=new H({parentfeatureset:a,whereclause:this._reformulateWhereClauseWithoutGroupByFields(n)}));let o=new ze({parentfeatureset:a,orderbyclause:new Ve(this._physicalGroupByFields.join(`,`)+`,`+this._parent.objectIdField+` ASC`)});return{filterApplied:!1,spatialFilterApplied:!1,ordered:!1,features:this._aggregateSortedFeatureGroups((await o.query({abortSignal:e.abortSignal})).features,this._maxQuery,e.abortSignal)}}async*_fixAggregateAttributeNames(e){for await(let t of e)yield t.map(e=>{let t={geometry:e.geometry,attributes:{}},n={};for(let t in e.attributes)n[t.toLowerCase()]=e.attributes[t];for(let e of this._decodedGroupByFields)t.attributes[e.tofieldname]=n[e.name.toLowerCase()];for(let e of this._decodedStatsFields)t.attributes[e.tofieldname]=n[e.field.toLowerCase()];return t})}async*_aggregateSortedFeatureGroups(e,t,n){let r=null,i=[];for await(let a of e){await x(),U(n);for(let e of a){let t=this._generateAggregateHash(e);r==null?r={features:[e],id:t}:t===r.id?r.features.push(e):(i.push(this._calculateAndAppendAggregateItem(r)),r={features:[e],id:t})}i.length>=t&&(yield i,i=[])}r!=null&&(i.push(this._calculateAndAppendAggregateItem(r)),yield i)}async queryStat(e){return{calculated:!1}}async canQueryAggregate(e){return!1}async queryAggregate(e){throw new W(`NeverReach`)}_reformulateWhereClauseWithoutStatsFields(e){for(let t of this._decodedStatsFields)e=K(e,t.tofieldname,q(t.workingexpr,0),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(let t of this._decodedGroupByFields)t.tofieldname!==t.name&&(e=K(e,t.tofieldname,q(t.expression,0),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){let t=[];for(let e of this._decodedGroupByFields)e.tofieldname!==e.name&&t.push({field:e.tofieldname,newfield:e.name});return t.length>0?e.replaceFields(t):e}_calculateFieldStat(e,t,n){let r=[];for(let n of e.features)if(t.workingexpr!==null){let e=t.workingexpr.calculateValue(n);e!==null&&(e instanceof a||e instanceof u?r.push(e.toNumber()):e instanceof ce?r.push(e.toMilliseconds()):r.push(e))}else r.push(null);n.attributes[t.tofieldname]=le(t.typeofstat,[r])}_calculateAndAppendAggregateItem(e){let t={attributes:{}};for(let n of this._decodedGroupByFields){let r=n.singlefield?e.features[0].attributes[n.singlefield]:V.convertValueToStorageFormat(n.expression.calculateValue(e.features[0]),n.sqlType);t.attributes[n.tofieldname]=r}for(let n of this._decodedStatsFields)this._calculateFieldStat(e,n,t);return t}_generateAggregateHash(e){let t=``;for(let n of this._decodedGroupByFields){let r=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);t+=r==null?`:`:`:`+r.toString()}return p(t,c.String)}async getFeatureByObjectId(){throw new W(`NotImplemented`)}};async function*Ke(e,t){let n=t;for await(let t of e)if(n>=t.length?(n-=t.length,yield t):(yield t.slice(0,n),n=0),n<=0)break}var qe=class extends we{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.actions.Top`,this._maxProcessing=100,this._parent=e.parentfeatureset,this._limit=e.topnum}async _queryAll(){return(await this.query({abortSignal:v})).features}async query(e){await this._ensureLoaded();let t=await this._parent.queryAll(e.abortSignal);return{filterApplied:e.where==null,spatialFilterApplied:e.spatialFilter==null,ordered:!1,features:Ke(t,this._limit)}}async queryStat(e){return{calculated:!1}}async canQueryAggregate(e){return!1}async queryAggregate(e){throw new W(`NeverReach`)}getFieldsIndex(){return this._parent.getFieldsIndex()}};function Je(e){if(e.length===1){if(o(e[0]))return ue(`distinct`,e[0],-1);if(A(e[0]))return ue(`distinct`,e[0].toArray(),-1)}return ue(`distinct`,e,-1)}function Ye(e,t,n){let r=e.getVariables();if(r.length>0){let i={};for(let e of r)i[e]=t.evaluateIdentifier(n,{name:e});e.parameters=i}return e}function Q(e,t,n=null){for(let n in e)if(n.toLowerCase()===t.toLowerCase())return e[n];return n}function Xe(e){if(e===null)return null;let t={type:Q(e,`type`,``),name:Q(e,`name`,``)};if(t.type===`range`)t.range=Q(e,`range`,[]);else{t.codedValues=[];for(let n of Q(e,`codedValues`,[]))t.codedValues.push({name:Q(n,`name`,``),code:Q(n,`code`,null)})}return t}function Ze(e){if(e===null)return null;let t={},n=Q(e,`wkt`);n!==null&&(t.wkt=n);let r=Q(e,`wkid`);return r!==null&&(t.wkid=r),t}function Qe(e){if(e===null)return null;let t={hasZ:Q(e,`hasz`,!1),hasM:Q(e,`hasm`,!1)},n=Q(e,`spatialreference`);n!=null&&(t.spatialReference=Ze(n));let r=Q(e,`x`,null);if(r!==null)return t.x=r,t.y=Q(e,`y`,null),t.hasZ&&(t.z=Q(e,`z`,null)),t.hasM&&(t.m=Q(e,`m`,null)),t;let i=Q(e,`rings`,null);if(i!==null)return t.rings=i,t;let a=Q(e,`paths`,null);if(a!==null)return t.paths=a,t;let o=Q(e,`points`,null);if(o!==null)return t.points=o,t;for(let n of[`xmin`,`xmax`,`ymin`,`ymax`,`zmin`,`zmax`,`mmin`,`mmax`]){let r=Q(e,n,null);r!==null&&(t[n]=r)}return t}function $e(e,t){for(let n of t)if(n===e)return!0;return!1}function et(e){return!!e.layerDefinition&&!!e.featureSet&&!1!==$e(e.layerDefinition.geometryType,[``,null,`esriGeometryNull`,`esriGeometryPoint`,`esriGeometryPolyline`,`esriGeometryPolygon`,`esriGeometryMultipoint`,`esriGeometryEnvelope`])&&!1!==o(e.layerDefinition.fields)&&!1!==o(e.featureSet.features)}function $(e){return e?.toLowerCase()===`utc`?`UTC`:e?.toLowerCase()===`unknown`?`Unknown`:e}async function tt(t,r,a,o,s,c,l){let u=await t.getFeatureSetInfo();if((u?.layerId??null)===null||!s.layerIdLookup.get(u.layerId))return null;let d=t.serviceUrl().replace(/\/FeatureServer/i,`/UtilityNetworkServer`),p=[];switch(a){case`connected`:p.push(`connectivity`),p.push(`junction-edge-from-connectivity`),p.push(`junction-edge-to-connectivity`),p.push(`junction-edge-midspan-connectivity`),p.push(`junction-junction-connectivity`);break;case`container`:case`content`:p.push(`containment`);break;case`structure`:case`attached`:p.push(`attachment`);break;case`junctionedge`:p.push(`junction-edge-from-connectivity`),p.push(`junction-edge-to-connectivity`);break;case`midspan`:p.push(`junction-edge-midspan-connectivity`);break;default:throw new g(c,`InvalidParameter`,l)}let m=null,h=!1;if(o!==null&&o!==``&&o!==void 0){for(let e of s.terminals)e.terminalName===o&&(m=e.terminalId);m===null&&(h=!0)}let _=[];if(!h){let n=new f({globalId:r.field(t.globalIdField),networkSourceId:s.layerIdLookup.get(u.layerId).sourceId,...m?{terminalId:m}:``}),i=await Fe(d,new Ie({types:p,elements:[n]})),o=0;for(let t of i.associations){let r=null,i=``,c=``;if(t.fromNetworkElement?.globalId===n.globalId?(r=t.toNetworkElement,c=`to`):t.toNetworkElement?.globalId===n.globalId&&(r=t.fromNetworkElement,c=`from`),!r)continue;switch(a){case`attached`:if(t.associationType!==`attachment`||c!==`to`)continue;break;case`structure`:if(t.associationType!==`attachment`||c!==`from`)continue;break;case`container`:if(t.associationType!==`containment`||c!==`from`)continue;break;case`content`:if(t.associationType!==`containment`||c!==`to`)continue;break;case`connected`:break;case`junctionedge`:t.associationType===`junction-edge-to-connectivity`?i=`to`:t.associationType===`junction-edge-from-connectivity`&&(i=`from`);break;case`midspan`:if(t.associationType!==`junction-edge-midspan-connectivity`)continue}let l=s.sourceIdLookup.get(r.networkSourceId)?.className??``;_.push(new e({geometry:null,attributes:{objectId:o++,globalId:r.globalId,percentAlong:t.percentAlong??0,isContentVisible:t.isContentVisible?0:1,className:l,side:i}}))}}let v=new i({source:_,geometryType:null,objectIdField:`objectId`,globalIdField:`globalId`,fields:[new n({name:`objectId`,alias:`objectId`,type:`oid`}),new n({name:`globalId`,alias:`globalId`,type:`global-id`}),new n({name:`percentAlong`,alias:`percentAlong`,type:`double`}),new n({name:`side`,alias:`side`,type:`string`}),new n({name:`isContentVisible`,alias:`isContentVisible`,type:`integer`}),new n({name:`className`,alias:`className`,type:`string`})]});return me(v)}function nt(e){if(e.mode===`async`){e.functions.timezone=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{if(C(i,1,2,t,n),M(i[0])||E(i[0]))return`Unknown`;if(N(i[0])){if(await i[0].load(),i.length===1||i[1]===null)return i[0].datesInUnknownTimezone?$(`unknown`):$(i[0].dateFieldsTimeZone);if(!(i[1]instanceof P)||!1===i[1].hasField(`type`))throw new g(t,`InvalidParameter`,n);let e=i[1].field(`type`);if(!1===l(e))throw new g(t,`InvalidParameter`,n);switch(b(e).toLowerCase()){case`preferredtimezone`:return $(i[0].preferredTimeZone);case`editfieldsinfo`:return $(i[0].editFieldsInfo?.timeZone??null);case`timeinfo`:return $(i[0].timeInfo?.timeZone??null);case`field`:if(i[1].hasField(`fieldname`)&&l(i[1].field(`fieldname`)))return $(i[0].fieldTimeZone(b(i[1].field(`fieldname`))))}throw new g(t,`InvalidParameter`,n)}let a=ne(i[0],re(t));if(a===null)return null;let o=a.timeZone;return o===`system`?h.systemTimeZoneCanonicalName:o.toLowerCase()===`utc`?`UTC`:o.toLowerCase()===`unknown`?`Unknown`:o})},e.functions.sqltimestamp=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{C(i,1,3,t,n);let a=i[0];if(w(a)){if(i.length===1)return a.toSQLWithKeyword();if(i.length===2)return a.changeTimeZone(b(i[1])).toSQLWithKeyword();throw new g(t,`InvalidParameter`,n)}if(E(a))return a.toSQLWithKeyword();if(N(a)){if(i.length!==3)throw new g(t,`InvalidParameter`,n);await a.load();let e=b(i[1]);if(E(i[2]))return i[2].toSQLWithKeyword();if(!1===w(i[2]))throw new g(t,`InvalidParameter`,n);let r=a.fieldTimeZone(e);return r==null?i[2].toSQLWithKeyword():i[2].changeTimeZone(r).toSQLWithKeyword()}throw new g(t,`InvalidParameter`,n)})},e.signatures.push({name:`sqltimestamp`,min:2,max:4}),e.functions.featuresetbyid=function(t,n){return e.standardFunctionAsync(t,n,(e,r,i)=>{if(C(i,2,4,t,n),S(i[0])){let e=b(i[1]),r=O(i[2],null),a=j(O(i[3],!0));if(r===null&&(r=[`*`]),!1===o(r))throw new g(t,`InvalidParameter`,n);return i[0].featureSetById(e,a,r)}throw new g(t,`InvalidParameter`,n)})},e.signatures.push({name:`featuresetbyid`,min:2,max:4});let a=new _([`datasource`,`parent`,`root`]);e.functions.getfeatureset=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{if(C(i,1,2,t,n),k(i[0])){let e=i[1]==null?`datasource`:a.lookup(b(i[1]));return pe(i[0].fullSchema(),e,t.lrucache,t.interceptor,t.spatialReference)}throw new g(t,`InvalidParameter`,n)})},e.signatures.push({name:`getfeatureset`,min:1,max:2}),e.functions.featuresetbyportalitem=function(t,n){return e.standardFunctionAsync(t,n,(e,r,i)=>{if(C(i,2,5,t,n),i[0]===null)throw new g(t,`PortalRequired`,n);if(i[0]instanceof de){let e=b(i[1]),r=b(i[2]),a=O(i[3],null),s=j(O(i[4],!0));if(a===null&&(a=[`*`]),!1===o(a))throw new g(t,`InvalidParameter`,n);let c;return c=t.services?.portal?t.services.portal:d.getDefault(),c=fe(i[0],c),ge(e,r,t.spatialReference,a,s,c,t.lrucache,t.interceptor)}if(!1===l(i[0]))throw new g(t,`PortalRequired`,n);let a=b(i[0]),s=b(i[1]),c=O(i[2],null),u=j(O(i[3],!0));if(c===null&&(c=[`*`]),!1===o(c))throw new g(t,`InvalidParameter`,n);return ge(a,s,t.spatialReference,c,u,t.services?.portal??d.getDefault(),t.lrucache,t.interceptor)})},e.signatures.push({name:`featuresetbyportalitem`,min:2,max:5}),e.functions.featuresetbyname=function(t,n){return e.standardFunctionAsync(t,n,(e,r,i)=>{if(C(i,2,4,t,n),S(i[0])){let e=b(i[1]),r=O(i[2],null),a=j(O(i[3],!0));if(r===null&&(r=[`*`]),!1===o(r))throw new g(t,`InvalidParameter`,n);return i[0].featureSetByName(e,a,r)}throw new g(t,`InvalidParameter`,n)})},e.signatures.push({name:`featuresetbyname`,min:2,max:4}),e.functions.featureset=function(t,n){return e.standardFunction(t,n,(e,r,i)=>{C(i,1,1,t,n);let a={layerDefinition:{geometryType:``,objectIdField:``,globalIdField:``,typeIdField:``,hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:``,features:[]}};if(l(i[0])){let e=JSON.parse(i[0]);e.layerDefinition===void 0?(a.featureSet.features=e.features,a.featureSet.geometryType=e.geometryType,a.layerDefinition.geometryType=a.featureSet.geometryType,a.layerDefinition.objectIdField=e.objectIdFieldName??``,a.layerDefinition.typeIdField=e.typeIdFieldName,a.layerDefinition.globalIdField=e.globalIdFieldName,a.layerDefinition.fields=e.fields,e.spatialReference&&(a.layerDefinition.spatialReference=e.spatialReference)):(a.layerDefinition=e.layerDefinition,a.featureSet=e.featureSet,e.layerDefinition.spatialReference&&(a.layerDefinition.spatialReference=e.layerDefinition.spatialReference))}else{if(!(i[0]instanceof P))throw new g(t,`InvalidParameter`,n);{let e=JSON.parse(i[0].castToText(!0)),r=Q(e,`layerdefinition`);if(r!==null){a.layerDefinition.geometryType=Q(r,`geometrytype`,``),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.globalIdField=Q(r,`globalidfield`,``),a.layerDefinition.objectIdField=Q(r,`objectidfield`,``),a.layerDefinition.typeIdField=Q(r,`typeidfield`,``),a.layerDefinition.hasZ=!0===Q(r,`hasz`,!1),a.layerDefinition.hasM=!0===Q(r,`hasm`,!1);let t=Q(r,`spatialreference`);t&&(a.layerDefinition.spatialReference=Ze(t));let n=[];for(let e of Q(r,`fields`,[])){let t={name:Q(e,`name`,``),alias:Q(e,`alias`,``),type:Q(e,`type`,``),nullable:Q(e,`nullable`,!0),editable:Q(e,`editable`,!0),length:Q(e,`length`,null),domain:Xe(Q(e,`domain`))};n.push(t)}a.layerDefinition.fields=n;let i=Q(e,`featureset`);if(i){let e={};for(let t of n)e[t.name.toLowerCase()]=t.name;for(let t of Q(i,`features`,[])){let n={},r=Q(t,`attributes`,{});for(let t in r)n[e[t.toLowerCase()]]=r[t];a.featureSet.features.push({attributes:n,geometry:Qe(Q(t,`geometry`))})}}}else{a.layerDefinition.hasZ=!0===Q(e,`hasz`,!1),a.layerDefinition.hasM=!0===Q(e,`hasm`,!1),a.layerDefinition.geometryType=Q(e,`geometrytype`,``),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.objectIdField=Q(e,`objectidfieldname`,``),a.layerDefinition.typeIdField=Q(e,`typeidfieldname`,``);let r=Q(e,`spatialreference`);r&&(a.layerDefinition.spatialReference=Ze(r));let i=[],s=Q(e,`fields`,null);if(!o(s))throw new g(t,`InvalidParameter`,n);for(let e of s){let t={name:Q(e,`name`,``),alias:Q(e,`alias`,``),type:Q(e,`type`,``),nullable:Q(e,`nullable`,!0),editable:Q(e,`editable`,!0),length:Q(e,`length`,null),domain:Xe(Q(e,`domain`))};i.push(t)}a.layerDefinition.fields=i;let c={};for(let e of i)c[e.name.toLowerCase()]=e.name;let l=Q(e,`features`,null);if(o(l))for(let e of l){let t={},n=Q(e,`attributes`,{});for(let e in n)t[c[e.toLowerCase()]]=n[e];a.featureSet.features.push({attributes:t,geometry:Qe(Q(e,`geometry`,null))})}else l=null,a.featureSet.features=l}}}if(!1===et(a))throw new g(t,`InvalidParameter`,n);return a.layerDefinition.geometryType||(a.layerDefinition.geometryType=`esriGeometryNull`),ye.create(a,t.spatialReference)})},e.signatures.push({name:`featureset`,min:1,max:1}),e.functions.filter=function(n,r){return e.standardFunctionAsync(n,r,async(i,a,s)=>{if(C(s,2,2,n,r),o(s[0])||A(s[0])){let e=[],i,a=s[0];if(a instanceof ee&&(a=a.toArray()),!T(s[1]))throw new g(n,`InvalidParameter`,r);i=s[1].createFunction(n);for(let n of a){let r=i(n);t(r)?!0===await r&&e.push(n):!0===r&&e.push(n)}return e}if(N(s[0])){let t=await s[0].load(),r=V.create(s[1],{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),i=r.getVariables();if(i.length>0){let t={};for(let r of i)t[r]=e.evaluateIdentifier(n,{name:r});r.parameters=t}return new H({parentfeatureset:s[0],whereclause:r})}throw new g(n,`InvalidParameter`,r)})},e.signatures.push({name:`filter`,min:2,max:2}),e.functions.orderby=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{if(C(i,2,2,t,n),N(i[0])){let e=new Ve(i[1]);return new ze({parentfeatureset:i[0],orderbyclause:e})}throw new g(t,`InvalidParameter`,n)})},e.signatures.push({name:`orderby`,min:2,max:2}),e.functions.top=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{if(C(i,2,2,t,n),N(i[0]))return new qe({parentfeatureset:i[0],topnum:i[1]});if(o(i[0]))return D(i[1])>=i[0].length?i[0].slice():i[0].slice(0,D(i[1]));if(A(i[0]))return D(i[1])>=i[0].length()?i[0].slice():i[0].slice(0,D(i[1]));throw new g(t,`InvalidParameter`,n)})},e.signatures.push({name:`top`,min:2,max:2}),e.functions.first=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{if(C(i,1,1,t,n),N(i[0])){let n=await i[0].first(e.abortSignal);if(n!==null){let e=se.createFromGraphicLikeObject(n.geometry,n.attributes,i[0],t.timeZone);return e._underlyingGraphic=n,e}return n}return o(i[0])?i[0].length===0?null:i[0][0]:A(i[0])?i[0].length()===0?null:i[0].get(0):null})},e.signatures.push({name:`first`,min:1,max:1}),e.functions.attachments=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{C(i,1,2,t,n);let a={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(i.length>1){if(i[1]instanceof P){if(i[1].hasField(`minsize`)&&(a.minsize=D(i[1].field(`minsize`))),i[1].hasField(`metadata`)&&(a.returnMetadata=j(i[1].field(`metadata`))),i[1].hasField(`maxsize`)&&(a.maxsize=D(i[1].field(`maxsize`))),i[1].hasField(`types`)){let e=y(i[1].field(`types`),!1);e.length>0&&(a.types=e)}}else if(i[1]!==null)throw new g(t,`InvalidParameter`,n)}if(k(i[0])){let e=i[0]._layer,n;if(N(e))n=e;else{if(e==null||!F(e))return[];n=me(e,t.spatialReference,[`*`],!0,t.lrucache,t.interceptor)}return await n.load(),n.queryAttachments(i[0].field(n.objectIdField),a.minsize,a.maxsize,a.types,a.returnMetadata)}if(i[0]===null)return[];throw new g(t,`InvalidParameter`,n)})},e.signatures.push({name:`attachments`,min:1,max:2}),e.functions.featuresetbyrelationshipname=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{C(i,2,4,t,n);let a=i[0],s=b(i[1]),c=O(i[2],null),l=j(O(i[3],!0));if(c===null&&(c=[`*`]),!1===o(c))throw new g(t,`InvalidParameter`,n);if(i[0]===null)return null;if(!k(i[0]))throw new g(t,`InvalidParameter`,n);let u=a._layer,d;if(N(u))d=u;else{if(u==null||!F(u))return null;d=me(u,t.spatialReference,[`*`],!0,t.lrucache,t.interceptor)}d=await d.load();let f=d.relationshipMetadata().filter(e=>e.name===s);if(f.length===0)return null;if(f[0].relationshipTableId!==void 0&&f[0].relationshipTableId!==null&&f[0].relationshipTableId>-1)return _e(d,f[0],a.field(d.objectIdField),d.spatialReference,c,l,t.lrucache,t.interceptor);let p=d.serviceUrl();if(!p)return null;p=p.endsWith(`/`)?p+f[0].relatedTableId.toString():p+`/`+f[0].relatedTableId.toString();let m=await ve(p,d.spatialReference,c,l,t.lrucache,t.interceptor);await m.load();let h=m.relationshipMetadata();if(h=h.filter(e=>e.id===f[0].id),!1===a.hasField(f[0].keyField)||a.field(f[0].keyField)===null){let e=await d.getFeatureByObjectId(a.field(d.objectIdField),[f[0].keyField]);if(e){let t=V.create(h[0].keyField+`= @id`,{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return t.parameters={id:e.attributes[f[0].keyField]},new H({parentfeatureset:m,whereclause:t})}return new Pe({parentfeatureset:m})}let _=V.create(h[0].keyField+`= @id`,{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return _.parameters={id:a.field(f[0].keyField)},new H({parentfeatureset:m,whereclause:_})})},e.signatures.push({name:`featuresetbyrelationshipname`,min:2,max:4}),e.functions.featuresetbyassociation=function(t,a){return e.standardFunctionAsync(t,a,async(e,o,s)=>{C(s,2,3,t,a);let c=s[0],u=r(b(O(s[1],``))),d=l(s[2])?b(s[2]):null;if(s[0]===null)return null;if(!k(s[0]))throw new g(t,`InvalidParameter`,a);let f=c._layer;if(f instanceof i&&(f=me(f,t.spatialReference,[`*`],!0,t.lrucache,t.interceptor)),f===null||!1===N(f))return null;await f.load();let p=f.serviceUrl(),m=await he(p,t.spatialReference,!0);if(m.unVersion>=8)return await tt(f,c,u,d,m,t,a);let h=m.associations,_=null,v=null,ee=!1;if(d!==null&&d!==``&&d!==void 0){for(let e of m.terminals)e.terminalName===d&&(v=e.terminalId);v===null&&(ee=!0)}let y=h.getFieldsIndex(),x=y.get(`TOGLOBALID`).name,S=y.get(`FROMGLOBALID`).name,ne=y.get(`TOTERMINALID`).name,w=y.get(`FROMTERMINALID`).name,T=y.get(`FROMNETWORKSOURCEID`).name,E=y.get(`TONETWORKSOURCEID`).name,D=y.get(`ASSOCIATIONTYPE`).name,A=y.get(`ISCONTENTVISIBLE`).name,j=y.get(`OBJECTID`).name;for(let e of f.fields)if(e.type===`global-id`){_=c.field(e.name);break}let M=null,P=new X(new n({name:`percentalong`,alias:`percentalong`,type:`double`}),V.create(`0`,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC})),re=new X(new n({name:`side`,alias:`side`,type:`string`}),V.create(`''`,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC})),F=`globalid`,ie=`globalId`,I={};for(let e in m.lkp)I[e]=m.lkp[e].sourceId;let L=new Re(new n({name:`classname`,alias:`classname`,type:`string`}),null,I),z=``;switch(u){case`midspan`:{z=`((${x}='${_}') OR ( ${S}='${_}')) AND (${D} IN (5))`,L.codefield=V.create(`CASE WHEN (${x}='${_}') THEN ${T} ELSE ${E} END`,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC});let e=R(Z.findField(h.fields,S));e.name=F,e.alias=F,M=new X(e,V.create(`CASE WHEN (${S}='${_}') THEN ${x} ELSE ${S} END`,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC})),P=m.unVersion>=4?new J(Z.findField(h.fields,y.get(`PERCENTALONG`).name)):new X(new n({name:`percentalong`,alias:`percentalong`,type:`double`}),V.create(`0`,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC}));break}case`junctionedge`:{z=`((${x}='${_}') OR ( ${S}='${_}')) AND (${D} IN (4,6))`,L.codefield=V.create(`CASE WHEN (${x}='${_}') THEN ${T} ELSE ${E} END`,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC});let e=R(Z.findField(h.fields,S));e.name=F,e.alias=F,M=new X(e,V.create(`CASE WHEN (${S}='${_}') THEN ${x} ELSE ${S} END`,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC})),re=new X(new n({name:`side`,alias:`side`,type:`string`}),V.create(`CASE WHEN (${D}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC}));break}case`connected`:{let e=`${x}='@T'`,t=`${S}='@T'`;v!==null&&(e+=` AND ${ne}=@A`,t+=` AND ${w}=@A`),z=`((`+e+`) OR (`+t+`))`,z=te(z,`@T`,_??``),e=te(e,`@T`,_??``),v!==null&&(e=te(e,`@A`,v.toString()),z=te(z,`@A`,v.toString())),L.codefield=V.create(`CASE WHEN `+e+` THEN ${T} ELSE ${E} END`,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC});let n=R(Z.findField(h.fields,S));n.name=F,n.alias=F,M=new X(n,V.create(`CASE WHEN `+e+` THEN ${S} ELSE ${x} END`,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC}));break}case`container`:z=`${x}='${_}' AND ${D} = 2`,v!==null&&(z+=` AND ${ne} = `+v.toString()),L.codefield=T,z=`( `+z+` )`,M=new Y(Z.findField(h.fields,S),F,F);break;case`content`:z=`(${S}='${_}' AND ${D} = 2)`,v!==null&&(z+=` AND ${w} = `+v.toString()),L.codefield=E,z=`( `+z+` )`,M=new Y(Z.findField(h.fields,x),F,F);break;case`structure`:z=`(${x}='${_}' AND ${D} = 3)`,v!==null&&(z+=` AND ${ne} = `+v.toString()),L.codefield=T,z=`( `+z+` )`,M=new Y(Z.findField(h.fields,S),F,ie);break;case`attached`:z=`(${S}='${_}' AND ${D} = 3)`,v!==null&&(z+=` AND ${w} = `+v.toString()),L.codefield=E,z=`( `+z+` )`,M=new Y(Z.findField(h.fields,x),F,ie);break;default:throw new g(t,`InvalidParameter`,a)}return ee&&(z=`1 <> 1`),new Z({parentfeatureset:h,adaptedFields:[new J(Z.findField(h.fields,j)),new J(Z.findField(h.fields,A)),M,re,L,P],extraFilter:z?V.create(z,{fieldsIndex:h.getFieldsIndex(),timeZone:h.dateFieldsTimeZoneDefaultUTC}):null})})},e.signatures.push({name:`featuresetbyassociation`,min:2,max:6}),e.functions.groupby=function(t,n){return e.standardFunctionAsync(t,n,async(r,i,a)=>{if(C(a,3,3,t,n),!N(a[0]))throw new g(t,`InvalidParameter`,n);let s=await a[0].load(),c=[],u=[],d=!1,f=[];if(l(a[1]))f.push(a[1]);else if(a[1]instanceof P)f.push(a[1]);else if(o(a[1]))f=a[1];else{if(!A(a[1]))throw new g(t,`InvalidParameter`,n);f=a[1].toArray()}for(let e of f)if(l(e)){let t=V.create(b(e),{fieldsIndex:s.getFieldsIndex(),timeZone:s.dateFieldsTimeZoneDefaultUTC}),n=!0===Me(t)?b(e):`%%%%FIELDNAME`;c.push({name:n,expression:t}),n===`%%%%FIELDNAME`&&(d=!0)}else{if(!(e instanceof P))throw new g(t,`InvalidParameter`,n);{let r=e.hasField(`name`)?e.field(`name`):`%%%%FIELDNAME`,i=e.hasField(`expression`)?e.field(`expression`):``;if(r===`%%%%FIELDNAME`&&(d=!0),!r)throw new g(t,`InvalidParameter`,n);c.push({name:r,expression:V.create(i||r,{fieldsIndex:s.getFieldsIndex(),timeZone:s.dateFieldsTimeZoneDefaultUTC})})}}if(f=[],l(a[2]))f.push(a[2]);else if(o(a[2]))f=a[2];else if(A(a[2]))f=a[2].toArray();else{if(!(a[2]instanceof P))throw new g(t,`InvalidParameter`,n);f.push(a[2])}for(let e of f){if(!(e instanceof P))throw new g(t,`InvalidParameter`,n);{let r=e.hasField(`name`)?e.field(`name`):``,i=e.hasField(`statistic`)?e.field(`statistic`):``,a=e.hasField(`expression`)?e.field(`expression`):``;if(!(r&&i&&l(i)&&a))throw new g(t,`InvalidParameter`,n);u.push({name:r,statistic:i,expression:V.create(a,{fieldsIndex:s.getFieldsIndex(),timeZone:s.dateFieldsTimeZoneDefaultUTC})})}}if(d){let e={};for(let t of s.fields)e[t.name.toLowerCase()]=1;for(let t of c)t.name!==`%%%%FIELDNAME`&&(e[t.name.toLowerCase()]=1);for(let t of u)t.name!==`%%%%FIELDNAME`&&(e[t.name.toLowerCase()]=1);let t=0;for(let n of c)if(n.name===`%%%%FIELDNAME`){for(;e[`field_`+t.toString()]===1;)t++;e[`field_`+t.toString()]=1,n.name=`FIELD_`+t.toString()}}for(let n of c)Ye(n.expression,e,t);for(let n of u)Ye(n.expression,e,t);return new Ge({parentfeatureset:a[0],groupbyfields:c,statsfields:u})})},e.signatures.push({name:`groupby`,min:3,max:3}),e.functions.distinct=function(t,n){return e.standardFunctionAsync(t,n,async(r,i,a)=>{if(N(a[0])){C(a,2,2,t,n);let r=await a[0].load(),i=[],s=[];if(l(a[1]))s.push(a[1]);else if(a[1]instanceof P)s.push(a[1]);else if(o(a[1]))s=a[1];else{if(!A(a[1]))throw new g(t,`InvalidParameter`,n);s=a[1].toArray()}let c=!1;for(let e of s)if(l(e)){let t=V.create(b(e),{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}),n=!0===Me(t)?b(e):`%%%%FIELDNAME`;i.push({name:n,expression:t}),n===`%%%%FIELDNAME`&&(c=!0)}else{if(!(e instanceof P))throw new g(t,`InvalidParameter`,n);{let a=e.hasField(`name`)?e.field(`name`):`%%%%FIELDNAME`,o=e.hasField(`expression`)?e.field(`expression`):``;if(a===`%%%%FIELDNAME`&&(c=!0),!a)throw new g(t,`InvalidParameter`,n);i.push({name:a,expression:V.create(o||a,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})})}}if(c){let e={};for(let t of r.fields)e[t.name.toLowerCase()]=1;for(let t of i)t.name!==`%%%%FIELDNAME`&&(e[t.name.toLowerCase()]=1);let t=0;for(let n of i)if(n.name===`%%%%FIELDNAME`){for(;e[`field_`+t.toString()]===1;)t++;e[`field_`+t.toString()]=1,n.name=`FIELD_`+t.toString()}}for(let n of i)Ye(n.expression,e,t);return new Ge({parentfeatureset:a[0],groupbyfields:i,statsfields:[]})}return Je(a)})},e.functions.getfeaturesetinfo=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{if(C(i,1,1,t,n),!N(i[0]))return null;let a=await i[0].getFeatureSetInfo();return a?P.convertObjectToArcadeDictionary({layerId:a.layerId,layerName:a.layerName,itemId:a.itemId,serviceLayerUrl:a.serviceLayerUrl,webMapLayerId:a.webMapLayerId??null,webMapLayerTitle:a.webMapLayerTitle??null,className:null,objectClassId:null},re(t),!1,!1):null})},e.signatures.push({name:`getfeaturesetinfo`,min:1,max:1}),e.functions.filterbysubtypecode=function(t,n){return e.standardFunctionAsync(t,n,async(e,r,i)=>{if(C(i,2,2,t,n),N(i[0])){let e=await i[0].load(),r=i[1];if(!m(r))throw new g(t,`InvalidParameter`,n);if(e.subtypeField){let t=V.create(`${e.subtypeField}= ${i[1]}`,{fieldsIndex:e.getFieldsIndex(),timeZone:e.dateFieldsTimeZoneDefaultUTC});return new H({parentfeatureset:i[0],whereclause:t})}if(e.typeIdField===null||e.typeIdField===``)throw new g(t,`FeatureSetDoesNotHaveSubtypes`,n);let a=V.create(`${e.typeIdField}= ${i[1]}`,{fieldsIndex:e.getFieldsIndex(),timeZone:e.dateFieldsTimeZoneDefaultUTC});return new H({parentfeatureset:i[0],whereclause:a})}throw new g(t,`InvalidParameter`,n)})},e.signatures.push({name:`filterbysubtypecode`,min:2,max:2})}}export{nt as registerFunctions};