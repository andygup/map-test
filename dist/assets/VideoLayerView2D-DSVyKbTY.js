import{BT as e,Bv as t,Ex as n,Kg as r,Ld as i,MT as a,Od as o,Pd as s,Rd as c,Uu as l,VT as u,Vd as d,_s as f,dg as p,dv as m,jT as h,kD as g,kT as _,ph as v,pv as y,uv as b,vT as x,ys as S}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import"./streamLayerUtils-82UmlW-3.js";import"./QueueProcessor-D6ozkjY6.js";import"./earcut-CEMcWA4Z.js";import"./layerViewUtils-CJcMVuwG.js";import"./colorUtils-CzajW9E7.js";import{t as C}from"./cimSymbolUtils-CLt57XQ8.js";import"./utils-BGjabRH0.js";import{t as w}from"./GraphicsLayer-DBcl42yN.js";import"./timeSupport-vK4lVcYW.js";import"./queryUtils-DGU5ISbw.js";import{t as T}from"./ControlPoint-CrbdjHAy.js";import"./normalizeUtilsSync-TXjrdJAe.js";import"./GeometryUtils-B-8QW9FG.js";import"./VertexAttributeLocations-BScEla0R.js";import"./VertexElementDescriptor-Cl_nC_ty.js";import{c as E,p as D}from"./videoUtils-BIrmQXOu.js";import"./labelPoint-1O-zXr9b.js";import"./callExpressionWithCursor-CKz4lb1p.js";import"./FeatureMetadata-rc_NIaUe.js";import"./CIMSymbolHelper-B2DBxDPE.js";import"./rasterizingUtils-BsmZb-O9.js";import"./Rect-LbcnjDUG.js";import"./BoundingBox-Dtf81F-g.js";import"./BidiEngine-DvXbVJau.js";import"./callExpressionWithFeature-UlbvTUQ4.js";import"./OverrideHelper-BahbnLvz.js";import"./FeatureCommandQueue-2UJWGVaq.js";import"./config-Dk3C6lVr.js";import"./dehydratedFeatureComparison-BCFMkftR.js";import"./WGLContainer-jm6ZclzQ.js";import"./utils-B0heZPZY.js";import"./ProgramTemplate-B9k_04Md.js";import"./VertexArrayObject-ChtD6bwg.js";import"./BufferObject-B3_aJU6V.js";import"./VertexBuffer-Ra4pb4dR.js";import"./vec3f32-DDMWoxUL.js";import{r as O}from"./Container-uEjPEzbR.js";import"./GraphShaderModule-AgkKIWM0.js";import"./FramebufferObject-BoYk_2uK.js";import"./ShaderBuilder-BLOqjpgt.js";import{n as k,t as A}from"./LayerView2D-Bgb1zyoa.js";import{t as j}from"./LayerView-DQaVI2FN.js";import"./UpdateTracking2D-BMTZzgpI.js";import"./TechniqueInstance-fDAaVtEH.js";import"./TileContainer-BL1bFhTv.js";import"./constants-BOI_CTg-.js";import"./utils-DmZFjYOb.js";import"./AGraphicContainer-DHUNjrd-.js";import{t as M}from"./GraphicContainer-fLr16fKu.js";import"./ComputedAttributeStorage-BgTqXVQM.js";import{t as N}from"./GraphicsView2D-CUXbaTHc.js";import"./dehydratedFeatures-D5ZOMtMh.js";import"./utils-URbtRPi5.js";import{t as P}from"./OverlayContainer-YNTpBXDF.js";var F=2,I=class extends O{constructor(e){super(),this.element=e,this._handles=new a,this.isWrapAround=!1,this.perspectiveTransform=l(),this.wrapAroundShift=0,this.clipGeometry=null,this._handles.add(b(()=>this.element,()=>{let e=this.element;this.ready(),e&&this._handles.add(x(e,`play`,()=>this.requestRender()))},m))}getMesh(e){throw Error(`Method not implemented.`)}destroy(){super.destroy(),this._handles.destroy(),this.texture=_(this.texture)}get textureSize(){if(!this.texture)return[1,1];let e=this.texture.descriptor;return[e.width,e.height]}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){let t=this.element;if(t==null)return;let{context:n}=e,{videoWidth:r,videoHeight:i}=t;if(r!==0&&i!==0){if(this.texture)t.paused||e.animationsEnabled&&this.texture.setData(t);else{let e=new S(r,i);e.wrapMode=33071,e.preMultiplyAlpha=!0,this.texture=new f(n,e,t)}t.paused||this.texture.generateMipmap(),super.beforeRender(e)}}_createTransforms(){return null}updateDrawCoords(e,n,i,a){let o=this.element,s=this._getFrameInfo();if(!o||!s)return;let{spatialReference:c}=i;this._initializeData(e,s,c);let{controlPoints:l,horizon:u}=s,d=Math.sqrt(l.length),f=d,{x:p,y:m}=e,h=this._vertices,g=l[0],_=l[d-1],v=l[(f-1)*d],y=l[(f-1)*d+d-1],b=r(u?u[0].mapPoint:g.mapPoint,c),x=r(u?u[1].mapPoint:_.mapPoint,c),S=r(v.mapPoint,c),C=r(y.mapPoint,c);this.clipGeometry=u?new k({geometry:t.fromJSON({rings:[[[S.x,S.y],[C.x,C.y],[x.x,x.y],[b.x,b.y],[S.x,S.y]]],spatialReference:c})}):null;for(let e=0;e<l.length;e++){let t=l[e],{sourcePoint:n,mapPoint:i}=t;if(n==null||i==null)continue;let a=r(i,c);h[e*F+0]=a.x-p,h[e*F+1]=a.y-m}let w=n;if(a){let e=Math.min(b.x,x.x,S.x,C.x),t=Math.max(b.x,x.x,S.x,C.x),{worldWidth:n,xBounds:r}=a,[i,o]=r;e<i&&t>i?w=n:t>o&&e<o&&(w=-n)}this.wrapAroundShift=w,this.isWrapAround=w!==0}draw(e,t){if(this.visible){if(!(this.isReady&&this._vertices&&this._indices&&this._texCoords))return void this.requestRender();this.stage||console.warn(`OverlayMultipoint: stage is null`),t.render(e,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:this.textureSize,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._texCoords,index:this._indices})}}_initializeData(e,t,n){if(this._vertices!=null&&this._indices!=null)return;let{controlPoints:i}=t,a=Math.sqrt(i.length),o=a,s=new Float32Array(F*i.length),c=new Uint16Array(2*i.length);for(let t=0;t<i.length;t++){let a=i[t],{sourcePoint:o,mapPoint:l}=a;if(o==null||l==null)continue;let u=r(l,n);s[t*F+0]=u.x-e.x,s[t*F+1]=u.y-e.y,c[2*t+0]=o.x,c[2*t+1]=o.y}let l=new Uint16Array(o*a+(o-2)*(a+2)),u=0;for(let e=0;e<o;e++){for(let t=0;t<a;t++)l[u++]=e*a+t,l[u++]=(e+1)*a+t;e<o-2&&(l[u++]=(e+1)*a+(a-1),l[u++]=(e+1)*a)}this._vertices=s,this._texCoords=c,this._indices=l}_getFrameInfo(){if(!this.groundControlPoints)return null;let e=this._getFrameControlPoints(),t=this.frameHorizonPoints,r=null;if(t){let e=t.startX,i=t.startY,a=t.endX,o=t.endY;r=[new T({sourcePoint:p(e,i),mapPoint:new n(t.startLongitude,t.startLatitude)}),new T({sourcePoint:p(a,o),mapPoint:new n(t.endLongitude,t.endLatitude)})]}return{controlPoints:e,horizon:r}}_getFrameControlPoints(){let e=this.groundControlPoints,t=e?.length;if(!t)return[];let r=Array(t),i=Math.max(...e.map(({x:e})=>e)),a=this.element.videoWidth/i;for(let i=0;i<t;i++){let{x:t,y:o,lat:s,lon:c}=e[i];r[i]=new T({sourcePoint:p(t*a,-o*a),mapPoint:new n(c,s)})}return r}},L=new v([255,127,0]),R=10005,z=10018,B=class extends A(j){constructor(){super(...arguments),this._graphicsLayer=new w,this._frameOutlineGraphic=new o({symbol:new c({outline:{type:`simple-line`,color:L}})}),this._frameCenterGraphic=new o({symbol:new i({color:L,style:`cross`})}),this._sensorTrailGraphic=new o({symbol:new d({color:L})}),this._sensorSightlineGraphic=new o({symbol:new d({color:L})}),this._sensorLocationGraphic=new o({symbol:new i({color:L})}),this._overlayContainer=null,this._sensorLocationSymbolType=null,this.layer=null,this.sensorLocationSymbol=null,this.symbolAngle=0,this.visibleTelemetryElements=null}destroy(){this._graphicsLayer=h(this._graphicsLayer)}initialize(){this._sensorLocationSymbolType=this.layer?.sensorSymbol.type,this._graphicsLayer.graphics.addMany([this._frameCenterGraphic,this._frameOutlineGraphic,this._sensorLocationGraphic,this._sensorSightlineGraphic,this._sensorTrailGraphic]),this.visibleTelemetryElements=new D({frame:this.layer.telemetryDisplay?.frame??!1,frameCenter:this.layer.telemetryDisplay?.frameCenter??!0,frameOutline:this.layer.telemetryDisplay?.frameOutline??!0,lineOfSight:this.layer.telemetryDisplay?.lineOfSight??!0,sensorLocation:this.layer.telemetryDisplay?.sensorLocation??!0,sensorTrail:this.layer.telemetryDisplay?.sensorTrail??!0})}attach(){this._overlayContainer=new P,this.container.addChild(this._overlayContainer),this._addOverlayMultipoint(),this.graphicsView=new N({requestUpdateCallback:()=>this.requestUpdate(),view:this.view,graphics:this._graphicsLayer.graphics,container:new M(this.view.featuresTilingScheme)}),this.container.addChild(this.graphicsView.container),this.addAttachHandles(this._graphicsLayer.on(`graphic-update`,this.graphicsView.graphicUpdateHandler)),this.addAttachHandles([y(()=>[this.layer.telemetryDisplay?.frame,this.layer.telemetryDisplay?.frameCenter,this.layer.telemetryDisplay?.frameOutline,this.layer.telemetryDisplay?.sensorLocation,this.layer.telemetryDisplay?.sensorTrail,this.layer.telemetryDisplay?.lineOfSight],()=>this._updateVisibleTelemetryElements(),m),y(()=>[this.layer.telemetry,this.visibleTelemetryElements?.frameCenter,this.visibleTelemetryElements?.frameOutline,this.visibleTelemetryElements?.sensorLocation,this.visibleTelemetryElements?.sensorTrail,this.visibleTelemetryElements?.lineOfSight],()=>this._updateGraphicGeometries(),m),y(()=>this.layer.metadata,()=>this._updateSensorLocationSymbolAngle(),m),y(()=>this.layer?.frameCenterSymbol,()=>this._updateFrameCenterSymbol(),m),y(()=>this.layer?.frameOutlineSymbol,()=>this._updateFrameOutlineSymbol(),m),y(()=>this.layer?.sensorSightLineSymbol,()=>this._updateSensorSightlineSymbol(),m),y(()=>this.layer?.sensorSymbol,()=>this._updateSensorLocationSymbol(),m),y(()=>this.layer?.sensorTrailSymbol,()=>this._updateSensorTrailSymbol(),m),y(()=>this.symbolAngle,()=>this._updateSensorLocationSymbol(),m)])}detach(){this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this.graphicsView=h(this.graphicsView)}supportsSpatialReference(e){return!0}moveEnd(){}viewChange(){this.graphicsView.viewChange()}update(e){this.graphicsView.processUpdate(e)}isUpdating(){return!this.graphicsView||this.graphicsView.updating}_updateVisibleTelemetryElements(){this.view.animationsEnabled&&this.visibleTelemetryElements&&this.layer.telemetryDisplay&&(this.visibleTelemetryElements.frame=this.layer.telemetryDisplay.frame,this.visibleTelemetryElements.frameCenter=this.layer.telemetryDisplay.frameCenter,this.visibleTelemetryElements.frameOutline=this.layer.telemetryDisplay.frameOutline,this.visibleTelemetryElements.lineOfSight=this.layer.telemetryDisplay.lineOfSight,this.visibleTelemetryElements.sensorLocation=this.layer.telemetryDisplay.sensorLocation,this.visibleTelemetryElements.sensorTrail=this.layer.telemetryDisplay.sensorTrail)}_updateGraphicGeometries(){if(!this.view.animationsEnabled)return;let{telemetry:e}=this.layer,{visibleTelemetryElements:t}=this;e&&t&&(t.frameOutline&&e.frameOutline?this._frameOutlineGraphic.geometry=this.layer.telemetry.frameOutline:this._frameOutlineGraphic.geometry=null,t.sensorTrail&&e.sensorTrail?this._sensorTrailGraphic.geometry=this.layer.telemetry.sensorTrail:this._sensorTrailGraphic.geometry=null,t.lineOfSight&&e.lineOfSight?this._sensorSightlineGraphic.geometry=this.layer.telemetry.lineOfSight:this._sensorSightlineGraphic.geometry=null,t.sensorLocation&&e.sensorLocation?this._sensorLocationGraphic.geometry=this.layer.telemetry.sensorLocation:this._sensorLocationGraphic.geometry=null,t.frameCenter&&e.frameCenter?this._frameCenterGraphic.geometry=this.layer.telemetry.frameCenter:this._frameCenterGraphic.geometry=null)}_updateSensorLocationSymbolAngle(){if(!this.view.animationsEnabled||!this.layer?.metadata?.size)return;let{source:e,symbolOffset:t=0}=this.layer.sensorSymbolOrientation||{};if(!e&&!t)return;let n=this.layer?.metadata?.get(R)?.value??0,r=this.layer?.metadata?.get(z)?.value??0,i=E({cameraAzimuth:r,platformHeading:n,source:this.layer.sensorSymbolOrientation?.source,symbolOffset:this.layer.sensorSymbolOrientation?.symbolOffset??0});this.symbolAngle=Math.round(Math.abs(i))}_updateSensorLocationSymbol(){switch(this._sensorLocationSymbolType){case`simple-marker`:this.sensorLocationSymbol=this.layer.sensorSymbol.clone(),this.sensorLocationSymbol.angle=this.symbolAngle,this._sensorLocationGraphic.symbol=this.sensorLocationSymbol.clone();break;case`picture-marker`:this.sensorLocationSymbol=this.layer.sensorSymbol,this.sensorLocationSymbol.angle=this.symbolAngle,this._sensorLocationGraphic.symbol=this.sensorLocationSymbol;break;case`cim`:this.sensorLocationSymbol=this.layer.sensorSymbol,C(this.sensorLocationSymbol,this.symbolAngle,!0),this._sensorLocationGraphic.symbol=this.sensorLocationSymbol}}_updateFrameCenterSymbol(){this.layer?.frameCenterSymbol&&(this._frameCenterGraphic.symbol=this.layer.frameCenterSymbol.clone())}_updateFrameOutlineSymbol(){this.layer?.frameOutlineSymbol&&(this._frameOutlineGraphic.symbol=this.layer.frameOutlineSymbol.clone())}_updateSensorSightlineSymbol(){this.layer?.sensorSightLineSymbol&&(this._sensorSightlineGraphic.symbol=this.layer.sensorSightLineSymbol.clone())}_updateSensorTrailSymbol(){this.layer?.sensorTrailSymbol&&(this._sensorTrailGraphic.symbol=this.layer.sensorTrailSymbol.clone())}async _addOverlayMultipoint(){if(!this.layer.videoElement)return;let e=new I(this.layer.videoElement);this.addAttachHandles([y(()=>[this.layer.frameHorizonPoints,this.layer.groundControlPoints,this.layer.frameOpacity,this.layer.telemetryDisplay?.frame],()=>{if(!this.view.animationsEnabled)return;let{visibleTelemetryElements:t}=this;e.frameHorizonPoints=this.layer.frameHorizonPoints,e.groundControlPoints=this.layer.groundControlPoints,e.opacity=this.layer.frameOpacity,e.visible=t?.frame??!1},m)]),this._overlayContainer.addChild(e),this.view.stage.requestRender()}};g([e()],B.prototype,`graphicsView`,void 0),g([e()],B.prototype,`layer`,void 0),g([e({types:s})],B.prototype,`sensorLocationSymbol`,void 0),g([e()],B.prototype,`symbolAngle`,void 0),g([e({type:D})],B.prototype,`visibleTelemetryElements`,void 0),B=g([u(`esri.views.2d.layers.VideoLayerView2D`)],B);var V=B;export{V as default};