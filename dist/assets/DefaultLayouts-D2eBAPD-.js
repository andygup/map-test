const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/HighlightApply.glsl-DuqK6J4a.js","assets/HighlightApply.glsl-C2uw2Uqi.js","assets/HighlightDownsample.glsl-CHTjOIMl.js","assets/ScreenSpacePass.glsl-QJ_LkLYn.js","assets/glsl-BMw-Ib6r.js","assets/NoParameters-BDE7RvXT.js","assets/ShaderBuilder-BLOqjpgt.js","assets/index-BN8X5Ryz.js","assets/index-CWJhHB6-.css","assets/Uniform-C_fuiTP5.js","assets/HighlightCellGridScreenSpacePass.glsl-BYepSulG.js","assets/IntegerPassUniform-CdQB44QJ.js","assets/HighlightReadBitmap.glsl-BBr-esSE.js","assets/Float2DrawUniform-3WoZLC1o.js","assets/FloatPassUniform-CSAt82xV.js","assets/Texture2DPassUniform-DFWoDpEL.js","assets/HighlightBlur.glsl-BsdmCFFV.js","assets/HighlightBlur.glsl-Bcasx3G3.js","assets/Texture2DDrawUniform-jqrXjxoW.js","assets/HighlightDownsample.glsl-CsEEdBfN.js","assets/HighlightToSingle.glsl-Bzk90e1b.js","assets/HighlightToSingle.glsl-DnQ7SOsv.js","assets/TextureOnly.glsl-CDYz7roi.js","assets/TextureOnly.glsl-DvvGRcsb.js","assets/Float3PassUniform-SaBA6LBM.js","assets/OverlayCompositing.glsl-DY8eGV0d.js","assets/OverlayCompositing.glsl-qGsngx-I.js","assets/ColorMaterial.glsl-DIWNJ4ry.js","assets/ColorMaterial.glsl-Bt7WM1mm.js","assets/Transform.glsl-2U1BxklA.js","assets/Float2BindUniform-D7Jg9GMR.js","assets/FloatBindUniform-CXY5KrrB.js","assets/Slice.glsl-DU3Ivhcc.js","assets/Float3DrawUniform-ua6q6ZtZ.js","assets/VisualVariables.glsl-1DqsizMu.js","assets/FloatsPassUniform-DKsLDw29.js","assets/AlphaCutoff-WIqqBGOV.js","assets/Texture2DBindUniform-Btzx3XRx.js","assets/Float4PassUniform-C4TO8dd0.js","assets/ObjectAndLayerIdColor.glsl-BHzrt-xI.js","assets/VertexColor.glsl-_MhPfHih.js","assets/TerrainDepthTest.glsl-D7e23Ppb.js","assets/ReadDepth.glsl-CX2bpX_x.js","assets/View.glsl-CPcmVaet.js","assets/Float3BindUniform-BDFedz_d.js","assets/Matrix4BindUniform-D7U89BGU.js","assets/OutputColorHighlightOLID.glsl-CoP020fC.js","assets/Emissions.glsl-C_Yvv-sZ.js"])))=>i.map(i=>d[i]);
import{$S as e,AT as t,Aw as n,BT as r,Bb as i,CD as a,CE as o,Db as s,ED as c,Eb as l,Fb as u,Fl as d,Fm as f,Gf as p,Hl as m,Iw as h,J as ee,Jf as g,Jm as te,Kl as _,Kw as v,Lm as y,Ls as ne,Mw as re,Nb as b,Nl as ie,Nm as ae,Ns as oe,Qb as se,Ql as ce,Rb as le,Rl as ue,Rm as de,Rs as fe,Ry as pe,Sw as me,Uf as he,Um as ge,Uu as x,VT as S,Vb as _e,Vl as ve,Wm as ye,Xf as C,Z as be,Zl as xe,Zm as Se,_s as Ce,_t as we,_v as Te,ad as Ee,ax as De,dD as Oe,dv as ke,g_ as Ae,gl as je,hl as Me,hw as Ne,ig as Pe,jb as w,kD as T,kT as Fe,kb as E,kl as Ie,lv as Le,mt as Re,mv as ze,mx as Be,n_ as Ve,nw as He,ot as Ue,pl as We,pv as D,ww as Ge,xE as Ke,x_ as qe,yE as Je,yT as Ye,y_ as Xe,ys as Ze,zb as O}from"./index-BN8X5Ryz.js";import{a as Qe,r as $e,s as et}from"./axisAngleDegrees-DzAS4tF-.js";import{D as tt}from"./plane-Da5EsY0J.js";import{n as nt}from"./triangulationUtils-DNxIB1ux.js";import{a as rt,n as it,o as at,t as k}from"./Util-BQgFCZvD.js";import{_ as ot,f as st,g as ct,i as lt,l as ut}from"./Emissions.glsl-C_Yvv-sZ.js";import{t as dt}from"./NoParameters-BDE7RvXT.js";import{n as ft,r as pt}from"./sphere-d9-4vNcj.js";import{t as mt}from"./VertexArrayObject-ChtD6bwg.js";import{t as ht}from"./BufferObject-B3_aJU6V.js";import{t as gt}from"./VertexBuffer-Ra4pb4dR.js";import{a as A,n as j,r as _t,u as vt}from"./renderState-BaFdYDAL.js";import{B as yt,E as bt,F as xt,I as St,N as Ct,O as wt,P as M,R as Tt,V as Et,a as Dt,c as Ot,o as kt,p as At,t as jt,u as Mt,z as Nt}from"./DefaultBufferWriter-BGKzMKkp.js";import{g as Pt,l as Ft,y as It}from"./ElevationContext-BzXFRbX1.js";import{a as N,c as Lt,i as Rt,l as zt,o as Bt,p as Vt,r as Ht,s as P,t as Ut}from"./SceneLighting-LJvcoD7s.js";import{a as F,s as I}from"./FloatArray-Dt98pDp2.js";import{d as Wt,f as Gt,i as Kt}from"./FloatsPassUniform-DKsLDw29.js";import{n as qt,t as Jt}from"./TextureOnly.glsl-DvvGRcsb.js";import{i as Yt,o as Xt,t as Zt}from"./HighlightDownsample.glsl-CHTjOIMl.js";import{t as Qt}from"./HighlightApply.glsl-C2uw2Uqi.js";import{r as $t,t as en}from"./HighlightBlur.glsl-Bcasx3G3.js";import{t as tn}from"./HighlightToSingle.glsl-DnQ7SOsv.js";import{t as nn}from"./NestedMap-BpsBVffk.js";import{t as rn}from"./AlphaCutoff-WIqqBGOV.js";import{n as an}from"./ManagedTexture-DgNSfAYU.js";import{n as on}from"./weather-D4qJROgB.js";import{n as sn,r as cn}from"./OverlayCompositing.glsl-qGsngx-I.js";import{n as ln}from"./ColorMaterial.glsl-Bt7WM1mm.js";import{t as un}from"./TextureBackedBufferLayout-C3PSJOOo.js";var dn=class extends mt{},fn=class{constructor(){this._extent=Be(),this.resolution=0,this.renderLocalOrigin=It(0,0,0,`O`),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new pn}get extent(){return this._extent}setExtent(e){Ue(this._extent,e)}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;let t=.001*e.range;if(this._extent[0]-t<=e.min){let t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];se(this._extent,e.range,0,t)}if(this._extent[2]+t>=e.max){let t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];se(this._extent,-e.range,0,t)}}_setupGeometryView(){this.canvasGeometries.numViews=1,De(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){let t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},pn=class{constructor(){this.extents=[Be(),Be(),Be()],this.numViews=0}},mn=class{constructor(e,t,n){this._fbos=e,this._format=t,this._name=n}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=t(this._handle)}get texture(){return this._handle?.getTexture()}ensureFramebuffer(e,t){this._handle&&this._handle.fbo?.width===e&&this._handle.fbo?.height===t||(this._handle?.release(),this._handle=this._fbos.acquire(e,t,this._name,this._format))}bind(e){e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}},L=class{constructor(e,t,n,r,i=1,a=6){this.output=n,this.content=r,this.redrawOnRequest=i,this.fbo=new mn(e,a,t)}handleRenderRequest(e){return e===1||e===this.redrawOnRequest}get valid(){return this.fbo.valid}},hn=class{constructor(e){this.targets=[new L(e,`overlay color`,0,0),new L(e,`overlay IM color`,0,1),new L(e,`overlay highlight`,8,2,1,3),new L(e,`overlay water`,2,3,0),new L(e,`overlay occluded`,0,4)],Wt()&&this.targets.push(new L(e,`overlay olid`,9,5,1,5))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(e){if(e!==0)for(let e of this.targets)e.fbo.dispose();else this.targets[3].fbo.dispose()}computeValidity(){return this.targets.reduce((e,t,n)=>t.valid?e|=1<<n:e,0)}},gn={required:[]},_n=class extends n{precompile(e){return!!this.acquireTechniques(e)}consumes(){return gn}get usedMemory(){return 0}get renderOccludedFlags(){return 1}get isDecoration(){return!1}get readyToRun(){return!1}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmitters(){return!1}forEachGeometry(e){}},vn=class extends _n{},yn=class extends _n{},bn=class extends N{constructor(t,n){super(t,n,Bt),this.shader=new P(Qt,()=>e(()=>import(`./HighlightApply.glsl-DuqK6J4a.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15])))}initializePipeline(){return j({blending:vt,colorWrite:A})}};bn=T([S(`esri.views.3d.webgl-engine.effects.highlight.HighlightApplyTechnique`)],bn);var xn=class extends N{constructor(t,n){super(t,n,Bt),this.shader=new P(en,()=>e(()=>import(`./HighlightBlur.glsl-BsdmCFFV.js`),__vite__mapDeps([16,17,7,8,10,2,3,4,5,6,9,11,13,18])))}initializePipeline(){return j({colorWrite:A})}};xn=T([S(`esri.views.3d.webgl-engine.effects.highlight.HighlightBlurTechnique`)],xn);var Sn=class extends N{constructor(){super(...arguments),this.shader=new P(Zt,()=>e(()=>import(`./HighlightDownsample.glsl-CsEEdBfN.js`),__vite__mapDeps([19,2,3,4,5,6,7,8,9])))}initializePipeline(){return j({colorWrite:A})}};Sn=T([S(`esri.views.3d.webgl-engine.effects.highlight.HighlightDownsampleTechnique`)],Sn);var Cn=class extends dt{constructor(){super(...arguments),this.occludedFactor=Ee,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}},wn=class extends N{constructor(t,n){super(t,n,Bt),this.shader=new P(tn,()=>e(()=>import(`./HighlightToSingle.glsl-Bzk90e1b.js`),__vite__mapDeps([20,2,3,4,5,6,7,8,9,21,10,11,12])))}initializePipeline(){return j({colorWrite:A})}};wn=T([S(`esri.views.3d.webgl-engine.effects.highlight.HighlightToSingleTechnique`)],wn);var Tn=class extends Lt{constructor(){super(...arguments),this.produces=zt.HIGHLIGHTS,this.consumes={required:[zt.HIGHLIGHTS,`highlights`]},this._downsampleDrawParameters=new Yt,this._passParameters=new Cn,this._highlightBlurDrawParameters=new $t,this._grid=new En}initialize(){this.addHandles([D(()=>this._updateOptionsTexture(),()=>{},ke)])}destroy(){this._grid.coverage=t(this._grid.coverage),this._grid.vao=Fe(this._grid.vao),this._passParameters.highlightOptionsTexture=t(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){let e=new Ze(16,2);e.internalFormat=6408,e.samplingMode=9728,this._passParameters.highlightOptionsTexture=new Ce(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(Dn(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(Sn),this.techniques.precompile(wn),this.techniques.precompile(xn),this.techniques.precompile(bn)}render(e){let t=e.find(({name:e})=>e===zt.HIGHLIGHTS),{techniques:n,bindParameters:r}=this;if(!r.decorations)return t;if(!n.get(Sn).compiled)return this.requestRender(1),t;let i=e.find(({name:e})=>e===`highlights`).getTexture();return this._renderHighlightPostprocess(i,t),t}_prepareAndDownSample(e){this._gridUpdateResources(e);let t=this.techniques.get(Sn),n=this._gridComputeCoverage(t,e),{horizontalCellCount:r,verticalCellCount:i}=n,a=this._passParameters;return a.horizontalCellCount=r,a.verticalCellCount=i,a.coverageTexture=n.coverage?.getTexture(),n}_renderGrid(e){let t=e.verticalCellCount*e.horizontalCellCount;this.renderingContext.bindVAO(e.vao),this.renderingContext.drawElementsInstanced(ne.TRIANGLES,6,oe.UNSIGNED_BYTE,0,t)}_renderHighlightPostprocess(e,t){let{fboCache:n,techniques:r,bindParameters:i,_passParameters:a,renderingContext:o}=this,s=r.get(wn),c=r.get(xn),l=r.get(bn);if(!l.compiled||!c.compiled||!s.compiled)return void this.requestRender(1);a.highlightTexture=e;let d=this._prepareAndDownSample(e),{width:f,height:p}=e.descriptor;a.highlightTexture=e;let{camera:m}=i,{fullWidth:h,fullHeight:ee,pixelRatio:g,fullViewport:te}=m,_=Math.ceil(h/g),v=Math.ceil(ee/g),{_highlightBlurDrawParameters:y}=this,ne=this.view.stage.renderView.renderer,{highlights:re}=i;for(let e=0;e<re.length;++e){let{name:r}=re[e];if(!ne.hasHighlight(r))continue;a.highlightLevel=e,o.setClearColor(0,0,0,0);let m=n.acquire(f,p,`single highlight`,2);o.bindFramebuffer(m.fbo),o.setViewport(0,0,f,p),o.clear(16384),o.bindTechnique(s,i,a),this._renderGrid(d),y.blurInput=m.getTexture(),u(y.blurSize,1/_,0);let h=n.acquire(_,v,`single highlight blur`,2);o.unbindTexture(h.fbo?.colorTexture),o.bindFramebuffer(h.fbo),o.setViewport(0,0,_,v),o.clear(16384),o.bindTechnique(c,i,a,y),this._renderGrid(d),m.release(),u(y.blurSize,0,1/v),a.highlightBlurTexture=h.getTexture(),o.bindFramebuffer(t.fbo),o.setViewport4fv(te),o.bindTechnique(l,i,a,y),this._renderGrid(d),h.release()}a.coverageTexture=a.highlightTexture=null}_gridUpdateResources(e){let t=this._grid,{width:n,height:r}=e.descriptor;if(t.horizontalCellCount=Math.ceil(n/32),t.verticalCellCount=Math.ceil(r/32),t.vao)return;let i=this.renderingContext,a=ht.createIndex(i,35044,An);t.vao=new dn(i,new gt(i,Bt),a)}_gridComputeCoverage(e,t){let n=this.renderingContext,r=this._grid,i=t.descriptor,a=Math.ceil(i.width/32),o=Math.ceil(i.height/32);this._downsampleDrawParameters.input=t;let{highlights:s}=this.bindParameters;r.coverage?.release();let c=this.fboCache.acquire(a,o,`highlight coverage`,s.length>4?3:1);return r.coverage=c,n.bindFramebuffer(c.fbo),n.bindTechnique(e,this.bindParameters,this._passParameters,this._downsampleDrawParameters),n.setViewport(0,0,a,o),n.screen.draw(),r}get test(){}};T([r()],Tn.prototype,`produces`,void 0),T([r()],Tn.prototype,`consumes`,void 0),Tn=T([S(`esri.views.3d.webgl-engine.effects.highlight.Highlight`)],Tn);var En=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function Dn(e){let t=new Uint8Array(128),n=0;for(let r of e){let e=4*n,i=4*n+64;++n;let{color:a}=r,o=r.haloColor??a;t[e+0]=a.r,t[e+1]=a.g,t[e+2]=a.b,t[e+3]=r.fillOpacity*a.a*255,t[i+0]=o.r,t[i+1]=o.g,t[i+2]=o.b,t[i+3]=r.haloOpacity*o.a*255}return t}var On=0;function kn(e){let t=0;for(let n of e){let{name:e}=n;t+=e.length;let{color:r,fillOpacity:i,haloColor:a,haloOpacity:o}=n;t+=r.r+r.g+r.b+r.a+i,t+=a?a.r+a.g+a.b+a.a+o:0}let n=e.at(0);if(n){let{shadowOpacity:e,shadowDifference:r,shadowColor:i}=n;t+=e+r+i.r+i.g+i.b+i.a}return On+++(t>=0?0:1)}var An=new Uint8Array([0,1,2,2,1,3]);function jn(e,t,n,r,i,a=0){let{highlights:o}=r,s=o.length>1?t.acquire(n.width,n.height,`highlight mix`,o.length>4?3:1):null,{gl:c}=e;if(s){let t=e.getBoundFramebufferObject();e.bindFramebuffer(s.fbo),c.clearBufferuiv(c.COLOR,0,[0,0,0,0]),e.bindFramebuffer(t)}let l=s?.getTexture();r.highlightMixTexture=l,u(r.highlightMixOrigin,a,0),o.forEach((t,o)=>{if(o>0){let t=Ce.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(l,t),e.setActiveTexture(t),c.copyTexSubImage2D(3553,0,0,0,a,0,n.width,n.height),e.bindTexture(null,t)}e.clear(256),r.highlightLevel=o,i()}),r.highlightLevel=null,r.highlightMixTexture=null,s?.release()}var Mn=class{constructor(e,t,n,r){this.material=e,this.output=t,this.techniques=n,this.textures=r}},Nn=class{constructor(e,t,n,r){this._textures=e,this._techniques=t,this.materialChanged=n,this.requestRender=r,this._id2glMaterialRef=new nn}dispose(){this._textures.destroy()}acquire(e,t,n){if(this._ownMaterial(e),!e.produces.get(t)?.(n))return null;let r=this._id2glMaterialRef.get(n,e.id);if(r==null){let t=e.createGLMaterial(new Mn(e,n,this._techniques,this._textures));r=new Pn(t),this._id2glMaterialRef.set(n,e.id,r)}return r.ref(),r.glMaterial}release(e,t){let n=this._id2glMaterialRef.get(t,e.id);n!=null&&(n.unref(),n.referenced||(Fe(n.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&o.getLogger(`esri.views.3d.webgl-engine.lib.GLMaterialRepository`).error(`Material is already owned by a different material repository`),e.repository=this}},Pn=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,rt(this._refCnt>=0)}get referenced(){return this._refCnt>0}};function Fn(e){return e!=null&&!e.readyToRun}var In=class{constructor(){this.startTime=0,this._data=Pe(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new Ln,this.parallaxNew=new Ln,this._anchorPoint=Xe(),this._fadeState=Pe(0),this._fadeFactor=Pe(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(e,t,n){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=n?Ge((t-this.startTime)/(Bn*n),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(e,t),this._updateParallax(e)}_evaluateState(e,t){let n=e.relativeElevation,r=this._updateAnchorPoint(e);(Math.abs(n)>1.7*1e4||r>Hn)&&this.opacity>0?this._startFade(0,t):this.isFading||(Math.abs(n)>1e4||r>Vn*Hn?this.opacity>0&&this._startFade(4,t):Fn(this.data)&&(this.opacity===0?this._startFade(1,t):this.data.state===2&&(this.fadeState===2?this._startFade(3,t):this._startFade(2,t))))}_updateParallax(e){let t=d(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-He.radius*He.radius,0))/Math.sqrt(t),Qe(Rn,this.parallax.anchorPoint,R),y(this.parallax.transform,C,R[3],et(R)),Qe(Rn,this.parallaxNew.anchorPoint,R),y(this.parallaxNew.transform,C,R[3],et(R))}_updateAnchorPoint(e){return We(this._anchorPoint,e.eye),ie(this._anchorPoint,this._anchorPoint,He.radius),this.fadeState===0&&this.data?.state===2?(m(this.parallax.anchorPoint,this._anchorPoint),0):ve(Ie(zn,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,t){switch(this._fadeState.value=e,this.startTime=t,e){case 3:this.requestFade(),this._switchReadChannels(),m(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),m(this.parallax.anchorPoint,this._anchorPoint),m(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),m(this.parallax.anchorPoint,this._anchorPoint),m(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==2&&(this.data.state=0),this.fadeState){case 3:m(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:a(this.fadeState)}}_switchReadChannels(){this.data?.state===2&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return this.fadeState===4||this.fadeState===1||this.fadeState===3}},Ln=class{constructor(){this.anchorPoint=Xe(),this.radiusCurvatureCorrection=0,this.transform=g()}},Rn=qe(0,0,1),R=$e(),zn=Xe(),Bn=1.25,Vn=.5,Hn=2e5,Un=class{constructor(e){this.shadowMap=e,this.slot=2,this.slicePlane=null,this.hasOccludees=!1,this.hasEmission=!1,this.enableFillLights=!0,this.oitPass=0,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this.cutFillEnabled=!1,this._camera=new Vt,this._inverseViewport=x(),this._oldLighting=new Ut,this._newLighting=new Ut,this._fadedLighting=new Ut,this._lighting=this._newLighting,this.ssr=new Wn,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=[],this.highlightOrderMap=new Map,this.highlightMixOrigin=x(),this.highlightMixTexture=null,this.hudRenderStyle=0,this.hudOccludedFragmentOpacity=1,this.snowCover=0,this.clouds=new In,this.shadowHighlightsVisible=!1}destroy(){this._camera=null,this.contentCamera=null,this.depth=null,this.geometryDepth=null,this.mainDepth=null,this.overlay=null,this.ssao=null,this.terrainDepth=null}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get enableOffset(){return this.oitPass===1&&this.camera.relativeElevation<5e5}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,n,r){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=n,this._newLighting.set(e),this._oldLighting.updateLegacy(),r===1&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}get occluder(){return this.slot===11||this.slot===12?this.slot:null}},Wn=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=g()}},Gn=class{constructor(e,t,n){this.rctx=e,this.techniques=n,this.lastFrameCamera=new Vt,this.output=0,this.renderOccludedMask=13,this.time=v(0),this.bind=new Un(t),this.bind.alignPixelEnabled=!0}},Kn=class extends Vt{constructor(){super(...arguments),this._projectionMatrix=g()}get projectionMatrix(){return this._projectionMatrix}};T([r()],Kn.prototype,`_projectionMatrix`,void 0),T([r({readOnly:!0})],Kn.prototype,`projectionMatrix`,null),Kn=T([S(`esri.views.3d.webgl-engine.lib.CascadeCamera`)],Kn);var qn=class{constructor(){this.camera=new Kn,this.lightMat=g()}},Jn=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},Yn=class{constructor(e,t){this._fbos=e,this._viewingMode=t,this._snapshots=[],this._textureHeight=0,this._numCascades=1,this.settings=new Jn,this._projectionView=g(),this._projectionViewInverse=g(),this._modelViewLight=g(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=be(),this._cascades=[new qn,new qn,new qn,new qn],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(c(`esri-mobile`)?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(fe)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return Re(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=t(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=Ge(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)ir[e]=this._cascades[e];return ir.length=this._numCascades,ir}start(e,t,n,r,i){rt(this.enabled);let{near:a,far:o}=mr(n);this._computeCascadeDistances(a,o,r),this._textureHeight=this._computeTextureHeight(e,i,r),this._setupMatrices(e,t);let{viewMatrix:s,projectionMatrix:c}=e;for(let e=0;e<this._numCascades;++e)this._constructCascade(e,c,s,t);this._lastOrigin=null,this.clear()}finish(){rt(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!je(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||Xe(),m(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){ye(ar,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)or[16*t+e]=ar[e]}}return or}moveSnapshot(e){rt(this.enabled),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle?.setName(e===0?`shadow map highlight`:`shadow map excluding highlight`),this._handle=null}copySnapshot(e){if(!this.enabled||!this._handle?.getTexture(33306)?.descriptor)return;this._snapshots[e]?.release();let t=e===0?`shadow map highlight`:`shadow map excluding highlight`,n=this._acquireFBO(t);this._snapshots[e]=n;let r=this._handle?.fbo;if(!r||!n?.fbo)return void console.error(`No FBO`);let{rctx:i}=this._fbos;i.blitFramebuffer(r,n.fbo,256)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture(fe):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight({pixelRatio:e,fullWidth:t,fullHeight:n},r,i){let a=Math.min(window.devicePixelRatio,r)/e,o=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return an(Math.max(t,n)*a*o,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO(`shadow map`))}_acquireFBO(e){let t=this._fbos.acquire(this._textureWidth,this._textureHeight,e,12);return t.getTexture(fe)?.setShadowFiltering(!0),t}_discardSnapshot(e){this._snapshots[e]=t(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,n,r){let i=this._cascades[e],a=-this._cascadeDistances[e],o=-this._cascadeDistances[e+1],s=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),c=(t[10]*o+t[14])/Math.abs(t[11]*o+t[15]);rt(s<c);for(let e=0;e<8;++e){Re(Zn,e%4==0||e%4==3?-1:1,e%4==0||e%4==1?-1:1,e<4?s:c,1);let t=z[e];we(t,Zn,this._projectionViewInverse),t[0]/=t[3],t[1]/=t[3],t[2]/=t[3]}_(rr,z[0]),i.camera.viewMatrix=ye(Xn,this._modelViewLight,rr);for(let e=0;e<8;++e)Me(z[e],z[e],i.camera.viewMatrix);let l=z[0][2],u=z[0][2];for(let e=1;e<8;++e)l=Math.min(l,z[e][2]),u=Math.max(u,z[e][2]);l-=200,u+=200,i.camera.near=-u,i.camera.far=-l,pr(n,r,l,u,i.camera),de(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);let d=this._textureHeight;i.camera.viewport=[e*d,0,d,d]}_setupMatrices(e,t){de(this._projectionView,e.projectionMatrix,e.viewMatrix),ge(this._projectionViewInverse,this._projectionView);let n=this._viewingMode===1?e.eye:ue(rr,0,0,1);f(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],n)}_computeCascadeDistances(e,t,n){let r=n?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(at(t/e,4)),r);let i=(t-e)/this._numCascades,a=(t/e)**(1/this._numCascades),o=e,s=e;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=me(o,s,this.settings.splitSchemeLambda),o*=a,s+=i}get test(){}},Xn=g(),Zn=be(),z=[];for(let e=0;e<8;++e)z.push(be());var Qn=x(),$n=x(),er=x(),tr=x(),nr=x(),rr=Xe(),ir=[],ar=g(),or=C.concat(C,C,C),B=x(),V=x(),H=[x(),x(),x(),x()],U=x(),sr=x(),W=x(),cr=x(),G=x(),K=x(),lr=x();function ur(e,t,n,r,a,o,c,d){u(B,0,0);for(let t=0;t<4;++t)O(B,B,e[t]);b(B,B,.25),u(V,0,0);for(let t=4;t<8;++t)O(V,V,e[t]);b(V,V,.25),l(H[0],e[4],e[5],.5),l(H[1],e[5],e[6],.5),l(H[2],e[6],e[7],.5),l(H[3],e[7],e[4],.5);let f=0,p=s(H[0],B);for(let e=1;e<4;++e){let t=s(H[e],B);t<p&&(p=t,f=e)}E(U,H[f],e[f+4]);let m=U[0],h,ee;U[0]=-U[1],U[1]=m,E(sr,V,B),w(sr,U)<0&&_e(U,U),l(U,U,sr,n),i(U,U),h=ee=w(E(W,e[0],B),U);for(let t=1;t<8;++t){let n=w(E(W,e[t],B),U);n<h?h=n:n>ee&&(ee=n)}le(r,B),b(W,U,h-t),O(r,r,W);let g=-1,te=1,_=0,v=0;for(let t=0;t<8;++t){E(cr,e[t],r),i(cr,cr);let n=U[0]*cr[1]-U[1]*cr[0];n>0?n>g&&(g=n,_=t):n<te&&(te=n,v=t)}k(g>0,`leftArea`),k(te<0,`rightArea`),b(G,U,h),O(G,G,B),b(K,U,ee),O(K,K,B),lr[0]=-U[1],lr[1]=U[0];let y=it(r,e[v],K,O(W,K,lr),1,a),ne=it(r,e[_],K,W,1,o),re=it(r,e[_],G,O(W,G,lr),1,c),ie=it(r,e[v],G,W,1,d);k(y,`rayRay`),k(ne,`rayRay`),k(re,`rayRay`),k(ie,`rayRay`)}function q(e,t){return 3*t+e}var dr=x();function J(e,t){return u(dr,e[t],e[t+3]),dr}var Y=x(),X=pe();function fr(e,t,n,r,i){E(Y,n,r),b(Y,Y,.5),X[0]=Y[0],X[1]=Y[1],X[2]=0,X[3]=Y[1],X[4]=-Y[0],X[5]=0,X[6]=Y[0]*Y[0]+Y[1]*Y[1],X[7]=Y[0]*Y[1]-Y[1]*Y[0],X[8]=1,X[q(0,2)]=-w(J(X,0),e),X[q(1,2)]=-w(J(X,1),e);let a=w(J(X,0),n)+X[q(0,2)],o=w(J(X,1),n)+X[q(1,2)],s=w(J(X,0),r)+X[q(0,2)],c=w(J(X,1),r)+X[q(1,2)];a=-(a+s)/(o+c),X[q(0,0)]+=X[q(1,0)]*a,X[q(0,1)]+=X[q(1,1)]*a,X[q(0,2)]+=X[q(1,2)]*a,a=1/(w(J(X,0),n)+X[q(0,2)]),o=1/(w(J(X,1),n)+X[q(1,2)]),X[q(0,0)]*=a,X[q(0,1)]*=a,X[q(0,2)]*=a,X[q(1,0)]*=o,X[q(1,1)]*=o,X[q(1,2)]*=o,X[q(2,0)]=X[q(1,0)],X[q(2,1)]=X[q(1,1)],X[q(2,2)]=X[q(1,2)],X[q(1,2)]+=1,a=w(J(X,1),t)+X[q(1,2)],o=w(J(X,2),t)+X[q(2,2)],s=w(J(X,1),n)+X[q(1,2)],c=w(J(X,2),n)+X[q(2,2)],a=-.5*(a/o+s/c),X[q(1,0)]+=X[q(2,0)]*a,X[q(1,1)]+=X[q(2,1)]*a,X[q(1,2)]+=X[q(2,2)]*a,a=w(J(X,1),t)+X[q(1,2)],o=w(J(X,2),t)+X[q(2,2)],s=-o/a,X[q(1,0)]*=s,X[q(1,1)]*=s,X[q(1,2)]*=s,i[0]=X[0],i[1]=X[1],i[2]=0,i[3]=X[2],i[4]=X[3],i[5]=X[4],i[6]=0,i[7]=X[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=X[6],i[13]=X[7],i[14]=0,i[15]=X[8]}function pr(e,t,n,r,i){let a=1/z[0][3],o=1/z[4][3];rt(a<o);let s=a+Math.sqrt(a*o),c=Math.sin(Ne(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));s/=c,ur(z,s,c,Qn,$n,er,tr,nr),fr(Qn,$n,tr,nr,i.projectionMatrix),i.projectionMatrix[10]=2/(n-r),i.projectionMatrix[14]=-(n+r)/(n-r)}function mr(e){let{near:t,far:n}=e;return t<2&&(t=2),n<2&&(n=2),t>=n&&(t=2,n=4),{near:t,far:n}}var hr=class extends N{constructor(){super(...arguments),this.shader=new P(qt,()=>e(()=>import(`./TextureOnly.glsl-CDYz7roi.js`),__vite__mapDeps([22,23,7,8,3,4,24,9,15,5,6])))}initializePipeline(e){return e.hasAlpha?j({blending:vt,colorWrite:A}):j({colorWrite:A})}};hr=T([S(`esri.views.3d.webgl-engine.lib.TextureTechnique`)],hr);var gr=class extends Ct{constructor(){super(...arguments),this.hasAlpha=!1}};T([M()],gr.prototype,`hasAlpha`,void 0);var _r=class extends N{constructor(){super(...arguments),this.shader=new P(sn,()=>e(()=>import(`./OverlayCompositing.glsl-DY8eGV0d.js`),__vite__mapDeps([25,26,3,4,14,9,11,15,5,6,7,8])))}};_r=T([S(`esri.views.3d.webgl-engine.shaders.OverlayCompositingTechnique`)],_r);var Z=class extends vn{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new cn,this.hasHighlights=!1,this.renderOccludedFlags=1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new Ye,this._passParameters=new Jt,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new Vt,this.events=new Te,this.longitudeCyclical=null,this.produces=new Map([[19,e=>e!==8||this.hasHighlights],[20,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1,this._hasDrapedFlowSource=!1}initialize(){let e=this._view,t=e.stage,n=t.renderer.fboCache,{waterTextures:r,techniques:i}=t.renderView;this._renderContext=new Gn(this._rctx,new Yn(n,e.state.viewingMode),i),this.addHandles([D(()=>r.updating,()=>this.events.emit(`content-changed`),ze),D(()=>this._spatialReference,e=>this._localOriginFactory=new Pt(e),ze),Le(()=>e.allLayerViews,`after-changes`,()=>this._sortedDrapeSourceRenderersDirty=!0),D(()=>kn(e.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,ke),D(()=>e.state.highlights,t=>{this._bindParameters.highlights=t,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap},ke),e.resourceController.scheduler.registerTask(xe.OVERLAY_RENDERER,this)]);let a=this._camera;a.near=1,a.far=1e4,a.relativeElevation=null,this._bindParameters.slot=19,this._bindParameters.camera=a,this._bindParameters.updateLighting([new Ht(Ae())],0,0,0)}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._passParameters.texture=Fe(this._passParameters.texture),this.disposeOverlays(),this._renderContext=null,this._sortedRenderers.prune()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get _spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){let t=new Nn(this._view.stage.renderView.textures,this._techniques,()=>{this._onMaterialOrContentChanged(),this.events.emit(`content-changed`),this.notifyChange(`updating`),this.notifyChange(`isEmpty`)},()=>this.events.emit(`content-changed`));this._pluginContext={...e,materials:t},this._techniques.precompile(_r)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||Je(this._renderers,e=>e.updating||e.canCompact)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(e){for(let t of this._renderers.values()){let n=t.getMaterialRenderer(e);if(n)return n}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),Oe(this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e))}registerDrapeSource(e,t){this._renderers.get(e)?.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,`fullOpacity`in e&&this.addHandles(D(()=>e.fullOpacity,()=>this.events.emit(`content-changed`)),e)}removeDrapeSourceRenderer(e){if(e==null)return;let t=this._renderers.get(e);t!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(e){this._renderTargets?.dispose(e)}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&h(e,e=>e.drapeTargetType===1)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=h(e,e=>e.drapeSourceType===1),this._hasDrapedRasterSource=h(e,e=>e.drapeSourceType===0),this._hasDrapedFlowSource=h(e,e=>e.drapeSourceType===2)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=this._hasDrapedFlowSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,n=this._bindParameters.overlayStretch){this._overlays??=(this._renderTargets=new hn(this._stage.renderer.fboCache),[new fn,new fn]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=n}disposeOverlays(){this._overlays=null,this._renderTargets?.dispose(1),this._renderTargets=null,this.events.emit(`textures-disposed`)}_useOverlayColorInsteadOfColorNoRasterImage(e){return e===1&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource}getTexture(e){let t=this._useOverlayColorInsteadOfColorNoRasterImage(e);return this._renderTargets?.getTexture(t?0:e)}get readyToRun(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_onMaterialOrContentChanged(){this.renderOccludedFlags=Je(this._renderers,e=>e.hasOccluders)?4:1}_processDrapeSources(e,t){let n=!1;for(let[r,i]of this._renderers){if(e.done)break;(r.destroyed||t(r))&&i.commitChanges()&&(n=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,n=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),n&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange(`updating`),this.notifyChange(`isEmpty`),this._onMaterialOrContentChanged(),this.hasHighlights=Je(this._renderers,e=>e.hasHighlights),this.events.emit(`content-changed`))}compact(e){let t=!1;for(let n of this._renderers.values()){if(e.done)break;t=n.compact(e)||t}return t&&this.notifyChange(`updating`),t}hasHighlight(e){return Je(this._renderers,t=>t.hasHighlight(e))}processSyncDrapeSources(){this._processDrapeSources(ce,e=>e.updatePolicy===1)}get isEmpty(){return!Gt.OVERLAY_DRAW_DEBUG_TEXTURE&&Ke(this._renderers,e=>e.isEmpty)}get hasWater(){let e=Je(this._renderers,({hasWater:e})=>e);return e!==this._hasWater&&(this._hasWater=e,this.events.emit(`has-water`)),this._hasWater}renders(e){if(Gt.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==4&&e!==2)return!0;if(!this._overlays)return!1;let t=this._overlays[0];for(let e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);if(!t.hasSomeSizedView())return!1;let n=this._setOutput(this._renderTargets?.targets.find(t=>t.content===e)?.output??0);++this._techniques.precompiling;let r=this._sortedRenderers.some(({renderer:e})=>e.precompile(this._renderContext));return--this._techniques.precompiling,this._setOutput(n),r}_setOutput(e){let t=this._renderContext.output;return this._renderContext.output=e,this._bindParameters.slot=e===2?20:19,t}get mode(){return this.isEmpty?0:this.hasWater&&this.renders(3)?2:this._renderTargets?.getTexture(0)?1:0}updateAnimation(e){let t=!1;return this._renderers.forEach(n=>t=n.updateAnimation(e)||t),t&&this.parent.requestRender(0),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return!1;let t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(let e of this._renderTargets.targets){if(e.content===1&&!this._needsColorWithoutRasterImage)continue;let{output:n}=e;this._setOutput(n),n===8&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null);let r=this._renderContext.renderOccludedMask;e.content===4&&(this._renderContext.renderOccludedMask=4),this._sortedRenderers.forAll(({drapeSource:t,renderer:n})=>{e.content===1&&t.drapeSourceType===0||e.content===4&&n.hasOnlyOccluders||n.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=r,t.highlightMixTexture=null}return--this._techniques.precompiling,!0}drawOverlays(e,t){if(!this._overlays||!this._renderTargets)return;for(let e of this._overlays)e.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;let n=this.allSourcesOccluders;for(let e of this._renderTargets.targets){if(!(e.content===0&&this._hasDrapedFlowSource)&&!e.handleRenderRequest(t)||e.content===1&&!this._needsColorWithoutRasterImage||e.content===4&&n)continue;let r=this._drawTarget(0,e),i=this._drawTarget(1,e);(r||i)&&e.fbo.generateMipMap()}}_drawTarget(e,t){let n=this._overlays[e],r=n.canvasGeometries;if(r.numViews===0)return!1;let i=this._view.state.contentPixelRatio;this._screenToWorldRatio=i*n.mapUnitsPerPixel/this._bindParameters.overlayStretch;let{output:a,content:o}=t;if(this.isEmpty||a===2&&!this.hasWater||!n.hasSomeSizedView())return!1;let{_rctx:s,_camera:c,_renderContext:l,_bindParameters:u}=this;if(c.pixelRatio=n.pixelRatio*i,this._setOutput(a),u.screenToWorldRatio=this._screenToWorldRatio,u.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,o===4&&(l.renderOccludedMask=4),!this.renders(o))return l.renderOccludedMask=13,!1;let{resolution:d}=n,f=e===0,p=f?0:d;if(s.setViewport(p,0,d,d),this._bindTargetFBO(t),f&&(a===8?s.gl.clearBufferuiv(s.gl.COLOR,0,[0,0,0,0]):(s.setClearColor(0,0,0,0),s.clear(16384))),Gt.OVERLAY_DRAW_DEBUG_TEXTURE&&o!==4&&o!==2){this._techniques.precompile(hr,xr);let t=this._techniques.get(hr,xr);for(let i=0;i<r.numViews;i++)this._setViewParameters(r.extents[i],n),this._ensureDebugPatternResources(n.resolution,yr[e]),s.bindTechnique(t,u,this._passParameters),s.screen.draw()}if(a===8){let{fboCache:n}=this._stage.renderer,r=this._resolution;this._bindTargetFBO(t),jn(s,n,{width:r,height:r},u,()=>this._renderAllGeometry(e,t),p)}else this._renderAllGeometry(e,t);return s.bindFramebuffer(null),l.renderOccludedMask=13,!0}get allSourcesOccluders(){return Ke(this._renderers,e=>e.hasOnlyOccluders)}_renderAllGeometry(e,t){let n=this._overlays[e],r=n.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:i,renderer:a})=>{if(t.content===1&&i.drapeSourceType===0)return;let{fullOpacity:o}=i,s=o!=null&&o<1&&t.output===0&&this._bindTemporaryFBO();for(let e=0;e<r.numViews;e++)this._setViewParameters(r.extents[e],n),a.render(this._renderContext);if(s){this._bindTargetFBO(t),this._overlayParameters.texture=s.getTexture(),this._overlayParameters.opacity=o,this._overlayParameters.overlayIndex=e;let n=this._techniques.get(_r);this._rctx.bindTechnique(n,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),s.release()}})}_bindTargetFBO(e){let t=this._resolution,n=2*t;e.fbo.ensureFramebuffer(n,t),e.fbo.bind(this._rctx)}_bindTemporaryFBO(){let e=this._resolution,t=2*e,n=this._stage.renderer.fboCache,r=n.acquire(t,e,`overlay tmp`);return n.rctx.bindFramebuffer(r.fbo),n.rctx.clear(16384),r}get _resolution(){return this._overlays?.[0].resolution??0}notifyContentChanged(){this.events.emit(`content-changed`)}intersect(e,t,n,r){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let i=0;for(let{renderer:a}of this._sortedRenderers)i=a.intersect?.(e,t,n,r,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;let e=this._view.map.allLayers.map(e=>e.uid),t=e.length;this._renderers.forEach((n,r)=>{let i=e.indexOf(r.layer?.uid),a=i>=0,o=r.renderGroup??(a?0:1),s=r.drapeSourcePriorityOffset??0,c=t*o+(a?i:0)+s;this._sortedRenderers.push(new vr(r,n,c))}),this._sortedRenderers.sort((e,t)=>e.index-t.index)}_setViewParameters(e,t){let n=this._camera;n.viewport=[0,0,t.resolution,t.resolution],ae(n.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],n.near,n.far),Se(n.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if(ue(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;let n=new Uint8Array(e*e*4),r=0;for(let t=0;t<e;t++)for(let i=0;i<e;i++){let a=Math.floor(i/10),o=Math.floor(t/10);a<2||o<2||10*a>e-20||10*o>e-20?(n[r++]=255,n[r++]=255,n[r++]=255,n[r++]=255):(n[r++]=255,n[r++]=255,n[r++]=255,n[r++]=1&a&&1&o?1&i^1&t?0:255:1&a^1&o?0:128)}let i=new Ze(e);i.samplingMode=9728,this._passParameters.texture=new Ce(this._rctx,i,n)}get test(){}};T([r()],Z.prototype,`hasHighlights`,void 0),T([r()],Z.prototype,`renderOccludedFlags`,void 0),T([r()],Z.prototype,`_sortedDrapeSourceRenderersDirty`,void 0),T([r({constructOnly:!0})],Z.prototype,`parent`,void 0),T([r({readOnly:!0})],Z.prototype,`_techniques`,null),T([r({type:Boolean,readOnly:!0})],Z.prototype,`updating`,null),T([r()],Z.prototype,`isEmpty`,null),Z=T([S(`esri.views.3d.terrain.OverlayRenderer`)],Z);var vr=class{constructor(e,t,n){this.drapeSource=e,this.renderer=t,this.index=n}},yr=[[1,.5,.5],[.5,.5,1]],br=-2,xr=new gr;xr.hasAlpha=!0;var Sr=class{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=g(),this._shaderTransformation=null,this._boundingSphere=null,this.id=re(),this.layerViewUid=t.layerViewUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){te(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??=g(),de(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere??(this._boundingSphere??=new pt,Me(this._boundingSphere.center,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere.radius=this.boundingInfo.radius*tt(this.shaderTransformation)),this._boundingSphere):ft}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get positionAttribute(){return this.geometry.positionAttribute}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}},Cr=class extends bt{intersect(e,t,n,r,i,a){return kt(e,n,r,i,void 0,a)}intersectDraped(e,t,n,r){return Dt(n[0],n[1],e,r)}},wr=class extends N{constructor(t,n){super(t,n,I(Er(n))),this.shader=new P(ln,()=>e(()=>import(`./ColorMaterial.glsl-DIWNJ4ry.js`),__vite__mapDeps([27,28,29,7,8,30,9,31,4,5,32,33,34,35,36,12,37,24,38,39,40,41,42,43,44,45,46,47,14,18,15,6])))}_createPipeline(e,t){let{oitPass:n,output:r,hasEmission:i,transparent:a,cullFace:o,draped:s,hasOccludees:c,polygonOffset:l}=e,u=n===0;return j({blending:ut(r)&&a?Tt(n):null,culling:_t(o),depthTest:s?null:xt(n),depthWrite:yt(e),drawBuffers:Rt(r,Et(n,i)),colorWrite:A,stencilWrite:c?Mt:null,stencilTest:c?t?At:Ot:null,polygonOffset:u?l?Tr:null:Nt(e)})}initializePipeline(e){return this._occludeePipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}getPipeline(e,t){return t?this._occludeePipelineState:super.getPipeline(e)}};wr=T([S(`esri.views.3d.webgl-engine.shaders.ColorMaterialTechnique`)],wr);var Tr={factor:1,units:1};function Er(e){let t=F().vec3f(`position`);return Wt()&&t.vec4u8(`olidColor`),e.hasVVColor?t.f32(`colorFeatureAttribute`):t.vec4u8(`color`),t.freeze()}var Q=class extends wt{constructor(){super(...arguments),this.cullFace=0,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasVVColor=!1,this.draped=!1,this.textureCoordinateType=0,this.emissionSource=0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.hasVVInstancing=!1,this.hasVVSize=!1,this.hasVVOpacity=!1,this.snowCover=!1}};T([M({count:3})],Q.prototype,`cullFace`,void 0),T([M()],Q.prototype,`hasVertexColors`,void 0),T([M()],Q.prototype,`transparent`,void 0),T([M()],Q.prototype,`discardInvisibleFragments`,void 0),T([M()],Q.prototype,`polygonOffset`,void 0),T([M()],Q.prototype,`enableOffset`,void 0),T([M()],Q.prototype,`writeDepth`,void 0),T([M()],Q.prototype,`hasOccludees`,void 0),T([M()],Q.prototype,`terrainDepthTest`,void 0),T([M()],Q.prototype,`cullAboveTerrain`,void 0),T([M()],Q.prototype,`hasVVColor`,void 0),T([M()],Q.prototype,`draped`,void 0);var Dr=class extends Cr{constructor(e){super(e,kr),this._configuration=new Q,this.supportsEdges=!0,this.produces=new Map([[2,e=>this._isOpaqueMaterialPass(e)],[3,e=>this._isOpaqueNoSSAODepthPass(e)],[4,e=>st(e)&&this._transparent&&this.parameters.writeDepth],[5,e=>ot(e)&&this._transparent&&this.parameters.writeDepth],[9,e=>st(e)&&this._transparent&&!this.parameters.writeDepth],[19,e=>ct(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(e)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=t.hasOccludees,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.enableOffset,this._configuration.terrainDepthTest=t.terrainDepthTest&&ut(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=rn}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(e){return this._isOpaqueMaterialPass(e)||this._isOpaqueNoSSAODepthPass(e)}_isOpaqueMaterialPass(e){return e===8||st(e)&&!this._transparent}_isOpaqueNoSSAODepthPass(e){return ot(e)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(e){return new Or(e)}createBufferWriter(){return new jt(Er(this.parameters))}},Or=class extends lt{beginSlot(e){return this.getTechnique(wr,e)}},kr=class extends Kt{constructor(){super(...arguments),this.color=ee,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.draped=!1,this.discardInvisibleFragments=!1}},$={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},Ar={dash:$.dash,"dash-dot":[...$.dash,...$.dot],dot:$.dot,"long-dash":$[`long-dash`],"long-dash-dot":[...$[`long-dash`],...$.dot],"long-dash-dot-dot":[...$[`long-dash`],...$.dot,...$.dot],none:null,"short-dash":$[`short-dash`],"short-dash-dot":[...$[`short-dash`],...$[`short-dot`]],"short-dash-dot-dot":[...$[`short-dash`],...$[`short-dot`],...$[`short-dot`]],"short-dot":$[`short-dot`],solid:null},jr=8;function Mr(e,t){return e==null?e:{pattern:e.slice(),pixelRatio:t}}function Nr(e){return{pattern:[e,e],pixelRatio:2}}function Pr(e){return e?.type===`style`?Fr(e.style):null}function Fr(e){return e==null?null:Mr(Ar[e],jr)}function Ir(e,t,n,r){let i=e.type===`polygon`?1:0,a=e.type===`polygon`?e.rings:e.paths,{position:o,outlines:s}=nt(a,!!e.hasZ,i,e.spatialReference),c=he(o.length),l=Ft(o,e.spatialReference,0,c,0,o,0,o.length/3,t,n,r),u=l!=null;return{lines:u?Rr(s,o,c):[],projectionSuccess:u,sampledElevation:l}}function Lr(e,t){let n=e.type===`polygon`?1:0,r=e.type===`polygon`?e.rings:e.paths,{position:i,outlines:a}=nt(r,!1,n),o=Ve(i,e.spatialReference,0,i,t,0);for(let e=2;e<i.length;e+=3)i[e]=-2;return{lines:o?Rr(a,i):[],projectionSuccess:o}}function Rr(e,t,n=null){let r=[];for(let{index:i,count:a}of e){if(a<=1)continue;let e=3*i,o=3*a;r.push({position:p(t,3*i,3*a),mapPositions:n==null?void 0:p(n,e,o)})}return r}var zr=F().vec3f(`position`).freeze(),Br=F().vec3f(`position`).vec2f16(`uv0`).freeze(),Vr=F().vec3f(`position`).vec4u8(`color`).freeze(),Hr=F().vec3f(`position`).vec2f(`uv0`).freeze(),Ur=F().vec3f(`position`).vec2f(`uv0`).vec4u8(`olidColor`).freeze(),Wr=I(zr);I(Br);var Gr=I(Vr),Kr=I(Hr),qr=I(Ur);I(F().u16(`componentIndex`,{integer:!0}));var Jr=[{name:`colorAndCastShadows`,type:`vec4u8`},{name:`elevationOffset`,type:`f32`},{name:`emissiveStrength`,type:`f16`},{name:`emissiveSourceMode`,type:`u8`}],Yr={name:`olidColor`,type:`vec4u8`};new un(Jr),new un([...Jr,Yr]);export{br as _,Kr as a,Hr as c,Ir as d,Nr as f,Sr as g,Cr as h,Br as i,Gr as l,Dr as m,Ur as n,Vr as o,Pr as p,zr as r,Wr as s,qr as t,Lr as u,yn as v,dn as y};