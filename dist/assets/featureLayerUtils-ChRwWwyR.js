const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CatalogLayer-CYTeBwNb.js","assets/index-BN8X5Ryz.js","assets/index-CWJhHB6-.css","assets/quatf64-D37SEdPg.js","assets/quat-C8PgLo31.js","assets/memoryEstimations-D_IbKyOk.js","assets/pbf-CO6WFbVS.js","assets/MeshLocalVertexSpace-vomIk0sx.js","assets/MeshTransform-BaPjlQwH.js","assets/axisAngleDegrees-DzAS4tF-.js","assets/External-C55iwtd6.js","assets/meshVertexSpaceUtils-s2jLb8qI.js","assets/OptimizedFeatureSet-CLjmRHYn.js","assets/OptimizedGeometry-BQJ7w5VU.js","assets/applyEditsUtils-CPVhCOou.js","assets/editingSupport-DiW8cYcp.js","assets/QueryEngineCapabilities-CxeEdoTy.js","assets/featureConversionUtils-o9-cJXzl.js","assets/FeatureLayerSource-Cwg0TQ9n.js","assets/QueryTask-6dVRoJFW.js","assets/executeForIds-Dq7stXFh.js","assets/query-BXrgTHrc.js","assets/urlUtils-CW4cnJ3W.js","assets/pbfQueryUtils-CmJPTrN7.js","assets/queryUtils-8f7b9mi_.js","assets/executeQueryJSON-DJO3NDvM.js","assets/executeQueryPBF-i-SuhVUp.js","assets/clientSideDefaults-Iizf0eUh.js","assets/generateRendererUtils-DGV_dTnd.js","assets/utils-DCGMUq-q.js","assets/FeatureLayer-CD-B1rfh.js","assets/OrientedImageryLayer-Cv9T7sQT.js"])))=>i.map(i=>d[i]);
import{$S as e,Ba as t,Dh as n,Fa as r,Ha as i,La as a,Na as o,Va as s,fD as c,iC as l,mD as u}from"./index-BN8X5Ryz.js";import"./originUtils-CJnuu7mB.js";import"./saveUtils-CEfw3trS.js";import{n as d,t as f}from"./fetchService-DUyN7SUy.js";import{n as p,t as m}from"./utils-BnryXVma.js";var h=`Feature Service`,g=`feature-layer-utils`,_=`${g}-save`,v=`${g}-save-as`;`${g}`,`${g}`;function y(e){return{isValid:n(e)&&(!(`dynamicDataSource`in e)||!e.dynamicDataSource),errorMessage:`Feature layer should be a layer or table in a map or feature service`}}function b(e,t){let n=o(e,`portal-item`);return t?.isTable&&(n.layerContainerType=`tables`),n}function x(e){let t=[],n=[];for(let{layer:r,layerJSON:i}of e)S(r)?n.push(i):t.push(i);return{layers:t,tables:n}}function S(e,t){return e.isTable}function C(e){return x([e])}async function w(e,t){return/\/\d+\/?$/.test(e.url)?C(t[0]):T(t,e)}async function T(e,t){if(e.reverse(),!t)return x(e);let n=await E(t,e);for(let t of e)I(t.layer,t.layerJSON,n);return k(n,e),n}async function E(e,t){let n=await e.fetchData(`json`);if(D(n)&&!s(e,r.HOSTED_SERVICE))return n;n||={},O(n);let{layer:{url:i,customParameters:a,apiKey:o}}=t[0];return await M(n,{url:i??``,customParameters:a,apiKey:o},t.map(e=>e.layer.layerId)),n}function D(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function O(e){e.layers||=[],e.tables||=[]}function k(e,t){let n=[],r=[];for(let{layer:e}of t){let{isTable:t,layerId:i}=e;t?r.push(i):n.push(i)}A(e.layers,n),A(e.tables,r)}function A(e,t){if(e.length<2)return;let n=[];for(let{id:t}of e)n.push(t);u(n.sort(j),t.slice().sort(j))&&e.sort((e,n)=>{let r=t.indexOf(e.id),i=t.indexOf(n.id);return r<i?-1:r>i?1:0})}function j(e,t){return e<t?-1:e>t?1:0}async function M(e,t,n){let{url:r,customParameters:i,apiKey:a}=t,{serviceJSON:o,layersJSON:s}=await f(r,{customParameters:i,apiKey:a}),c=N(e.layers,o.layers,n),l=N(e.tables,o.tables,n);e.layers=c.itemResources,e.tables=l.itemResources;let u=[...c.added,...l.added],d=s?[...s.layers,...s.tables]:[];await P(e,u,r,d)}function N(e,t,n){let r=c(e,t,(e,t)=>e.id===t.id);e=e.filter(e=>!r.removed.some(t=>t.id===e.id));let i=r.added;return i.forEach(({id:t})=>{e.push({id:t})}),{itemResources:e,added:i.filter(({id:e})=>!n.includes(e))}}async function P(e,t,n,r){let i=await F(t),a=t.map(({id:e,type:t})=>new(i.get(t))({url:n,layerId:e,sourceJSON:r.find(({id:t})=>t===e)}));await Promise.allSettled(a.map(e=>e.load())),a.forEach(t=>{let{layerId:n,loaded:r,defaultPopupTemplate:i}=t;if(!r||i==null)return;let a={id:n,popupInfo:i.toJSON()};I(t,t.operationalLayerType===`ArcGISFeatureLayer`?a:{...a,layerType:t.operationalLayerType},e)})}async function F(t){let n=[];t.forEach(({type:t})=>{switch(d(t)){case`CatalogLayer`:n.push(e(()=>import(`./CatalogLayer-CYTeBwNb.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29])).then(e=>e.default));break;case`FeatureLayer`:n.push(e(()=>import(`./FeatureLayer-CD-B1rfh.js`),__vite__mapDeps([30,1,2])).then(e=>e.default));break;case`OrientedImageryLayer`:n.push(e(()=>import(`./OrientedImageryLayer-Cv9T7sQT.js`),__vite__mapDeps([31,1,2])).then(e=>e.default))}});let r=await Promise.all(n),i=new Map;return t.forEach(({type:e},t)=>{i.set(e,r[t])}),i}function I(e,t,n){e.isTable?L(n.tables,t):L(n.layers,t)}function L(e,t){let n=e.findIndex(({id:e})=>e===t.id);n===-1?e.push(t):e[n]=t}function R(e){if(!(`layerType`in e))return!!e.charts?.length;switch(e.layerType){case`OrientedImageryLayer`:return!!e.charts?.length;case`SubtypeGroupLayer`:return!!e.layers.some(e=>!!e.charts?.length);case`SubtypeGroupTable`:return!!e.tables.some(e=>!!e.charts?.length);case`CatalogLayer`:return!!e.footprintLayer?.charts?.length}}function z(e,t){let n=0,a=0,o=0,s=0;for(let e of[...t.layers,...t.tables])if(R(e)&&s++,`layerType`in e)switch(e.layerType){case`OrientedImageryLayer`:n++;break;case`SubtypeGroupLayer`:a++;break;case`SubtypeGroupTable`:o++}i(e,r.ORIENTED_IMAGERY_LAYER,n>0),i(e,r.SUBTYPE_GROUP_LAYER,a>0),i(e,r.SUBTYPE_GROUP_TABLE,o>0),i(e,r.CHARTS,s>0)}function B(e,t,n){a(t,r.METADATA),i(t,r.MULTI_LAYER,e.length>1),i(t,r.SINGLE_LAYER,e.length===1),i(t,r.TABLE,n.tables.length>0&&n.layers.length===0),z(t,n)}async function V(e,t,n){z(t,n)}async function H(e,n,r){let{url:i,layerId:a,title:o,fullExtent:s,isTable:c}=e;n.url=(l(i)?.serverType===`FeatureServer`?i:`${i}/${a}`)??null,n.title||=o,n.extent=null,c||s==null||(n.extent=await t(s)),B([e],n,r)}async function U(e,t){return p({layer:e,itemType:h,validateLayer:y,createJSONContext:t=>b(t,e),createItemData:(e,t)=>w(t,[e]),errorNamePrefix:_,setItemProperties:V},t)}async function W(e,t,n){return m({layer:e,itemType:h,validateLayer:y,createJSONContext:t=>b(t,e),createItemData:(e,t)=>Promise.resolve(C(e)),errorNamePrefix:v,newItem:t,setItemProperties:H},n)}export{U as save,W as saveAs};