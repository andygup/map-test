import{$T as e,A as t,BT as n,HT as r,L as i,Li as a,Lx as o,M as s,Rh as c,UT as l,Ua as u,VT as d,WT as f,Yh as p,ZS as m,aC as h,ca as g,iC as _,j as v,kC as y,kD as b,ma as x,pa as S,rC as C,sT as w,ua as T,xC as E,zC as D,zi as O}from"./index-BN8X5Ryz.js";import"./memoryEstimations-D_IbKyOk.js";import"./OptimizedGeometry-BQJ7w5VU.js";import"./OptimizedFeatureSet-CLjmRHYn.js";import"./featureConversionUtils-o9-cJXzl.js";import"./urlUtils-CW4cnJ3W.js";import{t as k}from"./imageBitmapUtils-CLE9aRyR.js";import"./pbf-CO6WFbVS.js";import"./pbfQueryUtils-CmJPTrN7.js";import"./queryUtils-8f7b9mi_.js";import"./query-BXrgTHrc.js";import"./executeForIds-Dq7stXFh.js";import"./executeQueryJSON-DJO3NDvM.js";import"./executeQueryPBF-i-SuhVUp.js";import"./QueryTask-6dVRoJFW.js";import"./TileInfoTilemapCache-DkoFuD4x.js";import"./TilemapCache-jwsQgZr5.js";import{t as A}from"./ArcGISCachedService-yM7NwnvX.js";import{n as j,r as M,t as N}from"./SublayersOwner-B-_OpOb-.js";import"./sublayerUtils-Dk4DSA02.js";var P,F=[`Canvas/World_Dark_Gray_Base`,`Canvas/World_Dark_Gray_Reference`,`Canvas/World_Light_Gray_Base`,`Canvas/World_Light_Gray_Reference`,`Elevation/World_Hillshade`,`Elevation/World_Hillshade_Dark`,`Ocean/World_Ocean_Base`,`Ocean/World_Ocean_Reference`,`Ocean_Basemap`,`Reference/World_Boundaries_and_Places`,`Reference/World_Boundaries_and_Places_Alternate`,`Reference/World_Transportation`,`World_Imagery`,`World_Street_Map`,`World_Topo_Map`],I=P=class extends T(t(N(A(M(i(s(S(u(v(x(g(c)))))))))))){constructor(...e){super(...e),this.listMode=`show`,this.elevationInfo=new O({mode:`on-the-ground`}),this.isReference=null,this.operationalLayerType=`ArcGISTiledMapServiceLayer`,this.resampling=!0,this.sourceJSON=null,this.spatialReference=null,this.path=null,this.sublayers=null,this.type=`tile`,this.url=null}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}load(e){let t=e==null?null:e.signal;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:[`Map Service`]},e).catch(w).then(()=>this._fetchService(t))),Promise.resolve(this)}get attributionDataUrl(){let e=this.parsedUrl?.path.toLowerCase();return e?this._getDefaultAttribution(this._getMapName(e)):null}get hasAttributionData(){return super.hasAttributionData}readSpatialReference(e,t){return(e||=t.tileInfo?.spatialReference)&&o.fromJSON(e)}writeSublayers(e,t,n,r){if(!this.loaded||!e)return;let i=e.slice().reverse().flatten(({sublayers:e})=>e&&e.toArray().reverse()).toArray(),a=[],o={writeSublayerStructure:!1,...r};i.forEach(e=>{let t=e.write({},o);a.push(t)}),a.some(e=>Object.keys(e).length>1)&&(t.layers=a)}get tileServers(){return this._getDefaultTileServers(this.parsedUrl?.path)}castTileServers(e){return Array.isArray(e)?e.map(e=>y(e).path):null}fetchTile(e,t,n,r={}){let{signal:i}=r,a=this.getTileUrl(e,t,n),o={responseType:`image`,signal:i,query:{...this.refreshParameters}};return m(a,o).then(e=>e.data)}async fetchImageBitmapTile(e,t,n,r={}){let{signal:i}=r;if(this.fetchTile!==P.prototype.fetchTile){let a=await this.fetchTile(e,t,n,r);return k(a,e,t,n,i)}let a=this.getTileUrl(e,t,n),o={responseType:`blob`,signal:i,query:{...this.refreshParameters}},{data:s}=await m(a,o);return k(s,e,t,n,i)}getTileUrl(e,t,n){let r=!this.capabilities.operations.supportsTileMap&&this.supportsBlankTile,i=E({...this.parsedUrl?.query,blankTile:!r&&null,...this.customParameters,token:this.apiKey}),a=this.tileServers;return`${a&&a.length?a[t%a.length]:this.parsedUrl?.path}/tile/${e}/${t}/${n}${i?`?`+i:``}`}loadAll(){return p(this,e=>{e(this.allSublayers)})}_fetchService(t){return new Promise((n,r)=>{if(this.sourceJSON){if(this.sourceJSON.bandCount!=null&&this.sourceJSON.pixelSizeX!=null)throw new e(`tile-layer:unsupported-url`,`use ImageryTileLayer to open a tiled image service`);n({data:this.sourceJSON});return}if(!this.parsedUrl)throw new e(`tile-layer:undefined-url`,`layer's url is not defined`);let i=_(this.parsedUrl.path);if(i!=null&&i.serverType===`ImageServer`)throw new e(`tile-layer:unsupported-url`,`use ImageryTileLayer to open a tiled image service`);m(this.parsedUrl.path,{query:{f:`json`,...this.parsedUrl.query,...this.customParameters,token:this.apiKey},responseType:`json`,signal:t}).then(n,r)}).then(e=>{let n=this.url;if(e.ssl&&(n=this.url=n.replace(/^http:/i,`https:`)),this.sourceJSON=e.data,this.read(e.data,{origin:`service`,url:this.parsedUrl}),this.version===10.1&&!h(n))return this._fetchServerVersion(n,t).then(e=>{this.read({currentVersion:e})}).catch(()=>{})})}_fetchServerVersion(t,n){if(!C(t))return Promise.reject();let r=t.replace(/(.*\/rest)\/.*/i,`$1`)+`/info`;return m(r,{query:{f:`json`,...this.customParameters,token:this.apiKey},responseType:`json`,signal:n}).then(t=>{if(t.data?.currentVersion)return t.data.currentVersion;throw new e(`tile-layer:version-not-available`,`Server did not provide a version`)})}_getMapName(e){let t=e.match(/^(?:https?:)?\/\/(server\.arcgisonline\.com|services\.arcgisonline\.com|ibasemaps-api\.arcgis\.com)\/arcgis\/rest\/services\/([^/]+(\/[^/]+)*)\/mapserver/i);return t?t[2]:void 0}_getDefaultAttribution(e){if(e==null)return null;let t;e=e.toLowerCase();for(let n=0,r=F.length;n<r;n++)if(t=F[n],t.toLowerCase().includes(e))return D(`//static.arcgis.com/attribution/`+t);return null}_getDefaultTileServers(e){if(e==null)return[];let t=e.search(/^(?:https?:)?\/\/server\.arcgisonline\.com/i)!==-1,n=e.search(/^(?:https?:)?\/\/services\.arcgisonline\.com/i)!==-1;return t||n?[e,e.replace(t?/server\.arcgisonline/i:/services\.arcgisonline/i,t?`services.arcgisonline`:`server.arcgisonline`)]:[]}get hasOverriddenFetchTile(){return!this.fetchTile[L]}};b([n({readOnly:!0})],I.prototype,`attributionDataUrl`,null),b([n({type:[`show`,`hide`,`hide-children`]})],I.prototype,`listMode`,void 0),b([n({json:{read:!0,write:!0}})],I.prototype,`blendMode`,void 0),b([n()],I.prototype,`elevationInfo`,void 0),b([n({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],I.prototype,`isReference`,void 0),b([n({readOnly:!0,type:[`ArcGISTiledMapServiceLayer`]})],I.prototype,`operationalLayerType`,void 0),b([n({type:Boolean})],I.prototype,`resampling`,void 0),b([n()],I.prototype,`sourceJSON`,void 0),b([n({type:o})],I.prototype,`spatialReference`,void 0),b([f(`spatialReference`,[`spatialReference`,`tileInfo`])],I.prototype,`readSpatialReference`,null),b([n({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],I.prototype,`path`,void 0),b([n({readOnly:!0})],I.prototype,`sublayers`,void 0),b([l(`sublayers`,{layers:{type:[j]}})],I.prototype,`writeSublayers`,null),b([n({json:{read:!1,write:!1}})],I.prototype,`popupEnabled`,void 0),b([n()],I.prototype,`tileServers`,null),b([r(`tileServers`)],I.prototype,`castTileServers`,null),b([n({readOnly:!0,json:{read:!1}})],I.prototype,`type`,void 0),b([n(a)],I.prototype,`url`,void 0),I=P=b([d(`esri.layers.TileLayer`)],I);var L=Symbol(`default-fetch-tile`);I.prototype.fetchTile[L]=!0;var R=I;export{R as default};