import{$T as e,CE as t,Eu as n,JT as r,QT as i,Tu as a,ZS as o,iw as s,kD as c,lm as l,om as u,qh as d,vE as f,wn as p,wu as m}from"./index-BN8X5Ryz.js";import{t as h}from"./arcadeEnvironment-DUP-IKH2.js";import{B as g,X as _,nt as v,t as y}from"./Dictionary-Db5-uVgu.js";import{t as b}from"./commonProperties-CaHgSHvW.js";var x=class extends s{constructor(e){super(e),this.text=null,this.detectedLanguage=`en`,this.detectedLanguageScore=-1}};c([i({type:String,json:{write:!0}})],x.prototype,`key`,void 0),c([i({type:String,json:{write:!0}})],x.prototype,`text`,void 0),c([i({type:String,json:{read:{source:`detectedLanguage.language`},write:{target:`detectedLanguage.language`}}})],x.prototype,`detectedLanguage`,void 0),c([i({type:Number,json:{read:{source:`detectedLanguage.score`},write:{target:`detectedLanguage.score`}}})],x.prototype,`detectedLanguageScore`,void 0),c([i({type:Object,json:{write:!0}})],x.prototype,`translation`,void 0),x=c([r(`esri.rest.support.TranslateResult`)],x);async function S(e,t,r){let i=t.toJSON();i.contents=JSON.stringify(i.contents),i.token=await m(t.portalUrl,t.apiKey,{signal:r?.signal,prompt:r?.authMode!==`no-prompt`});let s=a(e),c=n(s.query,{...r,query:i,method:`post`,authMode:`anonymous`});return(await o(s.path,c)).data.results.map(e=>x.fromJSON(e))}var C=class extends s{constructor(e){super(e)}};c([i({type:String,json:{write:!0}})],C.prototype,`key`,void 0),c([i({type:String,json:{write:!0}})],C.prototype,`text`,void 0),C=c([r(`esri.rest.support.TranslateContent`)],C);var w=class extends s{constructor(e){super(e),this.to=null,this.contents=null,this.portalUrl=`https://www.arcgis.com`,this.translator=`esri`,this.from=null,this.apiKey=null,this.requestSource=null}};c([i({type:[String],json:{write:!0}})],w.prototype,`to`,void 0),c([i({type:[C],json:{write:!0}})],w.prototype,`contents`,void 0),c([i({type:String,json:{write:!0}})],w.prototype,`portalUrl`,void 0),c([i({type:String,json:{write:!0,default:`esri`}})],w.prototype,`translator`,void 0),c([i({type:String,json:{write:!0}})],w.prototype,`from`,void 0),c([i(b)],w.prototype,`apiKey`,void 0),c([i({type:String,json:{name:`x-esri-request-source`}})],w.prototype,`requestSource`,void 0),w=c([r(`esri.rest.support.TranslateParameters`)],w);var T=class{constructor(e,t){this.portal=e,this._debugLog=t}async translate(n){this.portal.loaded||await this.portal.load();let r=this.portal.helperServices?.aiUtilityServices;if(r==null)return{success:!1};let i=r.url+r.translateUtility;try{return n.requestSource??=`arcade`,{success:!0,results:(await S(i,n,{authMode:`no-prompt`})).map(e=>e.toJSON())}}catch(n){return this._debugLog!=null&&(n instanceof Error||n instanceof e)&&this._debugLog(`TranslateText error: ${n.message}`),t.getLogger(`esri.arcade.functions.aiServices`).error(n),{success:!1}}}},E=class{constructor(e,t,n){this._parameters=e,this._maxTotalContentSize=t,this._maxContentsLength=n,this._requests=[],this._normalizedContents=new Map,this._contentsTotalSize=0}tryAdd(e){let t=new Set(e.filter(e=>!this._normalizedContents.has(e.text)).map(e=>e.text));if(this._requests.length+t.size>this._maxContentsLength)return null;let n=0;for(let e of t)n+=e.length;if((n+this._contentsTotalSize)*(this._parameters.to.length??1)>this._maxTotalContentSize)return null;let r=this._requests.length;for(let{key:t,text:n}of e)f(this._normalizedContents,n,()=>[]).push({batchIdx:r,key:t});return this._requests.push(e),this._contentsTotalSize+=n,r}async send(e){let t=[],n=[],r=0;for(let[e,i]of this._normalizedContents)t.push(new C({key:String(r++),text:e})),n.push(i);let i=new w(this._parameters);i.contents=t;let a=await e.translate(i);if(!a.success)return Array.from(this._requests,()=>a);let o=Array.from(this._requests,()=>({success:!0,results:[]}));for(let e of a.results){let t=Number(e.key);for(let r of n[t])o[r.batchIdx].results.push({...e,key:r.key})}return o}};function D(e){let t=[...new Set(e.to)].sort(),n=e.from??null,r=e.portalUrl,i=e.translator,a=e.apiKey??null;return JSON.stringify([t,n,r,i,a])}async function O(e,t,n){try{return(await e.yieldFor(n))[t]}catch{return{success:!1}}}var k=class{constructor(e,t,{maxTotalContentSize:n=5e4,maxContentsLength:r=1e3}={}){this._executor=e,this._service=t,this._openBatches=new Map,this._maxTotalContentSize=n,this._maxContentsLength=r}create(e){return{translate:async t=>{let n=D(t),{contents:r,to:i,from:a,translator:o,portalUrl:s,apiKey:c}=t;if(i==null||r==null||r.every(e=>e.text.length===0))return{success:!1};let l=this._openBatches.get(n);if(l!=null){let t=l.data.tryAdd(r);if(t!=null)return await O(e,t,l);l.send()}let u=new E({to:i,from:a,translator:o,portalUrl:s,apiKey:c},this._maxTotalContentSize,this._maxContentsLength),d=u.tryAdd(r);if(d!=null){let t=this._executor.openBatch(u,{open:e=>{this._openBatches.set(n,e)},execute:e=>e.send(this._service),close:e=>{this._openBatches.get(n)===e&&this._openBatches.delete(n)}});return await O(e,d,t)}return await this._service.translate(t)}}}};function A(e){e.mode===`async`&&(e.functions[h(`TranslateText`)]=function(t,n){return e.standardFunctionAsync(t,n,async(e,t,n)=>{if(_(n,2,3,e,t),!u(n[0])&&!l(n[0])&&!v(n[0]))throw new p(e,`InvalidParameter`,t);let r=g(n[0]);if(!u(n[1])&&!l(n[1])&&!v(n[1]))throw new p(e,`InvalidParameter`,t);let i=g(n[1]),a=null;if(n.length>=3){if(!u(n[2]))throw new p(e,`InvalidParameter`,t);a=n[2]}let o=r.map((e,t)=>new C({key:String(t),text:e})),s=e.services?.portal??d.getDefault(),c=new w({to:i,contents:o,from:a,portalUrl:s.restUrl.replace(/\/sharing\/rest$/,``)}),f=new Map,m=null;if(e.lrucache!=null){let t=e.lrucache;m??=D(c),c.contents=c.contents?.filter(e=>{let n=t.getCachedTranslation(m,e.text);return n==null||(f.set(e.key,{...n,key:e.key,text:e.text}),!1)})}if(c.contents?.length){let t=e.services?.translation??new T(s,e.console),n=await t.translate(c);if(!n.success)return new y({__proto__:null,success:!1});for(let t of n.results){let n=c.contents?.find(e=>e.key===t.key)?.text;if(n==null)throw new p(null,`NeverReach`,null);f.set(t.key,t),e.lrucache!=null&&(m??=D(c),e.lrucache.setCachedTranslation(m,n,{detectedLanguage:t.detectedLanguage,translation:t.translation}))}}let h=Array.from(o,t=>{let n=x.fromJSON(f.get(t.key));if(n==null)throw new p(null,`NeverReach`,null);return n.text=t.text,y.convertJsonToArcade(n.toJSON(),e.timeZone??`system`,!0)});return new y({__proto__:null,success:!0,results:h})})})}var j=Object.freeze(Object.defineProperty({__proto__:null,BatchTranslationServiceFactory:k,PortalTranslationService:T,getTranslateParametersKey:D,registerFunctions:A},Symbol.toStringTag,{value:`Module`}));export{D as a,k as i,j as n,T as r,A as t};