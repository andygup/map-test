import{$c as e,DT as t,OT as n,Vl as r,Xc as i,Zc as a,_S as o,gD as s,qw as c,tl as l,uE as u}from"./index-CZ4oMP1N.js";import"./memoryEstimations-DQOvnrRz.js";import"./OptimizedGeometry-hOUTi-cB.js";import"./OptimizedFeatureSet-CTIqq8fn.js";import"./featureConversionUtils-_DSSMFQ2.js";import"./earcut-BF1-mB58.js";import"./layerViewUtils-RSw-QNoB.js";import"./VertexAttributeLocations-CfzeuYMz.js";import"./VertexElementDescriptor-ju-1bdWe.js";import"./BoundingBox-CLkiiRfJ.js";import"./config-BSvujflG.js";import"./WGLContainer-D_aBMsnu.js";import"./utils-DS5dbHj4.js";import"./ProgramTemplate-BXau1qoF.js";import"./VertexArrayObject-DEfjd5y-.js";import"./BufferObject-q8zuTMny.js";import"./VertexBuffer-xVpphTb4.js";import"./vec3f32-B2H3-fiA.js";import"./Container-BuEih3Ua.js";import"./GraphShaderModule-D5RCsL2_.js";import"./FramebufferObject-BhBPSr-C.js";import"./ShaderBuilder-D3cV1oap.js";import"./bitmapUtils-SuGDUZFe.js";import"./Bitmap-CiNUpq9T.js";import{t as d}from"./LayerView2D-BsKgTWnO.js";import{t as f}from"./LayerView-2jeNRFkG.js";import{t as p}from"./RefreshableLayerView-CXmtIjA5.js";import"./TileContainer-B6yQthEI.js";import{r as m,t as h}from"./imageUtils-H_6DvHN1.js";var g=[0,0],_=class extends p(m(d(f))){constructor(){super(...arguments),this._tileStrategy=null,this._fetchQueue=null,this.layer=null}get tileMatrixSet(){let{activeLayer:e}=this.layer,{tileMatrixSet:t}=e;if(t&&o(t.tileInfo?.spatialReference,this.view.spatialReference))return t;let n=this._getTileMatrixSetBySpatialReference(e);return n&&n.id!==e.tileMatrixSetId?(e.tileMatrixSetId=n.id,n):null}update(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume()}attach(){let t=this.tileMatrixSet?.tileInfo;t&&(this._tileInfoView=new e(t),this._fetchQueue=new a({tileInfoView:this._tileInfoView,concurrency:16,process:(e,t)=>this.fetchTile(e,t),scheduler:this.scheduler,priority:r.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new i({cachePolicy:`keep`,resampling:!0,acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView}),this.addAttachHandles(this._updatingHandles.add(()=>[this.layer?.activeLayer?.styleId,this.tileMatrixSet],()=>this.doRefresh())),super.attach())}detach(){super.detach(),this._tileStrategy?.destroy(),this._fetchQueue?.destroy(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return this.layer.activeLayer.tileMatrixSets?.some(t=>o(t.tileInfo?.spatialReference,e))??!1}async doRefresh(){if(this.attached){if(this.suspended)return this._tileStrategy.clear(),void this.requestUpdate();this._fetchQueue.reset(),this._tileStrategy.refresh(e=>this._updatingHandles.addPromise(this._enqueueTileFetch(e)))}}acquireTile(e){let t=this._bitmapView.createTile(e),n=t.bitmap;return[n.x,n.y]=this._tileInfoView.getTileCoords(g,t.key),n.resolution=this._tileInfoView.getTileResolution(t.key),[n.width,n.height]=this._tileInfoView.tileInfo.size,this._updatingHandles.addPromise(this._enqueueTileFetch(t)),this._bitmapView.addChild(t),this.requestUpdate(),t}releaseTile(e){this._fetchQueue.abort(e.key.id),this._bitmapView.removeChild(e),e.once(`detach`,()=>e.destroy()),this.requestUpdate()}async fetchTile(e,t={}){let n=`tilemapCache`in this.layer?this.layer.tilemapCache:null,{signal:r,resamplingLevel:i=0}=t;if(!n)return this._fetchImage(e,r);let a=new l(0,0,0,0),o;try{await n.fetchAvailabilityUpsample(e.level,e.row,e.col,a,{signal:r}),o=await this._fetchImage(a,r)}catch(n){if(c(n))throw n;if(i<3){let n=this._tileInfoView.getTileParentId(e.id);if(n){let r=new l(n),a=await this.fetchTile(r,{...t,resamplingLevel:i+1});return h(this._tileInfoView,a,r,e)}}throw n}return h(this._tileInfoView,o,a,e)}canResume(){return super.canResume()&&this.tileMatrixSet!==null}async _enqueueTileFetch(e){if(!this._fetchQueue.has(e.key.id)){try{let t=await this._fetchQueue.push(e.key);e.bitmap.source=t,e.bitmap.width=this._tileInfoView.tileInfo.size[0],e.bitmap.height=this._tileInfoView.tileInfo.size[1],e.once(`attach`,()=>this.requestUpdate())}catch(e){c(e)||u.getLogger(this).error(e)}this.requestUpdate()}}async _fetchImage(e,t){return this.layer.fetchImageBitmapTile(e.level,e.row,e.col,{signal:t})}_getTileMatrixSetBySpatialReference(e){return e.tileMatrixSets?.find(e=>o(e.tileInfo?.spatialReference,this.view.spatialReference))}};s([t({readOnly:!0})],_.prototype,`tileMatrixSet`,null),_=s([n(`esri.views.2d.layers.WMTSLayerView2D`)],_);var v=_;export{v as default};