import{$p as e,Ih as t,Xm as n,Xp as r,Zm as i,bn as a,em as o,g as s,gn as c,pn as l,qE as u,s as d,ud as f,vd as p,vn as m,wn as h,yn as g,zw as _}from"./index-CzMixifc.js";import{n as v}from"./arcadeEnvironment-BvmpPtDd.js";import{t as ee}from"./ImmutableArray-C3KNQCVd.js";import{$ as y,F as b,I as x,J as S,K as C,L as w,N as T,O as E,W as D,Y as O,ct as k,o as A,p as te,s as j,t as M,tt as N,v as P,y as ne,z as re}from"./Dictionary-CGt1qKCN.js";import{d as F,f as I,h as L,l as R,m as z,n as B,o as ie,u as ae}from"./shared-DVF4C5pR.js";import"./number-D2fZD7kK.js";import{n as oe}from"./Feature-2QyVo8eG.js";import"./memoryEstimations-C3WUBUZI.js";import"./OptimizedGeometry-5fDazGe-.js";import"./OptimizedFeatureSet-D4F9ObY_.js";import"./featureConversionUtils-VvJ2pauf.js";import{i as se,n as ce,r as V,t as H}from"./WhereClause-2gh-KjwG.js";import{t as le}from"./fieldStats-zmanK7EC.js";import{t as ue}from"./ArcadePortal-CAomFS7x.js";import"./Attachment-CF32PXLj.js";import{t as de}from"./portalUtils-bqU8Rp5_.js";import"./operatorsWorkerConnection-D_CeJsIM.js";import{c as fe,d as U,l as pe,n as me,o as he,s as ge,t as W,u as _e}from"./featureSetUtils-OelstKa-.js";import{C as G,S as K,_ as ve,b as ye,c as be,d as xe,f as Se,g as Ce,h as q,i as we,l as Te,m as Ee,n as De,o as Oe,p as ke,s as Ae,u as je,v as Me,y as Ne}from"./FeatureSet-B1gniK-o.js";import"./urlUtils-7tPnOsRB.js";import"./queryRelatedRecords-tkpAEmVF.js";import{t as Pe}from"./Empty-D8NMSeY8.js";import"./Association-BTt4cC6p.js";import{t as Fe}from"./queryAssociations-BLG87JKP.js";import{t as Ie}from"./QueryAssociationsParameters-bLrF_EAj.js";var Le=class{constructor(e){this.field=e,this.sqlRewritable=!1}postInitialization(e,t){}},J=class extends Le{constructor(e){super(e),this.sqlRewritable=!0}extractValue(e){return e.attributes[this.field.name]}rewriteSql(e){return{rewritten:this.sqlRewritable,where:e}}},Y=class extends Le{constructor(e,t,n){super(L(e)),this.originalField=e,this.sqlRewritable=!0,this.field.name=t,this.field.alias=n}rewriteSql(e,t){return{rewritten:this.sqlRewritable,where:Ce(e,this.field.name,this.originalField.name,t.getFieldsIndex())}}extractValue(e){return e.attributes[this.originalField.name]}},Re=class e extends Le{constructor(e,t,n){for(let r in super(e),this.codefield=t,this._stringToCode=n,this._codeToString={},n)this._codeToString[n[r]]=r;this.sqlRewritable=!0}static{this.BADNESS=`_!!!_BAD_LKP_!!!!`}rewriteSql(t,n){let r=this.evaluateNodeToWhereClause(t.parseTree,0,this.field.name,this.codefield instanceof H?q(this.codefield,0):this.codefield,t.parameters);return r.includes(e.BADNESS)?{rewritten:!1,where:t}:{rewritten:this.sqlRewritable,where:H.create(r,{fieldsIndex:n._parent.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})}}evaluateNodeToWhereClause(t,n,r=null,i=null,a){switch(t.type){case`interval`:return Ae(this.evaluateNodeToWhereClause(t.value,n,r,i,a),t.qualifier,t.op);case`case-expression`:{let i=` CASE `;t.format===`simple`&&(i+=this.evaluateNodeToWhereClause(t.operand,n,r,e.BADNESS,a));for(let o of t.clauses)i+=` WHEN `+this.evaluateNodeToWhereClause(o.operand,n,r,e.BADNESS,a)+` THEN `+this.evaluateNodeToWhereClause(o.value,n,r,e.BADNESS,a);return t.else!==null&&(i+=` ELSE `+this.evaluateNodeToWhereClause(t.else,n,r,e.BADNESS,a)),i+=` END `,i}case`parameter`:{let e=a[t.value.toLowerCase()];return typeof e==`string`?`'`+e.toString().replaceAll(`'`,`''`)+`'`:ae(e)||z(e)?Oe(e,n):F(e)?be(e,n):R(e)?ye(e,n):I(e)?je(e,n):Array.isArray(e)?e.map(e=>typeof e==`string`?`'`+e.toString().replaceAll(`'`,`''`)+`'`:ae(e)||z(e)?Oe(e,n):F(e)?be(e,n):R(e)?ye(e,n):I(e)?je(e,n):e.toString()):e.toString()}case`expression-list`:{let e=[];for(let o of t.value)e.push(this.evaluateNodeToWhereClause(o,n,r,i,a));return e}case`unary-expression`:return` ( NOT `+this.evaluateNodeToWhereClause(t.expr,n,r,e.BADNESS,a)+` ) `;case`binary-expression`:switch(t.operator){case`AND`:return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` AND `+this.evaluateNodeToWhereClause(t.right,n,r,i,a)+`) `;case`OR`:return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` OR `+this.evaluateNodeToWhereClause(t.right,n,r,i,a)+`) `;case`IS`:if(t.right.type!==`null`)throw new V(`UnsupportedIsRhs`);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IS NULL )`;case`ISNOT`:if(t.right.type!==`null`)throw new V(`UnsupportedIsRhs`);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IS NOT NULL )`;case`IN`:{if(t.right.type===`expression-list`){if(t.left.type===`column-reference`&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){let e=[],o=!0;for(let n of t.right.value){if(n.type!==`string`){o=!1;break}if(this._stringToCode[n.value]===void 0){o=!1;break}e.push(this._stringToCode[n.value].toString())}if(o)return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IN (`+e.join(`,`)+`)) `}let e=this.evaluateNodeToWhereClause(t.right,n,r,i,a);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IN (`+e.join(`,`)+`)) `}let e=this.evaluateNodeToWhereClause(t.right,n,r,i,a);return Array.isArray(e)?` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IN (`+e.join(`,`)+`)) `:` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` IN (`+e+`)) `}case`NOT IN`:{if(t.right.type===`expression-list`){if(t.left.type===`column-reference`&&t.left.column.toUpperCase()===this.field.name.toUpperCase()){let e=[],o=!0;for(let n of t.right.value){if(n.type!==`string`){o=!1;break}if(this._stringToCode[n.value]===void 0){o=!1;break}e.push(this._stringToCode[n.value].toString())}if(o)return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` NOT IN (`+e.join(`,`)+`)) `}let e=this.evaluateNodeToWhereClause(t.right,n,r,i,a);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` NOT IN (`+e.join(`,`)+`)) `}let e=this.evaluateNodeToWhereClause(t.right,n,r,i,a);return Array.isArray(e)?` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` NOT IN (`+e.join(`,`)+`)) `:` (`+this.evaluateNodeToWhereClause(t.left,n,r,i,a)+` NOT IN (`+e+`)) `}case`BETWEEN`:{let i=this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` BETWEEN `+i[0]+` AND `+i[1]+` ) `}case`NOTBETWEEN`:{let i=this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a);return` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` NOT BETWEEN `+i[0]+` AND `+i[1]+` ) `}case`LIKE`:return t.escape===``?` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` LIKE `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+`) `:` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` LIKE `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+` ESCAPE '`+t.escape+`') `;case`NOT LIKE`:return t.escape===``?` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` NOT LIKE `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+`) `:` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` NOT LIKE `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+` ESCAPE '`+t.escape+`') `;case`<>`:case`=`:if(t.left.type===`column-reference`&&t.right.type===`string`){if(t.left.column.toUpperCase()===this.field.name.toUpperCase()&&this._stringToCode[t.right.value.toString()]!==void 0)return` (`+i+` `+t.operator+` `+this._stringToCode[t.right.value.toString()].toString()+`) `}else if(t.right.type===`column-reference`&&t.left.type===`string`&&t.right.column.toUpperCase()===this.field.name.toUpperCase())return` (`+this._stringToCode[t.left.value.toString()].toString()+` `+t.operator+` `+i+`) `;return` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` `+t.operator+` `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+`) `;case`<`:case`>`:case`>=`:case`<=`:case`*`:case`-`:case`+`:case`/`:case`||`:return` (`+this.evaluateNodeToWhereClause(t.left,n,r,e.BADNESS,a)+` `+t.operator+` `+this.evaluateNodeToWhereClause(t.right,n,r,e.BADNESS,a)+`) `}case`null`:return`null`;case`boolean`:return!0===t.value?`1`:`0`;case`string`:return`'`+t.value.toString().replaceAll(`'`,`''`)+`'`;case`timestamp`:return`timestamp '${t.value}'`;case`date`:return`date '${t.value}'`;case`time`:return`time '${t.value}'`;case`number`:return t.value.toString();case`current-time`:return Ne(t.mode,n);case`current-user`:return`CURRENT_USER`;case`column-reference`:return r&&r.toLowerCase()===t.column.toLowerCase()?`(`+i+`)`:Se(t);case`data-type`:return t.value;case`function`:{let i=this.evaluateNodeToWhereClause(t.args,n,r,e.BADNESS,a);return Ee(t.name,i,n)}}throw new V(`UnsupportedSyntax`,{node:t.type})}extractValue(e){if(this.codefield instanceof H){let t=this.codefield.calculateValueCompiled(e);return this._codeToString[H.convertValueToStorageFormat(t)]}return this._codeToString[e.attributes[this.codefield]]}},X=class extends Le{constructor(e,t){super(e),this._sql=t}rewriteSql(e,t){return{rewritten:!0,where:Ce(e,this.field.name,q(this._sql,0),t.getFieldsIndex())}}extractValue(e){return H.convertValueToStorageFormat(this._sql.calculateValueCompiled(e),this.field.type)}},Z=class extends we{static findField(e,t){for(let n of e)if(n.name.toLowerCase()===t.toString().toLowerCase())return n;return null}constructor(e){super(),this.declaredClass=`esri.arcade.featureset.actions.Adapted`,this._maxProcessing=30,this._parent=e.parentfeatureset,this._adaptedFields=e.adaptedFields,this._extraFilter=e.extraFilter}_initialiseFeatureSet(){this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types,this.fields=[];for(let e of this._adaptedFields)e.postInitialization(this,this._parent),this.fields.push(e.field)}async _queryAll(){return await this._ensureLoaded(),this._extraFilter?(await this.query({abortSignal:v})).features:this._calculateFields(await this._parent.queryAll(v))}async query(e){let t=e.where??null,n=this._reformulateWithoutAdaptions(t),r=n.cannot;t=n.where;let i=!1,a=e.orderBy;if(a!=null){i=!0;let e=[];for(let t of this._adaptedFields)if(!(t instanceof J)&&!0===a.scanForField(t.field.name)){if(!(t instanceof Y)){a=null,i=!1;break}e.push({field:t.field.name,newfield:t.originalField.name})}a&&e.length>0&&(a=a.replaceFields(e))}t==null?t=this._extraFilter:this._extraFilter!=null&&(t=ve(this._extraFilter,t)),await this._ensureLoaded();let o=await this._parent.query({...e,where:t,orderBy:a});return G(e.abortSignal),r?{...o,filterApplied:!1,ordered:!!i&&o.ordered,features:this._calculateFields(o.features)}:{...o,ordered:!!i&&o.ordered,features:this._calculateFields(o.features)}}async*_calculateFields(e){for await(let t of e)yield t.map(e=>{let t={};for(let n of this._adaptedFields)t[n.field.name]=n.extractValue(e);return{attributes:t,geometry:e.geometry}})}async queryStat(e){let t=!1,n=e.field,r=this._reformulateWithoutAdaptions(n);t=r.cannot,n=r.where;let i=e.where??null;if(r=this._reformulateWithoutAdaptions(i),t||=r.cannot,i=r.where,i==null?i=this._extraFilter:this._extraFilter!==null&&(i=ve(this._extraFilter,i)),t)return i==null&&e.spatialFilter==null?this._manualStat(e.stat,n,e.limit??1e3,e.abortSignal):{calculated:!1};let a=await this._parent.queryStat({...e,field:n,where:i});return a.calculated?a:i==null&&e.spatialFilter==null?this._manualStat(e.stat,n,e.limit??1e3,e.abortSignal):{calculated:!1}}async canQueryAggregate(e){for(let t of e.groupBy)for(let e of this._adaptedFields)if(t.toLowerCase()===e.field.name.toLowerCase()&&!(e instanceof J))return!1;let t=[];for(let n of e.statistics)if(n.workingexpr!==null){let e=this._reformulateWithoutAdaptions(n.workingexpr);if(e.cannot)return!1;let r=n.clone();r.workingexpr=e.where,t.push(r)}else t.push(n);let n=e.where??null,r=this._reformulateWithoutAdaptions(n);return!r.cannot&&(n=r.where,n===null?n=this._extraFilter:this._extraFilter!==null&&(n=ve(this._extraFilter,n)),this._parent.canQueryAggregate({...e,statistics:t,where:n}))}async queryAggregate(e){let t=[];for(let n of e.statistics)if(n.workingexpr!==null){let e=this._reformulateWithoutAdaptions(n.workingexpr);if(e.cannot)throw new K(`NeverReach`);let r=n.clone();r.workingexpr=e.where,t.push(r)}else t.push(n);let n=e.where??null,r=this._reformulateWithoutAdaptions(n);if(r.cannot)throw new K(`NeverReach`);return n=r.where,n===null?n=this._extraFilter:this._extraFilter!==null&&(n=ve(this._extraFilter,n)),this._parent.queryAggregate({...e,statistics:t,where:n})}_reformulateWithoutAdaptions(e){let t={cannot:!1,where:e};if(e!==null){for(let n of this._adaptedFields)if(!0===xe(e,n.field.name)){let r=n.rewriteSql(e,this);if(!0!==r.rewritten){t.cannot=!0,t.where=null;break}t.where=r.where}}return t}},ze=class extends we{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.actions.OrderBy`,this._maxProcessing=100,this._parent=e.parentfeatureset,this._orderByClause=e.orderbyclause}async _queryAll(){return(await this.query({abortSignal:v})).features}async query(e){await this._ensureLoaded();let t=await this._parent.query({...e,orderBy:e.orderBy==null?this._orderByClause:e.orderBy});return G(e.abortSignal),!1===t.ordered?{...t,ordered:!0,features:this._sortFeatures(t.features,e.abortSignal)}:t}async*_sortFeatures(e,t){let n=[];for await(let r of e)n.push(r),await x(),G(t);let r=n.flat();this._orderByClause.order(r);for(let e of u(r,this._maxQueryRate()))yield e}async queryStat(e){let t=await this._parent.queryStat(e);return t.calculated?t:e.where==null&&e.spatialFilter==null?this._manualStat(e.stat,e.field,e.limit??1e3,e.abortSignal):{calculated:!1}}async canQueryAggregate(e){return this._parent.canQueryAggregate(e)}async queryAggregate(e){return this._parent.queryAggregate(e)}getFieldsIndex(){return this._parent.getFieldsIndex()}};function Be(e,t){return e===t?0:e===null?-1:t===null?1:e<t?-1:1}var Ve=class e{constructor(e){let t=e.split(`,`);this._fields=[],this._directions=[];for(let e=0;e<t.length;e++){let n=t[e].match(/\S+/g);this._fields.push(n[0]),n.length===2?n[1].toLowerCase()===`asc`?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let e=``;for(let t=0;t<this._fields.length;t++)t!==0&&(e+=`,`),e+=this._fields[t],this._directions[t]===1?e+=` ASC`:e+=` DESC`;return e}order(e){e.sort((e,t)=>{for(let n=0;n<this._fields.length;n++){let r=this.featureValue(e,this._fields[n],n),i=this.featureValue(t,this._fields[n],n),a=0;if(a=this._directions[n]===1?Be(r,i):-1*Be(r,i),a!==0)return a}return 0})}scanForField(e){for(let t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===e.toLowerCase().trim())return!0;return!1}replaceFields(t){let n=``;for(let e=0;e<this._fields.length;e++){e!==0&&(n+=`,`);let r=this._fields[e];for(let e of t)if(r.toLowerCase()===e.field.toLowerCase()){r=e.newfield;break}n+=r,this._directions[e]===1?n+=` ASC`:n+=` DESC`}return new e(n)}featureValue(e,t,n){let r=e.attributes[t];if(r!==void 0)return r;for(let r in e.attributes)if(t.toLowerCase()===r.toLowerCase())return this._fields[n]=r,e.attributes[r];return null}};function He(e){if(e.parseTree.type===`function`){if(e.parseTree.args.value.length===0)return{name:e.parseTree.name,expr:null};if(e.parseTree.args.value.length>1)throw new V(`MissingStatisticParameters`);let t=H.create(ke(e.parseTree.args.value[0],0,e.parameters),{fieldsIndex:e.fieldsIndex,timeZone:e.timeZone,currentUser:e.currentUser});return{name:e.parseTree.name,expr:t}}return null}var Ue=class e{constructor(){this.field=``,this.tofieldname=``,this.typeofstat=`MIN`,this.workingexpr=null}clone(){let t=new e;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}static parseStatField(t,n,r,i){let a=new e;a.field=t;let o=H.create(n,{fieldsIndex:r,timeZone:i}),s=He(o);if(s===null)throw new V(`UnsupportedSqlFunction`,{function:``});let c=s.name.toUpperCase().trim();if(c===`MIN`){if(a.typeofstat=`MIN`,a.workingexpr=s.expr,o===null)throw new V(`InvalidFunctionParameters`,{function:`min`})}else if(c===`MAX`){if(a.typeofstat=`MAX`,a.workingexpr=s.expr,o===null)throw new V(`InvalidFunctionParameters`,{function:`max`})}else if(c===`COUNT`)a.typeofstat=`COUNT`,a.workingexpr=s.expr;else if(c===`STDEV`){if(a.typeofstat=`STDDEV`,a.workingexpr=s.expr,o===null)throw new V(`InvalidFunctionParameters`,{function:`stdev`})}else if(c===`SUM`){if(a.typeofstat=`SUM`,a.workingexpr=s.expr,o===null)throw new V(`InvalidFunctionParameters`,{function:`sum`})}else if(c===`MEAN`){if(a.typeofstat=`AVG`,a.workingexpr=s.expr,o===null)throw new V(`InvalidFunctionParameters`,{function:c})}else if(c===`AVG`){if(a.typeofstat=`AVG`,a.workingexpr=s.expr,o===null)throw new V(`InvalidFunctionParameters`,{function:`avg`})}else{if(c!==`VAR`)throw new V(`UnsupportedSqlFunction`,{function:c});if(a.typeofstat=`VAR`,a.workingexpr=s.expr,o===null)throw new V(`InvalidFunctionParameters`,{function:`var`})}return a}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case`MIN`:return`min`;case`MAX`:return`max`;case`SUM`:return`sum`;case`COUNT`:default:return`count`;case`VAR`:return`var`;case`STDDEV`:return`stddev`;case`AVG`:return`avg`}}},We=new g([`MIN`,`MAX`,`VAR`,`STDDEV`,`COUNT`,`SUM`,`AVG`],[[`VARIANCE`,`VAR`],[`AVERAGE`,`AVG`],[`MEAN`,`AVG`],[`STDEV`,`STDDEV`]]),Ge=class extends we{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.actions.Aggregate`,this._decodedStatsFields=[],this._decodedGroupByFields=[],this._canDoSimpleGroupBy=!0,this._physicalGroupByFields=[],this.objectIdField=`ROW__ID`,this._adaptedFields=[],this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_nextUniqueName(e){for(;e[`T`+this._uniqueIds.toString()]===1;)this._uniqueIds++;let t=`T`+this._uniqueIds.toString();return e[t]=1,t}_convertToEsriFieldType(e){return e}_initialiseFeatureSet(){let e=this._parent.getFieldsIndex();this.objectIdField=`ROW__ID`,this.globalIdField=``;let t=!1,n=1;for(;!1===t;){let e=!1;for(let t of this._config.groupbyfields)if(t.name.toLowerCase()===this.objectIdField.toLowerCase()){e=!0;break}if(!1===e){for(let t of this._config.statsfields)if(t.name.toLowerCase()===this.objectIdField.toLowerCase()){e=!0;break}}!1===e?t=!0:(this.objectIdField=`ROW__ID`+n.toString(),n++)}for(let t of this._config.statsfields){let n=new Ue;n.field=t.name,n.tofieldname=t.name,n.workingexpr=t.expression instanceof H?t.expression:H.create(t.expression,{fieldsIndex:e,timeZone:this.dateFieldsTimeZoneDefaultUTC}),n.typeofstat=We.lookup(t.statistic)??`COUNT`,this._decodedStatsFields.push(n)}this._decodedGroupByFields=[];for(let t of this._config.groupbyfields){let n={name:t.name,singlefield:null,tofieldname:t.name,expression:t.expression instanceof H?t.expression:H.create(t.expression,{fieldsIndex:e,timeZone:this.dateFieldsTimeZoneDefaultUTC}),sqlType:null};this._decodedGroupByFields.push(n)}let r={};this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=``;for(let e of this._parent.fields)r[e.name.toUpperCase()]=1;this.types=null,this.subtypes=null,this.subtypeField=``,this.fields=[];let i=new Ue;i.field=this._nextUniqueName(r),i.tofieldname=this.objectIdField,i.workingexpr=H.create(this._parent.objectIdField,{fieldsIndex:this._parent.getFieldsIndex(),timeZone:this.dateFieldsTimeZoneDefaultUTC}),i.typeofstat=`MIN`,this._decodedStatsFields.push(i);for(let e of this._decodedGroupByFields){let t=new f;if(e.name=this._nextUniqueName(r),t.name=e.tofieldname,t.alias=t.name,Me(e.expression)){let n=this._parent.getField(q(e.expression,0));if(!n)throw new K(`AggregationFieldNotFound`);e.name=n.name,e.singlefield=n.name,this._physicalGroupByFields.push(n.name),t.type=n.type,e.sqlType=n.type}else{t.type=this._convertToEsriFieldType(Te(e.expression,this._parent.fields));let n=new f;n.name=e.name,n.alias=n.name,this._physicalGroupByFields.push(e.name),this._adaptedFields.push(new X(n,e.expression)),this._canDoSimpleGroupBy=!1,e.sqlType=t.type}this.fields.push(t)}if(this._adaptedFields.length>0)for(let e of this._parent.fields)this._adaptedFields.push(new J(e));for(let e of this._decodedStatsFields){let t=new f,n=null;e.field=this._nextUniqueName(r),t.name=e.tofieldname,t.alias=t.name;let i=e.workingexpr!==null&&Me(e.workingexpr)?q(e.workingexpr,0):``;switch(e.typeofstat){case`SUM`:if(i!==``){if(n=this._parent.getField(i),!n)throw new K(`AggregationFieldNotFound`);t.type=n.type}else t.type=`double`;break;case`MIN`:case`MAX`:if(i!==``){if(n=this._parent.getField(i),!n)throw new K(`AggregationFieldNotFound`);t.type=n.type}else t.type=`double`;break;case`COUNT`:t.type=`integer`;break;case`STDDEV`:case`VAR`:case`AVG`:if(i!==``&&(n=this._parent.getField(i),!n))throw new K(`AggregationFieldNotFound`);t.type=`double`}this.fields.push(t)}}async _queryAll(){return(await this.query({abortSignal:v})).features}async query(e){if(e.spatialFilter!=null)return De;let t={ordered:!1,nowhereclause:!1};await this._ensureLoaded();let n=e.where;if(n!=null){for(let e of this._decodedStatsFields)if(!0===xe(n,e.tofieldname)){t.nowhereclause=!0,n=null;break}}let r=e.orderBy;if(r!=null){t.ordered=!0;for(let e of this._decodedStatsFields)if(!0===r.scanForField(e.tofieldname)){r=null,t.ordered=!1;break}if(r!==null){for(let e of this._decodedGroupByFields)if(e.singlefield===null&&!0===r.scanForField(e.tofieldname)){r=null,t.ordered=!1;break}}}if(!1!==this._canDoSimpleGroupBy&&await this._parent.canQueryAggregate({groupBy:this._physicalGroupByFields,statistics:this._decodedStatsFields,where:null,spatialFilter:null,abortSignal:e.abortSignal})){let i=await this._parent.queryAggregate({groupBy:this._physicalGroupByFields,statistics:this._decodedStatsFields,where:n?this._reformulateWhereClauseWithoutGroupByFields(n):null,spatialFilter:null,orderBy:r?this._reformulateOrderClauseWithoutGroupByFields(r):null,abortSignal:e.abortSignal});return G(e.abortSignal),{...i,filterApplied:!t.nowhereclause&&i.filterApplied,ordered:!0===t.ordered&&i.ordered,features:this._fixAggregateAttributeNames(i.features)}}let i=this._adaptedFields.length>0?new Z({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null}):this._parent;if(!0===t.nowhereclause){let t=new ze({parentfeatureset:i,orderbyclause:new Ve(this._physicalGroupByFields.join(`,`)+`,`+this._parent.objectIdField+` ASC`)});return{filterApplied:!1,spatialFilterApplied:!1,ordered:!1,features:this._aggregateSortedFeatureGroups((await t.query({abortSignal:e.abortSignal})).features,this._maxQuery,e.abortSignal)}}let a=i;n!=null&&(a=new U({parentfeatureset:a,whereclause:this._reformulateWhereClauseWithoutGroupByFields(n)}));let o=new ze({parentfeatureset:a,orderbyclause:new Ve(this._physicalGroupByFields.join(`,`)+`,`+this._parent.objectIdField+` ASC`)});return{filterApplied:!1,spatialFilterApplied:!1,ordered:!1,features:this._aggregateSortedFeatureGroups((await o.query({abortSignal:e.abortSignal})).features,this._maxQuery,e.abortSignal)}}async*_fixAggregateAttributeNames(e){for await(let t of e)yield t.map(e=>{let t={geometry:e.geometry,attributes:{}},n={};for(let t in e.attributes)n[t.toLowerCase()]=e.attributes[t];for(let e of this._decodedGroupByFields)t.attributes[e.tofieldname]=n[e.name.toLowerCase()];for(let e of this._decodedStatsFields)t.attributes[e.tofieldname]=n[e.field.toLowerCase()];return t})}async*_aggregateSortedFeatureGroups(e,t,n){let r=null,i=[];for await(let a of e){await x(),G(n);for(let e of a){let t=this._generateAggregateHash(e);r==null?r={features:[e],id:t}:t===r.id?r.features.push(e):(i.push(this._calculateAndAppendAggregateItem(r)),r={features:[e],id:t})}i.length>=t&&(yield i,i=[])}r!=null&&(i.push(this._calculateAndAppendAggregateItem(r)),yield i)}async queryStat(e){return{calculated:!1}}async canQueryAggregate(e){return!1}async queryAggregate(e){throw new K(`NeverReach`)}_reformulateWhereClauseWithoutStatsFields(e){for(let t of this._decodedStatsFields)e=Ce(e,t.tofieldname,q(t.workingexpr,0),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(let t of this._decodedGroupByFields)t.tofieldname!==t.name&&(e=Ce(e,t.tofieldname,q(t.expression,0),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){let t=[];for(let e of this._decodedGroupByFields)e.tofieldname!==e.name&&t.push({field:e.tofieldname,newfield:e.name});return t.length>0?e.replaceFields(t):e}_calculateFieldStat(e,t,n){let r=[];for(let n of e.features)if(t.workingexpr!==null){let e=t.workingexpr.calculateValue(n);e!==null&&(e instanceof c||e instanceof l?r.push(e.toNumber()):e instanceof se?r.push(e.toMilliseconds()):r.push(e))}else r.push(null);n.attributes[t.tofieldname]=ce(t.typeofstat,[r])}_calculateAndAppendAggregateItem(e){let t={attributes:{}};for(let n of this._decodedGroupByFields){let r=n.singlefield?e.features[0].attributes[n.singlefield]:H.convertValueToStorageFormat(n.expression.calculateValue(e.features[0]),n.sqlType);t.attributes[n.tofieldname]=r}for(let n of this._decodedStatsFields)this._calculateFieldStat(e,n,t);return t}_generateAggregateHash(e){let t=``;for(let n of this._decodedGroupByFields){let r=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);t+=r==null?`:`:`:`+r.toString()}return i(t,n.String)}async getFeatureByObjectId(){throw new K(`NotImplemented`)}};async function*Ke(e,t){let n=t;for await(let t of e)if(n>=t.length?(n-=t.length,yield t):(yield t.slice(0,n),n=0),n<=0)break}var qe=class extends we{constructor(e){super(),this.declaredClass=`esri.arcade.featureset.actions.Top`,this._maxProcessing=100,this._parent=e.parentfeatureset,this._limit=e.topnum}async _queryAll(){return(await this.query({abortSignal:v})).features}async query(e){await this._ensureLoaded();let t=await this._parent.queryAll(e.abortSignal);return{filterApplied:e.where==null,spatialFilterApplied:e.spatialFilter==null,ordered:!1,features:Ke(t,this._limit)}}async queryStat(e){return{calculated:!1}}async canQueryAggregate(e){return!1}async queryAggregate(e){throw new K(`NeverReach`)}getFieldsIndex(){return this._parent.getFieldsIndex()}};function Je(t){if(t.length===1){if(e(t[0]))return le(`distinct`,t[0],-1);if(N(t[0]))return le(`distinct`,t[0].toArray(),-1)}return le(`distinct`,t,-1)}function Ye(e,t,n){let r=e.getVariables();if(r.length>0){let i={};for(let e of r)i[e]=t.evaluateIdentifier(n,{name:e});e.parameters=i}return e}function Q(e,t,n=null){for(let n in e)if(n.toLowerCase()===t.toLowerCase())return e[n];return n}function Xe(e){if(e===null)return null;let t={type:Q(e,`type`,``),name:Q(e,`name`,``)};if(t.type===`range`)t.range=Q(e,`range`,[]);else{t.codedValues=[];for(let n of Q(e,`codedValues`,[]))t.codedValues.push({name:Q(n,`name`,``),code:Q(n,`code`,null)})}return t}function Ze(e){if(e===null)return null;let t={},n=Q(e,`wkt`);n!==null&&(t.wkt=n);let r=Q(e,`wkid`);return r!==null&&(t.wkid=r),t}function Qe(e){if(e===null)return null;let t={hasZ:Q(e,`hasz`,!1),hasM:Q(e,`hasm`,!1)},n=Q(e,`spatialreference`);n!=null&&(t.spatialReference=Ze(n));let r=Q(e,`x`,null);if(r!==null)return t.x=r,t.y=Q(e,`y`,null),t.hasZ&&(t.z=Q(e,`z`,null)),t.hasM&&(t.m=Q(e,`m`,null)),t;let i=Q(e,`rings`,null);if(i!==null)return t.rings=i,t;let a=Q(e,`paths`,null);if(a!==null)return t.paths=a,t;let o=Q(e,`points`,null);if(o!==null)return t.points=o,t;for(let n of[`xmin`,`xmax`,`ymin`,`ymax`,`zmin`,`zmax`,`mmin`,`mmax`]){let r=Q(e,n,null);r!==null&&(t[n]=r)}return t}function $e(e,t){for(let n of t)if(n===e)return!0;return!1}function et(t){return!!t.layerDefinition&&!!t.featureSet&&!1!==$e(t.layerDefinition.geometryType,[``,null,`esriGeometryNull`,`esriGeometryPoint`,`esriGeometryPolyline`,`esriGeometryPolygon`,`esriGeometryMultipoint`,`esriGeometryEnvelope`])&&!1!==e(t.layerDefinition.fields)&&!1!==e(t.featureSet.features)}function $(e){return e?.toLowerCase()===`utc`?`UTC`:e?.toLowerCase()===`unknown`?`Unknown`:e}async function tt(e,t,n,r,i,a,o){let c=await e.getFeatureSetInfo();if((c?.layerId??null)===null||!i.layerIdLookup.get(c.layerId))return null;let l=e.serviceUrl().replace(/\/FeatureServer/i,`/UtilityNetworkServer`),u=[];switch(n){case`connected`:u.push(`connectivity`),u.push(`junction-edge-from-connectivity`),u.push(`junction-edge-to-connectivity`),u.push(`junction-edge-midspan-connectivity`),u.push(`junction-junction-connectivity`);break;case`container`:case`content`:u.push(`containment`);break;case`structure`:case`attached`:u.push(`attachment`);break;case`junctionedge`:u.push(`junction-edge-from-connectivity`),u.push(`junction-edge-to-connectivity`);break;case`midspan`:u.push(`junction-edge-midspan-connectivity`);break;default:throw new h(a,`InvalidParameter`,o)}let m=null,g=!1;if(r!==null&&r!==``&&r!==void 0){for(let e of i.terminals)e.terminalName===r&&(m=e.terminalId);m===null&&(g=!0)}let _=[];if(!g){let r=new d({globalId:t.field(e.globalIdField),networkSourceId:i.layerIdLookup.get(c.layerId).sourceId,...m?{terminalId:m}:``}),a=await Fe(l,new Ie({types:u,elements:[r]})),o=0;for(let e of a.associations){let t=null,a=``,s=``;if(e.fromNetworkElement?.globalId===r.globalId?(t=e.toNetworkElement,s=`to`):e.toNetworkElement?.globalId===r.globalId&&(t=e.fromNetworkElement,s=`from`),!t)continue;switch(n){case`attached`:if(e.associationType!==`attachment`||s!==`to`)continue;break;case`structure`:if(e.associationType!==`attachment`||s!==`from`)continue;break;case`container`:if(e.associationType!==`containment`||s!==`from`)continue;break;case`content`:if(e.associationType!==`containment`||s!==`to`)continue;break;case`connected`:break;case`junctionedge`:e.associationType===`junction-edge-to-connectivity`?a=`to`:e.associationType===`junction-edge-from-connectivity`&&(a=`from`);break;case`midspan`:if(e.associationType!==`junction-edge-midspan-connectivity`)continue}let c=i.sourceIdLookup.get(t.networkSourceId)?.className??``;_.push(new p({geometry:null,attributes:{objectId:o++,globalId:t.globalId,percentAlong:e.percentAlong??0,isContentVisible:e.isContentVisible?0:1,className:c,side:a}}))}}let v=new s({source:_,geometryType:null,objectIdField:`objectId`,globalIdField:`globalId`,fields:[new f({name:`objectId`,alias:`objectId`,type:`oid`}),new f({name:`globalId`,alias:`globalId`,type:`global-id`}),new f({name:`percentAlong`,alias:`percentAlong`,type:`double`}),new f({name:`side`,alias:`side`,type:`string`}),new f({name:`isContentVisible`,alias:`isContentVisible`,type:`integer`}),new f({name:`className`,alias:`className`,type:`string`})]});return W(v)}function nt(n){if(n.mode===`async`){n.functions.timezone=function(e,t){return n.standardFunctionAsync(e,t,async(n,i,a)=>{if(O(a,1,2,e,t),C(a[0])||y(a[0]))return`Unknown`;if(j(a[0])){if(await a[0].load(),a.length===1||a[1]===null)return a[0].datesInUnknownTimezone?$(`unknown`):$(a[0].dateFieldsTimeZone);if(!(a[1]instanceof M)||!1===a[1].hasField(`type`))throw new h(e,`InvalidParameter`,t);let n=a[1].field(`type`);if(!1===r(n))throw new h(e,`InvalidParameter`,t);switch(D(n).toLowerCase()){case`preferredtimezone`:return $(a[0].preferredTimeZone);case`editfieldsinfo`:return $(a[0].editFieldsInfo?.timeZone??null);case`timeinfo`:return $(a[0].timeInfo?.timeZone??null);case`field`:if(a[1].hasField(`fieldname`)&&r(a[1].field(`fieldname`)))return $(a[0].fieldTimeZone(D(a[1].field(`fieldname`))))}throw new h(e,`InvalidParameter`,t)}let o=w(a[0],P(e));if(o===null)return null;let s=o.timeZone;return s===`system`?m.systemTimeZoneCanonicalName:s.toLowerCase()===`utc`?`UTC`:s.toLowerCase()===`unknown`?`Unknown`:s})},n.functions.sqltimestamp=function(e,t){return n.standardFunctionAsync(e,t,async(n,r,i)=>{O(i,1,3,e,t);let a=i[0];if(S(a)){if(i.length===1)return a.toSQLWithKeyword();if(i.length===2)return a.changeTimeZone(D(i[1])).toSQLWithKeyword();throw new h(e,`InvalidParameter`,t)}if(y(a))return a.toSQLWithKeyword();if(j(a)){if(i.length!==3)throw new h(e,`InvalidParameter`,t);await a.load();let n=D(i[1]);if(y(i[2]))return i[2].toSQLWithKeyword();if(!1===S(i[2]))throw new h(e,`InvalidParameter`,t);let r=a.fieldTimeZone(n);return r==null?i[2].toSQLWithKeyword():i[2].changeTimeZone(r).toSQLWithKeyword()}throw new h(e,`InvalidParameter`,t)})},n.signatures.push({name:`sqltimestamp`,min:2,max:4}),n.functions.featuresetbyid=function(t,r){return n.standardFunctionAsync(t,r,(n,i,a)=>{if(O(a,2,4,t,r),T(a[0])){let n=D(a[1]),i=k(a[2],null),o=A(k(a[3],!0));if(i===null&&(i=[`*`]),!1===e(i))throw new h(t,`InvalidParameter`,r);return a[0].featureSetById(n,o,i)}throw new h(t,`InvalidParameter`,r)})},n.signatures.push({name:`featuresetbyid`,min:2,max:4});let i=new g([`datasource`,`parent`,`root`]);n.functions.getfeatureset=function(e,t){return n.standardFunctionAsync(e,t,async(n,r,a)=>{if(O(a,1,2,e,t),te(a[0])){let t=a[1]==null?`datasource`:i.lookup(D(a[1]));return me(a[0].fullSchema(),t,e.lrucache,e.interceptor,e.spatialReference)}throw new h(e,`InvalidParameter`,t)})},n.signatures.push({name:`getfeatureset`,min:1,max:2}),n.functions.featuresetbyportalitem=function(i,a){return n.standardFunctionAsync(i,a,(n,o,s)=>{if(O(s,2,5,i,a),s[0]===null)throw new h(i,`PortalRequired`,a);if(s[0]instanceof ue){let n=D(s[1]),r=D(s[2]),o=k(s[3],null),c=A(k(s[4],!0));if(o===null&&(o=[`*`]),!1===e(o))throw new h(i,`InvalidParameter`,a);let l;return l=i.services?.portal?i.services.portal:t.getDefault(),l=de(s[0],l),pe(n,r,i.spatialReference,o,c,l,i.lrucache,i.interceptor)}if(!1===r(s[0]))throw new h(i,`PortalRequired`,a);let c=D(s[0]),l=D(s[1]),u=k(s[2],null),d=A(k(s[3],!0));if(u===null&&(u=[`*`]),!1===e(u))throw new h(i,`InvalidParameter`,a);return pe(c,l,i.spatialReference,u,d,i.services?.portal??t.getDefault(),i.lrucache,i.interceptor)})},n.signatures.push({name:`featuresetbyportalitem`,min:2,max:5}),n.functions.featuresetbyname=function(t,r){return n.standardFunctionAsync(t,r,(n,i,a)=>{if(O(a,2,4,t,r),T(a[0])){let n=D(a[1]),i=k(a[2],null),o=A(k(a[3],!0));if(i===null&&(i=[`*`]),!1===e(i))throw new h(t,`InvalidParameter`,r);return a[0].featureSetByName(n,o,i)}throw new h(t,`InvalidParameter`,r)})},n.signatures.push({name:`featuresetbyname`,min:2,max:4}),n.functions.featureset=function(t,i){return n.standardFunction(t,i,(n,a,o)=>{O(o,1,1,t,i);let s={layerDefinition:{geometryType:``,objectIdField:``,globalIdField:``,typeIdField:``,hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:``,features:[]}};if(r(o[0])){let e=JSON.parse(o[0]);e.layerDefinition===void 0?(s.featureSet.features=e.features,s.featureSet.geometryType=e.geometryType,s.layerDefinition.geometryType=s.featureSet.geometryType,s.layerDefinition.objectIdField=e.objectIdFieldName??``,s.layerDefinition.typeIdField=e.typeIdFieldName,s.layerDefinition.globalIdField=e.globalIdFieldName,s.layerDefinition.fields=e.fields,e.spatialReference&&(s.layerDefinition.spatialReference=e.spatialReference)):(s.layerDefinition=e.layerDefinition,s.featureSet=e.featureSet,e.layerDefinition.spatialReference&&(s.layerDefinition.spatialReference=e.layerDefinition.spatialReference))}else{if(!(o[0]instanceof M))throw new h(t,`InvalidParameter`,i);{let n=JSON.parse(o[0].castToText(!0)),r=Q(n,`layerdefinition`);if(r!==null){s.layerDefinition.geometryType=Q(r,`geometrytype`,``),s.featureSet.geometryType=s.layerDefinition.geometryType,s.layerDefinition.globalIdField=Q(r,`globalidfield`,``),s.layerDefinition.objectIdField=Q(r,`objectidfield`,``),s.layerDefinition.typeIdField=Q(r,`typeidfield`,``),s.layerDefinition.hasZ=!0===Q(r,`hasz`,!1),s.layerDefinition.hasM=!0===Q(r,`hasm`,!1);let e=Q(r,`spatialreference`);e&&(s.layerDefinition.spatialReference=Ze(e));let t=[];for(let e of Q(r,`fields`,[])){let n={name:Q(e,`name`,``),alias:Q(e,`alias`,``),type:Q(e,`type`,``),nullable:Q(e,`nullable`,!0),editable:Q(e,`editable`,!0),length:Q(e,`length`,null),domain:Xe(Q(e,`domain`))};t.push(n)}s.layerDefinition.fields=t;let i=Q(n,`featureset`);if(i){let e={};for(let n of t)e[n.name.toLowerCase()]=n.name;for(let t of Q(i,`features`,[])){let n={},r=Q(t,`attributes`,{});for(let t in r)n[e[t.toLowerCase()]]=r[t];s.featureSet.features.push({attributes:n,geometry:Qe(Q(t,`geometry`))})}}}else{s.layerDefinition.hasZ=!0===Q(n,`hasz`,!1),s.layerDefinition.hasM=!0===Q(n,`hasm`,!1),s.layerDefinition.geometryType=Q(n,`geometrytype`,``),s.featureSet.geometryType=s.layerDefinition.geometryType,s.layerDefinition.objectIdField=Q(n,`objectidfieldname`,``),s.layerDefinition.typeIdField=Q(n,`typeidfieldname`,``);let r=Q(n,`spatialreference`);r&&(s.layerDefinition.spatialReference=Ze(r));let a=[],o=Q(n,`fields`,null);if(!e(o))throw new h(t,`InvalidParameter`,i);for(let e of o){let t={name:Q(e,`name`,``),alias:Q(e,`alias`,``),type:Q(e,`type`,``),nullable:Q(e,`nullable`,!0),editable:Q(e,`editable`,!0),length:Q(e,`length`,null),domain:Xe(Q(e,`domain`))};a.push(t)}s.layerDefinition.fields=a;let c={};for(let e of a)c[e.name.toLowerCase()]=e.name;let l=Q(n,`features`,null);if(e(l))for(let e of l){let t={},n=Q(e,`attributes`,{});for(let e in n)t[c[e.toLowerCase()]]=n[e];s.featureSet.features.push({attributes:t,geometry:Qe(Q(e,`geometry`,null))})}else l=null,s.featureSet.features=l}}}if(!1===et(s))throw new h(t,`InvalidParameter`,i);return s.layerDefinition.geometryType||(s.layerDefinition.geometryType=`esriGeometryNull`),_e.create(s,t.spatialReference)})},n.signatures.push({name:`featureset`,min:1,max:1}),n.functions.filter=function(t,r){return n.standardFunctionAsync(t,r,async(i,a,o)=>{if(O(o,2,2,t,r),e(o[0])||N(o[0])){let e=[],n,i=o[0];if(i instanceof ee&&(i=i.toArray()),!ne(o[1]))throw new h(t,`InvalidParameter`,r);n=o[1].createFunction(t);for(let t of i){let r=n(t);_(r)?!0===await r&&e.push(t):!0===r&&e.push(t)}return e}if(j(o[0])){let e=await o[0].load(),r=H.create(o[1],{fieldsIndex:e.getFieldsIndex(),timeZone:e.dateFieldsTimeZoneDefaultUTC}),i=r.getVariables();if(i.length>0){let e={};for(let r of i)e[r]=n.evaluateIdentifier(t,{name:r});r.parameters=e}return new U({parentfeatureset:o[0],whereclause:r})}throw new h(t,`InvalidParameter`,r)})},n.signatures.push({name:`filter`,min:2,max:2}),n.functions.orderby=function(e,t){return n.standardFunctionAsync(e,t,async(n,r,i)=>{if(O(i,2,2,e,t),j(i[0])){let e=new Ve(i[1]);return new ze({parentfeatureset:i[0],orderbyclause:e})}throw new h(e,`InvalidParameter`,t)})},n.signatures.push({name:`orderby`,min:2,max:2}),n.functions.top=function(t,r){return n.standardFunctionAsync(t,r,async(n,i,a)=>{if(O(a,2,2,t,r),j(a[0]))return new qe({parentfeatureset:a[0],topnum:a[1]});if(e(a[0]))return E(a[1])>=a[0].length?a[0].slice():a[0].slice(0,E(a[1]));if(N(a[0]))return E(a[1])>=a[0].length()?a[0].slice():a[0].slice(0,E(a[1]));throw new h(t,`InvalidParameter`,r)})},n.signatures.push({name:`top`,min:2,max:2}),n.functions.first=function(t,r){return n.standardFunctionAsync(t,r,async(n,i,a)=>{if(O(a,1,1,t,r),j(a[0])){let e=await a[0].first(n.abortSignal);if(e!==null){let n=oe.createFromGraphicLikeObject(e.geometry,e.attributes,a[0],t.timeZone);return n._underlyingGraphic=e,n}return e}return e(a[0])?a[0].length===0?null:a[0][0]:N(a[0])?a[0].length()===0?null:a[0].get(0):null})},n.signatures.push({name:`first`,min:1,max:1}),n.functions.attachments=function(e,t){return n.standardFunctionAsync(e,t,async(n,r,i)=>{O(i,1,2,e,t);let a={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(i.length>1){if(i[1]instanceof M){if(i[1].hasField(`minsize`)&&(a.minsize=E(i[1].field(`minsize`))),i[1].hasField(`metadata`)&&(a.returnMetadata=A(i[1].field(`metadata`))),i[1].hasField(`maxsize`)&&(a.maxsize=E(i[1].field(`maxsize`))),i[1].hasField(`types`)){let e=re(i[1].field(`types`),!1);e.length>0&&(a.types=e)}}else if(i[1]!==null)throw new h(e,`InvalidParameter`,t)}if(te(i[0])){let t=i[0]._layer,n;if(j(t))n=t;else{if(t==null||!ie(t))return[];n=W(t,e.spatialReference,[`*`],!0,e.lrucache,e.interceptor)}return await n.load(),n.queryAttachments(i[0].field(n.objectIdField),a.minsize,a.maxsize,a.types,a.returnMetadata)}if(i[0]===null)return[];throw new h(e,`InvalidParameter`,t)})},n.signatures.push({name:`attachments`,min:1,max:2}),n.functions.featuresetbyrelationshipname=function(t,r){return n.standardFunctionAsync(t,r,async(n,i,a)=>{O(a,2,4,t,r);let o=a[0],s=D(a[1]),c=k(a[2],null),l=A(k(a[3],!0));if(c===null&&(c=[`*`]),!1===e(c))throw new h(t,`InvalidParameter`,r);if(a[0]===null)return null;if(!te(a[0]))throw new h(t,`InvalidParameter`,r);let u=o._layer,d;if(j(u))d=u;else{if(u==null||!ie(u))return null;d=W(u,t.spatialReference,[`*`],!0,t.lrucache,t.interceptor)}d=await d.load();let f=d.relationshipMetadata().filter(e=>e.name===s);if(f.length===0)return null;if(f[0].relationshipTableId!==void 0&&f[0].relationshipTableId!==null&&f[0].relationshipTableId>-1)return ge(d,f[0],o.field(d.objectIdField),d.spatialReference,c,l,t.lrucache,t.interceptor);let p=d.serviceUrl();if(!p)return null;p=p.endsWith(`/`)?p+f[0].relatedTableId.toString():p+`/`+f[0].relatedTableId.toString();let m=await fe(p,d.spatialReference,c,l,t.lrucache,t.interceptor);await m.load();let g=m.relationshipMetadata();if(g=g.filter(e=>e.id===f[0].id),!1===o.hasField(f[0].keyField)||o.field(f[0].keyField)===null){let e=await d.getFeatureByObjectId(o.field(d.objectIdField),[f[0].keyField]);if(e){let t=H.create(g[0].keyField+`= @id`,{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return t.parameters={id:e.attributes[f[0].keyField]},new U({parentfeatureset:m,whereclause:t})}return new Pe({parentfeatureset:m})}let _=H.create(g[0].keyField+`= @id`,{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return _.parameters={id:o.field(f[0].keyField)},new U({parentfeatureset:m,whereclause:_})})},n.signatures.push({name:`featuresetbyrelationshipname`,min:2,max:4}),n.functions.featuresetbyassociation=function(e,t){return n.standardFunctionAsync(e,t,async(n,i,o)=>{O(o,2,3,e,t);let c=o[0],l=a(D(k(o[1],``))),u=r(o[2])?D(o[2]):null;if(o[0]===null)return null;if(!te(o[0]))throw new h(e,`InvalidParameter`,t);let d=c._layer;if(d instanceof s&&(d=W(d,e.spatialReference,[`*`],!0,e.lrucache,e.interceptor)),d===null||!1===j(d))return null;await d.load();let p=d.serviceUrl(),m=await he(p,e.spatialReference,!0);if(m.unVersion>=8)return await tt(d,c,l,u,m,e,t);let g=m.associations,_=null,v=null,ee=!1;if(u!==null&&u!==``&&u!==void 0){for(let e of m.terminals)e.terminalName===u&&(v=e.terminalId);v===null&&(ee=!0)}let y=g.getFieldsIndex(),x=y.get(`TOGLOBALID`).name,S=y.get(`FROMGLOBALID`).name,C=y.get(`TOTERMINALID`).name,w=y.get(`FROMTERMINALID`).name,T=y.get(`FROMNETWORKSOURCEID`).name,E=y.get(`TONETWORKSOURCEID`).name,A=y.get(`ASSOCIATIONTYPE`).name,M=y.get(`ISCONTENTVISIBLE`).name,N=y.get(`OBJECTID`).name;for(let e of d.fields)if(e.type===`global-id`){_=c.field(e.name);break}let P=null,ne=new X(new f({name:`percentalong`,alias:`percentalong`,type:`double`}),H.create(`0`,{fieldsIndex:g.getFieldsIndex(),timeZone:g.dateFieldsTimeZoneDefaultUTC})),re=new X(new f({name:`side`,alias:`side`,type:`string`}),H.create(`''`,{fieldsIndex:g.getFieldsIndex(),timeZone:g.dateFieldsTimeZoneDefaultUTC})),F=`globalid`,I=`globalId`,R={};for(let e in m.lkp)R[e]=m.lkp[e].sourceId;let z=new Re(new f({name:`classname`,alias:`classname`,type:`string`}),null,R),B=``;switch(l){case`midspan`:{B=`((${x}='${_}') OR ( ${S}='${_}')) AND (${A} IN (5))`,z.codefield=H.create(`CASE WHEN (${x}='${_}') THEN ${T} ELSE ${E} END`,{fieldsIndex:g.getFieldsIndex(),timeZone:g.dateFieldsTimeZoneDefaultUTC});let e=L(Z.findField(g.fields,S));e.name=F,e.alias=F,P=new X(e,H.create(`CASE WHEN (${S}='${_}') THEN ${x} ELSE ${S} END`,{fieldsIndex:g.getFieldsIndex(),timeZone:g.dateFieldsTimeZoneDefaultUTC})),ne=m.unVersion>=4?new J(Z.findField(g.fields,y.get(`PERCENTALONG`).name)):new X(new f({name:`percentalong`,alias:`percentalong`,type:`double`}),H.create(`0`,{fieldsIndex:g.getFieldsIndex(),timeZone:g.dateFieldsTimeZoneDefaultUTC}));break}case`junctionedge`:{B=`((${x}='${_}') OR ( ${S}='${_}')) AND (${A} IN (4,6))`,z.codefield=H.create(`CASE WHEN (${x}='${_}') THEN ${T} ELSE ${E} END`,{fieldsIndex:g.getFieldsIndex(),timeZone:g.dateFieldsTimeZoneDefaultUTC});let e=L(Z.findField(g.fields,S));e.name=F,e.alias=F,P=new X(e,H.create(`CASE WHEN (${S}='${_}') THEN ${x} ELSE ${S} END`,{fieldsIndex:g.getFieldsIndex(),timeZone:g.dateFieldsTimeZoneDefaultUTC})),re=new X(new f({name:`side`,alias:`side`,type:`string`}),H.create(`CASE WHEN (${A}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:g.getFieldsIndex(),timeZone:g.dateFieldsTimeZoneDefaultUTC}));break}case`connected`:{let e=`${x}='@T'`,t=`${S}='@T'`;v!==null&&(e+=` AND ${C}=@A`,t+=` AND ${w}=@A`),B=`((`+e+`) OR (`+t+`))`,B=b(B,`@T`,_??``),e=b(e,`@T`,_??``),v!==null&&(e=b(e,`@A`,v.toString()),B=b(B,`@A`,v.toString())),z.codefield=H.create(`CASE WHEN `+e+` THEN ${T} ELSE ${E} END`,{fieldsIndex:g.getFieldsIndex(),timeZone:g.dateFieldsTimeZoneDefaultUTC});let n=L(Z.findField(g.fields,S));n.name=F,n.alias=F,P=new X(n,H.create(`CASE WHEN `+e+` THEN ${S} ELSE ${x} END`,{fieldsIndex:g.getFieldsIndex(),timeZone:g.dateFieldsTimeZoneDefaultUTC}));break}case`container`:B=`${x}='${_}' AND ${A} = 2`,v!==null&&(B+=` AND ${C} = `+v.toString()),z.codefield=T,B=`( `+B+` )`,P=new Y(Z.findField(g.fields,S),F,F);break;case`content`:B=`(${S}='${_}' AND ${A} = 2)`,v!==null&&(B+=` AND ${w} = `+v.toString()),z.codefield=E,B=`( `+B+` )`,P=new Y(Z.findField(g.fields,x),F,F);break;case`structure`:B=`(${x}='${_}' AND ${A} = 3)`,v!==null&&(B+=` AND ${C} = `+v.toString()),z.codefield=T,B=`( `+B+` )`,P=new Y(Z.findField(g.fields,S),F,I);break;case`attached`:B=`(${S}='${_}' AND ${A} = 3)`,v!==null&&(B+=` AND ${w} = `+v.toString()),z.codefield=E,B=`( `+B+` )`,P=new Y(Z.findField(g.fields,x),F,I);break;default:throw new h(e,`InvalidParameter`,t)}return ee&&(B=`1 <> 1`),new Z({parentfeatureset:g,adaptedFields:[new J(Z.findField(g.fields,N)),new J(Z.findField(g.fields,M)),P,re,z,ne],extraFilter:B?H.create(B,{fieldsIndex:g.getFieldsIndex(),timeZone:g.dateFieldsTimeZoneDefaultUTC}):null})})},n.signatures.push({name:`featuresetbyassociation`,min:2,max:6}),n.functions.groupby=function(t,i){return n.standardFunctionAsync(t,i,async(a,o,s)=>{if(O(s,3,3,t,i),!j(s[0]))throw new h(t,`InvalidParameter`,i);let c=await s[0].load(),l=[],u=[],d=!1,f=[];if(r(s[1]))f.push(s[1]);else if(s[1]instanceof M)f.push(s[1]);else if(e(s[1]))f=s[1];else{if(!N(s[1]))throw new h(t,`InvalidParameter`,i);f=s[1].toArray()}for(let e of f)if(r(e)){let t=H.create(D(e),{fieldsIndex:c.getFieldsIndex(),timeZone:c.dateFieldsTimeZoneDefaultUTC}),n=!0===Me(t)?D(e):`%%%%FIELDNAME`;l.push({name:n,expression:t}),n===`%%%%FIELDNAME`&&(d=!0)}else{if(!(e instanceof M))throw new h(t,`InvalidParameter`,i);{let n=e.hasField(`name`)?e.field(`name`):`%%%%FIELDNAME`,r=e.hasField(`expression`)?e.field(`expression`):``;if(n===`%%%%FIELDNAME`&&(d=!0),!n)throw new h(t,`InvalidParameter`,i);l.push({name:n,expression:H.create(r||n,{fieldsIndex:c.getFieldsIndex(),timeZone:c.dateFieldsTimeZoneDefaultUTC})})}}if(f=[],r(s[2]))f.push(s[2]);else if(e(s[2]))f=s[2];else if(N(s[2]))f=s[2].toArray();else{if(!(s[2]instanceof M))throw new h(t,`InvalidParameter`,i);f.push(s[2])}for(let e of f){if(!(e instanceof M))throw new h(t,`InvalidParameter`,i);{let n=e.hasField(`name`)?e.field(`name`):``,a=e.hasField(`statistic`)?e.field(`statistic`):``,o=e.hasField(`expression`)?e.field(`expression`):``;if(!(n&&a&&r(a)&&o))throw new h(t,`InvalidParameter`,i);u.push({name:n,statistic:a,expression:H.create(o,{fieldsIndex:c.getFieldsIndex(),timeZone:c.dateFieldsTimeZoneDefaultUTC})})}}if(d){let e={};for(let t of c.fields)e[t.name.toLowerCase()]=1;for(let t of l)t.name!==`%%%%FIELDNAME`&&(e[t.name.toLowerCase()]=1);for(let t of u)t.name!==`%%%%FIELDNAME`&&(e[t.name.toLowerCase()]=1);let t=0;for(let n of l)if(n.name===`%%%%FIELDNAME`){for(;e[`field_`+t.toString()]===1;)t++;e[`field_`+t.toString()]=1,n.name=`FIELD_`+t.toString()}}for(let e of l)Ye(e.expression,n,t);for(let e of u)Ye(e.expression,n,t);return new Ge({parentfeatureset:s[0],groupbyfields:l,statsfields:u})})},n.signatures.push({name:`groupby`,min:3,max:3}),n.functions.distinct=function(t,i){return n.standardFunctionAsync(t,i,async(a,o,s)=>{if(j(s[0])){O(s,2,2,t,i);let a=await s[0].load(),o=[],c=[];if(r(s[1]))c.push(s[1]);else if(s[1]instanceof M)c.push(s[1]);else if(e(s[1]))c=s[1];else{if(!N(s[1]))throw new h(t,`InvalidParameter`,i);c=s[1].toArray()}let l=!1;for(let e of c)if(r(e)){let t=H.create(D(e),{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}),n=!0===Me(t)?D(e):`%%%%FIELDNAME`;o.push({name:n,expression:t}),n===`%%%%FIELDNAME`&&(l=!0)}else{if(!(e instanceof M))throw new h(t,`InvalidParameter`,i);{let n=e.hasField(`name`)?e.field(`name`):`%%%%FIELDNAME`,r=e.hasField(`expression`)?e.field(`expression`):``;if(n===`%%%%FIELDNAME`&&(l=!0),!n)throw new h(t,`InvalidParameter`,i);o.push({name:n,expression:H.create(r||n,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})})}}if(l){let e={};for(let t of a.fields)e[t.name.toLowerCase()]=1;for(let t of o)t.name!==`%%%%FIELDNAME`&&(e[t.name.toLowerCase()]=1);let t=0;for(let n of o)if(n.name===`%%%%FIELDNAME`){for(;e[`field_`+t.toString()]===1;)t++;e[`field_`+t.toString()]=1,n.name=`FIELD_`+t.toString()}}for(let e of o)Ye(e.expression,n,t);return new Ge({parentfeatureset:s[0],groupbyfields:o,statsfields:[]})}return Je(s)})},n.functions.getfeaturesetinfo=function(e,t){return n.standardFunctionAsync(e,t,async(n,r,i)=>{if(O(i,1,1,e,t),!j(i[0]))return null;let a=await i[0].getFeatureSetInfo();return a?M.convertObjectToArcadeDictionary({layerId:a.layerId,layerName:a.layerName,itemId:a.itemId,serviceLayerUrl:a.serviceLayerUrl,webMapLayerId:a.webMapLayerId??null,webMapLayerTitle:a.webMapLayerTitle??null,className:null,objectClassId:null},P(e),!1,!1):null})},n.signatures.push({name:`getfeaturesetinfo`,min:1,max:1}),n.functions.filterbysubtypecode=function(e,t){return n.standardFunctionAsync(e,t,async(n,r,i)=>{if(O(i,2,2,e,t),j(i[0])){let n=await i[0].load(),r=i[1];if(!o(r))throw new h(e,`InvalidParameter`,t);if(n.subtypeField){let e=H.create(`${n.subtypeField}= ${i[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new U({parentfeatureset:i[0],whereclause:e})}if(n.typeIdField===null||n.typeIdField===``)throw new h(e,`FeatureSetDoesNotHaveSubtypes`,t);let a=H.create(`${n.typeIdField}= ${i[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new U({parentfeatureset:i[0],whereclause:a})}throw new h(e,`InvalidParameter`,t)})},n.signatures.push({name:`filterbysubtypecode`,min:2,max:2})}}export{nt as registerFunctions};