import{$T as e,A as t,Ag as n,BS as r,BT as i,Ex as a,FE as o,L as s,M as c,Mg as l,PE as u,Rh as d,UT as f,Ua as p,VT as m,WT as h,ZS as g,cv as _,hS as v,hv as y,iw as b,j as x,kC as S,kD as C,lv as w,pv as T,sD as E,sT as D,ua as ee,vx as O,xC as te}from"./index-BN8X5Ryz.js";import{t as ne}from"./imageBitmapUtils-CLE9aRyR.js";import{t as re}from"./TileInfoTilemapCache-DkoFuD4x.js";import{n as ie,t as ae}from"./WebTileLayer-ButI5-m2.js";import{t as k}from"./crsUtils-DizqbFZW.js";import{n as A}from"./xmlUtils-B_nEa0O-.js";var j,M=j=class extends b{constructor(e){super(e),this.fullExtent=null,this.id=null,this.tileInfo=null}clone(){let e=new j;return this.hasOwnProperty(`fullExtent`)&&(e.fullExtent=this.fullExtent?.clone()??null),this.hasOwnProperty(`id`)&&(e.id=this.id),this.hasOwnProperty(`tileInfo`)&&(e.tileInfo=this.tileInfo?.clone()??null),e}};C([i({type:O,json:{read:{source:`fullExtent`}}})],M.prototype,`fullExtent`,void 0),C([i({type:String,json:{read:{source:`id`}}})],M.prototype,`id`,void 0),C([i({type:n,json:{read:{source:`tileInfo`}}})],M.prototype,`tileInfo`,void 0),M=j=C([m(`esri.layers.support.TileMatrixSet`)],M);var oe=M,N,P=N=class extends b{constructor(e){super(e),this.id=null,this.title=null,this.description=null,this.legendUrl=null}clone(){let e=new N;return this.hasOwnProperty(`description`)&&(e.description=this.description),this.hasOwnProperty(`id`)&&(e.id=this.id),this.hasOwnProperty(`isDefault`)&&(e.isDefault=this.isDefault),this.hasOwnProperty(`keywords`)&&(e.keywords=this.keywords&&this.keywords.slice()),this.hasOwnProperty(`legendUrl`)&&(e.legendUrl=this.legendUrl),this.hasOwnProperty(`title`)&&(e.title=this.title),e}};C([i({json:{read:{source:`id`}}})],P.prototype,`id`,void 0),C([i({json:{read:{source:`title`}}})],P.prototype,`title`,void 0),C([i({json:{read:{source:`abstract`}}})],P.prototype,`description`,void 0),C([i({json:{read:{source:`legendUrl`}}})],P.prototype,`legendUrl`,void 0),C([i({json:{read:{source:`isDefault`}}})],P.prototype,`isDefault`,void 0),C([i({json:{read:{source:`keywords`}}})],P.prototype,`keywords`,void 0),P=N=C([m(`esri.layers.support.WMTSStyle`)],P);var se=P,F,I=F=class extends b{constructor(e){super(e),this.description=null,this.fullExtent=null,this.fullExtents=null,this.id=null,this.imageFormats=null,this.layer=null,this.parent=null,this.styles=null,this.title=null,this.tileMatrixSetId=null,this.tileMatrixSets=null}readFullExtent(e,t){return(e=t.fullExtent)?O.fromJSON(e):null}readFullExtents(e,t){return t.fullExtents?.length?t.fullExtents.map(e=>O.fromJSON(e)):t.tileMatrixSets?.map(e=>O.fromJSON(e.fullExtent)).filter(e=>e)??[]}get imageFormat(){let e=this._get(`imageFormat`);return e||=this.imageFormats?.length?this.imageFormats[0]:``,e}set imageFormat(e){let t=this.imageFormats;e&&(e.includes(`image/`)||t&&!t.includes(e))&&(e.includes(`image/`)||(e=`image/`+e),t&&!t.includes(e))?console.error(`The layer doesn't support the format of `+e):this._set(`imageFormat`,e)}get styleId(){let e=this._get(`styleId`);return e||=this.styles?.at(0)?.id??``,e}set styleId(e){this._set(`styleId`,e)}get tileMatrixSet(){return this.tileMatrixSets?.find(({id:e})=>e===this.tileMatrixSetId)??null}clone(){let e=new F;return this.hasOwnProperty(`description`)&&(e.description=this.description),this.hasOwnProperty(`imageFormats`)&&(e.imageFormats=this.imageFormats?.slice()??null),this.hasOwnProperty(`imageFormat`)&&(e.imageFormat=this.imageFormat),this.hasOwnProperty(`fullExtent`)&&(e.fullExtent=this.fullExtent?.clone()),this.hasOwnProperty(`id`)&&(e.id=this.id),this.hasOwnProperty(`layer`)&&(e.layer=this.layer),this.hasOwnProperty(`styleId`)&&(e.styleId=this.styleId),this.hasOwnProperty(`styles`)&&(e.styles=this.styles?.clone()),this.hasOwnProperty(`tileMatrixSetId`)&&(e.tileMatrixSetId=this.tileMatrixSetId),this.hasOwnProperty(`tileMatrixSets`)&&(e.tileMatrixSets=this.tileMatrixSets?.clone()),this.hasOwnProperty(`title`)&&(e.title=this.title),e}};C([i()],I.prototype,`description`,void 0),C([i({type:O})],I.prototype,`fullExtent`,void 0),C([h(`fullExtent`,[`fullExtent`])],I.prototype,`readFullExtent`,null),C([i({readOnly:!0})],I.prototype,`fullExtents`,void 0),C([h(`fullExtents`,[`fullExtents`,`tileMatrixSets`])],I.prototype,`readFullExtents`,null),C([i()],I.prototype,`id`,void 0),C([i()],I.prototype,`imageFormat`,null),C([i({json:{read:{source:`formats`}}})],I.prototype,`imageFormats`,void 0),C([i()],I.prototype,`layer`,void 0),C([i()],I.prototype,`parent`,void 0),C([i()],I.prototype,`styleId`,null),C([i({type:y.ofType(se),json:{read:{source:`styles`}}})],I.prototype,`styles`,void 0),C([i({json:{write:{ignoreOrigin:!0}}})],I.prototype,`title`,void 0),C([i()],I.prototype,`tileMatrixSetId`,void 0),C([i({readOnly:!0})],I.prototype,`tileMatrixSet`,null),C([i({type:y.ofType(oe),json:{read:{source:`tileMatrixSets`}}})],I.prototype,`tileMatrixSets`,void 0),I=F=C([m(`esri.layers.support.WMTSSublayer`)],I);var L=90.71428571428571;function R(e){let t=e.replaceAll(/ows:/gi,``);return new DOMParser().parseFromString(t,`text/xml`)}function z(t){if(!V(`Contents`,t.documentElement))throw new e(`wmtslayer:wmts-capabilities-xml-is-not-valid`,`the wmts get capabilities response is not compliant`)}function ce(t,n){let r=t.documentElement,i=new Map,a=new Map,o=V(`Contents`,r);if(!o)throw new e(`wmtslayer:wmts-capabilities-xml-is-not-valid`,`Can't retrieve xml capabilities element`);let s=V(`OperationsMetadata`,r),c=s?.querySelector(`[name='GetTile']`),l=c?.getElementsByTagName(`Get`),u=l&&Array.prototype.slice.call(l),d=n.url?.indexOf(`https`),f=d!==void 0&&d>-1,p,m,h=n.serviceMode,g=n?.url;u?.length&&u.some(e=>{let t=V(`Constraint`,e);return!t||G(`AllowedValues`,`Value`,h,t)?(g=e.attributes[0].nodeValue,!0):(!t||G(`AllowedValues`,`Value`,`RESTful`,t)||G(`AllowedValues`,`Value`,`REST`,t)?m=e.attributes[0].nodeValue:t&&!G(`AllowedValues`,`Value`,`KVP`,t)||(p=e.attributes[0].nodeValue),!1)}),!g&&(m?(g=m,h=`RESTful`):p?(g=p,h=`KVP`):g=V(`ServiceMetadataURL`,r)?.getAttribute(`xlink:href`));let _=g.indexOf(`1.0.0/`);_===-1&&h===`RESTful`?g+=`/`:_>-1&&(g=g.slice(0,_)),h===`KVP`&&(g+=_>-1?``:`?`),f&&(g=g.replace(/^http:/i,`https:`));let v=W(`ServiceIdentification>ServiceTypeVersion`,r),y=W(`ServiceIdentification>AccessConstraints`,r),b=y&&/^none$/i.test(y)?null:y,x=H(`Layer`,o),S=H(`TileMatrixSet`,o),C=x.map(e=>{let t=W(`Identifier`,e);return i.set(t,e),ue(t,e,S,f,v)});return{copyright:b,dimensionMap:a,layerMap:i,layers:C,serviceMode:h,tileUrl:g}}function le(e){for(let t of e.layers)for(let e of t.tileMatrixSets??[]){let{tileInfo:t}=e;if(t&&t.dpi!==96){for(let n of t.lods??[])n.scale=96*n.scale/t.dpi,n.resolution=X(t.spatialReference?.wkid,n.scale*L/96,e.id);t.dpi=96}}}function B(e){return e.nodeType===Node.ELEMENT_NODE}function V(e,t){for(let n=0;n<t.childNodes.length;n++){let r=t.childNodes[n];if(B(r)&&r.nodeName===e)return r}return null}function H(e,t){let n=[];for(let r=0;r<t.childNodes.length;r++){let i=t.childNodes[r];B(i)&&i.nodeName===e&&n.push(i)}return n}function U(e,t){let n=[];for(let r=0;r<t.childNodes.length;r++){let i=t.childNodes[r];B(i)&&i.nodeName===e&&n.push(i)}return n.map(e=>e.textContent).filter(E)}function W(e,t){return e.split(`>`).forEach(e=>{t&&=V(e,t)}),t&&t.textContent}function G(e,t,n,r){let i;return Array.prototype.slice.call(r.childNodes).some(r=>{if(r.nodeName.includes(e)){let e=V(t,r),a=e?.textContent;if(a===n||n.split(`:`)&&n.split(`:`)[1]===a)return i=r,!0}return!1}),i}function ue(e,t,n,r,i){let a=W(`Abstract`,t),o=U(`Format`,t);return{id:e,fullExtent:me(t),fullExtents:he(t),description:a,formats:o,styles:ge(t,r),title:W(`Title`,t),tileMatrixSets:_e(i,t,n)}}function K(e,t){let n=[],r=e.layerMap?.get(t);if(!r)return null;let i=H(`ResourceURL`,r),a=H(`Dimension`,r),o,s,c,l;return a.length&&(o=W(`Identifier`,a[0]),s=U(`Default`,a[0])||U(`Value`,a[0])),a.length>1&&(c=W(`Identifier`,a[1]),l=U(`Default`,a[1])||U(`Value`,a[1])),e.dimensionMap.set(t,{dimensions:s,dimensions2:l}),i.forEach(e=>{let t=e.getAttribute(`template`);if(e.getAttribute(`resourceType`)===`tile`){if(o&&s.length)if(t.includes(`{`+o+`}`))t=t.replace(`{`+o+`}`,`{dimensionValue}`);else{let e=t.toLowerCase().indexOf(`{`+o.toLowerCase()+`}`);e>-1&&(t=t.slice(0,e)+`{dimensionValue}`+t.slice(e+o.length+2))}if(c&&l.length)if(t.includes(`{`+c+`}`))t=t.replace(`{`+c+`}`,`{dimensionValue2}`);else{let e=t.toLowerCase().indexOf(`{`+c.toLowerCase()+`}`);e>-1&&(t=t.slice(0,e)+`{dimensionValue2}`+t.slice(e+c.length+2))}n.push({template:t,format:e.getAttribute(`format`),resourceType:`tile`})}}),n}function de(e,t,n,r,i,a,o,s){let c=fe(e,t,r);if(!(c?.length>0))return``;let{dimensionMap:l}=e,u=l.get(t).dimensions?.[0],d=l.get(t).dimensions2?.[0];return c[o%c.length].template.replaceAll(/\{Style\}/gi,i??``).replaceAll(/\{TileMatrixSet\}/gi,n??``).replaceAll(/\{TileMatrix\}/gi,a).replaceAll(/\{TileRow\}/gi,``+o).replaceAll(/\{TileCol\}/gi,``+s).replaceAll(/\{dimensionValue\}/gi,u).replaceAll(/\{dimensionValue2\}/gi,d)}function fe(e,t,n){let r=K(e,t),i=r?.filter(e=>e.format===n);return(i?.length?i:r)??[]}function pe(e,t,n,r){let{dimensionMap:i}=e,a=K(e,t),o=``;if(a&&a.length>0){let e=i.get(t).dimensions?.[0],s=i.get(t).dimensions2?.[0];o=a[0].template,o.endsWith(`.xxx`)&&(o=o.slice(0,-4)),o=o.replaceAll(/\{Style\}/gi,r),o=o.replaceAll(/\{TileMatrixSet\}/gi,n),o=o.replaceAll(/\{TileMatrix\}/gi,`{level}`),o=o.replaceAll(/\{TileRow\}/gi,`{row}`),o=o.replaceAll(/\{TileCol\}/gi,`{col}`),o=o.replaceAll(/\{dimensionValue\}/gi,e),o=o.replaceAll(/\{dimensionValue2\}/gi,s)}return o}function me(e){let t=V(`WGS84BoundingBox`,e),n=t?W(`LowerCorner`,t).split(` `):[`-180`,`-90`],r=t?W(`UpperCorner`,t).split(` `):[`180`,`90`];return{xmin:parseFloat(n[0]),ymin:parseFloat(n[1]),xmax:parseFloat(r[0]),ymax:parseFloat(r[1]),spatialReference:{wkid:4326}}}function he(e){let t=[];return A(e,{BoundingBox:e=>{if(!e.getAttribute(`crs`))return;let n=e.getAttribute(`crs`).toLowerCase(),r=q(n),i=n.includes(`epsg`)&&k(r.wkid),a,o,s,c;A(e,{LowerCorner:e=>{[a,o]=e.textContent.split(` `).map(e=>Number.parseFloat(e)),i&&([a,o]=[o,a])},UpperCorner:e=>{[s,c]=e.textContent.split(` `).map(e=>Number.parseFloat(e)),i&&([s,c]=[c,s])}}),t.push({xmin:a,ymin:o,xmax:s,ymax:c,spatialReference:r})}}),t}function ge(e,t){return H(`Style`,e).map(e=>{let n=V(`LegendURL`,e),r=V(`Keywords`,e),i=r?U(`Keyword`,r):[],a=n?.getAttribute(`xlink:href`);return t&&(a=a?.replace(/^http:/i,`https:`)),{abstract:W(`Abstract`,e),id:W(`Identifier`,e),isDefault:e.getAttribute(`isDefault`)===`true`,keywords:i,legendUrl:a,title:W(`Title`,e)}})}function _e(e,t,n){return H(`TileMatrixSetLink`,t).map(t=>ve(e,t,n))}function ve(e,t,r){let i=V(`TileMatrixSet`,t).textContent,a=U(`TileMatrix`,t),o=r.find(e=>{let t=V(`Identifier`,e),n=t?.textContent;return!!(n===i||i.split(`:`)&&i.split(`:`)[1]===n)}),s=V(`TileMatrixSetLimits`,t),c=s&&H(`TileMatrixLimits`,s),l=new Map;if(c?.length)for(let e of c){let t=V(`TileMatrix`,e).textContent,n=+V(`MinTileRow`,e).textContent,r=+V(`MaxTileRow`,e).textContent,i=+V(`MinTileCol`,e).textContent,a=+V(`MaxTileCol`,e).textContent;l.set(t,{minCol:i,maxCol:a,minRow:n,maxRow:r})}let u=W(`SupportedCRS`,o).toLowerCase(),d=ye(o,u),f=d.spatialReference,p=V(`TileMatrix`,o),m=[parseInt(W(`TileWidth`,p),10),parseInt(W(`TileHeight`,p),10)],h=[];a.length?a.forEach((e,t)=>{let n=G(`TileMatrix`,`Identifier`,e,o);h.push(Y(n,u,t,i,l))}):H(`TileMatrix`,o).forEach((e,t)=>{h.push(Y(e,u,t,i,l))});let g=be(e,o,d,m,h[0]).toJSON(),_=new n({dpi:96,spatialReference:f,size:m,origin:d,lods:h}).toJSON();return{id:i,fullExtent:g,tileInfo:_}}function q(e){e=e.toLowerCase();let t=parseInt(e.split(`:`).pop(),10);t!==900913&&t!==3857||(t=102100);let n=Se(e);return n!=null&&(t=n),{wkid:t}}function ye(e,t){return J(V(`TileMatrix`,e),t)}function J(e,t){let n=q(t),[r,i]=W(`TopLeftCorner`,e).split(` `).map(e=>parseFloat(e)),o=t.includes(`epsg`)&&k(n.wkid);return new a(o?{x:i,y:r,spatialReference:n}:{x:r,y:i,spatialReference:n})}function be(e,t,n,r,i){let a=V(`BoundingBox`,t),o,s,c,l,u,d;if(a&&(o=W(`LowerCorner`,a).split(` `),s=W(`UpperCorner`,a).split(` `)),o&&o.length>1&&s&&s.length>1)c=parseFloat(o[0]),u=parseFloat(o[1]),l=parseFloat(s[0]),d=parseFloat(s[1]);else{let e=V(`TileMatrix`,t),a=parseInt(W(`MatrixWidth`,e),10),o=parseInt(W(`MatrixHeight`,e),10);c=n.x,d=n.y,l=c+a*r[0]*i.resolution,u=d-o*r[1]*i.resolution}return xe(e,n.spatialReference,n)?new O(u,c,d,l,n.spatialReference):new O(c,u,l,d,n.spatialReference)}function xe(e,t,n){return e===`1.0.0`&&k(t.wkid)&&!(n.spatialReference.isGeographic&&n.x<-90&&n.y>=-90)}function Se(e){return e.includes(`crs84`)||e.includes(`crs:84`)?4326:e.includes(`crs83`)||e.includes(`crs:83`)?4269:e.includes(`crs27`)||e.includes(`crs:27`)?4267:null}function Y(e,t,n,r,i){let a=q(t),o=W(`Identifier`,e),s=parseFloat(W(`ScaleDenominator`,e)),c=X(a.wkid,s,r);s*=96/L;let u=+W(`MatrixWidth`,e),d=+W(`MatrixHeight`,e),{maxCol:f=u-1,maxRow:p=d-1,minCol:m=0,minRow:h=0}=i.get(o)??{},{x:g,y:_}=J(e,t);return new l({cols:[m,f],level:n,levelValue:o,origin:[g,_],scale:s,resolution:c,rows:[h,p]})}function X(e,t,n){let i;return i=r.hasOwnProperty(``+e)?r.values[r[e]]:n===`default028mm`?6370997*Math.PI/180:v(e).metersPerDegree,7*t/25e3/i}var Z,Q={"image/png":`.png`,"image/png8":`.png`,"image/png24":`.png`,"image/png32":`.png`,"image/jpg":`.jpg`,"image/jpeg":`.jpeg`,"image/gif":`.gif`,"image/bmp":`.bmp`,"image/tiff":`.tif`,"image/jpgpng":``,"image/jpegpng":``,"image/unknown":``},Ce=new Set([`version`,`service`,`request`,`layer`,`style`,`format`,`tilematrixset`,`tilematrix`,`tilerow`,`tilecol`]),$=Z=class extends ee(x(t(s(c(p(d)))))){constructor(...e){super(...e),this.activeLayer=null,this.copyright=``,this.customParameters=null,this.customLayerParameters=null,this.fullExtent=null,this.operationalLayerType=`WebTiledLayer`,this.resourceInfo=null,this.serviceMode=`RESTful`,this.sublayers=null,this.type=`wmts`,this.version=`1.0.0`,this.addHandles([T(()=>this.activeLayer,(e,t)=>{t&&!this.sublayers?.includes(t)&&(t.layer=null,t.parent=null),e&&(e.layer=this,e.parent=this)},_),w(()=>this.sublayers,`after-add`,({item:e})=>{e.layer=this,e.parent=this},_),w(()=>this.sublayers,`after-remove`,({item:e})=>{e.layer=null,e.parent=null},_),T(()=>this.sublayers,(e,t)=>{if(t)for(let e of t)e.layer=null,e.parent=null;if(e)for(let t of e)t.layer=this,t.parent=this},_)])}normalizeCtorArgs(e,t){return typeof e==`string`?{url:e,...t}:e}load(t){return this.addResolvingPromise(this.loadFromPortal({supportedTypes:[`WMTS`]},t).catch(D).then(()=>this._fetchService(t)).catch(t=>{throw D(t),new e(`wmtslayer:unsupported-service-data`,`Invalid response from the WMTS service.`,{error:t})})),Promise.resolve(this)}readActiveLayerFromService(e,t,n){this.activeLayer||=new I;let r=t.layers.find(e=>e.id===this.activeLayer.id);return r||=t.layers[0],this.activeLayer.read(r,n),this.activeLayer}readActiveLayerFromItemOrWebDoc(e,t){let{templateUrl:n,wmtsInfo:r}=t,i=n?this._getLowerCasedUrlParams(n):null,a=r?.layerIdentifier,o=null,s=r?.tileMatrixSet;s&&(Array.isArray(s)?s.length&&(o=s[0]):o=s);let c=i?.format,l=i?.style;return new I({id:a,imageFormat:c,styleId:l,tileMatrixSetId:o})}writeActiveLayer(e,t,n,r){let i=this.activeLayer;t.templateUrl=this.getUrlTemplate(i.id,i.tileMatrixSetId,i.imageFormat,i.styleId);let a=u(`tileMatrixSet.tileInfo`,i);t.tileInfo=a?a.toJSON(r):null,t.wmtsInfo={...t.wmtsInfo,layerIdentifier:i.id,tileMatrixSet:i.tileMatrixSetId}}readCustomParameters(e,t){let n=t.wmtsInfo;return n?this._mergeParams(n.customParameters,n.url):null}get fullExtents(){return this.activeLayer.fullExtents}readServiceMode(e,t){return t.templateUrl.includes(`?`)?`KVP`:`RESTful`}readSublayersFromService(e,t,n){return we(t.layers,n)}get supportedSpatialReferences(){return this.activeLayer.tileMatrixSets?.map(e=>e.tileInfo?.spatialReference).toArray().filter(E)??[]}get tilemapCache(){let e=this.activeLayer?.tileMatrixSet?.tileInfo;return e?new re(e):void 0}get title(){return this.activeLayer?.title??`Layer`}set title(e){this._overrideIfSome(`title`,e)}get url(){return this._get(`url`)}set url(e){e&&e.endsWith(`/`)?this._set(`url`,e.slice(0,-1)):this._set(`url`,e)}createWebTileLayer(e){let t=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId),n=this._getTileMatrixSetById(e.tileMatrixSetId),r=n?.tileInfo,i=e.fullExtent,a=new ie({layerIdentifier:e.id,tileMatrixSet:e.tileMatrixSetId,url:this.url});return this.customLayerParameters&&(a.customLayerParameters=this.customLayerParameters),this.customParameters&&(a.customParameters=this.customParameters),new ae({fullExtent:i,urlTemplate:t,tileInfo:r,wmtsInfo:a})}async fetchTile(e,t,n,r={}){let{signal:i}=r,a=this.getTileUrl(e,t,n),{data:o}=await g(a,{responseType:`image`,signal:i});return o}async fetchImageBitmapTile(e,t,n,r={}){let{signal:i}=r;if(this.fetchTile!==Z.prototype.fetchTile){let a=await this.fetchTile(e,t,n,r);return ne(a,e,t,n,i)}let a=this.getTileUrl(e,t,n),{data:o}=await g(a,{responseType:`blob`,signal:i});return ne(o,e,t,n,i)}findSublayerById(e){return this.sublayers?.find(t=>t.id===e)}getTileUrl(e,t,n){let r=this._getTileMatrixSetById(this.activeLayer.tileMatrixSetId),i=r?.tileInfo?.lods[e],a=i?i.levelValue||`${i.level}`:`${e}`,o=this.resourceInfo?``:de({dimensionMap:this.dimensionMap,layerMap:this.layerMap},this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId,a,t,n);return o||=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId).replaceAll(/\{level\}/gi,a).replaceAll(/\{row\}/gi,`${t}`).replaceAll(/\{col\}/gi,`${n}`),o=this._appendCustomLayerParameters(o),o}getUrlTemplate(e,t,n,r){if(!this.resourceInfo){let n=pe({dimensionMap:this.dimensionMap,layerMap:this.layerMap},e,t,r);if(n)return n}if(this.serviceMode===`KVP`)return this.url+`?SERVICE=WMTS&VERSION=`+this.version+`&REQUEST=GetTile&LAYER=`+e+`&STYLE=`+r+`&FORMAT=`+n+`&TILEMATRIXSET=`+t+`&TILEMATRIX={level}&TILEROW={row}&TILECOL={col}`;if(this.serviceMode===`RESTful`){let i=``;return Q[n.toLowerCase()]&&(i=Q[n.toLowerCase()]),this.url+e+`/`+r+`/`+t+`/{level}/{row}/{col}`+i}return``}async _fetchService(t){if(this.resourceInfo)return this.resourceInfo.serviceMode!==`KVP`||this.url.includes(`?`)||(this.url+=`?`),le(this.resourceInfo),void this.read(this.resourceInfo,{origin:`service`});let n=null;try{let{data:e}=await this._getCapabilities(this.serviceMode,t);n=R(e),z(n)}catch{let r=this.serviceMode===`KVP`?`RESTful`:`KVP`;try{let{data:e}=await this._getCapabilities(r,t);n=R(e),z(n),this.serviceMode=r}catch(t){throw new e(`wmtslayer:unsupported-service-data`,`Services does not support RESTful or KVP service modes.`,{error:t})}}let{serviceMode:r,url:i}=this,a=ce(n,{serviceMode:r,url:i});this.read(a,{origin:`service`})}async _getCapabilities(e,t){let n=this._getCapabilitiesUrl(e);return await g(n,{...t,responseType:`text`})}_getTileMatrixSetById(e){return this.findSublayerById(this.activeLayer.id)?.tileMatrixSets?.find(({id:t})=>t===e)}_appendCustomParameters(e){return this._appendParameters(e,this.customParameters)}_appendCustomLayerParameters(e){return this._appendParameters(e,{...o(this.customParameters),...this.customLayerParameters})}_appendParameters(e,t){let n=S(e),r={...n.query,...t},i=te(r);return i===``?n.path:`${n.path}?${i}`}_getCapabilitiesUrl(e){this.url=S(this.url).path;let t=this.url;switch(e){case`KVP`:t+=`?request=GetCapabilities&service=WMTS&version=${this.version}`;break;case`RESTful`:{let e=`/${this.version}/WMTSCapabilities.xml`,n=new RegExp(e,`i`);t=t.replace(n,``),t+=e;break}}return this._appendCustomParameters(t)}_getLowerCasedUrlParams(e){if(!e)return null;let t=S(e).query;if(!t)return null;let n={};return Object.keys(t).forEach(e=>{n[e.toLowerCase()]=t[e]}),n}_mergeParams(e,t){let n=this._getLowerCasedUrlParams(t);if(n){let t=Object.keys(n);t.length&&(e=e?o(e):{},t.forEach(t=>{e.hasOwnProperty(t)||Ce.has(t)||(e[t]=n[t])}))}return e}};function we(e,t){return e.map(e=>{let n=new I;return n.read(e,t),n})}C([i()],$.prototype,`dimensionMap`,void 0),C([i()],$.prototype,`layerMap`,void 0),C([i({type:I,json:{origins:{"web-document":{write:{ignoreOrigin:!0}}}}})],$.prototype,`activeLayer`,void 0),C([h(`service`,`activeLayer`,[`layers`])],$.prototype,`readActiveLayerFromService`,null),C([h([`web-document`,`portal-item`],`activeLayer`,[`wmtsInfo`])],$.prototype,`readActiveLayerFromItemOrWebDoc`,null),C([f([`web-document`,`portal-item`],`activeLayer`,{templateUrl:{type:String},tileInfo:{type:n},"wmtsInfo.layerIdentifier":{type:String},"wmtsInfo.tileMatrixSet":{type:String}})],$.prototype,`writeActiveLayer`,null),C([i({type:String,value:``,json:{write:!0}})],$.prototype,`copyright`,void 0),C([i({type:[`show`,`hide`]})],$.prototype,`listMode`,void 0),C([i({json:{read:!0,write:!0}})],$.prototype,`blendMode`,void 0),C([i({json:{origins:{"web-document":{read:{source:[`wmtsInfo.customParameters`,`wmtsInfo.url`]},write:{target:`wmtsInfo.customParameters`}},"portal-item":{read:{source:[`wmtsInfo.customParameters`,`wmtsInfo.url`]},write:{target:`wmtsInfo.customParameters`}}}}})],$.prototype,`customParameters`,void 0),C([h([`portal-item`,`web-document`],`customParameters`)],$.prototype,`readCustomParameters`,null),C([i({json:{origins:{"web-document":{read:{source:`wmtsInfo.customLayerParameters`},write:{target:`wmtsInfo.customLayerParameters`}},"portal-item":{read:{source:`wmtsInfo.customLayerParameters`},write:{target:`wmtsInfo.customLayerParameters`}}}}})],$.prototype,`customLayerParameters`,void 0),C([i({type:O,json:{write:{ignoreOrigin:!0},origins:{"web-document":{read:{source:`fullExtent`}},"portal-item":{read:{source:`fullExtent`}}}}})],$.prototype,`fullExtent`,void 0),C([i({readOnly:!0})],$.prototype,`fullExtents`,null),C([i({type:[`WebTiledLayer`]})],$.prototype,`operationalLayerType`,void 0),C([i()],$.prototype,`resourceInfo`,void 0),C([i()],$.prototype,`serviceMode`,void 0),C([h([`portal-item`,`web-document`],`serviceMode`,[`templateUrl`])],$.prototype,`readServiceMode`,null),C([i({type:y.ofType(I)})],$.prototype,`sublayers`,void 0),C([h(`service`,`sublayers`,[`layers`])],$.prototype,`readSublayersFromService`,null),C([i({readOnly:!0})],$.prototype,`supportedSpatialReferences`,null),C([i({readOnly:!0})],$.prototype,`tilemapCache`,null),C([i({json:{read:{source:`title`}}})],$.prototype,`title`,null),C([i({json:{read:!1},readOnly:!0,value:`wmts`})],$.prototype,`type`,void 0),C([i({json:{origins:{service:{read:{source:`tileUrl`}},"web-document":{read:{source:`wmtsInfo.url`},write:{target:`wmtsInfo.url`}},"portal-item":{read:{source:`wmtsInfo.url`},write:{target:`wmtsInfo.url`}}}}})],$.prototype,`url`,null),C([i()],$.prototype,`version`,void 0),$=Z=C([m(`esri.layers.WMTSLayer`)],$);var Te=$;export{Te as default};