const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/LineCallout.glsl-DTTiqHkh.js","assets/LineCallout.glsl-Dk1G3jmu.js","assets/index-CzMixifc.js","assets/index-CDgdHpAj.css","assets/Slice.glsl-A8bL0Rkn.js","assets/Float3DrawUniform-UWnIK6YY.js","assets/Uniform-CfHWJqSg.js","assets/glsl-B__sVAcg.js","assets/HUDVisibility.glsl-nxRXaAOJ.js","assets/VerticalOffset.glsl-sMlOSVvR.js","assets/ScreenSizePerspective.glsl-BlmhzUp0.js","assets/Float3PassUniform-BIrLVK7_.js","assets/View.glsl-D5eT11ZQ.js","assets/Float3BindUniform-DnRIK6cJ.js","assets/FloatBindUniform-BPgZfINH.js","assets/Matrix4BindUniform-DNS5lGEU.js","assets/Float4PassUniform-CYWbrPzx.js","assets/BooleanBindUniform-9cQHW2Mv.js","assets/Float4BindUniform-DtHi0dnJ.js","assets/FloatPassUniform-D-_T45xB.js","assets/Texture2DBindUniform-BW-pj6EM.js","assets/ReadDepth.glsl-DUk8QQwu.js","assets/Float2BindUniform-COpkFEGz.js","assets/Float2PassUniform-gY4yy6pK.js","assets/ShaderBuilder-Dbc4jYz7.js","assets/NoParameters-B66z9IwQ.js","assets/Graphics3DSymbolLayerFactory-xpLpso5t.js","assets/ColorMaterial.glsl-DTJVM4te.js","assets/Transform.glsl-DMKMztkJ.js","assets/VisualVariables.glsl-BbHLNeev.js","assets/FloatsPassUniform-Dhl7UDF5.js","assets/AlphaCutoff-qYsC5qb0.js","assets/HighlightReadBitmap.glsl-yTX333eD.js","assets/ObjectAndLayerIdColor.glsl-DLOlMhcf.js","assets/VertexColor.glsl-D6K20lwp.js","assets/TerrainDepthTest.glsl-BUpx6Cvv.js","assets/OutputColorHighlightOLID.glsl-B38t8Aex.js","assets/Emissions.glsl-nadaueeL.js","assets/Texture2DDrawUniform-CV_1kucp.js","assets/Texture2DPassUniform-wY08hxIn.js","assets/DefaultMaterial.glsl-C2MdTJtA.js","assets/ReadShadowMap.glsl-5e85BRzh.js","assets/PiUtils.glsl-D-ndpb0M.js","assets/MixExternalColor.glsl-DhNkb2B4.js","assets/SnowCover.glsl-DZ1l37to.js","assets/SSAO.glsl-_Ml8r3TO.js","assets/ScreenSpacePass.glsl-MQijsFL9.js","assets/CameraSpace.glsl-DZ0WgHSr.js","assets/SSAOBlur.glsl-BO4v28iF.js","assets/Float2DrawUniform-DrsJI05n.js","assets/SceneLighting-Bd70zCMB.js","assets/sphere-DkSdrT5o.js","assets/vectorStacks-BQiry9fn.js","assets/quatf64-eO7UAs9K.js","assets/vec3-D7a6REBc.js","assets/plane--nqwMDYx.js","assets/ray-XqUMyuyU.js","assets/ObjectStack-DiVLRoBj.js","assets/projectPointToVector-D72S8Uh5.js","assets/projectVectorToVector-CZxjcyx6.js","assets/dehydratedPoint-CVzHYxaL.js","assets/frustum-DHXawB8f.js","assets/lineSegment-WEn1ku7V.js","assets/orientedBoundingBox-DQ8LQLAH.js","assets/quat-XKFzqP_i.js","assets/computeTranslationToOriginAndRotation-DwwRDWAD.js","assets/spatialReferenceEllipsoidUtils-b6wDfyu0.js","assets/HUDIntersectorResult-BZpY5C1W.js","assets/VertexAttributeLocations-DOYYzMyn.js","assets/VertexElementDescriptor-C9CNG143.js","assets/renderState-DH1meWdn.js","assets/IntegerPassUniform-BWtfz08R.js","assets/Matrix4PassUniform-9Utk6s1j.js","assets/MaterialUtil-BLN1UlUe.js","assets/Normals.glsl-Bd6fZ2hC.js","assets/HUDMaterial.glsl-iXgXHpJs.js","assets/HighlightApply.glsl-z0sIF5jH.js","assets/HighlightDownsample.glsl-CKuf0GsQ.js","assets/HighlightCellGridScreenSpacePass.glsl-BKkAmC25.js","assets/HighlightBlur.glsl-CbFN0SVI.js","assets/HighlightToSingle.glsl-NczMiEeh.js","assets/LineMarker.glsl-NFWMCOxu.js","assets/MarkerSizing.glsl-CtCvR4o9.js","assets/NativeLine.glsl-BQY7sqhl.js","assets/OverlayCompositing.glsl-BBFwctiS.js","assets/Path.glsl-CXCvAsx7.js","assets/NormalUtils.glsl-uET4Vps_.js","assets/Pattern.glsl-DFUC48MW.js","assets/RealisticTree.glsl-CZ6QJ5o-.js","assets/RibbonLine.glsl-B6EO8Ip1.js","assets/TextureOnly.glsl-B3pARRXz.js","assets/WaterSurface.glsl-CWA0HdQt.js","assets/weather-CFcauIFR.js","assets/earcut-CsNwSYFA.js","assets/indexUtils-Bo96jceH.js","assets/Indices-DELx3He_.js","assets/vec3-D13Z1xO0.js","assets/vec4-CJBDH7oG.js","assets/BidiEngine-CpIovbIK.js","assets/CIMSymbolHelper-CIzDgFQE.js","assets/rasterizingUtils-L-rXtdWe.js","assets/labelPoint-D95l1mBc.js","assets/OptimizedGeometry-5fDazGe-.js","assets/memoryEstimations-C3WUBUZI.js","assets/GeometryUtils-C6BJBMi9.js","assets/Rect-BMNJQxpm.js","assets/BoundingBox-CW0_Ka-z.js","assets/NestedMap-BEhJHzak.js","assets/devEnvironmentUtils-BL8rxKsk.js","assets/vec3f32-BWuLbfSR.js","assets/graphicUtils-D4vcxFBm.js","assets/FloatArray-DhcAaYJ8.js","assets/BufferView-BPABY7if.js","assets/Util-YNFIi00s.js","assets/types-DsLx34Br.js","assets/meshVertexSpaceUtils-CrM2H6JB.js","assets/MeshLocalVertexSpace-Dfv_NBsU.js","assets/hydratedFeatures-Cj67oeX-.js","assets/DefaultBufferWriter-CAVJ0EqM.js","assets/triangle-B4dfMIWc.js","assets/MeshComponent-B_wmH396.js","assets/MeshMaterialMetallicRoughness-dLgvoHFj.js","assets/meshCloneUtils-5rtyOBgA.js","assets/meshProperties-DwrhStLW.js","assets/Normals-C9bgSX6t.js","assets/axisAngleDegrees-GaSk0_KM.js","assets/deduplicate-C8bQBzHi.js","assets/projectMeshVertexPositions-Cs04NHNO.js","assets/vertexSpaceConversion-WXuyjrGI.js","assets/triangulationUtils-DZOlYzLu.js","assets/SnappingCandidate-BMrZX9Ey.js","assets/videoUtils-CDhtaJ_j.js","assets/ManagedTexture-N0puH7JB.js","assets/image-CSnYJraV.js","assets/pointUtils-CWrBxBjO.js","assets/ElevationContext-RIB4rYIh.js","assets/Octree-Bwk-xF2H.js","assets/primitiveObjectSymbolUtils-DBU61hLp.js","assets/Intersector-DrVIdDEe.js","assets/symbolColorUtils-BzuXy7VF.js","assets/DefaultMaterial-BweY01X0.js","assets/VertexBuffer-Dhf7DMaS.js","assets/BufferObject-DizvMSTk.js","assets/cimSymbolUtils-Dwr_LmxD.js","assets/utils-BroCumRv.js","assets/webStyleSymbolUtils-8kaQqao_.js","assets/DefaultLayouts-DnVLEhVX.js","assets/TextureBackedBufferLayout-YNJ8l8Rr.js","assets/VertexArrayObject-BCHCoUBc.js","assets/objectResourceUtils-B9UyAnEr.js","assets/resourceUtils-BqN6xlVZ.js","assets/placementUtils-D4ygv7uV.js","assets/sdfPrimitives-CXbCDQbD.js"])))=>i.map(i=>d[i]);
import{$_ as e,BS as t,BT as n,Bl as r,Cl as i,DT as a,Dh as o,Ed as s,Ef as c,Eg as l,Fd as u,Gg as d,Gr as f,Hl as p,Id as ee,J as te,JE as m,J_ as h,Jb as ne,Jx as re,KE as ie,Kb as ae,Kh as oe,Kr as g,Lb as se,Lw as ce,Ml as le,Nd as ue,Nl as de,Nm as fe,Nu as pe,OT as _,Og as me,Ol as v,Ow as he,Pg as ge,Q as _e,Q_ as ve,Qd as ye,Rf as be,Ru as xe,Sf as Se,Td as Ce,Tf as we,Ul as Te,Up as Ee,Vb as De,Vi as Oe,Vl as y,Vr as ke,WT as b,Wg as Ae,Wl as je,Yf as Me,Yl as x,Yw as Ne,Z as Pe,Z_ as Fe,Zp as Ie,_S as Le,_w as S,af as Re,al as ze,ax as Be,bf as Ve,c_ as C,cg as He,dT as Ue,dl as We,eT as w,ef as Ge,ev as Ke,ex as qe,fE as Je,fT as Ye,ff as Xe,gD as T,if as Ze,ig as Qe,iv as $e,jn as et,jr as tt,kf as E,kl as nt,kv as rt,lE as it,ll as at,lm as ot,lw as st,nv as D,oT as ct,ov as lt,pD as ut,pT as dt,pf as ft,pg as pt,px as mt,qh as ht,qr as gt,qw as _t,rD as vt,rS as yt,rT as bt,rh as xt,rl as St,rv as Ct,rx as wt,sv as Tt,tv as Et,tx as O,uD as Dt,uE as k,ug as Ot,vT as A,vd as kt,wx as At,xb as jt,yl as Mt,zb as Nt,zr as Pt,zu as Ft}from"./index-CzMixifc.js";import{n as It}from"./memoryEstimations-C3WUBUZI.js";import{t as Lt}from"./OptimizedGeometry-5fDazGe-.js";import{n as Rt}from"./OptimizedFeatureSet-D4F9ObY_.js";import{a as zt}from"./featureConversionUtils-VvJ2pauf.js";import"./quatf64-eO7UAs9K.js";import"./quat-XKFzqP_i.js";import"./MeshLocalVertexSpace-Dfv_NBsU.js";import"./meshVertexSpaceUtils-CrM2H6JB.js";import"./Indices-DELx3He_.js";import{C as Bt,b as Vt,g as Ht,n as Ut,r as Wt,y as Gt}from"./plane--nqwMDYx.js";import"./vectorStacks-BQiry9fn.js";import{t as Kt}from"./projectPointToVector-D72S8Uh5.js";import{t as qt}from"./computeTranslationToOriginAndRotation-DwwRDWAD.js";import"./BufferView-BPABY7if.js";import"./Util-YNFIi00s.js";import"./spatialReferenceEllipsoidUtils-b6wDfyu0.js";import{n as Jt}from"./PooledRBush-OI-c3i-A.js";import"./types-DsLx34Br.js";import{n as Yt}from"./dehydratedPoint-CVzHYxaL.js";import{t as Xt}from"./projectVectorToVector-CZxjcyx6.js";import"./symbolColorUtils-BzuXy7VF.js";import{i as Zt}from"./orientedBoundingBox-DQ8LQLAH.js";import{i as Qt,l as $t}from"./Emissions.glsl-nadaueeL.js";import"./glsl-B__sVAcg.js";import"./Uniform-CfHWJqSg.js";import"./Float3DrawUniform-UWnIK6YY.js";import"./Float3PassUniform-BIrLVK7_.js";import"./FloatPassUniform-D-_T45xB.js";import"./Texture2DDrawUniform-CV_1kucp.js";import"./Texture2DPassUniform-wY08hxIn.js";import"./NoParameters-B66z9IwQ.js";import{a as en,r as tn,t as nn}from"./layerViewUtils-Cbrog-dU.js";import{r as rn}from"./popupUtils-Bps_s4dv.js";import{h as an}from"./elevationInfoUtils-BcUBf70F.js";import{t as j}from"./optimizedFeatureQueryEngineAdapter-DhyuxDon.js";import"./quantizationUtils-CzrQVcZ1.js";import"./ObjectStack-DiVLRoBj.js";import{r as on}from"./ray-XqUMyuyU.js";import"./HUDIntersectorResult-BZpY5C1W.js";import"./Intersector-DrVIdDEe.js";import"./videoUtils-CDhtaJ_j.js";import"./VertexAttributeLocations-DOYYzMyn.js";import"./VertexElementDescriptor-C9CNG143.js";import"./vec3-D7a6REBc.js";import"./sphere-DkSdrT5o.js";import{d as sn,o as cn}from"./lineSegment-WEn1ku7V.js";import"./triangle-B4dfMIWc.js";import"./dehydratedFeatureComparison-DeSHk9xR.js";import{t as ln}from"./hydratedFeatures-Cj67oeX-.js";import"./BufferObject-DizvMSTk.js";import"./VertexBuffer-Dhf7DMaS.js";import"./vec3f32-BWuLbfSR.js";import"./ShaderBuilder-Dbc4jYz7.js";import{t as un}from"./LayerView-BKgBHcbR.js";import{t as dn}from"./highlightOptionsUtils-C-mZET-I.js";import{a as fn,c as pn,n as M,r as mn}from"./dehydratedFeatures-Db6Q9NQd.js";import{a as hn,i as gn,n as _n,o as vn}from"./renderState-DH1meWdn.js";import"./image-CSnYJraV.js";import"./frustum-DHXawB8f.js";import{D as yn,E as bn,O as xn,P as N,T as Sn,k as Cn,x as wn,y as Tn}from"./DefaultBufferWriter-CAVJ0EqM.js";import{C as En,a as Dn,b as On,g as kn,n as An,o as jn,p as Mn,r as Nn,s as Pn,t as Fn}from"./ElevationContext-RIB4rYIh.js";import{a as In}from"./MaterialUtil-BLN1UlUe.js";import"./Octree-Bwk-xF2H.js";import{a as Ln,d as Rn,s as zn}from"./SceneLighting-Bd70zCMB.js";import"./ScreenSpacePass.glsl-MQijsFL9.js";import"./Float2BindUniform-COpkFEGz.js";import"./ReadDepth.glsl-DUk8QQwu.js";import{a as Bn}from"./FloatArray-DhcAaYJ8.js";import"./Float4BindUniform-DtHi0dnJ.js";import"./CameraSpace.glsl-DZ0WgHSr.js";import"./Texture2DBindUniform-BW-pj6EM.js";import"./Float2PassUniform-gY4yy6pK.js";import"./Float3BindUniform-DnRIK6cJ.js";import"./Float4PassUniform-CYWbrPzx.js";import"./FloatBindUniform-BPgZfINH.js";import"./Matrix4BindUniform-DNS5lGEU.js";import"./Matrix4PassUniform-9Utk6s1j.js";import"./FloatsPassUniform-Dhl7UDF5.js";import"./IntegerPassUniform-BWtfz08R.js";import"./HighlightReadBitmap.glsl-yTX333eD.js";import"./Float2DrawUniform-DrsJI05n.js";import"./Slice.glsl-A8bL0Rkn.js";import"./ObjectAndLayerIdColor.glsl-DLOlMhcf.js";import"./VisualVariables.glsl-BbHLNeev.js";import{t as Vn}from"./AlphaCutoff-qYsC5qb0.js";import"./ScreenSizePerspective.glsl-BlmhzUp0.js";import"./View.glsl-D5eT11ZQ.js";import"./MarkerSizing.glsl-CtCvR4o9.js";import"./RibbonLine.glsl-B6EO8Ip1.js";import"./ManagedTexture-N0puH7JB.js";import"./sdfPrimitives-CXbCDQbD.js";import"./PiUtils.glsl-D-ndpb0M.js";import"./TerrainDepthTest.glsl-BUpx6Cvv.js";import"./OutputColorHighlightOLID.glsl-B38t8Aex.js";import{c as Hn,l as Un,t as Wn}from"./graphicUtils-D4vcxFBm.js";import"./VerticalOffset.glsl-sMlOSVvR.js";import"./HUDVisibility.glsl-nxRXaAOJ.js";import"./BooleanBindUniform-9cQHW2Mv.js";import"./HUDMaterial.glsl-iXgXHpJs.js";import"./Transform.glsl-DMKMztkJ.js";import"./VertexColor.glsl-D6K20lwp.js";import{A as Gn,C as Kn,D as qn,N as Jn,b as Yn,c as Xn,h as Zn,i as Qn,j as $n,l as er,n as tr,s as nr,t as rr,u as ir,v as ar,x as or,y as sr}from"./pointUtils-CWrBxBjO.js";import"./primitiveObjectSymbolUtils-DBU61hLp.js";import"./MixExternalColor.glsl-DhNkb2B4.js";import"./DefaultMaterial-BweY01X0.js";import"./SnowCover.glsl-DZ1l37to.js";import"./DefaultMaterial.glsl-C2MdTJtA.js";import"./ReadShadowMap.glsl-5e85BRzh.js";import"./SSAOBlur.glsl-BO4v28iF.js";import"./SSAO.glsl-_Ml8r3TO.js";import"./Normals.glsl-Bd6fZ2hC.js";import"./RealisticTree.glsl-CZ6QJ5o-.js";import{n as cr}from"./LineCallout.glsl-Dk1G3jmu.js";var lr=e=>{let t=e,n=class extends t{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(){super.postscript(),Ft(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}async _validateHeightModelInfo(){let e=new AbortController,t=e.signal;this.addHandles(b(()=>e.abort())),await Et(()=>this.view.defaultsFromMap?.heightModelInfoReady,t),w(t);let n=xe(this.layer,this.view.heightModelInfo,this.supportsHeightUnitConversion);if(n)throw n}};return T([a()],n.prototype,`view`,void 0),T([a()],n.prototype,`slicePlaneEnabled`,void 0),n=T([_(`esri.views.3d.layers.LayerView3D`)],n),n};async function ur(e,t,n,r,i){let{elevationProvider:a,renderCoordsHelper:o}=e,{elevationInfo:s}=t,{pointsInFeatures:c,spatialReference:l}=r,u=At.fromJSON(l),d=Nn(s,!0),f=await An(d,u,i);w(i);let p=[],ee=new Set,te=new Set,m=new Fn,h=Yt(0,0,0,At.WGS84),ne=new Mn,re=C();h.spatialReference=u;let ie=e.elevationProvider.spatialReference??e.spatialReference;for(let{objectId:e,points:r}of c){let c=n(e);if(c==null){for(let e of r)p.push(e.z??0);ee.add(e);continue}c.isDraped&&te.add(e);let l=c.graphic.geometry;m.setFromElevationInfo(an(l,s)),f&&m.updateFeatureExpressionInfoContextForGraphic(f,c.graphic,t);for(let{x:e,y:t,z:n}of r)h.x=e,h.y=t,h.z=n??0,await Kt(h,re,ie,{signal:i}),Dn(re,a,m,o,ne),p.push(ne.z)}return{elevations:p,drapedObjectIds:te,failedObjectIds:ee}}function dr(e){return e==null||e.type===`simple`||e.type===`unique-value`||e.type===`class-breaks`||e.type===`dictionary`||e.type===`heatmap`}function fr(e,t){if(e==null)return null;if(!dr(e))return new n(`renderer-conversion-3d:unsupported-renderer`,`Unsupported renderer of type '${e.type}'`,{renderer:e});switch(e.type){case`simple`:return mr(e,t);case`unique-value`:return hr(e,t);case`class-breaks`:return gr(e,t);case`dictionary`:case`heatmap`:return null}return null}function pr(e,t){if(!t)return null;if(Array.isArray(t)||(t=[t]),t.length>0){let r=t.map(e=>e.details.symbol.type||e.details.symbol.declaredClass).filter(e=>!!e);r.sort();let i=[];return r.forEach((e,t)=>{t!==0&&e===r[t-1]||i.push(e)}),new n(`renderer-conversion-3d:unsupported-symbols`,`Renderer contains symbols (${i.join(`, `)}) which are not supported in 3D`,{renderer:e,symbolErrors:t})}return null}function mr(e,t){let n={...f,...t,cimFallbackEnabled:!0};return pr(e,g(e.symbol,n).error)}function hr(e,t){let n={...f,...t,cimFallbackEnabled:!0},r=e.uniqueValueInfos?.map(e=>g(e.symbol,n).error).filter(m),i=g(e.defaultSymbol,n);return i.error&&r?.unshift(i.error),pr(e,r)}function gr(e,t){let n={...f,...t,cimFallbackEnabled:!0},r=e.classBreakInfos.map(e=>g(e.symbol,n).error).filter(m),i=g(e.defaultSymbol,n);return i.error&&r.unshift(i.error),pr(e,r)}var _r=class{constructor(e,t,n){this.maximumTotalNumberOfVertices=e,this.maximumNumberOfFeatures=t,this.averageSymbolComplexity=n}},vr=class{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,n){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,n)}async queryElevation(e,t,n,r,i){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,i,n,r)}},yr=Ve(),P=class extends S{constructor(e){super(e),this.events=new lt,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(e,t)=>`graphic`in e?e.graphic.attributes[t]:j.getAttribute(e,t),getAttributeAsTimestamp(e,t){let n=this.getAttribute(e,t);return typeof n==`number`?n:new Date(n).getTime()},getAttributes:e=>`graphic`in e?e.graphic.attributes:j.getAttributes(e),getObjectId:e=>`graphic`in e?M(e.graphic,this.objectIdField)??void 0:j.getObjectId(e),getGeometry:e=>`graphic`in e?e.getAsOptimizedGeometry(this.hasZ,this.hasM):j.getGeometry(e),getCentroid:(e,t)=>{if(`graphic`in e){let n=null;e.centroid==null?e.graphic.geometry.type===`point`&&ge(e.graphic.geometry,br,this.viewSpatialReference)&&(n=br):n=e.centroid;let r=Array(2+(t.hasZ?1:0)+(t.hasM?1:0));return n==null?(r[0]=0,r[1]=0,r[2]=0,r[3]=0):(r[0]=n.x,r[1]=n.y,t.hasZ&&(r[2]=n.hasZ?n.z:0),t.hasM&&(r[t.hasZ?3:2]=n.hasM?n.m:0)),new Lt([],r,t.hasZ,t.hasM)}return j.getCentroid(e,t)},cloneWithGeometry:(e,t)=>`graphic`in e?new Rt(t,this.featureAdapter.getAttributes(e),null,this.featureAdapter.getObjectId(e)):j.cloneWithGeometry(e,t)}}forEachInBounds(e,t){this.getSpatialIndex().forEachInBounds(e,t)}forEachBounds(e,t){let n=this.getSpatialIndex();for(let r of e){let e=this.featureAdapter.getObjectId(r);n.getBounds(e,yr)!=null&&t(yr)}}};T([a({constructOnly:!0})],P.prototype,`getSpatialIndex`,void 0),T([a({constructOnly:!0})],P.prototype,`forEach`,void 0),T([a({constructOnly:!0})],P.prototype,`hasZ`,void 0),T([a({constructOnly:!0})],P.prototype,`hasM`,void 0),T([a({constructOnly:!0})],P.prototype,`objectIdField`,void 0),T([a({constructOnly:!0})],P.prototype,`viewSpatialReference`,void 0),T([a({constructOnly:!0})],P.prototype,`featureSpatialReference`,void 0),P=T([_(`esri.views.3d.layers.graphics.Graphics3DFeatureStore`)],P);var br={type:`point`,x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null},xr=class{constructor(e,t,n){this.graphic=e,this.renderingInfo=t,this.layer=n}},Sr=class{constructor(e,t,n,r){this.scheduler=e,this.schedule=t,this.layerViewUid=n,this.compressionTracker=r,this.sharedResources=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}get spherical(){return this.stage.view.state.viewingMode===1}},Cr=class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}},wr=class extends Ln{constructor(e,n){super(e,n,Tr.locations),this.shader=new zn(cr,()=>t(()=>import(`./LineCallout.glsl-DTTiqHkh.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25])))}initializePipeline(e){let{hudDepth:t,terrainDepthTest:n}=e,r={func:n?519:513};return _n(t?{depthTest:r,depthWrite:gn}:{blending:vn(1,770,771,771),depthTest:r,colorWrite:hn})}};wr=T([_(`esri.views.3d.webgl-engine.shaders.LineCalloutTechnique`)],wr);var Tr=Bn().vec3f(`position`).vec3f(`normal`).vec2f16(`uv0`).vec4f(`centerOffsetAndDistance`),F=class extends xn{constructor(e){super(),this.spherical=e,this.screenCenterOffsetUnitsEnabled=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.hudDepth=!1,this.hudDepthAlignStart=!1,this.terrainDepthTest=!1,this.draped=!1}};T([N()],F.prototype,`screenCenterOffsetUnitsEnabled`,void 0),T([N()],F.prototype,`occlusionTestEnabled`,void 0),T([N()],F.prototype,`hasVerticalOffset`,void 0),T([N()],F.prototype,`hasScreenSizePerspective`,void 0),T([N()],F.prototype,`hudDepth`,void 0),T([N()],F.prototype,`hudDepthAlignStart`,void 0),T([N()],F.prototype,`terrainDepthTest`,void 0);var Er=class extends bn{constructor(e,t){super(e,kr),this.intersectDraped=void 0,this.produces=new Map([[16,e=>$t(e)],[17,e=>$t(e)]]),this._configuration=new F(t),this._uniqueMaterialIdentifier=Dr(this.parameters)}passParameters(){return this.parameters}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=this.parameters.verticalOffset!=null,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration.hudDepth=t.slot===17,this._configuration.hudDepthAlignStart=!!this.parameters.hudDepthAlignStart,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits===`screen`,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration}get visible(){return this.parameters.color[3]>=.003913894324853229||(this.parameters.borderColor?.[3]??0)>=.003913894324853229}intersect(){}createGLMaterial(e){return new Or(e)}createBufferWriter(){return new jr}validateParameters(e){this._uniqueMaterialIdentifier=Dr(e)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}};function Dr({renderOccluded:e,isDecoration:t,horizontalScreenOffset:n,color:r,size:i,occlusionTest:a,shaderPolygonOffset:o,hudDepthAlignStart:s,centerOffsetUnits:c,hasSlicePlane:l,screenSizePerspective:u,verticalOffset:d,borderColor:f}){return Je`${e}:${t}:${n}:[${r}]:${i}:${a}:${o}:${s}:${c}:${l}:${u!=null}:{${d?.screenLength}:${d?.minWorldLength}:${d?.maxWorldLength}}:[${f}]`}var Or=class extends Qt{beginSlot(e){return this.getTechnique(wr,e)}},kr=class extends yn{constructor(){super(...arguments),this.horizontalScreenOffset=0,this.color=_e(0,0,0,1),this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.hudDepthAlignStart=!1,this.centerOffsetUnits=`world`,this.hasSlicePlane=!1}},Ar=[x(0,0),x(1,0),x(0,1),x(1,0),x(1,1),x(0,1)],jr=class{constructor(){this.layout=Tr}elementCount(e){return 6*e.get(`position`).indices.length}write(e,t,n,r,i,a){Sn(n.get(`position`),e,i.position,a,6),Tn(n.get(`normal`),t,i.normal,a,6),wn(n.get(`centerOffsetAndDistance`),i.centerOffsetAndDistance,a,6);for(let e=0;e<Ar.length;++e)i.uv0.setVec(a+e,Ar[e]);return null}},Mr=class e extends nr{static{this.elevationModeChangeTypes={definedChanged:1,staysOnTheGround:1,onTheGroundChanged:2}}constructor(e,t){super(e,null,t,Ir),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._materials[0]=new Er(this._materialParameters,this._context.spherical)}_perInstanceMaterialParameters(e){let t=this._materialParameters;return t.horizontalScreenOffset=e.horizontalScreenOffset??0,t.centerOffsetUnits=e.centerOffsetUnits||`world`,t}get _materialParameters(){let e=new kr,t=this.symbol,n=t.callout;if(n.color){let t=xt.toUnitRGBA(n.color);t[3]*=this._getLayerOpacity(),e.color=t}else e.color=te;if(e.size=Qe(n.size||0),t.verticalOffset){let{screenLength:n,minWorldLength:r,maxWorldLength:i}=t.verticalOffset;e.verticalOffset={screenLength:Qe(n),minWorldLength:r||0,maxWorldLength:i??1/0}}e.borderColor=n.border?.color==null?null:xt.toUnitRGBA(n.border.color);let r=t.symbolLayers.at(0).type===`object`,i=t.type===`label-3d`;return e.occlusionTest=!r&&!ut(`enable-feature:non-occluded-hud`),r&&(e.shaderPolygonOffset=0),e.hudDepthAlignStart=i,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null,e}_defaultElevationInfoNoZ(){return Fr}createGraphics3DGraphic(e,t){let n=e.renderingInfo,r=e.graphic,i=this.createElevationContextForGraphic(r,n.elevationOffset||0),a=n.symbol,o=this._elevationContext.mode===`on-the-ground`&&(a.type===`cim`||!a.symbolLayers.some(e=>e.type===`object`||e.type===`text`));if(a.type!==`label-3d`&&o||a.type===`point-3d`&&a.symbolLayers.every(e=>e.type===`text`&&!u(e)))return null;let s=Hn(r.geometry);return s==null?null:this._createAs3DShape(s,i,n,r.uid,t)}layerOpacityChanged(){this._materials[0]?.setParameters(this._materialParameters)}layerScreenSizePerspectiveChanged(){let e=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null;this._materials[0]?.setParameters({screenSizePerspective:e})}layerElevationInfoChanged(t,n,r){let i=this._elevationContext.mode,a=Pn(e.elevationModeChangeTypes,r,i);return a!==1||t?.forEach(e=>{let t=n(e);t!=null&&this.graphics3DGraphicLayerElevationInfoChanged(e.graphic,t)}),a}slicePlaneEnabledChanged(){return this._materials[0]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}createElevationContextForGraphic(e,t=0){let n=super.createElevationContextForGraphic(e);return n.addOffsetRenderUnits(t),n}updateElevationContextForGraphic(e,t,n=0){super.updateElevationContextForGraphic(e,t),e.addOffsetRenderUnits(n)}graphics3DGraphicLayerElevationInfoChanged(e,t){let{elevationContext:n,metadata:r}=t;this.updateElevationContextForGraphic(n,e,r?.elevationOffset??0),t.needsElevationUpdates=jn(n.mode)}computeComplexity(){return new Kn({verticesPerFeature:6})}_getOrCreateMaterial(e,t){let n=this._perInstanceMaterialParameters(e),r=Dr(n);if(r===this._materials[0]?.uniqueMaterialIdentifier)return this._materials[0];if(t){let e=t.get(r);return e??(e=new Er(n,this._context.spherical),t.set(r,e)),e}return new Er(n,this._context.spherical)}_createAs3DShape(e,t,n,r,i){let a=this._context.layerViewUid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerViewUid:a}),s=this._getOrCreateMaterial(n,i),c=new Cn(s,Nr(n),null,1,o),l=Qn(this._context,e,c,t,r);if(l==null)return null;let u=new ir(this,l.object,null,Zn,t);return u.hiddenIfDeconflicted=!0,u.metadata=new er(n.elevationOffset),u.alignedSampledElevation=l.sampledElevation,u.needsElevationUpdates=jn(t.mode),tr(u,e,this._context.elevationProvider),u}};function Nr(e){let{translation:t,centerOffset:n}=e,r=new Zt(t?[t[0],t[1],t[2]]:[0,0,0],Pr,3,!0),i=new Zt(n?[n[0],n[1],n[2],n[3]]:[0,0,0,1],Pr,4,!0);return[[`position`,r],[`normal`,new Zt([0,0,1],Pr,3,!0)],[`centerOffsetAndDistance`,i]]}var Pr=[0],Fr={mode:`relative-to-ground`,offset:0},Ir={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},Lr=class extends Jn{constructor(e,t,n=C(),r=Pe(),i=0,a=`world`,o=0){super(e,t),this.translation=n,this.centerOffset=r,this.horizontalScreenOffset=i,this.centerOffsetUnits=a,this.elevationOffset=o}},Rr=()=>k.getLogger(`esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory`);function zr(e,t){if(!ee(e))return Rr().error(`Graphics3DCalloutSymbolLayerFactory#make`,`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;let n=Br[e.callout.type];return n?new n(e,t):(Rr().error(`Graphics3DCalloutSymbolLayerFactory#make`,`unknown or unsupported callout type ${e.callout.type}`),null)}var Br={line:Mr};function Vr(e,t,n,r){return e!=null&&(Le(t,r)?(ae(n,e),!0):(I[0]=e[0],I[1]=e[1],I[2]=0,!!d(I,t,0,I,r,0)&&(n[0]=I[0],n[1]=I[1],I[0]=e[2],I[1]=e[3],I[2]=0,!!d(I,t,0,I,r,0)&&(n[2]=I[0],n[3]=I[1],!0))))}var I=C(),Hr=new Ue(()=>Ve(),e=>c(e,ft),null,10,5),Ur=O(),Wr=class{get labelLayers(){return this._labelLayers||vt}get extent(){return this._extent}get isElevationSource(){return this.layers.some(e=>e?.isElevationSource)}constructor(e,t,n){this.graphic=e,this.graphics3DSymbol=t,this.layers=n,this._visibleFlags=255,++t.referenced,n.every(e=>e&&`hiddenIfDeconflicted`in e&&e.hiddenIfDeconflicted)&&(this._visibleFlags|=256)}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic(t=>{t.initialize(e),Gr(this._visibleFlags,1,t)})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.layers==null}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||=[],this._labelLayers.push(e),e.initialize(t),Gr(this._visibleFlags,16,e)}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),Gr(this._visibleFlags,1,e))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(t=>{t.type===`draped`&&(e=!0)}),e}isVisible(e=1,t=0){let n=this._visibleFlags;return Kr(n,e,t|16*t|(256&n?0:8))}setVisibilityFlag(e,t,n){let r=e*t;return n!==((this._visibleFlags&r)===r)&&(n?this._visibleFlags|=r:this._visibleFlags&=~r,e===1&&this._forEachSymbolLayerGraphic(e=>Gr(this._visibleFlags,1,e)),this._forEachLabelGraphic(e=>Gr(this._visibleFlags,16,e)),!0)}getVisibilityFlag(e,t){return(this._visibleFlags&e*t)!==0}computeExtent(e){if(!this._extent){let t=this.graphic.geometry;if(t==null)return!1;this._extent=O(),pn(t,this._extent);let n=t.spatialReference;if(!Le(n,e)&&!Vr(this._extent,n,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||=this._convertGraphicToOptimizedGeometry(this.graphic,e,t),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,n){let r=e.geometry;return r.type!==`mesh`&&r.type!==`extent`||(r=rt.fromExtent(r.type===`mesh`?r.extent:r)),zt(r,t,n)}get usedMemory(){let e=It(this.graphic.attributes);return this._forEachSymbolLayerGraphic(t=>e+=t.usedMemory),e}computeAttachmentOrigin(){let e={render:{origin:C(),num:0},draped:{origin:pe(),num:0}};for(let t of this.layers)t?.computeAttachmentOrigin(e);return e.render.num>1&&i(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&jt(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,n,r,i){return i||={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]},i.boundingBox?E(i.boundingBox):i.boundingBox=E(),i.requiresDrapedElevation=!1,await Ot(this.layers,async a=>{if(a==null)return;let o=a.type===`draped`?t:e,s=Hr.acquire(),c=await a.getProjectedBoundingBox(o,n,i.screenSpaceObjects,r,s);isFinite(c[2])&&isFinite(c[5])||(i.requiresDrapedElevation=!0),c&&Re(i.boundingBox,s),Hr.release(s)}),Xe(i.boundingBox)||wt(ye(i.boundingBox,Ur))?i:null}needsElevationUpdates(){for(let e of this.layers)if(e!=null&&(e.type===`object3d`||e.type===`lod-instance`)&&e.needsElevationUpdates)return!0;return this._labelLayers?.some(e=>e?.needsElevationUpdates??!1)??!1}alignWithElevation(e,t,n){this._forEachRenderedGraphic(r=>{r.type!==`object3d`&&r.type!==`lod-instance`||r.alignWithElevation(e,t,n)})}alignWithAbsoluteElevation(e,t,n){this._forEachRenderedGraphic(r=>{r.type===`object3d`&&r.alignWithAbsoluteElevation(e,t,n)})}addObjectStateSet(e){this._forEachSymbolLayerGraphic(t=>t.addObjectState(e))}removeObjectState(e){this._forEachSymbolLayerGraphic(t=>t.removeObjectState(e))}updateHighlights(e){this._forEachSymbolLayerGraphic(t=>t.updateHighlights(e))}_forEachGraphicList(e,t){e?.forEach(e=>e&&t(e))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this.labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){}};function Gr(e,t,n){let r=t===1?`hiddenIfDeconflicted`in n&&n.hiddenIfDeconflicted?0:8:256&e?0:8;n.setVisibility(Kr(e,t,r))}function Kr(e,t,n=0){let r=(t===1?15:255)&~n;return(e&r)===r}var qr=2216,Jr=4096;function Yr(e){return qr+Jr*e.symbolLayers.length+e.complexity.memory.resourceBytes}var Xr=class extends Xn{set symbol(e){this._symbol=e,e.symbolLayers.forEach((t,n)=>{let r=this.symbolLayers[n];r!=null&&(r.symbol=e,r.symbolLayer=t)})}get symbol(){return this._symbol}constructor(e,t,n){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=n,this._destroyed=!1,this.symbolLayers=[],this.referenced=0,this._extentPadding=0}async doLoad(e){let n=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(n=this._backgroundLayers.concat(n));let r=n.length;for(;this.symbolLayers.length<n.length;)this.symbolLayers.push(null);this.symbolLayers.length=n.length;let i=[];if(!Zr){let{make:e}=await t(async()=>{let{make:e}=await import(`./Graphics3DSymbolLayerFactory-xpLpso5t.js`);return{make:e}},__vite__mapDeps([26,2,3,27,28,22,6,14,7,25,4,5,29,30,31,32,20,11,16,33,34,35,21,12,13,15,36,37,19,38,39,24,40,41,42,18,43,44,45,46,47,23,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,17,71,72,73,9,10,74,75,8,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152]));Zr=e}for(let t=0;t<r;t++){let a=n.at(t);if(!1===a.enabled)continue;Qr.renderPriority=1-(1+t)/r,Qr.renderPriorityStep=1/r,Qr.ignoreDrivers=a.ignoreDrivers;let o=Zr(this.symbol,a,this._context,Qr),s=Ne(e,()=>{this.symbolLayers[t]=null,o.destroy()});s&&i.push(s),this.symbolLayers[t]=o}if(await Ot(this.symbolLayers,async(e,t)=>{if(e!=null)try{await e.load(),this._extentPadding+=Math.max(this._extentPadding,e.extentPadding)}catch{this.symbolLayers[t]=null}}),i.forEach(e=>e.remove()),w(e),this.symbolLayers.length&&!this.symbolLayers.some(e=>!!e))throw Error()}getSymbolLayerSize(e){let t=this.symbolLayers[e];return t==null?null:t.getCachedSize()}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>e?.queryForSnapping)}get needsUpdateFocus(){return this.symbolLayers.some(e=>!0===e?.needsUpdateFocus)}createGraphics3DGraphic(e,t){let{graphic:n}=e,r=this.symbolLayers.map(t=>t?.createGraphics3DGraphic(e)??null);return new Wr(n,t||this,r)}get complexity(){return ar(this.symbolLayers.map(e=>e?.complexity))}globalPropertyChanged(e,t){let n=this.symbolLayers.length;for(let r=0;r<n;r++){let n=this.symbolLayers[r];if(n!=null&&!n.globalPropertyChanged(e,t,e=>{let t=e.layers[r];return t instanceof ir?t:null}))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus===1?this.symbolLayers.reduce((n,r)=>n!==0&&r!=null?Math.min(n,r.applyRendererDiff(e,t)):n,2):0}prepareSymbolPatch(e){if(this.loadStatus===2||e.diff.type!==`partial`)return;let t=e.diff.diff;if(!t.symbolLayers||t.symbolLayers.type!==`partial`)return;let n=t.symbolLayers.diff;this.symbolLayers.forEach((t,r)=>{if(t==null)return;let i=n[r];if(i){let n={diff:i,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};t.prepareSymbolLayerPatch(n),e.symbolStatePatches.push(...n.symbolLayerStatePatches),n.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((e,t)=>{let i=e.layers[r];i!=null&&n.graphics3DGraphicPatches.forEach(e=>e(i,t))})}})}updateGeometry(e){return this._updateGeometryOrTransform(e,(t,n)=>!!t.updateGeometry&&t.updateGeometry(e.graphic,n))}updateTransform(e,t,n,r){return this._updateGeometryOrTransform(e,(e,i)=>!!e.updateTransform&&e.updateTransform(i,t,n,r))}_updateGeometryOrTransform(e,t){for(let n=0;n<this.symbolLayers.length;n++){let r=this.symbolLayers[n];if(r==null)continue;let i=e.layers[n];if(!i||!t(r,i))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){let n=this.symbolLayers[t];if(n==null)continue;let r=e.layers[t];r!=null&&n.onRemoveGraphic(r)}}getFastUpdateStatus(){let e=!1,t=!1;for(let n of this.symbolLayers)if(n!=null){if(n.loadStatus===0)return 3;n.isFastUpdatesEnabled()?t=!0:e=!0}return t?e?2:1:e?0:4}async queryForSnapping(e,t,n,r){let i=this.symbolLayers.filter(m).filter(e=>e.queryForSnapping!=null).map(i=>i.queryForSnapping(e,t,n,r)),a=await Promise.all(i);return w(r),a.flat()}destroy(){if(!this.destroyed){super.destroy();for(let e of this.symbolLayers)e?.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}get usedMemory(){return Yr(this)}},Zr=null,Qr=new Cr,$r=class extends Xr{constructor(e,t,n){super(e,t,n),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=zr(this.symbol,t))}async doLoad(e){let t=this._calloutSymbolLayer?He(this._calloutSymbolLayer.load()):null;try{await super.doLoad(e),w(e)}catch(e){throw this._calloutSymbolLayer?.abortLoad(),e}t&&await t}destroy(){super.destroy(),this._calloutSymbolLayer=A(this._calloutSymbolLayer)}createGraphics3DGraphic(e,t){let n=super.createGraphics3DGraphic(e,t);if(this._calloutSymbolLayer!=null&&n!=null){let t=this._createCalloutGraphic(e);t&&n.setCalloutGraphic(t)}return n}globalPropertyChanged(e,t){return!!super.globalPropertyChanged(e,t)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(e,t,e=>e.calloutLayer))}updateGeometry(e){let t=super.updateGeometry(e);if(t&&this._calloutSymbolLayer){let t=e.calloutLayer;if(t)return this._calloutSymbolLayer.updateGeometry?.(e.graphic,t)??!1}return t}_createCalloutGraphic(e){let t=e.renderingInfo;return e.renderingInfo=new Lr(t.renderer,t.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(e)}};function ei(e,t,n){return e.type===`point-3d`?new $r(e,t,n):new Xr(e,t,n)}var ti=class extends Xn{constructor(e,t,n){super(t),this.symbol=e,this._convert=n,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return this.graphics3DSymbol==null?null:this.graphics3DSymbol.getSymbolLayerSize(e)}get symbolLayers(){return this.graphics3DSymbol==null?[]:this.graphics3DSymbol.symbolLayers}get extentPadding(){return this.graphics3DSymbol==null?0:this.graphics3DSymbol.extentPadding}async doLoad(e){let t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),this.graphics3DSymbol!=null&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return this.graphics3DSymbol==null?null:this.graphics3DSymbol.createGraphics3DGraphic(e,this)}get complexity(){return this.graphics3DSymbol==null?sr:this.graphics3DSymbol.complexity}globalPropertyChanged(e,t){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return this.graphics3DSymbol==null?0:this.graphics3DSymbol.applyRendererDiff(e,t)}prepareSymbolPatch(e){this.graphics3DSymbol!=null&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.updateGeometry(e)}updateTransform(e,t,n,r){return this.graphics3DSymbol?.updateTransform(e,t,n,r)??!1}onRemoveGraphic(){}get needsUpdateFocus(){return!1}getFastUpdateStatus(){return this.graphics3DSymbol?.getFastUpdateStatus()??3}destroy(){this.graphics3DSymbol!=null&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}get usedMemory(){return Yr(this)}},ni=class{constructor(e,t,n,r){this.total=e,this.visible=t,this.missing=n,this.pending=r}},ri=class{constructor(e){this._graphicsCore=e,this._idToState=new Map,this._states=new Set;let t=e.owner.layer?.objectIdField;t?(this._getGraphicId=e=>M(e,t),this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicByObjectId(e)):(this._getGraphicId=e=>e.uid,this._getGraphics3DGraphicById=e=>this._graphicsCore.getGraphics3DGraphicById(e))}destroy(){this._idToState.clear(),this._states.forEach((e,t)=>this.remove(t))}add(e){let t=b(()=>this.remove(e));if(this._states.has(e))return t;let n=this._getGraphicId(e.graphic),r=this._getGraphics3DGraphicById(n);return this._states.has(e)||this._states.add(e),this._ensureStateList(n).push(e),e.displaying=r?.isVisible()??!1,e.isDraped=r?.isDraped??!1,e.tracking=!0,r!=null&&e.emit(`changed`),t}remove(e){if(this._states.has(e)){if(this._idToState.size){let t=this._getGraphicId(e.graphic),n=this._idToState.get(t);n&&(ie(n,e),n.length===0&&this._idToState.delete(t))}this._states.delete(e),e.tracking=!1,e.displaying=!1}}addGraphic(e){this._forEachState(e.graphic,t=>{t.displaying=e.isVisible(),t.isDraped=e.isDraped,t.emit(`changed`)})}removeGraphic(e){this._forEachState(e.graphic,e=>{e.displaying=!1,e.isDraped=!1})}updateGraphicGeometry(e){this._forEachState(e.graphic,e=>e.emit(`changed`))}updateGraphicVisibility(e){this._forEachState(e.graphic,t=>t.displaying=e.isVisible())}updateGraphicError(e,t){this._forEachState(e,e=>e.error=t)}allGraphicsDeleted(){this._states.forEach(e=>e.displaying=!1)}_ensureStateList(e){let t=this._idToState.get(e);if(t)return t;let n=[];return this._idToState.set(e,n),n}_forEachState(e,t){if(this._states.size===0||this._idToState.size===0)return;let n=this._getGraphicId(e);this._idToState.get(n)?.forEach(t)}},L=class extends S{constructor(e){super(e),this._index=new Jt(9,ut(`esri-csp-restrictions`)?e=>({minX:e.extent[0],minY:e.extent[1],maxX:e.extent[2],maxY:e.extent[3]}):[`.extent[0]`,`.extent[1]`,`.extent[2]`,`.extent[3]`]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(e){this._addMany(e)}destroy(){this._missing.clear(),this._index=A(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(e,t,n){t!=null&&t.equals(this.spatialReference)&&(R.minX=e[0],R.minY=e[1],R.maxX=e[2],R.maxY=e[3],this.update(),this._index.search(R,e=>n(e.graphic.uid)))}add(e){this._missing.add(e),this.updating=!0}remove(e){if(this._missing.delete(e))return void(this.updating=this._missing.size>0);if(!e.extent)return;this._index.remove(e);let t=M(e.graphic,this._get(`objectIdField`));t!=null&&this._boundsByFeature.delete(t)}_addMany(e){if(e.length===0)return;let t=this._get(`objectIdField`);for(let n of e){n.computeExtent(this.spatialReference);let e=M(n.graphic,t);e!=null&&this._boundsByFeature.set(e,n.extent)}this._index.load(e)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(e,t){R.minX=e[0],R.minY=e[1],R.maxX=e[2],R.maxY=e[3],this.update(),this._index.search(R,e=>{t(e)})}getBounds(e,t){this.update();let n=this._boundsByFeature.get(e);return n?Ge(t,n):null}};T([a({constructOnly:!0})],L.prototype,`spatialReference`,void 0),T([a({constructOnly:!0})],L.prototype,`hasZ`,void 0),T([a({constructOnly:!0})],L.prototype,`hasM`,void 0),T([a({constructOnly:!0})],L.prototype,`objectIdField`,void 0),T([a()],L.prototype,`updating`,void 0),T([a({readOnly:!0})],L.prototype,`updatingRemaining`,null),L=T([_(`esri.views.3d.layers.graphics.SpatialIndex2D`)],L);var R={minX:0,minY:0,maxX:0,maxY:0},ii=class{constructor(e=`scene`){this.context=e,this.extent=De(),this.spatialReference=null}},ai=1,oi=Symbol(`layerHandles`),z=class extends Tt{get spatialReference(){return this.view.spatialReference}constructor(e){super(e),this._elevationOffset=0}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=new Rn(this.view.state.viewingMode),this._intersector.options.store=0;let e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];let t=this.stageLayer.events;this.addHandles([t.on([`layerObjectAdded`,`layerObjectRemoved`,`transformationChanged`,`shaderTransformationChanged`],e=>this._objectChanged(e)),t.on([`geometryAdded`,`geometryRemoved`],({object:e})=>this._objectChanged(e)),t.on(`attributesChanged`,({attribute:e,object:t})=>En(e)&&this._objectChanged(t))],oi)}destroy(){this.removeHandles(oi)}elevationInfoChanged(){let e=this.layer==null?null:this.layer.elevationInfo;if(e!=null&&e.mode!==`on-the-ground`){let t=re(this.layer.spatialReference),n=Oe(e.unit??`meters`);this._elevationOffset=(e.offset??0)*n/t}else this._elevationOffset=0}getElevation(e,t,n,r){if(V[0]=e,V[1]=t,V[2]=n,!this._renderCoordsHelper.toRenderCoords(V,r,V))return k.getLogger(this).error(`could not project point for elevation alignment`),null;let i=this._elevationOffset,a=this._zmin+i,o=this._zmax+i;return this._renderCoordsHelper.setAltitude(ci,o,V),this._renderCoordsHelper.setAltitude(li,a,V),this._intersector.reset(ci,li,null),this._intersector.intersect(this._intersectLayers,null,ai,null,e=>!!e.lastValidElevationBB),this._intersector.results.min.getIntersectionPoint(V)?this._renderCoordsHelper.getAltitude(V):null}_objectChanged(e){let t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;E(B);let n=e.lastValidElevationBB;n.isEmpty()||this._expandExtent(t,n.min,n.max,B);let{min:r,max:i}=e.boundingVolumeWorldSpace;this._expandExtent(t,r,i,B),ye(B,si.extent),this._zmin=Math.min(this._zmin,B[2]),this._zmax=Math.max(this._zmax,B[5]),si.spatialReference=t,this.emit(`elevation-change`,si),si.spatialReference=null,n.assignMinMax(r,i)}_computeLayerExtent(e,t){return E(B),e!=null&&t.objects.forEach(t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,B)),B}_expandExtent(e,t,n,r){for(let i=0;i<8;++i)V[0]=1&i?t[0]:n[0],V[1]=2&i?t[1]:n[1],V[2]=4&i?t[2]:n[2],this._renderCoordsHelper.fromRenderCoords(V,V,e),Se(r,V);return r}};T([a({constructOnly:!0})],z.prototype,`layer`,void 0),T([a({constructOnly:!0})],z.prototype,`stageLayer`,void 0),T([a({constructOnly:!0})],z.prototype,`view`,void 0),T([a()],z.prototype,`spatialReference`,null),z=T([_(`esri.views.3d.layers.support.StageLayerElevationProvider`)],z);var B=E(),si=new ii,V=C(),ci=C(),li=C();function ui(e,t,n){if(e==null||n==null)return!1;let r=!0;return H[0]=e.xmin==null?0:e.xmin,H[1]=e.ymin==null?0:e.ymin,H[2]=e.zmin==null?0:e.zmin,r&&=d(H,e.spatialReference,0,H,n,0),t[0]=H[0],t[1]=H[1],H[0]=e.xmax==null?0:e.xmax,H[1]=e.ymax==null?0:e.ymax,H[2]=e.zmax==null?0:e.zmax,r&&=d(H,e.spatialReference,0,H,n,0),t[2]=H[0],t[3]=H[1],e.xmin??(t[0]=-1/0),e.ymin??(t[1]=-1/0),e.xmax??(t[2]=1/0),e.ymax??(t[3]=1/0),r}var H=C(),di=class{constructor(){this._pendingCompressionTasks=ht(0)}get compressing(){return!!this._pendingCompressionTasks.value}increment(){this._pendingCompressionTasks.value++}decrement(){this._pendingCompressionTasks.value--}},fi,pi=C(),mi=Ve(),U=class extends S{static{fi=this}static{this.tmpVec=C()}get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){return this._spatialIndex||(this._spatialIndex=new L({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get deconflictor(){return this._deconflictor}get labeler(){return this._labeler}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return this.currentRenderer!=null&&this.currentRenderer.type===`dictionary`?0:this._forcedUpdatePolicy??this.preferredUpdatePolicy}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){return!!(this.dataUpdating||this._elevationAlignment?.updating||this._scaleVisibility?.updating||this._filterVisibility?.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._frameTaskHandle.updating||this._updateQueue.updating||this.readyToRun)}get dataUpdating(){return!!(this._graphicsWaitingForSymbol.size>0||this._pendingUpdates.size>0||this._spatialIndex?.updating||this._updatingPendingLoadedGraphicsChange||this._dataUpdateQueue.updating||this._loadingSymbols>0||this.compressionTracker.compressing)}get readyToRun(){return this._pendingUpdates.size>0||!!this._spatialIndex?.updating||this._dataUpdateQueue.readyToRun||this._updateQueue.readyToRun||this._focusAreasGraphicsQueue.length>0}get suspendedOrOutsideOfView(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){let e=this.owner&&this.owner.view&&this.owner.view.qualitySettings,t=e?.graphics3D.minTotalNumberOfFeatures??0,n=e?.graphics3D.maxTotalNumberOfFeatures??0,r=e?.graphics3D.maxNumberOfDrawCalls??0,i=e?.graphics3D.maxTotalNumberOfVertices??0,a=this.averageSymbolComplexity,o=Math.max(1,a?.verticesPerFeature??1),s=a&&a.drawCallsPerFeature>0&&r>0?r/a.drawCallsPerFeature:n,c=Math.ceil(i/o),l=Math.max(t,Math.min(n,c,s)),u=this._get(`displayFeatureLimit`);return u&&u.maximumTotalNumberOfVertices===i&&u.averageSymbolComplexity===a&&u.maximumNumberOfFeatures===l?u:new _r(i,l,a)}get averageSymbolComplexity(){let e=Yn(this._symbolComplexities),t=this._get(`averageSymbolComplexity`);return e.numComplexities===0||t!=null&&(e.estimated&&(t.verticesPerFeature>=e.verticesPerFeature||t.verticesPerCoordinate>=e.verticesPerCoordinate||t.drawCallsPerFeature>=e.drawCallsPerFeature)||t.verticesPerFeature===e.verticesPerFeature&&t.verticesPerCoordinate===e.verticesPerCoordinate&&t.drawCallsPerFeature===e.drawCallsPerFeature)?t:e}get usedMemory(){let e=this.labelsEnabled?(this.averageSymbolComplexity?.memory.bytesPerFeatureLabel??0)*this._numberOfGraphics:0,t=this._getSymbolComplexitiesUsed().reduce((e,t)=>e+t.memory.resourceBytes,0);if(this._symbolMaterials==null){this._symbolMaterials=[];for(let e of this._symbols.values())if(e!=null){for(let t of e.symbolLayers)if(t)for(let e of t.materials)e&&this._symbolMaterials.push(e)}}let n=this.owner.view.stage.renderer,r=this.owner.view.overlayManager.renderer,i=this._symbolMaterials.reduce((e,t)=>e+((n.getMaterialRenderer(t)||r.getMaterialRenderer(t))?.usedMemory??0),0);return this._usedMemory+e+t+i}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){let e=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*e}if(this.averageSymbolComplexity!=null){let e=this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0;return this.averageSymbolComplexity.memory.bytesPerFeature+e}return 0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(e){let t=e;if(t.type===`web-style`)return t.clone();let n=this._symbolConversionCache.get(t.id);if(n!=null)return n;let r=g(t,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(t),cimFallbackEnabled:!0}),i=r.symbol||null;return i==null&&r.error&&k.getLogger(this).error(r.error.message),this._symbolConversionCache.set(t.id,i),i}_getSymbolComplexitiesUsedOrRenderer(e){if(e==null)return[];let t=e.symbols,n=`backgroundFillSymbol`in e?e.backgroundFillSymbol:null;if(!n&&!t.length)return[];let r=[],i=this._getSymbolComplexityUsedOrRenderer(n);i!=null&&r.push(i);for(let e of t){let t=this._getSymbolComplexityUsedOrRenderer(e);t!=null&&r.push(t)}return r}_getSymbolComplexityUsedOrRenderer(e){if(e==null)return null;let t=this._symbols.get(e.id);if(t!=null)return t.complexity;let n=this._getConvertedSymbol(e);return n==null?null:or(n)}_getSymbolComplexitiesUsed(){let e=[];return this._symbols.forEach(t=>{t!=null&&e.push(t.complexity)}),e}get _objectIdField(){return this.layer.objectIdField}constructor(e){super(e),this._propertiesPool=new oe({computedExtent:()=>new Be},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._frameTaskHandle=r,this._dataUpdateQueue=new Te,this._updateQueue=new Te,this._focusAreasGraphicsQueue=new h,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._elevationAlignment=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this.compressionTracker=new di,this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new ct,this.preferredUpdatePolicy=1,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this._unusedSymbolsCache=e.owner.view.resourceController.memoryController.newCache(`graphics-3d-unused-symbols`,e=>e.destroy()),this.symbolCreationContext=new Sr(e.owner.view.resourceController.scheduler,(e,t)=>this._updateQueue.push(e,t),e.owner.layerViewUid,this.compressionTracker)}initialize(){this._featureStore=new P({objectIdField:this.owner.layer?.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:e=>this.graphics3DGraphics.forEach(e)});let t=(e,t,n)=>this.spatialIndex.queryGraphicUIDsInExtent(e,t,n),{componentFactories:n}=this;this._elevationAlignment=n.elevationAlignment?.(this,t),this._scaleVisibility=n.scaleVisibility?.(this,t),this._filterVisibility=n.filterVisibility?.({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:e=>this.modifyGraphics3DGraphicVisibilities(t=>t.setVisibilityFlag(1,4,e(M(t.graphic,this._objectIdField)))),setAllFeaturesVisibility:e=>this.modifyGraphics3DGraphicVisibilities(t=>t.setVisibilityFlag(1,4,e)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(1,4,!0))}),this._deconflictor=n.deconflictor?.(this),this._labeler=n.labeler?.(this,this._scaleVisibility),this._objectStates=n.objectStates?.(this),this._initializeAbortController=new AbortController,this.addHandles(e(()=>this.owner.view.state.highlights,()=>{let{highlightOrderMap:e}=this.owner.view.state;this.graphics3DGraphics.forEach(t=>t.updateHighlights(e))})),this._initializePromise=this._initializeAsync()}async _initializeAsync(){let t=this._initializeAbortController?.signal,n=this.owner.view;this._viewElevationProvider=new vr(this._viewSpatialReference,n),this._initializeStage(n,this.owner.layerViewUid);let r=n.sharedSymbolResources;this.symbolCreationContext.sharedResources=r,this.currentRenderer!=null&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.renderCoordsHelper=n.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.graphicsCoreOwner=this.owner,this.symbolCreationContext.localOriginFactory=new kn(n.renderSpatialReference),this.symbolCreationContext.elevationProvider=n.elevationProvider,this.symbolCreationContext.notifyGraphicGeometryChanged=e=>this.notifyGraphicGeometryChanged(e),this.symbolCreationContext.notifyGraphicVisibilityChanged=e=>this.notifyGraphicVisibilityChanged(e);let i=Nn(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);if(this.symbolCreationContext.featureExpressionInfoContext=await An(i,this._viewSpatialReference,t,k.getLogger(this)),w(t),this.symbolCreationContext.screenSizePerspectiveEnabled=In(this.layer.screenSizePerspectiveEnabled),this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,this.symbolCreationContext.skipHighSymbolLods=!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,`drapeSourceType`in this.owner){let{owner:e}=this;this.symbolCreationContext.drapeSourceRenderer=n.overlayManager.registerGeometryDrapeSource(e)}this.addHandles([D(()=>this.suspendedOrOutsideOfView,()=>this._updateQueue.unshift(()=>this._updateLayerVisibility(),null).catch(bt)),D(()=>In(this.layer?.screenSizePerspectiveEnabled),e=>{e!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=e,this._screenSizePerspectiveEnabledChange())}),D(()=>this.owner.slicePlaneEnabled,e=>this._slicePlaneEnabledChange(!!e)),D(()=>this.owner.view.state?.rasterPixelRatio,()=>this._pixelRatioChange()),D(()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,e=>this._physicalBasedRenderingChange(e)),D(()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,e=>this._skipHighSymbolLoDsChange(e)),D(()=>this.owner.view.focusAreasView?.polygons,()=>this._updateFocusedLabels()),D(()=>this.owner.view.map?.focusAreas.style,()=>this.recreateAllGraphicsAndSymbols()),e(()=>n.basemapTerrain?.tilingScheme,e=>{e.spatialReference.equals(this.symbolCreationContext.overlaySR)||n.basemapTerrain.spatialReference==null||(this.symbolCreationContext.overlaySR=n.basemapTerrain.spatialReference),this.hasHandles(`loaded-graphics`)?this.recreateAllGraphics():this.addHandles([ve(()=>this.owner?.loadedGraphics,`change`,e=>{this._graphicsCollectionChanged(e),this._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{this.recreateAllGraphics(),this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],`loaded-graphics`)},{initial:!0}),D(()=>this.effectiveUpdatePolicy,e=>{this.stageLayer!=null&&(this.stageLayer.updatePolicy=e),this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===0,e===1&&this.runTask(p)},Ct)]),this._frameTaskHandle=n.resourceController.scheduler.registerTask(y.GRAPHICS_CORE,this),this.layer&&`featureReduction`in this.layer&&this.addHandles(D(()=>this.layer.featureReduction,()=>this._deconflictor?.featureReductionChange())),this.notifyChange(`averageSymbolComplexity`),this.rendererChange(this.owner.renderer).catch(()=>{}),this._initializeAbortController=null}_abortInitialize(){this._initializeAbortController=Ye(this._initializeAbortController)}_updateFocusedLabels(){this._focusAreasGraphicsQueue.clear(),this.forEachGraphics3DSymbol((e,t)=>{t&&e.needsUpdateFocus&&t.forEach(e=>{this._focusAreasGraphicsQueue.push(e)})})}destroy(){if(this._unusedSymbolsCache.destroy(),this._abortInitialize(),this._rendererChangeAbortController=Ye(this._rendererChangeAbortController),this._abortElevationInfoChange(),this._frameTaskHandle.remove(),this._frameTaskHandle=r,this._dataUpdateQueue.cancelAll(),this._updateQueue.cancelAll(),this._deconflictor=dt(this._deconflictor),this._labeler=dt(this._labeler),this._elevationAlignment=A(this._elevationAlignment),this._scaleVisibility=A(this._scaleVisibility),this._filterVisibility=A(this._filterVisibility),this._objectStates=A(this._objectStates),this.clear(),`drapeSourceType`in this.owner){let{owner:e}=this;this.stage.view.overlayManager.unregisterDrapeSource(e)}for(let e in this._featureStore=A(this._featureStore),this._updatingPendingLoadedGraphicsChange=dt(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=A(this._graphicStateTracking),this.stage&&=(this.stageLayer=A(this.stageLayer),null),this._set(`owner`,null),this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[e].reject(new n(`graphic:layer-destroyed`,`Layer has been destroyed`));this._whenGraphics3DGraphicRequests=null,this._propertiesPool=A(this._propertiesPool),this._whenSymbolRemoved.prune(),this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=A(this._spatialIndex),this._symbolMaterials=null}clear(){this._objectStates?.allGraphicsDeleted(),this._graphicStateTracking!=null&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach(e=>e.destroy()),this._spatialIndex?.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(A),this._symbols.clear(),this._symbolMaterials&&=(this._symbolMaterials.length=0,null),this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange(`dataUpdating`),this.notifyChange(`readyToRun`),this.notifyChange(`updatingRemaining`),this._featureStore.events.emit(`changed`),this.owner.notifyContentGeometryUpdate?.()}_initializeStage(e,t){this.stage=e.stage,this.stageLayer=new On(this.stage,{visible:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},t);let n=this.stageLayer.events;n.on(`transformationChanged`,e=>this.notifyGraphicGeometryChanged(e.graphicUid)),n.on(`shaderTransformationChanged`,e=>this.notifyGraphicGeometryChanged(e.graphicUid)),n.on(`visibilityChanged`,e=>this.notifyGraphicVisibilityChanged(e.graphicUid)),n.on(`geometryAdded`,e=>this.notifyGraphicGeometryChanged(e.object.graphicUid)),n.on(`geometryRemoved`,e=>this.notifyGraphicGeometryChanged(e.object.graphicUid)),n.on(`attributesChanged`,e=>En(e.attribute)&&this.notifyGraphicGeometryChanged(e.object.graphicUid))}notifyGraphicGeometryChanged(e){if(this.owner.notifyContentGeometryUpdate?.(),this._graphicStateTracking==null||e==null)return;let t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicGeometry(t)}notifyGraphicVisibilityChanged(e){if(this.owner.notifyContentGeometryUpdate?.(),this._graphicStateTracking==null||e==null)return;let t=this.graphics3DGraphics.get(e);t&&this._graphicStateTracking.updateGraphicVisibility(t)}_updateLayerVisibility(){let e=this.displayFeatureLimit.maximumNumberOfFeatures,t=this._numberOfGraphics>e*gi,n=!this.suspendedOrOutsideOfView&&!t;n!==this._visible&&(this._visible=n,this._updateStageLayerVisibility())}_updateStageLayerVisibility(){let e=this._visible&&(this.layer.opacity==null||this.layer.opacity>=.003913894324853229);this.stageLayer.visible!==e&&(this.stageLayer.visible=e,e?this.updateGraphicsVisibilities():this._hideAllGraphics(),this.owner.notifyContentGeometryUpdate?.())}getGraphics3DGraphicById(e){return e==null?void 0:this.graphics3DGraphics.get(e)}getGraphics3DGraphicByObjectId(e){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(e):null}_getGraphicObjectID(e,t=this.owner.layer?.objectIdField){return M(e,t)}get graphics3DGraphicsByObjectID(){let e=this.owner.layer?.objectIdField;if(!e)return;let t=new Map;return this.graphics3DGraphics.forEach(n=>{if(!n)return;let r=n.graphic,i=this._getGraphicObjectID(r,e);i!=null&&t.set(i,n)}),t}get labelsEnabled(){return!!this._labeler?.layerLabelsEnabled()}async updateLabelingInfo(e){let t=this._deconflictor?.labelingInfoChange(e),n=this._labeler?.labelingInfoChange(e);await Promise.allSettled([t,n])}updateVisibilityInfo(){this._deconflictor?.labelingInfoChange(),this._labeler?.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return`unknown`;let e=!1,t=!1;for(let[n,r]of this._symbols)if(r!=null)switch(r.getFastUpdateStatus()){case 3:return`unknown`;case 1:this._graphicsBySymbol.has(n)&&(t=!0);break;case 0:this._graphicsBySymbol.has(n)&&(e=!0);break;case 2:this._graphicsBySymbol.has(n)&&(t=e=!0)}return t?e?`mixed`:`fast`:e?`slow`:`mixed`}runTask(e){if(this._dataUpdateQueue.runTask(e),this._updateQueue.runTask(e),this._applyPendingUpdates(e),this._applyFocusAreasUpdates(e),this.notifyChange(`readyToRun`),this.readyToRun||this.notifyChange(`dataUpdating`),this.notifyChange(`updatingRemaining`),!e.hasProgressed)return je}setObjectIdVisibility(e,t){t?this._objectIdInvisibleSet.delete(e):this._objectIdInvisibleSet.add(e);let n=this._findGraphics3DGraphicByObjectId(e);n!=null&&this._updateUserVisibility(n)}_findGraphics3DGraphicByObjectId(e){return it(this.graphics3DGraphics,t=>this._getGraphicObjectID(t.graphic)===e)}_updateUserVisibility(e){if(e==null)return!1;let t=e.graphic,n=this._getGraphicObjectID(t),r=t.visible&&!this.owner.suspended&&this.stageLayer.visible&&(n==null||!this._objectIdInvisibleSet.has(n));return e.setVisibilityFlag(1,1,r)}_whenGraphics3DGraphic(e){let t=this.graphics3DGraphics.get(e.uid);if(t)return Promise.resolve(t);let n=this._whenGraphics3DGraphicRequests[e.uid];if(n)return n.promise;let r=ce();return this._whenGraphics3DGraphicRequests[e.uid]=r,r.promise}async _boundsForGraphics3DGraphic(e,t){let n=this._viewSpatialReference,r=this.owner.view.renderSpatialReference,i=this.owner.view.basemapTerrain.spatialReference,a=(e,t,i)=>d(e,r,t,e,n,t,i),o=(e,t,r)=>d(e,i,t,e,n,t,r),s=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:t!=null&&!!t.useViewElevation,minDemResolution:t==null?null:t.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,c=await e.getProjectedBoundingBox(a,o,s,t?.signal);if(!c)return null;let l=c.boundingBox;if(c.requiresDrapedElevation){let e=this.symbolCreationContext.elevationProvider;if(e){we(l,pi);let t=e.getElevation(pi[0],pi[1],0,n,`ground`)??0;l[2]=Math.min(l[2],t),l[5]=Math.max(l[5],t)}}return{boundingBox:l,screenSpaceObjects:c.screenSpaceObjects}}async whenGraphicBounds(e,t){await Et(()=>this.owner?.loadedGraphics);let r=this.owner.layer?.objectIdField,i=this.owner.loadedGraphics.find(t=>t===e||r!=null&&t.attributes!=null&&e.attributes&&t.attributes[r]===e.attributes[r]);if(!i)throw new n(`internal:graphic-not-part-of-view`,`Graphic is not part of this view`);let a=await this._whenGraphics3DGraphic(i);return this._boundsForGraphics3DGraphic(a,t)}computeAttachmentOrigin(e,t){let n=this.graphics3DGraphics.get(e.uid);if(!n)return null;let r=n.computeAttachmentOrigin();if(r.render.num===0&&r.draped.num===0)return null;v(W,0,0,0);let a=0;if(r.render.num>0){if(!Xt(r.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,G,t))return null;de(W,W,G),a++}if(r.draped.num>0){let[e,n]=r.draped.origin,i=this._viewElevationProvider.getElevation(e,n,`ground`)??0;if(v(G,e,n,i),!Xt(G,this._viewElevationProvider.spatialReference,G,t))return null;de(W,W,G),a++}return a>1&&i(W,W,1/a),new mt({x:W[0],y:W[1],z:W[2],spatialReference:t})}getSymbolLayerSize(e,t){let r=this._symbols.get(e.id);if(r==null)throw new n(`internal:symbol-not-part-of-view`,`Symbol is not part of this view`);let i=e.symbolLayers.indexOf(t);if(i===-1)throw new n(`internal:missing-symbol-layer`,`Symbol layer is not in symbol`);let a=r.getSymbolLayerSize(i);if(a==null)throw new n(`internal:missing-size`,`Symbol layer has no valid size`);return a}_graphicsCollectionChanged(e){this._startCreateGraphics&&(this.add(e.added),this.remove(e.removed))}graphicUpdateHandler(e){let t=e.graphic.uid,n=this.graphics3DGraphics.get(t);if(n!=null||this._graphicsWithoutSymbol.get(t)!=null){switch(e.property){case`visible`:this._graphicUpdateVisibleHandler(n);break;case`geometry`:this._graphicUpdateGeometryHandler(n,e.graphic);break;case`symbol`:this._graphicUpdateSymbolHandler(n,e);break;case`attributes`:this.symbolCreationContext.featureExpressionInfoContext?.arcade&&this._graphicUpdateGeometryHandler(n,e.graphic);break;case`popupTemplate`:break;case`origin-transform`:this._graphicUpdateTransformHandler(n,e)}this.owner.notifyContentGeometryUpdate?.()}}_graphicUpdateGeometryHandler(e,t){this._graphicUpdateGeometryOrTransformHandler(e,t,()=>!(e==null||!e.graphics3DSymbol.updateGeometry(e)||!(this._labeler?.updateGraphicGeometry(e)??1))&&(this._labeler?.setDirty(),!0));let n=t.geometry;n!=null&&this._expandComputedExtent(n)}_graphicUpdateTransformHandler(e,t){let n=t.graphic.geometry;this._graphicUpdateGeometryOrTransformHandler(e,t.graphic,()=>t.newValue!=null&&e!=null&&n!=null&&e.graphics3DSymbol.updateTransform(e,n.spatialReference,t.newValue,t.action))}_graphicUpdateGeometryOrTransformHandler(e,t,n){if(t.geometry!=null){if(e==null){let e=t.symbol?.id;if(e){let t=this._symbols.get(e);if(t!=null&&t.loadStatus===0)return}this._recreateGraphic(t);return}n()||this._recreateGraphic(e.graphic)}else this._recreateGraphic(t)}_graphicUpdateSymbolHandler(e,t){let n=t.graphic,r=e==null?t.oldValue==null?null:this._symbols.get(t.oldValue.id):e.graphics3DSymbol;if(r==null||t.newValue==null)return void this._recreateGraphic(n);let i=r.symbol,a=this._getConvertedSymbol(t.newValue);if(a!=null&&(a.type!==i.type||a.type===`web-style`)||i.type===`web-style`)return void this._recreateGraphic(n);let o=this._graphicsBySymbol.get(i.id);if(o&&o.size!==1)return void this._recreateGraphic(n);let s=ke(i,a);if(s==null)return void this._updateSymbolMapping(i.id,a);let c={diff:s,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(r.prepareSymbolPatch(c),!Pt(c.diff))return void this._recreateGraphic(n);let l=this._getRenderingInfo(n,!1);if(l==null)return void this._recreateGraphic(n);let u=r.extentPadding;for(let e of c.symbolStatePatches)e();if(u!==r.extentPadding&&this._recomputeExtentPadding(),e!=null)for(let t of c.graphics3DGraphicPatches)t(e,l);this._updateSymbolMapping(i.id,a)}_graphicUpdateVisibleHandler(e){this._updateUserVisibility(e)&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}recreateGraphics(e){this._suspendSymbolCleanup=!0,this.remove(e),this.add(e),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===1&&this._cleanupSymbols()}_recreateGraphic(e){this.recreateGraphics([e])}_beginGraphicUpdate(e){let t=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(e.uid,t),this._graphicsWaitingForSymbol.size===1&&this.notifyChange(`dataUpdating`),t}_endGraphicUpdate(e,t){e&&(t&&this._graphicStateTracking?.updateGraphicError(e,t),this._graphicsWaitingForSymbol.delete(e.uid),this._graphicsWaitingForSymbol.size===0&&(this._cleanupSymbols(),this.notifyChange(`dataUpdating`)))}_recomputeExtentPadding(){let e=0;this._symbols.forEach(t=>{t!=null&&(e=Math.max(e,t.extentPadding))}),this._set(`extentPadding`,e)}_expandComputedExtent(e){let t=mi,n=e.spatialReference;fn(e,t);let r=this._viewSpatialReference,i=fi.tmpVec;if(Le(n,r)||Ae(t[0],t[1],0,n,i,r)&&(t[0]=i[0],t[1]=i[1],Ae(t[3],t[4],0,n,i,r),t[3]=i[0],t[4]=i[1]),!(isFinite(t[0])&&isFinite(t[3])&&isFinite(t[1])&&isFinite(t[4])))return;let a=this.computedExtent,o=null,s=isFinite(t[2])&&isFinite(t[5]),c=s&&(a?.zmin==null||t[2]<a.zmin),l=s&&(a?.zmax==null||t[5]>a.zmax);a?(t[0]<a.xmin||t[1]<a.ymin||t[3]>a.xmax||t[4]>a.ymax||c||l)&&(o=this._propertiesPool.get(`computedExtent`),o.xmin=Math.min(t[0],a.xmin),o.ymin=Math.min(t[1],a.ymin),o.xmax=Math.max(t[3],a.xmax),o.ymax=Math.max(t[4],a.ymax),o.spatialReference=r):(o=this._propertiesPool.get(`computedExtent`),o.xmin=t[0],o.ymin=t[1],o.xmax=t[3],o.ymax=t[4],o.spatialReference=r),o&&(c&&(o.zmin=t[2]),l&&(o.zmax=t[5]),this._set(`computedExtent`,o))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&=(this._elevationInfoChangeAbortController.abort(),null)}async elevationInfoChange(){this._abortElevationInfoChange();let e=new AbortController;this._elevationInfoChangeAbortController=e;let t=Nn(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=await An(t,this._viewSpatialReference,e.signal,k.getLogger(this)),w(e.signal),this._elevationInfoChangeAbortController=null,this._labeler?.elevationInfoChange(),this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`elevationInfo`,t)?t?.forEach(e=>{let t=e.graphic,n=e.labelLayers;for(let e of n)e.graphics3DSymbolLayer.graphics3DGraphicLayerElevationInfoChanged(t,e)}):this._recreateSymbol(n)}),this.updateStageLayerElevationProvider(),this._elevationAlignment?.elevationInfoChange()}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?this.layer.elevationInfo?.mode!==`relative-to-scene`&&this._numberOfGraphicsProvidingElevation!==0||(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=A(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&this.layer.elevationInfo.mode!==`relative-to-scene`)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new z({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register(2,this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){this.clear(),this._filterVisibility!=null&&this._filterVisibility.clear(),this._labeler?.reset(),this._deconflictor?.clear(),this._elevationAlignment?.clear(),this.stageLayer?.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&=(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),A(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(e=!1){if(!this._startCreateGraphics)return;let{loadedGraphics:t,view:n}=this.owner,r=n.basemapTerrain?.tilingScheme&&t?.length?t.toArray():null;!e&&r||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=In(this.layer.screenSizePerspectiveEnabled),this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set(`computedExtent`,null),r&&(e?this.add(r):this.recreateGraphics(r))}_recreateSymbol(e){let t=this._graphicsBySymbol.get(e),n=[];t&&(t.forEach((e,t)=>{let r=e.usedMemory;this._conditionalRemove(e,t),this._spatialIndex?.remove(e),n.push(e.graphic),e.destroy(),this._removeGraphics3DGraphic(t,r),this._updateLayerVisibility(),this._featureStore.events.emit(`changed`),this.owner.notifyContentGeometryUpdate?.()}),this._graphicsBySymbol.set(e,new Map));let r=this._symbols.get(e);A(r),this._symbols.delete(e),this._symbolMaterials=null,A(this._unusedSymbolsCache.pop(e)),this.add(n)}_recreateGraphicsForSymbol(e){let t=this._graphicsBySymbol.get(e);if(t){let e=[];t.forEach(t=>e.push(t.graphic)),this.recreateGraphics(e)}}_conditionalRemove(e,t){this._graphicsDrapedUids.delete(t),this._objectStates?.removeGraphic(e),this._labeler?.removeGraphic(e),this._deconflictor?.removeGraphic(e),this._graphicStateTracking!=null&&this._graphicStateTracking.removeGraphic(e)}add(e){e&&e.length!==0&&(this.owner.view.basemapTerrain?.tilingScheme?(this._updatePolicyForGraphics(e)===0?this._addDelayed(e):this._addImmediate(e),this.notifyChange(`dataUpdating`)):k.getLogger(this).error(`#add()`,`Cannot add graphics before terrain surface has been initialized`))}_updatePolicyForGraphics(e){if(this.effectiveUpdatePolicy===1&&(this.layer.geometryType===`mesh`||this.layer.geometryType==null)){for(let t of e)if(t.geometry!=null&&t.geometry.type===`mesh`&&!t.geometry.loaded)return 0}return this.effectiveUpdatePolicy}_addImmediate(e){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(let t of e)this._addGraphic(t,this._getRenderingInfo(t),1);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_addDelayed(e){for(let t of e){let e=t.uid,n=this._pendingUpdates.get(e);n?n.add?n.state!==0&&n.abortController?.abort():this._pendingAdds++:(n=new hi,this._pendingAdds++,this._pendingUpdates.set(e,n)),n.add=t}this.notifyChange(`readyToRun`),this.notifyChange(`updatingRemaining`),this.notifyChange(`dataUpdating`)}remove(e){this.effectiveUpdatePolicy===0?this._removeDelayed(e):this._removeImmediate(e),this.notifyChange(`dataUpdating`)}_removeImmediate(e){for(let t of e)this._removeGraphic(t);this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_removeDelayed(e){for(let t of e){let e=t.uid,n=this._pendingUpdates.get(e);if(n)n.add&&(n.remove?n.add=null:this._pendingUpdates.delete(e),n.state===1&&n.abortController?.abort(),this._pendingAdds--);else{let n=new hi;n.remove=t,this._pendingUpdates.set(e,n),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}this._pendingUpdates.size===0&&this._finishPendingUpdates(),this.notifyChange(`readyToRun`),this.notifyChange(`updatingRemaining`),this.notifyChange(`dataUpdating`)}_finishPendingUpdates(){this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&k.getLogger(this).warn(`pendingAdds/Removes in inconsistent state!`),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyFocusAreasUpdates(e){for(;this._focusAreasGraphicsQueue.length>0&&!e.done;){e.madeProgress();let t=this._focusAreasGraphicsQueue.pop(),n=rr(t.graphic.geometry);if(n==null)continue;let r=this.stage.view.focusAreasView?.containsGeometry(n)??!0;t.layers.forEach(e=>{e.stageObject&&e.stageObject.geometries.some(e=>e.material instanceof Un&&e.material.parameters.isFocused!==r)&&this.recreateGraphics([t.graphic])})}this._focusAreasGraphicsQueue.length===0&&this.notifyChange(`readyToRun`)}_applyPendingUpdates(e){if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,this._pendingUpdates.size===0&&this._spatialIndex?.updating)return this._spatialIndex.update(),void e.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(let[t,n]of this._pendingUpdates){if(e.done){this._applyPendingRemovesFirst=!0;break}if(n.remove&&!n.add&&(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(n.remove),n.remove=null,this._pendingUpdates.delete(t),this._pendingRemoves===0))break}}for(let[t,n]of this._pendingUpdates){if(e.done)break;n.add&&n.state===0&&this._processPendingUpdateNew(n);let r=this.effectiveUpdatePolicy;if(!n.remove||n.add&&n.state!==2||(this._pendingRemoves--,e.madeProgress(),this._removeGraphic(n.remove),n.remove=null,r=1),n.add)switch(n.state){case 2:this._addGraphic(n.add,n.renderingInfo,r),n.add=null,this._pendingAdds--,e.madeProgress();break;case 3:n.add=null,this._pendingAdds--}n.remove==null&&n.add==null&&this._pendingUpdates.delete(t)}this._pendingUpdates.size===0&&(this._finishPendingUpdates(),this.notifyChange(`readyToRun`),this.notifyChange(`dataUpdating`))}_processPendingUpdateNew(e){if(!e.add)return void(e.state=2);let t=e.add.geometry;t==null||t.type!==`mesh`||t.loaded?this._processPendingUpdateNewRenderingInfo(e):this._processPendingUpdateNewMesh(e,t)}async _processPendingUpdateNewMesh(e,t){e.state=1,e.abortController=new AbortController;let n=e.abortController.signal;try{await t.load({signal:n})}catch(t){return this._processPendingUpdateNewError(e,t)}e.abortController=null,this._processPendingUpdateNewRenderingInfo(e)}_processPendingUpdateNewError(e,t){e.abortController=null,_t(t)?e.state=0:e.state=3}async _processPendingUpdateNewRenderingInfo(e){if(this.layer.renderer==null||this.layer.renderer.type!==`dictionary`)return e.renderingInfo=this._getRenderingInfo(e.add),void(e.state=2);e.state=1,e.abortController=new AbortController;let t=null;try{t=await this._getRenderingInfoAsync(e.add,{signal:e.abortController.signal})}catch(t){e.abortController=null,_t(t)?e.state=0:e.state=3;return}t?.symbol==null?(this._symbolWarningLogged||(this._symbolWarningLogged=!0,k.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),e.renderingInfo=null):e.renderingInfo=t,e.state=2}_addGraphic(e,t,n){if(this._graphicsWithoutSymbol.set(e.uid,e),t?.symbol==null||!mn(e))return;let r=this.stage.renderView.olidRenderHelper;if(r&&this.setUidToIdOnAdd){let t=ot(this.owner.view,this.owner.layerViewUid);r.setUidToObjectAndLayerId(e.objectId,e.uid,this.layer.id,this.owner.layerViewUid,Me(this.layer)&&!!this.layer.popupEnabled&&!t&&rn(this.layer,this.owner.view.popup?.defaultPopupTemplateEnabled))}let i=t.symbol,a=this.getOrCreateGraphics3DSymbol(i,t.renderer);if(a==null)return;this._expandComputedExtent(e.geometry);let o=this._beginGraphicUpdate(e),s=new xr(e,t,this.layer),c=!1,l=e=>{e===a.symbol.id&&(c=!0)};this._whenSymbolRemoved.push(l);let u=()=>{if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(l),this._graphicsWaitingForSymbol.get(e.uid)!==o||c||a.destroyed||this.graphicSymbolSupported&&e.symbol&&e.symbol.id!==a.symbol.id)--a.referenced,this._cleanupSymbols();else{let t=this._createGraphics3DGraphic(a,s);this._spatialIndex&&t!=null&&this._spatialIndex.add(t),--a.referenced,this._endGraphicUpdate(e)}this._featureStore.events.emit(`changed`),this.owner.notifyContentGeometryUpdate?.(),this._labeler?.setDirty()}},d=t=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(l),c||(_t(t)?this.add([e]):a.destroyed||this._endGraphicUpdate(e,t)))};++this._loadingSymbols,n===0?a.load(()=>this._dataUpdateQueue.push(u,null).catch(bt),e=>this._dataUpdateQueue.push(()=>d(e),null).catch(bt)):a.load(u,d)}_removeGraphic(e){let t=e.uid,n=this.graphics3DGraphics.get(t);if(n){n.graphics3DSymbol.onRemoveGraphic(n);let e=n.usedMemory,r=n.isElevationSource;this._conditionalRemove(n,t),this._spatialIndex?.remove(n);let i=n.graphics3DSymbol.symbol.id;this._graphicsBySymbol.get(i)?.delete(t),this._graphicsWithoutSymbol.delete(t),this._removeGraphics3DGraphic(t,e,r),n.destroy(),this._featureStore.events.emit(`changed`),this.owner.notifyContentGeometryUpdate?.()}else this._graphicsWithoutSymbol.delete(t),this._graphicsWaitingForSymbol.delete(t),this._graphicsWaitingForSymbol.size===0&&(this._cleanupSymbols(),this.notifyChange(`dataUpdating`))}_hasLabelingContext(e){if(e instanceof ue||e instanceof s){let t=this.symbolCreationContext.layer;return!!t.labelingInfo&&t.labelingInfo.some(t=>t.symbol===e)}return!1}_hasValidSymbolCreationContext(e){return!(e instanceof ue&&!this._hasLabelingContext(e))||(k.getLogger(this).error(`LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported.`),!1)}_getRenderingInfo(e,t=!0){let n=e.geometry;if(n==null)return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,k.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!me(n.spatialReference,this._viewSpatialReference))return t&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,k.getLogger(this).warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&e.symbol!=null)return t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,k.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;let r=this.rendererHasGeometryOperations?ln(e,this.layer,null):e,i;if(this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||this.currentRenderer!=null))i=this.owner.getRenderingInfo(r,this.currentRenderer,this._arcadeOnDemand);else{let e=r.symbol||gt(r.geometry);i=new Jn(null,e)}return i?.symbol==null?(t&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,k.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):i}_getRenderingInfoAsync(e,t){if(e.geometry==null)return this._geometryWarningLogged||(this._geometryWarningLogged=!0,k.getLogger(this).warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&e.symbol!=null)return this._symbolWarningLogged||(this._symbolWarningLogged=!0,k.getLogger(this).warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;let n=this.rendererHasGeometryOperations?ln(e,this.layer,null):e;return this.owner.getRenderingInfoAsync(n,this.currentRenderer,this._arcadeOnDemand,t)}_createGraphics3DSymbol(e,t){if(!this._hasValidSymbolCreationContext(e))return null;let n=this._getConvertedSymbol(e);if(!n)return null;let r;if(t!=null&&`backgroundFillSymbol`in t&&t.backgroundFillSymbol){let e=g(t.backgroundFillSymbol,{ignoreDrivers:!0});e.symbol!=null&&(r=e.symbol.symbolLayers)}let i=ei(n,this.symbolCreationContext,r);return i.load(()=>{let e=i.extentPadding;e>this.extentPadding&&this._set(`extentPadding`,e),this.notifyChange(`averageSymbolComplexity`)},()=>{}),i}getOrCreateGraphics3DSymbol(e,t){let n=this._symbols.get(e.id);return n===void 0&&(n=this._unusedSymbolsCache.pop(e.id)??(e instanceof Ce?new ti(e,e=>this._dataUpdateQueue.push(e,null),e=>this._createGraphics3DSymbol(e,t)):this._createGraphics3DSymbol(e,t)),this._symbols.set(e.id,n),this._symbolMaterials=null),n!=null&&++n.referenced,n}trackGraphicState(e){return this._graphicStateTracking??=new ri(this),this._graphicStateTracking.add(e)}_addGraphics3DGraphic(e){this._usedMemory+=e.usedMemory,this.graphics3DGraphics.set(e.graphic.uid,e),this._numberOfGraphics++,e.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(e,t,n=!1){this._usedMemory-=t,this.graphics3DGraphics.delete(e),this._numberOfGraphics--,n&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(e,t){let{graphic:n}=t;if(this._graphicsWithoutSymbol.delete(n.uid),!this._symbols.has(e.symbol.id))return this.add([n]),null;if(this.graphics3DGraphics.has(n.uid))return null;let r=e.createGraphics3DGraphic(t);if(r==null)return null;this._addGraphics3DGraphic(r);let i=e.symbol.id;if(this._graphicsBySymbol.has(i)||this._graphicsBySymbol.set(i,new Map),this._graphicsBySymbol.get(i).set(n.uid,r),r.isDraped&&this._graphicsDrapedUids.add(n.uid),r.centroid=null,n.geometry!=null&&n.geometry.type!==`point`&&(r.centroid=Hn(n.geometry,this._viewSpatialReference)),this._updateUserVisibility(r),this._scaleVisibility!=null&&this._scaleVisibility.updateVisibility(r),this._filterVisibility!=null){let{defaultVisibility:e}=this._filterVisibility;r.setVisibilityFlag(1,4,e),e||this._filterVisibility.reapply()}this._deconflictor?.addGraphic(r),this._labeler?.addGraphic(r),this._objectStates?.addGraphic(r),r.initialize(this.stageLayer),this._graphicStateTracking!=null&&this._graphicStateTracking.addGraphic(r);let a=this._whenGraphics3DGraphicRequests[n.uid];return a&&(delete this._whenGraphics3DGraphicRequests[n.uid],a.resolve(r)),this._symbolMaterials=null,r}async rendererChange(e){if(this._rendererChangeAbortController=Ye(this._rendererChangeAbortController),e!==this.currentRenderer)if(this._validateRenderer(e),e??this._currentRendererChange(null,!1),dr(e))if(e?.arcadeRequired){let t=new AbortController;this._rendererChangeAbortController=t;let{arcadeUtils:n}=await this._ensureArcade();w(t);let r=n.hasGeometryOperations(e);r&&(await n.enableGeometryOperations(),w(t)),this.effectiveUpdatePolicy===0?await this._updateQueue.push(()=>this._currentRendererChange(e,r),t.signal):this._currentRendererChange(e,r),this._rendererChangeAbortController=null}else if(this.effectiveUpdatePolicy===0){let t=new AbortController;this._rendererChangeAbortController=t,await this._updateQueue.push(()=>this._currentRendererChange(e,!1),t.signal),this._rendererChangeAbortController=null}else this._currentRendererChange(e,!1);else this._currentRendererChange(e,!1)}async _ensureArcade(){return this._arcadeOnDemand??=await Ee(),this._arcadeOnDemand}_currentRendererChange(e,t){this.currentRenderer=e,this.rendererHasGeometryOperations=t,this.symbolCreationContext.arcade=this._arcadeOnDemand;let n=this.symbolCreationContext.renderer;if(e===n)return;if(this._symbolConversionCache.clear(),this._unusedSymbolsCache.clear(),e==null)return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();let r=ke(n,e);this._updateUnchangedSymbolMappings(r,e,n),this.symbolCreationContext.renderer=e,r!=null&&(r.type===`complete`?this.recreateAllGraphicsAndSymbols():r.type===`partial`&&(this._applyRendererDiff(r,e,n)?this._labeler?.reset():this.recreateAllGraphicsAndSymbols()),this.notifyChange(`averageSymbolComplexity`))}_diffHasSymbolChange(e){for(let t in e.diff)switch(t){case`visualVariables`:case`defaultSymbol`:case`uniqueValueInfos`:break;case`uniqueValueGroups`:case`authoringInfo`:case`fieldDelimiter`:delete e.diff[t];break;default:return!0}return!1}_applySymbolSetDiff(e,t,n){e||=[],t||=[];let r=[];for(let i of t){let t=this._graphicsBySymbol.get(i.id);t&&t.forEach((a,s)=>{let c=a.graphic,l=this.layer instanceof o?this.layer:null,u=this._arcadeOnDemand;if(i===n.defaultSymbol&&n.getSymbol(ln(c,l,null),{arcade:u})===n.defaultSymbol)return;let d=a.usedMemory;e.length||n.defaultSymbol?r.push(c):this._graphicsWithoutSymbol.set(s,c);let f=this.graphics3DGraphics.get(s);this._conditionalRemove(f,s),a.destroy(),t.delete(s),this._removeGraphics3DGraphic(s,d),this._updateLayerVisibility()}),this._whenSymbolRemoved.forAll(e=>e(i.id))}(e.length||r.length)&&(this._graphicsWithoutSymbol.forEach(e=>r.push(e)),this._graphicsWithoutSymbol.clear(),this.add(r)),this._cleanupSymbols(),this._labeler?.setDirty(),this._deconflictor?.setDirty()}_applyUniqueValueRendererDiff(e,t,n){let r=e.diff.defaultSymbol,i=e.diff.uniqueValueInfos;if(r||i){let a=i?.changed,o=i?.unchanged;if(a&&o&&a.some(e=>o.some(t=>t.oldValue.symbol?.id===e.oldValue.symbol?.id)))return!1;let s=i?i.added.map(e=>e.symbol).filter(m):[],c=i?i.removed.map(e=>e.symbol).filter(m):[];if(a)for(let e=0;e<a.length;e++)s.push(a[e].newValue.symbol),c.push(a[e].oldValue.symbol);return r?(n.defaultSymbol&&c.push(n.defaultSymbol),t.defaultSymbol&&s.push(t.defaultSymbol)):n.defaultSymbol&&s.length&&c.push(t.defaultSymbol),this._applySymbolSetDiff(s,c,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(e,t,n){if(t?.type!==`unique-value`||n?.type!==`unique-value`||e!=null&&e.type!==`partial`)return[];let r=e=>e==null?null:e.id,i=e&&e.diff,a=i?.defaultSymbol,o=i&&i.uniqueValueInfos,s;if(o)s=o.unchanged.map(e=>({oldId:r(e.oldValue.symbol),newId:r(e.newValue.symbol)}));else{s=[];for(let e of n.uniqueValueInfos??[]){let n=r(e.symbol),i=t.uniqueValueInfos?.find(t=>t.value===e.value);i&&n!==r(i.symbol)&&s.push({oldId:n,newId:r(i.symbol)})}}return!a&&n.defaultSymbol&&s.push({oldId:r(n.defaultSymbol),newId:r(t.defaultSymbol)}),s}_updateSymbolMapping(e,t){let n=t!=null&&t?typeof t==`string`?t:t.id:null;if(e==null||e===n)return;let r=this._graphicsBySymbol.get(e);this._graphicsBySymbol.delete(e),r!==void 0&&this._graphicsBySymbol.set(n,r);let i=this._symbols.get(e);if(i!==void 0&&(this._symbols.delete(e),this._symbols.set(n,i),this._symbolMaterials=null,i!=null)){let e=typeof t==`string`?null:t;e==null?i.symbol.id=n:i.symbol=e}}_updateUnchangedSymbolMappings(e,t,n){let r=this._calculateUnchangedSymbolMapping(e,t,n);for(let{oldId:e,newId:t}of r)this._updateSymbolMapping(e,t)}_applyRendererDiff(e,t,n){if(this._diffHasSymbolChange(e))return!1;if(t instanceof tt&&n instanceof tt&&this._applyUniqueValueRendererDiff(e,t,n)&&Object.keys(e.diff).length===0)return!0;for(let n of this._graphicsBySymbol.keys()){let r=this._symbols.get(n);if(r!=null)switch(r.applyRendererDiff(e,t)){case 0:this._recreateSymbol(n);break;case 1:this._recreateGraphicsForSymbol(n)}}return!0}opacityChange(){this._updateStageLayerVisibility(),this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged(`opacity`,t))}_screenSizePerspectiveEnabledChange(){this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged(`screenSizePerspectiveEnabled`,t)),this._labeler?.screenSizePerspectiveEnabledChanged(),this._deconflictor?.screenSizePerspectiveEnabledChanged()}_slicePlaneEnabledChange(e){e!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=e,this.stageLayer.sliceable=e,this.forEachGraphics3DSymbol((e,t)=>e.globalPropertyChanged(`slicePlaneEnabled`,t)),this._deconflictor?.slicePlaneEnabledChange(),this._labeler?.slicePlaneEnabledChange())}_physicalBasedRenderingChange(e){this.symbolCreationContext.physicalBasedRenderingEnabled=e,this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`physicalBasedRenderingEnabled`,t)||this._recreateSymbol(n)})}_skipHighSymbolLoDsChange(e){this.symbolCreationContext.skipHighSymbolLods=e,this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`skipHighSymbolLods`,t)||this._recreateSymbol(n)})}_pixelRatioChange(){this.forEachGraphics3DSymbol((e,t,n)=>{e.globalPropertyChanged(`pixelRatio`,t)||this._recreateSymbol(n)})}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=he(()=>{this._updatingPendingLoadedGraphicsChange=null})}setClippingExtent(e,t){let n=this.symbolCreationContext.clippingExtent,r=O();return ui(e,r,t)?this.symbolCreationContext.clippingExtent=Ge(Ve(),r):this.symbolCreationContext.clippingExtent=null,!Ze(this.symbolCreationContext.clippingExtent,n)}modifyGraphics3DGraphicVisibilities(e){if(this.destroyed)return;let t=!1;this.graphics3DGraphics.forEach(n=>{e(n)&&(t=!0)}),t&&(this._labeler?.setDirty(),this._deconflictor?.setDirty())}forEachGraphics3DSymbol(e,t){for(let[t,n]of this._symbols){if(n==null)return;e(n,this._graphicsBySymbol.get(t)||_i,t)}if(!t?.excludeUnused)for(let t of this._unusedSymbolsCache)e(t,void 0,t.symbol.id)}updateGraphicsVisibilities(){this._filterVisibility!=null&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities(e=>{let t=this._updateUserVisibility(e),n=!!this._scaleVisibility?.updateVisibility(e);return t||n})}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(1,1,!1))}_validateRenderer(e){let t=()=>`'${this.layer.title?`${this.layer.title}, `:``}id:${this.layer.id}'`,n=fr(e,{geometryType:this.layer?.geometryType,logWarning:(e,n)=>k.getLogger(this).warn(e,`Symbology conversion for layer ${t()}: ${n}`)});if(n){let e=`Renderer for layer ${t} is not supported in a SceneView`;k.getLogger(this).warn(e,n.message)}}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let e=!1;this._symbols.forEach((t,n)=>{if(t==null||t.referenced>0)return;let r=this._graphicsBySymbol.get(n);r&&r.size!==0||(this._graphicsBySymbol.delete(n),this._symbols.delete(n),this._symbolMaterials=null,this._unusedSymbolsCache.put(n,t,-3),e=!0)}),e&&(this._recomputeExtentPadding(),this.notifyChange(`averageSymbolComplexity`))}get test(){}get performanceInfo(){return new ni(this.graphics3DGraphics.size,Array.from(this.graphics3DGraphics.values()).reduce((e,t)=>e+(t.isVisible()?1:0),0),this._graphicsWithoutSymbol.size,this._pendingUpdates.size)}};T([a({readOnly:!0})],U.prototype,`computedExtent`,void 0),T([a()],U.prototype,`currentRenderer`,void 0),T([a()],U.prototype,`rendererHasGeometryOperations`,void 0),T([a()],U.prototype,`_frameTaskHandle`,void 0),T([a()],U.prototype,`_dataUpdateQueue`,void 0),T([a()],U.prototype,`_updateQueue`,void 0),T([a({readOnly:!0})],U.prototype,`_viewSpatialReference`,null),T([a()],U.prototype,`_rendererChangeAbortController`,void 0),T([a()],U.prototype,`_elevationInfoChangeAbortController`,void 0),T([a()],U.prototype,`_initializeAbortController`,void 0),T([a()],U.prototype,`_elevationAlignment`,void 0),T([a()],U.prototype,`_scaleVisibility`,void 0),T([a()],U.prototype,`_filterVisibility`,void 0),T([a()],U.prototype,`_initializePromise`,void 0),T([a()],U.prototype,`_spatialIndex`,void 0),T([a({readOnly:!0})],U.prototype,`extentPadding`,void 0),T([a()],U.prototype,`_updatingPendingLoadedGraphicsChange`,void 0),T([a()],U.prototype,`_featureStore`,void 0),T([a()],U.prototype,`_objectStates`,void 0),T([a()],U.prototype,`_loadingSymbols`,void 0),T([a({constructOnly:!0})],U.prototype,`compressionTracker`,void 0),T([a()],U.prototype,`preferredUpdatePolicy`,void 0),T([a()],U.prototype,`_forcedUpdatePolicy`,void 0),T([a({readOnly:!0})],U.prototype,`effectiveUpdatePolicy`,null),T([a({constructOnly:!0})],U.prototype,`elevationFeatureExpressionEnabled`,void 0),T([a({constructOnly:!0})],U.prototype,`owner`,void 0),T([a({constructOnly:!0})],U.prototype,`layer`,void 0),T([a({constructOnly:!0})],U.prototype,`graphicSymbolSupported`,void 0),T([a({constructOnly:!0})],U.prototype,`getRenderingInfoWithoutRenderer`,void 0),T([a({constructOnly:!0})],U.prototype,`componentFactories`,void 0),T([a({constructOnly:!0})],U.prototype,`setUidToIdOnAdd`,void 0),T([a()],U.prototype,`featureStore`,null),T([a()],U.prototype,`initializePromise`,null),T([a()],U.prototype,`scaleVisibility`,null),T([a()],U.prototype,`elevationAlignment`,null),T([a()],U.prototype,`objectStates`,null),T([a()],U.prototype,`filterVisibility`,null),T([a({readOnly:!0})],U.prototype,`updating`,null),T([a({readOnly:!0})],U.prototype,`dataUpdating`,null),T([a({readOnly:!0})],U.prototype,`readyToRun`,null),T([a({readOnly:!0})],U.prototype,`suspendedOrOutsideOfView`,null),T([a({readOnly:!0,dependsOn:[]})],U.prototype,`updatingRemaining`,null),T([a({readOnly:!0})],U.prototype,`displayFeatureLimit`,null),T([a({readOnly:!0,dependsOn:[]})],U.prototype,`averageSymbolComplexity`,null),T([a({constructOnly:!0})],U.prototype,`hasZ`,void 0),T([a({constructOnly:!0})],U.prototype,`hasM`,void 0),T([a()],U.prototype,`_objectIdField`,null),U=fi=T([_(`esri.views.3d.layers.graphics.Graphics3DCore`)],U);var hi=class{constructor(){this.add=null,this.renderingInfo=null,this.state=0,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=0,this.abortController=null,this.remove=null}},gi=10,W=C(),G=C(),_i=new Map,vi=.05,yi=class{constructor(){this._extents=new ct({allocator:e=>e||O()}),this._tmpExtent=O(),this._dirty=!1}destroy(){this._extents.prune()}get empty(){return this._extents.length===0}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this._contains(e)||(this._removeContained(e),ae(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(e){return this._mergeTight(e),e.hasProgressed}_mergeTight(e=p){let t=this._extents,n=new Set,r=0;for(;r!==t.length;){t.sort((e,t)=>e[0]-t[0]),r=t.length,n.clear();for(let r=0;r<t.length;++r){if(e.done)return;let i=t.at(r);if(i){for(let e=r+1;e<t.length;++e){let r=t.at(e);if(r==null||r[0]>=i[2])break;n.add(r)}n.forEach(r=>{if(i===r)return;if(r[2]<=i[0])return void n.delete(r);let a=ne(i),o=ne(r),s=this._tmpExtent;qe(i,r,s);let c=a+o;(ne(s)-c)/c<vi&&(ae(i,s),n.delete(r),t.remove(r),e.madeProgress())}),n.add(i)}}}this._dirty=!1}_contains(e){return this._extents.some(t=>se(t,e))}_removeContained(e){this._extents.filterInPlace(t=>!se(e,t))}get test(){}},K=class extends S{constructor(e){super(e),this._dirtyExtents=new yi,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new lt}initialize(){let e=this.elevationProvider;this._task=this.graphicsCoreOwner.view.resourceController.scheduler.registerTask(bi(this.graphicsCore.layer.elevationInfo?.mode),this),this.addHandles([e.on(`elevation-change`,e=>this._elevationChanged(e)),D(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),this._task,D(()=>bi(this.graphicsCore.layer.elevationInfo?.mode),e=>this._task.priority=e)])}destroy(){this._dirtyGraphicsSet.clear(),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null,this._dirtyExtents.destroy()}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange(`updating`)}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange(`updating`))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange(`updating`)}get updating(){return this.readyToRun}get readyToRun(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(e){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,e.madeProgress()),e.run(()=>this._dirtyExtents.merge(e));this.readyToRun&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.notifyChange(`updating`)}_updateDirtyGraphics(e){let t=this.graphicsCoreOwner.view.renderCoordsHelper,n=this.graphicsCore.effectiveUpdatePolicy===0;for(let r of this._dirtyGraphicsSet.keys()){let i=this.graphicsCore.getGraphics3DGraphicById(r);if(this._dirtyGraphicsSet.delete(r),i!=null&&(i.alignWithElevation(this.elevationProvider,t,n),this.graphicsCore.deconflictor?.setDirty(),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this._dirtyExtents.empty&&!e.done;){let t=this._dirtyExtents.pop(),{spatialReference:n}=this.elevationProvider;this.events.emit(`invalidate-elevation`,{extent:t,spatialReference:n});let r=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,n,e=>{let t=this.graphicsCore.getGraphics3DGraphicById(e);t!=null&&t.needsElevationUpdates()&&this._dirtyGraphicsSet.add(e)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-r)+.9*this._averageExtentUpdateSize,e.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((e,t)=>this._dirtyGraphicsSet.add(t))}_elevationChanged(e){if(e.context===`scene`&&(!this.graphicsCore.layer.elevationInfo||this.graphicsCore.layer.elevationInfo.mode!==`relative-to-scene`))return;let t=e.extent;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){let e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this._updateElevation=!0)}this.events.emit(`invalidate-elevation`,e)}else t[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(t),this.notifyChange(`updating`)}};function bi(e){return e==null?y.ELEVATION_ALIGNMENT:e===`relative-to-scene`?y.ELEVATION_ALIGNMENT_SCENE:y.ELEVATION_ALIGNMENT}T([a()],K.prototype,`graphicsCoreOwner`,void 0),T([a()],K.prototype,`graphicsCore`,void 0),T([a()],K.prototype,`queryGraphicUIDsInExtent`,void 0),T([a()],K.prototype,`elevationProvider`,void 0),T([a({readOnly:!0})],K.prototype,`updating`,null),T([a({readOnly:!0})],K.prototype,`updatingRemaining`,null),K=T([_(`esri.views.3d.layers.graphics.Graphics3DElevationAlignment`)],K);function xi(e,t,n,r){return Ti(e,t,n,Ci(r,t,n,!0))}var Si={dir:C(),len:0,clip:pe()};function Ci(e,t,n,r){let a=Si;return e?(n&&r&&(a.len=nt(t,n)),le(a.dir,e)):r?(a.len=nt(t,n),Mt(a.dir,n,t),i(a.dir,a.dir,1/a.len)):(Mt(a.dir,n,t),St(a.dir,a.dir)),a}function wi(e,t,n){let r=We(Vt(e),n.dir),i=-Ht(e,t);if(i<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return i>0;if((i<0||r<0)&&!(i<0&&r<0))return!0;let a=i/r;return r>0?a<n.clip[1]&&(n.clip[1]=a):a>n.clip[0]&&(n.clip[0]=a),n.clip[0]<=n.clip[1]}function Ti(e,t,n,r){r.clip[0]=0,r.clip[1]=n?r.len:Number.MAX_VALUE;for(let n=0;n<e.length;n++)if(!wi(e[n],t,r))return!1;return!0}var Ei=.5*Math.PI,Di=Ei/Math.PI*180,Oi=class{constructor(e){this._extent=[,,,,],this._planes=[,,,,,,],this._maxSpan=0,this._center={origin:C(),direction:C()},this._renderCoordsHelper=e.renderCoordsHelper;for(let e=0;e<4;e++)this._extent[e]={origin:C(),direction:C(),cap:{next:null,direction:C()}},this._planes[e]=Gt();this._planes[4]=Gt(),this._planes[5]=Gt(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,n,r=!0){let a=this._extent;this._toRenderBoundingExtent(e,t,n),de(this._center.origin,a[0].origin,a[2].origin),i(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),r||i(this._center.direction,this._center.direction,-1);for(let e=0;e<4;e++){let t=a[e];this._renderCoordsHelper.worldUpAtPosition(t.origin,t.direction);let n=a[e===3?0:e+1];t.cap.next=n.origin,at(t.cap.direction,t.origin,n.origin),Wt(t.direction,t.cap.direction,t.origin,this._planes[e]),r||i(t.direction,t.direction,-1)}Wt(a[0].cap.direction,a[1].cap.direction,a[0].origin,this._planes[4]),r?Ut(this._planes[4],this._planes[5]):(Bt(this._planes[5],this._planes[4]),Ut(this._planes[4],this._planes[4])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*yt(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,n=!1){if(e==null)return!1;if(this._renderCoordsHelper.viewingMode===1){let n=this._maxSpanSpatialReference.isGeographic?Di:Ei*t;if(this._maxSpan>n)return!0;if(e.altitude!=null&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(this._maxSpan===0){let t=this._extent[0];return!(n||!e.intersectsRay(on(t.origin,t.direction)))}for(let t=0;t<this._extent.length;t++){let r=this._extent[t];if(!n&&e.intersectsRay(on(r.origin,r.direction))||e.intersectsLineSegment(cn(r.origin,r.cap.next,Mi),r.cap.direction))return!0}let r=n?this._planes:this._planesWithoutFar;for(let t=0;t<e.lines.length;t++){let n=e.lines[t];if(xi(r,n.origin,n.endpoint,n.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,n){Nt(e,q),q[2]=n,qt(t,q,Ai,this._renderCoordsHelper.spatialReference),fe(ji,Ai),E(J);for(let{x0:r,x1:i,y0:a,y1:o}of ki)for(let s=0;s<5;s++){let c=s/4;q[0]=st(e[r],e[i],c),q[1]=st(e[a],e[o],c),q[2]=n,Xt(q,t,q,this._renderCoordsHelper.spatialReference),ze(q,q,ji),Se(J,q)}v(this._extent[0].origin,J[0],J[1],J[2]),v(this._extent[1].origin,J[3],J[1],J[2]),v(this._extent[2].origin,J[3],J[4],J[2]),v(this._extent[3].origin,J[0],J[4],J[2]);for(let e=0;e<4;++e)ze(this._extent[e].origin,this._extent[e].origin,Ai)}_toRenderBoundingExtentLocal(e,t,n){Vr(e,t,Y,this._renderCoordsHelper.spatialReference),v(this._extent[0].origin,Y[0],Y[1],n),v(this._extent[1].origin,Y[2],Y[1],n),v(this._extent[2].origin,Y[2],Y[3],n),v(this._extent[3].origin,Y[0],Y[3],n)}_toRenderBoundingExtent(e,t,n){switch(this._renderCoordsHelper.viewingMode){case 1:this._toRenderBoundingExtentGlobal(e,t,n);break;case 2:this._toRenderBoundingExtentLocal(e,t,n);break;default:Dt(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if(Ht(e.planes[4],this._center.origin)<0&&We(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){let n=this._extent[t];if(Ht(e.planes[4],n.origin)<0&&We(n.direction,e.direction)<0)return!0}return!1}},ki=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],q=C(),Ai=be(),ji=be(),J=Ve(),Y=O(),Mi=sn(),Ni=1.2,X=class extends S{constructor(e){super(e),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this.graphicsCoreOwner=null,this.updating=!0}initialize(){let{graphicsCoreOwner:e}=this;this._extentIntersection=new Oi({renderCoordsHelper:e.view.renderCoordsHelper});let{view:t}=e,{groundView:n}=t,{scheduler:r}=t.resourceController;this.addHandles([t.on(`resize`,()=>this._viewChange()),D(()=>t.state.camera,()=>this._viewChange(),Fe),r.registerTask(y.FRUSTUM_VISIBILITY,this),D(()=>n.visibleElevationRange,()=>this._elevationRangeChange())]),t.viewingMode===`local`?this._isVisibleBelowSurface=!0:this.addHandles([D(()=>[n.baseOpacity,n.wireframe,t.map?.ground?.navigationConstraint?.type],()=>this._updateIsVisibleBelowSurface(),Ke)])}destroy(){this._set(`graphicsCoreOwner`,null),this._extent=null,this._extentIntersection=null}_setDirty(){this.updating||this._set(`updating`,!0)}setExtent(e){this._extent=e,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationRangeChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(e){this._isVisibleBelowSurfaceInternal=e,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){let e=this.graphicsCoreOwner.view,t=e.basemapTerrain,n=e.viewingMode===`local`,r=e.map.ground?.navigationConstraint?.type===`none`;this._isVisibleBelowSurface=n||!t.opaque||r}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;let e=this.graphicsCoreOwner.view,t;if(this._isVisibleBelowSurfaceInternal)t=-.3*yt(e.spatialReference).radius;else{let{minElevation:n,maxElevation:r}=e.basemapTerrain.visibleElevationRange;t=n-Math.max(1,(r-n)*(Ni-1))}this._extentIntersection.update(this._extent,e.spatialReference,t)}get readyToRun(){return this.updating}runTask(e){if(this._set(`updating`,!1),!this._extent)return this._set(`suspended`,!1),je;this._updateExtentIntersection();let{frustum:t}=this.graphicsCoreOwner.view,n=yt(this.graphicsCoreOwner.view.spatialReference).radius;this._set(`suspended`,!this._extentIntersection.isVisibleInFrustum(t,n)),e.madeProgress()}};T([a({readOnly:!0})],X.prototype,`suspended`,void 0),T([a({constructOnly:!0})],X.prototype,`graphicsCoreOwner`,void 0),T([a({readOnly:!0})],X.prototype,`updating`,void 0),X=T([_(`esri.views.3d.layers.graphics.Graphics3DFrustumVisibility`)],X);var Pi=class{},Fi=class extends Pi{constructor(e,t){super(),this.objectStateId=e,this.object=t}remove(){this.object.removeStateID(this.objectStateId)}},Ii=class extends Pi{constructor(e,t,n){super(),this.objectStateId=e,this.object=t,this.owner=n}remove(){this.owner.removeRenderGeometryObjectState(this.object,this.objectStateId)}},Li=class extends Pi{constructor(e,t){super(),this.objectStateId=e,this._removeCallback=t,this.object=null}remove(){this._removeCallback(this.objectStateId)}},Ri=class{constructor(){this._items=[]}addObject(e,t){this._items.push(new Fi(t,e))}addRenderGeometry(e,t,n){this._items.push(new Ii(t,e,n))}addExternal(e,t){this._items.push(new Li(t,e))}remove(e){this._remove(t=>t.objectStateId===e)}removeByObject(e){this._remove(t=>t.object===e)}removeAll(){this._items.forEach(e=>e.remove()),this._items=[]}_remove(e){let{_items:t}=this;for(let n=t.length-1;n>=0;--n){let r=t[n];e(r)&&(r.remove(),t.splice(n,1))}}},zi=class extends Ri{constructor(){super(...arguments),this.stateType=1}},Bi=class extends Ri{constructor(e){super(),this.highlightName=e,this.stateType=0}},Vi=class{constructor(e){this.objectIdField=e,this.ids=new Set,this.paused=!1}hasGraphic(e){let t=this.objectIdField?e.graphic.attributes[this.objectIdField]:e.graphic.uid;return this.ids.has(t)}},Hi=class extends Vi{constructor(e){super(e),this.stateType=1,this.objectStateSet=new zi}},Ui=class extends Vi{constructor(e,t){super(t),this.highlightName=e,this.stateType=0,this.objectStateSet=new Bi(e)}},Wi=class{constructor(e){this._graphicsCore=e,this._stateSets=[]}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(e=>e.objectStateSet.removeAll()),this._stateSets.length=0)}acquireOccludeeSet(e){let t=new Hi(e);this._stateSets.push(t);let n=b(()=>this.releaseSet(t));return{set:t,handle:n}}acquireHighlightSet(e,t){let n=new Ui(e,t);this._stateSets.push(n);let r=b(()=>this.releaseSet(n));return{set:n,handle:r}}releaseSet(e){e.objectStateSet.removeAll();let t=this._stateSets?this._stateSets.indexOf(e):-1;t!==-1&&this._stateSets.splice(t,1)}setUid(e,t){e.ids.add(t);let n=this._graphicsCore.graphics3DGraphics.get(t);n&&n.addObjectStateSet(e.objectStateSet)}setUids(e,t){t.forEach(t=>this.setUid(e,t))}setObjectIds(e,t){t.forEach(t=>e.ids.add(t)),this._initializeSet(e)}addGraphic(e){this._stateSets.forEach(t=>{!t.paused&&t.hasGraphic(e)&&e.addObjectStateSet(t.objectStateSet)})}removeGraphic(e){this._stateSets.forEach(t=>{t.hasGraphic(e)&&e.removeObjectState(t.objectStateSet)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(e=>e.objectStateSet.removeAll())}_initializeSet(e){let t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach(t=>{t&&e.hasGraphic(t)&&t.addObjectStateSet(e.objectStateSet)}):e.ids.forEach(n=>{let r=t.get(n);r&&r.addObjectStateSet(e.objectStateSet)})}get test(){}},Z=class extends S{constructor(e){super(e),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this._updatingHandles=new pt,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive();let e=this.graphicsCoreOwner.view.resourceController.scheduler;this.addHandles(e.registerTask(y.SCALE_VISIBILITY,this)),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.layerMinMaxScaleChangeHandler())}destroy(){this._updatingHandles.destroy(),this.removeHandles(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this._updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(e){let t=this.graphicsCoreOwner.view.spatialReference,n=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(t===n)this._extent=e??null;else{let r=O();Vr(e,t,r,n)?this._extent=r:this._extent=null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){let e=this.layer,t=e.effectiveScaleRange,n=this.layerScaleEnabled&&t!=null&&Gi(t.minScale,t.maxScale);e.labelingInfo&&!n&&(n=e.labelingInfo.some(e=>e&&Gi(e.minScale??0,e.maxScale??0)));let r=this._scaleRangeActive!==n;return this._scaleRangeActive=n,n&&!this.hasHandles(Ki)&&this.basemapTerrain?(this.addHandles(this.basemapTerrain.on(`scale-change`,e=>this._scaleUpdateHandler(e)),Ki),this.layerScaleEnabled&&this.addHandles(this.basemapTerrain.on(`tiles-visibility-changed`,()=>this._setDirty()),Ki)):!n&&this.hasHandles(Ki)&&this.removeHandles(Ki),r}get readyToRun(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(e){let{groundView:t}=this.graphicsCoreOwner.view;if(this._extent&&t&&t.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return je;{this._layerScaleRangeVisibilityQuery=!0;let{minScale:e,maxScale:t}=this.layer.effectiveScaleRange;this.graphicsCoreOwner.view.basemapTerrain.queryVisibleScaleRange(this._extent,e,t,e=>this._finishUpdate(e))}}else this._finishUpdate(!0);e.madeProgress()}_finishUpdate(e){this._layerScaleRangeVisibilityQuery=!1,this._set(`suspended`,!e),this._dirty=!1}_visibleAtLayerScale(e){let t=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||tn(e,t.minScale||0,t.maxScale||0)}_visibleAtLabelScale(e,t){return tn(e,t.minScale||0,t.maxScale||0)}_graphicScale(e){let t;return e.centroid==null?e.graphic.geometry!=null&&e.graphic.geometry.type===`point`&&(t=e.graphic.geometry):t=e.centroid,t?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(t):1:null}_graphicVisible(e){if(!this.layerScaleEnabled)return!0;let t=this._graphicScale(e);return this._visibleAtLayerScale(t)}updateVisibility(e){if(!this._scaleRangeActive)return!1;let t=this._graphicVisible(e);return e.setVisibilityFlag(1,2,t)}updateGraphicLabelScaleVisibility(e){if(!this._scaleRangeActive||!e.labelLayers.length)return!1;let t=this._graphicScale(e),n=this._updateLabelScaleVisibility(e,t);return n&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty()),n}_updateLabelScaleVisibility(e,t){if(!e.labelLayers.length)return!1;let n=e.labelLayers[0].labelClass;if(n?.minScale!=null&&n.maxScale!=null){let r=this._visibleAtLabelScale(t,n);if(e.setVisibilityFlag(16,2,r))return!0}return!1}_scaleUpdateHandler(e){if(this._setDirty(),!this.graphicsCore.visible)return;let t=e.extent,n=e.scale,r=this._visibleAtLayerScale(n),i=!1,a=this.graphicsCoreOwner.view.spatialReference,o=e.spatialReference;if(o==null)return void k.getLogger(this).error(`scaleUpdate: Internal error, no SpatialReference given for tiles`);let s=!o.equals(a);if(s&&!Vr(t,o,qi,a))return void k.getLogger(this).error(`scaleUpdate: Internal error, cannot project AABR from `+o+` to wkid `+a);let c=s?qi:t;this.queryGraphicUIDsInExtent(c,a,e=>{let a=this.graphicsCore.getGraphics3DGraphicById(e);if(a==null)return;let o=a.centroid;o!=null&&(t[0]>o.x||t[1]>o.y||t[2]<o.x||t[3]<o.y)||(a.setVisibilityFlag(1,2,r)&&(i=!0),this._updateLabelScaleVisibility(a,n)&&(i=!0))}),i&&(this.graphicsCore.deconflictor?.setDirty(),this.graphicsCore.labeler?.setDirty())}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(e=>e.setVisibilityFlag(1,2,!0)):this._scaleRangeActive&&this.graphicsCore.updateGraphicsVisibilities(),this._setDirty()}};function Gi(e,t){return e>0||t>0}T([a()],Z.prototype,`graphicsCoreOwner`,void 0),T([a()],Z.prototype,`layer`,void 0),T([a()],Z.prototype,`queryGraphicUIDsInExtent`,void 0),T([a()],Z.prototype,`graphicsCore`,void 0),T([a()],Z.prototype,`basemapTerrain`,void 0),T([a({constructOnly:!0})],Z.prototype,`layerScaleEnabled`,void 0),T([a({readOnly:!0})],Z.prototype,`suspended`,void 0),T([a({readOnly:!0})],Z.prototype,`updating`,null),T([a()],Z.prototype,`_dirty`,void 0),Z=T([_(`esri.views.3d.layers.graphics.Graphics3DScaleVisibility`)],Z);var Ki=`terrain-events`,qi=O();function Ji(e){return $e.isCollection(e)?e.toArray():Array.isArray(e)?e:Yi(e)||Ie(e)||Zi(e)?[e]:Xi}function Yi(e){return typeof e==`number`||typeof e==`string`}var Xi=[];b();function Zi(e){return e.declaredClass===`esri.views.3d.layers.i3s.PointCloudGraphic`}var Q=class extends S{constructor(e){super(e),this.drapeSourcePriorityOffset=0,this.type=`graphics-3d`,this.graphicsCore=null,this.drapeSourceType=1,this.scaleVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this._suspendResumeExtent=null,this._updatingHandles=new pt}initialize(){let{layer:e}=this,t=`effectiveScaleRange`in e?e:null,n=!nn()&&this.scaleVisibilityEnabled&&t!=null,r=new U({owner:this,layer:this.owner.layer,preferredUpdatePolicy:1,graphicSymbolSupported:!0,componentFactories:{elevationAlignment:(e,t)=>new K({graphicsCoreOwner:this,graphicsCore:e,queryGraphicUIDsInExtent:t,elevationProvider:this.view.elevationProvider}),scaleVisibility:n?(e,n)=>new Z({graphicsCoreOwner:this,layer:t,queryGraphicUIDsInExtent:n,graphicsCore:e,basemapTerrain:this.owner.view.basemapTerrain}):null,objectStates:e=>new Wi(e)}});if(this._set(`graphicsCore`,r),this.frustumVisibilityEnabled&&this._set(`frustumVisibility`,new X({graphicsCoreOwner:this})),`fullOpacity`in this.owner){let e=this.owner;this._updatingHandles.add(()=>e.fullOpacity,()=>this.graphicsCore.opacityChange())}if(`elevationInfo`in e){let t=e;this._updatingHandles.add(()=>t.elevationInfo,(e,t)=>{ke(e,t)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})}this._set(`initializePromise`,this._initializeAsync()),this._updatingHandles.addPromise(this.initializePromise)}async _initializeAsync(){try{await this.graphicsCore.initializePromise}catch(e){if(_t(e))return;throw e}this.destroyed||(this.addHandles(D(()=>this.view.clippingArea,()=>this._updateClippingExtent(),Fe)),this._updateClippingExtent(),this._setupSuspendResumeExtent(),this.graphicsCore.startCreateGraphics())}destroy(){this._updatingHandles.destroy(),this._set(`frustumVisibility`,A(this.frustumVisibility)),this._set(`graphicsCore`,A(this.graphicsCore))}get layer(){return this.owner.layer}get layerViewUid(){return this.owner.uid}get view(){return this.owner.view}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get scaleVisibilitySuspended(){return!(this.scaleVisibility==null||!this.scaleVisibility.suspended)}get frustumVisibilitySuspended(){return this.frustumVisibility!=null&&this.frustumVisibility.suspended}get suspended(){return this.owner.suspended??!1}get updating(){return!!(this.graphicsCore?.updating||this.scaleVisibility!=null&&this.scaleVisibility.updating||this.frustumVisibility!=null&&this.frustumVisibility.updating||this._updatingHandles.updating)}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner.fullOpacity??1}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}notifyContentGeometryUpdate(){this.owner.notifyContentGeometryUpdate?.()}getRenderingInfo(e,t,n){let r=$n(e,{renderer:t,arcade:n});if(r?.color){let e=r.color;e[0]/=255,e[1]/=255,e[2]/=255}return r}getRenderingInfoAsync(e,t,n,r){return Gn(e,{renderer:t,arcade:n,...r})}getHit(e,t){if(this.owner.loadedGraphics){let n=this.owner.loadedGraphics.find(t=>t.uid===e);if(n){let e=this.layer instanceof o?this.layer:null,r=ln(n,e,t);return{type:`graphic`,graphic:r,layer:r.layer}}}return null}whenGraphicBounds(e,t){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(e,t):Promise.reject()}computeAttachmentOrigin(e,t){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(e,t):null}getSymbolLayerSize(e,t){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(e,t):null}maskOccludee(e){let t=this.graphicsCore?.objectStates;if(!t)return b();let{set:n,handle:r}=t.acquireOccludeeSet(null);return t.setUid(n,e.uid),r}highlight(e,t){let n=this.graphicsCore?.objectStates;if(!n)return Qi;let r=Ji(e);if(r.length===0)return Qi;if(r[0]instanceof kt){let e=r.map(e=>e.uid),{set:i,handle:a}=n.acquireHighlightSet(t,null);return n.setUids(i,e),a}if(typeof r[0]==`number`){let e=r,{set:i,handle:a}=n.acquireHighlightSet(t,null);return n.setObjectIds(i,e),a}return Qi}_setupSuspendResumeExtent(){let{scaleVisibility:e,frustumVisibility:t}=this;if(e==null&&t==null)return;let n=({computedExtent:n,extentPadding:r})=>{this._suspendResumeExtent=Wn(n,this._suspendResumeExtent,qn,r),e?.setExtent(this._suspendResumeExtent),t?.setExtent(this._suspendResumeExtent)};this.addHandles(D(()=>({computedExtent:this.graphicsCore?.computedExtent,extentPadding:this.graphicsCore?.extentPadding}),e=>n(e),Ct))}_updateClippingExtent(){let e=this.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()}};T([a()],Q.prototype,`drapeSourcePriorityOffset`,void 0),T([a()],Q.prototype,`type`,void 0),T([a({constructOnly:!0})],Q.prototype,`owner`,void 0),T([a()],Q.prototype,`layer`,null),T([a()],Q.prototype,`layerViewUid`,null),T([a()],Q.prototype,`view`,null),T([a({constructOnly:!0})],Q.prototype,`graphicsCore`,void 0),T([a()],Q.prototype,`scaleVisibility`,null),T([a({constructOnly:!0})],Q.prototype,`frustumVisibility`,void 0),T([a()],Q.prototype,`elevationAlignment`,null),T([a()],Q.prototype,`scaleVisibilitySuspended`,null),T([a({readOnly:!0})],Q.prototype,`frustumVisibilitySuspended`,null),T([a()],Q.prototype,`suspended`,null),T([a({readOnly:!0})],Q.prototype,`updating`,null),T([a()],Q.prototype,`loadedGraphics`,null),T([a()],Q.prototype,`fullOpacity`,null),T([a()],Q.prototype,`slicePlaneEnabled`,null),T([a()],Q.prototype,`drapeSourceType`,void 0),T([a()],Q.prototype,`updatePolicy`,null),T([a({constructOnly:!0})],Q.prototype,`scaleVisibilityEnabled`,void 0),T([a({constructOnly:!0})],Q.prototype,`frustumVisibilityEnabled`,void 0),T([a()],Q.prototype,`initializePromise`,void 0),Q=T([_(`esri.views.3d.layers.graphics.GraphicsProcessor`)],Q);var Qi=b();async function $i(e,t,n){if(e==null||t.candidates.length===0)return ea;let r=e.graphics3DGraphicsByObjectID??e.graphics3DGraphics,i=[],a=[],{renderer:o}=e,s=o!=null&&`arcadeRequired`in o&&o.arcadeRequired?Ee():null,c=async(t,{graphic:r,graphics3DSymbol:i})=>{let a=await s,c=await e.getRenderingInfoAsync(r,o,a,{signal:n});return c==null?[]:i.queryForSnapping(t,u,c,n)},{candidates:l,spatialReference:u}=t;for(let e=0;e<l.length;++e){let t=l[e],{objectId:n}=t,o=typeof n==`number`?r?.get(n):void 0;if(o==null)continue;let{graphics3DSymbol:s}=o;s.symbologySnappingSupported&&(i.push(c(t,o)),a.push(e))}if(i.length===0)return ea;let d=await Promise.all(i);w(n);let f=[],p=[];for(let e=0;e<d.length;++e){let t=d[e],n=a[e];for(let e of t)f.push(e),p.push(n)}return{candidates:f,sourceCandidateIndices:p}}var ea={candidates:[],sourceCandidateIndices:[]},ta=class{constructor(e,t=0,n=0,r=0,i=0,a=null){this.usedMemory=e,this.displayedFeatures=t,this.totalFeatures=n,this.maximumFeatures=r,this.nodes=i,this.core=a}},$=class extends lr(un){constructor(){super(...arguments),this.type=`graphics-3d`,this.symbologySnappingSupported=!0,this._slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.ignoresMemoryFactor=!0}get highlightOptions(){return null}initialize(){this._set(`processor`,new Q({owner:this,scaleVisibilityEnabled:!0,frustumVisibilityEnabled:!0})),this.addResolvingPromise(this.processor.initializePromise),this.addHandles(this.layer.on(`graphic-update`,e=>this.processor.graphicsCore.graphicUpdateHandler(e))),this.layer.internal?this.notifyChange(`updating`):(this.view.viewingMode===`local`&&this.addResolvingPromise((async()=>this.fullExtentInLocalViewSpatialReference=await l(this.layer.fullExtent,this.view.spatialReference).catch(()=>null))()),this.addHandles(e(()=>this.view?.groundView?.ready,()=>()=>this.notifyChange(`updating`),{once:!0})))}destroy(){this._updatingHandles.removeAll(),this._set(`processor`,A(this.processor))}get loadedGraphics(){return this.layer.graphics}get legendEnabled(){return this.canResume()&&!this.processor?.frustumVisibilitySuspended}get visibleAtCurrentScale(){return nn()?en(this.layer.effectiveScaleRange,this.view.scale):!this.processor?.scaleVisibilitySuspended}get slicePlaneEnabled(){let e=this.layer.internal;return this._slicePlaneEnabled&&!e}set slicePlaneEnabled(e){this._slicePlaneEnabled=e}getSuspendInfo(){let e=super.getSuspendInfo();return e.outsideOfView=this.processor?.frustumVisibilitySuspended??!1,e}getHit(e){return this.processor.getHit(e,null)}whenGraphicBounds(e,t){return this.processor.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.processor?.computeAttachmentOrigin(e,t)}getSymbolLayerSize(e,t){return this.processor.getSymbolLayerSize(e,t)}queryGraphics(){return Promise.resolve(this.loadedGraphics)}maskOccludee(e){return this.processor.maskOccludee(e)}highlight(e,t){return this.processor.highlight(e,dn(t))}notifyContentGeometryUpdate(){this.emit(`visible-geometry-changed`)}async elevationAlignPointsInFeatures(e,t){let{processor:r}=this;if(r?.graphics3DGraphics==null)throw new n(`graphicslayerview3d:missing-processor`,`A Graphics3D processor is needed to resolve graphics elevation.`);let{graphics3DGraphics:i}=r;return ur(this.view,this.layer,e=>typeof e==`number`?i.get(e):void 0,e,t)}async queryForSymbologySnapping(e,t){return $i(this.processor,e,t)}get updatePolicy(){return this.processor?.graphicsCore.effectiveUpdatePolicy||1}isUpdating(){return this.view&&this.layer&&!(!this.processor?.updating&&(this.layer.internal||this.view.groundView?.ready))}get performanceInfo(){return new ta(this.usedMemory,this.loadedGraphics.length,-1,-1)}get usedMemory(){return this.processor?.graphicsCore?.usedMemory??0}get unloadedMemory(){return this.processor?.graphicsCore?.unprocessedMemoryEstimate}get test(){return{graphics3DProcessor:this.processor,loadedGraphics:this.loadedGraphics}}};T([a()],$.prototype,`highlightOptions`,null),T([a()],$.prototype,`loadedGraphics`,null),T([a({readOnly:!0})],$.prototype,`legendEnabled`,null),T([a()],$.prototype,`layer`,void 0),T([a({readOnly:!0})],$.prototype,`processor`,void 0),T([a({readOnly:!0})],$.prototype,`visibleAtCurrentScale`,null),T([a()],$.prototype,`_slicePlaneEnabled`,void 0),T([a({type:Boolean})],$.prototype,`slicePlaneEnabled`,null),$=T([_(`esri.views.3d.layers.GraphicsLayerView3D`)],$);var na=$;export{na as default};