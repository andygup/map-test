import{BT as e,DT as t,En as n,Hw as r,JE as i,Ju as a,OT as o,RS as s,WT as c,Z_ as l,_d as u,_w as d,ax as f,eT as p,fS as m,gD as h,iv as g,nv as _,pD as v,px as y,qw as b,rd as x,rv as S,uE as C,vd as w}from"./index-CzMixifc.js";import"./memoryEstimations-C3WUBUZI.js";import"./OptimizedGeometry-5fDazGe-.js";import"./OptimizedFeatureSet-D4F9ObY_.js";import"./featureConversionUtils-VvJ2pauf.js";import"./streamLayerUtils-82UmlW-3.js";import"./QueueProcessor-CbN5H2eO.js";import"./earcut-CsNwSYFA.js";import"./layerViewUtils-Cbrog-dU.js";import{t as T}from"./popupUtils-Bps_s4dv.js";import"./tagSymbols-CNjeVVdC.js";import"./PixelBlock-Cu1E_t0b.js";import{s as E,y as D}from"./vectorFieldUtils-BZ6-deEm.js";import"./colorUtils-Btp0B-0Y.js";import{r as O}from"./rasterFieldUtils-B81vnJaq.js";import"./dataUtils-CAfnFU_x.js";import{i as k,r as A,u as j}from"./rasterProjectionHelper-cBqbWx2d.js";import{t as M}from"./clipUtils-0cgYPFvv.js";import"./timeSupport-CjNpK2fD.js";import"./queryUtils-fxq7u50x.js";import"./quantizationUtils-CzrQVcZ1.js";import"./normalizeUtilsSync-DZGX2pCO.js";import"./GeometryUtils-C6BJBMi9.js";import"./VertexAttributeLocations-DOYYzMyn.js";import"./VertexElementDescriptor-C9CNG143.js";import"./labelPoint-D95l1mBc.js";import"./callExpressionWithCursor-NwM51lOx.js";import"./FeatureMetadata-DVsh91f_.js";import"./CIMSymbolHelper-CIzDgFQE.js";import"./rasterizingUtils-L-rXtdWe.js";import"./Rect-BMNJQxpm.js";import"./BoundingBox-CW0_Ka-z.js";import"./BidiEngine-CpIovbIK.js";import"./callExpressionWithFeature-jAwzgzDm.js";import"./OverrideHelper-Catw08-A.js";import"./FeatureCommandQueue-Ccv3I5Xd.js";import"./config-BY05DP3l.js";import"./dehydratedFeatureComparison-DeSHk9xR.js";import{t as N}from"./WGLContainer-v9ak9x06.js";import"./utils-CPFnbOXo.js";import"./ProgramTemplate-DXigF9DQ.js";import"./VertexArrayObject-BCHCoUBc.js";import"./BufferObject-DizvMSTk.js";import"./VertexBuffer-Dhf7DMaS.js";import"./vec3f32-BWuLbfSR.js";import{t as P}from"./Container-s63aPbsG.js";import"./GraphShaderModule-KXpa7jQA.js";import"./FramebufferObject-E0PFfPHi.js";import"./ShaderBuilder-Dbc4jYz7.js";import"./bitmapUtils-CseW13Cs.js";import{i as F}from"./Bitmap-BHK62sx3.js";import{t as I}from"./BitmapContainer-C71VqD9y.js";import{t as L}from"./LayerView2D-BLVA9W76.js";import{t as R}from"./ExportStrategy-CsYDFVcX.js";import{t as z}from"./LayerView-BKgBHcbR.js";import{t as B}from"./RefreshableLayerView-Cxa6i7Us.js";import{t as V}from"./timeSupport-DIR5HMZt.js";import"./UpdateTracking2D-BQFl9U6T.js";import"./TechniqueInstance-B2WffE-f.js";import"./TileContainer-CdHqIsYl.js";import"./constants-TfCITEY_.js";import"./utils-Cp6QQbUU.js";import{t as H}from"./highlightOptionsUtils-C-mZET-I.js";import"./AGraphicContainer-DjhIZWU6.js";import"./ComputedAttributeStorage-D3juJH-7.js";import{t as U}from"./GraphicsView2D-y5Ereu1j.js";import"./dehydratedFeatures-Db6Q9NQd.js";import"./loadUtils-grnyIg9J.js";import{n as W,r as G,t as K}from"./RasterVFDisplayObject-CAwXHvKp.js";import{t as q}from"./HighlightGraphicContainer-DMh0MvP_.js";var J=class extends d{constructor(){super(...arguments),this.attached=!1,this.container=new P,this.updateRequested=!1,this.pixelHighlights=[],this.type=`imagery`,this._bitmapView=new I}destroy(){this.attached&&=(this.detach(),!1),this.updateRequested=!1}get updating(){return!this.attached||this.isUpdating()}update(e){this.strategy.update(e).catch(e=>{b(e)||C.getLogger(this).error(e)})}hitTest(e){return new w({attributes:{},geometry:e.clone(),layer:this.layer})}attach(){this.container.addChild(this._bitmapView);let e=this.layer.version>=10,t=this.layer.version>=10.1?this.layer.imageMaxHeight:2048,n=this.layer.version>=10.1?this.layer.imageMaxWidth:2048;this.strategy=new R({container:this._bitmapView,imageNormalizationSupported:e,imageMaxHeight:t,imageMaxWidth:n,fetchSource:this._fetchImage.bind(this),requestUpdate:()=>this.requestUpdate()})}detach(){this.strategy.destroy(),this._bitmapView.removeAllChildren(),this.container.removeAllChildren(),this.updateRequested=!1}redraw(){this.strategy.updateExports(async e=>{let{source:t}=e;if(!t||t instanceof ImageBitmap)return;let n=t.originalPixelBlock??t.pixelBlock,{pixelHighlights:r}=this,i=r.length>0,a=await this.layer.applyRenderer({extent:t.extent,pixelBlock:n,isRawData:i}),o=a.pixelBlock;i&&n&&o&&await this.layer.highlightPixels({pixelBlock:n,renderedPixelBlock:o,highlightOptions:r}),t.filter=e=>this.layer.pixelFilter?this.layer.applyFilter(e):{...a,extent:t.extent}}).catch(e=>{b(e)||C.getLogger(this).error(e)})}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}isUpdating(){return this.strategy.updating||this.updateRequested}getPixelData(){if(this.updating)return null;let e=this.strategy.bitmaps;if(e.length===1&&e[0].source)return{extent:e[0].source.extent,pixelBlock:e[0].source.originalPixelBlock};if(e.length>1){let t=this.view.extent,n=e.map(e=>e.source).filter(e=>e.extent&&e.extent.intersects(t)).map(e=>({extent:e.extent,pixelBlock:e.originalPixelBlock})),r=D(n,t);return r==null?null:{extent:r.extent,pixelBlock:r.pixelBlock}}return null}async _fetchImage(e,t,n,r){(r||={}).timeExtent=this.timeExtent;let i=this.pixelHighlights.length>0;r.requestAsImageElement=!i,r.returnImageBitmap=!i,r.requestRawData=i;let a=await this.layer.internalFetchImage(e,t,n,r);if(a.imageBitmap)return a.imageBitmap;let o=await this.layer.applyRenderer({...a.pixelData,isRawData:i},{signal:r.signal}),s=a.pixelData.pixelBlock,c=o.pixelBlock;i&&s&&c&&await this.layer.highlightPixels({pixelBlock:s,renderedPixelBlock:c,highlightOptions:this.pixelHighlights});let l=new F(c,o.extent?.clone(),s);return l.filter=e=>this.layer.applyFilter(e),l}};h([t()],J.prototype,`attached`,void 0),h([t()],J.prototype,`container`,void 0),h([t()],J.prototype,`layer`,void 0),h([t()],J.prototype,`strategy`,void 0),h([t()],J.prototype,`timeExtent`,void 0),h([t()],J.prototype,`view`,void 0),h([t()],J.prototype,`updateRequested`,void 0),h([t()],J.prototype,`updating`,null),h([t()],J.prototype,`pixelHighlights`,void 0),h([t()],J.prototype,`type`,void 0),J=h([o(`esri.views.2d.layers.imagery.ImageryView2D`)],J);var Y=class extends N{constructor(){super(...arguments),this.symbolTypes=[`triangle`]}prepareRenderPasses(e){let t=e.registerRenderPass({name:`imagery (vf)`,brushes:[W],target:()=>this.children,drawPhase:1});return[...super.prepareRenderPasses(e),t]}doRender(e){this.visible&&e.drawPhase===1&&this.symbolTypes.forEach(t=>{e.renderPass=t,super.doRender(e)})}},X=class extends d{constructor(e){super(e),this._loading=null,this.update=r((e,t)=>this._update(e,t).catch(e=>{b(e)||C.getLogger(this).error(e)}))}get updating(){return!!this._loading}redraw(e){if(!this.container.children.length)return;let t=this.container.children[0];t.symbolizerParameters=e,t.invalidateVAO(),this.container.symbolTypes=e.style===`wind_speed`?[`scalar`,`triangle`]:e.style===`simple_scalar`?[`scalar`]:[`triangle`],this.container.requestRender()}async _update(e,t,n){if(!e.stationary)return;let{extent:r,spatialReference:i}=e.state,a=new f({xmin:r.xmin,ymin:r.ymin,xmax:r.xmax,ymax:r.ymax,spatialReference:i}),[o,s]=e.state.size;this._loading=this.fetchPixels(a,o,s,n);let c=await this._loading;this._addToDisplay(c,t,e.state),this._loading=null}_addToDisplay(e,t,n){if(e.pixelBlock==null)return this.container.children.forEach(e=>e.destroy()),void this.container.removeAllChildren();let{extent:r,pixelBlock:i}=e,a=new K(i);a.offset=[0,0],a.symbolizerParameters=t,a.rawPixelData=e,a.invalidateVAO(),a.x=r.xmin,a.y=r.ymax,a.pixelRatio=n.pixelRatio,a.rotation=n.rotation,a.resolution=n.resolution,a.width=i.width*t.symbolTileSize,a.height=i.height*t.symbolTileSize,this.container.children.forEach(e=>e.destroy()),this.container.removeAllChildren(),this.container.symbolTypes=t.style===`wind_speed`?[`scalar`,`triangle`]:t.style===`simple_scalar`?[`scalar`]:[`triangle`],this.container.addChild(a)}};h([t()],X.prototype,`fetchPixels`,void 0),h([t()],X.prototype,`container`,void 0),h([t()],X.prototype,`_loading`,void 0),h([t()],X.prototype,`updating`,null),X=h([o(`esri.views.2d.layers.imagery.ImageryVFStrategy`)],X);var Z=class extends d{constructor(){super(...arguments),this.attached=!1,this.container=new Y,this.type=`imageryVF`,this._dataParameters={exportParametersVersion:0,bbox:``,symbolTileSize:0,time:``},this._fetchpixels=async(e,t,n,r)=>{let i=await this._projectFullExtentPromise,{layer:a}=this,{symbolTileSize:o}=a.renderer,{extent:s,width:c,height:l}=E(e,t,n,o,i);if(i!=null&&!i.intersects(e))return{extent:s,pixelBlock:null};let u={bbox:`${s.xmin}, ${s.ymin}, ${s.xmax}, ${s.ymax}`,exportParametersVersion:a.exportImageServiceParameters.version,symbolTileSize:o,time:JSON.stringify(this.timeExtent||``)};if(this._canReuseVectorFieldData(u)){let e=this.getPixelData();if(e!=null&&`${e.extent.xmin}, ${e.extent.ymin}, ${e.extent.xmax}, ${e.extent.ymax}`===u.bbox)return e}let{pixelBlock:d}=await a.fetchPixels(s,c,l,{timeExtent:this.timeExtent,interpolation:a.interpolation,signal:r});if(this._dataParameters=u,d==null)return{extent:s,pixelBlock:null};let{dataType:f}=a.rasterInfo;return{extent:s,pixelBlock:f===`vector-uv`&&d?await a.convertVectorFieldData(d,`vector-uv`,{signal:r}):d}}}get updating(){return!this.attached||this._strategy.updating}attach(){this._projectFullExtentPromise=this._getProjectedFullExtent(this.view.spatialReference),this._strategy=new X({container:this.container,fetchPixels:this._fetchpixels}),this.addHandles(_(()=>this.layer.renderer,e=>this._updateSymbolizerParams(e),S),`attach`)}detach(){this._strategy.destroy(),this.container.children.forEach(e=>e.destroy()),this.container.removeAllChildren(),this.removeHandles(`attach`),this._strategy=this.container=this._projectFullExtentPromise=null}getPixelData(){let e=this.container.children[0]?.rawPixelData;if(this.updating||!e)return null;let{extent:t,pixelBlock:n}=e;return{extent:t,pixelBlock:n}}hitTest(e){return new w({attributes:{},geometry:e.clone(),layer:this.layer})}update(e){this._strategy.update(e,this._symbolizerParams).catch(e=>{b(e)||C.getLogger(this).error(e)})}redraw(){let{renderer:e}=this.layer;e&&(this._updateSymbolizerParams(e),this._strategy.redraw(this._symbolizerParams))}_canReuseVectorFieldData(e){let t=this._dataParameters.exportParametersVersion===e.exportParametersVersion,n=this._dataParameters.time===e.time,r=this._dataParameters.symbolTileSize===e.symbolTileSize,i=this._dataParameters.bbox===e.bbox;return t&&n&&r&&i}async _getProjectedFullExtent(e){try{return A(this.layer.fullExtent,e)}catch{try{let t=(await s(this.layer.url,{query:{option:`footprints`,outSR:m(e),f:`json`}})).data.featureCollection.layers[0].layerDefinition.extent;return t?f.fromJSON(t):null}catch{return null}}}_updateSymbolizerParams(e){e?.type===`vector-field`&&(this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null}))}};h([t()],Z.prototype,`attached`,void 0),h([t()],Z.prototype,`container`,void 0),h([t()],Z.prototype,`layer`,void 0),h([t()],Z.prototype,`timeExtent`,void 0),h([t()],Z.prototype,`type`,void 0),h([t()],Z.prototype,`view`,void 0),h([t()],Z.prototype,`updating`,null),Z=h([o(`esri.views.2d.layers.imagery.VectorFieldView2D`)],Z);var Q=r=>{let i=r,a=class extends i{constructor(...e){super(...e),this.view=null}get timeExtent(){return V(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}async fetchPopupFeaturesAtLocation(t,r){let{layer:i}=this;if(!t)throw new e(`imagerylayerview:fetchPopupFeatures`,`Nothing to fetch without area`,{layer:i});let{popupEnabled:a}=i,o=T(i,r);if(!a||o==null)return[];let s=await o.getRequiredFields(null,{index:new n(i.rasterFields),partitions:new Map([[`$pixel`,i.rasterFields.filter(e=>e.name.startsWith(O)).map(e=>e.name)],[`$imageCollectionItem`,i.fields.map(e=>e.name)]])});p(r);let c=new x;c.timeExtent=this.timeExtent,c.geometry=t,c.outFields=s,c.outSpatialReference=t.spatialReference;let{resolution:l,spatialReference:u}=this.view,d=this.view.type===`2d`?new y(l,l,u):new y(.5*l,.5*l,u),{returnTopmostRaster:f,showNoDataRecords:m}=o.layerOptions||{returnTopmostRaster:!0,showNoDataRecords:!1},h={returnDomainValues:!0,returnTopmostRaster:f,pixelSize:d,showNoDataRecords:m,signal:r?.signal};return i.queryVisibleRasters(c,h)}async getSourceScale(){return await j(),await this.layer.load(),k(this.layer.serviceRasterInfo,this.view.spatialReference)}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return h([t()],a.prototype,`layer`,void 0),h([t()],a.prototype,`suspended`,void 0),h([t({readOnly:!0})],a.prototype,`timeExtent`,null),h([t()],a.prototype,`view`,void 0),a=h([o(`esri.views.layers.ImageryLayerViewMixin`)],a),a},$=class extends Q(B(L(z))){constructor(){super(...arguments),this._exportImageVersion=-1,this._highlightGraphics=new u,this._highlightView=void 0,this._pixelHighlights=[],this.layer=null,this.subview=null}get pixelData(){let{subview:e}=this;return this.updating||!e?null:`getPixelData`in e?e.getPixelData():null}update(e){this.subview?.update(e)}attach(){this.layer.increaseRasterJobHandlerUsage(),this._setSubView(),this.view&&(this._highlightView=new U({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new q(this.view.featuresTilingScheme)}),this.container.addChild(this._highlightView.container)),this.addAttachHandles([_(()=>this.layer.exportImageServiceParameters.version,e=>{e&&this._exportImageVersion!==e&&(this._exportImageVersion=e,this.requestUpdate())},l),_(()=>this.timeExtent,e=>{let{subview:t}=this;t&&(t.timeExtent=e,`redraw`in t?this.requestUpdate():t.redrawOrRefetch())},l),this.layer.on(`redraw`,()=>{let{subview:e}=this;e&&(`redraw`in e?e.redraw():e.redrawOrRefetch())}),_(()=>this.layer.renderer,()=>this._setSubView()),_(()=>this.view.highlights.items.map(({name:e,color:t})=>({name:e,color:t})),()=>this._updateHighlightOptions(this.subview))])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this.container.removeAllChildren(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null,this._highlightView?.destroy(),this._exportImageVersion=-1}viewChange(){}moveEnd(){this.requestUpdate()}highlight(e,t){if(e&&`pixelRanges`in e&&(!Array.isArray(e.pixelRanges)||e.pixelRanges.length))return this._highlightPixels(e,t);if(!((Array.isArray(e)?e[0]:g.isCollection(e)?e.at(0):e)instanceof w))return c();let n=[];if(Array.isArray(e)||g.isCollection(e)?n=e.map(e=>e.clone()):e instanceof w&&(n=[e.clone()]),!n?.filter(i)?.length)return c();let r=H(t);return this._addHighlightGraphics(n,r),c(()=>!this.destroyed&&this._removeHighlightGraphics(n,r))}_highlightPixels(e,t){let n={target:e,options:t};return this._pixelHighlights.push(n),this._updateHighlightOptions(this.subview),c(()=>{let e=this._pixelHighlights.indexOf(n);e>-1&&(this._pixelHighlights.splice(e,1),this._updateHighlightOptions(this.subview))})}_addHighlightGraphics(e,t){this._highlightGraphics.addMany(e),this._addHighlights(e.map(e=>e.uid),t)}_removeHighlightGraphics(e,t){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map(e=>e.uid),t)}async doRefresh(){this.requestUpdate()}isUpdating(){let e=!this.subview||this.subview.updating||!!this._highlightView?.updating;return v(`esri-2d-log-updating`)&&console.log(`Updating ImageryLayerView2D (${this.layer.id}): ${e}\n-> subview ${!this.subview||this.subview.updating}\n-> higlightView ${this._highlightView?.updating}\n`),e}_processHighlight(){let e=this._getHighlights();this._highlightView?.setHighlight(e)}_setSubView(){if(!this.view)return;let e=this.layer.renderer?.type,t=`imagery`;if(e===`vector-field`?t=`imageryVF`:e===`flow`&&(t=`flow`),this.subview){let{type:e}=this.subview;if(e===t)return this._attachSubview(this.subview),void(e===`flow`?this.subview.redrawOrRefetch():e===`imagery`&&this.layer.format===`lerc`?this.subview.redraw():this.requestUpdate());this._detachSubview(this.subview),this.subview?.destroy()}t===`imagery`?(this.subview=new J({layer:this.layer,view:this.view,timeExtent:this.timeExtent}),this._updateHighlightOptions(this.subview)):this.subview=t===`imageryVF`?new Z({layer:this.layer,view:this.view,timeExtent:this.timeExtent}):new G({layer:this.layer,layerView:this}),this._attachSubview(this.subview),this.requestUpdate()}_attachSubview(e){e&&!e.attached&&(e.attach(),e.attached=!0,this.container.addChildAt(e.container,0))}_detachSubview(e){e?.attached&&(this.container.removeChild(e.container),e.detach(),e.attached=!1)}_updateHighlightOptions(e){let t=this.view.highlights;this._pixelHighlights.sort((e,n)=>t.findIndex(({name:e})=>e===H(n.options))-t.findIndex(({name:t})=>t===H(e.options)));let n=this._pixelHighlights.map(({target:e,options:n})=>ee(e,t,n)).filter(i);e?.type===`imagery`&&(e.pixelHighlights=n,e.attached&&(this.layer.format===`lerc`?e.redraw():this.requestUpdate()))}};function ee(e,t,n){let r=H(n),i=(t.find(e=>e.name===r)?.color??a).toArray(),{pixelRanges:o}=e;if(Array.isArray(o))return{ranges:o,bandId:e.bandId??0,color:i};let s=o.type===`extent`?o:o.extent;if(!s)return;let c=[s.xmin,s.xmax],l=[s.ymin,s.ymax],{xBandId:u,yBandId:d}=e,f=1024,p=1024;return{xBandId:u,yBandId:d,xBandRange:c,yBandRange:l,color:i,width:f,height:p,xyMask:o.type===`polygon`?M({srcExtent:s,geometry:o,size:[f,p]}):void 0}}h([t()],$.prototype,`pixelData`,null),h([t()],$.prototype,`subview`,void 0),$=h([o(`esri.views.2d.layers.ImageryLayerView2D`)],$);var te=$;export{te as default};