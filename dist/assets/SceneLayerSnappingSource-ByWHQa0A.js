import{Aw as e,BT as t,ET as n,JE as r,TT as i,VE as a,VT as o,aT as s,kD as c,nE as l,pT as u,sD as d,wg as f,y_ as p}from"./index-BN8X5Ryz.js";import"./quatf64-D37SEdPg.js";import"./Indices-tJiSUK6w.js";import"./plane-Da5EsY0J.js";import"./vectorStacks-Cuo89CNO.js";import"./deduplicate-D-tDe87s.js";import"./BufferView-BW77W5ev.js";import"./Util-BQgFCZvD.js";import"./types-BEunqM4i.js";import"./dehydratedPoint-CWZQBefp.js";import"./memoize-Dl61_jt0.js";import"./elevationInfoUtils-uoMH3ofe.js";import{t as m}from"./WorkerHandle-CqB02i91.js";import"./ObjectStack-l5kM7JZu.js";import"./ray-LkJ58wpZ.js";import"./VertexAttributeLocations-BScEla0R.js";import"./VertexElementDescriptor-Cl_nC_ty.js";import"./geodesicUtils-D99LxQ6q.js";import{g as h,l as g}from"./LineSnappingHint-CmFAetWF.js";import"./vec3-B94Y7ih2.js";import"./sphere-d9-4vNcj.js";import"./constraints-Ch5tsKD8.js";import"./SnappingCandidate-DueCLuvH.js";import{t as _}from"./EdgeSnappingCandidate-CCg5Xb97.js";import"./PointSnappingHint-F2JtYtXH.js";import"./FloatArray-Dt98pDp2.js";import"./TextureBackedBufferLayout-C3PSJOOo.js";import"./Normals-B0YlgMdD.js";import{t as v}from"./workerHelper-DL2pDLjw.js";import{n as y}from"./edgeProcessing-BiG5KLu5.js";import{t as b}from"./VertexSnappingCandidate-DgxoZtvD.js";var x=class extends m{constructor(e){super(`EdgeProcessingWorker`,`extract`,{extract:e=>[e.dataBuffer],extractComponentsEdgeLocations:e=>[e.dataBuffer],extractEdgeLocations:e=>[e.dataBuffer]},e)}async process(e,t,n){return n?y(e):S(await this.invoke(new C(e),t))}async extractEdgeLocations(e,t){let n=await this.invokeMethod(`extractEdgeLocations`,new C(e),t);return v(n)}async extractComponentsEdgeLocations(e,t){let n=await this.invokeMethod(`extractComponentsEdgeLocations`,new C(e),t);return v(n)}};function S(e){return{regular:{instancesData:v(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:v(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}var C=class{constructor(e){this.dataBuffer=e.data.buffer,this.writerSettings=e.writerSettings,this.skipDeduplicate=e.skipDeduplicate,this.indices=r(e.indices)?e.indices.buffer:e.indices,this.indicesType=r(e.indices)?a(e.indices)?`Uint32Array`:`Uint16Array`:`Array`,this.indicesLength=e.indicesLength}},w=class extends e{constructor(e){super(e),this.availability=0,this._ids=new Set}destroy(){this._workerHandle.destroy(),this._workerHandle=null}initialize(){this._workerHandle=new T(this.schedule,{fetchAllEdgeLocations:(e,t)=>this._fetchAllEdgeLocations(e,t)})}async fetchCandidates(e,t){let n=e.coordinateHelper,{point:r}=e,i=p();if(!this.renderCoordsHelper.toRenderCoords(r,n.spatialReference,i))return[];let a=e.distance,o=typeof a==`number`?a:a.distance,s=await this._workerHandle.invoke({mbsJSON:{center:i,radius:o},returnEdge:e.returnEdge,returnVertex:e.vertexMode!==`none`},t);return s.candidates.sort((e,t)=>e.distance-t.distance),s.candidates.map(e=>this._convertCandidate(n,e))}async add(e,t){this._ids.add(e.id),await this._workerHandle.invokeMethod(`add`,e,t)}async remove(e,t){this._ids.delete(e.id),await this._workerHandle.invokeMethod(`remove`,e,t)}_convertCandidate(e,t){switch(t.type){case`edge`:return new _({objectId:t.objectId,targetPoint:h(this._convertRenderCoordinate(e,t.target)),edgeStart:this._convertRenderCoordinate(e,t.start),edgeEnd:this._convertRenderCoordinate(e,t.end),isDraped:!1});case`vertex`:return new b({objectId:t.objectId,targetPoint:h(this._convertRenderCoordinate(e,t.target)),isDraped:!1})}}_convertRenderCoordinate({spatialReference:e},t){let n=p();return this.renderCoordsHelper.fromRenderCoords(t,n,e),g(n)}async _fetchAllEdgeLocations(e,t){let n=[],r=[];for(let{id:i,uid:a}of e.components)this._ids.has(i)&&n.push((async()=>{let e=await this.fetchEdgeLocations(i,t.signal),n=e.locations.buffer;return r.push(n),{id:i,uid:a,objectIds:e.objectIds,locations:n,origin:e.origin,type:e.type}})());return{result:{components:(await Promise.all(n)).filter(({id:e})=>this._ids.has(e))},transferList:r}}};c([t({constructOnly:!0})],w.prototype,`renderCoordsHelper`,void 0),c([t({constructOnly:!0})],w.prototype,`fetchEdgeLocations`,void 0),c([t({constructOnly:!0})],w.prototype,`schedule`,void 0),c([t({readOnly:!0})],w.prototype,`availability`,void 0),w=c([o(`esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorkerHandle`)],w);var T=class extends m{constructor(e,t){super(`SceneLayerSnappingSourceWorker`,`fetchCandidates`,{},e,{strategy:`dedicated`,client:t})}},E=class extends e{get updating(){return this._updatingHandles.updating}constructor(e){super(e),this.availability=1,this._updatingHandles=new f,this._abortController=new AbortController}destroy(){this._tracker=n(this._tracker),this._abortController=i(this._abortController),this._updatingHandles.destroy()}initialize(){let{view:e}=this,t=e.resourceController;this._edgeWorker=new x(D(t)),this._workerHandle=new w({renderCoordsHelper:this.view.renderCoordsHelper,schedule:D(t),fetchEdgeLocations:async(e,t)=>{if(this._tracker==null)throw Error(`tracker-not-initialized`);return this._tracker.fetchEdgeLocations(e,this._edgeWorker,t)}}),this._updatingHandles.addPromise(this._setupLayerView()),this.addHandles([l(this._workerHandle),l(this._edgeWorker)])}async fetchCandidates(e,t){return this._workerHandle.fetchCandidates(e,t)}refresh(){}async _setupLayerView(){if(this.destroyed)return;let e=this._abortController?.signal,t=await this.getLayerView();t==null||s(e)||(this._tracker=t.trackSnappingSources({add:(t,n)=>{this._updatingHandles.addPromise(this._workerHandle.add({id:t,bounds:n.toJSON()},e))},remove:t=>{this._updatingHandles.addPromise(this._workerHandle.remove({id:t},e))}}))}};function D(e){return t=>e.immediate.schedule(t)}c([t({constructOnly:!0})],E.prototype,`getLayerView`,void 0),c([t({constructOnly:!0})],E.prototype,`view`,void 0),c([t({readOnly:!0})],E.prototype,`updating`,null),c([t({readOnly:!0})],E.prototype,`availability`,void 0),E=c([o(`esri.views.interactive.snapping.featureSources.I3SSnappingSource`)],E);var O=class extends e{get updating(){return this._i3sSources.some(e=>e.updating)}constructor(e){super(e),this.availability=1,this._i3sSources=[]}destroy(){this._i3sSources.forEach(e=>e.destroy()),this._i3sSources.length=0}initialize(){let{view:e}=this,t=this.layerSource.layer;this._i3sSources=t.type===`building-scene`?this._getBuildingSceneI3SSources(e,t):[this._getSceneLayerI3SSource(e,t)]}async fetchCandidates(e,t){let n=await Promise.all(this._i3sSources.map(n=>n.fetchCandidates(e,t)));return u(t),n.flat()}refresh(){this._i3sSources.forEach(e=>e.refresh())}_getBuildingSceneI3SSources(e,t){return t.allSublayers.toArray().map(n=>n.type===`building-component`?new E({getLayerView:async()=>(await e.whenLayerView(t)).whenSublayerView(n),view:e}):null).filter(d)}_getSceneLayerI3SSource(e,t){return new E({getLayerView:async()=>{let n=await e.whenLayerView(t);return n.type===`scene-layer-graphics-3d`?void 0:n},view:e})}};c([t({constructOnly:!0})],O.prototype,`layerSource`,void 0),c([t({constructOnly:!0})],O.prototype,`view`,void 0),c([t({readOnly:!0})],O.prototype,`updating`,null),c([t({readOnly:!0})],O.prototype,`availability`,void 0),O=c([o(`esri.views.interactive.snapping.featureSources.SceneLayerSnappingSource`)],O);export{O as SceneLayerSnappingSource};