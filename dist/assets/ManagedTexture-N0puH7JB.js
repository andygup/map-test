import{BE as e,BS as t,BT as n,FE as r,Fs as i,IC as a,IE as o,LS as s,TC as c,eT as l,gT as u,gs as d,nC as f,nT as p,ov as m,pT as h,tT as ee,uE as te,vs as ne,xs as re,ys as g,yw as _}from"./index-CzMixifc.js";import{a as v}from"./Util-YNFIi00s.js";import{t as y}from"./videoUtils-CDhtaJ_j.js";import{t as b}from"./image-CSnYJraV.js";function x(){return S??=(async()=>{let e=await t(()=>import(`./basis_transcoder-DBNqfAkK.js`),[]),n=await e.default({locateFile:e=>s(`esri/libs/basisu/${e}`)});return n.initializeBasis(),n})(),S}var S,C=null,w=null;async function T(){return w??(w=x(),C=await w),w}function ie(e,t){if(C==null)return e.byteLength;let n=new C.BasisFile(new Uint8Array(e)),r=O(n)?D(n.getNumLevels(0),n.getHasAlpha(),n.getImageWidth(0,0),n.getImageHeight(0,0),t):0;return n.close(),n.delete(),r}function E(e,t){if(C==null)return e.byteLength;let n=new C.KTX2File(new Uint8Array(e)),r=k(n)?D(n.getLevels(),n.getHasAlpha(),n.getWidth(),n.getHeight(),t):0;return n.close(),n.delete(),r}function D(e,t,n,r,a){let o=g(t?i.COMPRESSED_RGBA8_ETC2_EAC:i.COMPRESSED_RGB8_ETC2),s=a&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(n*r*o*s)}function O(e){return e.getNumImages()>=1&&!e.isUASTC()}function k(e){return e.getFaces()>=1&&e.isETC1S()}async function A(e,t,n){C??=await T();let r=new C.BasisFile(new Uint8Array(n));if(!O(r))return null;r.startTranscoding();let i=M(e,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(e,t)=>r.getImageTranscodedSizeInBytes(0,e,t),(e,t,n)=>r.transcodeImage(n,0,e,t,0,0));return r.close(),r.delete(),i}async function j(e,t,n){C??=await T();let r=new C.KTX2File(new Uint8Array(n));if(!k(r))return null;r.startTranscoding();let i=M(e,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(e,t)=>r.getImageTranscodedSizeInBytes(e,0,0,t),(e,t,n)=>r.transcodeImage(n,e,0,0,t,0,-1,-1));return r.close(),r.delete(),i}function M(e,t,n,r,a,o,s,c){let{compressedTextureETC:l,compressedTextureS3TC:u}=e.capabilities,[f,p]=l?r?[1,i.COMPRESSED_RGBA8_ETC2_EAC]:[0,i.COMPRESSED_RGB8_ETC2]:u?r?[3,i.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[2,i.COMPRESSED_RGB_S3TC_DXT1_EXT]:[13,6408],m=t.hasMipmap?n:Math.min(1,n),h=[];for(let e=0;e<m;e++)h.push(new Uint8Array(s(e,f))),c(e,f,h[e]);return t.internalFormat=p,t.hasMipmap=h.length>1,t.samplingMode=t.hasMipmap?9987:9729,t.width=a,t.height=o,new d(e,t,{type:`compressed`,levels:h})}var N=()=>te.getLogger(`esri.views.3d.webgl-engine.lib.DDSUtil`),P=542327876,F=131072,I=4;function L(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function R(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}var z=L(`DXT1`),B=L(`DXT3`),V=L(`DXT5`),ae=31,H=0,U=1,W=2,G=3,K=4,q=7,J=20,oe=21;function se(e,t,n){let r=ce(n,t.hasMipmap??!1);if(r==null)throw Error(`DDS texture data is null`);let{textureData:i,internalFormat:a,width:o,height:s}=r;return t.samplingMode=i.levels.length>1?9987:9729,t.hasMipmap=i.levels.length>1,t.internalFormat=a,t.width=o,t.height=s,new d(e,t,i)}function ce(e,t){let n=new Int32Array(e.buffer,e.byteOffset,ae);if(n[H]!==P)return N().error(`Invalid magic number in DDS header`),null;if(!(n[J]&I))return N().error(`Unsupported format, must contain a FourCC code`),null;let r=n[oe],a,o;switch(r){case z:a=8,o=i.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case B:a=16,o=i.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case V:a=16,o=i.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return N().error(`Unsupported FourCC code:`,R(r)),null}let s=1,c=n[K],l=n[G];(3&c||3&l)&&(N().warn(`Rounding up compressed texture size to nearest multiple of 4.`),c=c+3&-4,l=l+3&-4);let u=c,d=l,f,p;n[W]&F&&!1!==t&&(s=Math.max(1,n[q]));let m=e.byteOffset+n[U]+4,h=[];for(let t=0;t<s;++t)p=(c+3>>2)*(l+3>>2)*a,f=new Uint8Array(e.buffer,m,p),h.push(f),m+=p,c=Math.max(1,c>>1),l=Math.max(1,l>>1);return{textureData:{type:`compressed`,levels:h},internalFormat:o,width:u,height:d}}var Y=16;function X(e,t){return t=Math.floor(t/Y)*Y,Math.min(Math.round(e/Y)*Y,t)}function Z(e,t){return t=Math.floor(t/Y)*Y,Math.min(Math.ceil(e/Y)*Y,t)}function le(e,t){let[n,r]=ue(e,t);return e.width===n&&e.height===r?e:Q(e,n,r)}function ue({width:e,height:t},{maxPreferredTexturePixels:n,maxTextureSize:r}){let i=Math.max(e,t),a=e*t;if(i<=r&&a<=n)return[e,t];let o=Math.min(Math.sqrt(n/a),r/i);return[X(Math.round(e*o),r),X(Math.round(t*o),r)]}function Q(e,t,n){if(e instanceof ImageData)return Q(de(e),t,n);let r=document.createElement(`canvas`);return r.width=t,r.height=n,r.getContext(`2d`).drawImage(e,0,0,r.width,r.height),r}function de(e){let t=document.createElement(`canvas`);t.width=e.width,t.height=e.height;let r=t.getContext(`2d`);if(r==null)throw new n(`texture:context-failed`,`Failed to create 2d context from HTMLCanvasElement`);return r.putImageData(e,0,0),t}var fe=class{constructor(e,t){this._data=e,this.id=_(),this.events=new m,this._parameters={...me,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(e){e instanceof HTMLVideoElement?(this.update=t=>this._update(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e)}_startPreloadVideoElement(e){if(!(c(e.src)||e.preload===`auto`&&e.crossOrigin)&&(e.preload=`auto`,e.crossOrigin=`anonymous`,e.src=e.src,e.paused&&e.autoplay)){let t=[];y(e,e=>t.push(e)).then(()=>{e.play()}).finally(()=>t.forEach(e=>e.remove()))}}_startPreloadImageElement(e){a(e.src)||c(e.src)||e.crossOrigin||(e.crossOrigin=`anonymous`,e.src=e.src)}_createDescriptor(e){let t=new ne;return t.wrapMode=this._parameters.wrap??10497,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?9987:9729,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t.dataType=this._parameters.dataType??t.dataType,t.pixelFormat=this._parameters.pixelFormat??t.pixelFormat,t.internalFormat=this._parameters.internalFormat??t.internalFormat,t}get texture(){return this._texture??this._emptyTexture}get loaded(){return this._texture!=null}get usedMemory(){return this._texture?.usedMemory||pe(this._data,this._parameters)}load(t){if(this._loadingPromise)return this._loadingPromise;if(this._texture)return this._texture;let n=this._data;return n==null?(this._texture=new d(t,this._createDescriptor(t),null),this._texture):(this._emptyTexture=t.emptyTexture,this._parameters.reloadable||(this._data=void 0),typeof n==`string`?this._loadFromURL(t,n):n instanceof Image?this._loadFromImageElement(t,n):n instanceof HTMLVideoElement?this._loadFromVideoElement(t,n):n instanceof ImageData||n instanceof HTMLCanvasElement?this._loadFromImage(t,n):e(n)&&this._parameters.encoding===`image/vnd-ms.dds`?this._loadFromDDSData(t,n):o(n)&&this._parameters.encoding===`image/vnd-ms.dds`?this._loadFromDDSData(t,new Uint8Array(n)):(o(n)||e(n))&&this._parameters.encoding===`image/ktx2`?this._loadFromKTX2(t,n):(o(n)||e(n))&&this._parameters.encoding===`image/x.basis`?this._loadFromBasis(t,n):o(n)?this._loadFromPixelData(t,new Uint8Array(n)):r(n)?this._loadFromPixelData(t,n):null)}_update(e,t){return this._texture==null||e.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._texture.setData(e),this._texture.descriptor.hasMipmap&&this._texture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._texture=se(e,this._createDescriptor(e),t),this._emptyTexture=null,this._texture}_loadFromKTX2(e,t){return this._loadAsync(()=>j(e,this._createDescriptor(e),t).then(e=>(this._texture=e,e)))}_loadFromBasis(e,t){return this._loadAsync(()=>A(e,this._createDescriptor(e),t).then(e=>(this._texture=e,e)))}_loadFromPixelData(e,t){v(this._parameters.width>0&&this._parameters.height>0);let n=this._createDescriptor(e);return n.pixelFormat!==6407&&n.pixelFormat!==6408||(n.compress=this._parameters.compressionOptions),n.width=this._parameters.width??0,n.height=this._parameters.height??0,this._texture=new d(e,n,t),this._texture}_loadFromURL(e,t){return this._loadAsync(async n=>{let r=await b(t,{signal:n});return l(n),this._loadFromImage(e,r)})}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync(async n=>{let r=await f(t,t.src,!1,n);return l(n),this._loadFromImage(e,r)})}_loadFromVideoElement(e,t){return t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync(r=>new Promise((i,a)=>{let o=()=>{t.removeEventListener(`loadeddata`,s),t.removeEventListener(`error`,c),h(l)},s=()=>{t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(o(),i(this._loadFromImage(e,t)))},c=e=>{o(),a(e||new n(`texture:load-error`,`Failed to load video`))};t.addEventListener(`loadeddata`,s),t.addEventListener(`error`,c);let l=p(r,()=>c(ee()))}))}_loadFromImage(e,t){let n=t;n instanceof HTMLVideoElement||(n=le(n,e.parameters));let r=$(n);this._parameters.width=r.width,this._parameters.height=r.height;let i=this._createDescriptor(e);return i.width=r.width,i.height=r.height,i.compress=this._parameters.compressionOptions,this._texture=new d(e,i,n),this._emptyTexture=null,this.events.emit(`loaded`),this._texture}_loadAsync(e){let t=new AbortController;this._loadingController=t;let n=e(t.signal);this._loadingPromise=n;let r=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===n&&(this._loadingPromise=null),this._emptyTexture=null};return n.then(r,r),n}unload(){if(this._texture=u(this._texture),this._emptyTexture=null,this._loadingController!=null){let e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit(`unloaded`)}get parameters(){return this._parameters}};function pe(t,n){if(t==null)return 0;if(o(t)||e(t))return n.encoding===`image/ktx2`?E(t,!!n.mipmap):n.encoding===`image/x.basis`?ie(t,!!n.mipmap):t.byteLength;let{width:r,height:i}=t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?$(t):n,a=n.pixelFormat??6408,s=re(a);return(n.mipmap?4/3:1)*r*i*s||0}function $(e){return e instanceof HTMLVideoElement?{width:e.videoWidth,height:e.videoHeight}:e}var me={wrap:{s:10497,t:10497},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};export{X as n,Z as r,fe as t};