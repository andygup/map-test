const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WhereClause-C5M56jdd.js","assets/WhereClause-2gh-KjwG.js","assets/index-CzMixifc.js","assets/index-CDgdHpAj.css"])))=>i.map(i=>d[i]);
import{BS as e,DT as t,Ed as n,Gl as r,Hw as i,JE as a,Jp as o,Ld as s,OT as c,Od as l,Ol as u,Pd as ee,Q_ as d,Rd as te,UT as f,Vd as ne,WT as p,Xb as m,Z_ as h,Zb as g,_v as _,_w as v,bg as y,c_ as b,dg as re,eT as x,ev as S,fT as ie,gD as C,iv as ae,kd as oe,kv as se,lw as w,nv as T,pg as E,px as ce,rT as D,rh as O,rv as k,tD as le,tx as A,vd as j,xg as M,xh as N,yg as P}from"./index-CzMixifc.js";import"./quatf64-eO7UAs9K.js";import"./plane--nqwMDYx.js";import"./vectorStacks-BQiry9fn.js";import{n as F}from"./dehydratedPoint-CVzHYxaL.js";import{r as I}from"./layerViewUtils-Cbrog-dU.js";import{S as L,a as R}from"./elevationInfoUtils-BcUBf70F.js";import{t as z}from"./WorkerHandle-CebpJ7hn.js";import"./ObjectStack-DiVLRoBj.js";import"./ray-XqUMyuyU.js";import"./geodesicUtils-DoIAZh7n.js";import"./LineSnappingHint-C4TfMb_L.js";import{c as B}from"./snappingUtils-BVQZFw4z.js";import"./vec3-D7a6REBc.js";import"./sphere-DkSdrT5o.js";import"./constraints-CZ12pnWC.js";import"./SnappingCandidate-CgOYxD9J.js";import"./EdgeSnappingCandidate-CRqUhTG1.js";import"./DrapedEdgeSnappingCandidate-yTm_e8W9.js";import"./lineSegment-WEn1ku7V.js";import"./PointSnappingHint-BIIZt5I0.js";import{n as V,s as H,t as U}from"./boundedPlane-BwWy0U6o.js";import"./VertexSnappingCandidate-C4r-KIir.js";import{n as ue,t as de}from"./queryEngineUtils-DJ2es_bo.js";function W(e,t){return U(t.extent,G),H(G,u(fe,e.x,e.y,0))}var G=V(),fe=b(),K=class extends v{get tiles(){let e=this.tilesCoveringView,t=this.pointOfInterest==null?this.view.center:this.pointOfInterest;return e.sort((e,n)=>W(t,e)-W(t,n)),e}_scaleEnabled(){return I(this.view.scale,this.layer.minScale||0,this.layer.maxScale||0)}get tilesCoveringView(){if(!this.view.ready||!this.view.featuresTilingScheme||!this.view.state||this.tileInfo==null||!this._scaleEnabled)return[];let{spans:e,lodInfo:t}=this.view.featuresTilingScheme.getTileCoverage(this.view.state,0),{level:n}=t,r=[];for(let{row:i,colFrom:a,colTo:o}of e)for(let e=a;e<=o;e++){let a=t.normalizeCol(e),o=new y(n,i,a);this.tileInfo.updateTileInfo(o),r.push(o)}return r}get tileInfo(){return this.view.featuresTilingScheme?.tileInfo??null}get tileSize(){return this.tileInfo==null?256:this.tileInfo.size[0]}constructor(e){super(e),this.pointOfInterest=null,this.updating=!1}initialize(){this.addHandles(T(()=>this.view?.state?.viewpoint,()=>this.notifyChange(`tilesCoveringView`),h))}};C([t({readOnly:!0})],K.prototype,`tiles`,null),C([t({readOnly:!0})],K.prototype,`_scaleEnabled`,null),C([t({readOnly:!0})],K.prototype,`tilesCoveringView`,null),C([t({readOnly:!0})],K.prototype,`tileInfo`,null),C([t({readOnly:!0})],K.prototype,`tileSize`,null),C([t({constructOnly:!0})],K.prototype,`view`,void 0),C([t({constructOnly:!0})],K.prototype,`layer`,void 0),C([t()],K.prototype,`pointOfInterest`,void 0),C([t()],K.prototype,`updating`,void 0),K=C([c(`esri.views.2d.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles2D`)],K);var q=class extends v{get _sortedTilesCoveringView(){let e=(this.view.featureTiles?.tiles?.toArray()??[]).map(pe),t=this._effectivePointOfInterest;return t!=null&&e.sort((e,n)=>W(t,e)-W(t,n)),e}get tileInfo(){return this.view.featureTiles?.tilingScheme?.toTileInfo()??null}get tileSize(){return this.view.featureTiles?.tileSize??256}get _effectivePointOfInterest(){return this.pointOfInterest??this.view.pointsOfInterest?.focus.location}get updating(){return!this.view.featureTiles}constructor(e){super(e),this.tiles=[],this.pointOfInterest=null}initialize(){this.addHandles([this.view.enableFeatureTiles(),T(()=>this._sortedTilesCoveringView,e=>this._set(`tiles`,e),{initial:!0,equals:(e,t)=>le(e,t,(e,t)=>e.id===t.id)})])}};function pe({lij:[e,t,n],extent:r}){return new y(e,t,n,r??A())}C([t({readOnly:!0})],q.prototype,`tiles`,void 0),C([t({readOnly:!0})],q.prototype,`_sortedTilesCoveringView`,null),C([t({readOnly:!0})],q.prototype,`tileInfo`,null),C([t({readOnly:!0})],q.prototype,`tileSize`,null),C([t({constructOnly:!0})],q.prototype,`view`,void 0),C([t()],q.prototype,`pointOfInterest`,void 0),C([t()],q.prototype,`_effectivePointOfInterest`,null),C([t()],q.prototype,`updating`,null),q=C([c(`esri.views.3d.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles3D`)],q);var me=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]],J=class extends v{constructor(e){super(e),this.updating=!1,this.enablePolygons=!0,this.enableLabels=!0,this._polygons=new Map,this._labels=new Map,this._symbols=me.map(e=>new l({color:[e[0],e[1],e[2],.6],outline:{color:`black`,width:1}})),this._enabled=!0}initialize(){this.update()}destroy(){this._enabled=!1,this.clear()}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.update())}getLabel(e){if(e.label!=null)return e.label;let t=e.lij.toString();return e.loadPriority!=null&&(t+=` (${e.loadPriority})`),e.measures&&(t+=`[${e.measures.lodLevel}]`),t}update(){if(!this._enabled)return void this.clear();let e=this.getTiles(),t=[],r=new Set(this._labels.size>0?this._labels.keys():this._polygons.keys());e.forEach((i,a)=>{let o=i.lij.toString();r.delete(o);let c=i.measures?.lodLevel??i.level,l=i.geometry;if(this.enablePolygons&&!this._polygons.has(o)){let e=i.polygonSymbol??this._symbols[c%this._symbols.length],n=new j({geometry:l,symbol:e});this._polygons.set(o,n),t.push(n)}if(this.enableLabels){let r=this.getLabel(i),c=a/(e.length-1),u=w(0,200,c),d=w(20,6,c)/.75,f=i.loadPriority!=null&&i.loadPriority>=e.length,p=new O([u,f?0:u,f?0:u]),m=this.view.type===`3d`?()=>new oe({verticalOffset:new ee({screenLength:40/.75}),callout:new s({color:new O(`white`),border:new te({color:new O(`black`)})}),symbolLayers:new ae([new ne({text:r,halo:{color:`white`,size:1/.75},material:{color:p},size:d})])}):()=>new n({text:r,haloColor:`white`,haloSize:1/.75,color:p,size:d}),h=this._labels.get(o);if(h){let e=m();h.symbol!=null&&JSON.stringify(e)===JSON.stringify(h.symbol)||(h.symbol=e)}else{let e=new j({geometry:l.extent.center,symbol:m()});this._labels.set(o,e),t.push(e)}}});let i=[];r.forEach(e=>{let t=this._polygons.get(e);t!=null&&(i.push(t),this._polygons.delete(e));let n=this._labels.get(e);n!=null&&(i.push(n),this._labels.delete(e))}),this.view.graphics.removeMany(i),this.view.graphics.addMany(t)}clear(){this.view.graphics.removeMany(Array.from(this._polygons.values())),this.view.graphics.removeMany(Array.from(this._labels.values())),this._polygons.clear(),this._labels.clear()}};C([t({constructOnly:!0})],J.prototype,`view`,void 0),C([t({readOnly:!0})],J.prototype,`updating`,void 0),C([t()],J.prototype,`enabled`,null),J=C([c(`esri.views.support.TileTreeDebugger`)],J);var Y=class extends J{constructor(e){super(e)}initialize(){let e=setInterval(()=>this._fetchDebugInfo(),2e3);this.addHandles(p(()=>clearInterval(e)))}getTiles(){if(!this._debugInfo)return[];let e=new Map,t=new Map;this._debugInfo.storedTiles.forEach(t=>e.set(y.fromJSON(t.key).id,t.featureCount)),this._debugInfo.pendingTiles.forEach(n=>{e.set(n.key.id,n.featureCount),t.set(n.key.id,n.state)});let n=n=>{let r=t.get(n),i=e.get(n)??`?`;return r?`${r}:${i}\n${n}`:`store:${i}\n${n}`},r=new Map;return this._debugInfo.storedTiles.forEach(e=>{let t=y.fromJSON(e.key);r.set(t.id,t)}),this._debugInfo.pendingTiles.forEach(e=>{r.set(e.key.id,e.key)}),Array.from(r.values()).map(e=>({lij:[e.level,e.row,e.col],level:e.level,geometry:se.fromExtent(m(e.extent,this.view.spatialReference)),label:n(e.id)}))}_fetchDebugInfo(){this.handle.getDebugInfo(null).then(e=>{this._debugInfo=e,this.update()})}};C([t({constructOnly:!0})],Y.prototype,`handle`,void 0),Y=C([c(`esri.views.interactive.snapping.featureSources.WorkerTileTreeDebugger`)],Y);var X=class extends v{get updating(){return this._updatingHandles.updating||this._workerHandleUpdating}constructor(e){super(e),this._updatingHandles=new E,this._suspendController=null,this.schedule=null,this.hasZ=!1,this.elevationAlignPointsInFeatures=async e=>{let t=[];for(let{points:n}of e.pointsInFeatures)for(let{z:e}of n)t.push(e);return{elevations:t,drapedObjectIds:new Set,failedObjectIds:new Set}},this.queryForSymbologySnapping=async()=>({candidates:[],sourceCandidateIndices:[]}),this.availability=0,this._workerHandleUpdating=!0,this.updateOutFields=i(async(e,t)=>{await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`updateOutFields`,[...e],t)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`whenNotUpdating`,{},t))})}destroy(){this._suspendController=ie(this._suspendController),this._workerHandle.destroy(),this._updatingHandles.destroy()}initialize(){this._workerHandle=new ge(this.schedule,{alignElevation:async(e,{signal:t})=>({result:await this.elevationAlignPointsInFeatures(e.query,t)}),getSymbologyCandidates:async(e,{signal:t})=>({result:await this.queryForSymbologySnapping(e,t)})}),this.addHandles([this._workerHandle.on(`notify-updating`,({updating:e})=>this._workerHandleUpdating=e),this._workerHandle.on(`notify-availability`,({availability:e})=>this._set(`availability`,e))])}async setup(e,t){let n=he(e.layer);if(n==null)return;let r={configuration:Z(e.configuration),serviceInfo:n,spatialReference:e.spatialReference.toJSON(),hasZ:this.hasZ,elevationInfo:e.layer.elevationInfo?.toJSON()};await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`setup`,r,t)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`whenNotUpdating`,{},t))}async configure(e,t){let n=Z(e);await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`configure`,n,t)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`whenNotUpdating`,{},t))}async refresh(e){await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`refresh`,{},e)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`whenNotUpdating`,{},e))}async fetchCandidates(e,t){let{point:n,filter:r,coordinateHelper:i}=e,a={...e,point:F(n[0],n[1],n[2],i.spatialReference.toJSON()),filter:r?.toJSON()};return this._workerHandle.invoke(a,t)}async updateTiles(e,t){let n={tiles:e.tiles.map(e=>e.toJSON()),tileInfo:e.tileInfo==null?null:e.tileInfo.toJSON(),tileSize:e.tileSize};await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`updateTiles`,n,t)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`whenNotUpdating`,{},t))}async handleEdits({historicMoment:e,addedFeatures:t,deletedFeatures:n,updatedFeatures:r},i){let o={historicMoment:e,addedFeatures:t?.map(({objectId:e})=>e).filter(a)??[],deletedFeatures:n?.map(({objectId:e,globalId:t})=>({objectId:e,globalId:t}))??[],updatedFeatures:r?.map(({objectId:e})=>e).filter(a)??[]};await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`handleEdits`,o,i)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`whenNotUpdating`,{},i))}async setHistoricMoment(e,t){await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`setHistoricMoment`,{moment:e},t))}getDebugInfo(e){return this._workerHandle.invokeMethod(`getDebugInfo`,{},e)}async notifyElevationSourceChange(){await this._workerHandle.invokeMethod(`notifyElevationSourceChange`,{})}async notifySymbologyChange(){await this._workerHandle.invokeMethod(`notifySymbologyChange`,{})}async setSymbologySnappingSupported(e){await this._workerHandle.invokeMethod(`setSymbologySnappingSupported`,e)}async setSuspended(e){this._suspendController?.abort(),this._suspendController=new AbortController,await this._updatingHandles.addPromise(this._workerHandle.invokeMethod(`setSuspended`,e,this._suspendController.signal))}};function Z(e){return{filter:e.filter==null?null:e.filter.toJSON(),customParameters:e.customParameters,viewType:e.viewType}}function he(e){return e.geometryType===`multipatch`||e.geometryType===`mesh`?null:{url:e.parsedUrl?.path??``,fieldsIndex:e.fieldsIndex.toJSON(),geometryType:_.toJSON(e.geometryType),capabilities:e.capabilities,objectIdField:e.objectIdField,globalIdField:e.globalIdField,spatialReference:e.spatialReference.toJSON(),timeInfo:e.timeInfo?.toJSON()}}C([t({constructOnly:!0})],X.prototype,`schedule`,void 0),C([t({constructOnly:!0})],X.prototype,`hasZ`,void 0),C([t({constructOnly:!0})],X.prototype,`elevationAlignPointsInFeatures`,void 0),C([t({constructOnly:!0})],X.prototype,`queryForSymbologySnapping`,void 0),C([t({readOnly:!0})],X.prototype,`updating`,null),C([t({readOnly:!0})],X.prototype,`availability`,void 0),C([t()],X.prototype,`_workerHandleUpdating`,void 0),X=C([c(`esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorkerHandle`)],X);var ge=class extends z{constructor(e,t){super(`FeatureServiceSnappingSourceWorker`,`fetchCandidates`,{},e,{strategy:`dedicated`,client:t})}},Q=class extends v{get tiles(){return[new y(0,0,0,g(-1e8,-1e8,1e8,1e8))]}get tileInfo(){return new P({origin:new ce({x:-1e8,y:1e8,spatialReference:this.layer.spatialReference}),size:[512,512],lods:[new M({level:0,scale:1,resolution:390625})],spatialReference:this.layer.spatialReference})}get tileSize(){return this.tileInfo.size[0]}constructor(e){super(e),this.pointOfInterest=null,this.updating=!1}};C([t({readOnly:!0})],Q.prototype,`tiles`,null),C([t({readOnly:!0})],Q.prototype,`tileInfo`,null),C([t({readOnly:!0})],Q.prototype,`tileSize`,null),C([t({constructOnly:!0})],Q.prototype,`layer`,void 0),C([t()],Q.prototype,`pointOfInterest`,void 0),C([t()],Q.prototype,`updating`,void 0),Q=C([c(`esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTilesSimple`)],Q);var $=class extends v{get _updateTilesParameters(){return{tiles:this._tilesOfInterest.tiles,tileInfo:this._tilesOfInterest.tileInfo,tileSize:this._tilesOfInterest.tileSize}}get _layerView(){return this.view?.allLayerViews.find(e=>e.layer===this._layer)}get _isSuspended(){return N(this._layer)&&!this.layerSource.sublayerSources.some(e=>e.enabled&&e.layer.visible)?!0:this._snappingComplexityExceeded||!!this.view&&(!1!==this._layerView?.suspended||!this.layerSource.enabled)}get _snappingComplexityExceeded(){return!(!this._layerView||!(`snappingComplexityExceeded`in this._layerView))&&this._layerView.snappingComplexityExceeded}get updating(){return this._workerHandle?.updating||this._updatingHandles.updating||this._tilesOfInterest.updating}get _outFields(){let{view:e,_layerView:t,layerSource:n}=this,{layer:r}=n,{fieldsIndex:i,timeInfo:a,floorInfo:o,subtypeField:s}=r,c=t&&`filter`in t?t.filter:null,l=c?.where&&c.where!==`1=1`?this._getOrLoadWhereFields(c.where,i):[];if(c?.timeExtent&&a){let{startField:e,endField:t}=a,n=i.get(e)?.name??e,r=i.get(t)?.name??t;n&&l.push(n),r&&l.push(r)}if(e?.map&&B(e.map)&&e.map.utilityNetworks?.find(e=>e.isUtilityLayer(r))){let e=r.fieldsIndex.get(`assetGroup`)?.name,t=r.fieldsIndex.get(`assetType`)?.name;e&&t&&(l.push(e),l.push(t))}if(r&&o?.floorField&&e?.floors?.length){let e=i.get(o.floorField)?.name??o.floorField;e&&l.push(e)}if(s){let e=i.get(s)?.name??s;e&&l.push(e)}return new Set(l)}get configuration(){let{view:e}=this,{apiKey:t,customParameters:n}=this._layer,r=e==null?`2d`:e.type,i=this._layer.createQuery();return this._layerView&&`effectiveDisplayFilter`in this._layerView&&(i.where=o(i.where,this._layerView.effectiveDisplayFilter?.where)),{filter:i,customParameters:t?{...n,token:t}:n,viewType:r}}get availability(){return this._workerHandle?.availability??0}get _layer(){return this.layerSource.layer}constructor(e){super(e),this._updatingHandles=new E,this._workerHandle=null,this._debug=null,this._memoizedMakeGetGroundElevation=L(de)}initialize(){let e,t=this.view;if(t==null||t.destroyed)this._tilesOfInterest=new Q({layer:this._layer}),e=this._workerHandle=new X;else switch(t.type){case`2d`:this._tilesOfInterest=new K({view:t,layer:this._layer}),e=this._workerHandle=new X;break;case`3d`:{let{resourceController:n}=t,r=this._layer;this._tilesOfInterest=new q({view:t}),e=this._workerHandle=new X({schedule:e=>n.immediate.schedule(e),hasZ:r.hasZ&&(r.returnZ??!0),elevationAlignPointsInFeatures:async(e,n)=>{let i=await t.whenLayerView(r);return x(n),i.elevationAlignPointsInFeatures(e,n)},queryForSymbologySnapping:async(e,n)=>{let i=await t.whenLayerView(r);return x(n),i.queryForSymbologySnapping(e,n)}}),this._updatingHandles.add(()=>r.elevationInfo,()=>D(e.notifyElevationSourceChange()),S),this._updatingHandles.add(()=>this._layerView?.layer?.renderer,()=>D(e.notifySymbologyChange()),S),this._updatingHandles.add(()=>this._layerView?.symbologySnappingSupported??!1,t=>D(e.setSymbologySnappingSupported(t)),S),this.addHandles([t.elevationProvider.on(`elevation-change`,({context:t})=>{let{elevationInfo:n}=r;R(t,n)&&D(e.notifyElevationSourceChange())}),d(()=>this._layerView?.layer,[`edits`,`apply-edits`,`graphic-update`],()=>e.notifySymbologyChange())]);break}}this.addHandles([f(e)]),D(e.setup({layer:this._layer,spatialReference:this.spatialReference,configuration:this.configuration},null)),this._updatingHandles.add(()=>this._updateTilesParameters,()=>D(e.updateTiles(this._updateTilesParameters,null)),S),this.addHandles([T(()=>this.configuration,t=>D(e.configure(t,null)),h),T(()=>this._layer.historicMoment,t=>D(e.setHistoricMoment(t)),k),T(()=>this._isSuspended,t=>D(e.setSuspended(t)),k)]),this._updatingHandles.add(()=>this._outFields,t=>D(e.updateOutFields(t)),S),t!=null&&this.addHandles(T(()=>r.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES,n=>{n&&!this._debug?(this._debug=new Y({view:t,handle:e}),this.addHandles(f(this._debug),`debug`)):!n&&this._debug&&this.removeHandles(`debug`)},S)),this.addHandles([this.layerSource.layer.on(`edits`,t=>D(e.handleEdits(t,null))),this.layerSource.layer.on(`apply-edits`,e=>this._updatingHandles.addPromise(e.result))])}destroy(){this._updatingHandles.destroy(),this._tilesOfInterest.destroy()}refresh(){this._workerHandle?.refresh(null)}async fetchCandidates(e,t){if(this._isSuspended)return[];let{coordinateHelper:n,point:r}=e;this._tilesOfInterest.pointOfInterest=n.arrayToPoint(r);let i=this._memoizedMakeGetGroundElevation(this.view,n.spatialReference);return(await this._workerHandle.fetchCandidates({...e},t)).candidates.map(e=>ue(e,i))}getDebugInfo(e){return this._workerHandle.getDebugInfo(e)}_getOrLoadWhereFields(t,n){let{_whereModule:r}=this;if(!this._loadWhereModuleTask&&!r){let t=re(async()=>(this._whereModule=(await e(()=>import(`./WhereClause-C5M56jdd.js`),__vite__mapDeps([0,1,2,3]))).default,this._whereModule));return this._loadWhereModuleTask=t,this._updatingHandles.addPromise(t.promise),[]}if(!r)return[];try{return r.create(t,{fieldsIndex:n}).fieldNames}catch{return[]}}};C([t({constructOnly:!0})],$.prototype,`spatialReference`,void 0),C([t({constructOnly:!0})],$.prototype,`layerSource`,void 0),C([t({constructOnly:!0})],$.prototype,`view`,void 0),C([t()],$.prototype,`_tilesOfInterest`,void 0),C([t({readOnly:!0})],$.prototype,`_updateTilesParameters`,null),C([t()],$.prototype,`_layerView`,null),C([t()],$.prototype,`_isSuspended`,null),C([t()],$.prototype,`_snappingComplexityExceeded`,null),C([t({readOnly:!0})],$.prototype,`updating`,null),C([t()],$.prototype,`_outFields`,null),C([t({readOnly:!0})],$.prototype,`configuration`,null),C([t({readOnly:!0})],$.prototype,`availability`,null),C([t()],$.prototype,`_loadWhereModuleTask`,void 0),C([t()],$.prototype,`_whereModule`,void 0),$=C([c(`esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource`)],$);export{$ as FeatureServiceSnappingSource};