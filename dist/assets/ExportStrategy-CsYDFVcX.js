import{$c as e,DT as t,Hw as n,Jw as r,OT as i,Xb as a,Xw as o,_w as s,bS as c,eT as l,gD as u,tl as d,tx as f,yg as p}from"./index-CzMixifc.js";import{n as m}from"./Bitmap-BHK62sx3.js";var h=Math.PI/180;function g(e){return e*h}function _(e,t){let n=g(t.rotation),r=Math.abs(Math.cos(n)),i=Math.abs(Math.sin(n)),[a,o]=t.size;return e[0]=Math.round(o*i+a*r),e[1]=Math.round(o*r+a*i),e}function v(e,t,n,r){let[i,a]=t,[o,s]=r,c=.5*n;return e[0]=i-c*o,e[1]=a-c*s,e[2]=i+c*o,e[3]=a+c*s,e}var y=f(),b=[0,0],x=new d(0,0,0,0),S={imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1},C=class extends s{constructor(e){super(e),this._imagePromise=null,this.bitmaps=[],this.hidpi=S.hidpi,this.imageMaxWidth=S.imageMaxWidth,this.imageMaxHeight=S.imageMaxHeight,this.imageRotationSupported=S.imageRotationSupported,this.imageNormalizationSupported=S.imageNormalizationSupported,this.update=n(async(e,t)=>{if(l(t),!e.stationary||this.destroyed)return;let n=e.state,i=c(n.spatialReference),a=this.hidpi?e.pixelRatio:1,o=n.worldScreenWidth>0,s=o&&this.imageNormalizationSupported&&n.worldScreenWidth<n.size[0],u=Math.round((this.imageMaxWidth??0)/a),d=Math.round((this.imageMaxHeight??0)/a);s?(b[0]=n.worldScreenWidth,b[1]=n.size[1]):this.imageRotationSupported?(b[0]=n.size[0],b[1]=n.size[1]):_(b,n);let f=Math.floor(b[0])>u||Math.floor(b[1])>d,p=i&&(n.extent.xmin<i.valid[0]||n.extent.xmax>i.valid[1]),m=!this.imageNormalizationSupported&&p,h=!f&&!m,g=this.imageRotationSupported?n.rotation:0,v=this.container.children.slice();if(h){let e=s?n.paddedViewState.center:n.center;this._imagePromise=this._singleExport(n,b,e,n.resolution,g,a,t)}else{let e=Math.min(u,d);o&&(e=Math.min(n.worldScreenWidth,e),e=Math.round(n.worldScreenWidth/Math.ceil(n.worldScreenWidth/e))),this._imagePromise=this._tiledExport(n,e,a,t)}try{let e=await this._imagePromise??[];l(t);let n=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=e;for(let t of v)e.includes(t)||n.push(t.fadeOut().then(()=>{t.remove(),t.destroy()}));for(let t of e)n.push(t.fadeIn());await Promise.all(n)}catch(e){this._imagePromise=null,r(e)}},5e3),this.updateExports=n(async e=>{let t=[];for(let n of this.container.children){if(!n.visible||!n.stage)return;t.push(e(n).then(()=>{n.invalidateTexture(),n.requestRender()}))}this._imagePromise=o(t).then(()=>this._imagePromise=null),await this._imagePromise})}destroy(){this.bitmaps.forEach(e=>e.destroy()),this.bitmaps=[]}get updating(){return!this.destroyed&&this._imagePromise!==null}async _export(e,t,n,r,i,a){let o=await this.fetchSource(e,Math.floor(t*i),Math.floor(n*i),{rotation:r,pixelRatio:i,signal:a});l(a);let s=new m(null,!0);return s.x=e.xmin,s.y=e.ymax,s.resolution=e.width/t,s.rotation=r,s.pixelRatio=i,s.opacity=0,this.container.addChild(s),await s.setSourceAsync(o,a),l(a),s}async _singleExport(e,t,n,r,i,o,s){v(y,n,r,t);let c=a(y,e.spatialReference);return[await this._export(c,t[0],t[1],i,o,s)]}_tiledExport(t,n,r,i){let o=p.create({size:n,spatialReference:t.spatialReference,scales:[t.scale]}),s=new e(o),c=s.getTileCoverage(t);if(!c)return null;let l=[];return c.forEach((e,o,c,u)=>{x.set(e,o,c,0),s.getTileBounds(y,x);let d=a(y,t.spatialReference);l.push(this._export(d,n,n,0,r,i).then(t=>(u!==0&&(x.set(e,o,c,u),s.getTileBounds(y,x),t.x=y[0],t.y=y[3]),t)))}),Promise.all(l)}};u([t()],C.prototype,`_imagePromise`,void 0),u([t()],C.prototype,`bitmaps`,void 0),u([t()],C.prototype,`container`,void 0),u([t()],C.prototype,`fetchSource`,void 0),u([t()],C.prototype,`hidpi`,void 0),u([t()],C.prototype,`imageMaxWidth`,void 0),u([t()],C.prototype,`imageMaxHeight`,void 0),u([t()],C.prototype,`imageRotationSupported`,void 0),u([t()],C.prototype,`imageNormalizationSupported`,void 0),u([t()],C.prototype,`requestUpdate`,void 0),u([t()],C.prototype,`updating`,null),C=u([i(`esri.views.2d.layers.support.ExportStrategy`)],C);export{C as t};