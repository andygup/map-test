import{DT as e,OT as t,WT as n,_d as r,gD as i,nv as a,qw as o,uE as s}from"./index-CzMixifc.js";import"./memoryEstimations-C3WUBUZI.js";import"./OptimizedGeometry-5fDazGe-.js";import"./OptimizedFeatureSet-D4F9ObY_.js";import"./featureConversionUtils-VvJ2pauf.js";import"./streamLayerUtils-82UmlW-3.js";import"./QueueProcessor-CbN5H2eO.js";import"./earcut-CsNwSYFA.js";import"./layerViewUtils-Cbrog-dU.js";import"./popupUtils-Bps_s4dv.js";import"./tagSymbols-CNjeVVdC.js";import"./colorUtils-Btp0B-0Y.js";import"./timeSupport-CjNpK2fD.js";import"./queryUtils-fxq7u50x.js";import"./quantizationUtils-CzrQVcZ1.js";import"./sublayerUtils-CdLiCppr.js";import"./floorFilterUtils-CQ-SmVM_.js";import{t as c}from"./ExportImageParameters-CwcaNEX7.js";import"./normalizeUtilsSync-DZGX2pCO.js";import"./GeometryUtils-C6BJBMi9.js";import"./VertexAttributeLocations-DOYYzMyn.js";import"./VertexElementDescriptor-C9CNG143.js";import"./labelPoint-D95l1mBc.js";import"./callExpressionWithCursor-NwM51lOx.js";import"./FeatureMetadata-DVsh91f_.js";import"./CIMSymbolHelper-CIzDgFQE.js";import"./rasterizingUtils-L-rXtdWe.js";import"./Rect-BMNJQxpm.js";import"./BoundingBox-CW0_Ka-z.js";import"./BidiEngine-CpIovbIK.js";import"./callExpressionWithFeature-jAwzgzDm.js";import"./OverrideHelper-Catw08-A.js";import"./FeatureCommandQueue-Ccv3I5Xd.js";import"./config-BY05DP3l.js";import"./dehydratedFeatureComparison-DeSHk9xR.js";import{n as l}from"./drapedUtils-DHehJLfn.js";import"./WGLContainer-v9ak9x06.js";import"./utils-CPFnbOXo.js";import"./ProgramTemplate-DXigF9DQ.js";import"./VertexArrayObject-BCHCoUBc.js";import"./BufferObject-DizvMSTk.js";import"./VertexBuffer-Dhf7DMaS.js";import"./vec3f32-BWuLbfSR.js";import"./Container-s63aPbsG.js";import"./GraphShaderModule-KXpa7jQA.js";import"./FramebufferObject-E0PFfPHi.js";import"./ShaderBuilder-Dbc4jYz7.js";import"./bitmapUtils-CseW13Cs.js";import"./Bitmap-BHK62sx3.js";import{t as u}from"./BitmapContainer-C71VqD9y.js";import{t as d}from"./LayerView2D-BLVA9W76.js";import{t as f}from"./ExportStrategy-CsYDFVcX.js";import{t as p}from"./LayerView-BKgBHcbR.js";import{t as m}from"./RefreshableLayerView-Cxa6i7Us.js";import{t as h}from"./timeSupport-DIR5HMZt.js";import"./UpdateTracking2D-BQFl9U6T.js";import"./TechniqueInstance-B2WffE-f.js";import"./TileContainer-CdHqIsYl.js";import"./constants-TfCITEY_.js";import"./utils-Cp6QQbUU.js";import{t as g}from"./highlightOptionsUtils-C-mZET-I.js";import"./AGraphicContainer-DjhIZWU6.js";import"./ComputedAttributeStorage-D3juJH-7.js";import{t as _}from"./GraphicsView2D-y5Ereu1j.js";import"./dehydratedFeatures-Db6Q9NQd.js";import{t as v}from"./HighlightGraphicContainer-DMh0MvP_.js";import{r as y,t as b}from"./MapServiceLayerViewHelper-DuQuoady.js";var x=n=>{let r=n,a=class extends r{initialize(){this.exportImageParameters=new c({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get floors(){return this.view?.floors??null}get exportImageVersion(){return this.exportImageParameters?.commitProperty(`version`),this.commitProperty(`timeExtent`),this.commitProperty(`floors`),(this._get(`exportImageVersion`)||0)+1}get timeExtent(){return h(this.layer,this.view?.timeExtent,this._get(`timeExtent`))}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}};return i([e()],a.prototype,`exportImageParameters`,void 0),i([e({readOnly:!0})],a.prototype,`floors`,null),i([e({readOnly:!0})],a.prototype,`exportImageVersion`,null),i([e()],a.prototype,`layer`,void 0),i([e()],a.prototype,`suspended`,void 0),i([e({readOnly:!0})],a.prototype,`timeExtent`,null),a=i([t(`esri.views.layers.MapImageLayerView`)],a),a},S=class extends x(m(d(p))){constructor(){super(...arguments),this._highlightGraphics=new r,this._updateHash=``}fetchPopupFeaturesAtLocation(e,t){return this._popupHighlightHelper.fetchPopupFeaturesAtLocation(e,t)}update(e){let t=`${this.exportImageVersion}/${e.state.id}/${e.pixelRatio}/${e.stationary}`;this._updateHash!==t&&(this._updateHash=t,this.strategy.update(e).catch(e=>{o(e)||s.getLogger(this).error(e)}),e.stationary&&this._popupHighlightHelper.updateHighlightedFeatures(e.state.resolution)),this._highlightView.processUpdate(e)}attach(){let{imageMaxWidth:e,imageMaxHeight:t,version:n}=this.layer,r=n>=10.3,i=n>=10;this._bitmapContainer=new u,this.container.addChild(this._bitmapContainer),this._highlightView=new _({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new v(this.view.featuresTilingScheme),defaultPointSymbolEnabled:!1}),this.container.addChild(this._highlightView.container),this._popupHighlightHelper=new b({createFetchPopupFeaturesQueryGeometry:(e,t)=>l(e,t,this.view),highlightGraphics:this._highlightGraphics,highlightGraphicUpdated:({graphic:e,property:t})=>this._highlightView.graphicUpdateHandler({graphic:e,property:t}),layerView:this,updatingHandles:this._updatingHandles}),this.strategy=new f({container:this._bitmapContainer,fetchSource:this.fetchImageBitmap.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:e,imageMaxHeight:t,imageRotationSupported:r,imageNormalizationSupported:i,hidpi:!0}),this.addAttachHandles(a(()=>this.exportImageVersion,()=>this.requestUpdate())),this.requestUpdate()}detach(){this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren(),this._highlightView.destroy(),this._popupHighlightHelper.destroy()}viewChange(){}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}async doRefresh(){this._updateHash=``,this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,t,n,r){return this.layer.fetchImage(e,t,n,{timeExtent:this.timeExtent,floors:this.floors,...r})}fetchImageBitmap(e,t,n,r){return this.layer.fetchImageBitmap(e,t,n,{timeExtent:this.timeExtent,floors:this.floors,...r})}highlight(e,t){let r=y(e);if(r.length===0)return n();let i=g(t);return this._addHighlightGraphics(r,i),n(()=>!this.destroyed&&this._removeHighlightGraphics(r,i))}_processHighlight(){let e=this._getHighlights();this._highlightView?.setHighlight(e)}_addHighlightGraphics(e,t){this._highlightGraphics.addMany(e),this._addHighlights(e.map(e=>e.uid),t)}_removeHighlightGraphics(e,t){this._highlightGraphics.removeMany(e),this._removeHighlights(e.map(e=>e.uid),t)}};i([e()],S.prototype,`strategy`,void 0),S=i([t(`esri.views.2d.layers.MapImageLayerView2D`)],S);var C=S;export{C as default};