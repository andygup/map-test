import{KT as e,Kw as t,Q_ as n,UT as r,dg as i,iv as a,rT as o,tT as s}from"./index-CzMixifc.js";function c(e,t,r){let i=r?.createCollection?.()??new a,o=r?.recycleItems?new l:null,s=(e,t=0)=>{if(!e?.length)return;let n=i.splice(t,e.length);o?o.processRemoved(e):n.forEach(d)},c=(e,n=0)=>{if(!e?.length)return;let r=[];for(let n of e){let e=o?.use(n);if(e)r.push(e);else{let e=t(n);o?.register(n,e),r.push(e)}}i.addMany(r,n)},u=n(e,`after-splice`,({added:e,start:t,removed:n})=>{s(n,t),c(e,t)},{sync:!0,onListenerRemove:e=>s(e.items),onListenerAdd:e=>c(e.items)});return i.addHandles(u),i}var l=class{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(e){if(!e?.length)return;let{_removedItemCandidates:t}=this;for(let n of e)this._getItem(n)?.markRemoved()&&(t.add(n),this._queueGarbageCollection())}use(e){let t=this._getItem(e);return t&&(t.removed=!1),t?.item}register(e,t){this._originalToMapped.set(e,new u(t))}_getItem(e){return this._originalToMapped.get(e)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask(()=>this._garbageCollectCandidates()))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;let{_removedItemCandidates:e}=this,t=Array.from(e);e.clear(),t.forEach(e=>this._garbageCollectIfRemoved(e))}_garbageCollectIfRemoved(e){let{_originalToMapped:t}=this,n=this._getItem(e);n?.removed&&(d(n.item),t.delete(e))}},u=class{constructor(e){this.item=e,this.removed=!1}markRemoved(){return this.removed=!0,!0}};function d(t){typeof t==`object`&&t&&(`destroy`in t&&typeof t.destroy==`function`?t.destroy():e(t))}function f(e,n,l){let u=new a,f=c(e,e=>i(async r=>{let i=await n(e,r);if(t(r))throw d(i),s();return i}),l),p=()=>null,m=async e=>{let t=await e.promise,n=f.indexOf(e);n<0||u.splice(n,1,t)};u.addMany(f.items.map(p));for(let e of f)o(m(e));let h=f.on(`after-splice`,({added:e,start:t,deleteCount:n})=>{let r=u.splice(t,n);for(let e of r)d(e);if(e?.length){u.addMany(e.map(p),t);for(let t of e)o(m(t))}});return u.addHandles([r(f),h]),u}export{f as n,c as t};