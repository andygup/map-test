const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/geometryServiceUtils-80CRqilk.js","assets/index-BN8X5Ryz.js","assets/index-CWJhHB6-.css"])))=>i.map(i=>d[i]);
import{$S as e,$T as t,AS as n,Aa as r,Ax as i,Dh as a,Fa as o,Ha as s,Kh as c,La as l,Lx as u,NC as d,Na as f,Th as p,Va as m,Wa as ee,bm as te,fv as h,ja as ne,kC as re,qh as g,tC as _,vm as v,xm as y,za as b}from"./index-BN8X5Ryz.js";import{t as ie}from"./originUtils-CJnuu7mB.js";import"./resourceUtils-Bt8ctqoA.js";import{n as x}from"./resourceUtils-t_8WR2aj.js";import{n as S,r as C,t as w}from"./saveUtils-CEfw3trS.js";var T=[`NatGeo_World_Map`,`Ocean_Basemap`,`USA_Topo_Maps`,`World_Imagery`,`World_Street_Map`,`World_Terrain_Base`,`World_Topo_Map`,`World_Hillshade`,`Canvas/World_Light_Gray_Base`,`Canvas/World_Light_Gray_Reference`,`Canvas/World_Dark_Gray_Base`,`Canvas/World_Dark_Gray_Reference`,`Ocean/World_Ocean_Base`,`Ocean/World_Ocean_Reference`,`Reference/World_Boundaries_and_Places`,`Reference/World_Reference_Overlay`,`Reference/World_Transportation`].map(e=>e.toLowerCase());async function E(e,t,n){n??={},k(e,t),await h(()=>!t.updatingFromView),await t.load(),await M(t),await S(t),await j(e,t);let r=t.portalItem,{json:i,jsonContext:a}=await D(t,r,e.origin);return C(a,{errorName:`${e.name}:save`},n),await N(t,r),await Ce(e,t,r,i,a),await Promise.all([t.updateItemThumbnail(),x(t.resourceReferences,a)]),r}async function D(e,t,n){let r=f(t,n,!0),i=e.write({},r);return await Promise.all(r.resources.pendingOperations),{json:i,jsonContext:r}}async function O(e,t,n,r){r??={};let i=ae(e,n);await h(()=>!t.updatingFromView),await t.load(),await M(t),await S(t),await j(e,t);let{json:a,jsonContext:o}=await D(t,i,e.origin);C(o,{errorName:`${e.name}:save`},r),await q(t,i);let s=t.getThumbnailState();return await we(e,t,i,a,o,r)&&(t.resourceReferences.portalItem=i),t.restoreThumbnailFromState(s),await Promise.all([t.updateItemThumbnail(),x(t.resourceReferences,o)]),i}function k(e,n){if(!n.portalItem)throw new t(`${e.name}:portal-item-not-set`,`Portal item to save to has not been set on the WebMap`);A(e,n.portalItem)}function A(e,n){if(n.type!==e.itemType)throw new t(`${e.name}:portal-item-wrong-type`,`Portal item needs to have type "${e.itemType}"`)}async function j(e,r){if(e.name===`linkchart`)return;if(!r.basemap?.baseLayers.length)throw new t(`${e.name}:save`,`Map does not have a valid basemap with a base layer.`);let i=null;if(await h(()=>{let e=te(r.initialViewProperties,r.basemap);return i=e.spatialReference,!e.updating}),!n(i,r.initialViewProperties.spatialReference))throw new t(`${e.name}:save`,`The spatial reference of the basemap is not compatible with the one from the map.`,{expected:r.initialViewProperties.spatialReference,actual:i})}function ae(e,t){let n=c.from(t);return n.id&&=(n=n.clone(),null),n.type||=e.itemType,n.portal||=g.getDefault(),A(e,n),n}function M(e){let t=[];return e.basemap&&t.push(e.basemap.load()),e.ground&&t.push(e.ground.load()),Promise.allSettled(t).then(()=>{})}async function N(e,t){t.extent=await ge(e.portalItem,e.initialViewProperties.viewpoint.targetGeometry),await se(e,t)}var oe=o.JSAPI,P=`CollectorDisabled`,F=`Collector`,I=`Data Editing`,L=`OfflineDisabled`,R=`Offline`,z=`Workforce Project`,B=`Workforce Worker`,V=`Workforce Dispatcher`,H=`Offline Map Areas`,U=`FieldMapsDisabled`,W=o.DEVELOPER_BASEMAP,G=`UtilityNetwork`,K=`IPS`;async function q(e,t){l(t,P),l(t,U),l(t,o.METADATA),l(t,L),l(t,H),l(t,V),l(t,z),l(t,B),await N(e,t)}async function se(e,t){b(t,oe),await ce(e),ue(e,t),de(e,t),fe(e,t),pe(e,t),me(e,t),X(e,t),he(e,t),t.typeKeywords&&=t.typeKeywords.filter((e,t,n)=>n.indexOf(e)===t)}function ce(e){let t=J(e).map(e=>e.load()).toArray();return Promise.allSettled(t).then(()=>{})}function J(e){return e.allLayers.concat(e.allTables)}function Y(e){return J(e).some(e=>e.loaded&&a(e)&&e.capabilities.operations.supportsEditing&&e.editingEnabled&&(e.type!==`subtype-group`||e.sublayers.some(e=>e.editingEnabled)))}function le(e){return J(e).filter(e=>e.type!==`group`).every(t=>t.loaded&&ye(e,t))}function ue(e,t){m(t,P)||m(t,z)||m(t,B)||m(t,V)||!Y(e)?l(t,F):b(t,F)}function de(e,t){Y(e)?b(t,I):l(t,I)}function fe(e,t){!m(t,L)&&le(e)?b(t,R):l(t,R)}function pe(e,t){y(e.basemap)?b(t,W):l(t,W)}function me(e,t){e.utilityNetworks?.length?b(t,G):l(t,G)}function X(e,t){e.ipsInfo?b(t,K):l(t,K)}function he(e,t){s(t,o.CHARTS,w(e))}async function ge(e,t){let n=t.clone().normalize(),r;if(n.length>1)for(let e of n)r?e.width>r.width&&(r=e):r=e;else r=n[0];return _e(e,r)}async function _e(t,n){let a=n.spatialReference;if(a.isWGS84)return n.clone();if(a.isWebMercator)return i(n);let{getGeometryServiceURL:o}=await e(async()=>{let{getGeometryServiceURL:e}=await import(`./geometryServiceUtils-80CRqilk.js`);return{getGeometryServiceURL:e}},__vite__mapDeps([0,1,2])),s=await o(t),c=new ne({geometries:[n],outSpatialReference:u.WGS84});return(await r(s,c))[0]}function ve(e){return p(e)||e.type===`map-notes`||e.type===`route`}function ye(e,t){return a(t)&&t.capabilities.operations.supportsSync||ve(t)&&!t.portalItem||be(t)&&!xe(t)&&t.spatialReference.equals(e.initialViewProperties.spatialReference)}function be(e){return(e.type===`tile`||e.type===`vector-tile`)&&(e.capabilities.operations.supportsExportTiles||Se(e)||v(e))}function xe(e){return e.type===`vector-tile`&&Object.keys(e.sourceNameToSource).length>1}function Se(e){return e.type===`tile`&&_(e.url)&&T.some(t=>e.url?.toLowerCase().includes(`/`+t+`/`))}async function Ce(e,t,n,r,i){await n.update({data:r}),$(e,t,n,r,i)}async function we(e,n,r,i,a,o){let s=n.portalItem,c={item:s,authenticated:!(!s?.id||!s.portal.user)},l=r.portal;await l.signIn();let{copyAllowed:u,itemReloaded:d}=await Z(c,l);if(c.authenticated||=d,!u)throw new t(`${e.name}:save-as-copy-not-allowed`,`Owner of this map does not allow others to save a copy`);let f=await Q(r,c,i,o);return n.portalItem=r,$(e,n,r,i,a),f}async function Z(e,t){let{item:n,authenticated:r}=e;return n?.id&&n.typeKeywords?.includes(`useOnly`)?n.portal.portalHostname===t.portalHostname?(r||await n.reload(),{copyAllowed:n.itemControl===`admin`||n.itemControl===`update`,itemReloaded:!0}):{copyAllowed:!1,itemReloaded:!1}:{copyAllowed:!0,itemReloaded:!1}}async function Q(e,t,n,r){let i=e.portal,{item:a}=t,{folder:o,copyAllResources:s}=r,c=!1;if(s&&a?.id&&d(a.portal.url,i.url)&&parseInt(a.portal.currentVersion,10)>=2023){let{total:e}=await a.fetchResources();c=!!e}if(c){let t=await a.copy({copyResources:`all`,folder:o});e.id=t.id,e.portal=t.portal;let r=e.toJSON();await e.load(),e.read(r),await e.update({data:n})}else await i.user.addItem({item:e,folder:o,data:n});return c}function $(e,t,n,r,i){ee.prototype.read.call(t,{version:r.version,authoringApp:r.authoringApp,authoringAppVersion:r.authoringAppVersion},{origin:e.origin,ignoreDefaults:!0,url:n.itemUrl?re(n.itemUrl):void 0}),ie(i),t.resourceInfo=r}export{D as createJSON,Q as initializeNewItem,Z as isCopyAllowed,E as save,O as saveAs};